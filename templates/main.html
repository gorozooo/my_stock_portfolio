{% extends "base.html" %}
{% load static humanize %}

{% block title %}ホーム{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock %}

{% block content %}
<div class="home-page">

  {% if messages %}
    <ul class="msgs">
      {% for m in messages %}
        <li class="msg {{ m.tags }}">{{ m }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- ===== HERO / 総資産ブロック ===== -->
  <header class="card hero">
    <div class="hero-head">
      <h1 class="hero-title">総資産ダッシュボード</h1>
      <div class="hero-actions">
        <a class="btn ghost" href="{% url 'stock_list' %}">保有一覧</a>
        <a class="btn ghost" href="{% url 'cash_io' %}">入出金</a>
      </div>
    </div>

    <div class="hero-grid">
      <!-- 円形ゲージ -->
      <div class="ring" aria-label="総資産ゲージ">
        <svg viewBox="0 0 120 120" class="ring-svg"
             data-target="{{ target_assets|default_if_none:0 }}"
             data-value="{{ total_assets|default_if_none:0 }}">
          <circle cx="60" cy="60" r="52" class="bg"></circle>
          <circle cx="60" cy="60" r="52" class="fg" stroke-dasharray="0 999" stroke-dashoffset="0"></circle>
        </svg>
        <div class="ring-center">
          <div class="ring-title">総資産</div>
          <div class="ring-figure">¥{{ total_assets|default_if_none:0|floatformat:0|intcomma }}</div>
          <div class="ring-sub">
            前日比
            {% with dc=day_change|default_if_none:0 %}
              <strong class="pn {% if dc >= 0 %}pos{% else %}neg{% endif %}">
                {% if dc >= 0 %}+{% endif %}¥{{ dc|floatformat:0|intcomma }}
              </strong>
            {% endwith %}
          </div>
        </div>
      </div>

      <!-- KPI群 + スパーク -->
      <div class="hero-right">
        <div class="kpi-row">
          <div class="mini">
            <span class="k">評価額</span>
            <span class="v">¥{{ portfolio_value|default_if_none:0|floatformat:0|intcomma }}</span>
          </div>
          <div class="mini">
            <span class="k">現金</span>
            <span class="v">¥{{ cash_total|default_if_none:0|floatformat:0|intcomma }}</span>
          </div>
          {% with upl=unrealized_pl|default_if_none:0 %}
          <div class="mini">
            <span class="k">含み損益</span>
            <span class="v {% if upl >= 0 %}pos{% else %}neg{% endif %}">
              {% if upl >= 0 %}+{% endif %}¥{{ upl|floatformat:0|intcomma }}
            </span>
          </div>
          {% endwith %}
        </div>

        <div id="assetSpark" class="sparkline"
             data-points="{{ asset_history_csv|default_if_none:'' }}"></div>
      </div>
    </div>
  </header>

  <!-- ===== 証券会社タブ ===== -->
  <section class="card brokers">
    <nav class="tabs" role="tablist" aria-label="証券会社">
      {% for b in brokers %}
        <button class="tab {% if forloop.first %}active{% endif %}" data-tab="{{ b.key }}">{{ b.label }}</button>
      {% endfor %}
    </nav>

    <div class="panes">
      {% for b in brokers %}
      <div class="pane {% if forloop.first %}active{% endif %}" id="pane-{{ b.key }}">
        <div class="pane-head">
          <div class="pane-brand">
            <div class="logo">{{ b.label|slice:":2" }}</div>
            <div class="pane-balance">
              <div class="k">現金残高</div>
              {% with _s=b.balance|stringformat:"s" %}
                {% if _s == 'Ellipsis' %}
                  <div class="v">—</div>
                {% else %}
                  <div class="v">¥{{ b.balance|default_if_none:0|floatformat:0|intcomma }}</div>
                {% endif %}
              {% endwith %}
            </div>
          </div>
          <div class="pill-row">
            <div class="pill">
              <div class="k">保有銘柄数</div>
              {% with _s=b.holdings_count|stringformat:"s" %}
                {% if _s == 'Ellipsis' %}
                  <div class="v">—</div>
                {% else %}
                  <div class="v">{{ b.holdings_count|default_if_none:0 }}</div>
                {% endif %}
              {% endwith %}
            </div>
            <div class="pill">
              <div class="k">時価評価</div>
              {% with _s=b.market_value|stringformat:"s" %}
                {% if _s == 'Ellipsis' %}
                  <div class="v">—</div>
                {% else %}
                  <div class="v">¥{{ b.market_value|default_if_none:0|floatformat:0|intcomma }}</div>
                {% endif %}
              {% endwith %}
            </div>
            <div class="pill">
              <div class="k">含み損益</div>
              {% with _s=b.unrealized_pl|stringformat:"s" %}
                {% if _s == 'Ellipsis' %}
                  <div class="v">—</div>
                {% else %}
                  {% with u=b.unrealized_pl|default_if_none:0 %}
                    <div class="v {% if u >= 0 %}pos{% else %}neg{% endif %}">
                      {% if u >= 0 %}+{% endif %}¥{{ u|floatformat:0|intcomma }}
                    </div>
                  {% endwith %}
                {% endif %}
              {% endwith %}
            </div>
          </div>
        </div>

        <!-- 詳細：上位ポジション + 最近の動き + ブレークダウン -->
        <div class="panel-split">
          <!-- 上位ポジション -->
          <div>
            <h3 class="sect-title">上位ポジション</h3>
            <div class="table-wrap">
              <table class="tbl dense">
                <thead>
                  <tr>
                    <th>ティッカー</th>
                    <th>銘柄</th>
                    <th class="ar">保有</th>
                    <th class="ar">時価</th>
                  </tr>
                </thead>
                <tbody>
                  {% with _tops_s=b.top_positions|stringformat:"s" %}
                    {% if _tops_s == 'Ellipsis' or not b.top_positions %}
                      <tr><td colspan="4" class="empty">データがありません</td></tr>
                    {% else %}
                      {% for p in b.top_positions %}
                        <tr>
                          <td>{{ p.ticker }}</td>
                          <td class="name">{{ p.name }}</td>
                          <td class="ar">{{ p.shares|default_if_none:0|intcomma }} 株</td>
                          <td class="ar">¥{{ p.market_value|default_if_none:0|floatformat:0|intcomma }}</td>
                        </tr>
                      {% empty %}
                        <tr><td colspan="4" class="empty">データがありません</td></tr>
                      {% endfor %}
                    {% endif %}
                  {% endwith %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- 最近のアクティビティ（そのブローカー限定） -->
          <div>
            <h3 class="sect-title">最近の動き</h3>
            {% with _rec_s=b.recent|stringformat:"s" %}
              {% if _rec_s == 'Ellipsis' or not b.recent %}
                <ul class="mini-activity"><li class="empty">まだ動きがありません</li></ul>
              {% else %}
                <ul class="mini-activity">
                  {% for r in b.recent %}
                    <li class="arow">
                      <div class="adate">{{ r.date|date:"n/j" }}</div>
                      <div class="amain">
                        <span class="cbadge">{{ r.kind }}</span>
                        {% if r.ticker %} {{ r.ticker }}{% endif %}
                        {% if r.name %} {{ r.name }}{% endif %}
                        {% if r.memo %} <span class="small">/ {{ r.memo }}</span>{% endif %}
                      </div>
                      {% if r.amount %}
                        {% with amt=r.amount|default_if_none:0 %}
                          <div class="aval {% if r.sign == '+' %}pos{% else %}neg{% endif %}">
                            {{ r.sign }}¥{{ amt|floatformat:0|intcomma }}
                          </div>
                        {% endwith %}
                      {% else %}
                        <div class="aval small">—</div>
                      {% endif %}
                    </li>
                  {% empty %}
                    <li class="empty">まだ動きがありません</li>
                  {% endfor %}
                </ul>
              {% endif %}
            {% endwith %}
          </div>
        </div>

        <!-- ブレークダウン（保有/現金/評価/含み益率） -->
        <div class="gauges">
          <div class="gauge">
            <div class="g-title">評価 / 総資産</div>
            {% with n_s=b.market_value|stringformat:"s" d_s=total_assets|stringformat:"s" %}
              {% if n_s == 'Ellipsis' or d_s == 'Ellipsis' %}
                <div class="g-figure">—</div>
              {% else %}
                <div class="g-figure">
                  ¥{{ b.market_value|default_if_none:0|floatformat:0|intcomma }}
                  /
                  ¥{{ total_assets|default_if_none:0|floatformat:0|intcomma }}
                </div>
              {% endif %}
            {% endwith %}
            <div class="g-bar">
              <span data-ratio="mv"
                    data-num="{{ b.market_value|default_if_none:0 }}"
                    data-den="{{ total_assets|default_if_none:0 }}"></span>
            </div>
          </div>

          <div class="gauge">
            <div class="g-title">現金 / 総資産</div>
            {% with n_s=b.balance|stringformat:"s" d_s=total_assets|stringformat:"s" %}
              {% if n_s == 'Ellipsis' or d_s == 'Ellipsis' %}
                <div class="g-figure">—</div>
              {% else %}
                <div class="g-figure">
                  ¥{{ b.balance|default_if_none:0|floatformat:0|intcomma }}
                  /
                  ¥{{ total_assets|default_if_none:0|floatformat:0|intcomma }}
                </div>
              {% endif %}
            {% endwith %}
            <div class="g-bar">
              <span data-ratio="cash"
                    data-num="{{ b.balance|default_if_none:0 }}"
                    data-den="{{ total_assets|default_if_none:0 }}"></span>
            </div>
          </div>

          {% with mv_s=b.market_value|stringformat:"s" u_s=b.unrealized_pl|stringformat:"s" %}
          <div class="gauge">
            <div class="g-title">含み益率</div>
            {% if mv_s == 'Ellipsis' or u_s == 'Ellipsis' %}
              <div class="g-figure">—</div>
              <div class="g-bar"><span data-profit data-u="0" data-mv="0"></span></div>
            {% else %}
              {% with mv=b.market_value|default_if_none:0 u=b.unrealized_pl|default_if_none:0 %}
                <div class="g-figure {% if u >= 0 %}pos{% else %}neg{% endif %}">
                  {% if mv > 0 %}¥{{ u|floatformat:0|intcomma }} / ¥{{ mv|floatformat:0|intcomma }}{% else %}—{% endif %}
                </div>
                <div class="g-bar">
                  <span data-profit data-u="{{ u }}" data-mv="{{ mv }}"></span>
                </div>
              {% endwith %}
            {% endif %}
          </div>
          {% endwith %}
        </div>

      </div>
      {% endfor %}
    </div>
  </section>

  <!-- ===== 実現損益（今月/今年/累計） ===== -->
  <section class="card realized">
    <div class="grid3">
      {% with m=realized_pl_mtd|default_if_none:0 %}
      <div class="kpi">
        <div class="k">今月の実現損益</div>
        <div class="v pn {% if m >= 0 %}pos{% else %}neg{% endif %}">
          {% if m >= 0 %}+{% endif %}¥{{ m|floatformat:0|intcomma }}
        </div>
      </div>
      {% endwith %}

      {% with y=realized_pl_ytd|default_if_none:0 %}
      <div class="kpi">
        <div class="k">今年の実現損益</div>
        <div class="v pn {% if y >= 0 %}pos{% else %}neg{% endif %}">
          {% if y >= 0 %}+{% endif %}¥{{ y|floatformat:0|intcomma }}
        </div>
      </div>
      {% endwith %}

      {% with t=realized_pl_total|default_if_none:0 %}
      <div class="kpi">
        <div class="k">累計の実現損益</div>
        <div class="v pn {% if t >= 0 %}pos{% else %}neg{% endif %}">
          {% if t >= 0 %}+{% endif %}¥{{ t|floatformat:0|intcomma }}
        </div>
      </div>
      {% endwith %}
    </div>
    <a class="btn link" href="{% url 'realized' %}">実現一覧へ</a>
  </section>

  <!-- ===== 最近のアクティビティ（全体） ===== -->
  <section class="card activity">
    <div class="activity-head">
      <h3 class="sect-title">最近のアクティビティ</h3>
      <div class="chips">
        {% with r=request.GET.range|default_if_none:'' %}
          <button class="chip {% if r == '7' or not r %}active{% endif %}" data-range="7">7日</button>
          <button class="chip {% if r == '30' %}active{% endif %}" data-range="30">30日</button>
          <button class="chip {% if r == '90' %}active{% endif %}" data-range="90">90日</button>
          <button class="chip {% if r == 'all' %}active{% endif %}" data-range="all">すべて</button>
        {% endwith %}
      </div>
    </div>

    <ul class="timeline" id="timeline">
      {% if recent_activities %}
        {% for a in recent_activities %}
          <li class="trow type-{{ a.kind }}">
            <div class="tdate">{{ a.date|date:"n/j" }}</div>
            <div class="tbody">
              <div class="tline">
                <span class="tbadge">{{ a.kind_label }}</span>
                <span class="tmain">
                  {% if a.kind == 'trade' %}
                    {{ a.ticker }} {{ a.name }} /
                    {% with p=a.pnl|default_if_none:0 %}
                      {% if p >= 0 %}+{% endif %}¥{{ p|floatformat:0|intcomma }}
                    {% endwith %}
                  {% elif a.kind == 'dividend' %}
                    配当 {{ a.ticker }} {{ a.name }} / 受取 ¥{{ a.net|default_if_none:0|floatformat:0|intcomma }}
                  {% elif a.kind == 'cash' %}
                    {% with amt=a.amount|default_if_none:0 %}
                      現金 {{ a.broker_label }} / {% if a.flow == 'in' %}+{% else %}-{% endif %}¥{{ amt|floatformat:0|intcomma }}
                    {% endwith %}
                  {% endif %}
                </span>
              </div>
              {% if a.memo %}<div class="tmemo">{{ a.memo }}</div>{% endif %}
            </div>
          </li>
        {% empty %}
          <li class="empty">まだデータがありません</li>
        {% endfor %}
      {% else %}
        <li class="empty">まだデータがありません</li>
      {% endif %}
    </ul>
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/main.js' %}" defer></script>
{% endblock %}