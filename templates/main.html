{% extends "base.html" %}
{% load static humanize %}

{% block title %}ホーム{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock %}

{% block content %}
<div class="home-page">

  {% if messages %}
    <ul class="msgs">
      {% for m in messages %}
        <li class="msg {{ m.tags }}">{{ m }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- ===== ヒーロー（総資産 + リング） ===== -->
  <header class="card hero">
  <div class="hero-head">
    <h1 class="hero-title">総資産</h1>
    <!-- hero-actions は不要なので削除（残っててもCSSで非表示） -->
  </div>

  <div class="hero-grid">
    <!-- 左：リング（任意） -->
    <div class="ring">
      <svg class="ring-svg" data-target="{{ target_assets|default_if_none:0 }}" data-value="{{ total_assets|default_if_none:0 }}" viewBox="0 0 120 120">
        <circle class="bg" cx="60" cy="60" r="52"/>
        <circle class="fg" cx="60" cy="60" r="52" stroke-dasharray="0 999" stroke-dashoffset="0"/>
      </svg>
      <div class="ring-center">
        <div class="ring-title">Total Assets</div>
        <div class="ring-figure">¥{{ total_assets|default_if_none:0|floatformat:0|intcomma }}</div>
        {% with dc=day_change|default_if_none:0 %}
        <div class="ring-sub pn {% if dc >= 0 %}pos{% else %}neg{% endif %}">
          前日比 {% if dc >= 0 %}+{% endif %}¥{{ dc|floatformat:0|intcomma }}
        </div>
        {% endwith %}
      </div>
    </div>

    <!-- 右：要約KPI & スパークライン -->
    <div class="hero-right">
      <div class="kpi-row">
        <div class="mini">
          <span class="k">評価額</span>
          <span class="v">¥{{ portfolio_value|default_if_none:0|floatformat:0|intcomma }}</span>
        </div>
        <div class="mini">
          <span class="k">現金</span>
          <span class="v">¥{{ cash_total|default_if_none:0|floatformat:0|intcomma }}</span>
        </div>
        <div class="mini">
          {% with upl=unrealized_pl|default_if_none:0 %}
          <span class="k">含み損益</span>
          <span class="v pn {% if upl >= 0 %}pos{% else %}neg{% endif %}">
            {% if upl >= 0 %}+{% endif %}¥{{ upl|floatformat:0|intcomma }}
          </span>
          {% endwith %}
        </div>
      </div>

      <!-- ここが「総資産の一番下」＝スパークライン（資産推移） -->
      <div class="sparkline" id="assetSpark" data-points="{{ asset_history_csv|default_if_none:'' }}"></div>
    </div>
  </div>
</header>

  <!-- ===== ブローカー別（タブ切替） ===== -->
  <section class="brokers card">
    <nav class="tabs" role="tablist" aria-label="証券会社">
      {% for key,label in broker_tabs %}
        <button class="tab {% if key == active_broker %}active{% endif %}"
                type="button"
                data-tab="{{ key }}">{{ label }}</button>
      {% endfor %}
    </nav>

    <div class="panes">
      {% for key,label in broker_tabs %}
        {% if key == 'rakuten' %}
          {% with bal=broker_balances.rakuten stats=broker_stats.rakuten tops=top_positions_by_broker.rakuten rec=recent_by_broker.rakuten %}
          <div class="pane {% if key == active_broker %}active{% endif %}" id="pane-{{ key }}">
            <div class="pane-head">
              <div class="pane-brand">
                <span class="logo">R</span>
                <div class="pane-balance">
                  <div class="k">現金残高</div>
                  {% with guard=bal|stringformat:"s" %}
                    {% if guard == 'Ellipsis' or guard == '' %}
                      <div class="v">—</div>
                    {% else %}
                      <div class="v">¥{{ bal|default_if_none:0|floatformat:0|intcomma }}</div>
                    {% endif %}
                  {% endwith %}
                </div>
              </div>
            </div>

            <div class="pill-row">
              <div class="pill">
                <span class="k">保有銘柄</span>
                {% with s=stats|stringformat:"s" %}
                  {% if s == 'Ellipsis' or not stats %}
                    <span class="v">—</span>
                  {% else %}
                    <span class="v">{{ stats.holdings_count|default_if_none:0 }}</span>
                  {% endif %}
                {% endwith %}
              </div>
              <div class="pill">
                <span class="k">時価評価</span>
                {% with s=stats|stringformat:"s" %}
                  {% if s == 'Ellipsis' or not stats %}
                    <span class="v">—</span>
                  {% else %}
                    <span class="v">¥{{ stats.market_value|default_if_none:0|floatformat:0|intcomma }}</span>
                  {% endif %}
                {% endwith %}
              </div>
              <div class="pill">
                <span class="k">含み損益</span>
                {% with s=stats|stringformat:"s" %}
                  {% if s == 'Ellipsis' or not stats %}
                    <span class="v">—</span>
                  {% else %}
                    {% with upv=stats.unrealized_pl|default_if_none:0 %}
                      <span class="v {% if upv >= 0 %}pos{% else %}neg{% endif %}">
                        {% if upv >= 0 %}+{% endif %}¥{{ upv|floatformat:0|intcomma }}
                      </span>
                    {% endwith %}
                  {% endif %}
                {% endwith %}
              </div>
            </div>

            <div class="panel-split">
              <div>
                <h3 class="sect-title">上位ポジション</h3>
                {% with ts=tops|stringformat:"s" %}
                  {% if ts == 'Ellipsis' or not tops %}
                    <div class="empty">データがありません</div>
                  {% else %}
                    <ul class="pos-list">
                      {% for p in tops %}
                        <li class="pos-row">
                          <span class="name">{{ p.ticker }} {{ p.name }}</span>
                          <span class="lot">{{ p.shares|default_if_none:0|intcomma }}株</span>
                          <span class="mv">¥{{ p.market_value|default_if_none:0|floatformat:0|intcomma }}</span>
                        </li>
                      {% empty %}
                        <li class="empty">データがありません</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                {% endwith %}
              </div>

              <div>
                <h3 class="sect-title">最近の動き</h3>
                {% with rs=rec|stringformat:"s" %}
                  {% if rs == 'Ellipsis' or not rec %}
                    <div class="empty">データがありません</div>
                  {% else %}
                    <ul class="mini-activity">
                      {% for a in rec %}
                        <li class="arow">
                          <span class="adate">{{ a.date|date:"n/j" }}</span>
                          <span class="amain">
                            {% if a.kind == 'trade' %}
                              {{ a.ticker }} {{ a.name }}
                            {% elif a.kind == 'dividend' %}
                              配当 {{ a.ticker }} {{ a.name }}
                            {% elif a.kind == 'cash' %}
                              現金 {{ a.broker_label }}
                            {% else %}
                              —
                            {% endif %}
                          </span>
                          <span class="aval {% if a.sign == '+' or a.pnl|default_if_none:0 >= 0 %}pos{% else %}neg{% endif %}">
                            {% if a.kind == 'trade' %}
                              {% with pnlv=a.pnl|default_if_none:0 %}
                                {% if pnlv >= 0 %}+{% endif %}¥{{ pnlv|floatformat:0|intcomma }}
                              {% endwith %}
                            {% elif a.kind == 'dividend' %}
                              ¥{{ a.net|default_if_none:0|floatformat:0|intcomma }}
                            {% elif a.kind == 'cash' %}
                              {% with am=a.amount|default_if_none:0 %}
                                {% if a.flow == 'in' %}+{% else %}-{% endif %}¥{{ am|floatformat:0|intcomma }}
                              {% endwith %}
                            {% else %}—{% endif %}
                          </span>
                        </li>
                      {% empty %}
                        <li class="empty">データがありません</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </div>
          {% endwith %}

        {% elif key == 'matsui' %}
          {% with bal=broker_balances.matsui stats=broker_stats.matsui tops=top_positions_by_broker.matsui rec=recent_by_broker.matsui %}
          <div class="pane {% if key == active_broker %}active{% endif %}" id="pane-{{ key }}">
            <div class="pane-head">
              <div class="pane-brand">
                <span class="logo">M</span>
                <div class="pane-balance">
                  <div class="k">現金残高</div>
                  {% with guard=bal|stringformat:"s" %}
                    {% if guard == 'Ellipsis' or guard == '' %}
                      <div class="v">—</div>
                    {% else %}
                      <div class="v">¥{{ bal|default_if_none:0|floatformat:0|intcomma }}</div>
                    {% endif %}
                  {% endwith %}
                </div>
              </div>
            </div>

            <div class="pill-row">
              <div class="pill">
                <span class="k">保有銘柄</span>
                {% with s=stats|stringformat:"s" %}
                  {% if s == 'Ellipsis' or not stats %}
                    <span class="v">—</span>
                  {% else %}
                    <span class="v">{{ stats.holdings_count|default_if_none:0 }}</span>
                  {% endif %}
                {% endwith %}
              </div>
              <div class="pill">
                <span class="k">時価評価</span>
                {% with s=stats|stringformat:"s" %}
                  {% if s == 'Ellipsis' or not stats %}
                    <span class="v">—</span>
                  {% else %}
                    <span class="v">¥{{ stats.market_value|default_if_none:0|floatformat:0|intcomma }}</span>
                  {% endif %}
                {% endwith %}
              </div>
              <div class="pill">
                <span class="k">含み損益</span>
                {% with s=stats|stringformat:"s" %}
                  {% if s == 'Ellipsis' or not stats %}
                    <span class="v">—</span>
                  {% else %}
                    {% with upv=stats.unrealized_pl|default_if_none:0 %}
                      <span class="v {% if upv >= 0 %}pos{% else %}neg{% endif %}">
                        {% if upv >= 0 %}+{% endif %}¥{{ upv|floatformat:0|intcomma }}
                      </span>
                    {% endwith %}
                  {% endif %}
                {% endwith %}
              </div>
            </div>

            <div class="panel-split">
              <div>
                <h3 class="sect-title">上位ポジション</h3>
                {% with ts=tops|stringformat:"s" %}
                  {% if ts == 'Ellipsis' or not tops %}
                    <div class="empty">データがありません</div>
                  {% else %}
                    <ul class="pos-list">
                      {% for p in tops %}
                        <li class="pos-row">
                          <span class="name">{{ p.ticker }} {{ p.name }}</span>
                          <span class="lot">{{ p.shares|default_if_none:0|intcomma }}株</span>
                          <span class="mv">¥{{ p.market_value|default_if_none:0|floatformat:0|intcomma }}</span>
                        </li>
                      {% empty %}
                        <li class="empty">データがありません</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                {% endwith %}
              </div>
              <div>
                <h3 class="sectタイトル">最近の動き</h3>
                {% with rs=rec|stringformat:"s" %}
                  {% if rs == 'Ellipsis' or not rec %}
                    <div class="empty">データがありません</div>
                  {% else %}
                    <ul class="mini-activity">
                      {% for a in rec %}
                        <li class="arow">
                          <span class="adate">{{ a.date|date:"n/j" }}</span>
                          <span class="amain">
                            {% if a.kind == 'trade' %}
                              {{ a.ticker }} {{ a.name }}
                            {% elif a.kind == 'dividend' %}
                              配当 {{ a.ticker }} {{ a.name }}
                            {% elif a.kind == 'cash' %}
                              現金 {{ a.broker_label }}
                            {% else %}
                              —
                            {% endif %}
                          </span>
                          <span class="aval {% if a.sign == '+' or a.pnl|default_if_none:0 >= 0 %}pos{% else %}neg{% endif %}">
                            {% if a.kind == 'trade' %}
                              {% with pnlv=a.pnl|default_if_none:0 %}
                                {% if pnlv >= 0 %}+{% endif %}¥{{ pnlv|floatformat:0|intcomma }}
                              {% endwith %}
                            {% elif a.kind == 'dividend' %}
                              ¥{{ a.net|default_if_none:0|floatformat:0|intcomma }}
                            {% elif a.kind == 'cash' %}
                              {% with am=a.amount|default_if_none:0 %}
                                {% if a.flow == 'in' %}+{% else %}-{% endif %}¥{{ am|floatformat:0|intcomma }}
                              {% endwith %}
                            {% else %}—{% endif %}
                          </span>
                        </li>
                      {% empty %}
                        <li class="empty">データがありません</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </div>
          {% endwith %}

        {% elif key == 'sbi' %}
          {% with bal=broker_balances.sbi stats=broker_stats.sbi tops=top_positions_by_broker.sbi rec=recent_by_broker.sbi %}
          <div class="pane {% if key == active_broker %}active{% endif %}" id="pane-{{ key }}">
            <div class="pane-head">
              <div class="pane-brand">
                <span class="logo">S</span>
                <div class="pane-balance">
                  <div class="k">現金残高</div>
                  {% with guard=bal|stringformat:"s" %}
                    {% if guard == 'Ellipsis' or guard == '' %}
                      <div class="v">—</div>
                    {% else %}
                      <div class="v">¥{{ bal|default_if_none:0|floatformat:0|intcomma }}</div>
                    {% endif %}
                  {% endwith %}
                </div>
              </div>
            </div>

            <div class="pill-row">
              <div class="pill">
                <span class="k">保有銘柄</span>
                {% with s=stats|stringformat:"s" %}
                  {% if s == 'Ellipsis' or not stats %}
                    <span class="v">—</span>
                  {% else %}
                    <span class="v">{{ stats.holdings_count|default_if_none:0 }}</span>
                  {% endif %}
                {% endwith %}
              </div>
              <div class="pill">
                <span class="k">時価評価</span>
                {% with s=stats|stringformat:"s" %}
                  {% if s == 'Ellipsis' or not stats %}
                    <span class="v">—</span>
                  {% else %}
                    <span class="v">¥{{ stats.market_value|default_if_none:0|floatformat:0|intcomma }}</span>
                  {% endif %}
                {% endwith %}
              </div>
              <div class="pill">
                <span class="k">含み損益</span>
                {% with s=stats|stringformat:"s" %}
                  {% if s == 'Ellipsis' or not stats %}
                    <span class="v">—</span>
                  {% else %}
                    {% with upv=stats.unrealized_pl|default_if_none:0 %}
                      <span class="v {% if upv >= 0 %}pos{% else %}neg{% endif %}">
                        {% if upv >= 0 %}+{% endif %}¥{{ upv|floatformat:0|intcomma }}
                      </span>
                    {% endwith %}
                  {% endif %}
                {% endwith %}
              </div>
            </div>

            <div class="panel-split">
              <div>
                <h3 class="sect-title">上位ポジション</h3>
                {% with ts=tops|stringformat:"s" %}
                  {% if ts == 'Ellipsis' or not tops %}
                    <div class="empty">データがありません</div>
                  {% else %}
                    <ul class="pos-list">
                      {% for p in tops %}
                        <li class="pos-row">
                          <span class="name">{{ p.ticker }} {{ p.name }}</span>
                          <span class="lot">{{ p.shares|default_if_none:0|intcomma }}株</span>
                          <span class="mv">¥{{ p.market_value|default_if_none:0|floatformat:0|intcomma }}</span>
                        </li>
                      {% empty %}
                        <li class="empty">データがありません</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                {% endwith %}
              </div>
              <div>
                <h3 class="sect-title">最近の動き</h3>
                {% with rs=rec|stringformat:"s" %}
                  {% if rs == 'Ellipsis' or not rec %}
                    <div class="empty">データがありません</div>
                  {% else %}
                    <ul class="mini-activity">
                      {% for a in rec %}
                        <li class="arow">
                          <span class="adate">{{ a.date|date:"n/j" }}</span>
                          <span class="amain">
                            {% if a.kind == 'trade' %}
                              {{ a.ticker }} {{ a.name }}
                            {% elif a.kind == 'dividend' %}
                              配当 {{ a.ticker }} {{ a.name }}
                            {% elif a.kind == 'cash' %}
                              現金 {{ a.broker_label }}
                            {% else %}
                              —
                            {% endif %}
                          </span>
                          <span class="aval {% if a.sign == '+' or a.pnl|default_if_none:0 >= 0 %}pos{% else %}neg{% endif %}">
                            {% if a.kind == 'trade' %}
                              {% with pnlv=a.pnl|default_if_none:0 %}
                                {% if pnlv >= 0 %}+{% endif %}¥{{ pnlv|floatformat:0|intcomma }}
                              {% endwith %}
                            {% elif a.kind == 'dividend' %}
                              ¥{{ a.net|default_if_none:0|floatformat:0|intcomma }}
                            {% elif a.kind == 'cash' %}
                              {% with am=a.amount|default_if_none:0 %}
                                {% if a.flow == 'in' %}+{% else %}-{% endif %}¥{{ am|floatformat:0|intcomma }}
                              {% endwith %}
                            {% else %}—{% endif %}
                          </span>
                        </li>
                      {% empty %}
                        <li class="empty">データがありません</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          </div>
          {% endwith %}
        {% else %}
          <div class="pane {% if key == active_broker %}active{% endif %}" id="pane-{{ key }}">
            <div class="empty">未対応のタブです</div>
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </section>

  <!-- ===== 実現損益 KPI ===== -->
  <section class="realized card">
    <div class="grid3" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
      {% with m=realized_pl_mtd|default_if_none:0 %}
      <div class="kpi">
        <div class="k">今月の実現損益</div>
        <div class="v pn {% if m >= 0 %}pos{% else %}neg{% endif %}">
          {% if m >= 0 %}+{% endif %}¥{{ m|floatformat:0|intcomma }}
        </div>
      </div>
      {% endwith %}
      {% with y=realized_pl_ytd|default_if_none:0 %}
      <div class="kpi">
        <div class="k">今年の実現損益</div>
        <div class="v pn {% if y >= 0 %}pos{% else %}neg{% endif %}">
          {% if y >= 0 %}+{% endif %}¥{{ y|floatformat:0|intcomma }}
        </div>
      </div>
      {% endwith %}
      {% with t=realized_pl_total|default_if_none:0 %}
      <div class="kpi">
        <div class="k">累計の実現損益</div>
        <div class="v pn {% if t >= 0 %}pos{% else %}neg{% endif %}">
          {% if t >= 0 %}+{% endif %}¥{{ t|floatformat:0|intcomma }}
        </div>
      </div>
      {% endwith %}
    </div>
    <a class="btn link" href="{% url 'realized' %}">実現一覧へ</a>
  </section>

  <!-- ===== 最近のアクティビティ（全体） ===== -->
  <section class="activity card">
    <div class="activity-head">
      <h3 class="sect-title">最近のアクティビティ</h3>
      <div class="chips">
        <button class="chip {% if request.GET.range|default_if_none:'' == '7' or not request.GET.range %}active{% endif %}" data-range="7" type="button">7日</button>
        <button class="chip {% if request.GET.range == '30' %}active{% endif %}" data-range="30" type="button">30日</button>
        <button class="chip {% if request.GET.range == '90' %}active{% endif %}" data-range="90" type="button">90日</button>
        <button class="chip {% if request.GET.range == 'all' %}active{% endif %}" data-range="all" type="button">すべて</button>
      </div>
    </div>

    <ul class="timeline" id="timeline">
      {% if recent_activities %}
        {% for a in recent_activities %}
          <li class="trow type-{{ a.kind }}">
            <div class="tdate">{{ a.date|date:"n/j" }}</div>
            <div class="tbody">
              <div class="tline">
                <span class="tbadge">{{ a.kind_label }}</span>
                <span class="tmain">
                  {% if a.kind == 'trade' %}
                    {{ a.ticker }} {{ a.name }} /
                    {% with p=a.pnl|default_if_none:0 %}
                      {% if p >= 0 %}+{% endif %}¥{{ p|floatformat:0|intcomma }}
                    {% endwith %}
                  {% elif a.kind == 'dividend' %}
                    配当 {{ a.ticker }} {{ a.name }} /
                    受取 ¥{{ a.net|default_if_none:0|floatformat:0|intcomma }}
                  {% elif a.kind == 'cash' %}
                    {% with amt=a.amount|default_if_none:0 %}
                      現金 {{ a.broker_label }} /
                      {% if a.flow == 'in' %}+{% else %}-{% endif %}¥{{ amt|floatformat:0|intcomma }}
                    {% endwith %}
                  {% else %}—{% endif %}
                </span>
              </div>
              {% if a.memo %}<div class="tmemo">{{ a.memo }}</div>{% endif %}
            </div>
          </li>
        {% empty %}
          <li class="empty">まだデータがありません</li>
        {% endfor %}
      {% else %}
        <li class="empty">まだデータがありません</li>
      {% endif %}
    </ul>
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/main.js' %}" defer></script>
{% endblock %}