{% extends "base.html" %}
{% load static humanize %}

{% block title %}ホーム{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock %}

{% block content %}
<div class="home-page">

  {# ===== HERO（総資産＋リング＋ミニKPI＋スパーク） ===== #}
  <header class="hero card glass">
    <div class="hero-grid">
      <div class="hero-core">
        <div class="ring"
             data-value="{{ total_assets|default:'0' }}"
             data-max="{{ target_assets|default:'0' }}">
          <svg viewBox="0 0 120 120" aria-hidden="true">
            <circle cx="60" cy="60" r="50" class="bg"></circle>
            <circle cx="60" cy="60" r="50" class="fg"></circle>
          </svg>
          <div class="ring-center">
            <div class="ring-title">総資産</div>
            <div class="ring-figure">¥{{ total_assets|default:"0"|floatformat:0|intcomma }}</div>
            <div class="ring-sub">
              前日比
              <b class="pn {% if day_change|default:"0"|floatformat:0|add:"0" >= 0 %}pos{% else %}neg{% endif %}">
                {% if day_change|default:"0"|floatformat:0|add:"0" >= 0 %}+{% endif %}¥{{ day_change|default:"0"|floatformat:0|intcomma }}
              </b>
            </div>
          </div>
        </div>
      </div>

      <div class="hero-metrics">
        <div class="mini">
          <div class="k">評価額</div>
          <div class="v">¥{{ portfolio_value|default:"0"|floatformat:0|intcomma }}</div>
        </div>
        <div class="mini">
          <div class="k">現金</div>
          <div class="v">¥{{ cash_total|default:"0"|floatformat:0|intcomma }}</div>
        </div>
        <div class="mini">
          <div class="k">含み損益</div>
          <div class="v pn {% if unrealized_pl|default:"0"|floatformat:0|add:"0" >= 0 %}pos{% else %}neg{% endif %}">
            {% if unrealized_pl|default:"0"|floatformat:0|add:"0" >= 0 %}+{% endif %}¥{{ unrealized_pl|default:"0"|floatformat:0|intcomma }}
          </div>
        </div>
      </div>

      <div class="spark" id="assetSpark" data-points="{{ asset_history_csv|default:'' }}"></div>
    </div>
  </header>

  {# ===== ブローカー：タブ（横スライドではなく、明確なセグメント） ===== #}
  <section class="brokers card glass">
    <nav class="tabs" role="tablist" aria-label="証券会社">
      {% for b in brokers %}
        <button class="tab {% if forloop.first %}active{% endif %}"
                role="tab"
                aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
                data-tab="{{ b.key }}">{{ b.label }}</button>
      {% endfor %}
    </nav>

    <div class="panes">
      {% for b in brokers %}
        <div class="pane {% if forloop.first %}active{% endif %}" id="pane-{{ b.key }}" role="tabpanel">
          <div class="pane-head">
            <div class="pane-brand">
              <div class="logo">{{ b.label|slice:":1" }}</div>
              <div class="name">{{ b.label }}</div>
            </div>
            <div class="pane-balance">
              <span class="k">残高</span>
              <span class="v">¥{{ b.balance|default:"0"|floatformat:0|intcomma }}</span>
            </div>
          </div>

          <div class="pill-row">
            <div class="pill">
              <div class="k">保有銘柄</div>
              <div class="v">{{ b.holdings_count|default:"0"|intcomma }}銘柄</div>
            </div>
            <div class="pill">
              <div class="k">時価評価</div>
              <div class="v">¥{{ b.market_value|default:"0"|floatformat:0|intcomma }}</div>
            </div>
            <div class="pill">
              <div class="k">含み損益</div>
              <div class="v pn {% if b.unrealized_pl|default:"0"|floatformat:0|add:"0" >= 0 %}pos{% else %}neg{% endif %}">
                {% if b.unrealized_pl|default:"0"|floatformat:0|add:"0" >= 0 %}+{% endif %}¥{{ b.unrealized_pl|default:"0"|floatformat:0|intcomma }}
              </div>
            </div>
          </div>

          <div class="panel-split">
            <div class="panel-left">
              <h3 class="sect-title">上位ポジション</h3>
              <ul class="pos-list">
                {% for p in b.top_positions %}
                  <li class="pos-row">
                    <span class="name">{{ p.ticker }} {{ p.name }}</span>
                    <span class="lot">{{ p.shares|intcomma }}株</span>
                    <span class="mv">¥{{ p.market_value|floatformat:0|intcomma }}</span>
                  </li>
                {% empty %}
                  <li class="empty">データがありません</li>
                {% endfor %}
              </ul>
            </div>

            <div class="panel-right">
              <h3 class="sect-title">直近アクティビティ</h3>
              <ul class="mini-activity">
                {% for a in b.recent|default:[] %}
                  <li class="arow type-{{ a.kind }}">
                    <span class="adate">{{ a.date|date:"n/j" }}</span>
                    <span class="amain">
                      {% if a.kind == 'trade' %}
                        {{ a.ticker }} {{ a.name }}
                      {% elif a.kind == 'dividend' %}
                        配当 {{ a.ticker }} {{ a.name }}
                      {% elif a.kind == 'cash' %}
                        現金 {{ a.flow|upper }}
                      {% else %}
                        {{ a.title|default:"" }}
                      {% endif %}
                    </span>
                    <span class="aval {% if a.sign|default:'+' == '+' %}pos{% else %}neg{% endif %}">
                      {% if a.sign|default:'+' == '+' %}+{% else %}-{% endif %}¥{{ a.amount|default:"0"|floatformat:0|intcomma }}
                    </span>
                  </li>
                {% empty %}
                  <li class="empty small">まだありません</li>
                {% endfor %}
              </ul>
            </div>
          </div>

        </div>
      {% endfor %}
    </div>
  </section>

  {# ===== KPIダッシュ（モジュール化されたゲージ3つ） ===== #}
  <section class="gauges card glass">
    <div class="gauge" data-val="{{ realized_pl_mtd|default:'0' }}">
      <div class="g-title">今月の実現損益</div>
      <div class="g-figure pn {% if realized_pl_mtd|default:'0'|floatformat:0|add:'0' >= 0 %}pos{% else %}neg{% endif %}">
        {% if realized_pl_mtd|default:'0'|floatformat:0|add:'0' >= 0 %}+{% endif %}¥{{ realized_pl_mtd|default:'0'|floatformat:0|intcomma }}
      </div>
      <div class="g-bar"><span></span></div>
    </div>
    <div class="gauge" data-val="{{ realized_pl_ytd|default:'0' }}">
      <div class="g-title">今年の実現損益</div>
      <div class="g-figure pn {% if realized_pl_ytd|default:'0'|floatformat:0|add:'0' >= 0 %}pos{% else %}neg{% endif %}">
        {% if realized_pl_ytd|default:'0'|floatformat:0|add:'0' >= 0 %}+{% endif %}¥{{ realized_pl_ytd|default:'0'|floatformat:0|intcomma }}
      </div>
      <div class="g-bar"><span></span></div>
    </div>
    <div class="gauge" data-val="{{ realized_pl_total|default:'0' }}">
      <div class="g-title">累計の実現損益</div>
      <div class="g-figure pn {% if realized_pl_total|default:'0'|floatformat:0|add:'0' >= 0 %}pos{% else %}neg{% endif %}">
        {% if realized_pl_total|default:'0'|floatformat:0|add:'0' >= 0 %}+{% endif %}¥{{ realized_pl_total|default:'0'|floatformat:0|intcomma }}
      </div>
      <div class="g-bar"><span></span></div>
    </div>
  </section>

  {# ===== 統合タイムライン（グローバル） ===== #}
  <section class="activity card glass">
    <div class="activity-head">
      <h3 class="sect-title">最近のアクティビティ</h3>
      <div class="chips">
        {# range クエリでフィルタ #}
        {% with r=request.GET.range|default:"7" %}
          <button class="chip {% if r == '7' %}active{% endif %}"  data-range="7">7日</button>
          <button class="chip {% if r == '30' %}active{% endif %}" data-range="30">30日</button>
          <button class="chip {% if r == '90' %}active{% endif %}" data-range="90">90日</button>
          <button class="chip {% if r == 'all' %}active{% endif %}" data-range="all">すべて</button>
        {% endwith %}
      </div>
    </div>

    <ul class="chiplist" id="timeline">
      {% for a in recent_activities|default:[] %}
        <li class="chiprow type-{{ a.kind }}">
          <span class="cdate">{{ a.date|date:"n/j" }}</span>
          <span class="cbadge">
            {% if a.kind == 'trade' %}売買{% elif a.kind == 'dividend' %}配当{% elif a.kind == 'cash' %}現金{% else %}その他{% endif %}
          </span>
          <span class="cmain">
            {% if a.kind == 'trade' %}
              {{ a.ticker }} {{ a.name }}
            {% elif a.kind == 'dividend' %}
              配当 {{ a.ticker }} {{ a.name }}
            {% elif a.kind == 'cash' %}
              {{ a.broker_label }} {{ a.flow|upper }}
            {% else %}
              {{ a.title|default:"" }}
            {% endif %}
          </span>
          <span class="cval {% if a.sign|default:'+' == '+' %}pos{% else %}neg{% endif %}">
            {% if a.sign|default:'+' == '+' %}+{% else %}-{% endif %}¥{{ a.amount|default:'0'|floatformat:0|intcomma }}
          </span>
          {% if a.memo %}<span class="cmemo">{{ a.memo }}</span>{% endif %}
        </li>
      {% empty %}
        <li class="empty">まだデータがありません</li>
      {% endfor %}
    </ul>
  </section>

  {% include "bottom_tab.html" %}
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/main.js' %}" defer></script>
{% endblock %}