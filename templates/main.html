{% extends "base.html" %}
{% load humanize %}

{% block title %}ホーム（ミニ）{% endblock %}

{% block content %}
<style>
  /* 最小＆モバイル優先、読みやすさ重視 */
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .hero{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:16px}
  .hero .label{opacity:.75;font-size:13px}
  .hero .total{font-weight:900;font-size:28px}
  .row{display:grid;grid-template-columns:1fr;gap:12px;margin:12px 0}
  @media(min-width:560px){.row{grid-template-columns:1fr 1fr}}
  .tile{padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:12px;background:rgba(255,255,255,.06)}
  .tile h3{margin:0 0 8px;font-size:14px;opacity:.85}
  .amt{font-weight:800}
  .pos{color:#22c55e}.neg{color:#ef4444}
  .muted{opacity:.8}
  .spark{height:64px;border:1px solid rgba(255,255,255,.2);border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-top:8px}
  .list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
  .item{display:grid;grid-template-columns:70px 1fr auto;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:8px;background:rgba(255,255,255,.06)}
  .date{opacity:.8;font-size:12px}

  /* Debug table */
  .debug-section{margin-top:20px}
  .debug-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin:8px 0}
  .debug-wrap{overflow:auto;border:1px solid rgba(255,255,255,.2);border-radius:10px}
  table.debug{width:100%;min-width:1080px;border-collapse:separate;border-spacing:0;background:rgba(255,255,255,.04)}
  table.debug th,table.debug td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.12);font-size:13px;vertical-align:middle;white-space:nowrap}
  table.debug thead th{position:sticky;top:0;background:rgba(255,255,255,.08);backdrop-filter:blur(6px)}
  table.debug tr:last-child td{border-bottom:none}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .ok{color:#22c55e}.ng{color:#ef4444}
</style>

<div class="wrap">

  <!-- 総資産（中央表示） -->
  <section class="hero">
    <div class="label">総資産</div>
    <div class="total">
      ¥{{ total_assets|default_if_none:0|floatformat:0|intcomma }}
    </div>
    <div class="spark" id="assetSpark" data-points="{{ asset_history_csv|default_if_none:'' }}"></div>
  </section>

  <!-- 評価額 / 含み損益 / 現金 -->
  <section class="row">
    <div class="tile">
      <h3>現物（現物 + NISA）</h3>
      <div class="amt">
        評価額 ¥{{ spot_market_value|default_if_none:0|floatformat:0|intcomma }}
      </div>
      {% with p=spot_unrealized_pl|default_if_none:0 %}
        <div class="muted">
          含み損益
          <span class="{% if p >= 0 %}pos{% else %}neg{% endif %}">
            {% if p >= 0 %}+{% endif %}¥{{ p|floatformat:0|intcomma }}
          </span>
        </div>
      {% endwith %}
    </div>

    <div class="tile">
      <h3>信用</h3>
      <div class="amt">
        評価額 ¥{{ margin_market_value|default_if_none:0|floatformat:0|intcomma }}
      </div>
      {% with p=margin_unrealized_pl|default_if_none:0 %}
        <div class="muted">
          含み損益
          <span class="{% if p >= 0 %}pos{% else %}neg{% endif %}">
            {% if p >= 0 %}+{% endif %}¥{{ p|floatformat:0|intcomma }}
          </span>
        </div>
      {% endwith %}
    </div>

    <div class="tile">
      <h3>現金合計</h3>
      <div class="amt">¥{{ cash_total|default_if_none:0|floatformat:0|intcomma }}</div>
    </div>

    <div class="tile">
      <h3>含み損益（合計）</h3>
      {% with p=unrealized_pl_total|default_if_none:0 %}
        <div class="amt {% if p >= 0 %}pos{% else %}neg{% endif %}">
          {% if p >= 0 %}+{% endif %}¥{{ p|floatformat:0|intcomma }}
        </div>
      {% endwith %}
    </div>
  </section>

  <!-- 最近のアクティビティ（10件まで表示想定） -->
  <section>
    <h3 class="muted" style="margin:8px 0">最近のアクティビティ</h3>
    {% if recent_activities %}
      <ul class="list">
        {% for a in recent_activities %}
          <li class="item">
            <span class="date">{{ a.date|date:"n/j" }}</span>

            {% if a.kind == 'trade' %}
              <span>{{ a.ticker }} {{ a.name }}</span>
              {% with v=a.pnl|default_if_none:0 %}
                <span class="{% if v >= 0 %}pos{% else %}neg{% endif %}">
                  {% if v >= 0 %}+{% endif %}¥{{ v|floatformat:0|intcomma }}
                </span>
              {% endwith %}

            {% elif a.kind == 'dividend' %}
              <span>配当 {{ a.ticker }} {{ a.name }}</span>
              <span class="pos">+¥{{ a.net|default_if_none:0|intcomma }}</span>

            {% elif a.kind == 'cash' %}
              {% with amt=a.amount|default_if_none:0 %}
                <span>現金 {{ a.broker_label }}</span>
                <span class="{% if a.flow == 'in' %}pos{% else %}neg{% endif %}">
                  {% if a.flow == 'in' %}+{% else %}-{% endif %}¥{{ amt|intcomma }}
                </span>
              {% endwith %}

            {% else %}
              <span>—</span><span></span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="muted">まだデータがありません</div>
    {% endif %}
  </section>

  {# ====== Debug（holdings_debug があるときだけ表示） ====== #}
  {% if holdings_debug %}
  <section class="debug-section">
    <div class="debug-head">
      <h3 class="muted" style="margin:0">Holdings Debug</h3>
      {% if debug_totals %}
        <div class="muted" style="font-size:13px">
          現物MV: {{ debug_totals.spot_mv|default_if_none:0|floatformat:0|intcomma }}
          ／ 信用MV: {{ debug_totals.margin_mv|default_if_none:0|floatformat:0|intcomma }}
          ／ 現物UPL: {{ debug_totals.spot_upl|default_if_none:0|intcomma }}
          ／ 信用UPL: {{ debug_totals.margin_upl|default_if_none:0|intcomma }}
        </div>
      {% endif %}
    </div>

    <div class="debug-wrap">
      <table class="debug">
        <thead>
          <tr>
            <th>ID</th>
            <th>コード</th>
            <th>銘柄</th>
            <th class="num">株数</th>
            <th class="num">取得単価</th>
            <th class="num">現在値</th>
            <th class="num">計算で使った価格</th>
            <th class="num">取得額(total_cost)</th>
            <th class="num">評価額</th>
            <th class="num">含み損益</th>
            <th>口座</th>
            <th>ポジ</th>
            <th>グループ</th>
          </tr>
        </thead>
        <tbody>
          {% for r in holdings_debug %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.ticker }}</td>
            <td>{{ r.name }}</td>
            <td class="num">{{ r.shares|default_if_none:0|floatformat:0|intcomma }}</td>
            <td class="num">{{ r.unit_price|default_if_none:0|floatformat:2|intcomma }}</td>
            <td class="num">{{ r.current_price|default_if_none:0|floatformat:2|intcomma }}</td>
            <td class="num">{{ r.price_used|default_if_none:0|floatformat:2|intcomma }}</td>
            <td class="num">{{ r.total_cost|default_if_none:0|floatformat:0|intcomma }}</td>
            <td class="num">{{ r.mv_calc|default_if_none:0|floatformat:0|intcomma }}</td>
            <td class="num {% if r.upl_calc >= 0 %}ok{% else %}ng{% endif %}">
              {% if r.upl_calc >= 0 %}+{% endif %}{{ r.upl_calc|default_if_none:0|floatformat:0|intcomma }}
            </td>
            <td>{{ r.account_type }}</td>
            <td>{{ r.position }}</td>
            <td>{{ r.group }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <p class="muted" style="margin-top:8px;font-size:12px">
      ※「計算で使った価格」は <strong>現在値が0なら取得単価</strong> を使用しています。<br>
      ※ 含み損益は「買い: 評価額 − 取得額」「売り: (取得単価 − 価格) × 株数」です。
    </p>
  </section>
  {% endif %}

</div>

<script>
/* シンプルなスパークライン描画（値が無ければメッセージ） */
(function renderSpark(){
  const el = document.getElementById('assetSpark');
  if(!el) return;
  const raw = (el.getAttribute('data-points')||'').trim();
  if(!raw){ el.textContent='データなし'; return; }
  const vals = raw.split(',').map(s=>parseFloat(s)).filter(v=>!Number.isNaN(v));
  if(vals.length<2){ el.textContent='データ不足'; return; }
  const w = el.clientWidth||320, h = el.clientHeight||64, pad=4;
  const min = Math.min(...vals), max = Math.max(...vals);
  const x = i => pad + (w-pad*2)*(i/(vals.length-1));
  const y = v => max===min ? h/2 : pad + (1-((v-min)/(max-min)))*(h-pad*2);
  const pts = vals.map((v,i)=>`${x(i)},${y(v)}`).join(' ');
  el.innerHTML = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
    <polyline points="${pts}" fill="none" stroke="rgba(96,165,250,1)" stroke-width="2"/>
    <polyline points="${pts}" fill="none" stroke="rgba(96,165,250,.35)" stroke-width="6" opacity=".35"/>
  </svg>`;
})();
</script>
{% endblock %}