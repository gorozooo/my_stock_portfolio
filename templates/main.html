{% extends "base.html" %}
{% load humanize %}

{% block title %}ホーム（ミニ）{% endblock %}

{% block content %}
<style>
  /* 最小&モバイル優先の軽量スタイル */
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .hero{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:16px}
  .hero .total{font-weight:900;font-size:28px}
  .row{display:grid;grid-template-columns:1fr;gap:10px;margin:12px 0}
  @media(min-width:560px){.row{grid-template-columns:1fr 1fr}}
  .tile{padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:12px;background:rgba(255,255,255,.06)}
  .tile h3{margin:0 0 8px;font-size:14px;opacity:.8}
  .amt{font-weight:800}
  .pos{color:#22c55e}.neg{color:#ef4444}
  .muted{opacity:.8}
  .spark{height:64px;border:1px solid rgba(255,255,255,.2);border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-top:8px}
  .list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
  .item{display:grid;grid-template-columns:70px 1fr auto;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:8px;background:rgba(255,255,255,.06)}
  .date{opacity:.8;font-size:12px}
</style>

<div class="wrap">

  <!-- 総資産（中央表示） -->
  <section class="hero">
    <div class="label muted">総資産</div>
    <div class="total">¥{{ total_assets|floatformat:0|intcomma }}</div>
    <div class="spark" id="assetSpark" data-points="{{ asset_history_csv|default_if_none:'' }}"></div>
  </section>

  <!-- 評価額 / 含み損益 / 現金 -->
  <section class="row">
    <div class="tile">
      <h3>現物（現物 + NISA）</h3>
      <div class="amt">評価額 ¥{{ spot_market_value|floatformat:0|intcomma }}</div>
      {% with p=spot_unrealized_pl|default_if_none:0 %}
        <div class="muted">含み損益 <span class="{% if p >= 0 %}pos{% else %}neg{% endif %}">
          {% if p >= 0 %}+{% endif %}¥{{ p|floatformat:0|intcomma }}</span></div>
      {% endwith %}
    </div>

    <div class="tile">
      <h3>信用</h3>
      <div class="amt">評価額 ¥{{ margin_market_value|floatformat:0|intcomma }}</div>
      {% with p=margin_unrealized_pl|default_if_none:0 %}
        <div class="muted">含み損益 <span class="{% if p >= 0 %}pos{% else %}neg{% endif %}">
          {% if p >= 0 %}+{% endif %}¥{{ p|floatformat:0|intcomma }}</span></div>
      {% endwith %}
    </div>

    <div class="tile">
      <h3>現金合計</h3>
      <div class="amt">¥{{ cash_total|floatformat:0|intcomma }}</div>
    </div>

    <div class="tile">
      <h3>含み損益（合計）</h3>
      {% with p=unrealized_pl_total|default_if_none:0 %}
        <div class="amt {% if p >= 0 %}pos{% else %}neg{% endif %}">
          {% if p >= 0 %}+{% endif %}¥{{ p|floatformat:0|intcomma }}</div>
      {% endwith %}
    </div>
  </section>

  <!-- 最近のアクティビティ（10件） -->
  <section>
    <h3 class="muted" style="margin:8px 0">最近のアクティビティ</h3>
    {% if recent_activities %}
      <ul class="list">
        {% for a in recent_activities %}
          <li class="item">
            <span class="date">{{ a.date|date:"n/j" }}</span>
            {% if a.kind == 'trade' %}
              <span>{{ a.ticker }} {{ a.name }}</span>
              {% with v=a.pnl|default_if_none:0 %}
                <span class="{% if v >= 0 %}pos{% else %}neg{% endif %}">
                  {% if v >= 0 %}+{% endif %}¥{{ v|floatformat:0|intcomma }}
                </span>
              {% endwith %}
            {% elif a.kind == 'dividend' %}
              <span>配当 {{ a.ticker }} {{ a.name }}</span>
              <span class="pos">+¥{{ a.net|default_if_none:0|intcomma }}</span>
            {% else %}
              <span>—</span><span></span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="muted">まだデータがありません</div>
    {% endif %}
  </section>

</div>

<!-- とりあえずインラインJS（静的ファイル化は後でOK） -->
<script>
(function renderSpark(){
  const el = document.getElementById('assetSpark');
  if(!el) return;
  const raw = (el.getAttribute('data-points')||'').trim();
  if(!raw){ el.textContent='データなし'; return; }
  const vals = raw.split(',').map(s=>parseFloat(s)).filter(v=>!Number.isNaN(v));
  if(vals.length<2){ el.textContent='データ不足'; return; }
  const w = el.clientWidth||320, h = el.clientHeight||64, pad=4;
  const min = Math.min(...vals), max = Math.max(...vals);
  const x = i => pad + (w-pad*2)*(i/(vals.length-1));
  const y = v => max===min ? h/2 : pad + (1-((v-min)/(max-min)))*(h-pad*2);
  const pts = vals.map((v,i)=>`${x(i)},${y(v)}`).join(' ');
  el.innerHTML = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
    <polyline points="${pts}" fill="none" stroke="rgba(96,165,250,1)" stroke-width="2"/>
    <polyline points="${pts}" fill="none" stroke="rgba(96,165,250,.35)" stroke-width="6" opacity=".35"/>
  </svg>`;
})();
</script>
{% endblock %}