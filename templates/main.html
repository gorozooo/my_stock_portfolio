{% extends "base.html" %}
{% load static humanize %}

{% block title %}ãƒ›ãƒ¼ãƒ {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock %}

{% block content %}
<div class="home-page">

  {# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ #}
  {% if messages %}
    <ul class="msgs">
      {% for m in messages %}
        <li class="msg {{ m.tags }}">{{ m }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {# ===== ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆç·è³‡ç”£ + å°ã•ãªã‚µãƒãƒªãƒ¼ï¼‰ ===== #}
  <header class="hero card">
    <div class="hero-top">
      <h1 class="hero-title">ç·è³‡ç”£</h1>
      <div class="hero-actions">
        <a class="btn ghost" href="{% url 'cash_io' %}">å…¥å‡ºé‡‘</a>
        <a class="btn ghost" href="{% url 'stock_list' %}">ä¿æœ‰æ ª</a>
      </div>
    </div>

    <div class="hero-main">
      <div class="asset-figure" data-value="{{ total_assets|default:0 }}">
        Â¥{{ total_assets|default:0|floatformat:0|intcomma }}
      </div>
      <div class="asset-sub">
        <span>å‰æ—¥æ¯”</span>
        <strong class="pn {% if day_change|default:0 >= 0 %}pos{% else %}neg{% endif %}">
          {% if day_change|default:0 >= 0 %}+{% endif %}Â¥{{ day_change|default:0|floatformat:0|intcomma }}
        </strong>
      </div>
    </div>

    <div class="hero-mini">
      <div class="mini">
        <span class="k">è©•ä¾¡é¡</span>
        <span class="v">Â¥{{ portfolio_value|default:0|floatformat:0|intcomma }}</span>
      </div>
      <div class="mini">
        <span class="k">ç¾é‡‘</span>
        <span class="v">Â¥{{ cash_total|default:0|floatformat:0|intcomma }}</span>
      </div>
      <div class="mini">
        <span class="k">å«ã¿æç›Š</span>
        <span class="v {% if unrealized_pl|default:0 >= 0 %}pos{% else %}neg{% endif %}">
          {% if unrealized_pl|default:0 >= 0 %}+{% endif %}Â¥{{ unrealized_pl|default:0|floatformat:0|intcomma }}
        </span>
      </div>
    </div>

    {# ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼ˆè»½é‡SVGï¼‰ #}
    <div class="sparkline" id="assetSpark"
         data-points="{{ asset_history_csv|default:'' }}"></div>
  </header>

  {# ===== ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼åˆ¥ï¼ˆã‚¿ãƒ–ï¼‰ ===== #}
  <section class="brokers card">
    <nav class="tabs" role="tablist" aria-label="è¨¼åˆ¸ä¼šç¤¾">
      {% for key,label in broker_tabs %}
        <button class="tab {% if key == active_broker %}active{% endif %}"
                data-tab="{{ key }}">{{ label }}</button>
      {% endfor %}
    </nav>

    <div class="panes">
      {% for key,label in broker_tabs %}
        <div class="pane {% if key == active_broker %}active{% endif %}" id="pane-{{ key }}">

          {# å‹•çš„ã‚­ãƒ¼å‚ç…§ã¯ with ã‚’åˆ†å²ã”ã¨ã«é–‰ã˜ã‚‹ #}
          {% if key == 'rakuten' %}
            {% with bal=broker_balances.rakuten stats=broker_stats.rakuten tops=top_positions_by_broker.rakuten %}
              <div class="pill-row">
                <div class="pill">
                  <span class="k">æ®‹é«˜</span>
                  <span class="v">Â¥{{ bal|default:0|floatformat:0|intcomma }}</span>
                </div>
                <div class="pill">
                  <span class="k">ä¿æœ‰éŠ˜æŸ„</span>
                  <span class="v">{{ stats.holdings_count|default:0 }}</span>
                </div>
                <div class="pill">
                  <span class="k">æ™‚ä¾¡è©•ä¾¡</span>
                  <span class="v">Â¥{{ stats.market_value|default:0|floatformat:0|intcomma }}</span>
                </div>
              </div>

              <div class="toppos">
                <h3 class="sect-title">ä¸Šä½ãƒã‚¸ã‚·ãƒ§ãƒ³</h3>
                <ul class="pos-list">
                  {% if tops %}
                    {% for p in tops %}
                      <li class="pos-row">
                        <span class="name">{{ p.ticker }} {{ p.name }}</span>
                        <span class="lot">{{ p.shares|intcomma }}æ ª</span>
                        <span class="mv">Â¥{{ p.market_value|floatformat:0|intcomma }}</span>
                      </li>
                    {% empty %}
                      <li class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>
                    {% endfor %}
                  {% else %}
                    <li class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>
                  {% endif %}
                </ul>
              </div>
            {% endwith %}

          {% elif key == 'matsui' %}
            {% with bal=broker_balances.matsui stats=broker_stats.matsui tops=top_positions_by_broker.matsui %}
              <div class="pill-row">
                <div class="pill">
                  <span class="k">æ®‹é«˜</span>
                  <span class="v">Â¥{{ bal|default:0|floatformat:0|intcomma }}</span>
                </div>
                <div class="pill">
                  <span class="k">ä¿æœ‰éŠ˜æŸ„</span>
                  <span class="v">{{ stats.holdings_count|default:0 }}</span>
                </div>
                <div class="pill">
                  <span class="k">æ™‚ä¾¡è©•ä¾¡</span>
                  <span class="v">Â¥{{ stats.market_value|default:0|floatformat:0|intcomma }}</span>
                </div>
              </div>

              <div class="toppos">
                <h3 class="sect-title">ä¸Šä½ãƒã‚¸ã‚·ãƒ§ãƒ³</h3>
                <ul class="pos-list">
                  {% if tops %}
                    {% for p in tops %}
                      <li class="pos-row">
                        <span class="name">{{ p.ticker }} {{ p.name }}</span>
                        <span class="lot">{{ p.shares|intcomma }}æ ª</span>
                        <span class="mv">Â¥{{ p.market_value|floatformat:0|intcomma }}</span>
                      </li>
                    {% empty %}
                      <li class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>
                    {% endfor %}
                  {% else %}
                    <li class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>
                  {% endif %}
                </ul>
              </div>
            {% endwith %}

          {% elif key == 'sbi' %}
            {% with bal=broker_balances.sbi stats=broker_stats.sbi tops=top_positions_by_broker.sbi %}
              <div class="pill-row">
                <div class="pill">
                  <span class="k">æ®‹é«˜</span>
                  <span class="v">Â¥{{ bal|default:0|floatformat:0|intcomma }}</span>
                </div>
                <div class="pill">
                  <span class="k">ä¿æœ‰éŠ˜æŸ„</span>
                  <span class="v">{{ stats.holdings_count|default:0 }}</span>
                </div>
                <div class="pill">
                  <span class="k">æ™‚ä¾¡è©•ä¾¡</span>
                  <span class="v">Â¥{{ stats.market_value|default:0|floatformat:0|intcomma }}</span>
                </div>
              </div>

              <div class="toppos">
                <h3 class="sect-title">ä¸Šä½ãƒã‚¸ã‚·ãƒ§ãƒ³</h3>
                <ul class="pos-list">
                  {% if tops %}
                    {% for p in tops %}
                      <li class="pos-row">
                        <span class="name">{{ p.ticker }} {{ p.name }}</span>
                        <span class="lot">{{ p.shares|intcomma }}æ ª</span>
                        <span class="mv">Â¥{{ p.market_value|floatformat:0|intcomma }}</span>
                      </li>
                    {% empty %}
                      <li class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>
                    {% endfor %}
                  {% else %}
                    <li class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>
                  {% endif %}
                </ul>
              </div>
            {% endwith %}

          {% else %}
            {% with bal=0 stats=None tops=None %}
              <div class="pill-row">
                <div class="pill">
                  <span class="k">æ®‹é«˜</span>
                  <span class="v">Â¥{{ bal|default:0|floatformat:0|intcomma }}</span>
                </div>
                <div class="pill">
                  <span class="k">ä¿æœ‰éŠ˜æŸ„</span>
                  <span class="v">{{ stats.holdings_count|default:0 }}</span>
                </div>
                <div class="pill">
                  <span class="k">æ™‚ä¾¡è©•ä¾¡</span>
                  <span class="v">Â¥{{ stats.market_value|default:0|floatformat:0|intcomma }}</span>
                </div>
              </div>

              <div class="toppos">
                <h3 class="sect-title">ä¸Šä½ãƒã‚¸ã‚·ãƒ§ãƒ³</h3>
                <ul class="pos-list">
                  <li class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>
                </ul>
              </div>
            {% endwith %}
          {% endif %}

        </div>
      {% endfor %}
    </div>
  </section>

  {# ===== å®Ÿç¾æç›Šï¼ˆä»Šæœˆ / ä»Šå¹´ / ç´¯è¨ˆï¼‰ ===== #}
  <section class="realized card">
    <div class="grid3">
      <div class="kpi">
        <div class="k">ä»Šæœˆã®å®Ÿç¾æç›Š</div>
        <div class="v pn {% if realized_pl_mtd|default:0 >= 0 %}pos{% else %}neg{% endif %}">
          {% if realized_pl_mtd|default:0 >= 0 %}+{% endif %}Â¥{{ realized_pl_mtd|default:0|floatformat:0|intcomma }}
        </div>
      </div>
      <div class="kpi">
        <div class="k">ä»Šå¹´ã®å®Ÿç¾æç›Š</div>
        <div class="v pn {% if realized_pl_ytd|default:0 >= 0 %}pos{% else %}neg{% endif %}">
          {% if realized_pl_ytd|default:0 >= 0 %}+{% endif %}Â¥{{ realized_pl_ytd|default:0|floatformat:0|intcomma }}
        </div>
      </div>
      <div class="kpi">
        <div class="k">ç´¯è¨ˆã®å®Ÿç¾æç›Š</div>
        <div class="v pn {% if realized_pl_total|default:0 >= 0 %}pos{% else %}neg{% endif %}">
          {% if realized_pl_total|default:0 >= 0 %}+{% endif %}Â¥{{ realized_pl_total|default:0|floatformat:0|intcomma }}
        </div>
      </div>
    </div>
    <a class="btn link" href="{% url 'realized' %}">å®Ÿç¾ä¸€è¦§ã¸</a>
  </section>

  {# ===== æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ï¼ˆçµ±åˆã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ï¼‰ ===== #}
  <section class="activity card">
    <div class="activity-head">
      <h3 class="sect-title">æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h3>
      <div class="chips">
        <button class="chip active" data-range="7">7æ—¥</button>
        <button class="chip" data-range="30">30æ—¥</button>
        <button class="chip" data-range="90">90æ—¥</button>
        <button class="chip" data-range="all">ã™ã¹ã¦</button>
      </div>
    </div>

    <ul class="timeline" id="timeline">
      {% for a in recent_activities %}
        <li class="trow type-{{ a.kind }}">
          <div class="tdate">{{ a.date|date:"n/j" }}</div>
          <div class="tbody">
            <div class="tline">
              <span class="tbadge">{{ a.kind_label }}</span>
              <span class="tmain">
                {% if a.kind == 'trade' %}
                  {{ a.ticker }} {{ a.name }} / {% if a.pnl >= 0 %}+{% endif %}Â¥{{ a.pnl|floatformat:0|intcomma }}
                {% elif a.kind == 'dividend' %}
                  é…å½“ {{ a.ticker }} {{ a.name }} / å—å– Â¥{{ a.net|floatformat:0|intcomma }}
                {% elif a.kind == 'cash' %}
                  ç¾é‡‘ {{ a.broker_label }} / {% if a.flow == 'in' %}+{% else %}-{% endif %}Â¥{{ a.amount|floatformat:0|intcomma }}
                {% endif %}
              </span>
            </div>
            {% if a.memo %}<div class="tmemo">{{ a.memo }}</div>{% endif %}
          </div>
        </li>
      {% empty %}
        <li class="empty">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>
      {% endfor %}
    </ul>
  </section>

  {# ===== ã‚¯ã‚¤ãƒƒã‚¯æ“ä½œ ===== #}
  <section class="quick card">
    <h3 class="sect-title">ã‚¯ã‚¤ãƒƒã‚¯æ“ä½œ</h3>
    <div class="qgrid">
      <a class="qbtn" href="{% url 'cash_io' %}">
        <span class="qi">ğŸ’¸</span><span>å…¥å‡ºé‡‘ã‚’è¨˜éŒ²</span>
      </a>
      <a class="qbtn" href="{% url 'dividend_new' %}">
        <span class="qi">ğŸ’´</span><span>é…å½“ã‚’ç™»éŒ²</span>
      </a>
      <a class="qbtn" href="{% url 'stock_list' %}">
        <span class="qi">ğŸ“ˆ</span><span>ä¿æœ‰æ ªã‚’è¦‹ã‚‹</span>
      </a>
      <a class="qbtn" href="{% url 'realized' %}">
        <span class="qi">ğŸ“ƒ</span><span>å®Ÿç¾ä¸€è¦§</span>
      </a>
    </div>
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/main.js' %}" defer></script>
{% endblock %}