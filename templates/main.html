{% extends "base.html" %}
{% load static humanize %}

{% block title %}ホーム{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock %}

{% block content %}
<div class="home-page">

  {# メッセージ #}
  {% if messages %}
    <ul class="msgs">
      {% for m in messages %}
        <li class="msg {{ m.tags }}">{{ m }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {# ===== ヘッダー（総資産 + 小さなサマリー） ===== #}
  <header class="hero card">
    <div class="hero-top">
      <h1 class="hero-title">総資産</h1>
      <div class="hero-actions">
        <a class="btn ghost" href="{% url 'cash_io' %}">入出金</a>
        <a class="btn ghost" href="{% url 'stock_list' %}">保有株</a>
      </div>
    </div>

    <div class="hero-main">
      <div class="asset-figure" data-value="{{ total_assets|default_if_none:0 }}">
        ¥{{ total_assets|default_if_none:0|floatformat:0|intcomma }}
      </div>
      <div class="asset-sub">
        <span>前日比</span>
        {% with dc_val=day_change|default_if_none:0 %}
        <strong class="pn {% if dc_val >= 0 %}pos{% else %}neg{% endif %}">
          {% if dc_val >= 0 %}+{% endif %}¥{{ dc_val|floatformat:0|intcomma }}
        </strong>
        {% endwith %}
      </div>
    </div>

    <div class="hero-mini">
      <div class="mini">
        <span class="k">評価額</span>
        <span class="v">¥{{ portfolio_value|default_if_none:0|floatformat:0|intcomma }}</span>
      </div>
      <div class="mini">
        <span class="k">現金</span>
        <span class="v">¥{{ cash_total|default_if_none:0|floatformat:0|intcomma }}</span>
      </div>
      <div class="mini">
        {% with upl_val=unrealized_pl|default_if_none:0 %}
        <span class="k">含み損益</span>
        <span class="v {% if upl_val >= 0 %}pos{% else %}neg{% endif %}">
          {% if upl_val >= 0 %}+{% endif %}¥{{ upl_val|floatformat:0|intcomma }}
        </span>
        {% endwith %}
      </div>
    </div>

    {# スパークライン（軽量SVG） #}
    <div class="sparkline" id="assetSpark"
         data-points="{{ asset_history_csv|default_if_none:'' }}"></div>
  </header>

  {# ===== ブローカー別（タブ） ===== #}
  <section class="brokers card">
    <nav class="tabs" role="tablist" aria-label="証券会社">
      {% for key,label in broker_tabs %}
        <button class="tab {% if key == active_broker %}active{% endif %}"
                data-tab="{{ key }}">{{ label }}</button>
      {% endfor %}
    </nav>

    <div class="panes">
      {% for key,label in broker_tabs %}
        <div class="pane {% if key == active_broker %}active{% endif %}" id="pane-{{ key }}">
          {# 動的キー参照を if/with で展開 #}
          {% if key == 'rakuten' %}
            {% with bal=broker_balances.rakuten stats=broker_stats.rakuten tops=top_positions_by_broker.rakuten %}
          {% elif key == 'matsui' %}
            {% with bal=broker_balances.matsui stats=broker_stats.matsui tops=top_positions_by_broker.matsui %}
          {% elif key == 'sbi' %}
            {% with bal=broker_balances.sbi stats=broker_stats.sbi tops=top_positions_by_broker.sbi %}
          {% else %}
            {% with bal=0 stats=None tops=None %}
          {% endif %}

          <div class="pill-row">
            <div class="pill">
              <span class="k">残高</span>
              <span class="v">¥{{ bal|default_if_none:0|floatformat:0|intcomma }}</span>
            </div>
            <div class="pill">
              <span class="k">保有銘柄</span>
              <span class="v">{{ stats.holdings_count|default_if_none:0 }}</span>
            </div>
            <div class="pill">
              <span class="k">時価評価</span>
              <span class="v">¥{{ stats.market_value|default_if_none:0|floatformat:0|intcomma }}</span>
            </div>
          </div>

          {# 上位ポジション #}
          <div class="toppos">
            <h3 class="sect-title">上位ポジション</h3>
            <ul class="pos-list">
              {% if tops %}
                {% for p in tops %}
                  <li class="pos-row">
                    <span class="name">{{ p.ticker }} {{ p.name }}</span>
                    <span class="lot">{{ p.shares|default_if_none:0|intcomma }}株</span>
                    <span class="mv">¥{{ p.market_value|default_if_none:0|floatformat:0|intcomma }}</span>
                  </li>
                {% empty %}
                  <li class="empty">データがありません</li>
                {% endfor %}
              {% else %}
                <li class="empty">データがありません</li>
              {% endif %}
            </ul>
          </div>

          {% endwith %}
        </div>
      {% endfor %}
    </div>
  </section>

  {# ===== 実現損益（今月 / 今年 / 累計） ===== #}
  <section class="realized card">
    <div class="grid3">
      {% with mtd_val=realized_pl_mtd|default_if_none:0 %}
      <div class="kpi">
        <div class="k">今月の実現損益</div>
        <div class="v pn {% if mtd_val >= 0 %}pos{% else %}neg{% endif %}">
          {% if mtd_val >= 0 %}+{% endif %}¥{{ mtd_val|floatformat:0|intcomma }}
        </div>
      </div>
      {% endwith %}

      {% with ytd_val=realized_pl_ytd|default_if_none:0 %}
      <div class="kpi">
        <div class="k">今年の実現損益</div>
        <div class="v pn {% if ytd_val >= 0 %}pos{% else %}neg{% endif %}">
          {% if ytd_val >= 0 %}+{% endif %}¥{{ ytd_val|floatformat:0|intcomma }}
        </div>
      </div>
      {% endwith %}

      {% with total_val=realized_pl_total|default_if_none:0 %}
      <div class="kpi">
        <div class="k">累計の実現損益</div>
        <div class="v pn {% if total_val >= 0 %}pos{% else %}neg{% endif %}">
          {% if total_val >= 0 %}+{% endif %}¥{{ total_val|floatformat:0|intcomma }}
        </div>
      </div>
      {% endwith %}
    </div>
    <a class="btn link" href="{% url 'realized' %}">実現一覧へ</a>
  </section>

  {# ===== 最近のアクティビティ ===== #}
  <section class="activity card">
    <div class="activity-head">
      <h3 class="sect-title">最近のアクティビティ</h3>
      <div class="chips">
        <button class="chip {% if request.GET.range|default_if_none:'' == '7' or not request.GET.range %}active{% endif %}" data-range="7">7日</button>
        <button class="chip {% if request.GET.range == '30' %}active{% endif %}" data-range="30">30日</button>
        <button class="chip {% if request.GET.range == '90' %}active{% endif %}" data-range="90">90日</button>
        <button class="chip {% if request.GET.range == 'all' %}active{% endif %}" data-range="all">すべて</button>
      </div>
    </div>

    <ul class="timeline" id="timeline">
      {% if recent_activities %}
        {% for a in recent_activities %}
          <li class="trow type-{{ a.kind }}">
            <div class="tdate">{{ a.date|date:"n/j" }}</div>
            <div class="tbody">
              <div class="tline">
                <span class="tbadge">{{ a.kind_label }}</span>
                <span class="tmain">
                  {% if a.kind == 'trade' %}
                    {{ a.ticker }} {{ a.name }} /
                    {% with pnl_val=a.pnl|default_if_none:0 %}
                      {% if pnl_val >= 0 %}+{% endif %}¥{{ pnl_val|floatformat:0|intcomma }}
                    {% endwith %}
                  {% elif a.kind == 'dividend' %}
                    配当 {{ a.ticker }} {{ a.name }} /
                    受取 ¥{{ a.net|default_if_none:0|floatformat:0|intcomma }}
                  {% elif a.kind == 'cash' %}
                    {% with amt_val=a.amount|default_if_none:0 %}
                      現金 {{ a.broker_label }} /
                      {% if a.flow == 'in' %}+{% else %}-{% endif %}¥{{ amt_val|floatformat:0|intcomma }}
                    {% endwith %}
                  {% endif %}
                </span>
              </div>
              {% if a.memo %}<div class="tmemo">{{ a.memo }}</div>{% endif %}
            </div>
          </li>
        {% empty %}
          <li class="empty">まだデータがありません</li>
        {% endfor %}
      {% else %}
        <li class="empty">まだデータがありません</li>
      {% endif %}
    </ul>
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/main.js' %}" defer></script>
{% endblock %}