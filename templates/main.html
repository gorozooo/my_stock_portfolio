{% extends "base.html" %}
{% load humanize %}

{% block title %}ホーム（ミニ）{% endblock %}

{% block content %}
<style>
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .hero{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:16px}
  .hero .label{opacity:.75;font-size:13px}
  .hero .total{font-weight:900;font-size:28px}
  .row{display:grid;grid-template-columns:1fr;gap:12px;margin:12px 0}
  @media(min-width:560px){.row{grid-template-columns:1fr 1fr}}
  .tile{padding:12px;border:1px solid rgba(255,255,255,.2);border-radius:12px;background:rgba(255,255,255,.06)}
  .tile h3{margin:0 0 8px;font-size:14px;opacity:.85}
  .amt{font-weight:800}
  .pos{color:#22c55e}.neg{color:#ef4444}
  .muted{opacity:.8}
  .spark{height:64px;border:1px solid rgba(255,255,255,.2);border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-top:8px}
  .list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:8px}
  .item{display:grid;grid-template-columns:70px 1fr auto;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:8px;background:rgba(255,255,255,.06)}
  .date{opacity:.8;font-size:12px}

  /* debug table */
  .debug-wrap{margin-top:20px}
  .dbg-title{margin:0 0 8px;font-size:16px;font-weight:900}
  .dbg-note{opacity:.8;margin:0 0 8px}
  .dbg-table{width:100%;border-collapse:separate;border-spacing:0;min-width:760px;border:1px solid rgba(255,255,255,.2);border-radius:10px;overflow:hidden}
  .dbg-table th,.dbg-table td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.15);font-size:12px}
  .dbg-table thead th{background:rgba(255,255,255,.08);text-align:left;position:sticky;top:0}
  .dbg-table .ar{text-align:right;font-variant-numeric:tabular-nums;white-space:nowrap}
  .dbg-scroll{overflow:auto;border-radius:10px}
</style>

<div class="wrap">

  {% if not debug_on %}
    <p style="margin:6px 0"><a href="?debug=1">デバッグ表示をON</a></p>
  {% else %}
    <p style="margin:6px 0"><a href="?">デバッグ表示をOFF</a></p>
  {% endif %}

  <!-- 総資産（中央表示） -->
  <section class="hero">
    <div class="label">総資産</div>
    <div class="total">
      ¥{{ total_assets|default_if_none:0|floatformat:0|intcomma }}
    </div>
    <div class="spark" id="assetSpark" data-points="{{ asset_history_csv|default_if_none:'' }}"></div>
  </section>

  <!-- 評価額 / 含み損益 / 現金 -->
  <section class="row">
    <div class="tile">
      <h3>現物（現物 + NISA）</h3>
      <div class="amt">
        評価額 ¥{{ spot_market_value|default_if_none:0|floatformat:0|intcomma }}
      </div>
      {% with p=spot_unrealized_pl|default_if_none:0 %}
        <div class="muted">
          含み損益
          <span class="{% if p|floatformat:2 >= 0 %}pos{% else %}neg{% endif %}">
            {% if p|floatformat:2 >= 0 %}+{% endif %}¥{{ p|floatformat:0|intcomma }}
          </span>
        </div>
      {% endwith %}
    </div>

    <div class="tile">
      <h3>信用</h3>
      <div class="amt">
        評価額 ¥{{ margin_market_value|default_if_none:0|floatformat:0|intcomma }}
      </div>
      {% with p=margin_unrealized_pl|default_if_none:0 %}
        <div class="muted">
          含み損益
          <span class="{% if p|floatformat:2 >= 0 %}pos{% else %}neg{% endif %}">
            {% if p|floatformat:2 >= 0 %}+{% endif %}¥{{ p|floatformat:0|intcomma }}
          </span>
        </div>
      {% endwith %}
    </div>

    <div class="tile">
      <h3>現金合計</h3>
      <div class="amt">¥{{ cash_total|default_if_none:0|floatformat:0|intcomma }}</div>
    </div>

    <div class="tile">
      <h3>含み損益（合計）</h3>
      {% with p=unrealized_pl_total|default_if_none:0 %}
        <div class="amt {% if p|floatformat:2 >= 0 %}pos{% else %}neg{% endif %}">
          {% if p|floatformat:2 >= 0 %}+{% endif %}¥{{ p|floatformat:0|intcomma }}
        </div>
      {% endwith %}
    </div>
  </section>

  <!-- 最近のアクティビティ（10件まで表示想定） -->
  <section>
    <h3 class="muted" style="margin:8px 0">最近のアクティビティ</h3>
    {% if recent_activities %}
      <ul class="list">
        {% for a in recent_activities %}
          <li class="item">
            <span class="date">{{ a.date|date:"n/j" }}</span>

            {% if a.kind == 'trade' %}
              <span>{{ a.ticker }} {{ a.name }}</span>
              {% with v=a.pnl|default_if_none:0 %}
                <span class="{% if v|floatformat:2 >= 0 %}pos{% else %}neg{% endif %}">
                  {% if v|floatformat:2 >= 0 %}+{% endif %}¥{{ v|floatformat:0|intcomma }}
                </span>
              {% endwith %}

            {% elif a.kind == 'dividend' %}
              <span>配当 {{ a.ticker }} {{ a.name }}</span>
              <span class="pos">+¥{{ a.net|default_if_none:0|intcomma }}</span>

            {% elif a.kind == 'cash' %}
              {% with amt=a.amount|default_if_none:0 %}
                <span>現金 {{ a.broker_label }}</span>
                <span class="{% if a.flow == 'in' %}pos{% else %}neg{% endif %}">
                  {% if a.flow == 'in' %}+{% else %}-{% endif %}¥{{ amt|intcomma }}
                </span>
              {% endwith %}

            {% else %}
              <span>—</span><span></span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="muted">まだデータがありません</div>
    {% endif %}
  </section>

  {% if debug_on %}
  <!-- ===== デバッグ表 ===== -->
  <section class="debug-wrap">
    <h3 class="dbg-title">Holdings Debug</h3>
    <p class="dbg-note">
      現物MV: {{ debug_totals.spot_mv|default_if_none:0|floatformat:0|intcomma }}
      / 信用MV: {{ debug_totals.margin_mv|default_if_none:0|floatformat:0|intcomma }}
      / 現物UPL: {{ debug_totals.spot_upl|default_if_none:0|floatformat:0|intcomma }}
      / 信用UPL: {{ debug_totals.margin_upl|default_if_none:0|floatformat:0|intcomma }}
    </p>
    <div class="dbg-scroll">
      <table class="dbg-table">
        <thead>
          <tr>
            <th>ID</th><th>コード</th><th>銘柄</th>
            <th class="ar">株数</th><th class="ar">取得単価</th>
            <th class="ar">現在値</th><th class="ar">計算で使った価格</th>
            <th class="ar">取得額(total_cost)</th><th class="ar">評価額</th>
            <th class="ar">含み損益</th><th>口座</th><th>ポジ</th><th>グループ</th>
          </tr>
        </thead>
        <tbody>
          {% for r in holdings_debug %}
          <tr>
            <td>{{ r.id }}</td>
            <td>{{ r.ticker }}</td>
            <td>{{ r.name }}</td>
            <td class="ar">{{ r.shares|intcomma }}</td>
            <td class="ar">{{ r.unit_price|floatformat:2|intcomma }}</td>
            <td class="ar">{{ r.current_price|floatformat:2|intcomma }}</td>
            <td class="ar">{{ r.price_used|floatformat:2|intcomma }}</td>
            <td class="ar">{{ r.total_cost|floatformat:0|intcomma }}</td>
            <td class="ar">{{ r.market_value|floatformat:0|intcomma }}</td>
            <td class="ar {% if r.unrealized_pl >= 0 %}pos{% else %}neg{% endif %}">
              {% if r.unrealized_pl >= 0 %}+{% endif %}{{ r.unrealized_pl|floatformat:0|intcomma }}
            </td>
            <td>{{ r.account_type }}</td>
            <td>{{ r.position }}</td>
            <td>{{ r.group }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="13">該当データなし</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  {% endif %}

</div>

<script>
(function renderSpark(){
  const el = document.getElementById('assetSpark');
  if(!el) return;
  const raw = (el.getAttribute('data-points')||'').trim();
  if(!raw){ el.textContent='データなし'; return; }
  const vals = raw.split(',').map(s=>parseFloat(s)).filter(v=>!Number.isNaN(v));
  if(vals.length<2){ el.textContent='データ不足'; return; }
  const w = el.clientWidth||320, h = el.clientHeight||64, pad=4;
  const min = Math.min(...vals), max = Math.max(...vals);
  const x = i => pad + (w-pad*2)*(i/(vals.length-1));
  const y = v => max===min ? h/2 : pad + (1-((v-min)/(max-min)))*(h-pad*2);
  const pts = vals.map((v,i)=>`${x(i)},${y(v)}`).join(' ');
  el.innerHTML = `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
    <polyline points="${pts}" fill="none" stroke="rgba(96,165,250,1)" stroke-width="2"/>
    <polyline points="${pts}" fill="none" stroke="rgba(96,165,250,.35)" stroke-width="6" opacity=".35"/>
  </svg>`;
})();
</script>
{% endblock %}
