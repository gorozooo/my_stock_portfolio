{% extends "base.html" %}
{% load static humanize %}

{% block title %}ãƒ›ãƒ¼ãƒ {% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/main.css' %}">
{% endblock %}

{% block content %}
<div class="home-page">

  {% if messages %}
    <ul class="msgs">
      {% for m in messages %}
        <li class="msg {{ m.tags }}">{{ m }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {# ====== ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼šç·è³‡ç”£ï¼ˆãƒªãƒ³ã‚°ï¼‹ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼‰ ====== #}
  <header class="hero glass card">
    <div class="hero-top">
      <h1 class="hero-title">ç·è³‡ç”£</h1>
      <div class="hero-actions">
        <a class="btn ghost" href="{% url 'cash_io' %}">å…¥å‡ºé‡‘</a>
        <a class="btn ghost" href="{% url 'stock_list' %}">ä¿æœ‰æ ª</a>
      </div>
    </div>

    <div class="hero-core">
      <div class="ring" 
           data-value="{{ total_assets|default_if_none:0 }}"
           data-max="{{ total_assets_target|default_if_none:0 }}">
        <svg viewBox="0 0 120 120" aria-hidden="true">
          <circle class="bg" cx="60" cy="60" r="50" />
          <circle class="fg" cx="60" cy="60" r="50" />
        </svg>
        <div class="ring-center">
          <div class="ring-figure">Â¥{{ total_assets|default_if_none:0|floatformat:0|intcomma }}</div>
          <div class="ring-sub">
            <span>å‰æ—¥æ¯”</span>
            <b class="pn {% if day_change|default_if_none:0 >= 0 %}pos{% else %}neg{% endif %}">
              {% if day_change|default_if_none:0 >= 0 %}+{% endif %}Â¥{{ day_change|default_if_none:0|floatformat:0|intcomma }}
            </b>
          </div>
        </div>
      </div>

      <div class="hero-metrics">
        <div class="mini">
          <span class="k">è©•ä¾¡é¡</span>
          <span class="v">Â¥{{ portfolio_value|default_if_none:0|floatformat:0|intcomma }}</span>
        </div>
        <div class="mini">
          <span class="k">ç¾é‡‘</span>
          <span class="v">Â¥{{ cash_total|default_if_none:0|floatformat:0|intcomma }}</span>
        </div>
        <div class="mini">
          <span class="k">å«ã¿æç›Š</span>
          <span class="v pn {% if unrealized_pl|default_if_none:0 >= 0 %}pos{% else %}neg{% endif %}">
            {% if unrealized_pl|default_if_none:0 >= 0 %}+{% endif %}Â¥{{ unrealized_pl|default_if_none:0|floatformat:0|intcomma }}
          </span>
        </div>
      </div>

      <div id="assetSpark" 
           class="spark"
           data-points="{{ asset_history_csv|default:'' }}">
      </div>
    </div>
  </header>

  {# ====== ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆãƒ”ãƒ«ï¼‹ãƒˆãƒƒãƒ—ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼‰ ====== #}
  <section class="swimlane">
    <h2 class="lane-title">è¨¼åˆ¸ä¼šç¤¾</h2>
    <div class="lane-scroll" role="list">
      {# æ¥½å¤© #}
      <article class="lane-card glass" role="listitem">
        <div class="lane-head">
          <div class="logo">R</div>
          <div class="name">æ¥½å¤©è¨¼åˆ¸</div>
        </div>
        <div class="pill-row">
          <div class="pill"><span class="k">æ®‹é«˜</span><span class="v">
            Â¥{{ broker_balances.rakuten|default_if_none:0|floatformat:0|intcomma }}</span></div>
          <div class="pill"><span class="k">ä¿æœ‰</span><span class="v">
            {{ broker_stats.rakuten.holdings_count|default_if_none:0 }}</span></div>
          <div class="pill"><span class="k">æ™‚ä¾¡</span><span class="v">
            Â¥{{ broker_stats.rakuten.market_value|default_if_none:0|floatformat:0|intcomma }}</span></div>
        </div>
        <div class="tops">
          <h3>ä¸Šä½</h3>
          {% with tops=top_positions_by_broker.rakuten %}
            <ul>
              {% if tops %}
                {% for p in tops %}
                  <li><span class="n">{{ p.ticker }} {{ p.name }}</span>
                      <span class="r">{{ p.shares|intcomma }}æ ª</span>
                      <span class="r">Â¥{{ p.market_value|floatformat:0|intcomma }}</span></li>
                {% endfor %}
              {% else %}
                <li class="empty">ãƒ‡ãƒ¼ã‚¿ãªã—</li>
              {% endif %}
            </ul>
          {% endwith %}
        </div>
      </article>

      {# æ¾äº• #}
      <article class="lane-card glass" role="listitem">
        <div class="lane-head">
          <div class="logo">M</div>
          <div class="name">æ¾äº•è¨¼åˆ¸</div>
        </div>
        <div class="pill-row">
          <div class="pill"><span class="k">æ®‹é«˜</span><span class="v">
            Â¥{{ broker_balances.matsui|default_if_none:0|floatformat:0|intcomma }}</span></div>
          <div class="pill"><span class="k">ä¿æœ‰</span><span class="v">
            {{ broker_stats.matsui.holdings_count|default_if_none:0 }}</span></div>
          <div class="pill"><span class="k">æ™‚ä¾¡</span><span class="v">
            Â¥{{ broker_stats.matsui.market_value|default_if_none:0|floatformat:0|intcomma }}</span></div>
        </div>
        <div class="tops">
          <h3>ä¸Šä½</h3>
          {% with tops=top_positions_by_broker.matsui %}
            <ul>
              {% if tops %}
                {% for p in tops %}
                  <li><span class="n">{{ p.ticker }} {{ p.name }}</span>
                      <span class="r">{{ p.shares|intcomma }}æ ª</span>
                      <span class="r">Â¥{{ p.market_value|floatformat:0|intcomma }}</span></li>
                {% endfor %}
              {% else %}
                <li class="empty">ãƒ‡ãƒ¼ã‚¿ãªã—</li>
              {% endif %}
            </ul>
          {% endwith %}
        </div>
      </article>

      {# SBI #}
      <article class="lane-card glass" role="listitem">
        <div class="lane-head">
          <div class="logo">S</div>
          <div class="name">SBIè¨¼åˆ¸</div>
        </div>
        <div class="pill-row">
          <div class="pill"><span class="k">æ®‹é«˜</span><span class="v">
            Â¥{{ broker_balances.sbi|default_if_none:0|floatformat:0|intcomma }}</span></div>
          <div class="pill"><span class="k">ä¿æœ‰</span><span class="v">
            {{ broker_stats.sbi.holdings_count|default_if_none:0 }}</span></div>
          <div class="pill"><span class="k">æ™‚ä¾¡</span><span class="v">
            Â¥{{ broker_stats.sbi.market_value|default_if_none:0|floatformat:0|intcomma }}</span></div>
        </div>
        <div class="tops">
          <h3>ä¸Šä½</h3>
          {% with tops=top_positions_by_broker.sbi %}
            <ul>
              {% if tops %}
                {% for p in tops %}
                  <li><span class="n">{{ p.ticker }} {{ p.name }}</span>
                      <span class="r">{{ p.shares|intcomma }}æ ª</span>
                      <span class="r">Â¥{{ p.market_value|floatformat:0|intcomma }}</span></li>
                {% endfor %}
              {% else %}
                <li class="empty">ãƒ‡ãƒ¼ã‚¿ãªã—</li>
              {% endif %}
            </ul>
          {% endwith %}
        </div>
      </article>
    </div>
  </section>

  {# ====== å®Ÿç¾æç›Šï¼ˆã‚²ãƒ¼ã‚¸3æšï¼‰ ====== #}
  <section class="gauges card glass">
    <div class="gauge" data-val="{{ realized_pl_mtd|default_if_none:0 }}">
      <div class="g-title">ä»Šæœˆã®å®Ÿç¾</div>
      <div class="g-figure pn {% if realized_pl_mtd|default_if_none:0 >= 0 %}pos{% else %}neg{% endif %}">
        {% if realized_pl_mtd|default_if_none:0 >= 0 %}+{% endif %}Â¥{{ realized_pl_mtd|default_if_none:0|floatformat:0|intcomma }}
      </div>
      <div class="g-bar"><span></span></div>
    </div>
    <div class="gauge" data-val="{{ realized_pl_ytd|default_if_none:0 }}">
      <div class="g-title">ä»Šå¹´ã®å®Ÿç¾</div>
      <div class="g-figure pn {% if realized_pl_ytd|default_if_none:0 >= 0 %}pos{% else %}neg{% endif %}">
        {% if realized_pl_ytd|default_if_none:0 >= 0 %}+{% endif %}Â¥{{ realized_pl_ytd|default_if_none:0|floatformat:0|intcomma }}
      </div>
      <div class="g-bar"><span></span></div>
    </div>
    <div class="gauge" data-val="{{ realized_pl_total|default_if_none:0 }}">
      <div class="g-title">ç´¯è¨ˆã®å®Ÿç¾</div>
      <div class="g-figure pn {% if realized_pl_total|default_if_none:0 >= 0 %}pos{% else %}neg{% endif %}">
        {% if realized_pl_total|default_if_none:0 >= 0 %}+{% endif %}Â¥{{ realized_pl_total|default_if_none:0|floatformat:0|intcomma }}
      </div>
      <div class="g-bar"><span></span></div>
    </div>
    <a class="btn link" href="{% url 'realized' %}">å®Ÿç¾ä¸€è¦§ã¸</a>
  </section>

  {# ====== æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ï¼ˆãƒãƒƒãƒ—åŒ–ï¼‰ ====== #}
  <section class="activity card glass">
    <div class="activity-head">
      <h2 class="sect-title">æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£</h2>
      <div class="chips">
        <button class="chip active" data-range="7">7æ—¥</button>
        <button class="chip" data-range="30">30æ—¥</button>
        <button class="chip" data-range="90">90æ—¥</button>
        <button class="chip" data-range="all">ã™ã¹ã¦</button>
      </div>
    </div>

    <ul id="timeline" class="chiplist">
      {% if recent_activities %}
        {% for a in recent_activities %}
          <li class="chiprow type-{{ a.kind }}">
            <span class="cdate">{{ a.date|date:"n/j" }}</span>
            {% if a.kind == 'trade' %}
              <span class="cbadge">å£²è²·</span>
              <span class="cmain">{{ a.ticker }} {{ a.name }}</span>
              <span class="cval pn {% if a.pnl >= 0 %}pos{% else %}neg{% endif %}">
                {% if a.pnl >= 0 %}+{% endif %}Â¥{{ a.pnl|floatformat:0|intcomma }}</span>
            {% elif a.kind == 'dividend' %}
              <span class="cbadge">é…å½“</span>
              <span class="cmain">{{ a.ticker }} {{ a.name }}</span>
              <span class="cval">å—å– Â¥{{ a.net|floatformat:0|intcomma }}</span>
            {% elif a.kind == 'cash' %}
              <span class="cbadge">ç¾é‡‘</span>
              <span class="cmain">{{ a.broker_label }}</span>
              <span class="cval pn {% if a.flow == 'in' %}pos{% else %}neg{% endif %}">
                {% if a.flow == 'in' %}+{% else %}-{% endif %}Â¥{{ a.amount|floatformat:0|intcomma }}</span>
            {% endif %}
            {% if a.memo %}<span class="cmemo">{{ a.memo }}</span>{% endif %}
          </li>
        {% endfor %}
      {% else %}
        <li class="empty">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</li>
      {% endif %}
    </ul>
  </section>

  {# ====== ã‚¯ã‚¤ãƒƒã‚¯æ“ä½œï¼ˆå¤§ãã‚ã‚¿ã‚¤ãƒ«ï¼‰ ====== #}
  <section class="quick card glass">
    <h2 class="sect-title">ã‚¯ã‚¤ãƒƒã‚¯æ“ä½œ</h2>
    <div class="qgrid">
      <a class="qbtn" href="{% url 'cash_io' %}"><span class="qi">ğŸ’¸</span><span>å…¥å‡ºé‡‘</span></a>
      <a class="qbtn" href="{% url 'dividend_new' %}"><span class="qi">ğŸ’´</span><span>é…å½“</span></a>
      <a class="qbtn" href="{% url 'stock_list' %}"><span class="qi">ğŸ“ˆ</span><span>ä¿æœ‰æ ª</span></a>
      <a class="qbtn" href="{% url 'realized' %}"><span class="qi">ğŸ“ƒ</span><span>å®Ÿç¾ä¸€è¦§</span></a>
    </div>
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/main.js' %}" defer></script>
{% endblock %}