{% extends "base.html" %}
{% load static %}

{% block title %}policyå±¥æ­´ | Myæ ªãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token }}">
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=30">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --pad:14px;
    --radius:14px;
  }
  .ph-wrap{ margin:12px; padding-bottom:calc(env(safe-area-inset-bottom, 0) + 8px); }
  .ph-card{ padding:var(--pad); }

  /* ã‚¿ã‚¤ãƒˆãƒ«è¡Œ */
  .ph-title{ font-weight:800; font-size:1.05rem; letter-spacing:.2px; margin-bottom:8px; }

  /* ãƒ™ã‚¹ãƒˆé€±è¡¨ç¤º */
  .best-box{
    margin-top:10px; padding:12px; border-radius:var(--radius);
    border:1px solid rgba(255,255,255,.15);
    background: rgba(255,255,255,.05);
  }
  .best-box .title{ font-weight:700; margin-bottom:8px; }
  .best-box .kv{ display:grid; grid-template-columns:100px 1fr; gap:6px; font-size:.95rem; }
  .muted{ opacity:.75; }

  /* ãƒ¯ãƒ³ã‚¯ãƒªå­¦ç¿’ï¼ˆãƒ¢ãƒã‚¤ãƒ«å‘ã‘ãƒ•ãƒ«å¹…ãƒœã‚¿ãƒ³ï¼‰ */
  .learn-wrap{
    margin-top:12px; padding:12px; border-radius:var(--radius);
    border:1px dashed rgba(255,255,255,.18); background:rgba(255,255,255,.04);
  }
  .learn-wrap .strip-title{ margin-bottom:10px; font-weight:700; }
  .learn-row{ display:flex; flex-direction:column; gap:10px; }
  .learn-btn{
    width:100%; padding:14px 12px; border-radius:12px;
    border:1px solid var(--pri); color:var(--pri); background:transparent;
    font-size:1rem; text-align:center;
  }
  .learn-btn:active{ transform:translateY(1px); opacity:.9; }
  .learn-status{ margin-top:10px; font-size:.95rem; line-height:1.5; word-break:break-all; }

  /* ã‚°ãƒ©ãƒ•ã‚’ãƒ¢ãƒã‚¤ãƒ«å¯„ã› */
  .chart-wrap{ margin-top:6px; }
  @media (min-width: 700px){
    .best-box .kv{ grid-template-columns:120px 1fr; }
    .learn-row{ flex-direction:row; flex-wrap:wrap; }
    .learn-btn{ width:auto; min-width:220px; }
  }
</style>
{% endblock %}

{% block content %}
<section class="glass ph-wrap ph-card">
  <div class="ph-title">policyå±¥æ­´ï¼ˆæ”¹å–„ã‚¹ã‚³ã‚¢ & å‹ç‡ï¼‰</div>

  {% if not has_data %}
    <p class="muted" style="line-height:1.6">
      å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<code>MEDIA_ROOT/advisor/history/</code> ã« <code>policy_YYYY-MM-DD.json</code> ã‚’è“„ç©ã—ã¦ãã ã•ã„ã€‚å˜ç™ºã®ã¿ãªã‚‰ <code>MEDIA_ROOT/advisor/policy.json</code> ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
    </p>
  {% else %}
    <div class="chart-wrap">
      <canvas id="policyChart" height="140"></canvas>
    </div>

    {% if best %}
    <div class="best-box">
      <div class="title">ä¸€ç•ªè‰¯ã‹ã£ãŸé€±</div>
      <div class="kv">
        <div class="muted">é€±ï¼š</div><div>{{ best.label }}</div>
        <div class="muted">æ”¹å–„ã‚¹ã‚³ã‚¢ï¼š</div><div>{% if best.score != None %}{{ best.score|floatformat:4 }}{% else %}--{% endif %}</div>
        <div class="muted">åŠ é‡å‹ç‡ï¼š</div><div>{% if best.winrt != None %}{{ best.winrt|floatformat:3 }}{% else %}--{% endif %}</div>
        <div class="muted">horizonï¼š</div><div>{{ best.horizon }} æ—¥</div>
      </div>
    </div>
    {% endif %}
  {% endif %}

  {% if request.user.is_staff %}
  <div class="learn-wrap" id="learnBox">
    <div class="strip-title">ğŸ§  policy å†å­¦ç¿’ï¼ˆãƒ¯ãƒ³ã‚¯ãƒªï¼‰</div>
    <div class="learn-row">
      <button class="learn-btn" data-learn-days="90">é€šå¸¸é‹ç”¨ï¼ˆ90æ—¥ï¼‰</button>
      <button class="learn-btn" data-learn-days="365">æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆï¼ˆ365æ—¥ï¼‰</button>
      <button class="learn-btn" data-learn-days="730">åˆå›å†å­¦ç¿’ï¼ˆ730æ—¥ï¼‰</button>
    </div>
    <div id="learnStatus" class="learn-status muted"></div>
  </div>
  {% endif %}
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ====== ã‚°ãƒ©ãƒ• ======
  const points = {{ points|safe }};
  if (points && points.length) {
    const labels = points.map(p => p.label);
    const score  = points.map(p => (p.score ?? null));
    const winrt  = points.map(p => (p.winrt ?? null));
    const selfS  = points.map(p => (p.self_score ?? null));

    const ctx = document.getElementById("policyChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "æ”¹å–„ã‚¹ã‚³ã‚¢", data: score, tension: 0.25 },
          { label: "åŠ é‡å‹ç‡(%)", data: winrt, yAxisID: "y2", tension: 0.25 },
          { label: "self_score", data: selfS, yAxisID: "y3", tension: 0.25 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: "index", intersect: false },
        plugins: {
          legend: { display: true, labels: { boxWidth: 10, font: { size: 11 } } },
          tooltip: { mode: "index", intersect: false }
        },
        scales: {
          y:  { beginAtZero: true, ticks: { font:{ size: 11 } }, title: { display:true, text: "ã‚¹ã‚³ã‚¢" } },
          y2: { beginAtZero: true, position: "right", grid: { drawOnChartArea:false }, ticks:{ font:{ size:11 } }, title: { display:true, text: "å‹ç‡(%)" } },
          y3: { beginAtZero: true, position: "right", grid: { drawOnChartArea:false }, ticks:{ font:{ size:11 } }, title: { display:true, text: "self_score" } }
        }
      }
    });
  }

  // ====== ãƒ¯ãƒ³ã‚¯ãƒªå­¦ç¿’ï¼ˆstaffå°‚ç”¨ï¼‰ ======
  const statusEl = document.getElementById("learnStatus");
  const boxEl    = document.getElementById("learnBox");
  const csrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute("content") || "";
  const apiUrl = "{% url 'advisor_learn_now' %}"; // /api/advisor/learn/

  const scrollInto = () => {
    if (!boxEl) return;
    boxEl.scrollIntoView({ behavior: "smooth", block: "center" });
  };

  const spinner = "â³";
  const okMark  = "âœ…";
  const ngMark  = "âŒ";

  const runLearn = async (days) => {
    if (!statusEl) return;
    statusEl.classList.remove("muted");
    statusEl.textContent = `${spinner} å­¦ç¿’ä¸­â€¦ (${days}æ—¥)`;
    scrollInto();

    const fd = new FormData();
    fd.append("days", String(days));

    try {
      const res = await fetch(apiUrl, { method: "POST", headers: { "X-CSRFToken": csrf }, body: fd });
      const j = await res.json();
      if (!j.ok) throw new Error(j.error || "unknown error");
      statusEl.textContent = `${okMark} policy.json ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆdays=${j.days}, kinds=${j.kinds}ï¼‰\n${j.saved}`;
    } catch (e) {
      statusEl.textContent = `${ngMark} å¤±æ•—: ${e}`;
    }
    scrollInto();
  };

  document.querySelectorAll('button[data-learn-days]').forEach(btn => {
    btn.addEventListener("click", () => {
      const days = Number(btn.getAttribute("data-learn-days") || "90");
      runLearn(days);
    });
  });
});
</script>
{% endblock %}