{% extends "base.html" %}
{% load static %}

{% block title %}policyå±¥æ­´ | Myæ ªãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª{% endblock %}

{% block head %}
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=30">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .ph-wrap{ margin:14px 12px; }
  .ph-card{ padding:14px; }
  .muted{ opacity:.7; }

  /* å­¦ç¿’ãƒ•ã‚©ãƒ¼ãƒ  (ã‚¹ãƒãƒ›å‘ã‘) */
  .train-box{ margin-top:10px; padding:12px; border-radius:12px;
    border:1px dashed rgba(255,255,255,.22); background:rgba(255,255,255,.05);}
  .field{ display:grid; grid-template-columns:1fr; row-gap:6px; margin:10px 0;}
  .field label{ font-size:.95rem; color:var(--muted); }
  .select, .input{ width:100%; padding:10px 12px; border-radius:10px;
    border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06); color:var(--fg);}
  .row{ display:flex; align-items:center; gap:10px; }
  .checkbox{ display:flex; align-items:center; gap:8px; font-size:.95rem; color:var(--fg); }
  .btn-primary{
    appearance:none; width:100%; padding:12px; border-radius:12px;
    border:1px solid #6ea8ff; color:#e8eeff; background:rgba(110,168,255,.15);
    font-weight:700;
  }
  .best-box{
    margin-top:12px; padding:10px; border-radius:12px;
    border:1px solid rgba(255,255,255,.15);
    background: rgba(255,255,255,.05);
  }
  .best-box .title{ font-weight:700; margin-bottom:6px; }
  .best-box .kv{ display:grid; grid-template-columns:120px 1fr; gap:6px; }
  @media (max-width: 460px){
    .best-box .kv{ grid-template-columns:100px 1fr; }
  }
  .flash{ margin-top:8px; font-size:.95rem; }
</style>
{% endblock %}

{% block content %}
<section class="glass ph-wrap ph-card">
  <div class="ai-title">policyå±¥æ­´ï¼ˆæ”¹å–„ã‚¹ã‚³ã‚¢ & å‹ç‡ï¼‰</div>

  {% if flash_msg %}
    <div class="flash">âœ… {{ flash_msg }}</div>
  {% endif %}

  {% if has_data %}
    <canvas id="policyChart" height="180"></canvas>

    {% if best %}
    <div class="best-box">
      <div class="title">ä¸€ç•ªè‰¯ã‹ã£ãŸé€±</div>
      <div class="kv">
        <div class="muted">é€±ï¼š</div><div>{{ best.label }}</div>
        <div class="muted">æ”¹å–„ã‚¹ã‚³ã‚¢ï¼š</div><div>{% if best.score != None %}{{ best.score|floatformat:4 }}{% else %}--{% endif %}</div>
        <div class="muted">åŠ é‡å‹ç‡ï¼š</div><div>{% if best.winrt != None %}{{ best.winrt|floatformat:3 }}{% else %}--{% endif %}</div>
        <div class="muted">horizonï¼š</div><div>{{ best.horizon }} æ—¥</div>
      </div>
    </div>
    {% endif %}
  {% else %}
    <p class="muted">
      å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<code>MEDIA_ROOT/advisor/history/</code> ã« <code>policy_YYYY-MM-DD.json</code> ã‚’è“„ç©ã—ã¦ãã ã•ã„ã€‚<br>
      å˜ç™ºã®ã¿ãªã‚‰ <code>MEDIA_ROOT/advisor/policy.json</code> ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚
    </p>
  {% endif %}

  <!-- å­¦ç¿’ãƒ•ã‚©ãƒ¼ãƒ ï¼šãƒœã‚¿ãƒ³ãŒæŠ¼ã›ãªã„å•é¡Œã¯ã€type="submit" & CSRF & POSTãƒãƒ³ãƒ‰ãƒ©ã§è§£æ±º -->
  <form class="train-box" method="post" action="{% url 'policy_history' %}">
    {% csrf_token %}
    <div class="row" style="justify-content:space-between;">
      <div style="font-weight:700;">ğŸ§  policy å†è¨“ç·´ï¼ˆãƒ¯ãƒ³ã‚¯ãƒªï¼‰</div>
    </div>

    <div class="field">
      <label for="days">ãƒ¢ãƒ¼ãƒ‰</label>
      <select class="select" id="days" name="days">
        <option value="90">é€šå¸¸é‹ç”¨ï¼ˆéå»90æ—¥ï¼‰</option>
        <option value="365">æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆï¼ˆéå»365æ—¥ï¼‰</option>
        <option value="730" {% if not has_data %}selected{% endif %}>åˆå›å†å­¦ç¿’ï¼ˆéå»730æ—¥ï¼‰</option>
      </select>
    </div>

    <div class="field checkbox">
      <input type="checkbox" id="make_snap" name="make_snap" value="1" checked>
      <label for="make_snap">å­¦ç¿’å‰ã«ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆä½œæˆ</label>
    </div>

    <div class="field">
      <label for="notify">é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ï¼ˆä»»æ„ / dry-runï¼‰</label>
      <input class="input" type="email" id="notify" name="notify" placeholder="you@example.com">
    </div>

    <button class="btn-primary" type="submit" id="btn-train">AIå†è¨“ç·´ï¼†é©ç”¨</button>
    <div id="msg" class="muted" style="margin-top:8px;"></div>
  </form>
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ã‚°ãƒ©ãƒ•
  const points = {{ points|safe }};
  if (points && points.length) {
    const labels = points.map(p => p.label);
    const score  = points.map(p => (p.score ?? null));
    const winrt  = points.map(p => (p.winrt ?? null));
    const selfS  = points.map(p => (p.self_score ?? null));

    const ctx = document.getElementById("policyChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "æ”¹å–„ã‚¹ã‚³ã‚¢ï¼ˆé‡ã¿å¹³å‡ï¼‰", data: score, tension: 0.25 },
          { label: "åŠ é‡å‹ç‡ï¼ˆ%ï¼‰", data: winrt, yAxisID: "y2", tension: 0.25 },
          { label: "AIè‡ªå·±è©•ä¾¡ self_score", data: selfS, yAxisID: "y3", tension: 0.25 }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        scales: {
          y:  { beginAtZero: true, title: { display:true, text: "ã‚¹ã‚³ã‚¢" } },
          y2: { beginAtZero: true, position: "right", title: { display:true, text: "å‹ç‡(%)" } },
          y3: { beginAtZero: true, position: "right", grid: { drawOnChartArea:false }, title: { display:true, text: "self_score" } }
        },
        plugins: { legend: { display: true } }
      }
    });
  }

  // äºŒé‡é€ä¿¡é˜²æ­¢ï¼†ç°¡æ˜“UX
  const form = document.querySelector("form.train-box");
  const btn  = document.getElementById("btn-train");
  const msg  = document.getElementById("msg");
  if (form && btn) {
    form.addEventListener("submit", () => {
      btn.disabled = true;
      btn.textContent = "å­¦ç¿’ä¸­â€¦";
      if (msg) msg.textContent = "æ•°ç§’ã ã‘ãŠå¾…ã¡ãã ã•ã„ã€‚å®Œäº†ã™ã‚‹ã¨ã“ã®ãƒšãƒ¼ã‚¸ãŒå†èª­ã¿è¾¼ã¿ã•ã‚Œã¾ã™ã€‚";
    });
  }
});
</script>
{% endblock %}