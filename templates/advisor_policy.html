{% extends "base.html" %}
{% load static %}

{% block title %}policy履歴 | My株ポートフォリオ{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=30">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  .ph-wrap{ margin:14px 12px; }
  .ph-card{ padding:14px; }
  .muted{ opacity:.7; }

  /* コントロール（1行レイアウト→スマホ縦並び） */
  .ctl{ display:grid; gap:8px; margin-bottom:10px; }
  .ctl-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .ctl select, .ctl input[type="email"]{
    background: rgba(255,255,255,.06); color:#fff; border:1px solid rgba(255,255,255,.2);
    padding:8px 10px; border-radius:10px; min-width:110px;
  }
  .ctl .btn{
    border:1px solid var(--pri); color:#fff; background: linear-gradient(180deg, rgba(110,168,255,.25), rgba(110,168,255,.05));
    padding:10px 14px; border-radius:12px; font-weight:700;
  }
  .ctl .sub{ font-size:.85rem; opacity:.8; }
  .best-box{
    margin-top:10px; padding:10px; border-radius:12px;
    border:1px solid rgba(255,255,255,.15);
    background: rgba(255,255,255,.05);
  }
  .best-box .title{ font-weight:700; margin-bottom:6px; }
  .best-box .kv{ display:grid; grid-template-columns:120px 1fr; gap:6px; }
  @media (max-width: 460px){
    .best-box .kv{ grid-template-columns:100px 1fr; }
  }
</style>
{% endblock %}

{% block content %}
<section class="glass ph-wrap ph-card">
  <div class="ai-title">policy履歴（改善スコア & 勝率）</div>

  <!-- 統合トリガー：学習→適用→通知 -->
  <div class="ctl">
    <div class="ctl-row">
      <select id="daysSel" aria-label="学習対象期間">
        <option value="90" selected>通常運用（過去90日）</option>
        <option value="365">月次レポート（過去365日）</option>
        <option value="730">初回再学習（過去730日）</option>
      </select>
      <label class="sub"><input type="checkbox" id="snapshotChk"> 学習前にスナップショット作成</label>
    </div>
    <div class="ctl-row">
      <input id="emailBox" type="email" placeholder="通知メール（任意）">
      <button id="btnRetrainApply" class="btn">AI再訓練＆適用</button>
      <span id="msg" class="sub"></span>
    </div>
  </div>

  {% if not has_data %}
    <p class="muted">履歴がありません。<code>MEDIA_ROOT/advisor/history/</code> に <code>policy_YYYY-MM-DD.json</code> を蓄積してください。単発のみなら <code>MEDIA_ROOT/advisor/policy.json</code> を読み込みます。</p>
  {% else %}
    <canvas id="policyChart" height="180"></canvas>

    {% if best %}
    <div class="best-box">
      <div class="title">一番良かった週</div>
      <div class="kv">
        <div class="muted">週：</div><div>{{ best.label }}</div>
        <div class="muted">改善スコア：</div><div>{% if best.score != None %}{{ best.score|floatformat:4 }}{% else %}--{% endif %}</div>
        <div class="muted">加重勝率：</div><div>{% if best.winrt != None %}{{ best.winrt|floatformat:3 }}{% else %}--{% endif %}</div>
        <div class="muted">horizon：</div><div>{{ best.horizon }} 日</div>
      </div>
    </div>
    {% endif %}
  {% endif %}
</section>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // ===== チャート =====
  const points = {{ points|safe }};
  if (points && points.length) {
    const labels = points.map(p => p.label);
    const score  = points.map(p => (p.score ?? null));
    const winrt  = points.map(p => (p.winrt ?? null));
    const ctx = document.getElementById("policyChart").getContext("2d");
    new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "改善スコア（重み平均）", data: score, tension: 0.25 },
          { label: "加重勝率（%）", data: winrt, yAxisID: "y2", tension: 0.25 }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        scales: {
          y:  { beginAtZero: true, title: { display:true, text: "スコア" } },
          y2: { beginAtZero: true, position: "right", title: { display:true, text: "勝率(%)" } }
        },
        plugins: { legend: { display: true } }
      }
    });
  }

  // ===== 統合トリガー =====
  const btn  = document.getElementById("btnRetrainApply");
  const daysSel = document.getElementById("daysSel");
  const emailBox = document.getElementById("emailBox");
  const snapshotChk = document.getElementById("snapshotChk");
  const msg  = document.getElementById("msg");

  const getCsrf = () => {
    const m = document.cookie.match(/csrftoken=([^;]+)/);
    if (m) return decodeURIComponent(m[1]);
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta?.getAttribute("content") || "";
  };

  btn?.addEventListener("click", async () => {
    const days = daysSel?.value || "90";
    const email = (emailBox?.value || "").trim();
    const snapshot = snapshotChk?.checked ? "1" : "0";

    btn.disabled = true;
    msg.textContent = "再訓練を実行中…";
    try {
      const res = await fetch("{% url 'policy_retrain' %}", {
        method: "POST",
        headers: {
          "X-Requested-With": "fetch",
          "X-CSRFToken": getCsrf(),
          "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
        },
        body: new URLSearchParams({ days, email, snapshot })
      });
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "failed");
      msg.textContent = "完了。グラフを更新します…";
      setTimeout(() => location.reload(), 800);
    } catch (e) {
      console.error(e);
      msg.textContent = "失敗しました。ログを確認してください。";
      btn.disabled = false;
    }
  });
});
</script>
{% endblock %}