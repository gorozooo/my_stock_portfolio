{% load static %}
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>{% block title %}My Stock{% endblock %}</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>

  <!-- HTMX CSRF -->
  <script>
    (function () {
      function getCookie(name) {
        const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return m ? m.pop() : '';
      }
      document.addEventListener('htmx:configRequest', function (e) {
        e.detail.headers['X-CSRFToken'] = getCookie('csrftoken');
      });
    })();
  </script>

  <!-- iOS ピンチ抑止 -->
  <script>
    (function () {
      const opts = { passive: false };
      ['gesturestart','gesturechange'].forEach(t =>
        document.addEventListener(t, e => e.preventDefault(), opts)
      );
    })();
  </script>

  <style>
    html, body { touch-action: manipulation; }
    a, button  { touch-action: manipulation; }
  </style>

  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b0f1a">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').catch(console.error);
      });
    }
  </script>

  <script>
    window.APP_URLS = { holding_create: "{% url 'holding_create' %}" };
  </script>
  {% block head %}{% endblock %}
</head>
<body class="bg-slate-950 text-slate-100">
  <main class="max-w-screen-sm mx-auto px-4 pb-24 pt-4">
    {% block content %}{% endblock %}
  </main>

  <div id="sheetRoot" aria-live="polite"></div>
  {% include "partials/bottom_tab.html" %}

  <script src="{% static 'js/realized_close.js' %}?v=2" defer></script>
  <script src="{% static 'js/realized_monthly_chart.js' %}?v=1" defer></script>

  <!-- HTMX エラーオーバーレイ -->
  <script>
    (function () {
      if (!window.htmx || htmx.defineExtension === undefined) return;
      htmx.defineExtension('swap-on-error', {
        onEvent(name, evt) {
          if (name === 'htmx:beforeSwap') {
            const status = evt.detail.xhr ? evt.detail.xhr.status : 0;
            if (status >= 400) { evt.detail.shouldSwap = true; evt.detail.isError = false; }
          }
        }
      });
    })();
  </script>
  <script>
    (function () {
      function showOverlay(title, bodyHTML) {
        const id = 'htmx-error-overlay';
        let el = document.getElementById(id);
        if (!el) {
          el = document.createElement('div');
          el.id = id;
          el.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;padding:16px;';
          el.innerHTML =
            '<div style="max-width:900px;width:100%;background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.45)">'+
              '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:#1f2937;border-bottom:1px solid #374151;">'+
                '<div style="font-weight:700">HTMX エラー: <span id="he-title"></span></div>'+
                '<button id="he-close" style="padding:6px 10px;border:1px solid #4b5563;border-radius:8px;background:transparent;color:#e5e7eb">閉じる</button>'+
              '</div>'+
              '<div id="he-body" style="max-height:70vh;overflow:auto;padding:14px 16px;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;"></div>'+
            '</div>';
          document.body.appendChild(el);
          el.querySelector('#he-close').onclick = () => el.remove();
          document.addEventListener('keydown', ev => { if (ev.key === 'Escape') el.remove(); });
        }
        el.querySelector('#he-title').textContent = title || '';
        el.querySelector('#he-body').innerHTML   = bodyHTML || '';
      }
      document.body.addEventListener('htmx:responseError', function (e) {
        const xhr = e.detail.xhr || {};
        const ct  = (xhr.getResponseHeader && xhr.getResponseHeader('Content-Type')) || '';
        let body  = xhr.responseText || '';
        if (ct.indexOf('application/json') >= 0) {
          try { body = '<pre>'+JSON.stringify(JSON.parse(body), null, 2)+'</pre>'; } catch(_){}
        }
        showOverlay('HTTP '+xhr.status, body || '(空のレスポンス)');
      });
    })();
  </script>

  <!-- Django messages → JSON -->
  <script id="dj-messages" type="application/json">
  [
  {% for m in messages %}
    {"text":"{{ m|escapejs }}","level":"{{ m.tags|default_if_none:'' }}"}{% if not forloop.last %},{% endif %}
  {% endfor %}
  ]
  </script>

  <!-- Global Toast（改行＆“数字＋単位”の非分割を強化） -->
  <script>
  (function(){
    // ---- DOM -------------------------------------------------------------
    let toast = document.getElementById("globalToast");
    if(!toast){
      toast = document.createElement("div");
      toast.id = "globalToast";
      Object.assign(toast.style,{
        position:"fixed",
        left:"50%",
        bottom:"calc(96px + env(safe-area-inset-bottom))",
        transform:"translate(-50%, 12px)",
        background:"rgba(18,21,33,.96)",
        color:"#fff",
        padding:"12px 14px",
        fontSize:"14px",
        fontWeight:"600",
        borderRadius:"12px",
        border:"1px solid rgba(255,255,255,.10)",
        boxShadow:"0 18px 42px rgba(0,0,0,.45)",
        opacity:"0",
        pointerEvents:"none",
        transition:"opacity .22s ease, transform .22s ease",
        zIndex:"100260",
        maxWidth:"92vw",
        textAlign:"left",
        lineHeight:"1.5",
        wordBreak:"keep-all",
        overflowWrap:"anywhere",
        backdropFilter:"blur(10px)",
      });
      document.body.appendChild(toast);
    }

    // 下タブ/現金ドックに被らない
    function adjustOffset(){
      const bottomTab = document.getElementById("bottomTabRoot");
      const dockInner = document.querySelector(".cash-dock .inner");
      const tabH = bottomTab ? bottomTab.getBoundingClientRect().height : 0;
      const dockH = dockInner ? dockInner.getBoundingClientRect().height : 0;
      const offset = Math.max(96, Math.round(tabH + dockH + 16));
      toast.style.bottom = `calc(${offset}px + env(safe-area-inset-bottom))`;
    }
    adjustOffset();
    window.addEventListener("resize", adjustOffset);

    // ---- 見た目 ----------------------------------------------------------
    const styleFor = lvl => {
      if (/error/.test(lvl))   return {bg:"rgba(220,38,38,.96)", b:"#7f1d1d", icon:"⚠️"};
      if (/success/.test(lvl)) return {bg:"rgba(16,185,129,.96)", b:"#064e3b", icon:"✅"};
      if (/warning/.test(lvl)) return {bg:"rgba(234,179,8,.96)", b:"#713f12", icon:"⚠️"};
      return {bg:"rgba(18,21,33,.96)", b:"rgba(255,255,255,.10)", icon:"ℹ️"};
    };

    // ---- メッセージ取り込み ----------------------------------------------
    let queue = [];
    try{
      const el = document.getElementById("dj-messages");
      queue = el ? JSON.parse(el.textContent || "[]") : [];
    }catch(e){ queue = []; }

    // 外部 API
    window.toast = function(text, level="info"){
      queue.push({text, level});
      if (!showing) showNext();
    };

    // ---- 整形ユーティリティ ----------------------------------------------
    function escapeHtml(s){
      return String(s||"")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }
    function nn(s){ return (s===0 || s) ? String(s) : ""; }

    // 「数字+単位」を絶対に折り返さない（カンマ付きもOK）
    function protectUnits(textNode){
      // テキストをHTMLに差し替え（span で包む）
      const raw = textNode.textContent;
      const html = escapeHtml(raw)
        // 件・円・回・人・銘柄 を対象（必要なら増やす）
        .replace(/(^|[^0-9,])([0-9][0-9,]*)\s*(件|円|回|人|銘柄)/g,
          (_, pre, num, unit) => pre + '<span style="white-space:nowrap">'+ num +'&nbsp;'+ unit +'</span>');
      const wrap = document.createElement("span");
      wrap.innerHTML = html;
      textNode.replaceWith(wrap);
    }

    // ---- 表示ループ ------------------------------------------------------
    let i = 0, showing = false;

    function showNext(){
      if (i >= queue.length){ showing = false; return; }
      showing = true;

      const {text, level} = queue[i++] || {};
      const sty = styleFor(level||"");
      toast.style.background = sty.bg;
      toast.style.borderColor = sty.b;

      // 中身を組み立て（1行目=タイトル、以降=箇条書き）
      toast.innerHTML = "";
      const box = document.createElement("div");
      box.style.display = "grid";
      box.style.gap = "6px";

      const first = document.createElement("div");
      first.style.display = "flex";
      first.style.alignItems = "center";
      first.style.gap = "6px";
      const icon = document.createElement("span"); icon.textContent = sty.icon;
      const strong = document.createElement("strong");
      strong.style.fontWeight = "800";
      strong.textContent = nn(String(text||"").split("\n")[0] || "通知");
      first.appendChild(icon); first.appendChild(strong);
      box.appendChild(first);

      const lines = String(text||"").split("\n").slice(1);
      lines.forEach(line=>{
        if (!line.trim()) return;
        const row = document.createElement("div");
        row.style.display = "flex";
        const dot = document.createElement("span"); dot.textContent = "・"; dot.style.marginRight = "6px";
        const txt = document.createElement("span"); txt.textContent = line;
        row.appendChild(dot); row.appendChild(txt);
        box.appendChild(row);
        // 数字＋単位の非分割を適用（txtの中身に）
        protectUnits(txt.firstChild);
      });

      // もし1行しか無ければ、行にも非分割適用
      if (lines.length === 0) protectUnits(strong.firstChild);

      toast.appendChild(box);

      // アニメーション
      toast.style.opacity = "1";
      toast.style.transform = "translate(-50%, 0)";
      const SHOW_MS = /error/.test(level||"") ? 5200 : 4200;
      setTimeout(()=>{
        toast.style.opacity = "0";
        toast.style.transform = "translate(-50%, 12px)";
        setTimeout(showNext, 280);
      }, SHOW_MS);
    }

    if (queue.length) showNext();
  })();
  </script>
</body>
</html>