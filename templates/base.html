{% load static %}
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>{% block title %}My Stock{% endblock %}</title>

  <!-- Tailwind CDN（後でビルドに移行） -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js（必要ページのみ使われる想定だが共通読込でもOK） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>

  <!-- HTMX（defer） -->
  <script src="https://unpkg.com/htmx.org@1.9.12" defer></script>

  <!-- ★ HTMXにCSRFヘッダを自動付与（Djangoのcsrftokenクッキーを使用） -->
  <script>
    (function () {
      function getCookie(name) {
        const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return m ? m.pop() : '';
      }
      document.addEventListener('htmx:configRequest', function (e) {
        e.detail.headers['X-CSRFToken'] = getCookie('csrftoken');
      });
    })();
  </script>

  <!-- Alpine（必要なら） -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b0f1a">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').catch(console.error);
      });
    }
  </script>

  {# シートのベースCSS（最前面＆スクロール可能に） #}
  <style>
    #sheetRoot{
      position: fixed;
      inset: 0;
      z-index: 1000;               /* 何が来ても最前面 */
      pointer-events: none;        /* 中身が無いときはクリックを通す */
    }
    #sheetRoot > *{
      pointer-events: auto;        /* 中身があるときだけ操作可 */
    }
    /* realized/_close_sheet.html 側で .sheet をルートとして返す想定 */
    #sheetRoot .sheet{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      max-height: 90vh;            /* ← 下までスクロールできるように */
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      background: rgba(17,24,39,.98);
      border-top-left-radius: 14px;
      border-top-right-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 -10px 30px rgba(0,0,0,.5);
    }
    /* 背景の半透明オーバーレイ（close_sheet 側で .sheet-overlay を出しているなら） */
    #sheetRoot .sheet-overlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45);
    }
  </style>

  {% block head %}{% endblock %}
</head>
<body class="bg-slate-950 text-slate-100" hx-ext="swap-on-error">
  <main class="max-w-screen-sm mx-auto px-4 pb-24 pt-4">
    {% block content %}{% endblock %}
  </main>

  <!-- 全ページ共通：ボトムシート差し込み先（HTMXターゲット） -->
  <div id="sheetRoot" aria-live="polite"></div>

  <!-- 共通下タブ -->
  {% include "partials/bottom_tab.html" %}

  <!-- 売却シートのJS（クローズ等の細かい挙動） -->
  <script src="{% static 'js/realized_close.js' %}?v=3"></script>
  <script src="{% static 'js/realized_monthly_chart.js' %}?v=1"></script>

  <!-- HTMX 拡張: エラーでも強制スワップ -->
  <script>
    (function () {
      if (!window.htmx || htmx.defineExtension === undefined) return;
      htmx.defineExtension('swap-on-error', {
        onEvent: function (name, evt) {
          if (name === 'htmx:beforeSwap') {
            var status = evt.detail.xhr ? evt.detail.xhr.status : 0;
            if (status >= 400) {
              evt.detail.shouldSwap = true;
              evt.detail.isError = false;
            }
          }
        }
      });
    })();
  </script>

  <!-- HTMX エラーモーダル -->
  <script>
    (function () {
      function showOverlay(title, bodyHTML) {
        var id = 'htmx-error-overlay';
        var el = document.getElementById(id);
        if (!el) {
          el = document.createElement('div');
          el.id = id;
          el.style.cssText = 'position:fixed;inset:0;z-index:99999;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;padding:16px;';
          el.innerHTML =
            '<div style="max-width:900px;width:100%;background:#111827;color:#e5e7eb;border:1px solid #374151;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.45)">'+
              '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:#1f2937;border-bottom:1px solid #374151;">'+
                '<div style="font-weight:700">HTMX エラー: <span id="he-title"></span></div>'+
                '<button id="he-close" style="padding:6px 10px;border:1px solid #4b5563;border-radius:8px;background:transparent;color:#e5e7eb">閉じる</button>'+
              '</div>'+
              '<div id="he-body" style="max-height:70vh;overflow:auto;padding:14px 16px;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, monospace;"></div>'+
            '</div>';
          document.body.appendChild(el);
          el.querySelector('#he-close').onclick = function(){ el.remove(); };
          document.addEventListener('keydown', function(ev){
            if (ev.key === 'Escape') { var x = document.getElementById('htmx-error-overlay'); if (x) x.remove(); }
          });
        }
        el.querySelector('#he-title').textContent = title || '';
        el.querySelector('#he-body').innerHTML = bodyHTML || '';
      }

      document.body.addEventListener('htmx:responseError', function (e) {
        var xhr = e.detail.xhr || {};
        var ct  = (xhr.getResponseHeader && xhr.getResponseHeader('Content-Type')) || '';
        var body = xhr.responseText || '';
        if (ct.indexOf('application/json') >= 0) {
          try { body = '<pre>'+JSON.stringify(JSON.parse(body), null, 2)+'</pre>'; } catch(_){}
        }
        showOverlay('HTTP '+xhr.status, body || '(空のレスポンス)');
      });

      // シートが差し込まれたら自動で最下部までスクロール可能な状態に
      document.body.addEventListener('htmx:afterSwap', function(e){
        if (!e || !e.detail || !e.detail.target) return;
        if (e.detail.target.id === 'sheetRoot') {
          // iOS系での慣性スクロールを確実化
          var sheet = document.querySelector('#sheetRoot .sheet');
          if (sheet) sheet.style.webkitOverflowScrolling = 'touch';
        }
      });
    })();
  </script>
</body>
</html>