<div id="detail-modal"
     class="detail-modal"
     aria-hidden="false"
     data-stock-id="{{ stock.id }}">  <!-- JS が参照するため stock.id を埋め込み -->

  <!-- オーバーレイ（タップで閉じる） -->
  <div class="detail-modal__overlay" data-dm-close></div>

  <div class="detail-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="detail-modal-title">
    <!-- ヘッダー：銘柄名＝1行目中央／コード＝2行目中央 -->
    <header class="detail-modal__header">
      <h2 id="detail-modal-title" class="dm-title">
        <span class="dm-name">{{ stock.name }}</span>
        <span class="dm-code">{{ stock.ticker }}</span>
      </h2>
    </header>

    <!-- タブ -->
    <nav class="detail-tabs" role="tablist" aria-label="詳細タブ">
      <button class="detail-tab is-active"
              data-tab="overview"
              role="tab"
              aria-selected="true">
        概要
      </button>

      <!-- 価格タブ（lazy-load 用に JS が利用） -->
      <button class="detail-tab"
              data-tab="price"
              role="tab"
              aria-selected="false">
        価格
      </button>

      <!-- 指標タブを有効化 -->
      <button class="detail-tab"
              data-tab="fundamental"
              role="tab"
              aria-selected="false">
        指標
      </button>

      <!-- ニュースは未実装のままでもOK -->
      <button class="detail-tab"
              data-tab="news"
              role="tab"
              aria-selected="false">
        ニュース
      </button>
    </nav>

    <!-- パネル -->
    <section class="detail-panels">
      <!-- 概要：最初はスケルトン → JS が /overview.json を描画 -->
      <div class="detail-panel is-active" data-panel="overview">
        <div class="skeleton">
          <div class="sk-line"></div>
          <div class="sk-line"></div>
          <div class="sk-line sk-line--w60"></div>
        </div>
      </div>

      <!-- 価格：初回クリック時に /price.json を取得して描画 -->
      <div class="detail-panel" data-panel="price">
        <div class="price-wrap">
          <!-- 期間チップ（JS が読み取ってチャート更新） -->
          <div class="price-range-chips" role="tablist" aria-label="期間を選択">
            <button type="button" class="chip is-active" data-range="1M" aria-selected="true">1M</button>
            <button type="button" class="chip" data-range="3M" aria-selected="false">3M</button>
            <button type="button" class="chip" data-range="1Y" aria-selected="false">1Y</button>
          </div>

          <div class="price-top">
            <div class="price-last">
              <span class="label">最新</span>
              <span class="val" id="price-last">—</span>
            </div>
            <div class="price-chg">
              <span class="label">前日比</span>
              <span class="val" id="price-chg">—</span>
            </div>
          </div>

          <!-- ▼ チャート：ベース＋オーバーレイ（クロスヘア等を将来使う場合に備えて重ねる）
               ピンチズーム/ドラッグパンを確実に拾うため touch-action: none を明示 -->
          <div class="price-chart" style="position:relative; width:100%;">
            <canvas id="price-canvas"
                    width="600" height="180"
                    style="display:block; width:100%; height:180px; touch-action:none;"
                    aria-label="価格推移（ピンチでズーム、ドラッグでパン）"></canvas>

            <!-- オーバーレイ（将来のクロスヘア・ツールチップ用） -->
            <canvas id="price-overlay"
                    width="600" height="180"
                    style="position:absolute; inset:0; width:100%; height:180px; pointer-events:none;"
                    aria-hidden="true"></canvas>

            <!-- ツールチップ（必要になったら JS で表示/配置する） -->
            <div class="price-tooltip"
                 id="price-tooltip"
                 role="status"
                 aria-live="polite"
                 style="position:absolute; left:8px; top:8px; font-size:12px; opacity:.8; pointer-events:none;">
              —
            </div>

            <!-- 操作ヒント -->
            <div style="position:absolute; right:8px; bottom:6px; font-size:11px; opacity:.7; pointer-events:none;">
              ピンチでズーム／ドラッグでパン
            </div>
          </div>

          <div class="price-rows">
            <div class="row"><span>52週高値</span><span id="price-52h">—</span></div>
            <div class="row"><span>52週安値</span><span id="price-52l">—</span></div>
            <div class="row"><span>上場来高値</span><span id="price-allh">—</span></div>
            <div class="row"><span>上場来安値</span><span id="price-alll">—</span></div>
          </div>
        </div>
      </div>

      <!-- 指標：/fundamental.json を lazy-load で描画 -->
      <div class="detail-panel" data-panel="fundamental">
        <div class="overview-grid">
          <div class="ov-item">
            <div class="ov-k">PER</div>
            <div class="ov-v" id="fd-per">—</div>
          </div>
          <div class="ov-item">
            <div class="ov-k">PBR</div>
            <div class="ov-v" id="fd-pbr">—</div>
          </div>
          <div class="ov-item">
            <div class="ov-k">配当利回り</div>
            <div class="ov-v" id="fd-div">—</div>
          </div>
          <div class="ov-item">
            <div class="ov-k">予想配当（1株）</div>
            <div class="ov-v" id="fd-dps">—</div>
          </div>
          <div class="ov-item">
            <div class="ov-k">時価総額</div>
            <div class="ov-v" id="fd-mcap">—</div>
          </div>
          <div class="ov-item" style="grid-column:1 / -1;">
            <div class="ov-k">EPS（推定）</div>
            <div class="ov-v" id="fd-eps">—</div>
          </div>
          <div class="ov-item" style="grid-column:1 / -1;">
            <div class="ov-k">更新</div>
            <div class="ov-v" id="fd-updated">—</div>
          </div>
        </div>
      </div>

      <div class="detail-panel" data-panel="news">
    <div class="news-list" id="news-list">
      <div class="news-skeleton">
        <div class="sk-line"></div>
        <div class="sk-line"></div>
        <div class="sk-line sk-line--w60"></div>
      </div>
    </div>
  </div>
</section>

    <!-- フッター（左から：編集／売却／閉じる） -->
    <footer class="detail-modal__footer">
      <a href="{% url 'stock_edit' stock.id %}" class="dm-btn dm-btn--edit">編集</a>
      <a href="{% url 'stock_sell' stock.id %}" class="dm-btn dm-btn--danger">売却</a>
      <button type="button" class="dm-btn dm-btn--close" data-dm-close aria-label="モーダルを閉じる">閉じる</button>
    </footer>
  </div>
</div>