{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}売却 - {{ stock.name }} ({{ stock.ticker }}){% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stock_sell.css' %}">
{% endblock %}

{% block content %}
{% now "Y-m-d" as now_str %}
{% with today_val=today_str|default:now_str %}
<div class="sell-page"
     id="sellPageRoot"
     data-shares="{{ stock.shares }}"
     data-unit-price="{{ stock.unit_price|floatformat:2 }}"
     data-current-price="{% if current_price %}{{ current_price|floatformat:2 }}{% elif stock.current_price %}{{ stock.current_price|floatformat:2 }}{% else %}0{% endif %}"
     data-has-price="{{ has_price_available|yesno:'1,0' }}"
     data-initial-mode="{{ initial_sell_mode_default }}">

  <header class="sell-header">
    <a href="{% url 'stock_list' %}" class="back-link" aria-label="一覧へ戻る">←</a>
    <h1 class="sell-title">
      <span class="name">{{ stock.name }}</span>
      <span class="code">{{ stock.ticker }}</span>
    </h1>
  </header>

  {% if errors %}
    <div class="sell-errors" id="sell-errors" aria-live="polite">
      <ul>
        {% for e in errors %}<li>{{ e }}</li>{% endfor %}
      </ul>
    </div>
  {% else %}
    <div class="sell-errors" id="sell-errors" aria-live="polite" hidden></div>
  {% endif %}

  {% if not has_price_available %}
    <div class="banner warn" id="noPriceBanner">現在値を取得できないため、初期状態を「指値」にしています。価格を入力してください。</div>
  {% endif %}

  <form id="sell-form" method="post" action="{% url 'stock_sell' pk=stock.pk %}" novalidate>
    {% csrf_token %}
    <input type="hidden" name="stock_id" value="{{ stock.id }}">
    <!-- 互換用：サーバでは再計算するが一応残す -->
    <input type="hidden" name="fee" id="hidden-fee" value="{{ posted.fee|default:'' }}">
    <input type="hidden" name="sell_price" id="hidden-sell-price" value="{{ posted.sell_price|default:'' }}">

    <!-- 売却日 -->
    <section class="sell-date card">
      <label class="form-label" for="sell-date-input">売却日</label>
      <input id="sell-date-input" name="sell_date" type="date"
             value="{{ posted.sell_date|default:today_val }}" class="text-input">
      <p class="hint">約定日を選択（未変更なら本日）</p>
    </section>

    <!-- 概要 -->
    <section class="sell-summary">
      <div class="pill"><span class="k">保有株数</span><span class="v">{{ stock.shares|intcomma }} 株</span></div>
      <div class="pill"><span class="k">取得単価</span><span class="v">¥{{ stock.unit_price|floatformat:0|intcomma }}</span></div>
      <div class="pill">
        <span class="k">現在株価</span>
        <span class="v">
          {% if current_price %}
            ¥{{ current_price|floatformat:0|intcomma }}
          {% elif stock.current_price %}
            ¥{{ stock.current_price|floatformat:0|intcomma }}
          {% else %}
            —
          {% endif %}
        </span>
      </div>
      <div class="pill"><span class="k">口座</span><span class="v">{{ stock.account_type|default:"—" }}</span></div>
      <div class="pill"><span class="k">証券</span><span class="v">{{ stock.broker|default:"—" }}</span></div>
    </section>

    <!-- 数量（整数） -->
    <section class="form-section card">
      <label class="form-label" for="sell-shares">売却株数</label>
      <div class="qty-row">
        <button type="button" class="qty-btn" data-step="-100">-100</button>
        <button type="button" class="qty-btn" data-step="-10">-10</button>
        <input id="sell-shares" name="shares" type="number" inputmode="numeric"
               min="1" max="{{ stock.shares }}" step="1"
               value="{{ posted.shares|default:stock.shares }}"
               class="qty-input" required>
        <button type="button" class="qty-btn" data-step="10">+10</button>
        <button type="button" class="qty-btn" data-step="100">+100</button>
      </div>
      <div class="qty-helpers">
        <button type="button" class="chip" data-fill="25">25%</button>
        <button type="button" class="chip" data-fill="50">50%</button>
        <button type="button" class="chip" data-fill="75">75%</button>
        <button type="button" class="chip" data-fill="100">ALL</button>
      </div>
    </section>

    <!-- 売却方法 -->
    <section class="form-section card">
      <span class="form-label">売却方法</span>
      {% with sel=posted.sell_mode|default:initial_sell_mode_default %}
      <div class="mode-row" role="radiogroup" aria-label="売却方法">
        <label class="mode-item">
          <input type="radio" name="sell_mode" value="market" {% if sel == 'market' %}checked{% endif %}>
          <span>市場価格</span>
        </label>
        <label class="mode-item">
          <input type="radio" name="sell_mode" value="limit" {% if sel == 'limit' %}checked{% endif %}>
          <span>指値</span>
        </label>
      </div>

      <!-- 指値（text+tel）＋ ソフトキー -->
      <div id="limit-wrap" class="limit-wrap" {% if sel != 'limit' %}hidden{% endif %}>
        <label class="form-label" for="limit-price">指値（円）</label>
        <input id="limit-price" name="limit_price"
               type="text" inputmode="tel"
               autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
               placeholder="例: 1234 / 1234.5 / -1234"
               value="{{ posted.limit_price|default:'' }}"
               class="text-input">
        <div class="softpad" data-target="#limit-price" aria-label="数値キーパッド">
          <button type="button" class="sp-key sp-minus" aria-label="マイナスを挿入">−</button>
          <button type="button" class="sp-key sp-dot" aria-label="小数点を挿入">.</button>
          <button type="button" class="sp-key sp-toggle" aria-label="符号を反転">±</button>
          <button type="button" class="sp-key sp-clear" aria-label="クリア">C</button>
        </div>

        <div class="limit-hints">
          {% if current_price %}
            <button type="button" class="chip" data-limit="{{ current_price|floatformat:0 }}">現在値</button>
          {% elif stock.current_price %}
            <button type="button" class="chip" data-limit="{{ stock.current_price|floatformat:0 }}">現在値</button>
          {% endif %}
          <button type="button" class="chip" data-limit="+5">+5</button>
          <button type="button" class="chip" data-limit="+10">+10</button>
          <button type="button" class="chip" data-limit="-5">-5</button>
          <button type="button" class="chip" data-limit="-10">-10</button>
        </div>
      </div>
      {% endwith %}
    </section>

    <!-- 実際の損益額（text+tel）＋ ソフトキー -->
    <section class="form-section card">
      <label class="form-label" for="actual-profit">実際の損益額（円）</label>
      <input id="actual-profit" name="actual_profit"
             type="text" inputmode="tel"
             autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
             placeholder="例: -12,345.67"
             value="{{ posted.actual_profit|default:'' }}"
             class="text-input"
             aria-describedby="actual-profit-help">
      <p id="actual-profit-help" class="hint">必要なら下の − / . / ± / C を使って入力できます。</p>

      <div class="softpad" data-target="#actual-profit" aria-label="数値キーパッド">
        <button type="button" class="sp-key sp-minus" aria-label="マイナスを挿入">−</button>
        <button type="button" class="sp-key sp-dot" aria-label="小数点を挿入">.</button>
        <button type="button" class="sp-key sp-toggle" aria-label="符号を反転">±</button>
        <button type="button" class="sp-key sp-clear" aria-label="クリア">C</button>
      </div>
    </section>

    <!-- ライブ計算 -->
    <section class="review card">
      <div class="row"><span class="k">取得額</span><span class="v" id="rv-buy">—</span></div>
      <div class="row"><span class="k">売却額</span><span class="v" id="rv-sell">—</span></div>
      <div class="row"><span class="k">損益</span><span class="v" id="rv-pl">—</span></div>
      <div class="row"><span class="k">手数料</span><span class="v" id="rv-fee">—</span></div>
    </section>

    <div class="sticky-actions">
      <a href="{% url 'stock_list' %}" class="btn secondary">キャンセル</a>
      <button type="submit" class="btn danger" id="sell-submit">売却する</button>
    </div>

    <div class="page-end-spacer" aria-hidden="true"></div>
  </form>
</div>
{% endwith %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/stock_sell.js' %}" defer></script>
{% endblock %}