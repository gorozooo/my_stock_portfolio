す{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}売却 - {{ stock.name }} ({{ stock.ticker }}){% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stock_sell.css' %}">
{% endblock %}

{% block content %}
{% now "Y-m-d" as now_str %}
{% with today_val=today_str|default:now_str %}
<div class="sell-page">
  <header class="sell-header">
    <a href="{% url 'stock_list' %}" class="back-link" aria-label="一覧へ戻る">←</a>
    <h1 class="sell-title">
      <span class="name">{{ stock.name }}</span>
      <span class="code">{{ stock.ticker }}</span>
    </h1>
  </header>

  {% if errors %}
    <div class="sell-errors" id="sell-errors" aria-live="polite">
      <ul>
        {% for e in errors %}<li>{{ e }}</li>{% endfor %}
      </ul>
    </div>
  {% else %}
    <div class="sell-errors" id="sell-errors" aria-live="polite" hidden></div>
  {% endif %}

  {% if not has_price_available %}
    <div class="banner warn">現在値を取得できないため、初期状態を「指値」にしています。価格を入力してください。</div>
  {% endif %}

  <form id="sell-form" method="post" action="{% url 'stock_sell' pk=stock.pk %}">
    {% csrf_token %}
    <input type="hidden" name="stock_id" value="{{ stock.id }}">
    <input type="hidden" name="fee" id="hidden-fee" value="{{ posted.fee|default:'' }}">
    <input type="hidden" name="sell_price" id="hidden-sell-price" value="{{ posted.sell_price|default:'' }}">

    <!-- 売却日 -->
    <section class="sell-date card">
      <label class="form-label" for="sell-date-input">売却日</label>
      <input id="sell-date-input" name="sell_date" type="date"
             value="{{ posted.sell_date|default:today_val }}" class="text-input">
      <p class="hint">約定日を選択（未変更なら本日）</p>
    </section>

    <!-- 概要 -->
    <section class="sell-summary">
      <div class="pill"><span class="k">保有株数</span><span class="v">{{ stock.shares|intcomma }} 株</span></div>
      <div class="pill"><span class="k">取得単価</span><span class="v">¥{{ stock.unit_price|floatformat:0|intcomma }}</span></div>
      <div class="pill">
        <span class="k">現在株価</span>
        <span class="v">
          {% if current_price %}
            ¥{{ current_price|floatformat:0|intcomma }}
          {% elif stock.current_price %}
            ¥{{ stock.current_price|floatformat:0|intcomma }}
          {% else %}
            —
          {% endif %}
        </span>
      </div>
      <div class="pill"><span class="k">口座</span><span class="v">{{ stock.account_type|default:"—" }}</span></div>
      <div class="pill"><span class="k">証券</span><span class="v">{{ stock.broker|default:"—" }}</span></div>
    </section>

    <!-- 数量（整数のみ） -->
    <section class="form-section card">
      <label class="form-label" for="sell-shares">売却株数</label>
      <div class="qty-row">
        <button type="button" class="qty-btn" data-step="-100">-100</button>
        <button type="button" class="qty-btn" data-step="-10">-10</button>
        <input id="sell-shares" name="shares" type="number" inputmode="numeric"
               min="1" max="{{ stock.shares }}" step="1"
               value="{{ posted.shares|default:stock.shares }}"
               class="qty-input" required>
        <button type="button" class="qty-btn" data-step="10">+10</button>
        <button type="button" class="qty-btn" data-step="100">+100</button>
      </div>
      <div class="qty-helpers">
        <button type="button" class="chip" data-fill="25">25%</button>
        <button type="button" class="chip" data-fill="50">50%</button>
        <button type="button" class="chip" data-fill="75">75%</button>
        <button type="button" class="chip" data-fill="100">ALL</button>
      </div>
    </section>

    <!-- 売却方法 -->
    <section class="form-section card">
      <span class="form-label">売却方法</span>
      {% with sel=posted.sell_mode|default:initial_sell_mode_default %}
      <div class="mode-row" role="radiogroup" aria-label="売却方法">
        <label class="mode-item">
          <input type="radio" name="sell_mode" value="market" {% if sel == 'market' %}checked{% endif %}>
          <span>市場価格</span>
        </label>
        <label class="mode-item">
          <input type="radio" name="sell_mode" value="limit" {% if sel == 'limit' %}checked{% endif %}>
          <span>指値</span>
        </label>
      </div>

      <!-- 指値：小数点・マイナスのテンキーを許可（サーバ側で0以下はエラーに） -->
      <div id="limit-wrap" class="limit-wrap" {% if sel != 'limit' %}hidden{% endif %}>
        <label class="form-label" for="limit-price">指値（円）</label>
        <input id="limit-price" name="limit_price"
               type="text"
               inputmode="decimal"
               pattern="^-?\\d*([\\.,]\\d+)?$"
               placeholder="例: 1,234.56（マイナスも入力可）"
               value="{{ posted.limit_price|default:'' }}"
               class="text-input">

        <div class="limit-hints">
          {% if current_price %}
            <button type="button" class="chip" data-limit="{{ current_price|floatformat:0 }}">現在値</button>
          {% elif stock.current_price %}
            <button type="button" class="chip" data-limit="{{ stock.current_price|floatformat:0 }}">現在値</button>
          {% endif %}
          <button type="button" class="chip" data-limit="+5">+5</button>
          <button type="button" class="chip" data-limit="+10">+10</button>
          <button type="button" class="chip" data-limit="-5">-5</button>
          <button type="button" class="chip" data-limit="-10">-10</button>
        </div>
      </div>
      {% endwith %}
    </section>

    <!-- 実際の損益額 -->
    <section class="form-section card">
      <label class="form-label" for="actual-profit">実際の損益額（円）</label>
      <input id="actual-profit" name="actual_profit"
             type="text"
             inputmode="tel"        <!-- ← 電話配列で確実に数字行 -->
             autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"
             placeholder="例: -12,345.67"
             value="{{ posted.actual_profit|default:'' }}"
             class="text-input">
    
      <!-- ここを追加：仮想キー -->
      <div class="softpad" data-target="#actual-profit" aria-label="数値キーパッド">
        <button type="button" class="sp-key sp-minus">−</button>
        <button type="button" class="sp-key sp-dot">.</button>
        <button type="button" class="sp-key sp-toggle">±</button>
        <button type="button" class="sp-key sp-clear">C</button>
      </div>
    </section>

    <!-- ライブ計算 -->
    <section class="review card">
      <div class="row"><span class="k">取得額</span><span class="v" id="rv-buy">—</span></div>
      <div class="row"><span class="k">売却額</span><span class="v" id="rv-sell">—</span></div>
      <div class="row"><span class="k">損益</span><span class="v" id="rv-pl">—</span></div>
      <div class="row"><span class="k">手数料</span><span class="v" id="rv-fee">—</span></div>
    </section>

    <div class="sticky-actions">
      <a href="{% url 'stock_list' %}" class="btn secondary">キャンセル</a>
      <button type="submit" class="btn danger" id="sell-submit">売却する</button>
    </div>

    <div class="page-end-spacer" aria-hidden="true"></div>
  </form>
</div>
{% endwith %}
{% endblock %}

{% block extra_js %}
<script>
  window.__SELL_CTX__ = {
    shares: {{ stock.shares }},
    unit_price: {{ stock.unit_price|floatformat:2 }},
    {% if current_price %}
      current_price: {{ current_price|floatformat:2 }},
    {% elif stock.current_price %}
      current_price: {{ stock.current_price|floatformat:2 }},
    {% else %}
      current_price: null,
    {% endif %}
  };
</script>
<script src="{% static 'js/stock_sell.js' %}" defer></script>
<script>
  // 現在値が無い場合はJSでも「指値」を選択状態に（安全側）
  document.addEventListener('DOMContentLoaded', function(){
    var hasPrice = {{ has_price_available|yesno:"true,false" }};
    if (!hasPrice) {
      var limitRadio = document.querySelector('input[name="sell_mode"][value="limit"]');
      var marketRadio= document.querySelector('input[name="sell_mode"][value="market"]');
      var limitWrap  = document.getElementById('limit-wrap');
      if (limitRadio) limitRadio.checked = true;
      if (marketRadio) marketRadio.checked = false;
      if (limitWrap) limitWrap.hidden = false;
    }
  });
(function(){
  // 文字列→数値 正規化（全角→半角、カンマ削除、全角マイナス対応）
  function normalizeNumericString(s){
    if (typeof s !== 'string') return '';
    // 全角英数記号→半角
    s = s.replace(/[！-～]/g, function(ch){ return String.fromCharCode(ch.charCodeAt(0)-0xFEE0); });
    // 全角ハイフン/マイナスや長音などを半角マイナスへ
    s = s.replace(/[－ー―−‒–—]/g, '-');
    // カンマ削除、全角ピリオド→半角
    s = s.replace(/,/g,'').replace(/。/g,'.').replace(/．/g,'.');
    // 先頭以外のマイナスは除去（例: "12-3" → "123"）
    s = s.replace(/(?!^)-/g,'');
    // ドットは最初の1個だけ許容
    const firstDot = s.indexOf('.');
    if (firstDot !== -1) {
      s = s.slice(0, firstDot + 1) + s.slice(firstDot + 1).replace(/\./g, '');
    }
    return s;
  }

  // カーソル位置に文字を挿入
  function insertAtCursor(input, text){
    const start = input.selectionStart ?? input.value.length;
    const end   = input.selectionEnd ?? input.value.length;
    const before = input.value.slice(0, start);
    const after  = input.value.slice(end);
    input.value = before + text + after;
    const pos = start + text.length;
    input.setSelectionRange(pos, pos);
    input.dispatchEvent(new Event('input', {bubbles:true}));
  }

  // ±トグル
  function toggleSign(input){
    let v = input.value || '';
    v = normalizeNumericString(v);
    if (!v) { input.value = '-'; input.setSelectionRange(1,1); return; }
    if (v.startsWith('-')) v = v.slice(1);
    else v = '-' + v;
    input.value = v;
    input.dispatchEvent(new Event('input', {bubbles:true}));
  }

  // C クリア
  function clearAll(input){
    input.value = '';
    input.dispatchEvent(new Event('input', {bubbles:true}));
  }

  // .（小数点）を一つだけ
  function insertDot(input){
    let v = normalizeNumericString(input.value || '');
    if (v.includes('.')) return;
    insertAtCursor(input, '.');
  }

  // −（マイナス）を先頭に1回
  function insertMinus(input){
    let v = normalizeNumericString(input.value || '');
    if (v.startsWith('-')) return;
    // 先頭に挿入
    input.focus();
    input.setSelectionRange(0,0);
    insertAtCursor(input, '-');
  }

  // すべての .softpad を初期化
  document.querySelectorAll('.softpad').forEach(pad=>{
    const targetSel = pad.getAttribute('data-target');
    const input = document.querySelector(targetSel);
    if (!input) return;

    pad.addEventListener('click', (e)=>{
      const btn = e.target.closest('.sp-key');
      if (!btn) return;
      if (btn.classList.contains('sp-minus'))  insertMinus(input);
      else if (btn.classList.contains('sp-dot')) insertDot(input);
      else if (btn.classList.contains('sp-toggle')) toggleSign(input);
      else if (btn.classList.contains('sp-clear'))  clearAll(input);
      input.focus();
    });

    // 入力時に都度正規化（全角/カンマ等）
    input.addEventListener('input', ()=>{
      const pos = input.selectionStart;
      const before = input.value;
      const normalized = normalizeNumericString(before);
      if (before !== normalized){
        input.value = normalized;
        // ざっくりカーソル維持
        const newPos = Math.min(normalized.length, pos ?? normalized.length);
        input.setSelectionRange(newPos, newPos);
      }
    });
  });

  // 送信直前に hidden 値へも正規化して反映（既に stock_sell.js があればそこで拾ってOK）
  const form = document.getElementById('sell-form');
  if (form){
    form.addEventListener('submit', ()=>{
      ['#actual-profit','#limit-price'].forEach(sel=>{
        const el = document.querySelector(sel);
        if (!el) return;
        el.value = normalizeNumericString(el.value || '');
      });
    });
  }
})();
</script>
{% endblock %}