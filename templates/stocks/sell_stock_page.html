{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}売却 - {{ stock.name }} ({{ stock.ticker }}){% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stock_sell.css' %}">
{% endblock %}

{% block content %}
{% now "Y-m-d" as now_str %}
{% with today_val=today_str|default:now_str %}
<div class="sell-page">
  <header class="sell-header">
    <a href="{% url 'stock_list' %}" class="back-link" aria-label="一覧へ戻る">←</a>
    <h1 class="sell-title">
      <span class="name">{{ stock.name }}</span>
      <span class="code">{{ stock.ticker }}</span>
    </h1>
  </header>

  {# ===== エラー表示（サーババリデーション） ===== #}
  {% if errors %}
    <div class="sell-errors" id="sell-errors" aria-live="polite">
      <ul>
        {% for e in errors %}<li>{{ e }}</li>{% endfor %}
      </ul>
    </div>
  {% else %}
    <div class="sell-errors" id="sell-errors" aria-live="polite" hidden></div>
  {% endif %}

  {# 現在値が無い時のヒント #}
  {% if not current_price and not stock.current_price %}
    <div class="banner warn">現在値を取得できないため、初期状態を「指値」にしています。価格を入力してください。</div>
  {% endif %}

  <form id="sell-form" method="post" action="{% url 'stock_sell' pk=stock.pk %}">
    {% csrf_token %}
    <input type="hidden" name="stock_id" value="{{ stock.id }}">
    <input type="hidden" name="fee" id="hidden-fee" value="{{ posted.fee|default:'' }}">
    <input type="hidden" name="sell_price" id="hidden-sell-price" value="{{ posted.sell_price|default:'' }}">

    <!-- 売却日 -->
    <section class="sell-date card">
      <label class="form-label" for="sell-date-input">売却日</label>
      <input id="sell-date-input" name="sell_date" type="date"
             value="{{ posted.sell_date|default:today_val }}" class="text-input">
      <p class="hint">約定日を選択（未変更なら本日）</p>
    </section>

    <!-- 概要（ピル） -->
    <section class="sell-summary">
      <div class="pill"><span class="k">保有株数</span><span class="v">{{ stock.shares|intcomma }} 株</span></div>
      <div class="pill"><span class="k">取得単価</span><span class="v">¥{{ stock.unit_price|floatformat:0|intcomma }}</span></div>
      <div class="pill">
        <span class="k">現在株価</span>
        <span class="v">
          {% if current_price %}
            ¥{{ current_price|floatformat:0|intcomma }}
          {% elif stock.current_price %}
            ¥{{ stock.current_price|floatformat:0|intcomma }}
          {% else %}
            —
          {% endif %}
        </span>
      </div>
      <div class="pill"><span class="k">口座</span><span class="v">{{ stock.account_type|default:"—" }}</span></div>
      <div class="pill"><span class="k">証券</span><span class="v">{{ stock.broker|default:"—" }}</span></div>
    </section>

    <!-- 数量 -->
    <section class="form-section card">
      <label class="form-label" for="sell-shares">売却株数</label>
      <div class="qty-row">
        <button type="button" class="qty-btn" data-step="-100">-100</button>
        <button type="button" class="qty-btn" data-step="-10">-10</button>
        <input id="sell-shares" name="shares" type="number" inputmode="numeric"
               min="1" max="{{ stock.shares }}" step="1"
               value="{{ posted.shares|default:stock.shares }}"
               class="qty-input" required>
        <button type="button" class="qty-btn" data-step="10">+10</button>
        <button type="button" class="qty-btn" data-step="100">+100</button>
      </div>
      <div class="qty-helpers">
        <button type="button" class="chip" data-fill="25">25%</button>
        <button type="button" class="chip" data-fill="50">50%</button>
        <button type="button" class="chip" data-fill="75">75%</button>
        <button type="button" class="chip" data-fill="100">ALL</button>
      </div>
    </section>

    <!-- 売却方法 -->
    <section class="form-section card">
      <span class="form-label">売却方法</span>
      {% with has_price=(current_price or stock.current_price) %}
      <div class="mode-row" role="radiogroup" aria-label="売却方法">
        {% with sel=posted.sell_mode|default:('market' if has_price else 'limit') %}
          <label class="mode-item">
            <input type="radio" name="sell_mode" value="market" {% if sel == 'market' %}checked{% endif %}>
            <span>市場価格</span>
          </label>
          <label class="mode-item">
            <input type="radio" name="sell_mode" value="limit" {% if sel == 'limit' %}checked{% endif %}>
            <span>指値</span>
          </label>
        {% endwith %}
      </div>

      {# 価格入力（現在値が無ければ初期表示） #}
      {% with sel=posted.sell_mode|default:('market' if has_price else 'limit') %}
      <div id="limit-wrap" class="limit-wrap" {% if sel != 'limit' %}hidden{% endif %}>
        <label class="form-label" for="limit-price">指値（円）</label>
        <input id="limit-price" name="limit_price" type="number" inputmode="numeric"
               min="0" step="1" placeholder="例: 1,234"
               value="{{ posted.limit_price|default:'' }}" class="text-input">

        <div class="limit-hints">
          {% if current_price %}
            <button type="button" class="chip" data-limit="{{ current_price|floatformat:0 }}">現在値</button>
          {% elif stock.current_price %}
            <button type="button" class="chip" data-limit="{{ stock.current_price|floatformat:0 }}">現在値</button>
          {% endif %}
          <button type="button" class="chip" data-limit="+5">+5</button>
          <button type="button" class="chip" data-limit="+10">+10</button>
          <button type="button" class="chip" data-limit="-5">-5</button>
          <button type="button" class="chip" data-limit="-10">-10</button>
        </div>
      </div>
      {% endwith %}
      {% endwith %}
    </section>

    <!-- 実際の損益額 -->
    <section class="form-section card">
      <label class="form-label" for="actual-profit">実際の損益額（円）</label>
      <input id="actual-profit" name="actual_profit" type="number" inputmode="numeric" step="1"
             placeholder="例: 12,345（空欄なら 売却額−取得額 を使用）"
             value="{{ posted.actual_profit|default:'' }}" class="text-input">
    </section>

    <!-- ライブ計算（レビュー） -->
    <section class="review card">
      <div class="row"><span class="k">取得額</span><span class="v" id="rv-buy">—</span></div>
      <div class="row"><span class="k">売却額</span><span class="v" id="rv-sell">—</span></div>
      <div class="row"><span class="k">損益</span><span class="v" id="rv-pl">—</span></div>
      <div class="row"><span class="k">手数料</span><span class="v" id="rv-fee">—</span></div>
    </section>

    <!-- 送信 -->
    <div class="sticky-actions">
      <a href="{% url 'stock_list' %}" class="btn secondary">キャンセル</a>
      <button type="submit" class="btn danger" id="sell-submit">売却する</button>
    </div>

    <div class="page-end-spacer" aria-hidden="true"></div>
  </form>
</div>
{% endwith %}
{% endblock %}

{% block extra_js %}
<script>
  window.__SELL_CTX__ = {
    shares: {{ stock.shares }},
    unit_price: {{ stock.unit_price|floatformat:2 }},
    {% if current_price %}
      current_price: {{ current_price|floatformat:2 }},
    {% elif stock.current_price %}
      current_price: {{ stock.current_price|floatformat:2 }},
    {% else %}
      current_price: null,
    {% endif %}
  };
</script>
<script src="{% static 'js/stock_sell.js' %}" defer></script>
<script>
  // 現在値が無い場合はJSでも安全に「指値」へ切替
  document.addEventListener('DOMContentLoaded', ()=>{
    const ctx = window.__SELL_CTX__ || {};
    const hasPrice = ctx.current_price != null && Number(ctx.current_price) > 0;
    if (!hasPrice) {
      const limitRadio = document.querySelector('input[name="sell_mode"][value="limit"]');
      const marketRadio= document.querySelector('input[name="sell_mode"][value="market"]');
      const limitWrap  = document.getElementById('limit-wrap');
      if (limitRadio) limitRadio.checked = true;
      if (marketRadio) marketRadio.checked = false;
      if (limitWrap) limitWrap.hidden = false;
    }
  });
</script>
{% endblock %}