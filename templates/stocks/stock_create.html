{% extends "base.html" %}
{% load static %}

{% block title %}新規登録 | My株ポートフォリオ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stock_form.css' %}">
{% endblock %}

{% block content %}
<main>
  <form id="stock-form" method="post" novalidate>
    {% csrf_token %}
    <div class="form-grid">

      <!-- 購入日 -->
      <div class="form-field">
        <label for="purchase_date">購入日</label>
        <input type="date" id="purchase_date" name="purchase_date"
               value="{{ data.purchase_date|default:'' }}">
      </div>

      <!-- 証券コード -->
      <div class="form-field">
        <label for="ticker">証券コード</label>
        <input type="text" id="ticker" name="ticker" pattern="^(\d{4}|\d{3,4}[A-Z])$"
               value="{{ data.ticker|default:'' }}">
        {% if errors.ticker %}<div class="field-error">{{ errors.ticker }}</div>{% endif %}
      </div>

      <!-- 銘柄名 -->
      <div class="form-field">
        <label for="name">銘柄</label>
        <input type="text" id="name" name="name" value="{{ data.name|default:'' }}">
        {% if errors.name %}<div class="field-error">{{ errors.name }}</div>{% endif %}
      </div>

      <!-- 口座区分 -->
      <div class="form-field">
        <label for="account_type">口座区分</label>
        <select id="account_type" name="account_type">
          <option value="" disabled {% if not data.account_type %}selected{% endif %}>選択してください</option>
          <option value="現物" {% if data.account_type == '現物' %}selected{% endif %}>現物</option>
          <option value="信用" {% if data.account_type == '信用' %}selected{% endif %}>信用</option>
          <option value="NISA" {% if data.account_type == 'NISA' %}selected{% endif %}>NISA</option>
        </select>
        {% if errors.account_type %}<div class="field-error">{{ errors.account_type }}</div>{% endif %}
      </div>

      <!-- 証券会社 -->
      <div class="form-field" id="broker-field">
        <label for="broker">証券会社</label>
        <select id="broker" name="broker">
          <option value="" disabled {% if not data.broker %}selected{% endif %}>選択してください</option>
          {% for val,label in BROKER_CHOICES %}
            <option value="{{ val }}" {% if data.broker == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
        {% if errors.broker %}<div class="field-error">{{ errors.broker }}</div>{% endif %}
      </div>

      <!-- セクター -->
      <div class="form-field">
        <label for="sector">セクター</label>
        <input list="sector-list" id="sector" name="sector" value="{{ data.sector|default:'' }}">
        <datalist id="sector-list"></datalist>
        {% if errors.sector %}<div class="field-error">{{ errors.sector }}</div>{% endif %}
      </div>

      <!-- 株数 -->
      <div class="form-field">
        <label for="shares">株数</label>
        <input type="number" id="shares" name="shares" min="1" step="1" value="{{ data.shares|default:'' }}">
        {% if errors.shares %}<div class="field-error">{{ errors.shares }}</div>{% endif %}
      </div>

      <!-- 取得単価 -->
      <div class="form-field">
        <label for="unit_price">取得単価</label>
        <input type="number" id="unit_price" name="unit_price" step="any" min="0" value="{{ data.unit_price|default:'' }}">
        {% if errors.unit_price %}<div class="field-error">{{ errors.unit_price }}</div>{% endif %}
      </div>

      <!-- 取得額（自動計算） -->
      <div class="form-field">
        <label for="total_cost">取得額</label>
        <input type="text" id="total_cost" readonly value="{{ data.total_cost|default:'' }}">
        <input type="hidden" id="total_cost_raw" name="total_cost" value="{{ data.total_cost|default:'' }}">
      </div>

      <!-- 備考 -->
      <div class="form-field form-field--full">
        <label for="note">備考</label>
        <textarea id="note" name="note" rows="3">{{ data.note|default:'' }}</textarea>
      </div>

    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary">登録する</button>
      <a class="btn btn-secondary" href="{% url 'stock_list' %}">戻る</a>
    </div>
  </form>
</main>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/stock_form.js' %}" defer></script>
{% endblock %}
