{% load humanize %}

<style>
  .rk-d-wrap{margin-top:10px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
  .rk-d-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .rk-d-title{font-size:13px;color:#cbd5e1}
  .rk-d-actions{display:flex;gap:8px}
  .rk-d-btn{font-size:11px;padding:4px 8px;border:1px solid rgba(148,163,184,.25);border-radius:8px;background:transparent;color:#cbd5e1}
  .rk-d-grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:8px;margin-bottom:8px}
  .rk-d-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:8px}
  .k{font-size:11px;color:#94a3b8;margin-bottom:4px}
  .v{font-variant-numeric:tabular-nums}
  .pos{color:#86efac} .neg{color:#fca5a5}
  .rk-d-table{width:100%;border-collapse:separate;border-spacing:0}
  .rk-d-table th,.rk-d-table td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.08);font-size:12px}
  .num{text-align:right;font-variant-numeric:tabular-nums;white-space:nowrap}
  @media (max-width: 800px){ .rk-d-grid{grid-template-columns:repeat(2,minmax(0,1fr))} }
</style>

{# â˜… outerHTML ã§ç½®æ›ã•ã‚Œã¦ã‚‚æ¬¡ã‚‚å½“ãŸã‚‹ã‚ˆã†ã«ã€å¿…ãšåŒã˜ id ã‚’æŒã¤ #}
<div id="pnlRankingDetailWrap" class="rk-d-wrap">

  <div class="rk-d-head">
    <div class="rk-d-title">éŠ˜æŸ„è©³ç´°: <strong>{{ ticker }}</strong></div>
    <div class="rk-d-actions">
      <button type="button" class="rk-d-btn" id="rkDetailClose">é–‰ã˜ã‚‹</button>
      <button type="button" class="rk-d-btn" id="rkDetailClear">ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤</button>
    </div>
  </div>

  {% if agg %}
    <div class="rk-d-grid">
      <div class="rk-d-card">
        <div class="k">ä»¶æ•°</div><div class="v">{{ agg.n|intcomma }}</div>
      </div>
      <div class="rk-d-card">
        <div class="k">æ•°é‡</div><div class="v">{{ agg.qty|intcomma }}</div>
      </div>
      <div class="rk-d-card">
        <div class="k">ğŸ“ˆ PnL</div>
        {% with p=agg.pnl %}<div class="v {% if p >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ p|floatformat:0|intcomma }}</div>{% endwith %}
      </div>
      <div class="rk-d-card">
        <div class="k">å¹³å‡ / å›</div><div class="v">Â¥{{ agg.avg|floatformat:0|intcomma }}</div>
      </div>
      <div class="rk-d-card">
        <div class="k">å‹ç‡</div><div class="v">{{ agg.win_rate|floatformat:0 }}%</div>
      </div>
    </div>
  {% endif %}

  <table class="rk-d-table">
    <thead>
      <tr>
        <th>æ—¥ä»˜</th><th>Side</th><th class="num">æ•°é‡</th><th class="num">ç´„å®šå˜ä¾¡</th><th class="num">ğŸ“ˆPnL</th>
      </tr>
    </thead>
    <tbody>
      {% if rows %}
        {% for t in rows %}
          <tr>
            <td>{{ t.trade_at|date:"Y-m-d" }}</td>
            <td>{{ t.side }}</td>
            <td class="num">{{ t.qty|intcomma }}</td>
            <td class="num">Â¥{{ t.price|floatformat:0|intcomma }}</td>
            <td class="num">
              {% with p=t.pnl_display %}
                <span class="{% if p >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ p|floatformat:0|intcomma }}</span>
              {% endwith %}
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="5" style="color:#94a3b8">ç›´è¿‘ã®ç´„å®šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
(() => {
  // é–‰ã˜ã‚‹ï¼šæ˜ç´°ã‚¨ãƒªã‚¢ã‚’ç©ºã«ã™ã‚‹ã ã‘
  document.getElementById('rkDetailClose')?.addEventListener('click', () => {
    const box = document.getElementById('pnlRankingDetailWrap');
    if (box) box.innerHTML = '';
  });

  // ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤ï¼š#q ã‚’ç©ºã«ã—ã¦æ—¢å­˜ã®é€£é–ã‚’ç™ºç«ã€æ˜ç´°ã‚‚ã‚¯ãƒªã‚¢
  document.getElementById('rkDetailClear')?.addEventListener('click', () => {
    const q = document.getElementById('q');
    if (q) {
      q.value = '';
      if (window.htmx) {
        document.body.dispatchEvent(new Event('pnl:refresh', {bubbles:true}));
        htmx.trigger(q, 'search');
      }
    }
    const box = document.getElementById('pnlRankingDetailWrap');
    if (box) box.innerHTML = '';
  });
})();
</script>