{% extends "base.html" %}
{% load static %}
{% block title %}実現損益{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/realized.css' %}?v=10">
<style>
  .view-hidden{display:none!important}
  section{margin-top:12px}
</style>
{% endblock %}

{% block content %}
<div class="pnl">
  <h1>実現損益</h1>

  {# ── 検索 ─────────────────────────────── #}
  <div class="fi fi-full mt-4">
    <input type="search" name="q" value="{{ q|default:'' }}" id="q"
           placeholder="ティッカー/名称で検索"
           hx-get="{% url 'realized_table_partial' %}"
           hx-target="#pnlTableWrap"
           hx-trigger="keyup changed delay:300ms, search"
           hx-include="#q"
           class="w-full">
  </div>

  {# ── Section 1: 上部サマリー（証券会社別まで） ─── #}
  <section id="realized-top">
    <div id="pnlSummaryWrap">
      {% include "realized/_summary.html" with agg=agg agg_brokers=agg_brokers %}
    </div>
  </section>

  {# ── Section 2: 期間サマリー（期間まとめ＋グラフ3枚） ─── #}
  <section id="realized-summary" class="view-hidden">
    {# 期間まとめ（ボタンでHX再描画／hidden inputsあり） #}
    {% include "realized/_summary_period.html" %}
    {# グラフ #}
    {% include "realized/_monthly_chart.html" %}
    {% include "realized/_analysis_charts.html" %}
  </section>

  {# ── Section 3: ランキング ─────────────────── #}
  <section id="realized-ranking" class="view-hidden">
    <div id="pnlRankingWrap"
         hx-get="{% url 'realized_ranking_partial' %}"
         hx-include="[name=q],[name=preset],[name=freq],[name=start],[name=end]"
         hx-trigger="load"
         hx-swap="outerHTML">
      <div style="color:#94a3b8;padding:8px 0">ランキングを読み込み中…</div>
    </div>
    <div id="pnlRankingDetailWrap"></div>
  </section>

  {# ── Section 4: 明細（テーブル） ───────────────── #}
  <section id="realized-details" class="view-hidden">
    <div class="csv-link">
      <a href="{% url 'realized_export_csv' %}?q={{ q|urlencode }}">CSVエクスポート</a>
    </div>
    <div id="pnlTableWrap"
         hx-get="{% url 'realized_table_partial' %}?q={{ q|urlencode }}"
         hx-trigger="load"
         hx-swap="outerHTML">
      {% include "realized/_table.html" with trades=trades %}
    </div>
  </section>
</div>

<script>
(function(){
  const sections = {
    top:     document.getElementById('realized-top'),
    summary: document.getElementById('realized-summary'),
    ranking: document.getElementById('realized-ranking'),
    details: document.getElementById('realized-details'),
  };

  function showOnly(key){
    Object.values(sections).forEach(s => s && s.classList.add('view-hidden'));
    const tgt = sections[key] || sections.top;
    tgt.classList.remove('view-hidden');

    // スクロール位置を上げる
    try{ tgt.scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){}

    // グラフ面は可視化直後に再レイアウト
    if (key === 'summary'){
      setTimeout(()=> window.dispatchEvent(new Event('resize')), 50);
    }

    // 初回ロード保証（HTMX領域）
    if (key === 'ranking'){
      const rk = document.getElementById('pnlRankingWrap');
      if (rk && window.htmx) htmx.trigger(rk, 'load');
    }
    if (key === 'details'){
      const tb = document.getElementById('pnlTableWrap');
      if (tb && window.htmx) htmx.trigger(tb, 'load');
    }
  }

  // 初期表示：上部サマリー
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', ()=> showOnly('top'), {once:true});
  }else{
    showOnly('top');
  }

  // bottom_tab.js からのサブメニュー操作
  window.addEventListener('bottomtab:action', (ev)=>{
    const d = ev.detail || {};
    if (d.menu !== 'realized') return;
    switch(d.action){
      case 'show_summary': showOnly('summary'); break; // 期間まとめ＋グラフ
      case 'show_ranking': showOnly('ranking'); break; // ランキングのみ
      case 'show_details': showOnly('details'); break; // 明細のみ
      default: showOnly('top'); break;                 // 上部サマリーのみ
    }
  });

  // 検索確定で明細を前面へ（任意）
  document.getElementById('q')?.addEventListener('search', ()=> showOnly('details'));
})();
</script>
{% endblock %}