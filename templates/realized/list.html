{% extends "base.html" %}
{% load static %}
{% block title %}実現損益{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/realized.css' %}?v=6">
<style>
  /* セクションの表示/非表示 */
  .is-hidden{display:none}
</style>
{% endblock %}

{% block content %}
<div class="pnl">
  <h1>実現損益</h1>

  {# ── 検索 ─────────────────────────────── #}
  <div class="fi fi-full mt-4">
    <input type="search" name="q" value="{{ q|default:'' }}" id="q"
           placeholder="ティッカー/名称で検索"
           hx-get="{% url 'realized_table_partial' %}"
           hx-target="#pnlTableWrap"
           hx-trigger="keyup changed delay:300ms, search"
           hx-include="#q"
           class="w-full">
  </div>

  {# ===================== セクション：期間サマリー（グラフ付き） ===================== #}
  <section id="pnlSectionSummary">
    {# サマリー（SSR固定・上書きしない） #}
    <div id="pnlSummaryWrap">
      {% include "realized/_summary.html" with agg=agg agg_brokers=agg_brokers %}
    </div>

    {# 期間まとめ（初回ロード時に今月・月次を取得） #}
    <div id="pnlPeriodWrap"
         hx-get="{% url 'realized_summary_period' %}?preset=THIS_MONTH&freq=month&q={{ q|urlencode }}"
         hx-trigger="load"
         hx-swap="outerHTML">
      <div style="color:#94a3b8; padding:8px 0">期間まとめを読み込み中…</div>
    </div>

    {# 月次チャート / 追加分析チャート #}
    {% include "realized/_monthly_chart.html" %}
    {% include "realized/_analysis_charts.html" %}
  </section>

  {# =========================== セクション：ランキング ============================ #}
  <section id="pnlSectionRanking" class="is-hidden">
    <div id="pnlRankingWrap"
       hx-get="{% url 'realized_ranking_partial' %}?preset=LAST_12M&freq=month"
       hx-include="[name=q],[name=preset],[name=freq],[name=start],[name=end]"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    <div style="color:#94a3b8;padding:8px 0">ランキングを読み込み中…</div>
  </div>

  {# ドリルダウンの明細を表示する場所 #}
  <div id="pnlRankingDetailWrap"></div
  </section>

  {# ============================= セクション：明細 ============================== #}
  <section id="pnlSectionDetails" class="is-hidden">
    <div id="pnlTableWrap"
         hx-get="{% url 'realized_table_partial' %}?q={{ q|urlencode }}"
         hx-trigger="revealed"
         hx-swap="outerHTML">
      {% include "realized/_table.html" with trades=trades %}
    </div>
  </section>

  {# ── CSV ─────────────────────────────────── #}
  <div class="csv-link">
    <a href="{% url 'realized_export_csv' %}?q={{ q|urlencode }}">CSVエクスポート</a>
  </div>
</div>

{# ===== セクション切替の配線（bottom_tab の bottomtab:action を受ける） ===== #}
<script>
(function(){
  const sections = {
    summary: document.getElementById('pnlSectionSummary'),
    ranking: document.getElementById('pnlSectionRanking'),
    details: document.getElementById('pnlSectionDetails'),
  };

  function ensureLoadFor(id){
    // hx-trigger="revealed" の要素は、非表示→表示で領域に入った時ロードされる
    // 念のため初回だけ明示 load も打てるよう保険を入れておく
    const box = document.getElementById(id);
    if (!box) return;
    if (!box.dataset.loaded && window.htmx) {
      // すでに画面内なら revealed で走る。画面外の場合に 'load' も試す。
      htmx.trigger(box, 'revealed');
      htmx.trigger(box, 'load');
    }
  }

  // afterSwap でロード済みマーク
  document.body.addEventListener('htmx:afterSwap', (e) => {
    if (e.target?.id === 'pnlRankingWrap') e.target.dataset.loaded = '1';
    if (e.target?.id === 'pnlTableWrap')   e.target.dataset.loaded = '1';
  });

  function show(which){
    Object.entries(sections).forEach(([k, el])=>{
      if (!el) return;
      el.classList.toggle('is-hidden', k !== which);
    });
    const target = sections[which];
    target?.scrollIntoView({behavior:'smooth', block:'start'});

    if (which === 'ranking') ensureLoadFor('pnlRankingWrap');
    if (which === 'details') ensureLoadFor('pnlTableWrap');

    try { sessionStorage.setItem('realized:view', which); } catch {}
  }

  // bottom_tab.js からのイベントを受けて切替
  window.addEventListener('bottomtab:action', (e)=>{
    if (e.detail?.menu !== 'realized') return;
    const a = e.detail.action;
    if (a === 'show_summary') return show('summary');
    if (a === 'show_ranking') return show('ranking');
    if (a === 'show_details') return show('details');
  });

  // 直前の選択状態を復元（デフォは summary）
  const initial = (()=>{
    try { return sessionStorage.getItem('realized:view') || 'summary'; } catch { return 'summary'; }
  })();
  show(initial);
})();
</script>
{% endblock %}