{% extends "base.html" %}
{% load static %}
{% block title %}実現損益{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/realized.css' %}?v=9">
<style>
  .view-hidden{display:none!important}
  section{margin-top:12px}
</style>
{% endblock %}

{% block content %}
<div class="pnl">
  <h1>実現損益</h1>

  <!-- 検索 -->
  <div class="fi fi-full mt-4">
    <input type="search" name="q" value="{{ q|default:'' }}" id="q"
           placeholder="ティッカー/名称で検索"
           hx-get="{% url 'realized_table_partial' %}"
           hx-target="#pnlTableWrap"
           hx-trigger="keyup changed delay:300ms, search"
           hx-include="#q"
           class="w-full">
  </div>

  <!-- Section 1: 上部サマリー（証券会社別まで） -->
  <section id="realized-top">
    <div id="pnlSummaryWrap">
      {% include "realized/_summary.html" with agg=agg agg_brokers=agg_brokers %}
    </div>
  </section>

  <!-- Section 2: 期間サマリー（グラフだけ） -->
  <section id="realized-summary" class="view-hidden">
    {% include "realized/_monthly_chart.html" %}
    {% include "realized/_analysis_charts.html" %}
  </section>

  <!-- Section 3: ランキング（従来どおり） -->
  <section id="realized-ranking" class="view-hidden">
    <div id="pnlRankingWrap"
         hx-get="{% url 'realized_ranking_partial' %}"
         hx-include="[name=q],[name=preset],[name=freq],[name=start],[name=end]"
         hx-trigger="load"
         hx-swap="outerHTML">
      <div style="color:#94a3b8;padding:8px 0">ランキングを読み込み中…</div>
    </div>
    <div id="pnlRankingDetailWrap"></div>
  </section>

  <!-- Section 4: 明細（従来どおり） -->
  <section id="realized-details" class="view-hidden">
    <div class="csv-link">
      <a href="{% url 'realized_export_csv' %}?q={{ q|urlencode }}">CSVエクスポート</a>
    </div>
    <div id="pnlTableWrap"
         hx-get="{% url 'realized_table_partial' %}?q={{ q|urlencode }}"
         hx-trigger="load"
         hx-swap="outerHTML">
      {% include "realized/_table.html" with trades=trades %}
    </div>
  </section>
</div>

<script>
(function(){
  const sections = {
    top:     document.getElementById('realized-top'),
    summary: document.getElementById('realized-summary'),
    ranking: document.getElementById('realized-ranking'),
    details: document.getElementById('realized-details'),
  };

  function showOnly(key){
    Object.values(sections).forEach(s => s && s.classList.add('view-hidden'));
    const tgt = sections[key] || sections.top;
    tgt.classList.remove('view-hidden');
    // 見切れ防止に上へ
    try{ tgt.scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){}
    // グラフ面は可視化直後に再レイアウトさせる
    if (key === 'summary'){
      setTimeout(()=> window.dispatchEvent(new Event('resize')), 50);
    }
    // 初回ロード保証（HTMX領域）
    if (key === 'ranking'){
      const rk = document.getElementById('pnlRankingWrap');
      if (rk && window.htmx) htmx.trigger(rk, 'load');
    }
    if (key === 'details'){
      const tb = document.getElementById('pnlTableWrap');
      if (tb && window.htmx) htmx.trigger(tb, 'load');
    }
  }

  // 初期：上部サマリーのみ
  document.addEventListener('DOMContentLoaded', ()=> showOnly('top'));

  // bottom_tab.js が投げるイベントを受信
  window.addEventListener('bottomtab:action', (ev)=>{
    const d = ev.detail || {};
    if (d.menu !== 'realized') return;
    switch(d.action){
      case 'show_summary': showOnly('summary'); break;  // ← グラフだけ
      case 'show_ranking': showOnly('ranking'); break;
      case 'show_details': showOnly('details'); break;
      default: showOnly('top'); break;                  // ← 指標カード～証券会社別
    }
  });

  // 検索→明細を前面に出す（任意）
  const qEl = document.getElementById('q');
  qEl?.addEventListener('search', ()=> showOnly('details'));
})();
</script>
{% endblock %}