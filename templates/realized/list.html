{# templates/realized/list.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}実現損益{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/realized.css' %}?v=6">
{% endblock %}

{% block content %}
<div class="pnl">
  <h1>実現損益</h1>

  {# ── 検索 ─────────────────────────────── #}
  <div class="fi fi-full mt-4">
    <input type="search" name="q" value="{{ q|default:'' }}" id="q"
           placeholder="ティッカー/名称で検索"
           hx-get="{% url 'realized_table_partial' %}"
           hx-target="#pnlTableWrap"
           hx-trigger="keyup changed delay:300ms, search"
           hx-include="#q"
           class="w-full">
  </div>

  {# ── サマリー（SSR固定・上書きしない） ─────────────── #}
  <div id="pnlSummaryWrap">
    {% include "realized/_summary.html" with agg=agg agg_brokers=agg_brokers %}
  </div>
  
  {# --- ランキング（HTMXでロード） --- #}
<div id="pnlRankingWrap"
     hx-get="{% url 'realized_ranking_partial' %}?q={{ q|urlencode }}"
     hx-trigger="load"
     hx-swap="outerHTML">
  <div style="color:#94a3b8;padding:8px 0">ランキングを読み込み中…</div>
</div>

  {# --- ランキング（期間連動） --- #}
<div id="pnlRankingWrap"
     hx-get="{% url 'realized_ranking_partial' %}"
     hx-include="[name=q],[name=preset],[name=freq],[name=start],[name=end]"
     hx-trigger="load, pnl:refresh from:body"
     hx-swap="outerHTML">
  <div style="color:#94a3b8;padding:8px 0">ランキングを読み込み中…</div>
</div>

{# ドリルダウンの明細を表示する場所 #}
<div id="pnlRankingDetailWrap"></div>

  {# ── チャート ───────────────────────────── #}
  {% include "realized/_monthly_chart.html" %}
  {% include "realized/_analysis_charts.html" %}

  {# ── CSV ─────────────────────────────────── #}
  <div class="csv-link">
    <a href="{% url 'realized_export_csv' %}?q={{ q|urlencode }}">CSVエクスポート</a>
  </div>

  {# ── テーブル ───────────────────────────── #}
  <div id="pnlTableWrap"
       hx-get="{% url 'realized_table_partial' %}?q={{ q|urlencode }}"
       hx-trigger="load"
       hx-swap="outerHTML">
    {% include "realized/_table.html" with trades=trades %}
  </div>
</div>
{% endblock %}