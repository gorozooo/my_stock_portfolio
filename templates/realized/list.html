{% extends "base.html" %}
{% load static %}
{% block title %}実現損益{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/realized.css' %}?v=6">
<style>
  .is-hidden{display:none}
  /* スクロール先の余白（固定ヘッダ等があれば調整） */
  .anchor { scroll-margin-top: 16px; }
</style>
{% endblock %}

{% block content %}
<div class="pnl">
  <h1 id="pnlTopAnchor" class="anchor">実現損益</h1>

  {# ── 検索 ─────────────────────────────── #}
  <div class="fi fi-full mt-4">
    <input type="search" name="q" value="{{ q|default:'' }}" id="q"
           placeholder="ティッカー/名称で検索"
           hx-get="{% url 'realized_table_partial' %}"
           hx-target="#pnlTableWrap"
           hx-trigger="keyup changed delay:300ms, search"
           hx-include="#q"
           class="w-full">
  </div>

  {# ===================== セクション：期間サマリー（グラフ付き） ===================== #}
  <section id="pnlSectionSummary">
    {# サマリー（SSR固定・上書きしない） #}
    <div id="pnlSummaryWrap">
      {% include "realized/_summary.html" with agg=agg agg_brokers=agg_brokers %}
    </div>

    {# 期間まとめ #}
    <div id="pnlPeriodWrap"
         hx-get="{% url 'realized_summary_period' %}?preset=THIS_MONTH&freq=month&q={{ q|urlencode }}"
         hx-trigger="load"
         hx-swap="outerHTML">
      <div style="color:#94a3b8; padding:8px 0">期間まとめを読み込み中…</div>
    </div>

    {# ←「期間まとめより下」へ飛ぶためのアンカー #}
    <div id="pnlChartsAnchor" class="anchor"></div>

    {# 月次チャート / 追加分析チャート #}
    {% include "realized/_monthly_chart.html" %}
    {% include "realized/_analysis_charts.html" %}
  </section>

  {# =========================== セクション：ランキング ============================ #}
  <section id="pnlSectionRanking" class="is-hidden">
    <div id="pnlRankingWrap"
       hx-get="{% url 'realized_ranking_partial' %}?preset=LAST_12M&freq=month"
       hx-include="[name=q],[name=preset],[name=freq],[name=start],[name=end]"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    <div style="color:#94a3b8;padding:8px 0">ランキングを読み込み中…</div>
  </div>

  {# ドリルダウンの明細を表示する場所 #}
  <div id="pnlRankingDetailWrap"></div>
  </section>

  {# ============================= セクション：明細 ============================== #}
  <section id="pnlSectionDetails" class="is-hidden">
    <div id="pnlTableWrap"
         hx-get="{% url 'realized_table_partial' %}?q={{ q|urlencode }}"
         hx-trigger="revealed"
         hx-swap="outerHTML">
      {% include "realized/_table.html" with trades=trades %}
    </div>
  </section>

  {# ── CSV ─────────────────────────────────── #}
  <div class="csv-link">
    <a href="{% url 'realized_export_csv' %}?q={{ q|urlencode }}">CSVエクスポート</a>
  </div>
</div>

{# ===== セクション切替 & スクロール制御 ===== #}
<script>
(function(){
  const sections = {
    summary: document.getElementById('pnlSectionSummary'),
    ranking: document.getElementById('pnlSectionRanking'),
    details: document.getElementById('pnlSectionDetails'),
  };
  const elTop    = document.getElementById('pnlTopAnchor');
  const elCharts = document.getElementById('pnlChartsAnchor');

  function ensureLoadFor(id){
    const box = document.getElementById(id);
    if (!box) return;
    if (!box.dataset.loaded && window.htmx) {
      htmx.trigger(box, 'revealed');
      htmx.trigger(box, 'load');
    }
  }
  document.body.addEventListener('htmx:afterSwap', (e) => {
    if (e.target?.id === 'pnlRankingWrap') e.target.dataset.loaded = '1';
    if (e.target?.id === 'pnlTableWrap')   e.target.dataset.loaded = '1';
  });

  function show(which){
    Object.entries(sections).forEach(([k, el])=>{
      if (!el) return;
      el.classList.toggle('is-hidden', k !== which);
    });
    try { sessionStorage.setItem('realized:view', which); } catch {}
  }

  // --- bottom_tab からのイベントを受ける ---
  window.addEventListener('bottomtab:action', (e)=>{
    if (e.detail?.menu !== 'realized') return;
    const a = e.detail.action;
    if (a === 'show_summary'){
      show('summary');
      // 「期間まとめより下」を表示
      elCharts?.scrollIntoView({behavior:'smooth', block:'start'});
    }
    if (a === 'show_ranking'){
      show('ranking'); ensureLoadFor('pnlRankingWrap');
      document.getElementById('pnlRankingWrap')?.scrollIntoView({behavior:'smooth', block:'start'});
    }
    if (a === 'show_details'){
      show('details'); ensureLoadFor('pnlTableWrap');
      document.getElementById('pnlTableWrap')?.scrollIntoView({behavior:'smooth', block:'start'});
    }
  });

  // アクティブな「実現損益」タブをタップした時 → 上部（証券会社別より上）へ
  window.addEventListener('bottomtab:jump', (e)=>{
    if (e.detail?.menu !== 'realized') return;
    elTop?.scrollIntoView({behavior:'smooth', block:'start'});
  });

  // ページ初期表示は前回の表示状態を再現（既定は summary）
  const initial = (()=>{
    try { return sessionStorage.getItem('realized:view') || 'summary'; } catch { return 'summary'; }
  })();
  show(initial);
})();
</script>
{% endblock %}