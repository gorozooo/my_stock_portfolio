{# templates/realized/list.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}実現損益{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/realized.css' %}?v=3">
{% endblock %}

{% block content %}
<div class="pnl">
  <h1>実現損益</h1>

  {# ── 入力フォーム ───────────────────────────────────────────── #}
  <form id="pnlForm" class="formgrid"
        hx-post="{% url 'realized_create' %}"
        hx-target="#pnlTableWrap"
        hx-swap="outerHTML"
        hx-include="#q"
        hx-on::after-request="if (event.detail.successful) { document.dispatchEvent(new CustomEvent('pnl:scheduleRefresh')); }"
        autocomplete="off" novalidate>
    {% csrf_token %}

    <div class="fi">
      <label>日付</label>
      {# ※ views は name='date' を読むので合わせる #}
      <input type="date" name="date">
    </div>

    <div class="fi">
      <label>ティッカー</label>
      <input type="text" name="ticker" placeholder="例: 7203 / AAPL"
             inputmode="latin" autocapitalize="characters">
    </div>

    <div class="fi">
      <label>Side</label>
      <select name="side">
        <option>SELL</option>
        <option>BUY</option>
      </select>
    </div>

    <div class="fi">
      <label>数量</label>
      <input type="number" name="qty" inputmode="numeric" placeholder="数量">
    </div>

    <div class="fi">
      <label>価格</label>
      <input type="number" name="price" inputmode="decimal" step="0.01" placeholder="価格">
    </div>

    <div class="fi">
      <label>手数料</label>
      <input type="number" name="fee" inputmode="decimal" step="0.01" placeholder="手数料">
    </div>

    <div class="fi">
      <label>税</label>
      <input type="number" name="tax" inputmode="decimal" step="0.01" placeholder="税">
    </div>

    <div class="fi">
      <label>メモ</label>
      <input type="text" name="memo" placeholder="任意メモ">
    </div>

    <div class="fi fi-full">
      <button type="submit" class="btn-primary">追加</button>
    </div>

    {# 検索（テーブルのみ差し替え・入力のたび） #}
    <div class="fi fi-full">
      <input type="search" name="q" value="{{ q|default:'' }}" id="q"
             placeholder="ティッカーで検索"
             hx-get="{% url 'realized_table_partial' %}"
             hx-target="#pnlTableWrap"
             hx-trigger="keyup changed delay:300ms, search"
             hx-include="#q">
    </div>
  </form>

  {# ── サマリー（id 固定） ─────────────────────────────── #}
  <div id="pnlSummaryWrap"
       hx-get="{% url 'realized_summary_partial' %}?q={{ q|urlencode }}"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    {% include "realized/_summary.html" with agg=agg %}
  </div>

  {# ── CSV ───────────────────────────────────────────────────── #}
  <div class="csv-link">
    <a href="{% url 'realized_export_csv' %}?q={{ q|urlencode }}">CSVエクスポート</a>
  </div>

  {# ── テーブル（作成・削除後に差し替えるターゲット） ─────────────── #}
  <div id="pnlTableWrap"
       hx-get="{% url 'realized_table_partial' %}?q={{ q|urlencode }}"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    {% include "realized/_table.html" with trades=trades %}
  </div>
</div>

{# ── 3秒デバウンスでサマリー/テーブル再計算（削除・追加後） ───────────── #}
<script>
  (function () {
    var timer = null;
    var DEBOUNCE_MS = 3000;

    // 削除や追加完了後に呼ばれる
    function schedule() {
      if (timer) clearTimeout(timer);
      timer = setTimeout(function () {
        timer = null;
        // サマリーだけ再取得
        htmx.ajax('GET', "{% url 'realized_summary_partial' %}?q={{ q|urlencode }}", {
          target: '#pnlSummaryWrap',
          swap: 'outerHTML'
        });
      }, DEBOUNCE_MS);
    }

    // カスタムイベント → どこからでも呼べる
    document.addEventListener('pnl:scheduleRefresh', schedule);

    window.addEventListener('beforeunload', function () {
      if (timer) clearTimeout(timer);
    });
  })();
</script>
{% endblock %}