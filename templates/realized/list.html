{# templates/realized/list.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}実現損益{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/realized.css' %}?v=6">
{% endblock %}

{% block content %}
<div class="pnl">
  <h1>実現損益</h1>

  {# ── 検索だけ残す ─────────────────────────────── #}
  <div class="fi fi-full mt-4">
    <input type="search" name="q" value="{{ q|default:'' }}" id="q"
           placeholder="ティッカー/名称で検索"
           hx-get="{% url 'realized_table_partial' %}"
           hx-target="#pnlTableWrap"
           hx-trigger="keyup changed delay:300ms, search"
           hx-include="#q"
           class="w-full">
  </div>

  {# ── サマリー ───────────────────────────────── #}
  <div id="pnlSummaryWrap"
       hx-get="{% url 'realized_summary_partial' %}?q={{ q|urlencode }}"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    {% include "realized/_summary.html" with agg=agg %}
  </div>

  {# すでにあるサマリー #}
  <div id="pnlSummaryWrap"
       hx-get="{% url 'realized_summary_partial' %}?q={{ q|urlencode }}"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    {% include "realized/_summary.html" with agg=agg agg_brokers=agg_brokers %}
  </div>
  
  {# ★ 期間まとめ（初回ロード時に今月・月次を取得） #}
  <div id="pnlPeriodWrap"
       hx-get="{% url 'realized_summary_period' %}?preset=THIS_MONTH&freq=month&q={{ q|urlencode }}"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    {# 初期フォールバック（JS無効時） #}
    <div style="color:#94a3b8; padding:8px 0">期間まとめを読み込み中…</div>
  </div>

  {# ── CSV ────────────────────────────────────── #}
  <div class="csv-link">
    <a href="{% url 'realized_export_csv' %}?q={{ q|urlencode }}">CSVエクスポート</a>
  </div>

  {# ── テーブル ──────────────────────────────── #}
  <div id="pnlTableWrap"
       hx-get="{% url 'realized_table_partial' %}?q={{ q|urlencode }}"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    {% include "realized/_table.html" with trades=trades %}
  </div>
</div>
{% endblock %}