{# templates/realized/list.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}å®Ÿç¾æç›Š{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/realized.css' %}?v=6">
{% endblock %}

{% block content %}
<div class="pnl">
  <h1>å®Ÿç¾æç›Š</h1>

  {# â”€â”€ æ¤œç´¢ã ã‘æ®‹ã™ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div class="fi fi-full mt-4">
    <input type="search" name="q" value="{{ q|default:'' }}" id="q"
           placeholder="ãƒ†ã‚£ãƒƒã‚«ãƒ¼/åç§°ã§æ¤œç´¢"
           hx-get="{% url 'realized_table_partial' %}"
           hx-target="#pnlTableWrap"
           hx-trigger="keyup changed delay:300ms, search"
           hx-include="#q"
           class="w-full">
  </div>

  {# â”€â”€ ã‚µãƒãƒªãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div id="pnlSummaryWrap"
       hx-get="{% url 'realized_summary_partial' %}?q={{ q|urlencode }}"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    {% include "realized/_summary.html" with agg=agg %}
  </div>

  {# ã™ã§ã«ã‚ã‚‹ã‚µãƒãƒªãƒ¼ #}
  <div id="pnlSummaryWrap"
       hx-get="{% url 'realized_summary_partial' %}?q={{ q|urlencode }}"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    {% include "realized/_summary.html" with agg=agg agg_brokers=agg_brokers %}
  </div>
  
  {# â˜… æœŸé–“ã¾ã¨ã‚ï¼ˆåˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«ä»Šæœˆãƒ»æœˆæ¬¡ã‚’å–å¾—ï¼‰ #}
  <div id="pnlPeriodWrap"
       hx-get="{% url 'realized_summary_period' %}?preset=THIS_MONTH&freq=month&q={{ q|urlencode }}"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    {# åˆæœŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆJSç„¡åŠ¹æ™‚ï¼‰ #}
    <div style="color:#94a3b8; padding:8px 0">æœŸé–“ã¾ã¨ã‚ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  </div>

  <!-- æœˆæ¬¡ãƒãƒ£ãƒ¼ãƒˆï¼ˆPnL & ç¾é‡‘ãƒ•ãƒ­ãƒ¼ï¼‰ -->
  <div class="mt-6 rounded-2xl bg-white/5 p-3">
    <div class="flex items-center justify-between mb-2">
      <div class="text-sm text-slate-300">æœˆæ¬¡ã‚µãƒãƒªãƒ¼</div>
      <div class="text-xs text-slate-400">ğŸ“ˆ PnLï¼ˆæŠ•è³‡å®¶æç›Šï¼‰ / ğŸ’° ç¾é‡‘ãƒ•ãƒ­ãƒ¼</div>
    </div>
    <div style="height:240px">
      <canvas id="pnlChart"></canvas>
    </div>
  </div>
  
  <!-- Chart.js CDNï¼ˆé‡è¤‡èª­ã¿è¾¼ã¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãŒå‹æ‰‹ã«ã¾ã¨ã‚ã¾ã™ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  (function () {
    const el = document.getElementById('pnlChart');
    if (!el) return;
  
    async function draw() {
      try {
        // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ (#q) ã®å€¤ã‚’ä½¿ã£ã¦å†æç”»å¯èƒ½ã«
        const qEl = document.querySelector('#q');
        const q   = qEl ? encodeURIComponent(qEl.value || '') : '';
        const res = await fetch("{% url 'realized_chart_monthly' %}?q=" + q, {credentials: 'same-origin'});
        const data = await res.json();
  
        // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆãŒã‚ã‚Œã°ç ´æ£„
        if (window._pnlChart) {
          window._pnlChart.destroy();
          window._pnlChart = null;
        }
  
        const ctx = el.getContext('2d');
        window._pnlChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [
              {
                label: 'ğŸ“ˆPnL',
                data: data.pnl,
                borderWidth: 0,
                backgroundColor: 'rgba(16, 185, 129, 0.65)',   // emerald-ish
              },
              {
                label: 'ğŸ’°ç¾é‡‘',
                data: data.cash,
                borderWidth: 0,
                backgroundColor: 'rgba(59, 130, 246, 0.55)',   // blue-ish
              },
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {mode: 'index', intersect: false},
            plugins: {
              legend: {labels: {color: '#e5e7eb'}},
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const v = ctx.parsed.y ?? 0;
                    return `${ctx.dataset.label}: Â¥` + v.toLocaleString();
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {color: '#cbd5e1'},
                grid: {color: 'rgba(148,163,184,0.12)'}
              },
              y: {
                ticks: {
                  color: '#cbd5e1',
                  callback: (v) => 'Â¥' + Number(v).toLocaleString()
                },
                grid: {color: 'rgba(148,163,184,0.12)'}
              }
            }
          }
        });
      } catch (e) {
        console.error(e);
      }
    }
  
    // åˆå›æç”»
    document.addEventListener('DOMContentLoaded', draw);
  
    // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã§å†æç”»ï¼ˆEnter/blur/changeï¼‰
    const qEl = document.querySelector('#q');
    if (qEl) {
      ['change', 'blur', 'keydown'].forEach(ev => {
        qEl.addEventListener(ev, (e) => {
          if (ev !== 'keydown' || e.key === 'Enter') draw();
        });
      });
    }
  
    // HTMX ã§ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå·®ã—æ›¿ã‚ã£ãŸå ´åˆã‚‚å†æç”»
    document.body.addEventListener('htmx:afterSwap', function (e) {
      if (e.target && (e.target.id === 'pnlTableWrap' || e.target.id === 'pnlSummaryWrap')) {
        draw();
      }
    });
  })();
  </script>

  {# â”€â”€ CSV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div class="csv-link">
    <a href="{% url 'realized_export_csv' %}?q={{ q|urlencode }}">CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</a>
  </div>

  {# â”€â”€ ãƒ†ãƒ¼ãƒ–ãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div id="pnlTableWrap"
       hx-get="{% url 'realized_table_partial' %}?q={{ q|urlencode }}"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    {% include "realized/_table.html" with trades=trades %}
  </div>
</div>
{% endblock %}