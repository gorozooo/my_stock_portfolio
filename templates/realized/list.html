{# templates/realized/list.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}実現損益{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/realized.css' %}?v=7">
{% endblock %}

{% block content %}
<div class="pnl">
  <h1>実現損益</h1>

  {# ── 入力フォーム ──────────────────────────────────────────────── #}
  <form id="pnlForm" class="formgrid"
        hx-post="{% url 'realized_create' %}"
        hx-target="#pnlTableWrap"
        hx-swap="outerHTML"
        hx-include="#q"
        hx-on::after-request="if (event.detail.successful) { htmx.trigger(document.body, 'pnl:refresh'); }"
        autocomplete="off" novalidate>
    {% csrf_token %}

    <div class="fi">
      <label>日付</label>
      <input type="date" name="date">
    </div>

    <div class="fi">
      <label>ティッカー</label>
      <input type="text" name="ticker" placeholder="例: 7203 / AAPL"
             inputmode="latin" autocapitalize="characters">
    </div>

    {# ★ 銘柄名追加 #}
    <div class="fi">
      <label>銘柄名</label>
      <input type="text" name="name" placeholder="例: トヨタ / Apple">
    </div>

    <div class="fi">
      <label>Side</label>
      <select name="side">
        <option>SELL</option>
        <option>BUY</option>
      </select>
    </div>

    <div class="fi">
      <label>数量</label>
      <input type="number" name="qty" inputmode="numeric" placeholder="数量">
    </div>

    <div class="fi">
      <label>約定単価</label>
      <input type="number" name="price" inputmode="decimal" step="0.01" placeholder="価格">
    </div>

    <div class="fi">
      <label>手数料</label>
      <input type="number" name="fee" inputmode="decimal" step="0.01" placeholder="手数料">
    </div>

    {# ★ 受渡金額（実損キャッシュフロー） #}
    <div class="fi">
      <label>受渡金額（実損）</label>
      <input type="number" name="cashflow" inputmode="decimal" step="0.01" placeholder="SELLは＋／BUYは−">
      <small class="text-xs text-slate-400 block mt-1">
        入力すると手数料を逆算します。未入力なら手数料から自動計算します。
      </small>
    </div>

    {# ★ 証券会社 #}
    <div class="fi">
      <label>証券会社</label>
      <select name="broker">
        <option value="RAKUTEN">楽天証券</option>
        <option value="SBI">SBI証券</option>
        <option value="MATSUI">松井証券</option>
        <option value="OTHER" selected>その他</option>
      </select>
    </div>
    
    <div class="fi">
      <label>口座区分</label>
      <select name="account">
        <option value="SPEC">特定</option>
        <option value="MARGIN">信用</option>
        <option value="NISA">NISA</option>
      </select>
    </div>
    
    <div class="fi fi-full">
      <label>メモ</label>
      <input type="text" name="memo" placeholder="任意メモ">
    </div>

    <div class="fi fi-full">
      <button type="submit" class="btn-primary">追加</button>
    </div>

    {# 検索（テーブルのみ差し替え） #}
    <div class="fi fi-full">
      <input type="search" name="q" value="{{ q|default:'' }}" id="q"
             placeholder="ティッカーや銘柄名で検索"
             hx-get="{% url 'realized_table_partial' %}"
             hx-target="#pnlTableWrap"
             hx-trigger="keyup changed delay:300ms, search"
             hx-include="#q">
    </div>
  </form>

  {# ── サマリー ──────────────────────────────────────────────── #}
  <div id="pnlSummaryWrap"
       hx-get="{% url 'realized_summary_partial' %}?q={{ q|urlencode }}"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    {% include "realized/_summary.html" with agg=agg %}
  </div>

  {# ── CSV ───────────────────────────────────────────────────── #}
  <div class="csv-link">
    <a href="{% url 'realized_export_csv' %}?q={{ q|urlencode }}">CSVエクスポート</a>
  </div>

  {# ── テーブル ──────────────────────────────────────────────── #}
  <div id="pnlTableWrap"
       hx-get="{% url 'realized_table_partial' %}?q={{ q|urlencode }}"
       hx-trigger="load, pnl:refresh from:body"
       hx-swap="outerHTML">
    {% include "realized/_table.html" with trades=trades %}
  </div>
</div>
{% endblock %}