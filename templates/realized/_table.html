{% load humanize %}

<style>
  /* ===== å®Ÿç¾æç›Šãƒ†ãƒ¼ãƒ–ãƒ«å°‚ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
  .realized-pnl-container {
    width: 100%;
  }

  .realized-pnl-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  /* ===== Sticky ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆé€éï¼‹blurï¼‹å½±ï¼‹ç¸®å°ã‚¢ãƒ‹ãƒ¡ï¼‰ ===== */
  .realized-pnl-thead {
    --header-scale: 1;
    transform-origin: top;
    transform: scaleY(var(--header-scale));
    transition: transform 0.15s ease-out;
  }

  .realized-pnl-thead th {
    position: sticky;
    position: -webkit-sticky;
    top: 0;
    z-index: 30;

    background: rgba(15, 23, 42, 0.75);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);

    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
  }

  /* ===== è¡Œãƒ›ãƒãƒ¼ / ã‚¿ãƒƒãƒ—æ™‚ã® iOS é¢¨ãƒã‚¤ãƒ©ã‚¤ãƒˆ ===== */
  .realized-row {
    transition:
      background-color 0.12s ease-out,
      transform 0.06s ease-out;
  }

  @media (hover: hover) and (pointer: fine) {
    .realized-row:hover {
      background: rgba(148, 163, 184, 0.15);
    }
  }

  .realized-row.is-tapping {
    background: rgba(129, 140, 248, 0.35);
    transform: translateY(1px);
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const thead = document.querySelector(".realized-pnl-thead");
    if (thead) {
      const onScroll = () => {
        const y = window.scrollY || document.documentElement.scrollTop || 0;
        const minScale = 0.85;
        const maxScroll = 20;
        const scale = Math.max(minScale, 1 - (y / maxScroll) * (1 - minScale));
        thead.style.setProperty("--header-scale", scale.toString());
      };
      onScroll();
      window.addEventListener("scroll", onScroll, { passive: true });
    }

    const clearTap = () => {
      document
        .querySelectorAll(".realized-row.is-tapping")
        .forEach((row) => row.classList.remove("is-tapping"));
    };

    document.addEventListener(
      "touchstart",
      (e) => {
        const row = e.target.closest(".realized-row");
        if (!row) return;
        clearTap();
        row.classList.add("is-tapping");
      },
      { passive: true }
    );

    document.addEventListener("touchend", clearTap, { passive: true });
    document.addEventListener("touchcancel", clearTap, { passive: true });
  });
</script>

<div class="realized-pnl-container">
  <table class="realized-pnl-table">
    <thead class="realized-pnl-thead bg-white/5 text-slate-300 text-xs">
      <tr>
        <th class="px-3 py-2 text-left">æ—¥ä»˜</th>
        <th class="px-3 py-2 text-left">éŠ˜æŸ„</th>
        <th class="px-3 py-2 text-center">Side</th>
        <th class="px-3 py-2 text-right">æ•°é‡</th>
        <th class="px-3 py-2 text-right">ç´„å®šå˜ä¾¡ / å–å¾—å˜ä¾¡</th>
        <th class="px-3 py-2 text-right">ğŸ’°å®Ÿæ(ç¾é‡‘)</th>
        <th class="px-3 py-2 text-right">ğŸ“ˆå®Ÿç¾æç›Š</th>
        <th class="px-3 py-2 text-right">æ‰‹æ•°æ–™</th>
        <th class="px-3 py-2 text-right">æ“ä½œ</th>
      </tr>
    </thead>

    <tbody class="text-[15px]">
      {% for t in trades %}
        <tr class="realized-row border-b border-white/10">

          <td class="px-3 py-2 text-slate-200">
            <div>{{ t.trade_at|date:"Y-m-d" }}</div>
            {% if t.opened_at or t.hold_days %}
              <div class="text-[11px] text-slate-400">
                {% if t.opened_at %}ä¿æœ‰é–‹å§‹ {{ t.opened_at|date:"Y-m-d" }}{% endif %}
                {% if t.hold_days %}ï¼ˆ{{ t.hold_days|intcomma }}æ—¥ï¼‰{% endif %}
              </div>
            {% endif %}
          </td>

          <td class="px-3 py-2">
            <div class="text-xs text-slate-400">{{ t.ticker }}</div>
            <div class="font-semibold text-slate-200">{{ t.name }}</div>
          </td>

          <td class="px-3 py-2 text-center">
            <span class="px-2 py-0.5 rounded text-xs
              {% if t.side == 'SELL' %}bg-rose-500/20 text-rose-200
              {% else %}bg-emerald-500/20 text-emerald-200{% endif %}">
              {{ t.side }}
            </span>
          </td>

          <td class="px-3 py-2 text-right font-mono">
            {{ t.qty|intcomma }}
          </td>

          <td class="px-3 py-2 text-right font-mono">
            Â¥{{ t.price|floatformat:2|intcomma }}
            {% if t.basis %}
              <div class="text-[11px] opacity-70">
                å–å¾—: Â¥{{ t.basis|floatformat:2|intcomma }}
              </div>
            {% endif %}
          </td>

          {# ğŸ’° å®Ÿæï¼ˆç¾é‡‘ï¼‰ #}
          <td class="px-3 py-2 text-right font-mono">
            {% with v=t.cashflow_calc_jpy %}
              <span class="{% if v >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </span>
            {% endwith %}
          </td>

          {# ğŸ“ˆ å®Ÿç¾æç›Š #}
          <td class="px-3 py-2 text-right font-mono">
            {% with v=t.pnl_jpy_calc %}
              <span class="{% if v >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </span>
            {% endwith %}
          </td>

          <td class="px-3 py-2 text-right font-mono">
            Â¥{{ t.fee|floatformat:0|intcomma }}
          </td>

          <td class="px-3 py-2 text-right">
            <form
              hx-post="{% url 'realized_delete' t.id %}"
              hx-swap="none"
              hx-confirm="å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ">
              {% csrf_token %}
              <button class="text-slate-300 hover:text-rose-300">å‰Šé™¤</button>
            </form>
          </td>

        </tr>
      {% empty %}
        <tr>
          <td colspan="9" class="px-3 py-6 text-slate-400">ãƒ‡ãƒ¼ã‚¿ãªã—</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>