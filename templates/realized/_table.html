{# templates/realized/_table.html #}
{% load humanize %}
<table class="w-full border-separate border-spacing-0 rounded-2xl overflow-hidden">
  <colgroup>
    <col class="w-28">  {# æ—¥ä»˜ #}
    <col class="w-48">  {# éŠ˜æŸ„ #}
    <col class="w-20">  {# Side #}
    <col class="w-24">  {# æ•°é‡ #}
    <col class="w-28">  {# ç´„å®šå˜ä¾¡ #}
    <col class="w-28">  {# å®Ÿæï¼ˆç¾é‡‘ï¼‰ #}
    <col class="w-28">  {# å®Ÿç¾æç›Šï¼ˆPnLï¼‰ #}
    <col class="w-28">  {# æ‰‹æ•°æ–™ #}
    <col class="w-20">  {# æ“ä½œ #}
  </colgroup>

  <thead class="bg-white/5 text-slate-300 text-sm">
    <tr>
      <th class="px-3 py-2 text-left whitespace-nowrap">æ—¥ä»˜</th>
      <th class="px-3 py-2 text-left">éŠ˜æŸ„</th>
      <th class="px-3 py-2 text-center whitespace-nowrap">Side</th>
      <th class="px-3 py-2 text-right th-nowrap">æ•°é‡</th>
      <th class="px-3 py-2 text-right th-nowrap td-narrow">ç´„å®šå˜ä¾¡</th>
      <th class="px-3 py-2 text-right th-nowrap td-narrow">ğŸ’° å®Ÿæ</th>
      <th class="px-3 py-2 text-right th-nowrap td-narrow">ğŸ“ˆ å®Ÿç¾æç›Š</th>
      <th class="px-3 py-2 text-right th-nowrap">æ‰‹æ•°æ–™</th>
      <th class="px-3 py-2 text-right whitespace-nowrap">æ“ä½œ</th>
    </tr>
  </thead>

  <tbody class="text-[15px]">
    {% for t in trades %}
      <tr class="border-b border-white/10">
        {# æ—¥ä»˜ #}
        <td class="px-3 py-2 whitespace-nowrap text-slate-200">
          {{ t.trade_at|date:"Y-m-d" }}
        </td>

        {# éŠ˜æŸ„ï¼šä¸Š=ã‚³ãƒ¼ãƒ‰ / ä¸‹=åç§° + ãƒãƒƒã‚¸ï¼ˆè¨¼åˆ¸ä¼šç¤¾ãƒ»å£åº§åŒºåˆ†ï¼‰ #}
        <td class="px-3 py-2">
          <div class="leading-tight">
            <div class="text-slate-400 text-xs tracking-wide whitespace-nowrap mono tabnums">{{ t.ticker }}</div>
            <div class="text-slate-200 font-medium truncate">{{ t.name|default:"" }}</div>
            <div class="mt-0.5 flex gap-1 text-[11px]">
              {% with b=t.broker|default:"" a=t.account|default:"" %}
                {% if b %}
                  <span class="px-1.5 py-0.5 rounded bg-white/10 text-slate-300 whitespace-nowrap">
                    {% if b == "RAKUTEN" %}æ¥½å¤©{% elif b == "SBI" %}SBI{% elif b == "MATSUI" %}æ¾äº•{% else %}ãã®ä»–{% endif %}
                  </span>
                {% endif %}
                {% if a %}
                  <span class="px-1.5 py-0.5 rounded bg-white/10 text-slate-300 whitespace-nowrap">
                    {% if a == "SPEC" %}ç‰¹å®š{% elif a == "MARGIN" %}ä¿¡ç”¨{% elif a == "NISA" %}NISA{% else %}â€”{% endif %}
                  </span>
                {% endif %}
              {% endwith %}
            </div>
          </div>
        </td>

        {# Side #}
        <td class="px-3 py-2 text-center whitespace-nowrap">
          <span class="inline-block rounded-md px-2 py-0.5 text-xs
                       {% if t.side == 'SELL' %}bg-rose-500/15 text-rose-200 ring-1 ring-rose-400/25
                       {% else %}bg-emerald-500/15 text-emerald-200 ring-1 ring-emerald-400/25{% endif %}">
            {{ t.side }}
          </span>
        </td>

        {# æ•°é‡ #}
        <td class="px-3 py-2 text-right nowrap mono tabnums">{{ t.qty|intcomma }}</td>

        {# ç´„å®šå˜ä¾¡ï¼ˆæŠ˜ã‚Šè¿”ã—ç¦æ­¢ï¼‰ #}
        <td class="px-3 py-2 text-right nowrap mono tabnums td-narrow">Â¥{{ t.price|floatformat:0|intcomma }}</td>

        {# å®Ÿæï¼ˆç¾é‡‘ï¼‰ï¼ cashflow ã‚’ãã®ã¾ã¾è¡¨ç¤º #}
        <td class="px-3 py-2 text-right nowrap mono tabnums td-narrow">
          {% with v=t.cashflow|default:0 %}
            <span class="{% if v >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}">
              Â¥{{ v|floatformat:0|intcomma }}
            </span>
          {% endwith %}
        </td>

        {# å®Ÿç¾æç›Šï¼ˆæŠ•è³‡å®¶PnLï¼‰ #}
        <td class="px-3 py-2 text-right nowrap mono tabnums td-narrow">
          {% with v=t.pnl_calc|default:0 %}
            <span class="{% if v >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}">
              Â¥{{ v|floatformat:0|intcomma }}
            </span>
          {% endwith %}
        </td>

        {# æ‰‹æ•°æ–™ï¼ˆå‚è€ƒï¼‰ #}
        <td class="px-3 py-2 text-right nowrap mono tabnums">Â¥{{ t.fee|floatformat:0|intcomma }}</td>

        {# å‰Šé™¤ï¼ˆJSONã§ãƒ†ãƒ¼ãƒ–ãƒ«/ã‚µãƒãƒªãƒ¼å·®ã—æ›¿ãˆï¼‰ #}
        <td class="px-3 py-2 text-right whitespace-nowrap">
          <form
            hx-post="{% url 'realized_delete' t.id %}"
            hx-swap="none"
            hx-include="#q"
            hx-confirm="å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
            hx-on::after-request="
              if (event.detail.successful) {
                try {
                  var data = JSON.parse(event.detail.xhr.responseText || '{}');
                  if (data.table)   { var t = document.querySelector('#pnlTableWrap');   if (t) t.outerHTML = data.table; }
                  if (data.summary) { var s = document.querySelector('#pnlSummaryWrap'); if (s) s.outerHTML = data.summary; }
                } catch(e) { console.error(e); }
              }">
            {% csrf_token %}
            <button type="submit" class="text-slate-300 hover:text-rose-300 text-sm whitespace-nowrap">å‰Šé™¤</button>
          </form>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="9" class="px-3 py-6 text-slate-400">ãƒ‡ãƒ¼ã‚¿ãªã—</td>
      </tr>
    {% endfor %}
  </tbody>
</table>