{% load humanize %}

<style>
  /* å®Ÿç¾æç›Šãƒ†ãƒ¼ãƒ–ãƒ«ï¼šãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®šï¼†é€éãƒ–ãƒ©ãƒ¼ */
  .realized-pnl-thead th {
    position: sticky;
    position: -webkit-sticky;
    top: 0;  /* ä¸Šã«å›ºå®šãƒ˜ãƒƒãƒ€ãƒ¼ãŒã‚ã‚‹ãªã‚‰ 40px ãªã©ã«èª¿æ•´ */
    z-index: 0;
    background: rgba(15, 23, 42, 0.82); /* é€éãƒ€ãƒ¼ã‚¯ï¼‹blur */
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
  }
</style>

<table class="w-full border-separate border-spacing-0">
  <colgroup>
    <col class="w-28">
    <col class="w-48">
    <col class="w-20">
    <col class="w-24">
    <col class="w-28">
    <col class="w-28">
    <col class="w-28">
    <col class="w-24">
    <col class="w-20">
  </colgroup>

  <thead class="realized-pnl-thead text-slate-300 text-xs">
    <tr>
      <th class="px-3 py-2 text-left"  style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">æ—¥ä»˜</th>
      <th class="px-3 py-2 text-left">éŠ˜æŸ„</th>
      <th class="px-3 py-2 text-center" style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">Side</th>
      <th class="px-3 py-2 text-right" style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">æ•°é‡</th>
      <th class="px-3 py-2 text-right" style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">ç´„å®šå˜ä¾¡ / å–å¾—å˜ä¾¡</th>
      <th class="px-3 py-2 text-right" style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">ğŸ’°å®Ÿæ(ç¾é‡‘)</th>
      <th class="px-3 py-2 text-right" style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">ğŸ“ˆå®Ÿç¾æç›Š</th>
      <th class="px-3 py-2 text-right" style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">æ‰‹æ•°æ–™</th>
      <th class="px-3 py-2 text-right" style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">æ“ä½œ</th>
    </tr>
  </thead>

  <tbody class="text-[15px]">
    {% for t in trades %}
      <tr class="border-b border-white/10">
        <td class="px-3 py-2 text-slate-200"
            style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">
          <div>{{ t.trade_at|date:"Y-m-d" }}</div>
          {# ä¿æœ‰é–‹å§‹æ—¥ï¼‹ä¿æœ‰æ—¥æ•° #}
          {% if t.opened_at or t.hold_days %}
            <div class="text-[11px] text-slate-400 leading-tight">
              {% if t.opened_at %}
                ä¿æœ‰é–‹å§‹ {{ t.opened_at|date:"Y-m-d" }}
              {% endif %}
              {% if t.hold_days %}
                ï¼ˆ{{ t.hold_days|intcomma }}æ—¥ï¼‰
              {% endif %}
            </div>
          {% endif %}
        </td>

        <td class="px-3 py-2">
          <div class="leading-tight">
            <div class="text-slate-400 text-xs tracking-wide" style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">
              {{ t.ticker }}
            </div>
            <div class="text-slate-200 font-semibold truncate">{{ t.name|default:"" }}</div>

            {# ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼ / å£åº§ãƒãƒƒã‚¸ #}
            <div class="mt-1 flex items-center gap-1 text-[10px] leading-none">
              {% with b=t.broker|default:"OTHER" %}
                <span class="px-1.5 py-0.5 rounded-md ring-1"
                      style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;
                             {% if b == 'RAKUTEN' %}background:rgba(217,70,239,.15);color:#f5d0fe;border-color:rgba(217,70,239,.25);
                             {% elif b == 'SBI' %}background:rgba(14,165,233,.15);color:#bae6fd;border-color:rgba(14,165,233,.25);
                             {% elif b == 'MATSUI' %}background:rgba(16,185,129,.15);color:#bbf7d0;border-color:rgba(16,185,129,.25);
                             {% else %}background:rgba(100,116,139,.2);color:#cbd5e1;border-color:rgba(255,255,255,.1);{% endif %}">
                  {% if b == 'RAKUTEN' %}æ¥½å¤©{% elif b == 'SBI' %}SBI{% elif b == 'MATSUI' %}æ¾äº•{% else %}ãã®ä»–{% endif %}
                </span>
              {% endwith %}
              {% with a=t.account|default:"SPEC" %}
                <span class="px-1.5 py-0.5 rounded-md ring-1"
                      style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;
                             {% if a == 'NISA' %}background:rgba(245,158,11,.15);color:#fde68a;border-color:rgba(245,158,11,.25);
                             {% elif a == 'MARGIN' %}background:rgba(244,63,94,.15);color:#fecdd3;border-color:rgba(244,63,94,.25);
                             {% else %}background:rgba(99,102,241,.15);color:#c7d2fe;border-color:rgba(99,102,241,.25);{% endif %}">
                  {% if a == 'NISA' %}NISA{% elif a == 'MARGIN' %}ä¿¡ç”¨{% else %}ç‰¹å®š{% endif %}
                </span>
              {% endwith %}
            </div>

            {# â˜… 33æ¥­ç¨®ï¼ˆå¿…ãš1è¡Œè¡¨ç¤ºï¼šãªã‘ã‚Œã°ã€Œâ€”ã€ï¼‰ #}
            <div class="mt-0.5 flex items-center gap-1 text-[11px] text-slate-400 leading-tight">
              <span style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">33æ¥­ç¨®:</span>
              {% if t.sector33_name or t.sector33_code %}
                <span class="truncate">
                  {% if t.sector33_name %}{{ t.sector33_name }}{% endif %}
                  {% if t.sector33_code %} ({{ t.sector33_code }}){% endif %}
                </span>
              {% else %}
                <span class="text-slate-500">â€”</span>
              {% endif %}
            </div>

            {# å›½ãƒ»é€šè²¨ãƒ»FXãƒ¬ãƒ¼ãƒˆ #}
            {% if t.country or t.currency or t.fx_rate %}
              <div class="mt-0.5 flex items-center gap-2 text-[11px] text-slate-500 leading-tight">
                {% if t.country %}
                  <span style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">{{ t.country }}</span>
                {% endif %}
                {% if t.currency %}
                  <span style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">{{ t.currency }}</span>
                {% endif %}
                {% if t.fx_rate %}
                  <span style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">Fx {{ t.fx_rate }}</span>
                {% endif %}
              </div>
            {% endif %}

            {# æˆ¦ç•¥ãƒ©ãƒ™ãƒ« / AIã‚·ã‚°ãƒŠãƒ« #}
            {% if t.strategy_label or t.is_ai_signal %}
              <div class="mt-0.5 flex items-center gap-1 text-[10px] leading-none">
                {% if t.strategy_label %}
                  <span class="px-1.5 py-0.5 rounded-md bg-white/5 text-slate-200 max-w-[140px] truncate"
                        style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">
                    {{ t.strategy_label }}
                  </span>
                {% endif %}
                {% if t.is_ai_signal %}
                  <span class="px-1.5 py-0.5 rounded-md bg-emerald-500/20 text-emerald-200"
                        style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">
                    AI
                  </span>
                {% endif %}
              </div>
            {% endif %}

            {# ãƒ¡ãƒ¢ï¼ˆã‚ã‚Œã°ï¼‰ #}
            {% if t.memo %}
              <div class="mt-0.5 text-[11px] text-slate-400 line-clamp-2">
                {{ t.memo }}
              </div>
            {% endif %}
          </div>
        </td>

        <td class="px-3 py-2 text-center">
          <span class="inline-block rounded-md px-2 py-0.5 text-xs"
                style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;
                       {% if t.side == 'SELL' %}background:rgba(244,63,94,.15);color:#fecdd3;border:1px solid rgba(244,63,94,.25);
                       {% else %}background:rgba(16,185,129,.15);color:#bbf7d0;border:1px solid rgba(16,185,129,.25);{% endif %}">
            {{ t.side }}
          </span>
        </td>

        <td class="px-3 py-2 text-right font-mono"
            style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal; font-variant-numeric:tabular-nums;">
          {{ t.qty|intcomma }}
        </td>

        <td class="px-3 py-2 text-right font-mono"
            style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal; font-variant-numeric:tabular-nums;">
          {# ç´„å®šå˜ä¾¡ï¼ˆ2æ¡ï¼‰ #}
          {% if t.currency and t.currency != "JPY" %}
            {{ t.price|floatformat:2|intcomma }} {{ t.currency }}
          {% else %}
            Â¥{{ t.price|floatformat:2|intcomma }}
          {% endif %}

          {# å–å¾—å˜ä¾¡ï¼ˆbasisï¼š2æ¡ï¼‰ #}
          {% if t.basis %}
            <div class="text-[11px] opacity-70">
              å–å¾—:
              {% if t.currency and t.currency != "JPY" %}
                {{ t.basis|floatformat:2|intcomma }} {{ t.currency }}
              {% else %}
                Â¥{{ t.basis|floatformat:2|intcomma }}
              {% endif %}
            </div>
          {% endif %}
        </td>

        {# ğŸ’°å®Ÿæ(ç¾é‡‘) #}
        <td class="px-3 py-2 text-right font-mono"
            style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal; font-variant-numeric:tabular-nums;">
          {% if t.account == 'MARGIN' %}
            {% with v=t.pnl_jpy %}
              <span class="{% if v >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}"
                    style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">
                Â¥{{ v|floatformat:0|intcomma }}
              </span>
              {% if t.currency and t.currency != "JPY" %}
                <div class="text-[11px] opacity-70">
                  ({{ t.pnl_display|floatformat:2|intcomma }} {{ t.currency }})
                </div>
              {% endif %}
            {% endwith %}
          {% else %}
            {% with v=t.cashflow_calc_jpy %}
              <span class="{% if v >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}"
                    style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">
                Â¥{{ v|floatformat:0|intcomma }}
              </span>
              {% if t.currency and t.currency != "JPY" %}
                <div class="text-[11px] opacity-70">
                  ({{ t.cashflow_calc|floatformat:2|intcomma }} {{ t.currency }})
                </div>
              {% endif %}
            {% endwith %}
          {% endif %}
        </td>

        {# ğŸ“ˆå®Ÿç¾æç›Š #}
        <td class="px-3 py-2 text-right font-mono"
            style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal; font-variant-numeric:tabular-nums;">
          {% with v=t.pnl_jpy %}
            <span class="{% if v >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}"
                  style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">
              Â¥{{ v|floatformat:0|intcomma }}
            </span>
            {% if t.currency and t.currency != "JPY" %}
              <div class="text-[11px] opacity-70">
                ({{ t.pnl_display|floatformat:2|intcomma }} {{ t.currency }})
              </div>
            {% endif %}
          {% endwith %}
        </td>

        <td class="px-3 py-2 text-right font-mono"
            style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal; font-variant-numeric:tabular-nums;">
          Â¥{{ t.fee|floatformat:0|intcomma }}
        </td>

        <td class="px-3 py-2 text-right"
            style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">
          <form
            hx-post="{% url 'realized_delete' t.id %}"
            hx-swap="none"
            hx-include="#q"
            hx-confirm="å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
            hx-on::after-request="
              if (event.detail.successful) {
                try {
                  var data = JSON.parse(event.detail.xhr.responseText || '{}');
                  if (data.table) {
                    var tEl = document.querySelector('#pnlTableWrap'); if (tEl) tEl.outerHTML = data.table;
                  }
                  if (data.summary) {
                    var sEl = document.querySelector('#pnlSummaryWrap'); if (sEl) sEl.outerHTML = data.summary;
                  }
                } catch(e) { console.error(e); }
              }
            ">
            {% csrf_token %}
            <button type="submit" class="text-slate-300 hover:text-rose-300 text-sm"
                    style="white-space:nowrap;word-break:keep-all;overflow-wrap:normal;">
              å‰Šé™¤
            </button>
          </form>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="9" class="px-3 py-6 text-slate-400">ãƒ‡ãƒ¼ã‚¿ãªã—</td>
      </tr>
    {% endfor %}
  </tbody>
</table>