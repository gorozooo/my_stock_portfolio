{% load humanize %}
<table class="w-full border-separate border-spacing-0 rounded-2xl overflow-hidden">
  <colgroup>
    <col class="w-28">
    <col class="w-48">
    <col class="w-20">
    <col class="w-24">
    <col class="w-28">
    <col class="w-28">
    <col class="w-28">
    <col class="w-24">
    <col class="w-20">
  </colgroup>

  <thead class="bg-white/5 text-slate-300 text-xs">
    <tr>
      <th class="px-3 py-2 text-left">æ—¥ä»˜</th>
      <th class="px-3 py-2 text-left">éŠ˜æŸ„</th>
      <th class="px-3 py-2 text-center">Side</th>
      <th class="px-3 py-2 text-right">æ•°é‡</th>
      <th class="px-3 py-2 text-right">ç´„å®šå˜ä¾¡</th>
      <th class="px-3 py-2 text-right">ğŸ’°å®Ÿæ(ç¾é‡‘)</th>
      <th class="px-3 py-2 text-right">ğŸ“ˆå®Ÿç¾æç›Š</th>
      <th class="px-3 py-2 text-right">æ‰‹æ•°æ–™</th>
      <th class="px-3 py-2 text-right">æ“ä½œ</th>
    </tr>
  </thead>

  <tbody class="text-[15px]">
    {% for t in trades %}
      <tr class="border-b border-white/10">

        <td class="px-3 py-2 text-slate-200">
          {{ t.trade_at|date:"Y-m-d" }}
        </td>

        <td class="px-3 py-2">
          <div class="leading-tight">
            <div class="text-slate-400 text-xs tracking-wide">{{ t.ticker }}</div>
            <div class="text-slate-200 font-semibold truncate">{{ t.name|default:"" }}</div>

            <div class="mt-1 flex items-center gap-1 text-[10px] leading-none">
              {% with b=t.broker|default:"OTHER" %}
                <span class="px-1.5 py-0.5 rounded-md ring-1
                  {% if b == 'RAKUTEN' %}bg-fuchsia-600/20 text-fuchsia-200 border-fuchsia-400/20
                  {% elif b == 'SBI' %}bg-sky-600/20 text-sky-200 border-sky-400/20
                  {% elif b == 'MATSUI' %}bg-emerald-600/20 text-emerald-200 border-emerald-400/20
                  {% else %}bg-slate-600/30 text-slate-300 border-white/10{% endif %}">
                  {% if b == 'RAKUTEN' %}æ¥½å¤©{% elif b == 'SBI' %}SBI{% elif b == 'MATSUI' %}æ¾äº•{% else %}ãã®ä»–{% endif %}
                </span>
              {% endwith %}

              {% with a=t.account|default:"SPEC" %}
                <span class="px-1.5 py-0.5 rounded-md ring-1
                  {% if a == 'NISA' %}bg-amber-600/20 text-amber-200 border-amber-400/20
                  {% elif a == 'MARGIN' %}bg-rose-600/20 text-rose-200 border-rose-400/20
                  {% else %}bg-indigo-600/20 text-indigo-200 border-indigo-400/20{% endif %}">
                  {% if a == 'NISA' %}NISA{% elif a == 'MARGIN' %}ä¿¡ç”¨{% else %}ç‰¹å®š{% endif %}
                </span>
              {% endwith %}
            </div>
          </div>
        </td>

        <td class="px-3 py-2 text-center">
          <span class="inline-block rounded-md px-2 py-0.5 text-xs
            {% if t.side == 'SELL' %}bg-rose-600/20 text-rose-200 border border-rose-400/20
            {% else %}bg-emerald-600/20 text-emerald-200 border border-emerald-400/20{% endif %}">
            {{ t.side }}
          </span>
        </td>

        <td class="px-3 py-2 text-right font-mono">
          {{ t.qty|intcomma }}
        </td>

        {# â†â†â† ğŸ”¥ ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆï¼ˆJPY / USD è‡ªå‹•åˆ¤å®šï¼‰ #}
        <td class="px-3 py-2 text-right font-mono">
          {% if t.currency == "USD" %}
            ${{ t.price|floatformat:2|intcomma }}
          {% else %}
            Â¥{{ t.price|floatformat:0|intcomma }}
          {% endif %}
        </td>
        {# ã“ã“ã¾ã§ #}

        {# ğŸ’° å®Ÿæ(ç¾é‡‘) #}
        <td class="px-3 py-2 text-right font-mono">
          {% if t.account == "MARGIN" %}
            {% with v=t.pnl_jpy %}
              <span class="{% if v >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </span>
              {% if t.currency != "JPY" %}
                <div class="text-[11px] opacity-70">({{ t.pnl_display|floatformat:2 }} {{ t.currency }})</div>
              {% endif %}
            {% endwith %}
          {% else %}
            {% with v=t.cashflow_calc_jpy %}
              <span class="{% if v >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </span>
              {% if t.currency != "JPY" %}
                <div class="text-[11px] opacity-70">({{ t.cashflow_calc|floatformat:2 }} {{ t.currency }})</div>
              {% endif %}
            {% endwith %}
          {% endif %}
        </td>

        {# ğŸ“ˆå®Ÿç¾æç›Š #}
        <td class="px-3 py-2 text-right font-mono">
          {% with v=t.pnl_jpy %}
            <span class="{% if v >= 0 %}text-emerald-300{% else %}text-rose-300{% endif %}">
              Â¥{{ v|floatformat:0|intcomma }}
            </span>
            {% if t.currency != "JPY" %}
              <div class="text-[11px] opacity-70">({{ t.pnl_display|floatformat:2 }} {{ t.currency }})</div>
            {% endif %}
          {% endwith %}
        </td>

        <td class="px-3 py-2 text-right font-mono">
          Â¥{{ t.fee|floatformat:0|intcomma }}
        </td>

        <td class="px-3 py-2 text-right">
          <form
            hx-post="{% url 'realized_delete' t.id %}"
            hx-swap="none"
            hx-confirm="å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
            hx-on::after-request="
              if (event.detail.successful) {
                try {
                  var data = JSON.parse(event.detail.xhr.responseText || '{}');
                  if (data.table) document.querySelector('#pnlTableWrap').outerHTML = data.table;
                  if (data.summary) document.querySelector('#pnlSummaryWrap').outerHTML = data.summary;
                } catch(e) { console.error(e); }
              }
            ">
            {% csrf_token %}
            <button class="text-slate-300 hover:text-rose-300 text-sm">å‰Šé™¤</button>
          </form>
        </td>

      </tr>
    {% empty %}
      <tr>
        <td colspan="9" class="px-3 py-6 text-slate-400">ãƒ‡ãƒ¼ã‚¿ãªã—</td>
      </tr>
    {% endfor %}
  </tbody>
</table>