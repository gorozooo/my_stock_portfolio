{# templates/realized/monthly.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}月別サマリー{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/realized.css' %}?v=10">
<style>
  .view-hidden{display:none!important}
  section{margin-top:12px}
  .card{padding:10px 12px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.03)}

  /* 月選択チップ */
  .chips{display:flex;gap:8px;overflow-x:auto;padding:6px 2px 2px 2px}
  .chip{font-size:12px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:9999px;background:transparent;color:#e5e7eb;white-space:nowrap}
  .chip[aria-current="true"]{background:rgba(255,255,255,.10)}

  /* 横スクロール（明細/期間表向け） */
  .h-scroll{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .scroll-pad{ min-width: 900px; }  /* 明細テーブル幅に応じて調整OK */
</style>
{% endblock %}

{% block content %}
<div class="pnl">
  <h1>月別サマリー</h1>

  {# ── 検索 ── #}
  <div class="fi fi-full mt-4">
    <input
      type="search" name="q" value="{{ q|default:'' }}" id="q"
      placeholder="ティッカー/名称で検索"
      hx-get="{% url 'realized_summary_period' %}"
      hx-target="#monthly-period"
      hx-trigger="keyup changed delay:300ms, search"
      hx-include="#q"
      class="w-full">
  </div>

  {# ── 期間まとめ（既存の部分テンプレ） ── #}
  <section id="monthly-period"
           hx-get="{% url 'realized_summary_period' %}?preset={{ preset|default:'LAST_12M' }}&freq=month&q={{ q|urlencode }}"
           hx-trigger="load"
           hx-include="[name=q],[name=preset],[name=freq],[name=start],[name=end]"
           hx-swap="outerHTML">
    <div style="color:#94a3b8;padding:8px 0">読み込み中…</div>
  </section>
  
  {# ── KPI ── #}
  <section id="monthly-kpis"
           hx-get="{% url 'realized_monthly_kpis' %}"
           hx-trigger="load, pnl:refresh from:body"
           hx-include="[name=q],[name=preset],[name=freq],[name=start],[name=end]"
           hx-swap="outerHTML">
    <div style="color:#94a3b8;padding:8px 0">KPIを読み込み中…</div>
  </section>

  {# ── ブレークダウン ── #}
  <section id="monthly-breakdown"
           hx-get="{% url 'realized_monthly_breakdown' %}"
           hx-trigger="load, pnl:refresh from:body"
           hx-include="[name=q],[name=preset],[name=freq],[name=start],[name=end]"
           hx-swap="outerHTML">
    <div style="color:#94a3b8;padding:8px 0">ブレークダウンを読み込み中…</div>
  </section>
  
  {# ── Top/Worst 月 ── #}
  <section id="monthly-topworst"
           hx-get="{% url 'realized_monthly_topworst' %}"
           hx-trigger="load, pnl:refresh from:body"
           hx-include="[name=q],[name=preset],[name=freq],[name=start],[name=end]"
           hx-swap="outerHTML">
    <div style="color:#94a3b8;padding:8px 0">トップ/ワースト月を読み込み中…</div>
  </section>

  {# ── 月選択チップ ── #}
  <section id="month-picker" class="card">
    <div class="text-xs text-slate-400 mb-1">月を選択</div>
    <div id="monthlyMonthPicker" class="chips" aria-live="polite"></div>
  </section>

  {# ── 選択月の明細（横スクロール対応） ── #}
  <section id="monthly-details">
    <div class="text-xs text-slate-400 mb-1">選択月の明細</div>
    <div class="h-scroll">
      <div id="monthlyDetailsBody" class="scroll-pad" style="color:#94a3b8">
        月をクリックすると明細を表示します
      </div>
    </div>
  </section>

  {# ── 月次チャート ── #}
  <section id="monthly-chart" class="card">
    <div style="font-size:12px;color:#a7b1d8;margin-bottom:6px">累積PnLの推移</div>
    <div id="monthlyChartBox" style="height:260px; position:relative;">
      <canvas id="monthlyChartCanvas"></canvas>
    </div>
  </section>

  {# ── 既存の分析チャート ── #}
  <section id="analysis-charts">
    {% include "realized/_analysis_charts.html" %}
  </section>

  {# ── 日別ヒートマップ ── #}
  <section class="card">
    <div class="text-xs text-slate-400 mb-1">日別ヒートマップ</div>
    <div id="heatCal" style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px"></div>
  </section>

  <script>
  /* ===== 日別ヒートマップ ===== */
  (async function(){
    const heatWrap = document.getElementById('heatCal');
    if (!heatWrap) return;
    const guess = (()=>{
      const cell = document.querySelector('#pnlPeriodWrap tbody tr:last-child td:first-child');
      const label = cell?.textContent?.trim();
      if (label && /^\d{4}-\d{2}$/.test(label)){ const [y,m] = label.split('-'); return {y:+y, m:+m}; }
      const d=new Date(); return {y:d.getFullYear(), m:d.getMonth()+1};
    })();
    const stub = "{% url 'realized_chart_daily_heat_json' year=2000 month=1 %}";
    const base = stub.replace(/\/2000\/1(\.json)?$/, `/${guess.y}/${guess.m}$1`);
    const qVal = (document.getElementById('q')?.value||'').trim();
    const url  = qVal ? `${base}?q=${encodeURIComponent(qVal)}` : base;

    try{
      const res = await fetch(url, {headers:{'X-Requested-With':'fetch'}});
      const payload = await res.json();
      const year = +payload.year, month = +payload.month, days = payload.days || {};
      const first = new Date(year, month-1, 1);
      const last  = new Date(year, month, 0).getDate();
      heatWrap.innerHTML = "";
      for(let i=0;i<first.getDay();i++){ const s=document.createElement('div'); s.style.opacity=.25; heatWrap.appendChild(s); }
      for(let d=1; d<=last; d++){
        const k = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
        const v = Number(days[k]||0);
        const cell = document.createElement('div');
        cell.textContent = d;
        cell.style.textAlign="center";
        cell.style.padding="6px 0";
        cell.style.border="1px solid rgba(255,255,255,.08)";
        cell.style.borderRadius="6px";
        const a = Math.min(1, Math.abs(v)/5000);
        cell.style.background = v>=0 ? `rgba(16,185,129,${0.12+0.45*a})` : `rgba(244,63,94,${0.12+0.45*a})`;
        heatWrap.appendChild(cell);
      }
    }catch(e){
      console.error(e);
      heatWrap.innerHTML = '<div style="color:#fca5a5">ヒートマップの取得に失敗しました</div>';
    }
  })();
  </script>
</div>

<script>
/* ===== 月次チャート & ドリルダウン ===== */
(function(){
  let chart;
  window.chart = null;

  const detailsBody = () => document.getElementById('monthlyDetailsBody');
  const monthPicker = () => document.getElementById('monthlyMonthPicker');

  const currentQ = () => (document.getElementById('q')?.value || '').trim();
  const monthlyApi = () => {
    const base = "{% url 'realized_chart_monthly_json' %}";
    const q = encodeURIComponent(currentQ());
    return q ? `${base}?q=${q}` : base;
  };

  // ─ 明細を1ヶ月に絞って取得（JSON固定） ─
  async function loadDetailsForYm(ym){
    try{
      const [y,m] = ym.split("-");
      const start = `${ym}-01`;
      const endDate = new Date(+y, +m, 0);            // 月末
      const endStr = `${endDate.getFullYear()}-${String(endDate.getMonth()+1).padStart(2,'0')}-${String(endDate.getDate()).padStart(2,'0')}`;

      const params = new URLSearchParams({ start: start, end: endStr, format: 'json' });
      const q = currentQ(); if (q) params.append("q", q);

      detailsBody().innerHTML = "<div style='color:#94a3b8'>読み込み中…</div>";

      const res = await fetch("{% url 'realized_table_partial' %}?"+params.toString(), {
        headers: { "Accept":"application/json", "X-Requested-With":"fetch" }
      });
      const j = await res.json();

      detailsBody().innerHTML = (j && j.ok && j.html)
        ? j.html
        : "<div style='color:#94a3b8'>データなし</div>";

      setActiveChip(ym);
      document.getElementById("monthly-details")?.scrollIntoView({behavior:"smooth", block:"start"});
    }catch(e){
      console.error(e);
      detailsBody().innerHTML =
        "<div class='p-3 rounded-lg' style='background:#2b1f24;color:#ffd1d1;border:1px solid #ff9aa9;'>明細の取得に失敗しました</div>";
    }
  }
  window.loadDetailsForYm = loadDetailsForYm;

  // ─ 月チップ生成/更新 ─
  function buildMonthChips(labels){
    const box = monthPicker(); if (!box) return;
    box.innerHTML = '';
    (labels||[]).forEach(ym=>{
      if (!/^\d{4}-\d{2}$/.test(ym)) return;
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'chip';
      b.textContent = ym;
      b.dataset.ym = ym;
      b.addEventListener('click', ()=> loadDetailsForYm(ym));
      box.appendChild(b);
    });
  }
  function setActiveChip(ym){
    monthPicker()?.querySelectorAll('.chip').forEach(c=>{
      c.setAttribute('aria-current', c.dataset.ym === ym ? 'true' : 'false');
    });
  }

  // ─ チャート描画 ─
  async function drawMonthlyChart(){
    const canvas = document.getElementById('monthlyChartCanvas');
    if (!canvas || !window.Chart) return;
    try{
      const resp = await fetch(monthlyApi(), {headers:{'X-Requested-With':'fetch'}});
      const data = await resp.json();

      const ctx = canvas.getContext('2d');
      if (chart) { chart.destroy(); chart = null; }

      buildMonthChips(data.labels || []);

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels || [],
          datasets: [
            { type:'bar',  label:'PnL',      data:data.pnl || [], borderWidth:0 },
            { type:'line', label:'累積PnL',  data:data.pnl_cum || [], borderWidth:2, pointRadius:3, yAxisID:'y1' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          resizeDelay: 150,
          scales: {
            y:  { beginAtZero:true },
            y1: { beginAtZero:true, position:'right', grid:{ drawOnChartArea:false } }
          },
          plugins: {
            legend: { labels:{ boxWidth:10 } },
            tooltip:{ mode:'index', intersect:false }
          },
          onClick: (_evt, els)=>{
            if (!els || !els.length) return;
            const idx = els[0].index;
            const ym  = (chart.data.labels||[])[idx];
            if (ym) loadDetailsForYm(ym);
          }
        }
      });
      window.chart = chart;
    }catch(e){ console.error('monthly chart error', e); }
  }
  window.drawMonthlyChart = drawMonthlyChart;

  // ─ 初期描画・再描画 ─
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', drawMonthlyChart, {once:true});
  }else{
    drawMonthlyChart();
  }
  let redrawTimer=null;
  function requestRedraw(){ clearTimeout(redrawTimer); redrawTimer=setTimeout(drawMonthlyChart,180); }
  document.addEventListener('pnl:refresh', requestRedraw);
  document.getElementById('q')?.addEventListener('search', requestRedraw);
  window.addEventListener('resize', requestRedraw);

  // Top/Worst クリック
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-ym]');
    if (btn) loadDetailsForYm(btn.dataset.ym);
  });

  // 期間テーブルからの通知でも
  document.addEventListener('pnl:focus-period', (ev)=>{
    const ym = ev?.detail?.label;
    if (/^\d{4}-\d{2}$/.test(ym)) loadDetailsForYm(ym);
  });

  // ─ 自動初期選択（最後のラベル → Top/Worst → 期間表） ─
  async function autoPick(){
    let ym = (window.chart?.data?.labels||[]).slice(-1)[0] || null;
    if (!ym){
      const tw = document.querySelector('#monthly-topworst [data-ym]');
      ym = tw?.getAttribute('data-ym') || null;
    }
    if (!ym){
      const last = document.querySelector('#pnlPeriodWrap tbody tr:last-child');
      ym = last?.dataset?.period || last?.querySelector('td:first-child')?.textContent?.trim();
    }
    if (ym && /^\d{4}-\d{2}$/.test(ym)) await loadDetailsForYm(ym);
  }
  window.addEventListener('load', ()=> setTimeout(autoPick, 350));
  document.addEventListener('pnl:refresh', ()=> setTimeout(autoPick, 250));
})();
</script>
{% endblock %}