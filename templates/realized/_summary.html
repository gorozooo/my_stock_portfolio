{# templates/realized/_summary.html #}
{% load humanize %}

<style>
  .real-wrap{
    margin-top:8px;
    padding:12px;
    border-radius:20px;
    background:radial-gradient(circle at top,#111827 0,#020617 55%);
    border:1px solid rgba(148,163,184,.35);
    box-shadow:0 18px 40px rgba(15,23,42,.9);
  }

  /* ==== ã‚¿ãƒ– ==== */
  .real-tabs{
    display:flex;
    gap:8px;
    margin-bottom:14px;
    padding:2px;
    border-radius:999px;
    background:linear-gradient(135deg,rgba(129,140,248,.45),rgba(45,212,191,.35));
  }
  .real-tab{
    flex:1;
    border:none;
    border-radius:999px;
    padding:9px 6px;
    font-size:12px;
    font-weight:600;
    letter-spacing:.06em;
    text-align:center;
    color:#e5e7eb;
    background:transparent;
    cursor:pointer;
    position:relative;
    overflow:hidden;
  }
  .real-tab span{position:relative;z-index:1}
  .real-tab::before{
    content:"";
    position:absolute;
    inset:0;
    border-radius:inherit;
    background:radial-gradient(circle at top,#4f46e5,#111827);
    opacity:0;
    transform:scale(.94);
    transition:opacity .16s ease-out, transform .16s ease-out;
  }
  .real-tab.active{
    color:#f9fafb;
    text-shadow:0 0 14px rgba(129,140,248,.8);
  }
  .real-tab.active::before{
    opacity:1;
    transform:scale(1);
  }

  /* ==== ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ==== */
  .section-title{
    margin-top:4px;
    margin-bottom:6px;
    font-size:12px;
    color:#a5b4fc;
    letter-spacing:.08em;
    text-transform:uppercase;
  }

  .summary-grid{
    display:grid;
    gap:12px;
    grid-template-columns:repeat(4,minmax(0,1fr));
  }
  .sum-card{
    background:rgba(15,23,42,.96);
    border-radius:14px;
    padding:10px 12px;
    border:1px solid rgba(148,163,184,.45);
    box-shadow:0 12px 30px rgba(15,23,42,.9);
  }
  .k{font-size:11px;color:#9ca3af;margin-bottom:6px}
  .v{font-size:18px;font-weight:700}
  .mono{font-variant-numeric:tabular-nums}
  .pos{color:#4ade80}
  .neg{color:#fb7171}
  .muted{color:#9ca3af}
  .sub{font-size:11px;color:#9ca3af;margin-top:4px}

  .broker-grid{
    display:grid;
    gap:10px;
    grid-template-columns:repeat(4,minmax(0,1fr));
    margin-top:8px;
  }
  .bname{font-size:12px;color:#e5e7eb;margin-bottom:4px;font-weight:600}
  .chip-broker{
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:2px 8px;
    border-radius:999px;
    background:rgba(148,163,255,.16);
    font-size:10px;
    color:#c7d2fe;
    margin-left:4px;
  }

  /* ã‚¿ãƒ–ã®è¡¨ç¤ºåˆ¶å¾¡ */
  .real-panel{display:none;animation:panelFade .18s ease-out}
  .real-panel.active{display:block}

  @keyframes panelFade{
    from{opacity:0;transform:translateY(4px)}
    to{opacity:1;transform:translateY(0)}
  }

  @media (max-width:1024px){
    .summary-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    .broker-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
  @media (max-width:640px){
    .summary-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    .broker-grid{grid-template-columns:1fr}
    .real-wrap{padding:10px}
  }
</style>

<div class="real-wrap" id="realSummaryRoot">
  <!-- ==== ã‚¿ãƒ– ==== -->
  <div class="real-tabs" role="tablist">
    <button type="button" class="real-tab active" data-tab="total"  role="tab" aria-selected="true"><span>ç·åˆ</span></button>
    <button type="button" class="real-tab"        data-tab="rakuten" role="tab"><span>æ¥½å¤©</span></button>
    <button type="button" class="real-tab"        data-tab="matsui"  role="tab"><span>æ¾äº•</span></button>
    <button type="button" class="real-tab"        data-tab="sbi"     role="tab"><span>SBI</span></button>
  </div>

  <!-- ==== ç·åˆã‚¿ãƒ– ==== -->
  <div class="real-panel active" data-panel="total">
    <div class="section-title">ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</div>
    <div class="summary-grid">
      <div class="sum-card">
        <div class="k">ä»¶æ•°</div>
        <div class="v mono">{{ agg.n|intcomma }}</div>
      </div>

      <div class="sum-card">
        <div class="k">å‹ç‡(%)</div>
        <div class="v mono">{{ agg.win_rate|floatformat:1 }}%</div>
      </div>

      <div class="sum-card">
        <div class="k">å¹³å‡å®Ÿç¾æç›Š(%)</div>
        {% if agg.avg_pnl_pct is not None %}
          <div class="v mono">{{ agg.avg_pnl_pct|floatformat:2 }}%</div>
        {% else %}
          <div class="v mono muted">â€”</div>
        {% endif %}
      </div>

      <div class="sum-card">
        <div class="k">PFï¼ˆåˆ©ç›Š / |æå¤±|ï¼‰</div>
        {% if agg.pf is not None %}
          {% if agg.pf == inf %}
            <div class="v mono">âˆ</div>
          {% else %}
            <div class="v mono">{{ agg.pf|floatformat:2 }}</div>
          {% endif %}
        {% elif agg.profit_sum and not agg.loss_sum %}
          <div class="v mono">âˆ</div>
        {% else %}
          <div class="v mono muted">â€”</div>
        {% endif %}
      </div>
    </div>

    <div class="section-title">ğŸ’° æç›Šãƒ»ãƒ•ãƒ­ãƒ¼</div>
    <div class="summary-grid">
      <div class="sum-card">
        <div class="k">ğŸ“ˆå®Ÿç¾æç›Šç´¯è¨ˆ</div>
        {% with v=agg.pnl %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
            Â¥{{ v|floatformat:0|intcomma }}
          </div>
        {% endwith %}
      </div>

      <div class="sum-card">
        <div class="k">åˆ©ç›Šåˆè¨ˆ</div>
        <div class="v mono pos">Â¥{{ agg.profit_sum|default_if_none:0|floatformat:0|intcomma }}</div>
      </div>

      <div class="sum-card">
        <div class="k">æå¤±åˆè¨ˆ</div>
        {% if agg.loss_sum is not None %}
          <div class="v mono neg">Â¥{{ agg.loss_sum|floatformat:0|intcomma }}</div>
        {% else %}
          <div class="v mono muted">â€”</div>
        {% endif %}
      </div>

      <div class="sum-card">
        <div class="k">å¹³å‡ä¿æœ‰æ—¥æ•°</div>
        {% if agg.avg_hold_days is not None %}
          <div class="v mono">{{ agg.avg_hold_days|floatformat:1 }} æ—¥</div>
        {% else %}
          <div class="v mono muted">â€”</div>
        {% endif %}
      </div>

      <div class="sum-card">
        <div class="k">ğŸ’°ç¾é‡‘ãƒ•ãƒ­ãƒ¼ï¼ˆç¾ç‰©ï¼‰</div>
        {% with v=agg.cash_spec %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
            Â¥{{ v|floatformat:0|intcomma }}
          </div>
        {% endwith %}
      </div>

      <div class="sum-card">
        <div class="k">ğŸ’°ç¾é‡‘ãƒ•ãƒ­ãƒ¼ï¼ˆä¿¡ç”¨ï¼‰</div>
        {% with v=agg.cash_margin %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
            Â¥{{ v|floatformat:0|intcomma }}
          </div>
        {% endwith %}
      </div>

      <div class="sum-card">
        <div class="k">ğŸ’°ç¾é‡‘ãƒ•ãƒ­ãƒ¼åˆè¨ˆ</div>
        {% with v=agg.cash_total %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
            Â¥{{ v|floatformat:0|intcomma }}
          </div>
        {% endwith %}
      </div>

      <div class="sum-card">
        <div class="k">æ‰‹æ•°æ–™åˆè¨ˆ</div>
        <div class="v mono">Â¥{{ agg.fee|floatformat:0|intcomma }}</div>
      </div>
    </div>

    <div class="section-title">ğŸ¦ è¨¼åˆ¸ä¼šç¤¾åˆ¥ã‚µãƒãƒª</div>
    {% if agg_brokers %}
      <div class="broker-grid">
        {% for b in agg_brokers %}
          <div class="sum-card">
            <div class="bname">
              {% if b.broker == 'RAKUTEN' %}æ¥½å¤©è¨¼åˆ¸
              {% elif b.broker == 'SBI' %}SBIè¨¼åˆ¸
              {% elif b.broker == 'MATSUI' %}æ¾äº•è¨¼åˆ¸
              {% elif b.broker %}{{ b.broker }}
              {% else %}ãã®ä»–{% endif %}
            </div>

            <div class="k">ä»¶æ•°</div>
            <div class="v mono">{{ b.n|intcomma }}</div>

            <div class="k" style="margin-top:6px">å‹ç‡</div>
            <div class="v mono">{{ b.win_rate|floatformat:1 }}%</div>

            <div class="k" style="margin-top:6px">ğŸ“ˆå®Ÿç¾æç›Š</div>
            {% with v=b.pnl %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="sum-card" style="margin-top:6px">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
    {% endif %}
  </div>

  <!-- ==== æ¥½å¤©ã‚¿ãƒ– ==== -->
  <div class="real-panel" data-panel="rakuten">
    <div class="section-title">æ¥½å¤©è¨¼åˆ¸ã‚µãƒãƒª</div>
    <div class="summary-grid">
      {% for b in agg_brokers %}
        {% if b.broker == 'RAKUTEN' %}
          <div class="sum-card">
            <div class="k">ä»¶æ•°</div>
            <div class="v mono">{{ b.n|intcomma }}</div>
          </div>
          <div class="sum-card">
            <div class="k">å‹ç‡</div>
            <div class="v mono">{{ b.win_rate|floatformat:1 }}%</div>
          </div>
          <div class="sum-card">
            <div class="k">ğŸ“ˆå®Ÿç¾æç›Š</div>
            {% with v=b.pnl %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
          <div class="sum-card">
            <div class="k">å¹³å‡å®Ÿç¾æç›Š(%)</div>
            {% if b.avg_pnl_pct is not None %}
              <div class="v mono">{{ b.avg_pnl_pct|floatformat:2 }}%</div>
            {% else %}
              <div class="v mono muted">â€”</div>
            {% endif %}
          </div>
          <div class="sum-card">
            <div class="k">å¹³å‡ä¿æœ‰æ—¥æ•°</div>
            {% if b.avg_hold_days is not None %}
              <div class="v mono">{{ b.avg_hold_days|floatformat:1 }} æ—¥</div>
            {% else %}
              <div class="v mono muted">â€”</div>
            {% endif %}
          </div>
          <div class="sum-card">
            <div class="k">ğŸ’°ç¾é‡‘ï¼ˆç¾ç‰©ï¼‰</div>
            {% with v=b.cash_spec %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
          <div class="sum-card">
            <div class="k">ğŸ’°ç¾é‡‘ï¼ˆä¿¡ç”¨ï¼‰</div>
            {% with v=b.cash_margin %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
          <div class="sum-card">
            <div class="k">ğŸ’°ç¾é‡‘ï¼ˆåˆè¨ˆï¼‰</div>
            {% with v=b.cash_total %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <!-- ==== æ¾äº•ã‚¿ãƒ– ==== -->
  <div class="real-panel" data-panel="matsui">
    <div class="section-title">æ¾äº•è¨¼åˆ¸ã‚µãƒãƒª</div>
    <div class="summary-grid">
      {% for b in agg_brokers %}
        {% if b.broker == 'MATSUI' %}
          <div class="sum-card">
            <div class="k">ä»¶æ•°</div>
            <div class="v mono">{{ b.n|intcomma }}</div>
          </div>
          <div class="sum-card">
            <div class="k">å‹ç‡</div>
            <div class="v mono">{{ b.win_rate|floatformat:1 }}%</div>
          </div>
          <div class="sum-card">
            <div class="k">ğŸ“ˆå®Ÿç¾æç›Š</div>
            {% with v=b.pnl %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
          <div class="sum-card">
            <div class="k">å¹³å‡å®Ÿç¾æç›Š(%)</div>
            {% if b.avg_pnl_pct is not None %}
              <div class="v mono">{{ b.avg_pnl_pct|floatformat:2 }}%</div>
            {% else %}
              <div class="v mono muted">â€”</div>
            {% endif %}
          </div>
          <div class="sum-card">
            <div class="k">å¹³å‡ä¿æœ‰æ—¥æ•°</div>
            {% if b.avg_hold_days is not None %}
              <div class="v mono">{{ b.avg_hold_days|floatformat:1 }} æ—¥</div>
            {% else %}
              <div class="v mono muted">â€”</div>
            {% endif %}
          </div>
          <div class="sum-card">
            <div class="k">ğŸ’°ç¾é‡‘ï¼ˆç¾ç‰©ï¼‰</div>
            {% with v=b.cash_spec %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
          <div class="sum-card">
            <div class="k">ğŸ’°ç¾é‡‘ï¼ˆä¿¡ç”¨ï¼‰</div>
            {% with v=b.cash_margin %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
          <div class="sum-card">
            <div class="k">ğŸ’°ç¾é‡‘ï¼ˆåˆè¨ˆï¼‰</div>
            {% with v=b.cash_total %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  <!-- ==== SBIã‚¿ãƒ– ==== -->
  <div class="real-panel" data-panel="sbi">
    <div class="section-title">SBIè¨¼åˆ¸ã‚µãƒãƒª</div>
    <div class="summary-grid">
      {% for b in agg_brokers %}
        {% if b.broker == 'SBI' %}
          <div class="sum-card">
            <div class="k">ä»¶æ•°</div>
            <div class="v mono">{{ b.n|intcomma }}</div>
          </div>
          <div class="sum-card">
            <div class="k">å‹ç‡</div>
            <div class="v mono">{{ b.win_rate|floatformat:1 }}%</div>
          </div>
          <div class="sum-card">
            <div class="k">ğŸ“ˆå®Ÿç¾æç›Š</div>
            {% with v=b.pnl %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
          <div class="sum-card">
            <div class="k">å¹³å‡å®Ÿç¾æç›Š(%)</div>
            {% if b.avg_pnl_pct is not None %}
              <div class="v mono">{{ b.avg_pnl_pct|floatformat:2 }}%</div>
            {% else %}
              <div class="v mono muted">â€”</div>
            {% endif %}
          </div>
          <div class="sum-card">
            <div class="k">å¹³å‡ä¿æœ‰æ—¥æ•°</div>
            {% if b.avg_hold_days is not None %}
              <div class="v mono">{{ b.avg_hold_days|floatformat:1 }} æ—¥</div>
            {% else %}
              <div class="v mono muted">â€”</div>
            {% endif %}
          </div>
          <div class="sum-card">
            <div class="k">ğŸ’°ç¾é‡‘ï¼ˆç¾ç‰©ï¼‰</div>
            {% with v=b.cash_spec %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
          <div class="sum-card">
            <div class="k">ğŸ’°ç¾é‡‘ï¼ˆä¿¡ç”¨ï¼‰</div>
            {% with v=b.cash_margin %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
          <div class="sum-card">
            <div class="k">ğŸ’°ç¾é‡‘ï¼ˆåˆè¨ˆï¼‰</div>
            {% with v=b.cash_total %}
              <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ v|floatformat:0|intcomma }}
              </div>
            {% endwith %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const root = document.getElementById("realSummaryRoot");
  if (!root) return;

  const tabs   = root.querySelectorAll(".real-tab");
  const panels = root.querySelectorAll(".real-panel");

  tabs.forEach(tab => {
    tab.addEventListener("click", () => {
      const target = tab.dataset.tab;
      tabs.forEach(t => t.classList.toggle("active", t === tab));
      panels.forEach(p => p.classList.toggle("active", p.dataset.panel === target));
    });
  });
});
</script>