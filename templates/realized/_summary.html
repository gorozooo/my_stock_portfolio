{% load humanize %}

<style>
  .summary-grid{display:grid;gap:12px;grid-template-columns:repeat(4,minmax(0,1fr))}
  .sum-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px}
  .k{font-size:12px;color:#a7b1d8;margin-bottom:6px}
  .v{font-size:18px;font-weight:700}
  .pos{color:#86efac} .neg{color:#fca5a5}
  .mono{font-variant-numeric: tabular-nums}

  /* è¨¼åˆ¸ä¼šç¤¾ã‚°ãƒªãƒƒãƒ‰ */
  .broker-grid{display:grid;gap:10px;grid-template-columns:repeat(4,minmax(0,1fr))}
  .bname{font-size:12px;color:#cbd5e1;margin-bottom:6px}
  @media (max-width: 1024px){
    .summary-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    .broker-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
</style>

<div class="summary-grid">
  <!-- ä»¶æ•° -->
  <div class="sum-card">
    <div class="k">ä»¶æ•°</div>
    <div class="v mono">{{ agg.n|intcomma }}</div>
  </div>

  <!-- å‹ç‡ -->
  <div class="sum-card">
    <div class="k">å‹ç‡</div>
    {% with v=agg.win_rate %}
      <div class="v mono">{% if v is not None %}{{ v|floatformat:1 }}%{% else %}â€”{% endif %}</div>
    {% endwith %}
  </div>

  <!-- PnLç´¯è¨ˆ -->
  <div class="sum-card">
    <div class="k">ğŸ“ˆPnLç´¯è¨ˆ</div>
    {% with v=agg.pnl %}
      <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ v|floatformat:0|intcomma }}</div>
    {% endwith %}
  </div>

  <!-- å¹³å‡PnL% -->
  <div class="sum-card">
    <div class="k">å¹³å‡PnL%</div>
    {% with v=agg.avg_pnl_pct %}
      <div class="v mono">{% if v is not None %}{{ v|floatformat:2 }}%{% else %}â€”{% endif %}</div>
    {% endwith %}
  </div>

  <!-- åˆ©ç›Šåˆè¨ˆ -->
  <div class="sum-card">
    <div class="k">åˆ©ç›Šåˆè¨ˆ</div>
    {% with v=agg.profit_total %}
      <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
        {% if v is not None %}Â¥{{ v|floatformat:0|intcomma }}{% else %}â€”{% endif %}
      </div>
    {% endwith %}
  </div>

  <!-- æå¤±åˆè¨ˆï¼ˆãƒã‚¤ãƒŠã‚¹ã®ã¾ã¾è¡¨ç¤ºã€‚çµ¶å¯¾å€¤ã§è¦‹ã›ãŸã„ãªã‚‰ |floatformat ã®å‰ã« |abs ã‚’ï¼‰ -->
  <div class="sum-card">
    <div class="k">æå¤±åˆè¨ˆ</div>
    {% with v=agg.loss_total %}
      <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
        {% if v is not None %}Â¥{{ v|floatformat:0|intcomma }}{% else %}â€”{% endif %}
      </div>
    {% endwith %}
  </div>

  <!-- PF -->
  <div class="sum-card">
    <div class="k">PFï¼ˆåˆ©ç›Š/|æå¤±|ï¼‰</div>
    {% with v=agg.pf %}
      <div class="v mono">{% if v %}{{ v|floatformat:2 }}{% else %}â€”{% endif %}</div>
    {% endwith %}
  </div>

  <!-- å¹³å‡ä¿æœ‰æ—¥æ•° -->
  <div class="sum-card">
    <div class="k">å¹³å‡ä¿æœ‰æ—¥æ•°</div>
    {% with v=agg.avg_holding_days %}
      <div class="v mono">{% if v is not None %}{{ v|floatformat:1 }} æ—¥{% else %}â€”{% endif %}</div>
    {% endwith %}
  </div>

  <!-- ç¾é‡‘ãƒ•ãƒ­ãƒ¼ï¼ˆç¾ç‰©/NISAï¼‰ -->
  <div class="sum-card">
    <div class="k">ğŸ’°ç¾é‡‘ãƒ•ãƒ­ãƒ¼ï¼ˆç¾ç‰©ï¼‰</div>
    {% with v=agg.cash_spec %}
      <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ v|floatformat:0|intcomma }}</div>
    {% endwith %}
  </div>

  <!-- ç¾é‡‘ãƒ•ãƒ­ãƒ¼ï¼ˆä¿¡ç”¨ï¼‰ -->
  <div class="sum-card">
    <div class="k">ğŸ’°ç¾é‡‘ãƒ•ãƒ­ãƒ¼ï¼ˆä¿¡ç”¨ï¼‰</div>
    {% with v=agg.cash_margin %}
      <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ v|floatformat:0|intcomma }}</div>
    {% endwith %}
  </div>

  <!-- ç¾é‡‘ãƒ•ãƒ­ãƒ¼åˆè¨ˆ ï¼ˆç¾ç‰©ï¼‹ä¿¡ç”¨ï¼‰-->
  <div class="sum-card">
    <div class="k">ğŸ’°ç¾é‡‘ãƒ•ãƒ­ãƒ¼åˆè¨ˆ </div>
    {% with v=agg.cash_total %}
      <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ v|floatformat:0|intcomma }}</div>
    {% endwith %}
  </div>

  <!-- æ‰‹æ•°æ–™åˆè¨ˆ -->
  <div class="sum-card">
    <div class="k">æ‰‹æ•°æ–™åˆè¨ˆ</div>
    <div class="v mono">Â¥{{ agg.fee|floatformat:0|intcomma }}</div>
  </div>
</div>

{# â”€â”€ è¨¼åˆ¸ä¼šç¤¾åˆ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
{% if agg_brokers|length > 0 %}
  <div style="margin-top:14px; font-size:12px; color:#94a3b8">è¨¼åˆ¸ä¼šç¤¾åˆ¥</div>
  <div class="broker-grid" style="margin-top:6px">
    {% for b in agg_brokers %}
      <div class="sum-card">
        <div class="bname">{{ b.broker_label|default:b.broker|default:"ãã®ä»–" }}</div>

        <div class="k">ä»¶æ•°</div>
        <div class="v mono">{{ b.n|default_if_none:"â€”" }}</div>

        <div class="k" style="margin-top:8px">å‹ç‡</div>
        {% with v=b.win_rate %}
          <div class="v mono">{% if v is not None %}{{ v|floatformat:1 }}%{% else %}â€”{% endif %}</div>
        {% endwith %}

        <div class="k" style="margin-top:8px">å¹³å‡PnL%</div>
        {% with v=b.avg_pnl_pct %}
          <div class="v mono">{% if v is not None %}{{ v|floatformat:2 }}%{% else %}â€”{% endif %}</div>
        {% endwith %}

        <div class="k" style="margin-top:8px">å¹³å‡ä¿æœ‰æ—¥æ•°</div>
        {% with v=b.avg_holding_days %}
          <div class="v mono">{% if v is not None %}{{ v|floatformat:1 }} æ—¥{% else %}â€”{% endif %}</div>
        {% endwith %}

        <div class="k" style="margin-top:8px">ğŸ“ˆPnL</div>
        {% with v=b.pnl %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ v|floatformat:0|intcomma }}</div>
        {% endwith %}

        <div class="k" style="margin-top:8px">åˆ©ç›Šåˆè¨ˆ</div>
        {% with v=b.profit_total %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
            {% if v is not None %}Â¥{{ v|floatformat:0|intcomma }}{% else %}â€”{% endif %}
          </div>
        {% endwith %}

        <div class="k" style="margin-top:8px">æå¤±åˆè¨ˆ</div>
        {% with v=b.loss_total %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">
            {% if v is not None %}Â¥{{ v|floatformat:0|intcomma }}{% else %}â€”{% endif %}
          </div>
        {% endwith %}

        <div class="k" style="margin-top:8px">PF</div>
        {% with v=b.pf %}
          <div class="v mono">{% if v %}{{ v|floatformat:2 }}{% else %}â€”{% endif %}</div>
        {% endwith %}

        <div class="k" style="margin-top:8px">ğŸ’°ç¾é‡‘ï¼ˆç¾ç‰©ï¼‰</div>
        {% with v=b.cash_spec %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ v|floatformat:0|intcomma }}</div>
        {% endwith %}

        <div class="k" style="margin-top:8px">ğŸ’°ç¾é‡‘ï¼ˆä¿¡ç”¨ï¼‰</div>
        {% with v=b.cash_margin %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ v|floatformat:0|intcomma }}</div>
        {% endwith %}

        <div class="k" style="margin-top:8px">ğŸ’°ç¾é‡‘ï¼ˆåˆè¨ˆï¼‰</div>
        {% with v=b.cash_total %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ v|floatformat:0|intcomma }}</div>
        {% endwith %}
      </div>
    {% endfor %}
  </div>
{% else %}
  <div style="margin-top:14px; font-size:12px; color:#94a3b8">è¨¼åˆ¸ä¼šç¤¾åˆ¥</div>
  <div class="sum-card" style="margin-top:6px">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
{% endif %}