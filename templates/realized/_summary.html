{# templates/realized/_summary.html #}
{% load humanize %}

<style>
  .summary-grid{display:grid;gap:12px;grid-template-columns:repeat(4,minmax(0,1fr))}
  .sum-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px}
  .k{font-size:12px;color:#a7b1d8;margin-bottom:6px}
  .v{font-size:18px;font-weight:700}
  .pos{color:#86efac} .neg{color:#fca5a5}
  .mono{font-variant-numeric: tabular-nums}
  .broker-grid{display:grid;gap:10px;grid-template-columns:repeat(4,minmax(0,1fr))}
  .bname{font-size:12px;color:#cbd5e1;margin-bottom:6px}
  @media (max-width: 1024px){
    .summary-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    .broker-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
</style>

<div class="summary-grid">
  <div class="sum-card">
    <div class="k">件数</div>
    <div class="v mono">{{ agg.n|intcomma }}</div>
  </div>

  <div class="sum-card">
    <div class="k">勝率(%)</div>
    <div class="v mono">{{ agg.win_rate|floatformat:1 }}%</div>
  </div>

  <div class="sum-card">
    <div class="k">📈実現損益累計</div>
    {% with v=agg.pnl %}
      <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">¥{{ v|floatformat:0|intcomma }}</div>
    {% endwith %}
  </div>

  <div class="sum-card">
    <div class="k">平均実現損益(%)</div>
    {% if agg.avg_pnl_pct is not None %}
      <div class="v mono">{{ agg.avg_pnl_pct|floatformat:2 }}%</div>
    {% else %}
      <div class="v mono">—</div>
    {% endif %}
  </div>

  <div class="sum-card">
    <div class="k">利益合計</div>
    <div class="v mono pos">¥{{ agg.profit_sum|default_if_none:0|floatformat:0|intcomma }}</div>
  </div>

  <div class="sum-card">
    <div class="k">損失合計</div>
    {% if agg.loss_sum is not None %}
      <div class="v mono neg">¥{{ agg.loss_sum|floatformat:0|intcomma }}</div>
    {% else %}
      <div class="v mono">—</div>
    {% endif %}
  </div>

  <div class="sum-card">
    <div class="k">PF（利益 / |損失|）</div>
    {% if agg.pf is not None %}
      {% if agg.pf == inf %}<div class="v mono">∞</div>{% else %}
        <div class="v mono">{{ agg.pf|floatformat:2 }}</div>
      {% endif %}
    {% elif agg.profit_sum and not agg.loss_sum %}
      <div class="v mono">∞</div>
    {% else %}
      <div class="v mono">—</div>
    {% endif %}
  </div>

  <div class="sum-card">
    <div class="k">平均保有日数</div>
    {% if agg.avg_hold_days is not None %}
      <div class="v mono">{{ agg.avg_hold_days|floatformat:1 }} 日</div>
    {% else %}
      <div class="v mono">—</div>
    {% endif %}
  </div>

  <div class="sum-card">
    <div class="k">💰現金フロー（現物）</div>
    {% with v=agg.cash_spec %}
      <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">¥{{ v|floatformat:0|intcomma }}</div>
    {% endwith %}
  </div>

  <div class="sum-card">
    <div class="k">💰現金フロー（信用）</div>
    {% with v=agg.cash_margin %}
      <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">¥{{ v|floatformat:0|intcomma }}</div>
    {% endwith %}
  </div>
  
  <div class="sum-card">
    <div class="k">💰現金フロー合計 </div>
    {% with v=agg.cash_total %}
      <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">¥{{ v|floatformat:0|intcomma }}</div>
    {% endwith %}
  </div>
  
  <div class="sum-card">
    <div class="k">手数料合計</div>
    <div class="v mono">¥{{ agg.fee|floatformat:0|intcomma }}</div>
  </div>

</div>

{% if agg_brokers %}
  <div style="margin-top:14px; font-size:12px; color:#94a3b8">証券会社別</div>
  <div class="broker-grid" style="margin-top:6px">
    {% for b in agg_brokers %}
      <div class="sum-card">
        <div class="bname">
          {% if b.broker == 'RAKUTEN' %}楽天証券
          {% elif b.broker == 'SBI' %}SBI証券
          {% elif b.broker == 'MATSUI' %}松井証券
          {% elif b.broker %}{{ b.broker }}
          {% else %}その他{% endif %}
        </div>

        <div class="k">件数</div>
        <div class="v mono">{{ b.n|intcomma }}</div>

        <div class="k" style="margin-top:8px">勝率</div>
        <div class="v mono">{{ b.win_rate|floatformat:1 }}%</div>

        <div class="k" style="margin-top:8px">平均PnL%</div>
        {% if b.avg_pnl_pct is not None %}
          <div class="v mono">{{ b.avg_pnl_pct|floatformat:2 }}%</div>
        {% else %}
          <div class="v mono">—</div>
        {% endif %}

        <div class="k" style="margin-top:8px">平均保有日数</div>
        {% if b.avg_hold_days is not None %}
          <div class="v mono">{{ b.avg_hold_days|floatformat:1 }} 日</div>
        {% else %}
          <div class="v mono">—</div>
        {% endif %}

        <div class="k" style="margin-top:8px">📈PnL</div>
        {% with v=b.pnl %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">¥{{ v|floatformat:0|intcomma }}</div>
        {% endwith %}

        <div class="k" style="margin-top:8px">💰現金（現物）</div>
        {% with v=b.cash_spec %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">¥{{ v|floatformat:0|intcomma }}</div>
        {% endwith %}

        <div class="k" style="margin-top:8px">💰現金（信用）</div>
        {% with v=b.cash_margin %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">¥{{ v|floatformat:0|intcomma }}</div>
        {% endwith %}

        <div class="k" style="margin-top:8px">💰現金（合計）</div>
        {% with v=b.cash_total %}
          <div class="v mono {% if v >= 0 %}pos{% else %}neg{% endif %}">¥{{ v|floatformat:0|intcomma }}</div>
        {% endwith %}
      </div>
    {% endfor %}
  </div>
{% else %}
  <div style="margin-top:14px; font-size:12px; color:#94a3b8">証券会社別</div>
  <div class="sum-card" style="margin-top:6px">データなし</div>
{% endif %}