{# templates/realized/_summary_period.html #}
{% load humanize %}
<style>
  .period-wrap{margin-top:14px}
  .period-head{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .btn{font-size:12px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:8px;background:transparent;color:#e5e7eb}
  .btn[aria-current="true"]{background:rgba(255,255,255,.10)}

  .tbl{width:100%;border-collapse:separate;border-spacing:0}
  .tbl th,.tbl td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.08)}
  .tbl thead th{font-size:12px;color:#a7b1d8;text-align:right;white-space:nowrap}
  .tbl thead th:first-child,
  .tbl tbody td:first-child{
    text-align:left;
    white-space:nowrap;
  }
  .tbl .num{
    text-align:right;
    white-space:nowrap;
    font-variant-numeric:tabular-nums;
  }
  .pos{color:#86efac}
  .neg{color:#fca5a5}
  .tbl tbody tr.is-focus > td{
    background:rgba(59,130,246,.10);
  }

  /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ãƒ©ãƒƒãƒ‘ã¨æœ€å°å¹… */
  .h-scroll{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  .tbl-wide{
    min-width:880px;
  }
</style>

<div id="pnlPeriodWrap" class="period-wrap"
     data-preset="{{ preset }}" data-freq="{{ freq }}">

  {# ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç­‰ãŒ hx-include ã§æ‹¾ã†ãŸã‚ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ #}
  <input type="hidden" name="preset" id="periodPreset" value="{{ preset }}">
  <input type="hidden" name="freq"   id="periodFreq"   value="{{ freq }}">
  <input type="hidden" name="start"  id="periodStart"
         value="{% if start %}{{ start|date:'Y-m-d' }}{% endif %}">
  <input type="hidden" name="end"    id="periodEnd"
         value="{% if end %}{{ end|date:'Y-m-d' }}{% endif %}">

  <div class="period-head">
    <div style="font-size:12px;color:#a7b1d8">æœŸé–“ã¾ã¨ã‚</div>

    <button class="btn"
            hx-get="{% url 'realized_summary_period' %}?preset=THIS_MONTH&freq={{ freq }}&q={{ q|urlencode }}"
            hx-target="#pnlPeriodWrap" hx-swap="outerHTML"
            aria-current="{% if preset == 'THIS_MONTH' %}true{% else %}false{% endif %}">
      ä»Šæœˆ
    </button>
    <button class="btn"
            hx-get="{% url 'realized_summary_period' %}?preset=THIS_YEAR&freq={{ freq }}&q={{ q|urlencode }}"
            hx-target="#pnlPeriodWrap" hx-swap="outerHTML"
            aria-current="{% if preset == 'THIS_YEAR' %}true{% else %}false{% endif %}">
      ä»Šå¹´
    </button>
    <button class="btn"
            hx-get="{% url 'realized_summary_period' %}?preset=LAST_12M&freq={{ freq }}&q={{ q|urlencode }}"
            hx-target="#pnlPeriodWrap" hx-swap="outerHTML"
            aria-current="{% if preset == 'LAST_12M' %}true{% else %}false{% endif %}">
      éå»12ãƒ¶æœˆ
    </button>

    <button class="btn"
            hx-get="{% url 'realized_summary_period' %}?preset={{ preset }}&freq=month&q={{ q|urlencode }}"
            hx-target="#pnlPeriodWrap" hx-swap="outerHTML"
            aria-current="{% if freq == 'month' %}true{% else %}false{% endif %}">
      æœˆæ¬¡
    </button>
    <button class="btn"
            hx-get="{% url 'realized_summary_period' %}?preset={{ preset }}&freq=year&q={{ q|urlencode }}"
            hx-target="#pnlPeriodWrap" hx-swap="outerHTML"
            aria-current="{% if freq == 'year' %}true{% else %}false{% endif %}">
      å¹´æ¬¡
    </button>

    <button id="btnClearFocus" class="btn" type="button"
            style="display:{% if focus %}block{% else %}none{% endif %}">
      å…¨ä½“ã«æˆ»ã‚‹
    </button>
  </div>

  {# â”€ é¸æŠã‚µãƒãƒªãƒ¼ â”€ #}
  <div id="periodSelectedBox">
    {% if selected %}
      <div class="rounded-xl p-3 mb-2"
           style="border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)">
        <div class="text-xs text-slate-400 mb-1">
          é¸æŠ: {{ selected.label }}
        </div>
        <div class="grid grid-cols-2 gap-2 text-[14px]">
          <div>ä»¶æ•°: {{ selected.n|intcomma }}</div>
          <div>æ•°é‡: {{ selected.qty|intcomma }}</div>
          <div>æ‰‹æ•°æ–™: Â¥{{ selected.fee|floatformat:0|intcomma }}</div>
          <div>ğŸ“ˆPnL:
            <span class="{% if selected.pnl >= 0 %}pos{% else %}neg{% endif %}">
              Â¥{{ selected.pnl|floatformat:0|intcomma }}
            </span>
          </div>
          <div>ğŸ’°ç¾é‡‘(ç¾ç‰©):
            <span class="{% if selected.cash_spec >= 0 %}pos{% else %}neg{% endif %}">
              Â¥{{ selected.cash_spec|floatformat:0|intcomma }}
            </span>
          </div>
          <div>ğŸ’°ç¾é‡‘(ä¿¡ç”¨):
            <span class="{% if selected.cash_margin >= 0 %}pos{% else %}neg{% endif %}">
              Â¥{{ selected.cash_margin|floatformat:0|intcomma }}
            </span>
          </div>
          <div class="col-span-2">ğŸ’°ç¾é‡‘(åˆè¨ˆ):
            <span class="{% if selected.cash_total >= 0 %}pos{% else %}neg{% endif %}">
              Â¥{{ selected.cash_total|floatformat:0|intcomma }}
            </span>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  {# â–¼ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ©ãƒƒãƒ‘ã§åŒ…ã‚€ â–¼ #}
  <div class="h-scroll">
    <table class="tbl tbl-wide">
      <thead>
        <tr>
          <th>æœŸé–“</th>
          <th>ä»¶æ•°</th>
          <th>æ•°é‡</th>
          <th>æ‰‹æ•°æ–™</th>
          <th>ğŸ’°ç¾é‡‘(ç¾ç‰©)</th>
          <th>ğŸ’°ç¾é‡‘(ä¿¡ç”¨)</th>
          <th>ğŸ’°ç¾é‡‘(åˆè¨ˆ)</th>
          <th>ğŸ“ˆPnL</th>
        </tr>
      </thead>
      <tbody class="text-[15px]">
        {% if rows %}
          {% for r in rows %}
            <tr
              data-period="{{ r.label }}"
              data-n="{{ r.n }}"
              data-qty="{{ r.qty }}"
              data-fee="{{ r.fee }}"
              data-cash-spec="{{ r.cash_spec }}"
              data-cash-margin="{{ r.cash_margin }}"
              data-cash-total="{{ r.cash_total }}"
              data-pnl="{{ r.pnl }}"
              class="{% if focus and r.label == focus %}is-focus{% endif %}">
              <td>{{ r.label }}</td>
              <td class="num">{{ r.n|intcomma }}</td>
              <td class="num">{{ r.qty|intcomma }}</td>
              <td class="num">Â¥{{ r.fee|floatformat:0|intcomma }}</td>
              <td class="num">
                {% with v=r.cash_spec %}
                  <span class="{% if v >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ v|floatformat:0|intcomma }}
                  </span>
                {% endwith %}
              </td>
              <td class="num">
                {% with v=r.cash_margin %}
                  <span class="{% if v >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ v|floatformat:0|intcomma }}
                  </span>
                {% endwith %}
              </td>
              <td class="num">
                {% with v=r.cash_total %}
                  <span class="{% if v >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ v|floatformat:0|intcomma }}
                  </span>
                {% endwith %}
              </td>
              <td class="num">
                {% with v=r.pnl %}
                  <span class="{% if v >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ v|floatformat:0|intcomma }}
                  </span>
                {% endwith %}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="8" style="color:#94a3b8">ãƒ‡ãƒ¼ã‚¿ãªã—</td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<script>
(function(){
  const wrap = document.getElementById('pnlPeriodWrap');
  if (!wrap) return;

  const selBox  = document.getElementById('periodSelectedBox');
  const btnClear = document.getElementById('btnClearFocus');

  const yen = v => 'Â¥' + Number(v || 0).toLocaleString();

  function buildSelectedHTML(row){
    const d = row.dataset;
    const pnl = Number(d.pnl || 0);
    const cs  = Number(d.cashSpec || d['cash-spec'] || 0);
    const cm  = Number(d.cashMargin || d['cash-margin'] || 0);
    const ct  = Number(d.cashTotal || d['cash-total'] || (cs + cm));
    const cls = v => (Number(v) >= 0 ? 'pos' : 'neg');

    return `
      <div class="rounded-xl p-3 mb-2"
           style="border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)">
        <div class="text-xs text-slate-400 mb-1">é¸æŠ: ${d.period || ''}</div>
        <div class="grid grid-cols-2 gap-2 text-[14px]">
          <div>ä»¶æ•°: ${Number(d.n || 0).toLocaleString()}</div>
          <div>æ•°é‡: ${Number(d.qty || 0).toLocaleString()}</div>
          <div>æ‰‹æ•°æ–™: ${yen(d.fee)}</div>
          <div>ğŸ“ˆPnL: <span class="${cls(pnl)}">${yen(pnl)}</span></div>
          <div>ğŸ’°ç¾é‡‘(ç¾ç‰©): <span class="${cls(cs)}">${yen(cs)}</span></div>
          <div>ğŸ’°ç¾é‡‘(ä¿¡ç”¨): <span class="${cls(cm)}">${yen(cm)}</span></div>
          <div class="col-span-2">ğŸ’°ç¾é‡‘(åˆè¨ˆ): <span class="${cls(ct)}">${yen(ct)}</span></div>
        </div>
      </div>
    `;
  }

  function clearFocus(){
    wrap.querySelectorAll('tbody tr').forEach(tr =>
      tr.classList.remove('is-focus')
    );
    selBox.innerHTML = '';
    if (btnClear) btnClear.style.display = 'none';
  }

  function focusLabel(label){
    let target = null;
    wrap.querySelectorAll('tbody tr[data-period]').forEach(tr => {
      const hit = (tr.dataset.period === label);
      tr.classList.toggle('is-focus', hit);
      if (hit) target = tr;
    });
    if (target){
      selBox.innerHTML = buildSelectedHTML(target);
      if (btnClear) btnClear.style.display = '';
      try{
        target.scrollIntoView({behavior:'smooth', block:'center'});
      }catch(e){}
    }
  }

  // è¡Œã‚¿ãƒƒãƒ—ã§ä¸Šéƒ¨ã‚µãƒãƒªãƒ¼ï¼†è¡Œãƒã‚¤ãƒ©ã‚¤ãƒˆ
  wrap.addEventListener('click', (e)=>{
    const tr = e.target.closest('tbody tr[data-period]');
    if (!tr) return;
    focusLabel(tr.dataset.period);
  });

  // ãƒãƒ£ãƒ¼ãƒˆã‹ã‚‰ã®é€šçŸ¥ã§ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
  document.addEventListener('pnl:focus-period', (e)=>{
    if (e.detail && e.detail.label){
      focusLabel(e.detail.label);
    }
  });

  // å…¨ä½“ã«æˆ»ã‚‹
  btnClear?.addEventListener('click', clearFocus);

  // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç­‰æ›´æ–°ã®ãƒˆãƒªã‚¬ãƒ¼ï¼ˆç·åˆã‚¿ãƒ–å†…ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ‹¾ã†ï¼‰
  const fireRefresh = () => {
    const ev = new Event('pnl:refresh');
    document.body.dispatchEvent(ev);
  };
  fireRefresh();

  document.addEventListener('htmx:afterSwap', ev => {
    if (ev.target && ev.target.id === 'pnlPeriodWrap'){
      fireRefresh();
    }
  });
})();
</script>