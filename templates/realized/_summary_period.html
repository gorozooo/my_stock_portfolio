{# templates/realized/_summary_period.html #}
{% load humanize %}
<style>
  .period-wrap{margin-top:14px}
  .period-head{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .btn{font-size:12px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:8px;background:transparent;color:#e5e7eb}
  .btn[aria-current="true"]{background:rgba(255,255,255,.10)}
  .tbl{width:100%;border-collapse:separate;border-spacing:0}
  .tbl th,.tbl td{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.08)}
  .tbl thead th{font-size:12px;color:#a7b1d8;text-align:right}
  .tbl thead th:first-child,.tbl tbody td:first-child{text-align:left}
  .pos{color:#86efac} .neg{color:#fca5a5}
  .is-focus{background:rgba(59,130,246,.10)}
</style>

{# â˜… ã‚°ãƒ©ãƒ•å´ãŒ preset/freq ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã† data-* ã‚’ä»˜ä¸ #}
<div id="pnlPeriodWrap" class="period-wrap" data-preset="{{ preset }}" data-freq="{{ freq }}">
  <div class="period-head">
    <div style="font-size:12px;color:#a7b1d8">æœŸé–“ã¾ã¨ã‚</div>

    {# ãƒ—ãƒªã‚»ãƒƒãƒˆåˆ‡æ›¿ï¼ˆã‚µãƒ¼ãƒé›†è¨ˆã‚’ä½¿ã†é€šå¸¸åˆ‡æ›¿ï¼‰ #}
    <button class="btn"
            hx-get="{% url 'realized_summary_period' %}?preset=THIS_MONTH&freq={{ freq }}&q={{ q|urlencode }}"
            hx-target="#pnlPeriodWrap" hx-swap="outerHTML"
            aria-current="{% if preset == 'THIS_MONTH' %}true{% else %}false{% endif %}">
      ä»Šæœˆ
    </button>
    <button class="btn"
            hx-get="{% url 'realized_summary_period' %}?preset=THIS_YEAR&freq={{ freq }}&q={{ q|urlencode }}"
            hx-target="#pnlPeriodWrap" hx-swap="outerHTML"
            aria-current="{% if preset == 'THIS_YEAR' %}true{% else %}false{% endif %}">
      ä»Šå¹´
    </button>
    <button class="btn"
            hx-get="{% url 'realized_summary_period' %}?preset=LAST_12M&freq={{ freq }}&q={{ q|urlencode }}"
            hx-target="#pnlPeriodWrap" hx-swap="outerHTML"
            aria-current="{% if preset == 'LAST_12M' %}true{% else %}false{% endif %}">
      éå»12ãƒ¶æœˆ
    </button>

    {# ç²’åº¦åˆ‡æ›¿ #}
    <button class="btn"
            hx-get="{% url 'realized_summary_period' %}?preset={{ preset }}&freq=month&q={{ q|urlencode }}"
            hx-target="#pnlPeriodWrap" hx-swap="outerHTML"
            aria-current="{% if freq == 'month' %}true{% else %}false{% endif %}">
      æœˆæ¬¡
    </button>
    <button class="btn"
            hx-get="{% url 'realized_summary_period' %}?preset={{ preset }}&freq=year&q={{ q|urlencode }}"
            hx-target="#pnlPeriodWrap" hx-swap="outerHTML"
            aria-current="{% if freq == 'year' %}true{% else %}false{% endif %}">
      å¹´æ¬¡
    </button>

    {# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ãƒ•ã‚©ãƒ¼ã‚«ã‚¹è§£é™¤ãƒœã‚¿ãƒ³ï¼ˆå¾Œè¿°JSã§åˆ¶å¾¡ï¼‰ #}
    <button id="btnClearFocus" class="btn" type="button" style="display:none">å…¨ä½“ã«æˆ»ã‚‹</button>
  </div>

  {# â”€ é¸æŠã‚µãƒãƒªãƒ¼ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚‚å·®ã—æ›¿ãˆã‚‹ï¼‰ â”€ #}
  <div id="periodSelectedBox">
    {% if selected %}
      <div class="rounded-xl p-3 mb-2"
           style="border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)">
        <div class="text-xs text-slate-400 mb-1">é¸æŠ: {{ selected.label }}</div>
        <div class="grid grid-cols-2 gap-2 text-[14px]">
          <div>ä»¶æ•°: {{ selected.n|intcomma }}</div>
          <div>æ•°é‡: {{ selected.qty|intcomma }}</div>
          <div>æ‰‹æ•°æ–™: Â¥{{ selected.fee|floatformat:0|intcomma }}</div>
          <div>ğŸ“ˆPnL: <span class="{% if selected.pnl >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ selected.pnl|floatformat:0|intcomma }}</span></div>
          <div>ğŸ’°ç¾é‡‘(ç¾ç‰©): <span class="{% if selected.cash_spec >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ selected.cash_spec|floatformat:0|intcomma }}</span></div>
          <div>ğŸ’°ç¾é‡‘(ä¿¡ç”¨): <span class="{% if selected.cash_margin >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ selected.cash_margin|floatformat:0|intcomma }}</span></div>
          <div class="col-span-2">ğŸ’°ç¾é‡‘(åˆè¨ˆ): <span class="{% if selected.cash_total >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ selected.cash_total|floatformat:0|intcomma }}</span></div>
        </div>
      </div>
    {% endif %}
  </div>

  <table class="tbl">
    <thead>
      <tr>
        <th>æœŸé–“</th>
        <th>ä»¶æ•°</th>
        <th>æ•°é‡</th>
        <th>æ‰‹æ•°æ–™</th>
        <th>ğŸ’°ç¾é‡‘(ç¾ç‰©)</th>
        <th>ğŸ’°ç¾é‡‘(ä¿¡ç”¨)</th>
        <th>ğŸ’°ç¾é‡‘(åˆè¨ˆ)</th>
        <th>ğŸ“ˆPnL</th>
      </tr>
    </thead>
    <tbody class="text-[15px]">
      {% if rows %}
        {% for r in rows %}
          {# â˜… è¡Œã«é›†è¨ˆå€¤ã‚’ data-* ã§åŸ‹ã‚è¾¼ã¿ï¼ˆJSã§é¸æŠãƒœãƒƒã‚¯ã‚¹ã‚’å³æ™‚ç”Ÿæˆï¼‰ #}
          <tr
            data-period="{{ r.label }}"
            data-n="{{ r.n }}"
            data-qty="{{ r.qty }}"
            data-fee="{{ r.fee }}"
            data-cash-spec="{{ r.cash_spec }}"
            data-cash-margin="{{ r.cash_margin }}"
            data-cash-total="{{ r.cash_total }}"
            data-pnl="{{ r.pnl }}"
            class="{% if focus and r.label == focus %}is-focus{% endif %}">
            <td>{{ r.label }}</td>
            <td style="text-align:right">{{ r.n|intcomma }}</td>
            <td style="text-align:right">{{ r.qty|intcomma }}</td>
            <td style="text-align:right">Â¥{{ r.fee|floatformat:0|intcomma }}</td>
            <td style="text-align:right">
              {% with v=r.cash_spec %}<span class="{% if v >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ v|floatformat:0|intcomma }}</span>{% endwith %}
            </td>
            <td style="text-align:right">
              {% with v=r.cash_margin %}<span class="{% if v >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ v|floatformat:0|intcomma }}</span>{% endwith %}
            </td>
            <td style="text-align:right">
              {% with v=r.cash_total %}<span class="{% if v >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ v|floatformat:0|intcomma }}</span>{% endwith %}
            </td>
            <td style="text-align:right">
              {% with v=r.pnl %}<span class="{% if v >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ v|floatformat:0|intcomma }}</span>{% endwith %}
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="8" style="color:#94a3b8">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ã‚°ãƒ©ãƒ•ã® onClick ã¯ã€Œpnl:focus-period {detail:{label:'YYYY-MM'}}ã€
   ã‚’ç™ºç«ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£æ¸ˆã¿ã€‚ã“ã“ã§è¡Œãƒã‚¤ãƒ©ã‚¤ãƒˆï¼†ä¸Šéƒ¨ãƒœãƒƒã‚¯ã‚¹æ›´æ–°ã€‚
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function(){
  const wrap = document.getElementById('pnlPeriodWrap');
  if (!wrap) return;

  const selBox = document.getElementById('periodSelectedBox');
  const btnClear = document.getElementById('btnClearFocus');

  function yen(v){ try{ return 'Â¥' + Number(v).toLocaleString(); }catch(e){ return 'Â¥0'; } }

  function buildSelectedHTML(row){
    const label = row.dataset.period || '';
    const n     = row.dataset.n || 0;
    const qty   = row.dataset.qty || 0;
    const fee   = row.dataset.fee || 0;
    const pnl   = Number(row.dataset.pnl || 0);
    const cs    = Number(row.dataset['cashSpec'] || row.dataset.cashSpec || 0);
    const cm    = Number(row.dataset['cashMargin'] || row.dataset.cashMargin || 0);
    const ct    = Number(row.dataset['cashTotal'] || row.dataset.cashTotal || (cs+cm));

    const pnlCls = pnl >= 0 ? 'pos' : 'neg';
    const csCls  = cs  >= 0 ? 'pos' : 'neg';
    const cmCls  = cm  >= 0 ? 'pos' : 'neg';
    const ctCls  = ct  >= 0 ? 'pos' : 'neg';

    return `
      <div class="rounded-xl p-3 mb-2" style="border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)">
        <div class="text-xs text-slate-400 mb-1">é¸æŠ: ${label}</div>
        <div class="grid grid-cols-2 gap-2 text-[14px]">
          <div>ä»¶æ•°: ${Number(n).toLocaleString()}</div>
          <div>æ•°é‡: ${Number(qty).toLocaleString()}</div>
          <div>æ‰‹æ•°æ–™: ${yen(fee)}</div>
          <div>ğŸ“ˆPnL: <span class="${pnlCls}">${yen(pnl)}</span></div>
          <div>ğŸ’°ç¾é‡‘(ç¾ç‰©): <span class="${csCls}">${yen(cs)}</span></div>
          <div>ğŸ’°ç¾é‡‘(ä¿¡ç”¨): <span class="${cmCls}">${yen(cm)}</span></div>
          <div class="col-span-2">ğŸ’°ç¾é‡‘(åˆè¨ˆ): <span class="${ctCls}">${yen(ct)}</span></div>
        </div>
      </div>
    `;
  }

  function clearFocus(){
    wrap.querySelectorAll('tbody tr').forEach(tr => tr.classList.remove('is-focus'));
    if (selBox) selBox.innerHTML = '';
    if (btnClear) btnClear.style.display = 'none';
  }

  function focusLabel(label){
    let target = null;
    wrap.querySelectorAll('tbody tr').forEach(tr=>{
      const hit = (tr.dataset.period === label);
      tr.classList.toggle('is-focus', hit);
      if (hit) target = tr;
    });
    if (target && selBox){
      selBox.innerHTML = buildSelectedHTML(target);
      if (btnClear) btnClear.style.display = '';
      // è¡¨ã®è©²å½“è¡Œã¸è»½ãã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆä¸Šéƒ¨ãƒœãƒƒã‚¯ã‚¹ã¯æ®‹ã™ï¼‰
      target.scrollIntoView({behavior:'smooth', block:'center'});
    }
  }

  // è¡Œã‚¿ãƒƒãƒ—ã§ã‚‚åŒæ§˜ã®æŒ™å‹•
  wrap.addEventListener('click', (e)=>{
    const tr = e.target.closest('tbody tr[data-period]');
    if (!tr) return;
    focusLabel(tr.dataset.period);
  });

  // ã‚°ãƒ©ãƒ•ã‹ã‚‰ã®é€šçŸ¥
  document.addEventListener('pnl:focus-period', (e)=>{
    if (!e.detail || !e.detail.label) return;
    focusLabel(e.detail.label);
  });

  // å…¨ä½“ã«æˆ»ã‚‹
  btnClear?.addEventListener('click', clearFocus);

  // ã‚µãƒ¼ãƒã‹ã‚‰ focus/selected ãŒæœ€åˆã«æ¸¡ã£ã¦ããŸå ´åˆã¯ã€ãã®ã¾ã¾ãƒœã‚¿ãƒ³è¡¨ç¤º
  {% if focus %} if (btnClear) btnClear.style.display = ''; {% endif %}
})();
</script>