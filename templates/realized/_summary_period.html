@login_required
@require_GET
def summary_period_partial(request):
    """
    月次/年次で 📈PnL と 💰現金（現物/信用/合計）を集計して返す。
    - 現物(NISA含む)の現金フロー: cashflow_calc
    - 信用の現金フロー        : pnl_display（手入力PnL）
    """
    q = (request.GET.get("q") or "").strip()
    freq = (request.GET.get("freq") or "month").lower()
    start, end, preset = _parse_period(request)
    focus = (request.GET.get("focus") or "").strip()

    qs = RealizedTrade.objects.filter(user=request.user)
    if q:
        qs = qs.filter(Q(ticker__icontains=q) | Q(name__icontains=q))
    if start:
        qs = qs.filter(trade_at__gte=start)
    if end:
        qs = qs.filter(trade_at__lte=end)

    qs = _with_metrics(qs)

    if freq == "year":
        bucket = TruncYear("trade_at")
        label_fmt = "%Y"
    else:
        bucket = TruncMonth("trade_at")
        label_fmt = "%Y-%m"

    grouped = (
        qs.annotate(period=bucket)
          .values("period")
          .annotate(
              n   = Coalesce(Count("id"), Value(0), output_field=IntegerField()),
              qty = Coalesce(Sum("qty"), Value(0), output_field=IntegerField()),
              fee = Coalesce(
                      Sum(Coalesce(F("fee"), Value(Decimal("0"), output_field=DEC2))),
                      Value(Decimal("0"), output_field=DEC2)
              ),
              # 現物/NISA は受渡金ベース
              cash_spec = Coalesce(
                  Sum(Case(
                      When(account__in=["SPEC", "NISA"], then=F("cashflow_calc")),
                      default=Value(Decimal("0")),
                      output_field=DEC2,
                  )),
                  Value(Decimal("0"), output_field=DEC2)
              ),
              # 信用は “手入力の実現損益” ベース
              cash_margin = Coalesce(
                  Sum(Case(
                      When(account="MARGIN", then=F("pnl_display")),
                      default=Value(Decimal("0")),
                      output_field=DEC2,
                  )),
                  Value(Decimal("0"), output_field=DEC2)
              ),
              pnl = Coalesce(Sum("pnl_display", output_field=DEC2),
                             Value(Decimal("0"), output_field=DEC2)),
          )
          .order_by("period")
    )

    rows = []
    for r in grouped:
        cash_total = (r["cash_spec"] or Decimal("0")) + (r["cash_margin"] or Decimal("0"))
        rows.append({
            "period": r["period"],
            "label": r["period"].strftime(label_fmt) if r["period"] else "",
            "n": r["n"],
            "qty": r["qty"],
            "fee": r["fee"],
            "cash_spec": r["cash_spec"],
            "cash_margin": r["cash_margin"],
            "cash_total": cash_total,
            "pnl": r["pnl"],
        })

    selected = None
    if focus:
        selected = next((rr for rr in rows if rr["label"] == focus), None)

    ctx = {
        "rows": rows,
        "preset": preset,
        "freq": freq,
        "start": start,
        "end": end,
        "q": q,
        "focus": focus,
        "selected": selected,
    }
    return render(request, "realized/_summary_period.html", ctx)