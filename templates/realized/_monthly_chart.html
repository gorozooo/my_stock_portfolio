{# templates/realized/_monthly_chart.html #}
<div class="mt-6 rounded-2xl bg-white/5 p-3">
  <div class="flex items-center justify-between mb-2">
    <div class="text-sm text-slate-300">æœˆæ¬¡ã‚µãƒãƒªãƒ¼</div>
    <div class="text-xs text-slate-400">ğŸ“ˆ PnLï¼ˆæŠ•è³‡å®¶æç›Šï¼‰ / ğŸ’° ç¾é‡‘ãƒ•ãƒ­ãƒ¼</div>
  </div>
  <div id="pnlChartWrap" style="height:240px">
    <canvas id="pnlChart" style="width:100%;height:100%"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function () {
  // äºŒé‡ãƒã‚¤ãƒ³ãƒ‰é˜²æ­¢
  if (window.__pnlChartBound) return;
  window.__pnlChartBound = true;

  // iOS Safari ã§éå‰°ã«è§£åƒåº¦ãŒä¸ŠãŒã£ã¦ã‚µã‚¤ã‚ºãŒè†¨ã‚‰ã‚€ã®ã‚’æŠ‘æ­¢
  if (window.Chart && Chart.defaults) {
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    Chart.defaults.animation = false;
    Chart.defaults.devicePixelRatio = 1;
  }

  const canvas = document.getElementById('pnlChart');
  if (!canvas) return;

  let chart = null;
  let drawTimer = null;

  async function fetchData() {
    const qEl = document.querySelector('#q');
    const q   = qEl ? encodeURIComponent(qEl.value || '') : '';
    const res = await fetch("{% url 'realized_chart_monthly' %}?q=" + q, { credentials: 'same-origin' });
    return await res.json();
  }

  async function draw() {
    // é€£æ‰“å¯¾ç­–ï¼ˆ150ms ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
    clearTimeout(drawTimer);
    drawTimer = setTimeout(async () => {
      try {
        const data = await fetchData();
        if (chart) {
          chart.destroy();
          chart = null;
        }
        const ctx = canvas.getContext('2d');
        chart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: data.labels,
            datasets: [
              { label: 'ğŸ“ˆPnL',  data: data.pnl,  borderWidth: 0, backgroundColor: 'rgba(16,185,129,0.65)' },
              { label: 'ğŸ’°ç¾é‡‘', data: data.cash, borderWidth: 0, backgroundColor: 'rgba(59,130,246,0.55)' },
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { labels: { color: '#e5e7eb' } },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const v = ctx.parsed.y ?? 0;
                    return `${ctx.dataset.label}: Â¥` + Number(v).toLocaleString();
                  }
                }
              }
            },
            scales: {
              x: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,0.12)' } },
              y: { ticks: { color: '#cbd5e1', callback: (v)=> 'Â¥' + Number(v).toLocaleString() },
                   grid: { color: 'rgba(148,163,184,0.12)' } }
            }
          }
        });
      } catch (e) {
        console.error(e);
      }
    }, 150);
  }

  // åˆå›æç”»
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', draw, { once: true });
  } else {
    draw();
  }

  // æ¤œç´¢ã§å†æç”»ï¼ˆEnter / blur / changeï¼‰
  const qEl = document.querySelector('#q');
  if (qEl) {
    ['change','blur','keydown'].forEach(ev => {
      qEl.addEventListener(ev, (e) => {
        if (ev !== 'keydown' || e.key === 'Enter') draw();
      });
    });
  }

  // HTMX ã§è©²å½“é ˜åŸŸãŒå·®ã—æ›¿ã‚ã£ãŸã‚‰å†æç”»
  document.body.addEventListener('htmx:afterSwap', function (e) {
    const id = e.target && e.target.id;
    if (id === 'pnlTableWrap' || id === 'pnlSummaryWrap' || id === 'pnlPeriodWrap') {
      draw();
    }
  });

  // ã‚¿ãƒ–å¾©å¸°æ™‚ã«ã‚µã‚¤ã‚ºãŒç‹‚ã£ãŸã‚‰å†æç”»
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) draw();
  });
})();
</script>