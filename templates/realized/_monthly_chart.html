{# templates/realized/_monthly_chart.html #}
<div class="mt-6 rounded-2xl bg-white/5 p-3">
  <div class="flex items-center justify-between mb-2">
    <div class="text-sm text-slate-300">月次サマリー</div>
    <div class="text-xs text-slate-400">📈 PnL（投資家損益） / 💰 現金フロー</div>
  </div>
  <div id="pnlChartWrap" style="height:240px">
    <canvas id="pnlChart" style="width:100%;height:100%"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function () {
  if (window.__pnlChartBound) return;
  window.__pnlChartBound = true;

  const canvas = document.getElementById('pnlChart');
  if (!canvas) return;

  let chart = null;
  let timer = null;

  async function fetchData() {
    const qEl = document.querySelector('#q');
    const q = qEl ? encodeURIComponent(qEl.value || '') : '';
    const res = await fetch("{% url 'realized_chart_monthly' %}?q=" + q, {credentials: 'same-origin'});
    return await res.json();
  }

  async function draw() {
    clearTimeout(timer);
    timer = setTimeout(async () => {
      try {
        const data = await fetchData();

        if (chart) { chart.destroy(); chart = null; }

        const ctx = canvas.getContext('2d');

        // 高精細ディスプレイは 2x までにしてクッキリ＆過負荷防止
        const dpr = Math.min(2, window.devicePixelRatio || 1);

        chart = new Chart(ctx, {
          type: 'bar', // デフォは棒、PnLは個別に line 指定
          data: {
            labels: data.labels,
            datasets: [
              {
                type: 'line',
                label: '📈PnL',
                data: data.pnl,
                borderWidth: 2,
                pointRadius: 2,
                pointHoverRadius: 4,
                tension: 0.25,
                borderColor: 'rgba(16,185,129,1)',    // 緑系
                backgroundColor: 'rgba(16,185,129,0.15)',
                yAxisID: 'y',
              },
              {
                type: 'bar',
                label: '💰現金',
                data: data.cash,
                borderWidth: 0,
                backgroundColor: 'rgba(59,130,246,0.55)', // 青系
                yAxisID: 'y',
              },
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            devicePixelRatio: dpr,
            interaction: { mode: 'index', intersect: false },
            animation: { duration: 200 },
            plugins: {
              legend: { labels: { color: '#e5e7eb' } },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const v = ctx.parsed.y ?? 0;
                    return `${ctx.dataset.label}: ¥` + Number(v).toLocaleString();
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: { color: '#cbd5e1' },
                grid:  { color: 'rgba(148,163,184,0.12)' }
              },
              y: {
                beginAtZero: true,
                ticks: { color: '#cbd5e1', callback: v => '¥' + Number(v).toLocaleString() },
                grid:  { color: 'rgba(148,163,184,0.12)' }
              }
            }
          }
        });
      } catch (e) {
        console.error(e);
      }
    }, 120);
  }

  // 初回
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', draw, { once: true });
  } else {
    draw();
  }

  // 検索で再描画（Enter/blur/change）
  const qEl = document.querySelector('#q');
  if (qEl) {
    ['change','blur','keydown'].forEach(ev => {
      qEl.addEventListener(ev, (e) => {
        if (ev !== 'keydown' || e.key === 'Enter') draw();
      });
    });
  }

  // HTMX差し替え時も再描画
  document.body.addEventListener('htmx:afterSwap', (e) => {
    const id = e.target && e.target.id;
    if (id === 'pnlTableWrap' || id === 'pnlSummaryWrap' || id === 'pnlPeriodWrap') draw();
  });

  // タブ復帰で再調整
  document.addEventListener('visibilitychange', () => { if (!document.hidden) draw(); });
})();
</script>