{# templates/realized/_monthly_chart.html #}
<div class="mt-6 rounded-2xl bg-white/5 p-3">
  <div class="flex items-center justify-between mb-2">
    <div class="text-sm text-slate-300">æœˆæ¬¡ã‚µãƒãƒªãƒ¼</div>
    <div class="text-xs text-slate-400">ğŸ“ˆ PnLï¼ˆæŠ•è³‡å®¶æç›Šï¼‰ / ğŸ’° ç¾é‡‘ãƒ•ãƒ­ãƒ¼</div>
  </div>
  <div id="pnlChartWrap" style="height:240px">
    <canvas id="pnlChart" style="width:100%;height:100%"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function () {
  if (window.__pnlChartBound) return;
  window.__pnlChartBound = true;

  const canvas = document.getElementById('pnlChart');
  if (!canvas) return;

  let chart = null;
  let timer = null;

  async function fetchData() {
    const qEl = document.querySelector('#q');
    const q = qEl ? encodeURIComponent(qEl.value || '') : '';
    const res = await fetch("{% url 'realized_chart_monthly' %}?q=" + q, {credentials: 'same-origin'});
    return await res.json();
  }

  async function draw() {
    clearTimeout(timer);
    timer = setTimeout(async () => {
      try {
        const data = await fetchData();

        if (chart) { chart.destroy(); chart = null; }

        const ctx = canvas.getContext('2d');

        // é«˜ç²¾ç´°ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã¯ 2x ã¾ã§ã«ã—ã¦ã‚¯ãƒƒã‚­ãƒªï¼†éè² è·é˜²æ­¢
        const dpr = Math.min(2, window.devicePixelRatio || 1);

        chart = new Chart(ctx, {
          type: 'bar', // ãƒ‡ãƒ•ã‚©ã¯æ£’ã€PnLã¯å€‹åˆ¥ã« line æŒ‡å®š
          data: {
            labels: data.labels,
            datasets: [
              {
                type: 'line',
                label: 'ğŸ“ˆPnL',
                data: data.pnl,
                borderWidth: 2,
                pointRadius: 2,
                pointHoverRadius: 4,
                tension: 0.25,
                borderColor: 'rgba(16,185,129,1)',    // ç·‘ç³»
                backgroundColor: 'rgba(16,185,129,0.15)',
                yAxisID: 'y',
              },
              {
                type: 'bar',
                label: 'ğŸ’°ç¾é‡‘',
                data: data.cash,
                borderWidth: 0,
                backgroundColor: 'rgba(59,130,246,0.55)', // é’ç³»
                yAxisID: 'y',
              },
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            devicePixelRatio: dpr,
            interaction: { mode: 'index', intersect: false },
            animation: { duration: 200 },
            plugins: {
              legend: { labels: { color: '#e5e7eb' } },
              tooltip: {
                callbacks: {
                  label: (ctx) => {
                    const v = ctx.parsed.y ?? 0;
                    return `${ctx.dataset.label}: Â¥` + Number(v).toLocaleString();
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: { color: '#cbd5e1' },
                grid:  { color: 'rgba(148,163,184,0.12)' }
              },
              y: {
                beginAtZero: true,
                ticks: { color: '#cbd5e1', callback: v => 'Â¥' + Number(v).toLocaleString() },
                grid:  { color: 'rgba(148,163,184,0.12)' }
              }
            }
          }
        });
      } catch (e) {
        console.error(e);
      }
    }, 120);
  }

  // åˆå›
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', draw, { once: true });
  } else {
    draw();
  }

  // æ¤œç´¢ã§å†æç”»ï¼ˆEnter/blur/changeï¼‰
  const qEl = document.querySelector('#q');
  if (qEl) {
    ['change','blur','keydown'].forEach(ev => {
      qEl.addEventListener(ev, (e) => {
        if (ev !== 'keydown' || e.key === 'Enter') draw();
      });
    });
  }

  // HTMXå·®ã—æ›¿ãˆæ™‚ã‚‚å†æç”»
  document.body.addEventListener('htmx:afterSwap', (e) => {
    const id = e.target && e.target.id;
    if (id === 'pnlTableWrap' || id === 'pnlSummaryWrap' || id === 'pnlPeriodWrap') draw();
  });

  // ã‚¿ãƒ–å¾©å¸°ã§å†èª¿æ•´
  document.addEventListener('visibilitychange', () => { if (!document.hidden) draw(); });
})();
</script>