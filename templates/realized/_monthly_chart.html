{# templates/realized/_monthly_chart.html #}
<div class="mt-6 rounded-2xl bg-white/5 p-3">
  <div class="flex items-center justify-between mb-2">
    <div class="text-sm text-slate-300">月次サマリー</div>

    <!-- 🔧 モバイル向け：凡例トグル -->
    <div class="flex gap-2">
      <button id="btnToggleCum"
              class="text-[11px] px-2 py-1 rounded border border-amber-300/30 text-amber-200 hover:bg-amber-400/10"
              type="button" aria-pressed="true" title="累積PnL の表示/非表示">累積PnL</button>
      <button id="btnToggleCash"
              class="text-[11px] px-2 py-1 rounded border border-blue-300/30 text-blue-200 hover:bg-blue-400/10"
              type="button" aria-pressed="true" title="現金フロー の表示/非表示">現金</button>
      <button id="btnTogglePnl"
              class="text-[11px] px-2 py-1 rounded border border-emerald-300/30 text-emerald-200 hover:bg-emerald-400/10"
              type="button" aria-pressed="true" title="PnL（月次）の表示/非表示">PnL</button>
    </div>
  </div>

  <div class="text-xs text-slate-400 mb-2">
    📈 PnL（投資家損益） / 💰 現金フロー / 📈 累積PnL（右軸）
  </div>

  <div style="height:240px">
    <canvas id="pnlChart" style="width:100%;height:100%"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function () {
  const el = document.getElementById('pnlChart');
  if (!el) return;

  // HiDPI 対策
  const resizeCanvasForHiDPI = (canvas) => {
    const ratio = Math.max(1, window.devicePixelRatio || 1);
    const r = canvas.getBoundingClientRect();
    const w = Math.round(r.width  * ratio);
    const h = Math.round(r.height * ratio);
    if (canvas.width !== w || canvas.height !== h) {
      canvas.width  = w;
      canvas.height = h;
      canvas.style.width  = r.width + 'px';
      canvas.style.height = r.height + 'px';
    }
  };

  let chart = null;

  async function fetchData() {
    const qEl = document.querySelector('#q');
    const q   = qEl ? encodeURIComponent(qEl.value || '') : '';
    const res = await fetch("{% url 'realized_chart_monthly' %}?q=" + q, { credentials: 'same-origin' });
    return await res.json();
  }

  function setBtnState(btn, visible) {
    btn.setAttribute('aria-pressed', visible ? 'true' : 'false');
    btn.style.opacity = visible ? '1' : '0.45';
  }

  async function draw(force = false) {
    const rect = el.getBoundingClientRect();
    if (!force && (rect.width === 0 || rect.height === 0)) return;

    const data = await fetchData();
    const labels = data.labels || [];
    const cash   = data.cash   || [];
    const pnl    = data.pnl    || [];
    const pnlCum = data.pnl_cum|| [];

    const cashColors = cash.map(v => v >= 0 ? 'rgba(59,130,246,0.55)' : 'rgba(244,63,94,0.70)');

    if (chart) { chart.destroy(); chart = null; }
    const ctx = el.getContext('2d');
    resizeCanvasForHiDPI(el);

    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { type: 'bar',  label: '💰 現金',     data: cash,   backgroundColor: cashColors, borderWidth: 0,  yAxisID: 'y',  order: 2 },
          { type: 'line', label: '📈 PnL',     data: pnl,    borderColor: 'rgba(16,185,129,1)', backgroundColor: 'rgba(16,185,129,0.15)', borderWidth: 2.5, pointRadius: 3, pointHoverRadius: 4, tension: 0.25, fill: false, yAxisID: 'y',  order: 1 },
          { type: 'line', label: '📈 累積PnL', data: pnlCum, borderColor: '#fde68a', backgroundColor: 'rgba(253,230,138,0.18)', borderWidth: 3,   pointRadius: 3, pointHoverRadius: 4, tension: 0.18, fill: false, yAxisID: 'y2', order: 0 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },

        // ★ グラフクリック → 期間まとめは「全体を維持」+ 選択月だけハイライト
        onClick: (evt, elements, inst) => {
          const pts = inst.getElementsAtEventForMode(evt, 'nearest', {intersect: true}, true);
          if (!pts || !pts.length) return;
          const label = inst.data.labels[pts[0].index];  // "YYYY-MM"

          // 現在の preset / freq は #pnlPeriodWrap の data 属性から取得（未設定なら LAST_12M / month）
          const wrap = document.querySelector('#pnlPeriodWrap');
          const preset = (wrap?.dataset.preset) || 'LAST_12M';
          const freq   = (wrap?.dataset.freq)   || 'month';

          const qEl = document.querySelector('#q');
          const q   = qEl ? encodeURIComponent(qEl.value || '') : '';

          const url =
            "{% url 'realized_summary_period' %}"
            + "?preset=" + encodeURIComponent(preset)
            + "&freq="   + encodeURIComponent(freq)
            + "&keep=all"                       // ← 全体を残すフラグ
            + "&focus="  + encodeURIComponent(label)
            + "&q=" + q;

          if (window.htmx) {
            htmx.ajax('GET', url, { target: '#pnlPeriodWrap', swap: 'outerHTML' });
            wrap?.scrollIntoView({behavior:'smooth', block:'start'});
          }
        },

        plugins: {
          legend: {
            labels: { color: '#e5e7eb', boxWidth: 12 },
            onClick: (e, legendItem, legend) => {
              const idx = legendItem.datasetIndex;
              const ds  = legend.chart.isDatasetVisible(idx);
              legend.chart.setDatasetVisibility(idx, !ds);
              legend.chart.update();
              if (idx === 0) setBtnState(document.getElementById('btnToggleCash'), !ds);
              if (idx === 1) setBtnState(document.getElementById('btnTogglePnl'),  !ds);
              if (idx === 2) setBtnState(document.getElementById('btnToggleCum'), !ds);
            }
          },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const v = ctx.parsed.y ?? 0;
                return `${ctx.dataset.label}: ¥${Number(v).toLocaleString()}`;
              }
            }
          }
        },
        scales: {
          x:  { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,0.12)' } },
          y:  { ticks: { color: '#cbd5e1', callback: v => '¥' + Number(v).toLocaleString() }, grid: { color: 'rgba(148,163,184,0.12)' } },
          y2: { position: 'right', ticks: { color: '#fde68a', callback: v => '¥' + Number(v).toLocaleString() }, grid: { drawOnChartArea: false } }
        }
      }
    });

    setBtnState(document.getElementById('btnToggleCum'),  true);
    setBtnState(document.getElementById('btnToggleCash'), true);
    setBtnState(document.getElementById('btnTogglePnl'),  true);
  }

  // 初回描画
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => draw(true), { once: true });
  } else {
    draw(true);
  }

  // キーワード変更 → 再描画
  const qEl = document.querySelector('#q');
  if (qEl) {
    ['change','blur','keydown'].forEach(ev => {
      qEl.addEventListener(ev, (e) => {
        if (ev !== 'keydown' || e.key === 'Enter') draw(true);
      });
    });
  }

  // HTMX 差し替え後も再描画
  document.body.addEventListener('htmx:afterSwap', (e) => {
    if (!e.target) return;
    if (['pnlTableWrap','pnlSummaryWrap','pnlPeriodWrap'].includes(e.target.id)) draw(true);
  });

  // 可視・回転対応
  const io = new IntersectionObserver((entries) => {
    const ent = entries[0];
    if (ent && ent.isIntersecting) {
      if (chart && chart.chartArea) {
        resizeCanvasForHiDPI(el);
        chart.resize();
        chart.update('none');
      } else {
        draw(true);
      }
    }
  }, { threshold: 0.2 });
  io.observe(el);

  let rT = null;
  window.addEventListener('resize', () => {
    clearTimeout(rT);
    rT = setTimeout(() => {
      if (!chart) return;
      resizeCanvasForHiDPI(el);
      chart.resize();
      chart.update('none');
    }, 100);
  });

  window.addEventListener('pageshow', () => draw(true));

  // ── トグルボタン配線 ─
  const btnCum  = document.getElementById('btnToggleCum');
  const btnCash = document.getElementById('btnToggleCash');
  const btnPnl  = document.getElementById('btnTogglePnl');

  function toggleDataset(index, btn){
    if (!chart) return;
    const vis = chart.isDatasetVisible(index);
    chart.setDatasetVisibility(index, !vis);
    chart.update();
    setBtnState(btn, !vis);
  }
  btnCum?.addEventListener('click',  () => toggleDataset(2, btnCum));
  btnCash?.addEventListener('click', () => toggleDataset(0, btnCash));
  btnPnl?.addEventListener('click',  () => toggleDataset(1, btnPnl));
})();
</script>