{# templates/realized/_monthly_chart.html #}
<div class="mt-6 rounded-2xl bg-white/5 p-3">
  <div class="flex items-center justify-between mb-2">
    <div class="text-sm text-slate-300">æœˆæ¬¡ã‚µãƒãƒªãƒ¼</div>
    <div class="text-xs text-slate-400">ğŸ“ˆ PnLï¼ˆæŠ•è³‡å®¶æç›Šï¼‰ / ğŸ’° ç¾é‡‘ãƒ•ãƒ­ãƒ¼ / ğŸ“ˆ ç´¯ç©PnL</div>
  </div>

  <div style="height:240px">
    <canvas id="pnlChart" style="width:100%;height:100%"></canvas>
  </div>
  <div id="pnlChartMsg" class="text-sm text-slate-400 mt-2 hidden"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function () {
  const el  = document.getElementById('pnlChart');
  const msg = document.getElementById('pnlChartMsg');
  if (!el) return;

  // 2x è§£åƒåº¦ã§ã«ã˜ã¿å¯¾ç­–
  const resizeCanvasForHiDPI = (canvas) => {
    const ratio = Math.max(1, window.devicePixelRatio || 1);
    const r = canvas.getBoundingClientRect();
    const w = Math.round(r.width  * ratio);
    const h = Math.round(r.height * ratio);
    if (canvas.width !== w || canvas.height !== h) {
      canvas.width  = w;
      canvas.height = h;
      canvas.style.width  = r.width + 'px';
      canvas.style.height = r.height + 'px';
    }
  };

  const showMsg = (text) => {
    if (!msg) return;
    msg.textContent = text || '';
    msg.classList.toggle('hidden', !text);
  };

  let chart = null;

  async function fetchData() {
    const qEl = document.querySelector('#q');
    const q   = qEl ? encodeURIComponent(qEl.value || '') : '';
    const res = await fetch("{% url 'realized_chart_monthly' %}?q=" + q, { credentials: 'same-origin' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  }

  async function draw(force = false) {
    try {
      showMsg('');

      // ç”»é¢å¤–ã§ã‚¼ãƒ­ã‚µã‚¤ã‚ºã®ã¨ãã¯ä½•ã‚‚ã—ãªã„ï¼ˆå¯è¦–ã«ãªã£ãŸã‚‰æãï¼‰
      const rect = el.getBoundingClientRect();
      if (!force && (rect.width === 0 || rect.height === 0)) return;

      const dataRaw = await fetchData();

      // --- é˜²å¾¡: æ¬ æã‚­ãƒ¼/NaNã«å¼·ã„æ­£è¦åŒ– ---
      const labels = Array.isArray(dataRaw.labels) ? dataRaw.labels : [];
      const pnl    = (Array.isArray(dataRaw.pnl)  ? dataRaw.pnl  : []).map(v => Number.isFinite(+v) ? +v : 0);
      const cash   = (Array.isArray(dataRaw.cash) ? dataRaw.cash : []).map(v => Number.isFinite(+v) ? +v : 0);
      let pnlCum   = Array.isArray(dataRaw.pnl_cum) ? dataRaw.pnl_cum.map(v => Number.isFinite(+v) ? +v : 0) : null;

      // ç´¯ç©ãŒæ¥ã¦ã„ãªã„/é•·ã•ä¸ä¸€è‡´ãªã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ç”Ÿæˆ
      if (!pnlCum || pnlCum.length !== pnl.length) {
        pnlCum = [];
        let run = 0;
        for (let i = 0; i < pnl.length; i++) { run += pnl[i]; pnlCum.push(run); }
      }

      if (labels.length === 0) {
        if (chart) { chart.destroy(); chart = null; }
        showMsg('ãƒ‡ãƒ¼ã‚¿ãªã—');
        return;
      }

      const cashColors = cash.map(v => v >= 0 ? 'rgba(59,130,246,0.55)' : 'rgba(244,63,94,0.65)');

      if (chart) {
        chart.destroy();
        chart = null;
      }

      const ctx = el.getContext('2d');
      resizeCanvasForHiDPI(el);

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            // ğŸ’°ç¾é‡‘ï¼ˆæ£’ï¼‰
            {
              type: 'bar',
              label: 'ğŸ’° ç¾é‡‘',
              data: cash,
              backgroundColor: cashColors,
              borderWidth: 0,
              yAxisID: 'y',
              order: 2
            },
            // ğŸ“ˆPnLï¼ˆæœˆæ¬¡ï¼šæŠ˜ã‚Œç·šï¼‰
            {
              type: 'line',
              label: 'ğŸ“ˆ PnL',
              data: pnl,
              borderColor: 'rgba(16,185,129,1)',
              backgroundColor: 'rgba(16,185,129,0.15)',
              pointRadius: 3,
              pointHoverRadius: 4,
              tension: 0.25,
              fill: false,
              yAxisID: 'y',
              order: 1
            },
            // ğŸ“ˆç´¯ç©PnLï¼ˆå³è»¸ï¼šæŠ˜ã‚Œç·šï¼‰
            {
              type: 'line',
              label: 'ğŸ“ˆ ç´¯ç©PnL',
              data: pnlCum,
              borderColor: 'rgba(234,179,8,1)',        // amber
              backgroundColor: 'rgba(234,179,8,0.15)',
              pointRadius: 3,
              pointHoverRadius: 4,
              tension: 0.2,
              fill: false,
              yAxisID: 'y2',
              order: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#e5e7eb' } },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.y ?? 0;
                  return `${ctx.dataset.label}: Â¥${Number(v).toLocaleString()}`;
                }
              }
            }
          },
          scales: {
            x: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,0.12)' } },
            // å·¦è»¸ï¼ˆæ£’ï¼†æœˆæ¬¡PnLï¼‰
            y: {
              ticks: { color: '#cbd5e1', callback: v => 'Â¥' + Number(v).toLocaleString() },
              grid:  { color: 'rgba(148,163,184,0.12)' }
            },
            // å³è»¸ï¼ˆç´¯ç©PnLï¼‰
            y2: {
              position: 'right',
              ticks: { color: '#fbbf24', callback: v => 'Â¥' + Number(v).toLocaleString() },
              grid:  { drawOnChartArea: false }
            }
          }
        }
      });
    } catch (err) {
      console.error(err);
      if (chart) { chart.destroy(); chart = null; }
      showMsg('ã‚°ãƒ©ãƒ•ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }

  // åˆå›æç”»
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => draw(true), { once: true });
  } else {
    draw(true);
  }

  // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ã§å†æç”»
  const qEl = document.querySelector('#q');
  if (qEl) {
    ['change','blur','keydown'].forEach(ev => {
      qEl.addEventListener(ev, (e) => {
        if (ev !== 'keydown' || e.key === 'Enter') draw(true);
      });
    });
  }

  // HTMX æ›´æ–°å¾Œã‚‚å†æç”»
  document.body.addEventListener('htmx:afterSwap', (e) => {
    if (!e.target) return;
    if (['pnlTableWrap','pnlSummaryWrap','pnlPeriodWrap'].includes(e.target.id)) {
      draw(true);
    }
  });

  // å¯è¦–ã«ãªã£ãŸã‚‰å¾©å…ƒï¼ˆiOS Safari ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æŒ™å‹•å¯¾ç­–ï¼‰
  const io = new IntersectionObserver((entries) => {
    const ent = entries[0];
    if (ent && ent.isIntersecting) {
      if (chart && chart.chartArea) {
        resizeCanvasForHiDPI(el);
        chart.resize();
        chart.update('none');
      } else {
        draw(true);
      }
    }
  }, { threshold: 0.2 });
  io.observe(el);

  // ç«¯æœ«å›è»¢ã‚„ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ä¼¸ç¸®ã§å†ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
  let rT = null;
  window.addEventListener('resize', () => {
    clearTimeout(rT);
    rT = setTimeout(() => {
      if (!chart) return;
      resizeCanvasForHiDPI(el);
      chart.resize();
      chart.update('none');
    }, 100);
  });

  // bfcache ã‹ã‚‰ã®å¾©å¸°ã§ã‚‚å†æç”»
  window.addEventListener('pageshow', () => draw(true));
})();
</script>