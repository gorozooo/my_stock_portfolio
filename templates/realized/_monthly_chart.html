{# templates/realized/_monthly_chart.html #}
<div class="mt-6 rounded-2xl bg-white/5 p-3">
  <div class="flex items-center justify-between mb-2">
    <div class="text-sm text-slate-300">æœˆæ¬¡ã‚µãƒãƒªãƒ¼</div>
    <div class="text-xs text-slate-400">ğŸ“ˆ PnLï¼ˆæŠ•è³‡å®¶æç›Šï¼‰ / ğŸ’° ç¾é‡‘ãƒ•ãƒ­ãƒ¼</div>
  </div>

  <div style="height:240px">
    <canvas id="pnlChart" style="width:100%;height:100%"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function () {
  const el = document.getElementById('pnlChart');
  if (!el) return;

  // 2x è§£åƒåº¦ã§ã«ã˜ã¿å¯¾ç­–ï¼ˆiPhone ãªã©ï¼‰
  const resizeCanvasForHiDPI = (canvas) => {
    const ratio = window.devicePixelRatio || 1;
    const { width, height } = canvas.getBoundingClientRect();
    canvas.width  = Math.round(width  * ratio);
    canvas.height = Math.round(height * ratio);
    canvas.style.width  = width + 'px';
    canvas.style.height = height + 'px';
  };

  async function draw() {
    try {
      const qEl = document.querySelector('#q');
      const q   = qEl ? encodeURIComponent(qEl.value || '') : '';
      const url = "{% url 'realized_chart_monthly' %}?q=" + q;

      const res  = await fetch(url, { credentials: 'same-origin' });
      const data = await res.json();

      // ç¾é‡‘ãƒãƒ¼ã®è‰²ã‚’ç¬¦å·ã§åˆ†å²ï¼ˆ+é’ / -èµ¤ï¼‰
      const cashColors = data.cash.map(v => v >= 0 ? 'rgba(59,130,246,0.55)' : 'rgba(244,63,94,0.65)');

      // æ—¢å­˜ãƒãƒ£ãƒ¼ãƒˆç ´æ£„
      if (window._pnlChart) {
        window._pnlChart.destroy();
        window._pnlChart = null;
      }

      const ctx = el.getContext('2d');
      resizeCanvasForHiDPI(el);

      window._pnlChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.labels,                   // e.g. ["2025-02","2025-03","â€¦"]
          datasets: [
            // ç¾é‡‘ï¼ãƒãƒ¼ï¼ˆç¬¦å·ã§è‰²åˆ†ã‘ï¼‰
            {
              type: 'bar',
              label: 'ğŸ’° ç¾é‡‘',
              data: data.cash,
              backgroundColor: cashColors,
              borderWidth: 0,
              order: 2
            },
            // PnLï¼æŠ˜ã‚Œç·š
            {
              type: 'line',
              label: 'ğŸ“ˆ PnL',
              data: data.pnl,
              borderColor: 'rgba(16,185,129,1)',  // ç·‘
              backgroundColor: 'rgba(16,185,129,0.15)',
              pointRadius: 3,
              pointHoverRadius: 4,
              tension: 0.25,
              fill: false,
              yAxisID: 'y',
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 250 },
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#e5e7eb' } },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.y ?? 0;
                  return `${ctx.dataset.label}: Â¥${Number(v).toLocaleString()}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { color: '#cbd5e1' },
              grid: { color: 'rgba(148,163,184,0.12)' }
            },
            y: {
              ticks: {
                color: '#cbd5e1',
                callback: v => 'Â¥' + Number(v).toLocaleString()
              },
              grid: {
                color: 'rgba(148,163,184,0.12)',
                zeroLineColor: 'rgba(148,163,184,0.35)'
              }
            }
          }
        }
      });
    } catch (e) {
      console.error(e);
    }
  }

  // åˆæœŸæç”»
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', draw, { once: true });
  } else {
    draw();
  }

  // æ¤œç´¢ã§å†æç”»ï¼ˆEnter / change / blurï¼‰
  const qEl = document.querySelector('#q');
  if (qEl) {
    ['change','blur','keydown'].forEach(ev => {
      qEl.addEventListener(ev, (e) => {
        if (ev !== 'keydown' || e.key === 'Enter') draw();
      });
    });
  }

  // HTMX ã§ã‚µãƒãƒªãƒ¼/ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰å†æç”»
  document.body.addEventListener('htmx:afterSwap', (e) => {
    if (!e.target) return;
    if (e.target.id === 'pnlTableWrap' || e.target.id === 'pnlSummaryWrap' || e.target.id === 'pnlPeriodWrap') {
      draw();
    }
  });

  // ç”»é¢å›è»¢ãƒ»ãƒªã‚µã‚¤ã‚ºã§é«˜DPIã‚’ç¶­æŒ
  window.addEventListener('resize', () => {
    if (!window._pnlChart) return;
    resizeCanvasForHiDPI(el);
    window._pnlChart.resize();
  });
})();
</script>