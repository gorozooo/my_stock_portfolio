{% extends "base.html" %}
{% load humanize %}

{% block title %}{{ h.ticker }} ã‚’ã‚¯ãƒ­ãƒ¼ã‚º{% endblock %}

{% block head %}
<style>
  .sheet { max-width: 720px; margin: 12px auto; padding: 12px; }
  .sheet .in{appearance:none;-webkit-appearance:none;width:100%;border-radius:12px;padding:12px 14px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);color:#e9ecff;outline:none;transition:.15s}
  .sheet .in::placeholder{color:rgba(233,236,255,.45)}
  .sheet .in:focus{border-color:rgba(99,102,241,.55);box-shadow:0 0 0 3px rgba(99,102,241,.22)}
  .sheet .btn-primary{width:100%;border:0;border-radius:14px;padding:14px 16px;background:linear-gradient(180deg,#6d73ff,#5561f2);color:#fff;font-weight:700}
  .sheet .btn-ghost{width:100%;border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:14px 16px;color:#e9ecff;background:transparent}
  .sheet .sheet-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .sheet .sheet-title{font-weight:700;font-size:18px;margin-bottom:10px}
  .sheet .sheet-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .sheet .label{font-size:12px;color:#a7b1d8}
  .tabs{display:flex;gap:8px;margin:8px 0 12px}
  .tab{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.15);cursor:pointer}
  .tab.active{background:rgba(255,255,255,.12)}
  .sign-wrap{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
  .sign-btn{min-width:38px;padding:10px 0;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#e9ecff}
  @media (max-width: 420px){ .sheet { padding: 8px } }
</style>
{% endblock %}

{% block content %}
<div class="sheet" id="closeSheet" data-initial-side="{{ initial_side|default:'SELL' }}">
  <div class="sheet-head">
    <div class="sheet-title">
      {{ h.ticker }}{% if h.name %}<span class="text-slate-400 text-xs font-normal">ï¼ˆ{{ h.name }}ï¼‰</span>{% endif %} ã‚’ã‚¯ãƒ­ãƒ¼ã‚º
    </div>
    <button type="button" class="text-indigo-300 underline" onclick="history.back()">é–‰ã˜ã‚‹</button>
  </div>

  <!-- SELL/BUY åˆ‡æ›¿ -->
  <div class="tabs">
    <button type="button" class="tab" data-side="SELL">SELLï¼ˆå£²å´ï¼‰</button>
    <button type="button" class="tab" data-side="BUY">BUYï¼ˆè²·ä»˜ï¼‰</button>
  </div>

  <form id="closeForm" action="{% url 'holding_close_submit' h.id %}" method="post" autocomplete="off">
    {% csrf_token %}
    <input type="hidden" name="side" value="SELL">

    <div class="sheet-row">
      <label class="flex flex-col gap-1">
        <span class="label">æ—¥ä»˜</span>
        <input name="date" type="date" value="{{ prefill.date }}" class="in">
      </label>
      <label class="flex flex-col gap-1">
        <span class="label">æ•°é‡</span>
        <input
          name="qty"
          type="text"
          inputmode="numeric"
          pattern="[0-9]*"
          data-min="1"
          data-max="{{ h_qty }}"
          class="in"
          placeholder="ä¾‹: 100">
        <small class="text-xs text-slate-500">ä¿æœ‰: {{ h_qty }}</small>
      </label>
    </div>

    <label class="flex flex-col gap-1 mt-3">
      <span class="label" data-price-label>å£²å´å˜ä¾¡</span>
      <input name="price" inputmode="decimal" placeholder="ä¾‹: 1234.5" class="in">
    </label>

    <div class="sheet-row mt-3">
      <label class="flex flex-col gap-1">
        <span class="label">æ‰‹æ•°æ–™ï¼ˆç¨è¾¼ï¼‰</span>
        <input name="fee" inputmode="decimal" placeholder="æœªå…¥åŠ›ãªã‚‰0" class="in">
      </label>
      <label class="flex flex-col gap-1">
        <span class="label">ç¨é‡‘</span>
        <input name="tax" inputmode="decimal" placeholder="æœªå…¥åŠ›ãªã‚‰0" class="in">
      </label>
    </div>

    <!-- ğŸ”¸ é€šè²¨ãƒ»FXï¼ˆJPYä»¥å¤–ã®ã¨ãã ã‘è¡¨ç¤ºã€‚ãƒ¬ãƒ¼ãƒˆã¯è¨¼åˆ¸ä¼šç¤¾ãƒ¬ãƒ¼ãƒˆã‚’æ‰‹å…¥åŠ›ï¼‰ -->
    {% if currency != "JPY" %}
      <div class="sheet-row mt-3">
        <label class="flex flex-col gap-1">
          <span class="label">é€šè²¨</span>
          <input class="in" value="{{ currency }}" disabled>
        </label>
        <label class="flex flex-col gap-1">
          <span class="label">ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆï¼ˆ1{{ currency }} ã‚ãŸã‚Šã®å††ãƒ»è¨¼åˆ¸ä¼šç¤¾ãƒ¬ãƒ¼ãƒˆã‚’å…¥åŠ›ï¼‰</span>
          <input
            name="fx_rate"
            inputmode="decimal"
            placeholder="ç´„å®šãƒ¬ãƒ¼ãƒˆã‚’å…¥åŠ›ï¼ˆä¾‹: 155.250ï¼‰"
            class="in"
            value="">
        </label>
      </div>
      <input type="hidden" name="currency" value="{{ currency }}">
      <input type="hidden" name="country" value="{{ country|default:'JP' }}">
    {% else %}
      <input type="hidden" name="currency" value="JPY">
      <input type="hidden" name="country" value="{{ country|default:'JP' }}">
    {% endif %}

    <!-- å®Ÿæ / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ -->
    <label class="flex flex-col gap-1 mt-3">
      <span class="label">å®Ÿæ / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ï¼ˆÂ±ãƒ»ä»»æ„ï¼‰</span>
      <div class="sign-wrap">
        <button type="button" class="sign-btn" data-sgn="-">âˆ’</button>
        <input name="cashflow" type="text" inputmode="decimal"
               pattern="-?[0-9]+([.,][0-9]+)?" placeholder="SELL:+åˆ©ç›Š / âˆ’æå¤±ã€BUY:é€šå¸¸0" class="in">
        <button type="button" class="sign-btn" data-sgn="+">ï¼‹</button>
      </div>
    </label>

    <div class="sheet-row mt-3">
      <label class="flex flex-col gap-1">
        <span class="label">è¨¼åˆ¸ä¼šç¤¾</span>
        <select name="broker" class="in">
          <option value="RAKUTEN" {% if prefill.broker == 'RAKUTEN' %}selected{% endif %}>æ¥½å¤©è¨¼åˆ¸</option>
          <option value="SBI" {% if prefill.broker == 'SBI' %}selected{% endif %}>SBIè¨¼åˆ¸</option>
          <option value="MATSUI" {% if prefill.broker == 'MATSUI' %}selected{% endif %}>æ¾äº•è¨¼åˆ¸</option>
          <option value="OTHER" {% if prefill.broker == 'OTHER' or not prefill.broker %}selected{% endif %}>ãã®ä»–</option>
        </select>
      </label>
      <label class="flex flex-col gap-1">
        <span class="label">å£åº§åŒºåˆ†</span>
        <select name="account" class="in">
          <option value="SPEC" {% if prefill.account == 'SPEC' %}selected{% endif %}>ç‰¹å®š</option>
          <option value="MARGIN" {% if prefill.account == 'MARGIN' %}selected{% endif %}>ä¿¡ç”¨</option>
          <option value="NISA" {% if prefill.account == 'NISA' %}selected{% endif %}>NISA</option>
        </select>
      </label>
    </div>

    <label class="flex flex-col gap-1 mt-3">
      <span class="label">ãƒ¡ãƒ¢</span>
      <input name="memo" placeholder="ä»»æ„ãƒ¡ãƒ¢" class="in">
    </label>

    <div class="grid grid-cols-2 gap-2 mt-4">
      <button type="button" class="btn-ghost" onclick="history.back()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn-primary" data-submit-label>å£²å´ã‚’è¨˜éŒ²</button>
    </div>

    <!-- å›ºå®š -->
    <input type="hidden" name="name" value="{{ h.name|default:'' }}">
    <input type="hidden" name="ticker" value="{{ h.ticker }}">
  </form>
</div>

<script>
(function(){
  const root = document.getElementById('closeSheet');
  if (!root) return;

  const initial = (root.dataset.initialSide || 'SELL').toUpperCase();
  const form = root.querySelector('#closeForm');
  const sideInput = form.querySelector('input[name="side"]');
  const qtyInput = form.querySelector('input[name="qty"]');
  const priceLabel = root.querySelector('[data-price-label]');
  const submitBtn= root.querySelector('[data-submit-label]');

  function sanitizeQty() {
    let v = (qtyInput.value || '').replace(/\D/g, '');
    v = v.replace(/^0+(\d)/, '$1');
    qtyInput.value = v;
  }
  qtyInput.addEventListener('input', sanitizeQty);
  qtyInput.addEventListener('blur', () => {
    sanitizeQty();
    const min = parseInt(qtyInput.dataset.min || '1', 10);
    const maxAttr = qtyInput.getAttribute('max');
    const max = maxAttr ? parseInt(maxAttr, 10) : null;
    let val = parseInt(qtyInput.value || '0', 10);
    if (isNaN(val) || val < min) val = min;
    if (max !== null && val > max) val = max;
    qtyInput.value = String(val);
  });

  function setSide(side){
    sideInput.value = side;
    root.querySelectorAll('.tab').forEach(t=>{
      t.classList.toggle('active', t.dataset.side === side);
    });
    if(side === 'SELL'){
      priceLabel.textContent = 'å£²å´å˜ä¾¡';
      submitBtn.textContent = 'å£²å´ã‚’è¨˜éŒ²';
      const mx = qtyInput.getAttribute('data-max');
      if(mx){ qtyInput.setAttribute('max', mx); }
    }else{
      priceLabel.textContent = 'è²·ä»˜å˜ä¾¡';
      submitBtn.textContent = 'è²·ä»˜ã‚’è¨˜éŒ²';
      qtyInput.removeAttribute('max');
    }
  }

  setSide(initial);

  root.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=> setSide(btn.dataset.side));
  });

  root.querySelectorAll('.sign-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const input = root.querySelector('input[name="cashflow"]');
      if (!input) return;
      const s = btn.dataset.sgn === '-' ? '-' : '';
      const v = (input.value || '').replace(/^[+-]?/, '');
      input.value = s + v;
      input.focus();
    });
  });
})();
</script>
{% endblock %}