{# templates/realized/_close_sheet.html #}
<style>
  .sheet .in{
    appearance:none;-webkit-appearance:none;width:100%;
    border-radius:12px;padding:12px 14px;
    background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);
    color:#e9ecff;outline:none;transition:.15s;
  }
  .sheet .in::placeholder{color:rgba(233,236,255,.45)}
  .sheet .in:focus{border-color:rgba(99,102,241,.55);box-shadow:0 0 0 3px rgba(99,102,241,.22)}
  .sheet .btn-primary{width:100%;border:0;border-radius:14px;padding:14px 16px;
    background:linear-gradient(180deg,#6d73ff,#5561f2);color:#fff;font-weight:700}
  .sheet .btn-ghost{width:100%;border:1px solid rgba(255,255,255,.15);border-radius:14px;padding:14px 16px;color:#e9ecff;background:transparent}
  .sheet .sheet-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .sheet .sheet-title{font-weight:700;font-size:18px;margin-bottom:10px}
  .sheet .sheet-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .sheet .label{font-size:12px;color:#a7b1d8}
  /* ±トグル付き入力 */
  .sign-wrap{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center}
  .sign-btn{min-width:38px;padding:10px 0;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:#e9ecff}
</style>

<div class="sheet">
  <div class="sheet-head">
    <div class="sheet-title">
      {{ h.ticker }}
      {% if h.name %}<span class="text-slate-400 text-xs font-normal">（{{ h.name }}）</span>{% endif %}
      をクローズ
    </div>
    <button type="button" class="text-indigo-300 underline" data-dismiss="sheet">閉じる</button>
  </div>

  <form class="js-close-submit-form"
        action="{% url 'realized_close_submit' h.id %}"
        method="post" id="closeForm">
    {% csrf_token %}

    <div class="sheet-row">
      <label class="flex flex-col gap-1">
        <span class="label">日付</span>
        <input name="date" type="date" value="{{ prefill.date }}" class="in">
      </label>
      <label class="flex flex-col gap-1">
        <span class="label">数量</span>
        <input name="qty" type="number" min="1" max="{{ h_qty }}" value="{{ prefill.qty }}" class="in">
        <small class="text-xs text-slate-500">保有: {{ h_qty }}</small>
      </label>
    </div>

    <label class="flex flex-col gap-1 mt-3">
      <span class="label">売却単価</span>
      <input name="price" inputmode="decimal" placeholder="例: 1234.5" class="in">
    </label>

    <div class="sheet-row mt-3">
      <label class="flex flex-col gap-1">
        <span class="label">証券会社</span>
        <select name="broker" class="in">
          <option value="RAKUTEN" {% if prefill.broker == 'RAKUTEN' %}selected{% endif %}>楽天証券</option>
          <option value="SBI" {% if prefill.broker == 'SBI' %}selected{% endif %}>SBI証券</option>
          <option value="MATSUI" {% if prefill.broker == 'MATSUI' %}selected{% endif %}>松井証券</option>
          <option value="OTHER" {% if prefill.broker == 'OTHER' or not prefill.broker %}selected{% endif %}>その他</option>
        </select>
      </label>
      <label class="flex flex-col gap-1">
        <span class="label">口座区分</span>
        <select name="account" class="in">
          <option value="SPEC" {% if prefill.account == 'SPEC' %}selected{% endif %}>特定</option>
          <option value="MARGIN" {% if prefill.account == 'MARGIN' %}selected{% endif %}>信用</option>
          <option value="NISA" {% if prefill.account == 'NISA' %}selected{% endif %}>NISA</option>
        </select>
      </label>
    </div>

    <!-- 実損（手数料控除前）: iOSでも負数を入れられる ±トグル付き -->
    <label class="flex flex-col gap-1 mt-3">
      <span class="label">実損（手数料控除前・任意）</span>
      <div class="sign-wrap">
        <button type="button" class="sign-btn" data-sgn="-">−</button>
        <input name="cashflow"
               type="text"
               inputmode="decimal"
               pattern="-?[0-9]+([.,][0-9]+)?"
               placeholder="+ 利益 / − 損失"
               class="in"
               value="{{ prefill.cashflow|default:'' }}">
        <button type="button" class="sign-btn" data-sgn="+">＋</button>
      </div>
      <p class="text-xs text-slate-400 mt-1">
        ※ iPhoneの小数キーボードには「−」が無いので、左の「−」ボタンで負にできます。
      </p>
    </label>

    <label class="flex flex-col gap-1 mt-3">
      <span class="label">手数料（税込み）</span>
      <input name="fee" inputmode="decimal" value="{{ prefill.fee }}" class="in">
    </label>

    <label class="flex flex-col gap-1 mt-3">
      <span class="label">メモ</span>
      <input name="memo" placeholder="任意メモ" class="in">
    </label>

    <div class="grid grid-cols-2 gap-2 mt-4">
      <button type="button" class="btn-ghost" data-dismiss="sheet">キャンセル</button>
      <button class="btn-primary">売却を記録</button>
    </div>

    <!-- 固定項目 -->
    <input type="hidden" name="side" value="SELL">
    <input type="hidden" name="name" value="{{ h.name|default:'' }}">
    <input type="hidden" name="ticker" value="{{ h.ticker }}">
  </form>
</div>

<script>
  // ±トグル
  document.currentScript.closest('.sheet').addEventListener('click', function(e){
    const btn = e.target.closest('.sign-btn');
    if (!btn) return;
    const wrap = btn.closest('.sign-wrap');
    const input = wrap.querySelector('input[name="cashflow"]');
    if (!input) return;
    const wantMinus = btn.dataset.sgn === '-';

    // 全角/記号を正規化
    let v = (input.value || '').replace(/[＋+]/g, '+')
                               .replace(/[−–—]/g, '-')
                               .replace(/，/g, ',')
                               .trim();
    v = v.replace(',', '.');
    if (v === '' || v === '+' || v === '-') v = '0';
    let num = parseFloat(v);
    if (isNaN(num)) num = 0;

    num = Math.abs(num) * (wantMinus ? -1 : 1);
    input.value = String(num);
    input.dispatchEvent(new Event('input', {bubbles:true}));
  });

  // 送信前に数値を正規化（,→. / 全角→半角 / 前後空白除去）
  document.getElementById('closeForm').addEventListener('submit', function(e){
    const cf = this.querySelector('input[name="cashflow"]');
    if (cf) {
      cf.value = (cf.value || '')
        .replace(/[＋+]/g, '+')
        .replace(/[−–—]/g, '-')
        .replace(/，/g, ',')
        .replace(',', '.')
        .trim();
    }
  });
</script>