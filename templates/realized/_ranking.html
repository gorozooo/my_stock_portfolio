{# templates/realized/_ranking.html #}
{% load humanize %}

<style>
  .rank-wrap{margin-top:16px}
  .rank-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .rank-grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
  .rank-card{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:12px;padding:12px}
  .rank-title{font-size:12px;color:#a7b1d8;margin-bottom:8px;display:flex;align-items:center;gap:6px}
  .rank-row{display:grid;grid-template-columns:auto 1fr auto;gap:8px;align-items:center;padding:6px 0;border-top:1px dashed rgba(255,255,255,.06)}
  .rank-row:first-of-type{border-top:0}
  .tic{font-weight:700;font-variant-numeric:tabular-nums}
  .nm{font-size:12px;color:#cbd5e1}
  .k{font-size:12px;color:#9aa4b2}
  .v{font-variant-numeric:tabular-nums}
  .pos{color:#86efac}
  .neg{color:#fca5a5}
  .pill{font-size:11px;border:1px solid rgba(255,255,255,.12);padding:3px 6px;border-radius:9999px;color:#e5e7eb}
  .mini{font-size:11px;color:#94a3b8}
  .clickable{cursor:pointer}
  @media (max-width: 768px){
    .rank-grid{grid-template-columns:1fr}
  }
</style>

<div class="rank-wrap" id="pnlRankingWrap">
  <div class="rank-head">
    <div class="mini">ğŸ¯ éŠ˜æŸ„åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå®Ÿç¾PnLï¼‰</div>
    <button type="button" class="pill" onclick="window.clearTickerFilter?.()">ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤</button>
  </div>

  <div class="rank-grid">
    {# ------ TOP 5 ------ #}
    <div class="rank-card">
      <div class="rank-title">ğŸ† TOP 5</div>
      {% if top5 %}
        {% for r in top5 %}
          <div class="rank-row clickable" onclick="window.filterByTicker?.('{{ r.ticker }}')">
            <div>
              <div class="tic">{{ r.ticker }}</div>
              <div class="nm">{{ r.name }}</div>
            </div>
            <div class="k">
              ä»¶æ•° {{ r.n|intcomma }}ãƒ»æ•°é‡ {{ r.qty|intcomma }}<br>
              å‹ç‡ {{ r.win_rate|floatformat:0 }}%
            </div>
            <div style="text-align:right">
              <div class="v {% if r.pnl >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ r.pnl|floatformat:0|intcomma }}
              </div>
              <div class="mini">å¹³å‡ Â¥{{ r.avg|floatformat:0|intcomma }}</div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="mini" style="padding:8px 0">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
      {% endif %}
    </div>

    {# ------ WORST 5 ------ #}
    <div class="rank-card">
      <div class="rank-title">ğŸ“‰ ãƒ¯ãƒ¼ã‚¹ãƒˆ 5</div>
      {% if worst5 %}
        {% for r in worst5 %}
          <div class="rank-row clickable" onclick="window.filterByTicker?.('{{ r.ticker }}')">
            <div>
              <div class="tic">{{ r.ticker }}</div>
              <div class="nm">{{ r.name }}</div>
            </div>
            <div class="k">
              ä»¶æ•° {{ r.n|intcomma }}ãƒ»æ•°é‡ {{ r.qty|intcomma }}<br>
              å‹ç‡ {{ r.win_rate|floatformat:0 }}%
            </div>
            <div style="text-align:right">
              <div class="v {% if r.pnl >= 0 %}pos{% else %}neg{% endif %}">
                Â¥{{ r.pnl|floatformat:0|intcomma }}
              </div>
              <div class="mini">å¹³å‡ Â¥{{ r.avg|floatformat:0|intcomma }}</div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="mini" style="padding:8px 0">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // æ¤œç´¢æ¬„ã«åæ˜  â†’ HTMXé ˜åŸŸã‚’ã¾ã¨ã‚ã¦å†å–å¾—ï¼ˆæ—¢å­˜ã®æ§‹æˆã‚’æ´»ã‹ã™ï¼‰
  window.filterByTicker = function(ticker){
    const q = document.getElementById('q');
    if (!q) return;
    q.value = ticker;
    // ãƒ†ãƒ¼ãƒ–ãƒ«å·®ã—æ›¿ãˆï¼ˆæ—¢å­˜ã®hx-getè¨­å®šã‚’åˆ©ç”¨ï¼‰
    q.dispatchEvent(new Event('change', {bubbles:true}));
    // æœŸé–“ã¾ã¨ã‚ãƒ»ã‚µãƒãƒªãƒ¼ãƒ»ã‚°ãƒ©ãƒ•ã‚‚æ›´æ–°ã—ãŸã„å ´åˆã¯ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆã§
    document.body.dispatchEvent(new Event('pnl:refresh'));
  };
};
</script>