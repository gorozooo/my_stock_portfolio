{% load humanize %}
<style>
  .rk-wrap{margin-top:14px}
  .rk-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
  .rk-h{font-size:13px;color:#cbd5e1}
  .rk-clear{font-size:11px;padding:4px 8px;border:1px solid rgba(148,163,184,.25);border-radius:8px;background:transparent;color:#cbd5e1}
  .rk-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
  .rk-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
  .rk-ttl{font-size:12px;color:#94a3b8;margin-bottom:6px}
  .rk-row{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:8px;cursor:pointer}
  .rk-row:hover{background:rgba(255,255,255,.06)}
  .rk-name{font-size:13px;color:#e5e7eb;display:flex;gap:6px;align-items:baseline}
  .rk-ticker{font-size:11px;color:#94a3b8}
  .rk-mets{font-variant-numeric:tabular-nums;text-align:right}
  .rk-mets div{line-height:1.2}
  .pos{color:#86efac} .neg{color:#fca5a5}
  .muted{color:#94a3b8}
  @media (max-width: 640px){ .rk-grid{grid-template-columns:1fr} }
</style>

<div class="rk-wrap" id="rkWrap">
  <div class="rk-head">
    <div class="rk-h">ğŸ“Š éŠ˜æŸ„åˆ¥ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå®Ÿç¾PnLï¼‰</div>
    <button type="button" class="rk-clear" id="rkClear">ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤</button>
  </div>

  {% if (top5 and top5|length) or (worst5 and worst5|length) %}
    <div class="rk-grid">
      <div class="rk-card">
        <div class="rk-ttl">ğŸ… TOP 5</div>
        {% if top5 %}
          {% for r in top5 %}
            <div class="rk-row"
                 hx-get="{% url 'realized_ranking_detail_partial' %}"
                 hx-target="#pnlRankingDetailWrap"
                 hx-swap="outerHTML"
                 hx-include="[name=q],[name=preset],[name=freq],[name=start],[name=end]"
                 hx-vals='{"ticker":"{{ r.ticker }}"}'>
              <div class="rk-name">
                <span>{{ r.name|default:r.ticker }}</span>
                <span class="rk-ticker">{{ r.ticker }}</span>
              </div>
              <div class="rk-mets">
                {% with p=r.pnl %}<div class="{% if p >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ p|floatformat:0|intcomma }}</div>{% endwith %}
                <div class="muted">å‹ç‡ {{ r.win_rate|floatformat:0 }}% / å¹³å‡ Â¥{{ r.avg|floatformat:0|intcomma }}</div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted" style="padding:8px 0">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
        {% endif %}
      </div>

      <div class="rk-card">
        <div class="rk-ttl">ğŸ“‰ ãƒ¯ãƒ¼ã‚¹ãƒˆ 5</div>
        {% if worst5 %}
          {% for r in worst5 %}
            <div class="rk-row"
                 hx-get="{% url 'realized_ranking_detail_partial' %}"
                 hx-target="#pnlRankingDetailWrap"
                 hx-swap="outerHTML"
                 hx-include="[name=q],[name=preset],[name=freq],[name=start],[name=end]"
                 hx-vals='{"ticker":"{{ r.ticker }}"}'>
              <div class="rk-name">
                <span>{{ r.name|default:r.ticker }}</span>
                <span class="rk-ticker">{{ r.ticker }}</span>
              </div>
              <div class="rk-mets">
                {% with p=r.pnl %}<div class="{% if p >= 0 %}pos{% else %}neg{% endif %}">Â¥{{ p|floatformat:0|intcomma }}</div>{% endwith %}
                <div class="muted">å‹ç‡ {{ r.win_rate|floatformat:0 }}% / å¹³å‡ Â¥{{ r.avg|floatformat:0|intcomma }}</div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted" style="padding:8px 0">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div class="muted" style="padding:8px 0">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
  {% endif %}
</div>

<script>
(() => {
  // æ—¢å­˜ã®ã€Œ#qã€ã‚’ä½¿ã£ã¦å…¨ä½“ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤ã‚’å®Ÿè£…
  const qEl  = document.getElementById('q');
  document.getElementById('rkClear')?.addEventListener('click', () => {
    if (!qEl) return;
    qEl.value = '';
    if (window.htmx) {
      // æ—¢å­˜ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥é€£é–ã‚’åˆ©ç”¨ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«/ã‚µãƒãƒªãƒ¼/æœŸé–“ã¾ã¨ã‚/ãƒãƒ£ãƒ¼ãƒˆ/ãƒ©ãƒ³ã‚­ãƒ³ã‚° å…¨éƒ¨æ›´æ–°ï¼‰
      document.body.dispatchEvent(new Event('pnl:refresh', {bubbles:true}));
      htmx.trigger(qEl, 'search');
    }
    // ãƒ‰ãƒªãƒ«ãƒ€ã‚¦ãƒ³é ˜åŸŸã‚’ã‚¯ãƒªã‚¢
    const d = document.getElementById('pnlRankingDetailWrap');
    if (d) d.innerHTML = '';
  });
})();
</script>