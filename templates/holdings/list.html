{% extends "base.html" %}
{% load static humanize num %}

{% block title %}保有一覧{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/holdings.css' %}?v=5.5">
<style>
  /* --- クイックバー & モーダル最小スタイル --- */
  .quickbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
  .quickbar .fld{display:flex;gap:6px;align-items:center}
  .quickbar select,.quickbar input[type="text"]{
    background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.14);
    color:#dbe3f4;border-radius:10px;padding:6px 8px;font-size:12px
  }
  .quickbar .btn{padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14)}

  /* Spark modal */
  .spark-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50}
  .spark-modal.is-open{display:flex}
  .spark-dlg{width:min(92vw,520px);background:rgba(18,24,33,.98);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px}
  .spark-dlg h3{margin:0 0 8px}
  .spark-ctrl{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
  .spark-ctrl .btn{padding:6px 10px;border:1px solid rgba(255,255,255,.14);border-radius:10px;font-size:12px;background:rgba(255,255,255,.05);color:#dbe3f4}
  .spark-ctrl .btn.is-on{outline:2px solid rgba(110,168,255,.55)}
  .spark-canvas{width:100%;height:140px}
</style>
{% endblock %}

{% block content %}

<!-- クイックフィルタ/並び替え -->
<div class="quickbar" id="qb">
  <div class="fld">
    <label>証券</label>
    <select id="qb-broker">
      <option value="">ALL</option>
      <option>松井証券</option>
      <option>楽天証券</option>
      <option>SBI</option>
    </select>
  </div>
  <div class="fld">
    <label>口座</label>
    <select id="qb-account">
      <option value="">ALL</option>
      <option>特定</option>
      <option>信用</option>
      <option>NISA</option>
    </select>
  </div>
  <div class="fld">
    <label>売買</label>
    <select id="qb-side">
      <option value="">ALL</option>
      <option value="BUY">BUY</option>
      <option value="SELL">SELL</option>
    </select>
  </div>
  <div class="fld">
    <label>損益</label>
    <select id="qb-pnl">
      <option value="">ALL</option>
      <option value="POS">＋</option>
      <option value="NEG">−</option>
    </select>
  </div>
  <div class="fld">
    <label>並び</label>
    <select id="qb-sort">
      <option value="updated">更新日</option>
      <option value="created">作成日</option>
      <option value="opened">保有開始</option>
      <option value="pnl">含み損益</option>
      <option value="days">保有日数</option>
    </select>
    <select id="qb-order">
      <option value="desc">↓</option>
      <option value="asc">↑</option>
    </select>
  </div>
  <div class="fld">
    <input id="qb-q" type="text" placeholder="コード/名称 検索">
  </div>
  <button class="btn" id="qb-apply">適用</button>
</div>

<div id="holdingsBody">
  {% include "holdings/_list.html" %}
</div>

<!-- Sparkモーダル（そのまま） -->
<div class="spark-modal" id="sparkModal" aria-hidden="true">
  <div class="spark-dlg">
    <h3 id="sparkTitle">Spark</h3>
    <div class="spark-ctrl">
      <button class="btn is-on" data-span="7">7日</button>
      <button class="btn" data-span="30">30日</button>
      <button class="btn" data-span="90">90日</button>
      <button class="btn is-on" data-mode="idx">指数</button>
      <button class="btn" data-mode="raw">実値</button>
      <button class="btn" id="sparkClose" style="margin-left:auto">閉じる</button>
    </div>
    <canvas class="spark-canvas" id="sparkCanvas"></canvas>
  </div>
</div>

<script src="{% static 'js/holdings.js' %}?v=130"></script>
<script>
  // Quickbar: URL > localStorage を優先。適用で URL も更新（pushState）
  (function(){
    const LSKEY='holdings.qb.v1';
    const $ = (id)=>document.getElementById(id);

    // 表示名 ↔ コード の相互変換（サブメニューはコード、セレクトは表示名）
    const BROKER = {
      toLabel(code){ return ({MATSUI:'松井証券', RAKUTEN:'楽天証券', SBI:'SBI'})[code] || code || ''; },
      toCode(label){ const m={'松井証券':'MATSUI','楽天証券':'RAKUTEN','SBI':'SBI'}; return m[label] || label || ''; }
    };
    const ACCOUNT = {
      toLabel(code){ return ({SPEC:'特定', MARGIN:'信用', NISA:'NISA'})[code] || code || ''; },
      toCode(label){ const m={'特定':'SPEC','信用':'MARGIN','NISA':'NISA'}; return m[label] || label || ''; }
    };

    function readLS(){ try{return JSON.parse(localStorage.getItem(LSKEY)||'{}')}catch(_){return{}} }
    function saveLS(v){ localStorage.setItem(LSKEY, JSON.stringify(v||{})) }

    function readURL(){
      const u = new URL(location.href);
      const p = u.searchParams;
      // URL はコード前提で受取
      return {
        broker: p.get('broker') || '',
        account:p.get('account')||'',
        side:   p.get('side')   ||'',
        pnl:    p.get('pnl')    ||'',
        sort:   p.get('sort')   ||'',
        order:  p.get('order')  ||'',
        // q or ticker のどちらでも拾う
        ticker: p.get('ticker') || p.get('q') || ''
      };
    }

    function applyState(st){
      // セレクトは「表示名」で選択されるので変換してから入れる
      $('qb-broker').value = st.broker ? BROKER.toLabel(st.broker) : '';
      $('qb-account').value= st.account? ACCOUNT.toLabel(st.account): '';
      $('qb-side').value   = st.side||'';
      $('qb-pnl').value    = st.pnl||'';
      $('qb-sort').value   = st.sort||'updated';
      $('qb-order').value  = st.order||'desc';
      $('qb-q').value      = st.ticker||'';
    }

    function gather(){
      // 画面から拾う → URLへはコードで渡す
      const brokerLabel  = $('qb-broker').value || '';
      const accountLabel = $('qb-account').value || '';
      return {
        broker: BROKER.toCode(brokerLabel),
        account:ACCOUNT.toCode(accountLabel),
        side:   $('qb-side').value || '',
        pnl:    $('qb-pnl').value || '',
        sort:   $('qb-sort').value || 'updated',
        order:  $('qb-order').value || 'desc',
        ticker: $('qb-q').value || ''
      };
    }

    function buildQuery(st){
      const p = new URLSearchParams();
      if (st.broker) p.set('broker', st.broker);
      if (st.account) p.set('account', st.account);
      if (st.side) p.set('side', st.side);
      if (st.pnl) p.set('pnl', st.pnl);
      if (st.sort) p.set('sort', st.sort);
      if (st.order) p.set('order', st.order);
      if (st.ticker) p.set('ticker', st.ticker);
      return p.toString();
    }

    function fetchList(st){
      const qs = buildQuery(st);
      const url = "{% url 'holding_list_partial' %}" + (qs ? ("?"+qs) : "");
      fetch(url, {headers:{'HX-Request':'true'}})
        .then(r=>r.text())
        .then(html=>{
          const target = document.getElementById('holdingsBody');
          target.innerHTML = html;
          // HTMX 再スキャン（hx-* を有効化）
          if (window.htmx) htmx.process(target);
          // 既存の初期化フックがあれば通知
          document.body.dispatchEvent(new CustomEvent('htmx:load', {detail:{target}}));
        });
    }

    function applyAndRender(st, push=true){
      applyState(st);
      // URL 更新（ブックマーク可能）。初回は replace、以降は push でもOK
      const qs = buildQuery(st);
      const newURL = location.pathname + (qs ? ("?"+qs) : "");
      if (push) history.pushState(st, '', newURL); else history.replaceState(st, '', newURL);
      // 保存（次回のデフォルトに）
      saveLS(st);
      // 描画
      fetchList(st);
    }

    // 初期ロード：URL が優先（URLに何か入っていなければ LS）
    (function init(){
      const urlSt = readURL();
      const hasURL = Object.values(urlSt).some(v => !!v);
      const base = hasURL ? urlSt : Object.assign({
        broker:'',account:'',side:'',pnl:'',sort:'updated',order:'desc',ticker:''
      }, readLS());
      applyAndRender(base, /*push=*/false);
    })();

    // 適用ボタン：pushState して反映
    $('qb-apply').addEventListener('click', ()=>{
      const st = gather();
      applyAndRender(st, /*push=*/true);
    });
    // Enter でも適用
    $('qb-q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('qb-apply').click(); }});

    // 戻る/進む対応
    window.addEventListener('popstate', (e)=>{
      const st = e.state || readURL();  // state が無ければURLを読む
      applyState(st||{});
      fetchList(st||{});
    });
  })();
</script>
{% endblock %}