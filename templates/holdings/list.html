{# templates/holdings/list.html #}
{% extends "base.html" %}
{% load static humanize num %}

{% block title %}保有一覧{% endblock %}

{% block head %}
<style>
  .page-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}

  .card{
    position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.08);
    border-radius:16px;background:rgba(255,255,255,.04)
  }

  /* ===== スワイプ行 ===== */
  .row{position:relative}
  .track{
    position:relative;width:100%;z-index:2;
    transform:translateX(0);transition:transform .18s ease-out;will-change:transform;
    /* 透け防止：背景をうっすら敷いて背面のactionsが見えないようにする */
    background: linear-gradient(180deg, rgba(12,18,28,.72), rgba(12,18,28,.72));
  }

  /* 初期は画面の外へ退避（右:-260px）。開いたら0に。 */
  .actions{
    position:absolute;top:0;right:-260px;bottom:0;z-index:1;
    width:260px;display:flex;gap:8px;align-items:center;justify-content:flex-end;
    padding:0 12px;background:rgba(12,18,28,.96);
    border-left:1px solid rgba(255,255,255,.07);backdrop-filter:blur(2px);
    transition:right .18s ease-out;
  }
  .row.is-open .actions{ right:0; }

  .btn-ghost{
    padding:9px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);
    font-size:13px;background:transparent;color:#e6ebff
  }
  .btn-warn{
    padding:9px 12px;border-radius:12px;border:1px solid rgba(244,63,94,.35);
    background:rgba(244,63,94,.12);font-size:13px;color:#ffdbe1
  }

  /* ===== 表示部 ===== */
  .body{padding:14px}
  .title{display:flex;align-items:center;gap:10px}
  .name{font-weight:800;font-size:20px;letter-spacing:.02em}
  .code{font-size:12px;color:#9aa4b2}
  .badges{display:flex;flex-wrap:wrap;gap:6px;margin-left:6px}
  .badge{font-size:11px;padding:3px 8px;border:1px solid rgba(255,255,255,.16);border-radius:9999px;color:#dbe3f4}
  .badge.buy{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35)}
  .badge.sell{background:rgba(244,63,94,.12);border-color:rgba(244,63,94,.35)}

  .grid{
    display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;
    border-top:1px dashed rgba(255,255,255,.08);padding-top:10px
  }
  .kv{display:flex;justify-content:space-between;gap:8px}
  .kv .k{font-size:12px;color:#97a3b6}
  .kv .v{font-size:18px}

  /* “詳細”は初期非表示。カードに .show-detail が付いたときだけ表示 */
  .more{display:none;border-top:1px dashed rgba(255,255,255,.08);padding:10px 14px}
  .row.show-detail .more{display:block}
  .moregrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:6px}

  @media (max-width:480px){
    .grid{grid-template-columns:1fr 1fr}
  }
</style>
{% endblock %}

{% block content %}
<div class="page-head">
  <h1>保有一覧</h1>
  <a href="{% url 'holding_create' %}" class="btn btn-outline">＋ 新規登録</a>
</div>

{% if holdings %}
  <div class="vstack" style="gap:14px">
    {% for h in holdings %}
      <article class="card row" data-swipe>
        {# 右側アクション（初期は画面外に退避。CSSで right:-260px ） #}
        <div class="actions" aria-hidden="true">
          <button type="button" class="btn-ghost" data-action="detail">詳細</button>
          <a class="btn-ghost" href="{% url 'holding_edit' h.id %}">編集</a>
          <button class="btn-warn"
                  hx-post="{% url 'holding_delete' h.id %}"
                  hx-confirm="削除しますか？"
                  hx-target="closest [data-swipe]"
                  hx-swap="outerHTML swap:15ms">削除</button>
        </div>

        {# 表示本体（ここを左にスライド） #}
        <div class="track">
          <div class="body">
            <header class="title">
              <div class="name">{{ h.name|default:"-" }}</div>
              <div class="code">{{ h.ticker }}</div>
              <div class="badges">
                <span class="badge">{{ h.get_broker_display }}</span>
                <span class="badge">{{ h.get_account_display }}</span>
                <span class="badge {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
              </div>
            </header>

            <div class="grid">
              <div class="kv"><div class="k">数量</div><div class="v">{{ h.quantity|intcomma }}</div></div>
              <div class="kv"><div class="k">平均取得</div><div class="v">¥{{ h.avg_cost|floatformat:0|intcomma }}</div></div>
            </div>
          </div>

          {# 隠し“詳細”（初期は非表示。アクションの「詳細」でトグル） #}
          <div class="more">
            <div class="moregrid">
              <div class="kv" style="border:none;padding:0">
                <div class="k">取得額</div>
                <div class="v">¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div>
              </div>
              <div class="kv" style="border:none;padding:0">
                <div class="k">保有開始</div>
                <div class="v">{{ h.opened_at|date:"Y-m-d"|default:"—" }}</div>
              </div>
              <div class="kv"><div class="k">作成</div><div class="v">{{ h.created_at|date:"Y-m-d" }}</div></div>
              <div class="kv"><div class="k">更新</div><div class="v">{{ h.updated_at|date:"Y-m-d" }}</div></div>
            </div>
          </div>
        </div>
      </article>
    {% endfor %}
  </div>
{% else %}
  <div class="text-slate-400">保有はまだありません。</div>
{% endif %}

<script>
/* ===== 左スワイプでアクション露出（初期は完全非表示） ===== */
(function(){
  const rows = document.querySelectorAll('[data-swipe]');
  const OPEN_W = 260; // アクション幅と一致させる

  function closeAll(except){
    document.querySelectorAll('[data-swipe].is-open').forEach(r=>{
      if (r===except) return;
      r.classList.remove('is-open');
      r.querySelector('.track').style.transform = 'translateX(0)';
    });
  }

  rows.forEach(row=>{
    const track = row.querySelector('.track');
    const detailBtn = row.querySelector('[data-action="detail"]');
    let startX=0, startY=0, dragging=false, horiz=false, opened=false, baseX=0;

    const setX = x => track.style.transform = `translateX(${x}px)`;

    const onStart = e=>{
      const t = e.touches ? e.touches[0] : e;
      startX = t.clientX; startY = t.clientY;
      dragging = true; horiz = false;
      baseX = opened ? -OPEN_W : 0;
      track.style.transition = 'none';
      // 他の開いている行を閉じる
      if (document.querySelector('[data-swipe].is-open') && !row.classList.contains('is-open')){
        closeAll(row);
      }
    };

    const onMove = e=>{
      if(!dragging) return;
      const t = e.touches ? e.touches[0] : e;
      const dx = t.clientX - startX;
      const dy = t.clientY - startY;

      // 横スワイプだけ反応（縦スクロール誤作動防止）
      if(!horiz){
        if(Math.abs(dx) < 8) return;
        if(Math.abs(dx) > Math.abs(dy)) horiz = true; else { dragging=false; track.style.transition=''; return; }
      }
      if(e.cancelable) e.preventDefault();

      let nx = Math.min(0, baseX + dx);
      nx = Math.max(-OPEN_W, nx);
      setX(nx);
    };

    const onEnd = ()=>{
      if(!dragging) return;
      dragging=false; track.style.transition='';
      const m = new WebKitCSSMatrix(getComputedStyle(track).transform);
      opened = (m.m41 < -OPEN_W/2);
      if (opened){ row.classList.add('is-open'); setX(-OPEN_W); }
      else       { row.classList.remove('is-open'); setX(0); }
    };

    track.addEventListener('touchstart', onStart, {passive:true});
    track.addEventListener('touchmove',  onMove,  {passive:false});
    track.addEventListener('touchend',   onEnd);
    track.addEventListener('mousedown',  onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup',   onEnd);

    // アクション「詳細」 → .more をトグル（メニューは閉じる）
    detailBtn.addEventListener('click', ()=>{
      row.classList.toggle('show-detail');
      opened = false; row.classList.remove('is-open'); setX(0);
    });
  });

  // 画面外側タップで閉じる
  document.addEventListener('click', (ev)=>{
    const r = ev.target.closest('[data-swipe]');
    if (!r) closeAll(null);
  });
})();
</script>
{% endblock %}