{% extends "base.html" %}
{% load static humanize num %}

{% block title %}保有一覧{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/holdings.css' %}?v=9">
<style>
  /* ===== フィルター（極小） ===== */
  :root{
    --topbarH: 48px;       /* 画面上部ナビ等の高さに合わせて調整 */
  }

  .quickbar{ /* 最小のグリッド配置 */
    display:grid;
    gap:6px;
    grid-template-columns: repeat(4, minmax(0,1fr));
    align-items:center;
    margin:6px 0 8px;
  }
  @media (max-width:420px){
    .quickbar{ grid-template-columns: repeat(3, minmax(0,1fr)); }
  }
  .quickbar .fld{display:contents;} /* ラベルと要素をグリッドに直接置く */

  .quickbar label{
    font-size:11px; opacity:.8; display:none; /* コンパクトにするので非表示 */
  }

  .quickbar select,
  .quickbar input[type="text"],
  .quickbar .btn{
    height:28px;
    padding:0 8px;
    font-size:12px;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.14);
    color:#dbe3f4;
    border-radius:8px;
  }

  /* 検索ボックスは幅広、適用ボタンは右端 */
  #qb-q{ grid-column: 1 / -2; }
  #qb-apply{ grid-column: -2 / -1; }

  /* Sticky KPI の下に十分な余白がないと重なるので、ページ先頭の
     何か（例えばヘッダー）がある場合は body 側でパディングを付ける運用を推奨。
     ここでは何もしない。 */
</style>
{% endblock %}

{% block content %}

<!-- クイックフィルタ/並び替え（IDや各要素は既存JSのままでOK） -->
<div class="quickbar" id="qb">
  <div class="fld">
    <label>証券</label>
    <select id="qb-broker">
      <option value="">ALL</option>
      <option>松井証券</option>
      <option>楽天証券</option>
      <option>SBI</option>
    </select>
  </div>
  <div class="fld">
    <label>口座</label>
    <select id="qb-account">
      <option value="">ALL</option>
      <option>特定</option>
      <option>信用</option>
      <option>NISA</option>
    </select>
  </div>
  <div class="fld">
    <label>売買</label>
    <select id="qb-side">
      <option value="">ALL</option>
      <option value="BUY">BUY</option>
      <option value="SELL">SELL</option>
    </select>
  </div>
  <div class="fld">
    <label>損益</label>
    <select id="qb-pnl">
      <option value="">ALL</option>
      <option value="POS">＋</option>
      <option value="NEG">−</option>
    </select>
  </div>
  <div class="fld">
    <label>並び</label>
    <select id="qb-sort">
      <option value="updated">更新日</option>
      <option value="created">作成日</option>
      <option value="opened">保有開始</option>
      <option value="pnl">含み損益</option>
      <option value="days">保有日数</option>
    </select>
    <select id="qb-order">
      <option value="desc">↓</option>
      <option value="asc">↑</option>
    </select>
  </div>
  <div class="fld">
    <input id="qb-q" type="text" placeholder="コード/名称 検索">
  </div>
  <button class="btn" id="qb-apply">適用</button>
</div>

<div id="holdingsBody">
  {% include "holdings/_list.html" %}
</div>

<!-- Sparkモーダル（現状維持） -->
<div class="spark-modal" id="sparkModal" aria-hidden="true" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50">
  <div class="spark-dlg" style="width:min(92vw,520px);background:rgba(18,24,33,.98);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px">
    <h3 id="sparkTitle">Spark</h3>
    <div class="spark-ctrl" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px">
      <button class="btn is-on" data-span="7">7日</button>
      <button class="btn" data-span="30">30日</button>
      <button class="btn" data-span="90">90日</button>
      <button class="btn is-on" data-mode="idx">指数</button>
      <button class="btn" data-mode="raw">実値</button>
      <button class="btn" id="sparkClose" style="margin-left:auto">閉じる</button>
    </div>
    <canvas class="spark-canvas" id="sparkCanvas" style="width:100%;height:140px"></canvas>
  </div>
</div>

<script src="{% static 'js/holdings.js' %}?v=130"></script>
<script>
  // Quickbar: URL > localStorage を優先。適用で URL も更新（pushState）
  (function(){
    const LSKEY='holdings.qb.v1';
    const $ = (id)=>document.getElementById(id);

    const BROKER = {
      toLabel(code){ return ({MATSUI:'松井証券', RAKUTEN:'楽天証券', SBI:'SBI'})[code] || code || ''; },
      toCode(label){ const m={'松井証券':'MATSUI','楽天証券':'RAKUTEN','SBI':'SBI'}; return m[label] || label || ''; }
    };
    const ACCOUNT = {
      toLabel(code){ return ({SPEC:'特定', MARGIN:'信用', NISA:'NISA'})[code] || code || ''; },
      toCode(label){ const m={'特定':'SPEC','信用':'MARGIN','NISA':'NISA'}; return m[label] || label || ''; }
    };

    function readLS(){ try{return JSON.parse(localStorage.getItem(LSKEY)||'{}')}catch(_){return{}} }
    function saveLS(v){ localStorage.setItem(LSKEY, JSON.stringify(v||{})) }

    function readURL(){
      const u = new URL(location.href);
      const p = u.searchParams;
      return {
        broker: p.get('broker') || '',
        account:p.get('account')||'',
        side:   p.get('side')   ||'',
        pnl:    p.get('pnl')    ||'',
        sort:   p.get('sort')   ||'',
        order:  p.get('order')  ||'',
        ticker: p.get('ticker') || p.get('q') || ''
      };
    }

    function applyState(st){
      $('qb-broker').value = st.broker ? BROKER.toLabel(st.broker) : '';
      $('qb-account').value= st.account? ACCOUNT.toLabel(st.account): '';
      $('qb-side').value   = st.side||'';
      $('qb-pnl').value    = st.pnl||'';
      $('qb-sort').value   = st.sort||'updated';
      $('qb-order').value  = st.order||'desc';
      $('qb-q').value      = st.ticker||'';
    }

    function gather(){
      const brokerLabel  = $('qb-broker').value || '';
      const accountLabel = $('qb-account').value || '';
      return {
        broker: BROKER.toCode(brokerLabel),
        account:ACCOUNT.toCode(accountLabel),
        side:   $('qb-side').value || '',
        pnl:    $('qb-pnl').value || '',
        sort:   $('qb-sort').value || 'updated',
        order:  $('qb-order').value || 'desc',
        ticker: $('qb-q').value || ''
      };
    }

    function buildQuery(st){
      const p = new URLSearchParams();
      if (st.broker) p.set('broker', st.broker);
      if (st.account) p.set('account', st.account);
      if (st.side) p.set('side', st.side);
      if (st.pnl) p.set('pnl', st.pnl);
      if (st.sort) p.set('sort', st.sort);
      if (st.order) p.set('order', st.order);
      if (st.ticker) p.set('ticker', st.ticker);
      return p.toString();
    }

    function fetchList(st){
      const qs = buildQuery(st);
      const url = "{% url 'holding_list_partial' %}" + (qs ? ("?"+qs) : "");
      fetch(url, {headers:{'HX-Request':'true'}})
        .then(r=>r.text())
        .then(html=>{
          const target = document.getElementById('holdingsBody');
          target.innerHTML = html;
          if (window.htmx) htmx.process(target);
          document.body.dispatchEvent(new CustomEvent('htmx:load', {detail:{target}}));
        });
    }

    function applyAndRender(st, push=true){
      applyState(st);
      const qs = buildQuery(st);
      const newURL = location.pathname + (qs ? ("?"+qs) : "");
      if (push) history.pushState(st, '', newURL); else history.replaceState(st, '', newURL);
      saveLS(st);
      fetchList(st);
    }

    (function init(){
      const urlSt = readURL();
      const hasURL = Object.values(urlSt).some(v => !!v);
      const base = hasURL ? urlSt : Object.assign({
        broker:'',account:'',side:'',pnl:'',sort:'updated',order:'desc',ticker:''
      }, readLS());
      applyAndRender(base, /*push=*/false);
    })();

    document.getElementById('qb-apply').addEventListener('click', ()=>{
      const st = gather();
      applyAndRender(st, /*push=*/true);
    });
    document.getElementById('qb-q').addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); document.getElementById('qb-apply').click(); }
    });

    window.addEventListener('popstate', (e)=>{
      const st = e.state || readURL();
      applyState(st||{});
      fetchList(st||{});
    });
  })();
</script>
{% endblock %}