{# templates/holdings/list.html #}
{% extends "base.html" %}
{% load static humanize num %}

{% block title %}ä¿æœ‰ä¸€è¦§{% endblock %}

{% block head %}
<style>
  .page-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}

  .card{
    position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.08);
    border-radius:16px;background:rgba(255,255,255,.04)
  }
  .row{position:relative}

  /* æœ¬æ–‡ã¯å›ºå®šï¼ˆå‹•ã‹ã•ãªã„ï¼‰ */
  .track{
    position:relative;z-index:1;
    background: linear-gradient(180deg, rgba(12,18,28,.72), rgba(12,18,28,.72));
  }

  /* ===== æ¨ªä¸¦ã³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¤–æ ãªã—ï¼ã‚«ãƒ¼ãƒ‰ã®é«˜ã•ã«ãƒ•ã‚£ãƒƒãƒˆï¼‰ ===== */
  .actions{
    --open-w: 220px; /* ã‚¹ãƒ¯ã‚¤ãƒ—å¹…ï¼ˆå¥½ã¿ã§ 200ã€œ240ï¼‰ */
    position:absolute;inset:0 auto 0 calc(var(--open-w)*-1);
    right:calc(var(--open-w)*-1); /* åˆæœŸã¯ç”»é¢å¤– */
    width:var(--open-w);
    z-index:2; display:flex; align-items:stretch; justify-content:center;
    padding:0; transition:right .18s ease-out; will-change:right;
    background: none; /* â† å¤–æ ã‚„æ¿ã‚’ãªãã™ */
    pointer-events:auto;
  }
  .row.is-open .actions{ right:0; }

  /* ä¸­èº«ã¯æ¨ª3åˆ†å‰²ã€‚ã‚«ãƒ¼ãƒ‰é«˜ã«ãƒ•ã‚£ãƒƒãƒˆ */
  .action-panel{
    display:flex; flex-direction:row; gap:8px;
    width:100%; height:100%; padding:8px 10px 8px 8px; /* å³ç«¯å°‘ã—ä½™ç™½ */
  }
  .action-panel .item{
    flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:6px; text-decoration:none; color:#e6ebff; font-weight:700; font-size:12px;
    border-radius:12px; border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06); min-width:0; text-align:center;
    box-shadow: 0 4px 18px rgba(0,0,0,.25);
    touch-action: manipulation; /* iOSã§ã®ã‚¯ãƒªãƒƒã‚¯é…å»¶å›é¿ */
  }
  .item .ico{font-size:18px; line-height:1}
  .item.detail{ background: rgba(110,168,255,.18); }
  .item.edit  { background: rgba(0,255,209,.16); }
  .item.delete{ background: rgba(255,77,103,.20); }

  /* æœ¬æ–‡ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .body{padding:14px}
  .title{display:flex;align-items:center;gap:10px}
  .name{font-weight:800;font-size:20px;letter-spacing:.02em}
  .code{font-size:12px;color:#9aa4b2}
  .badges{display:flex;flex-wrap:wrap;gap:6px;margin-left:6px}
  .badge{font-size:11px;padding:3px 8px;border:1px solid rgba(255,255,255,.16);border-radius:9999px;color:#dbe3f4}
  .badge.buy{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35)}
  .badge.sell{background:rgba(244,63,94,.12);border-color:rgba(244,63,94,.35)}

  .grid{
    display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;
    border-top:1px dashed rgba(255,255,255,.08);padding-top:10px
  }
  .kv{display:flex;justify-content:space-between;gap:8px}
  .kv .k{font-size:12px;color:#97a3b6}
  .kv .v{font-size:18px}

  /* è©³ç´°ãƒˆã‚°ãƒ«éƒ¨ */
  .more{display:none;border-top:1px dashed rgba(255,255,255,.08);padding:10px 14px}
  .row.show-detail .more{display:block}
  .moregrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:6px}
</style>
{% endblock %}

{% block content %}
<div class="page-head">
  <h1>ä¿æœ‰ä¸€è¦§</h1>
  <a href="{% url 'holding_create' %}" class="btn btn-outline">ï¼‹ æ–°è¦ç™»éŒ²</a>
</div>

{% if holdings %}
  <div class="vstack" style="gap:14px">
    {% for h in holdings %}
      <article class="card row" data-swipe>
        <!-- æ¨ªä¸¦ã³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆå¤–æ ãƒŠã‚·ã€ã‚«ãƒ¼ãƒ‰é«˜ãƒ•ã‚£ãƒƒãƒˆï¼‰ -->
        <div class="actions">
          <div class="action-panel">
            <button type="button" class="item detail" data-action="detail">
              <span class="ico">ğŸ“„</span><span>è©³ç´°</span>
            </button>
            <a class="item edit" href="{% url 'holding_edit' h.id %}">
              <span class="ico">âœï¸</span><span>ç·¨é›†</span>
            </a>
            <!-- å‰Šé™¤ã¯ãƒ•ã‚©ãƒ¼ãƒ ä¸è¦ã€‚HTMXã§POSTã™ã‚‹ -->
            <button class="item delete"
                    hx-post="{% url 'holding_delete' h.id %}"
                    hx-confirm="å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
                    hx-target="closest [data-swipe]"
                    hx-swap="outerHTML swap:15ms">
              <span class="ico">ğŸ—‘ï¸</span><span>å‰Šé™¤</span>
            </button>
          </div>
        </div>

        <!-- æœ¬æ–‡ï¼ˆå›ºå®šï¼‰ -->
        <div class="track">
          <div class="body">
            <header class="title">
              <div class="name">{{ h.name|default:"-" }}</div>
              <div class="code">{{ h.ticker }}</div>
              <div class="badges">
                <span class="badge">{{ h.get_broker_display }}</span>
                <span class="badge">{{ h.get_account_display }}</span>
                <span class="badge {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
              </div>
            </header>

            <div class="grid">
              <div class="kv"><div class="k">æ•°é‡</div><div class="v">{{ h.quantity|intcomma }}</div></div>
              <div class="kv"><div class="k">å¹³å‡å–å¾—</div><div class="v">Â¥{{ h.avg_cost|floatformat:0|intcomma }}</div></div>
            </div>
          </div>

          <div class="more">
            <div class="moregrid">
              <div class="kv" style="border:none;padding:0">
                <div class="k">å–å¾—é¡</div>
                <div class="v">Â¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div>
              </div>
              <div class="kv" style="border:none;padding:0">
                <div class="k">ä¿æœ‰é–‹å§‹</div>
                <div class="v">{{ h.opened_at|date:"Y-m-d"|default:"â€”" }}</div>
              </div>
              <div class="kv"><div class="k">ä½œæˆ</div><div class="v">{{ h.created_at|date:"Y-m-d" }}</div></div>
              <div class="kv"><div class="k">æ›´æ–°</div><div class="v">{{ h.updated_at|date:"Y-m-d" }}</div></div>
            </div>
          </div>
        </div>
      </article>
    {% endfor %}
  </div>
{% else %}
  <div class="text-slate-400">ä¿æœ‰ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
{% endif %}

<script>
/* å³â€œæ¨ªä¸¦ã³ãƒ‘ãƒãƒ«â€ã ã‘ã‚’éœ²å‡ºï¼ˆæœ¬æ–‡ã¯å›ºå®šï¼‰ï¼‹ ã‚¯ãƒªãƒƒã‚¯åå¿œæ”¹å–„ */
(function(){
  const rows = document.querySelectorAll('[data-swipe]');

  function getOpenW(actions){
    const v = getComputedStyle(actions).getPropertyValue('--open-w').trim().replace('px','');
    return parseFloat(v || '220');
  }

  function closeAll(except){
    document.querySelectorAll('[data-swipe].is-open').forEach(r=>{
      if(r===except) return;
      r.classList.remove('is-open');
      const a = r.querySelector('.actions');
      a.style.right = (-getOpenW(a)) + 'px';
    });
  }

  rows.forEach(row=>{
    const actions = row.querySelector('.actions');
    const detailBtn = row.querySelector('[data-action="detail"]');
    const OPEN_W = getOpenW(actions);

    // åˆæœŸä½ç½®
    actions.style.right = (-OPEN_W) + 'px';

    let startX=0,startY=0,drag=false,horiz=false,opened=false,baseRight=-OPEN_W;

    const setRight = (px)=> actions.style.right = px + 'px';

    const onStart = (e)=>{
      // â˜… ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ«ä¸Šã®ã‚¿ãƒƒãƒ—ã¯ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†ã‚’é–‹å§‹ã—ãªã„ï¼ˆåå¿œã—ãªã„å•é¡Œã®æ ¹æ²»ï¼‰
      if (e.target.closest('.actions')) return;

      const t = e.touches ? e.touches[0] : e;
      startX=t.clientX; startY=t.clientY;
      drag=true; horiz=false;
      baseRight = opened ? 0 : -OPEN_W;
      actions.style.transition='none';

      if(document.querySelector('[data-swipe].is-open') && !row.classList.contains('is-open')){
        closeAll(row);
      }
    };

    const onMove = (e)=>{
      if(!drag) return;
      const t = e.touches ? e.touches[0] : e;
      const dx=t.clientX-startX, dy=t.clientY-startY;

      if(!horiz){
        if(Math.abs(dx)<8) return;
        if(Math.abs(dx)>Math.abs(dy)) horiz=true; else { drag=false; actions.style.transition=''; return; }
      }
      if(e.cancelable) e.preventDefault();

      let nr = baseRight - dx;          // å·¦ã¸ã§ -OPEN_W â†’ 0
      if(nr>0) nr=0;
      if(nr<-OPEN_W) nr=-OPEN_W;
      setRight(nr);
    };

    const onEnd = ()=>{
      if(!drag) return;
      drag=false; actions.style.transition='right .18s ease-out';
      const curRight = parseFloat(getComputedStyle(actions).right) || -OPEN_W;
      opened = (curRight > -OPEN_W/2);
      if(opened){ row.classList.add('is-open'); setRight(0); }
      else      { row.classList.remove('is-open'); setRight(-OPEN_W); }
    };

    // ã‚¿ãƒƒãƒã®ã¿ã§OKï¼ˆiPhoneå‰æï¼‰ã€‚ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã§ã‚‚ä½¿ã†ãªã‚‰ mousedown ç³»ã‚‚è¿½åŠ å¯ã€‚
    row.addEventListener('touchstart', onStart, {passive:true});
    row.addEventListener('touchmove',  onMove,  {passive:false});
    row.addEventListener('touchend',   onEnd);

    // è©³ç´°ãƒˆã‚°ãƒ«ï¼ˆæŠ¼ä¸‹å¾Œã¯ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹ï¼‰
    detailBtn.addEventListener('click', ()=>{
      row.classList.toggle('show-detail');
      opened=false; row.classList.remove('is-open'); setRight(-OPEN_W);
    });
  });

  // å¤–å´ã‚¿ãƒƒãƒ—ã§é–‰ã˜ã‚‹ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³å†…ã¯é™¤å¤–ï¼‰
  document.addEventListener('click', (e)=>{
    if (e.target.closest('.actions')) return;
    const r = e.target.closest('[data-swipe]');
    if(!r) closeAll(null);
  });
})();
</script>
{% endblock %}