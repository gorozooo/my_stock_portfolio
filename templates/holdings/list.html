{# templates/holdings/list.html #}
{% extends "base.html" %}
{% load static humanize num %}

{% block title %}保有一覧{% endblock %}

{% block head %}
<style>
  .page-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  .vstack{ display:flex; flex-direction:column; gap:16px; }

  /* ── フィルタ/ソート ツールバー ── */
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .toolbar select,.toolbar input{
    padding:7px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);color:#e6ebff
  }
  .toolbar .btn{padding:7px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14)}

  .card{
    position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.08);
    border-radius:16px;background:rgba(255,255,255,.04);
    box-shadow:0 6px 22px rgba(0,0,0,.18);
  }
  .row{position:relative}

  /* 本文は固定（動かさない） */
  .track{ position:relative; z-index:1; background:linear-gradient(180deg, rgba(12,18,28,.72), rgba(12,18,28,.72)); }

  /* 右の横並びアクション */
  .actions{
    --open-w: 220px;
    position:absolute; top:0; bottom:0; right:calc(var(--open-w)*-1); left:auto;
    width:var(--open-w); z-index:2;
    display:flex; align-items:stretch; justify-content:center;
    padding:0; transition:right .18s ease-out; will-change:right;
    background:none; pointer-events:none;
  }
  .row.is-open .actions{ right:0; pointer-events:auto; }

  .action-panel{ display:flex; flex-direction:row; gap:8px; width:100%; height:100%; padding:8px 10px 8px 8px; }
  .action-panel .item{
    flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:6px; text-decoration:none; color:#e6ebff; font-weight:700; font-size:12px;
    border-radius:12px; border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06); min-width:0; text-align:center;
    box-shadow:0 4px 18px rgba(0,0,0,.25); touch-action:manipulation;
  }
  .item .ico{font-size:18px; line-height:1}
  .item.detail{ background:rgba(110,168,255,.18) }
  .item.edit  { background:rgba(0,255,209,.16) }
  .item.delete{ background:rgba(255,77,103,.20) }

  .body{padding:14px}
  .title{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; text-align:center; }
  .name{ font-weight:800; font-size:20px; line-height:1.15; white-space:nowrap; overflow:hidden; }
  .subline{ display:flex; align-items:center; justify-content:center; gap:8px; flex-wrap:wrap; }
  .badges{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }

  .badge{
    font-size:11px; padding:3px 10px;
    border:1px solid rgba(255,255,255,.16); border-radius:9999px; color:#dbe3f4; white-space:nowrap;
    background:rgba(255,255,255,.06);
  }
  .badge--code{ color:#c7d2fe; border-color:rgba(110,168,255,.35); background:rgba(110,168,255,.12); }
  .badge.buy{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35)}
  .badge.sell{background:rgba(244,63,94,.12);border-color:rgba(244,63,94,.35)}

  .grid{
    display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;
    border-top:1px dashed rgba(255,255,255,.08); padding-top:10px;
  }
  .kv{display:flex;justify-content:space-between;gap:8px}
  .kv .k{font-size:12px;color:#97a3b6}
  .kv .v{font-size:18px}

  .more{display:none;border-top:1px dashed rgba(255,255,255,.08);padding:10px 14px}
  .row.show-detail .more{display:block}
  .moregrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:6px}
</style>
{% endblock %}

{% block content %}
<div class="page-head">
  <h1>保有一覧</h1>
  <a href="{% url 'holding_create' %}" class="btn btn-outline">＋ 新規登録</a>
</div>

{# ── フィルタ/ソート ツールバー（HTMXで本体を差し替え）── #}
<div class="toolbar"
     hx-get="{% url 'holding_list_partial' %}"
     hx-target="#holdingsBody"
     hx-swap="innerHTML"
     hx-trigger="change, keyup delay:250ms from:.js-filter">
  <select name="sort" class="js-filter">
    <option value="">並び替え: 更新順</option>
    <option value="value" {% if sort == "value" %}selected{% endif %}>評価額</option>
    <option value="pnl"   {% if sort == "pnl" %}selected{% endif %}>含み損益</option>
    <option value="days"  {% if sort == "days" %}selected{% endif %}>保有日数</option>
  </select>
  <select name="order" class="js-filter">
    <option value="desc" {% if order != "asc" %}selected{% endif %}>降順</option>
    <option value="asc"  {% if order == "asc" %}selected{% endif %}>昇順</option>
  </select>
  <select name="broker" class="js-filter">
    <option value="">ブローカー: 全て</option>
    {% for k,v in request.user.holding_set.model.BROKER_CHOICES %}
      <option value="{{k}}" {% if filters.broker == k %}selected{% endif %}>{{v}}</option>
    {% endfor %}
  </select>
  <select name="account" class="js-filter">
    <option value="">口座: 全て</option>
    {% for k,v in request.user.holding_set.model.ACCOUNT_CHOICES %}
      <option value="{{k}}" {% if filters.account == k %}selected{% endif %}>{{v}}</option>
    {% endfor %}
  </select>
  <input type="text" name="ticker" class="js-filter" placeholder="ティッカーで絞込" value="{{filters.ticker}}">
</div>

<div id="holdingsBody">
  {% include "holdings/_list.html" %}
</div>

<script>
/* ===== 銘柄名を1行で収めるための自動縮小 ===== */
function autoFitNames(){
  const els = document.querySelectorAll('.name-fit');
  els.forEach(el=>{
    const max = 20, min = 14; // px
    el.style.fontSize = max + 'px';
    const limit = el.clientWidth || el.parentElement.clientWidth;
    let size = max;
    const hardLimit = Math.max(60, (limit - 12));
    while (el.scrollWidth > hardLimit && size > min){
      size -= 1; el.style.fontSize = size + 'px';
    }
  });
}
window.addEventListener('load', autoFitNames);
window.addEventListener('resize', ()=>{
  clearTimeout(window.__fitT); window.__fitT = setTimeout(autoFitNames, 120);
});
</script>
{% endblock %}