{% extends "base.html" %}
{% load static humanize num %}

{% block title %}保有一覧{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/holdings.css' %}?v=6.2">
<style>
  /* --- クイックバー & モーダル最小スタイル --- */
  .quickbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
  .quickbar .fld{display:flex;gap:6px;align-items:center}
  .quickbar select,.quickbar input[type="text"]{
    background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.14);
    color:#dbe3f4;border-radius:10px;padding:6px 8px;font-size:12px
  }
  .quickbar .btn{padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14)}

  /* Spark modal */
  .spark-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:50}
  .spark-modal.is-open{display:flex}
  .spark-dlg{width:min(92vw,520px);background:rgba(18,24,33,.98);border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:12px}
  .spark-dlg h3{margin:0 0 8px}
  .spark-ctrl{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
  .spark-ctrl .btn{padding:6px 10px;border:1px solid rgba(255,255,255,.14);border-radius:10px;font-size:12px;background:rgba(255,255,255,.05);color:#dbe3f4}
  .spark-ctrl .btn.is-on{outline:2px solid rgba(110,168,255,.55)}
  .spark-canvas{width:100%;height:140px}
</style>
{% endblock %}

{% block content %}
<div class="page-head">
  <h1>保有一覧</h1>
  <a href="{% url 'holding_create' %}" class="btn btn-outline">＋ 新規登録</a>
</div>

<!-- クイックフィルタ/並び替え -->
<div class="quickbar" id="qb">
  <div class="fld">
    <label>証券</label>
    <select id="qb-broker">
      <option value="">ALL</option>
      <option>松井証券</option>
      <option>楽天証券</option>
      <option>SBI</option>
    </select>
  </div>
  <div class="fld">
    <label>口座</label>
    <select id="qb-account">
      <option value="">ALL</option>
      <option>特定</option>
      <option>信用</option>
      <option>NISA</option>
    </select>
  </div>
  <div class="fld">
    <label>売買</label>
    <select id="qb-side">
      <option value="">ALL</option>
      <option value="BUY">BUY</option>
      <option value="SELL">SELL</option>
    </select>
  </div>
  <div class="fld">
    <label>損益</label>
    <select id="qb-pnl">
      <option value="">ALL</option>
      <option value="POS">＋</option>
      <option value="NEG">−</option>
    </select>
  </div>
  <div class="fld">
    <label>並び</label>
    <select id="qb-sort">
      <option value="updated">更新日</option>
      <option value="created">作成日</option>
      <option value="opened">保有開始</option>
      <option value="pnl">含み損益</option>
      <option value="days">保有日数</option>
    </select>
    <select id="qb-order">
      <option value="desc">↓</option>
      <option value="asc">↑</option>
    </select>
  </div>
  <div class="fld">
    <input id="qb-q" type="text" placeholder="コード/名称 検索">
  </div>
  <button class="btn" id="qb-apply">適用</button>
</div>

<div id="holdingsBody">
  {% include "holdings/_list.html" %}
</div>

<!-- スパークモーダル -->
<div class="spark-modal" id="sparkModal" aria-hidden="true">
  <div class="spark-dlg">
    <h3 id="sparkTitle">Spark</h3>
    <div class="spark-ctrl">
      <button class="btn is-on" data-span="7">7日</button>
      <button class="btn" data-span="30">30日</button>
      <button class="btn" data-span="90">90日</button>
      <button class="btn is-on" data-mode="idx">指数</button>
      <button class="btn" data-mode="raw">実値</button>
      <button class="btn" id="sparkClose" style="margin-left:auto">閉じる</button>
    </div>
    <canvas class="spark-canvas" id="sparkCanvas"></canvas>
  </div>
</div>

<script src="{% static 'js/holdings.js' %}?v=131"></script>
<script>
  // Quickbar: 状態保存＆適用
  (function(){
    const LSKEY='holdings.qb.v1';
    const $ = (id)=>document.getElementById(id);

    function read(){ try{return JSON.parse(localStorage.getItem(LSKEY)||'{}')}catch(_){return{}} }
    function save(v){ localStorage.setItem(LSKEY, JSON.stringify(v||{})) }
    function gather(){
      return {
        broker: $('qb-broker').value || '',
        account:$('qb-account').value || '',
        side:   $('qb-side').value || '',
        pnl:    $('qb-pnl').value || '',
        sort:   $('qb-sort').value || 'updated',
        order:  $('qb-order').value || 'desc',
        ticker: $('qb-q').value || ''
      }
    }
    function applyState(st){
      $('qb-broker').value = st.broker||'';
      $('qb-account').value= st.account||'';
      $('qb-side').value   = st.side||'';
      $('qb-pnl').value    = st.pnl||'';
      $('qb-sort').value   = st.sort||'updated';
      $('qb-order').value  = st.order||'desc';
      $('qb-q').value      = st.ticker||'';
    }
    function queryString(st){
      const p = new URLSearchParams(st);
      return p.toString();
    }
    function load(){
      const st = Object.assign({
        broker:'',account:'',side:'',pnl:'',sort:'updated',order:'desc',ticker:''
      }, read());
      applyState(st);
      const qs = queryString(st);
      fetch("{% url 'holding_list_partial' %}?"+qs, {headers:{'HX-Request':'true'}})
      .then(r=>r.text()).then(html=>{
        const body = document.getElementById('holdingsBody');
        body.innerHTML = html;

        // ★ 差し替え後に必ず HTMX を再スキャン
        if (window.htmx) { window.htmx.process(body); }

        // sumbox の再初期化（もし定義されていれば）
        if (typeof initHoldingsSumbox === 'function') { initHoldingsSumbox(body); }

        // Spark や swipe など他の再バインド処理もここで呼べる
      });
    }
    $('qb-apply').addEventListener('click', ()=>{ const st = gather(); save(st); load(); });
    $('qb-q').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ $('qb-apply').click(); }});
    load();
  })();
</script>
{% endblock %}