{# templates/holdings/list.html #}
{% extends "base.html" %}
{% load static humanize num %}

{% block title %}保有一覧{% endblock %}

{% block head %}
<style>
  .h-wrap{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .h-card{position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.08);
          border-radius:16px;background:rgba(255,255,255,.04)}
  .h-row{position:relative;height:100%}
  .h-track{position:relative;z-index:2;transform:translateX(0);transition:transform .18s ease-out}
  .h-actions{position:absolute;inset:0 0 0 auto;width:230px;display:flex;gap:8px;align-items:center;justify-content:flex-end;
             padding:0 12px;z-index:1; background:rgba(14,21,34,.9);backdrop-filter:blur(2px);border-left:1px solid rgba(255,255,255,.06)}
  .h-btn{padding:9px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18);font-size:13px}
  .h-btn.warn{background:rgba(244,63,94,.12);border-color:rgba(244,63,94,.35)}
  .h-btn.ghost{background:transparent}
  .h-body{padding:14px}
  .h-title{display:flex;align-items:center;gap:10px}
  .h-name{font-weight:800;font-size:20px;letter-spacing:.02em}
  .h-code{font-size:12px;color:#9aa4b2}
  .h-badges{display:flex;flex-wrap:wrap;gap:6px;margin-left:6px}
  .h-badge{font-size:11px;padding:3px 8px;border:1px solid rgba(255,255,255,.16);border-radius:9999px;color:#dbe3f4}
  .h-badge.buy{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35)}
  .h-badge.sell{background:rgba(244,63,94,.12);border-color:rgba(244,63,94,.35)}
  .h-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;
          border-top:1px dashed rgba(255,255,255,.08);padding-top:10px}
  .kv{display:flex;justify-content:space-between;gap:8px}
  .kv .k{font-size:12px;color:#97a3b6}
  .kv .v{font-size:18px}
  @media (max-width:480px){ .h-grid{grid-template-columns:1fr 1fr} }
</style>
{% endblock %}

{% block content %}
<div class="h-wrap">
  <h1>保有一覧</h1>
  <a href="{% url 'holding_create' %}" class="btn btn-outline">＋ 新規登録</a>
</div>

{% if holdings %}
  <div class="vstack" style="gap:14px">
    {% for h in holdings %}
      <article class="h-card h-row" data-swipe>
        <!-- アクション（右固定／最初は隠れている） -->
        <div class="h-actions" aria-hidden="true">
          <a class="h-btn ghost" href="{% url 'holding_edit' h.id %}">編集</a>
          <button class="h-btn warn"
                  hx-post="{% url 'holding_delete' h.id %}"
                  hx-confirm="削除しますか？"
                  hx-target="closest [data-swipe]"
                  hx-swap="outerHTML swap:15ms">削除</button>
        </div>

        <!-- 本体（スワイプで左にスライド） -->
        <div class="h-track">
          <div class="h-body">
            <header class="h-title">
              <div class="h-name">{{ h.name|default:"-" }}</div>
              <div class="h-code">{{ h.ticker }}</div>
              <div class="h-badges">
                <span class="h-badge">{{ h.get_broker_display }}</span>
                <span class="h-badge">{{ h.get_account_display }}</span>
                <span class="h-badge {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
              </div>
            </header>

            <div class="h-grid">
              <div class="kv">
                <div class="k">数量</div>
                <div class="v">{{ h.quantity|intcomma }}</div>
              </div>
              <div class="kv">
                <div class="k">平均取得</div>
                <div class="v">¥{{ h.avg_cost|floatformat:0|intcomma }}</div>
              </div>
              {# 評価損益は後で実装（現在値×数量 − 取得額） #}
            </div>
          </div>
        </div>
      </article>
    {% endfor %}
  </div>
{% else %}
  <div class="text-slate-400">保有はまだありません。</div>
{% endif %}

<script>
/* ===== 左スワイプでアクション表示 ===== */
(function(){
  const rows = document.querySelectorAll('[data-swipe]');
  rows.forEach(row=>{
    const track = row.querySelector('.h-track');
    const actions = row.querySelector('.h-actions');
    const OPEN_X = actions.offsetWidth || 230; // スライド量

    let startX=0, curX=0, dragging=false, opened=false;

    const setX = x => { track.style.transform = `translateX(${x}px)`; };

    const closeAll = () => {
      document.querySelectorAll('[data-swipe].is-open').forEach(r=>{
        r.classList.remove('is-open');
        r.querySelector('.h-track').style.transform = 'translateX(0)';
      });
    };

    const onStart = (e)=>{
      dragging = true;
      startX = (e.touches ? e.touches[0].clientX : e.clientX);
      curX = opened ? -OPEN_X : 0;
      track.style.transition = 'none';
    };
    const onMove = (e)=>{
      if(!dragging) return;
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - startX;
      // 左へのみ
      let nx = Math.min(0, curX + x);
      nx = Math.max(-OPEN_X, nx);
      setX(nx);
    };
    const onEnd = (e)=>{
      if(!dragging) return;
      dragging = false;
      track.style.transition = '';
      const matrix = new WebKitCSSMatrix(getComputedStyle(track).transform);
      const moved = matrix.m41; // 現在のtranslateX
      const shouldOpen = moved < -OPEN_X/2;
      opened = shouldOpen;
      if (shouldOpen){
        closeAll();
        row.classList.add('is-open');
        setX(-OPEN_X);
      }else{
        row.classList.remove('is-open');
        setX(0);
      }
    };

    // タッチ/マウス両対応
    track.addEventListener('touchstart', onStart, {passive:true});
    track.addEventListener('touchmove',  onMove,  {passive:true});
    track.addEventListener('touchend',   onEnd);
    track.addEventListener('mousedown',  onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup',   onEnd);

    // どこか他をタップしたら閉じる
    document.addEventListener('click', (ev)=>{
      if (!row.contains(ev.target)) { opened=false; row.classList.remove('is-open'); setX(0); }
    });
  });
})();
</script>
{% endblock %}