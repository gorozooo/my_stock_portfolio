{% extends "base.html" %}
{% load static humanize num %}

{% block title %}保有一覧{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/holdings.css' %}?v=2.1">
{% endblock %}

{% block content %}
<div class="page-head">
  <h1>保有一覧</h1>
  <a href="{% url 'holding_create' %}" class="btn btn-outline">＋ 新規登録</a>
</div>

{% if page.object_list %}
  <div class="stack">
    {% for r in page.object_list %}
      {% with h=r.obj %}
      <article class="neo row" data-swipe>
        <!-- スワイプアクション -->
        <div class="actions">
          <div class="action-panel" onclick="event.stopPropagation()">
            <button type="button" class="item detail" data-action="detail"><span>詳細</span></button>
            <a class="item edit" href="{% url 'holding_edit' h.id %}"><span>編集</span></a>
            <button class="item delete"
                    hx-post="{% url 'holding_delete' h.id %}"
                    hx-confirm="削除しますか？"
                    hx-target="closest [data-swipe]"
                    hx-swap="outerHTML swap:15ms"><span>削除</span></button>
          </div>
        </div>

        <!-- 本文 -->
        <div class="track">
          <!-- ヘッダー（左：名前＋小バッジ／右：スパーク） -->
          <header class="head">
            <div class="title">
              <div class="name" title="{{ h.name|default:'-' }}">{{ h.name|default:'-' }}</div>
              <div class="chips">
                <span class="chip code">{{ h.ticker }}</span>
                <span class="chip">{{ h.get_broker_display }}</span>
                <span class="chip">{{ h.get_account_display }}</span>
                <span class="chip {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">
                  {{ h.side }}
                </span>
              </div>
            <div class="sparkbox">
              {% if r.spark %}
                <svg class="spark"
                     viewBox="0 0 110 30" preserveAspectRatio="none"
                     data-spark='{{ r.spark|safe }}'
                     data-rate='{{ r.pnl_pct|default:0 }}'></svg>
              {% endif %}
            </div>
          </header>

          <!-- メトリクス（超コンパクト pill） -->
          <section class="pillgrid">
            <div class="pill">
              <div class="k">数量</div>
              <div class="v">{{ h.quantity|intcomma }}</div>
            </div>
            <div class="pill">
              <div class="k">平均取得</div>
              <div class="v">¥{{ h.avg_cost|floatformat:0|intcomma }}</div>
            </div>
            <div class="pill hi {% if r.pnl is not None and r.pnl < 0 %}neg{% endif %}">
              <div class="k">含み損益</div>
              <div class="v">{% if r.pnl is not None %}¥{{ r.pnl|floatformat:0|intcomma }}{% else %}—{% endif %}</div>
            </div>
            <div class="pill hi {% if r.pnl_pct is not None and r.pnl_pct < 0 %}neg{% endif %}">
              <div class="k">損益率</div>
              <div class="v">{% if r.pnl_pct is not None %}{{ r.pnl_pct|floatformat:2 }}%{% else %}—{% endif %}</div>
            </div>
          </section>

          <!-- 詳細（トグル） -->
          <section class="more">
            <div class="moregrid">
              <div class="kv"><div class="k">取得額</div><div class="v">¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div></div>
              <div class="kv"><div class="k">保有開始</div><div class="v">{{ h.opened_at|date:"Y-m-d"|default:"—" }}</div></div>
              <div class="kv"><div class="k">作成</div><div class="v">{{ h.created_at|date:"Y-m-d" }}</div></div>
              <div class="kv"><div class="k">更新</div><div class="v">{{ h.updated_at|date:"Y-m-d" }}</div></div>
              {% if h.memo %}<div class="kv" style="grid-column:1/-1"><div class="k">メモ</div><div class="v">{{ h.memo }}</div></div>{% endif %}
            </div>
          </section>
        </div>
      </article>
      {% endwith %}
    {% endfor %}
  </div>
{% else %}
  <div class="text-slate-400">保有はまだありません。</div>
{% endif %}

<script src="{% static 'js/holdings.js' %}?v=1"></script>
{% endblock %}