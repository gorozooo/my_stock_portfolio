{% extends "base.html" %}
{% load static humanize num %}

{% block title %}保有一覧{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/holdings_compact.css' %}?v=3.1">
{% endblock %}

{% block content %}
<div class="page-head">
  <h1>保有一覧</h1>
  <a href="{% url 'holding_create' %}" class="btn btn-outline">＋ 新規登録</a>
</div>

{% if page.object_list %}
  <div class="stack">
    {% for r in page.object_list %}{% with h=r.obj %}
    <article class="card row" data-swipe>
      <!-- 右スワイプアクション -->
      <div class="actions">
        <div class="action-panel" onclick="event.stopPropagation()">
          <button type="button" class="item detail" data-action="detail"><span class="ico">📄</span><span>詳細</span></button>
          <a class="item edit" href="{% url 'holding_edit' h.id %}"><span class="ico">✏️</span><span>編集</span></a>
          <button class="item delete"
                  hx-post="{% url 'holding_delete' h.id %}"
                  hx-confirm="削除しますか？"
                  hx-target="closest [data-swipe]"
                  hx-swap="outerHTML swap:15ms"><span class="ico">🗑️</span><span>削除</span></button>
        </div>
      </div>

      <!-- 本文 -->
      <div class="track">
        <!-- 1行ヘッダ：左=銘柄名/チップ、右=スパーク -->
        <header class="head">
          <div class="head__left">
            <div class="name" title="{{ h.name|default:'-' }}">{{ h.name|default:"-" }}</div>
            <div class="chips">
              <span class="chip code">{{ h.ticker }}</span>
              <span class="chip">{{ h.get_broker_display }}</span>
              <span class="chip">{{ h.get_account_display }}</span>
              <span class="chip {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
            </div>
          </div>
          <div class="head__spark">
            {% if r.spark %}
              <svg class="spark" viewBox="0 0 96 24" preserveAspectRatio="none"
                   data-spark='{{ r.spark|safe }}'
                   data-rate='{{ r.pnl_pct|default:0 }}'></svg>
            {% endif %}
          </div>
        </header>

        <!-- メトリクス 1段だけ：4つの極小ピル -->
        <section class="stats">
          <div class="stat">
            <div class="stat__k">数量</div>
            <div class="stat__v">{{ h.quantity|intcomma }}</div>
          </div>
          <div class="stat">
            <div class="stat__k">平均取得</div>
            <div class="stat__v">¥{{ h.avg_cost|floatformat:0|intcomma }}</div>
          </div>
          <div class="stat {% if r.pnl is not None and r.pnl < 0 %}neg{% else %}pos{% endif %}">
            <div class="stat__k">含み損益</div>
            <div class="stat__v">{% if r.pnl is not None %}¥{{ r.pnl|floatformat:0|intcomma }}{% else %}—{% endif %}</div>
          </div>
          <div class="stat {% if r.pnl_pct is not None and r.pnl_pct < 0 %}neg{% else %}pos{% endif %}">
            <div class="stat__k">損益率</div>
            <div class="stat__v">{% if r.pnl_pct is not None %}{{ r.pnl_pct|floatformat:2 }}%{% else %}—{% endif %}</div>
          </div>
        </section>

        <!-- 折りたたみ詳細（必要なら） -->
        <section class="more">
          <div class="moregrid">
            <div class="kv"><div class="k">取得額</div><div class="v">¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div></div>
            <div class="kv"><div class="k">保有開始</div><div class="v">{{ h.opened_at|date:"Y-m-d"|default:"—" }}</div></div>
            <div class="kv"><div class="k">作成</div><div class="v">{{ h.created_at|date:"Y-m-d" }}</div></div>
            <div class="kv"><div class="k">更新</div><div class="v">{{ h.updated_at|date:"Y-m-d" }}</div></div>
            {% if h.memo %}<div class="kv" style="grid-column:1/-1"><div class="k">メモ</div><div class="v">{{ h.memo }}</div></div>{% endif %}
          </div>
        </section>
      </div>
    </article>
    {% endwith %}{% endfor %}
  </div>
{% else %}
  <div class="text-slate-400">保有はまだありません。</div>
{% endif %}

<!-- 既存の swipe/描画JS を流用。ファイル名はそのままでもOK -->
<script src="{% static 'js/holdings.js' %}?v=1.1"></script>
<script>
/* 最小限のスパーク描画（色=損益率） */
(function(){
  function draw(svg, data, col){
    if(!data||!data.length){ svg.innerHTML=''; return; }
    let min=Math.min(...data), max=Math.max(...data); if(min===max){min-=1e-6;max+=1e-6;}
    const w=96,h=24,p=1.5,step=(w-p*2)/Math.max(data.length-1,1);
    const d=data.map((v,i)=>`${
      i?'L':'M'
    }${(p+i*step).toFixed(2)},${(h-p - (v-min)/(max-min)*(h-p*2)).toFixed(2)}`).join(' ');
    svg.innerHTML=`<path d="${d}" fill="none" stroke="${col}" stroke-width="1.6" stroke-linecap="round" opacity=".95" />`;
  }
  document.querySelectorAll('svg.spark').forEach(svg=>{
    try{
      const arr = JSON.parse(svg.dataset.spark||'[]');
      const rate = parseFloat(svg.dataset.rate||'0');
      const col = (isFinite(rate) && rate<0) ? '#ef4444' : '#22c55e';
      draw(svg, arr, col);
    }catch(_){}
  });
})();
</script>
{% endblock %}