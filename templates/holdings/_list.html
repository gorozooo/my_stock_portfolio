{# templates/holdings/_list.html #}
{% load humanize num %}

{# ---- サマリー（KPI） ---- #}
<div class="summary-bar" style="display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 12px">
  <div class="sb-item" style="min-width:120px;flex:1;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;background:rgba(255,255,255,.04)">
    <div class="sb-k" style="font-size:12px;color:#9fb0c8">取得額合計</div>
    <div class="sb-v" style="font-size:16px">¥{{ summary.acq|floatformat:0|intcomma }}</div>
  </div>
  <div class="sb-item" style="min-width:120px;flex:1;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;background:rgba(255,255,255,.04)">
    <div class="sb-k" style="font-size:12px;color:#9fb0c8">評価額合計</div>
    <div class="sb-v" style="font-size:16px">{% if summary.val is not None %}¥{{ summary.val|floatformat:0|intcomma }}{% else %}—{% endif %}</div>
  </div>
  <div class="sb-item" style="min-width:120px;flex:1;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;background:rgba(255,255,255,.04)">
    <div class="sb-k" style="font-size:12px;color:#9fb0c8">含み損益</div>
    <div class="sb-v {% if summary.pnl and summary.pnl < 0 %}neg{% else %}pos{% endif %}" style="font-size:16px;color:{% if summary.pnl and summary.pnl < 0 %}#ef4444{% else %}#22c55e{% endif %}">
      {% if summary.pnl is not None %}¥{{ summary.pnl|floatformat:0|intcomma }}{% else %}—{% endif %}
    </div>
  </div>
  <div class="sb-item" style="min-width:120px;flex:1;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;background:rgba(255,255,255,.04)">
    <div class="sb-k" style="font-size:12px;color:#9fb0c8">損益率</div>
    <div class="sb-v {% if summary.pnl_pct and summary.pnl_pct < 0 %}neg{% else %}pos{% endif %}" style="font-size:16px;color:{% if summary.pnl_pct and summary.pnl_pct < 0 %}#ef4444{% else %}#22c55e{% endif %}">
      {% if summary.pnl_pct is not None %}{{ summary.pnl_pct|floatformat:2 }}%{% else %}—{% endif %}
    </div>
  </div>
  <div class="sb-item" style="min-width:120px;flex:1;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;background:rgba(255,255,255,.04)">
    <div class="sb-k" style="font-size:12px;color:#9fb0c8">勝率</div>
    <div class="sb-v" style="font-size:16px">{% if summary.win_rate is not None %}{{ summary.win_rate|floatformat:1 }}%{% else %}—{% endif %}</div>
  </div>
</div>

{# ---- 内訳（実現と同じノリ：グリッド） ---- #}
{% if breakdown.broker or breakdown.account %}
  <div class="break-wrap" style="display:grid;grid-template-columns:1fr;gap:10px;margin:4px 0 12px">
    {% if breakdown.broker %}
      <section class="break-sec" style="border:1px solid rgba(255,255,255,.1);border-radius:12px;background:rgba(255,255,255,.03)">
        <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,.08)">
          <strong>ブローカー別</strong>
          <span style="opacity:.65;font-size:12px">（件数 / 取得 / 評価 / PnL / PnL% / 勝率）</span>
        </div>
        <div class="break-grid" style="display:grid;grid-template-columns:1fr;gap:8px;padding:8px 10px">
          {% for b in breakdown.broker %}
            <div class="bcard" style="display:grid;grid-template-columns:1.2fr repeat(5,1fr);gap:8px;align-items:center;background:rgba(255,255,255,.04);padding:8px;border:1px solid rgba(255,255,255,.08);border-radius:10px">
              <div style="font-weight:700">{{ b.label }}</div>
              <div>{{ b.count }}</div>
              <div>¥{{ b.acq|floatformat:0|intcomma }}</div>
              <div>{% if b.val is not None %}¥{{ b.val|floatformat:0|intcomma }}{% else %}—{% endif %}</div>
              <div style="color:{% if b.pnl and b.pnl < 0 %}#ef4444{% else %}#22c55e{% endif %}">
                {% if b.pnl is not None %}¥{{ b.pnl|floatformat:0|intcomma }}{% else %}—{% endif %}
              </div>
              <div style="color:{% if b.pnl_pct and b.pnl_pct < 0 %}#ef4444{% else %}#22c55e{% endif %}">
                {% if b.pnl_pct is not None %}{{ b.pnl_pct|floatformat:2 }}%{% else %}—{% endif %}
              </div>
              <div>{% if b.win_rate is not None %}{{ b.win_rate|floatformat:1 }}%{% else %}—{% endif %}</div>
            </div>
          {% endfor %}
        </div>
      </section>
    {% endif %}

    {% if breakdown.account %}
      <section class="break-sec" style="border:1px solid rgba(255,255,255,.1);border-radius:12px;background:rgba(255,255,255,.03)">
        <div style="display:flex;align-items:center;gap:8px;padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,.08)">
          <strong>口座別</strong>
          <span style="opacity:.65;font-size:12px">（件数 / 取得 / 評価 / PnL / PnL% / 勝率）</span>
        </div>
        <div class="break-grid" style="display:grid;grid-template-columns:1fr;gap:8px;padding:8px 10px">
          {% for a in breakdown.account %}
            <div class="bcard" style="display:grid;grid-template-columns:1.2fr repeat(5,1fr);gap:8px;align-items:center;background:rgba(255,255,255,.04);padding:8px;border:1px solid rgba(255,255,255,.08);border-radius:10px">
              <div style="font-weight:700">{{ a.label }}</div>
              <div>{{ a.count }}</div>
              <div>¥{{ a.acq|floatformat:0|intcomma }}</div>
              <div>{% if a.val is not None %}¥{{ a.val|floatformat:0|intcomma }}{% else %}—{% endif %}</div>
              <div style="color:{% if a.pnl and a.pnl < 0 %}#ef4444{% else %}#22c55e{% endif %}">
                {% if a.pnl is not None %}¥{{ a.pnl|floatformat:0|intcomma }}{% else %}—{% endif %}
              </div>
              <div style="color:{% if a.pnl_pct and a.pnl_pct < 0 %}#ef4444{% else %}#22c55e{% endif %}">
                {% if a.pnl_pct is not None %}{{ a.pnl_pct|floatformat:2 }}%{% else %}—{% endif %}
              </div>
              <div>{% if a.win_rate is not None %}{{ a.win_rate|floatformat:1 }}%{% else %}—{% endif %}</div>
            </div>
          {% endfor %}
        </div>
      </section>
    {% endif %}
  </div>
{% endif %}

{# ---- ここから既存カード一覧 ---- #}
{% if page.object_list %}
  <div class="stack">
    {% for r in page.object_list %}{% with h=r.obj %}
    <article class="card row" data-swipe>
      <div class="actions">
        <div class="action-panel" onclick="event.stopPropagation()">
          <button type="button" class="item detail" data-action="detail"><span class="ico">📄</span><span>詳細</span></button>
          <a class="item edit" href="{% url 'holding_edit' h.id %}"><span class="ico">✏️</span><span>編集</span></a>
          <button class="item delete"
                  hx-post="{% url 'holding_delete' h.id %}"
                  hx-confirm="削除しますか？"
                  hx-target="closest [data-swipe]"
                  hx-swap="outerHTML swap:15ms"><span class="ico">🗑️</span><span>削除</span></button>
        </div>
      </div>

      <div class="track">
        <header class="head">
          <div class="head__left">
            <div class="name" title="{{ h.name|default:'-' }}">{{ h.name|default:"-" }}</div>
            <div class="chips">
              <span class="chip code">{{ h.ticker }}</span>
              <span class="chip">{{ h.get_broker_display }}</span>
              <span class="chip">{{ h.get_account_display }}</span>
              <span class="chip {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
            </div>
          </div>
          <div class="head__spark">
            <svg class="spark"
                 viewBox="0 0 96 24" preserveAspectRatio="none"
                 data-rate="{{ r.pnl_pct|default:0 }}"
                 data-s7i='{{ r.s7_idx|default:"[]"|safe }}'
                 data-s30i='{{ r.s30_idx|default:"[]"|safe }}'
                 data-s90i='{{ r.s90_idx|default:"[]"|safe }}'
                 data-s7r='{{ r.s7_raw|default:"[]"|safe }}'
                 data-s30r='{{ r.s30_raw|default:"[]"|safe }}'
                 data-s90r='{{ r.s90_raw|default:"[]"|safe }}'></svg>
          </div>
        </header>

        <section class="stats">
          <div class="stat"><div class="stat__k">数量</div><div class="stat__v">{{ h.quantity|intcomma }}</div></div>
          <div class="stat"><div class="stat__k">平均取得</div><div class="stat__v">¥{{ h.avg_cost|floatformat:0|intcomma }}</div></div>
          <div class="stat {% if r.pnl is not None and r.pnl < 0 %}neg{% else %}pos{% endif %}">
            <div class="stat__k">含み損益</div>
            <div class="stat__v">{% if r.pnl is not None %}¥{{ r.pnl|floatformat:0|intcomma }}{% else %}—{% endif %}</div>
          </div>
          <div class="stat {% if r.pnl_pct is not None and r.pnl_pct < 0 %}neg{% else %}pos{% endif %}">
            <div class="stat__k">損益率</div>
            <div class="stat__v">{% if r.pnl_pct is not None %}{{ r.pnl_pct|floatformat:2 }}%{% else %}—{% endif %}</div>
          </div>
        </section>

        <section class="more">
          <div class="moregrid">
            <div class="kv"><div class="k">取得額</div><div class="v">¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div></div>
            <div class="kv"><div class="k">保有開始</div><div class="v">{{ h.opened_at|date:"Y-m-d"|default:"—" }}</div></div>
            <div class="kv"><div class="k">保有日数</div><div class="v">{{ r.days|default:"—" }}</div></div>
            <div class="kv"><div class="k">更新</div><div class="v">{{ h.updated_at|date:"Y-m-d" }}</div></div>
            {% if h.memo %}<div class="kv" style="grid-column:1/-1"><div class="k">メモ</div><div class="v">{{ h.memo }}</div></div>{% endif %}
          </div>
        </section>
      </div>
    </article>
    {% endwith %}{% endfor %}
  </div>

  {% if page.paginator.num_pages > 1 %}
  <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
    {% if page.has_previous %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.previous_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">前へ</a>
    {% endif %}
    <div style="opacity:.75;padding:8px 12px">Page {{page.number}} / {{page.paginator.num_pages}}</div>
    {% if page.has_next %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.next_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">次へ</a>
    {% endif %}
  </div>
  {% endif %}
{% else %}
  <div class="text-slate-400">保有はまだありません。</div>
{% endif %}