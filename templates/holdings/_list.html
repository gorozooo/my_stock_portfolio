{# templates/holdings/_list.html #}
{% load humanize num %}

{# --- ã‚«ãƒ¼ãƒ‰å†…2ã‚«ãƒ©ãƒ çµ±è¨ˆï¼ˆ3æšç›®é¢¨ï¼‰å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- #}
<style>
  .stats-v2{
    display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px;
  }
  .stats-v2 .blk{
    border:1px dashed rgba(255,255,255,.12);
    border-radius:14px; padding:10px;
    background:rgba(255,255,255,.03);
  }
  .stats-v2 .kv{display:flex; justify-content:space-between; gap:12px; padding:6px 0;}
  .stats-v2 .kv + .kv{border-top:1px dashed rgba(255,255,255,.08);}
  .stats-v2 .k{color:#9fb0c8; font-size:12px;}
  .stats-v2 .v{font-size:16px;}
  .stats-v2 .v.small{font-size:14px; opacity:.9}
  .stats-v2 .v.pos{color:#22c55e}
  .stats-v2 .v.neg{color:#ef4444}
  .stats-v2 .approx{opacity:.9}
  @media (max-width:520px){ .stats-v2{grid-template-columns:1fr;} }

  /* æ—¢å­˜ã‚«ãƒ¼ãƒ‰ã®éª¨æ ¼ï¼ˆå¿…è¦æœ€å°é™ã€‚ã‚ãªãŸã® holdings.css ãŒã‚ã‚Œã°ãã‚Œå„ªå…ˆã§OKï¼‰ */
  .stack{display:flex; flex-direction:column; gap:14px}
  .card{border:1px solid rgba(255,255,255,.10); border-radius:16px; background:rgba(255,255,255,.03)}
  .row{position:relative; overflow:hidden}
  .track{padding:14px}
  .head{display:flex; align-items:flex-start; gap:12px; justify-content:space-between}
  .head .name{font-weight:800; font-size:18px}
  .chips{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px}
  .chip{font-size:11px; padding:4px 8px; border:1px solid rgba(255,255,255,.14); border-radius:9999px; color:#dbe3f4}
  .chip.code{background:rgba(59,130,246,.12); border-color:rgba(59,130,246,.35)}
  .chip.buy{background:rgba(16,185,129,.12); border-color:rgba(16,185,129,.35)}
  .chip.sell{background:rgba(244,63,94,.12); border-color:rgba(244,63,94,.35)}
  .head__spark{width:96px; height:24px; margin-top:4px}
  .head__spark svg{width:96px; height:24px; display:block}

  /* ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
  [data-swipe] .actions{
    position:absolute; inset:0; display:flex; justify-content:flex-end;
    transform:translateX(100%); transition:transform .18s ease;
    pointer-events:none;
  }
  [data-swipe].is-open .actions{ transform:translateX(0); pointer-events:auto; }
  .action-panel{display:flex; gap:8px; align-items:center; padding:0 10px; background:rgba(12,18,26,.92)}
  .action-panel .item{
    display:flex; flex-direction:column; align-items:center; gap:4px;
    border:1px solid rgba(255,255,255,.14); border-radius:12px; padding:8px 10px;
    background:rgba(255,255,255,.06); color:#e5e7eb; font-size:12px;
  }
  .action-panel .item.delete{background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35)}
  .action-panel .ico{font-size:13px}
  .more{display:none; padding-top:8px}
  [data-swipe].show-detail .more{display:block}
  .moregrid{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
  .kv{display:flex; justify-content:space-between; gap:12px; padding:6px 0; border-top:1px dashed rgba(255,255,255,.08)}
  .k{color:#9fb0c8; font-size:12px}
  .v{font-size:16px}
  @media (max-width:520px){ .moregrid{grid-template-columns:1fr} }
</style>

{% if page.object_list %}
  <div class="stack">
    {% for r in page.object_list %}
      {% with h=r.obj %}
      <article class="card row" data-swipe>

        {# ===== ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè©³ç´°ï¼ç·¨é›†ï¼å£²å´ï¼å‰Šé™¤ï¼‰ ===== #}
        <div class="actions">
          <div class="action-panel" onclick="event.stopPropagation()">
            <button type="button" class="item detail" data-action="detail">
              <span class="ico">ğŸ“„</span><span>è©³ç´°</span>
            </button>
            <a class="item edit" href="{% url 'holding_edit' h.id %}">
              <span class="ico">âœï¸</span><span>ç·¨é›†</span>
            </a>
            <a class="item sell" href="{% url 'holding_close_sheet' h.id %}">
              <span class="ico">ğŸ’±</span><span>å£²å´</span>
            </a>
            <button class="item delete"
                    hx-post="{% url 'holding_delete' h.id %}"
                    hx-confirm="å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
                    hx-target="closest [data-swipe]"
                    hx-swap="outerHTML swap:15ms">
              <span class="ico">ğŸ—‘ï¸</span><span>å‰Šé™¤</span>
            </button>
          </div>
        </div>

        {# ===== è¡¨ç¤ºé¢ ===== #}
        <div class="track">
          <header class="head">
            <div>
              <div class="name" title="{{ h.name|default:'-' }}">{{ h.name|default:"-" }}</div>
              <div class="chips">
                <span class="chip code">{{ h.ticker }}</span>
                <span class="chip">{{ h.get_broker_display }}</span>
                <span class="chip">{{ h.get_account_display }}</span>
                <span class="chip {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
              </div>
            </div>
            <div class="head__spark">
              <svg class="spark" viewBox="0 0 96 24" preserveAspectRatio="none"
                   data-rate="{{ r.pnl_pct|default:0 }}"
                   data-s7i='{{ r.s7_idx|default:"[]"|safe }}'
                   data-s30i='{{ r.s30_idx|default:"[]"|safe }}'
                   data-s90i='{{ r.s90_idx|default:"[]"|safe }}'
                   data-s7r='{{ r.s7_raw|default:"[]"|safe }}'
                   data-s30r='{{ r.s30_raw|default:"[]"|safe }}'
                   data-s90r='{{ r.s90_raw|default:"[]"|safe }}'></svg>
            </div>
          </header>

          {# ===== ã“ã“ãŒã€Œ3æšç›®ã¨åŒã˜ã€2ã‚«ãƒ©ãƒ ã®ç™½æ ã‚¨ãƒªã‚¢ ===== #}
          <section class="stats-v2">
            {# å·¦ãƒ–ãƒ­ãƒƒã‚¯ï¼šç¾åœ¨å€¤ãƒ»åˆ©å›ã‚Šï¼ˆå–å¾—ï¼ç¾åœ¨ï¼‰ #}
            <div class="blk">
              <div class="kv">
                <div class="k">ç´„ ç¾åœ¨å€¤</div>
                <div class="v approx">
                  {% if r.price is not None %}Â¥{{ r.price|floatformat:1|intcomma }}{% else %}â€”{% endif %}
                </div>
              </div>
              <div class="kv">
                <div class="k">å–å¾—å˜ä¾¡</div>
                <div class="v">Â¥{{ h.avg_cost|floatformat:2|intcomma }}</div>
              </div>
              <div class="kv">
                <div class="k">ç¾åœ¨åˆ©å›ã‚Š</div>
                <div class="v small">
                  {% if r.yield_current is not None %}{{ r.yield_current|floatformat:2 }} %{% else %}â€”{% endif %}
                </div>
              </div>
              <div class="kv">
                <div class="k">å–å¾—åˆ©å›ã‚Š</div>
                <div class="v small">
                  {% if r.yield_cost is not None %}{{ r.yield_cost|floatformat:2 }} %{% else %}â€”{% endif %}
                </div>
              </div>
            </div>

            {# å³ãƒ–ãƒ­ãƒƒã‚¯ï¼šä¿æœ‰æ•°ãƒ»å–å¾—é¡ãƒ»è©•ä¾¡é¡(+æç›Šç‡)ãƒ»å¹´é–“é…å½“ #}
            <div class="blk">
              <div class="kv">
                <div class="k">ä¿æœ‰æ•°</div>
                <div class="v">{{ h.quantity|intcomma }} <span class="v small">æ ª</span></div>
              </div>
              <div class="kv">
                <div class="k">å–å¾—é¡</div>
                <div class="v">Â¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div>
              </div>
              <div class="kv">
                <div class="k">è©•ä¾¡é¡</div>
                <div class="v">
                  {% if r.val is not None %}Â¥{{ r.val|floatformat:0|intcomma }}{% else %}â€”{% endif %}
                  {% if r.pnl_pct is not None %}
                    <span class="v small {% if r.pnl_pct < 0 %}neg{% else %}pos{% endif %}">
                      ({% if r.pnl_pct > 0 %}+{% endif %}{{ r.pnl_pct|floatformat:2 }}%)
                    </span>
                  {% endif %}
                </div>
              </div>
              <div class="kv">
                <div class="k">å¹´é–“é…å½“</div>
                <div class="v">
                  {% if r.div_annual is not None %}Â¥{{ r.div_annual|floatformat:0|intcomma }}{% else %}â€”{% endif %}
                </div>
              </div>
            </div>
          </section>

          {# ===== ã‚¹ãƒ¯ã‚¤ãƒ—ã§å‡ºã™è©³ç´°ï¼ˆä»¥å‰ã©ãŠã‚Šï¼‰ ===== #}
          <section class="more">
            <div class="moregrid">
              <div class="kv" style="border-top:none">
                <div class="k">ä¿æœ‰é–‹å§‹</div>
                <div class="v">{{ h.opened_at|date:"Y-m-d"|default:"â€”" }}</div>
              </div>
              <div class="kv" style="border-top:none">
                <div class="k">ä¿æœ‰æ—¥æ•°</div>
                <div class="v">{{ r.days|months_from_days }}</div>
              </div>
              <div class="kv">
                <div class="k">æ›´æ–°</div>
                <div class="v">{{ h.updated_at|date:"Y-m-d" }}</div>
              </div>
              {% if h.memo %}
              <div class="kv" style="grid-column:1/-1">
                <div class="k">ãƒ¡ãƒ¢</div><div class="v">{{ h.memo }}</div>
              </div>
              {% endif %}
            </div>
          </section>
        </div>
      </article>
      {% endwith %}
    {% endfor %}
  </div>

  {# ===== ãƒšãƒ¼ã‚¸ãƒ³ã‚° ===== #}
  {% if page.paginator.num_pages > 1 %}
  <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
    {% if page.has_previous %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.previous_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">å‰ã¸</a>
    {% endif %}
    <div style="opacity:.75;padding:8px 12px">Page {{page.number}} / {{page.paginator.num_pages}}</div>
    {% if page.has_next %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.next_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">æ¬¡ã¸</a>
    {% endif %}
  </div>
  {% endif %}
{% else %}
  <div class="text-slate-400">ä¿æœ‰ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
{% endif %}