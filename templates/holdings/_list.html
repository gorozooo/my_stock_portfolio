{# templates/holdings/_list.html #}
{% load humanize num %}

<style>
  .summary-line{ display:flex; align-items:stretch; gap:12px; margin-top:12px;
                 border-top:1px dashed rgba(255,255,255,.08); padding-top:12px; }
  .summary-item{ flex:1; min-width:0; display:flex; flex-direction:column; align-items:center; gap:2px; }
  .summary-item + .summary-item{ border-left:1px dashed rgba(255,255,255,.10); padding-left:12px; }
  .summary-k{ font-size:12px; color:#97a3b6; white-space:nowrap }
  .summary-v{ font-size:clamp(14px, 4.6vw, 20px); line-height:1.15; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .pnl-pos{ color:#34d399 } .pnl-neg{ color:#f87171 }

  /* === ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³ï¼ˆæç›Šç‡ã®å³ï¼‰ === */
  .pnl-rate{ display:flex; align-items:center; gap:8px; }
  .spark-wrap{ width:64px; height:20px; opacity:.55; }
  .spark-wrap svg{ width:100%; height:100%; display:block; }
  .spark-path{ fill:none; stroke-width:1.6; }
  .spark-pos{ stroke:#34d399 }   /* ç·‘ */
  .spark-neg{ stroke:#f87171 }   /* èµ¤ */
  .spark-base{ stroke:rgba(255,255,255,.20); stroke-dasharray:2 3; }

  @media (max-width:360px){
    .summary-v{ font-size:clamp(13px, 4.2vw, 18px); }
    .spark-wrap{ width:56px; }
  }
</style>

{% if page.object_list %}
  <div class="vstack">
    {% for r in page.object_list %}
      {% with h=r.obj %}
      <article class="card row" data-swipe>
        <div class="actions">
          <div class="action-panel">
            <button type="button" class="item detail" data-action="detail" aria-label="è©³ç´°ã‚’é–‹ã">
              <span class="ico">ğŸ“„</span><span>è©³ç´°</span>
            </button>
            <a class="item edit" href="{% url 'holding_edit' h.id %}" aria-label="ç·¨é›†ã¸">
              <span class="ico">âœï¸</span><span>ç·¨é›†</span>
            </a>
            <button class="item delete"
                    hx-post="{% url 'holding_delete' h.id %}"
                    hx-confirm="å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
                    hx-target="closest [data-swipe]"
                    hx-swap="outerHTML swap:15ms"
                    aria-label="å‰Šé™¤">
              <span class="ico">ğŸ—‘ï¸</span><span>å‰Šé™¤</span>
            </button>
          </div>
        </div>

        <div class="track">
          <div class="body">
            <header class="title">
              <div class="name name-fit" title="{{ h.name|default:'-' }}">{{ h.name|default:"-" }}</div>
              <div class="subline">
                <div class="badges">
                  <span class="badge badge--code">{{ h.ticker }}</span>
                  <span class="badge">{{ h.get_broker_display }}</span>
                  <span class="badge">{{ h.get_account_display }}</span>
                  <span class="badge {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
                </div>
              </div>
            </header>

            <!-- === 1è¡Œã‚µãƒãƒªãƒ¼ === -->
            <div class="summary-line">
              <div class="summary-item">
                <div class="summary-k">æ•°é‡</div>
                <div class="summary-v">{{ h.quantity|intcomma }}</div>
              </div>
              <div class="summary-item">
                <div class="summary-k">å¹³å‡å–å¾—</div>
                <div class="summary-v">Â¥{{ h.avg_cost|floatformat:0|intcomma }}</div>
              </div>
              <div class="summary-item">
                <div class="summary-k">å«ã¿æç›Š</div>
                <div class="summary-v {% if r.pnl and r.pnl > 0 %}pnl-pos{% elif r.pnl and r.pnl < 0 %}pnl-neg{% endif %}">
                  {% if r.pnl is not None %}Â¥{{ r.pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}
                </div>
              </div>
              <div class="summary-item">
                <div class="summary-k">æç›Šç‡</div>
                <div class="pnl-rate">
                  <div class="summary-v {% if r.pnl_pct and r.pnl_pct > 0 %}pnl-pos{% elif r.pnl_pct and r.pnl_pct < 0 %}pnl-neg{% endif %}">
                    {% if r.pnl_pct is not None %}{{ r.pnl_pct|floatformat:2 }}%{% else %}â€”{% endif %}
                  </div>
                  {# data-spark : ã€Œå°ã•ã„æ•°å€¤é…åˆ—ã€ã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ã€‚ä¾‹: 1,1.2,0.9,1.3 ... #}
                  {% if r.spark %}
                    <div class="spark-wrap"
                         data-spark="{{ r.spark|join:',' }}"
                         data-pos="{% if r.pnl_pct and r.pnl_pct >= 0 %}1{% else %}0{% endif %}">
                      <!-- JS ã§SVGã‚’å·®ã—è¾¼ã‚€ -->
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- === è©³ç´° === -->
          <div class="more">
            <div class="moregrid">
              <div class="kv" style="border:none;padding:0">
                <div class="k">è©•ä¾¡é¡</div>
                <div class="v">{% if r.valuation is not None %}Â¥{{ r.valuation|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div>
              </div>
              <div class="kv" style="border:none;padding:0">
                <div class="k">å–å¾—é¡</div>
                <div class="v">Â¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div>
              </div>
              <div class="kv"><div class="k">ä¿æœ‰é–‹å§‹</div><div class="v">{{ h.opened_at|date:"Y-m-d"|default:"â€”" }}</div></div>
              <div class="kv"><div class="k">ä¿æœ‰æ—¥æ•°</div><div class="v">{{ r.days|default:"â€”" }}</div></div>
              <div class="kv"><div class="k">ä½œæˆ</div><div class="v">{{ h.created_at|date:"Y-m-d" }}</div></div>
              <div class="kv"><div class="k">æ›´æ–°</div><div class="v">{{ h.updated_at|date:"Y-m-d" }}</div></div>
            </div>
          </div>
        </div>
      </article>
      {% endwith %}
    {% endfor %}
  </div>

  {% if page.paginator.num_pages > 1 %}
  <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
    {% if page.has_previous %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.previous_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">å‰ã¸</a>
    {% endif %}
    <div style="opacity:.75;padding:8px 12px">Page {{page.number}} / {{page.paginator.num_pages}}</div>
    {% if page.has_next %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.next_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">æ¬¡ã¸</a>
    {% endif %}
  </div>
  {% endif %}
{% else %}
  <div class="text-slate-400">ä¿æœ‰ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
{% endif %}

<script>
/* ==== ã‚¹ãƒ¯ã‚¤ãƒ—ï¼†è©³ç´°ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰ ==== */
(function(){
  const rows=document.querySelectorAll('[data-swipe]');
  function getOpenW(a){const v=getComputedStyle(a).getPropertyValue('--open-w').trim().replace('px','');return parseFloat(v||'220');}
  function closeAll(except){document.querySelectorAll('[data-swipe].is-open').forEach(r=>{if(r===except)return; r.classList.remove('is-open');const a=r.querySelector('.actions');a.style.right=(-getOpenW(a))+'px';a.style.pointerEvents='none';});}
  rows.forEach(row=>{
    const actions=row.querySelector('.actions'); const detailBtn=row.querySelector('[data-action="detail"]'); const track=row.querySelector('.track');
    const OPEN_W=getOpenW(actions); actions.style.right=(-OPEN_W)+'px'; actions.style.pointerEvents='none';
    let startX=0,startY=0,drag=false,horiz=false,opened=false,baseRight=-OPEN_W;
    const setRight=(px)=> actions.style.right=px+'px';
    const onStart=(e)=>{ if(e.target.closest('.actions')) return; const t=e.touches?e.touches[0]:e; startX=t.clientX; startY=t.clientY;
      drag=true; horiz=false; baseRight=opened?0:-OPEN_W; actions.style.transition='none';
      if(document.querySelector('[data-swipe].is-open') && !row.classList.contains('is-open')) closeAll(row); };
    const onMove=(e)=>{ if(!drag) return; const t=e.touches?e.touches[0]:e; const dx=t.clientX-startX, dy=t.clientY-startY;
      if(!horiz){ if(Math.abs(dx)<8) return; if(Math.abs(dx)>Math.abs(dy)) horiz=true; else {drag=false; actions.style.transition=''; return;} }
      if(e.cancelable) e.preventDefault(); let nr=baseRight-dx; if(nr>0) nr=0; if(nr<-OPEN_W) nr=-OPEN_W; setRight(nr); };
    const onEnd=()=>{ if(!drag) return; drag=false; actions.style.transition='right .18s ease-out';
      const curRight=parseFloat(getComputedStyle(actions).right)||-OPEN_W; opened=(curRight>-OPEN_W/2);
      if(opened){ row.classList.add('is-open'); setRight(0); actions.style.pointerEvents='auto'; }
      else { row.classList.remove('is-open'); setRight(-OPEN_W); actions.style.pointerEvents='none'; } };
    row.addEventListener('touchstart', onStart, {passive:true});
    row.addEventListener('touchmove',  onMove,  {passive:false});
    row.addEventListener('touchend',   onEnd);
    detailBtn.addEventListener('click', ()=>{ row.classList.toggle('show-detail');
      opened=false; row.classList.remove('is-open'); setRight(-OPEN_W); actions.style.pointerEvents='none'; });
    track.addEventListener('click', (ev)=>{ if(ev.target.closest('.actions, .item, a, button')) return;
      if(row.classList.contains('show-detail')) row.classList.remove('show-detail');
      if(row.classList.contains('is-open')) { row.classList.remove('is-open'); setRight(-OPEN_W); actions.style.pointerEvents='none'; } });
  });
})();

/* ==== ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ©ã‚¤ãƒ³æç”»ï¼ˆè¶…è»½é‡SVGï¼‰ ==== */
(function(){
  const els=document.querySelectorAll('.spark-wrap[data-spark]');
  els.forEach(el=>{
    const raw=(el.getAttribute('data-spark')||'').trim();
    if(!raw) return;
    const arr=raw.split(',').map(s=>parseFloat(s)).filter(v=>isFinite(v));
    if(arr.length<3) return;
    const w=el.clientWidth||64, h=el.clientHeight||20, pad=1;
    // æ­£è¦åŒ–
    let min=Math.min.apply(null, arr), max=Math.max.apply(null, arr);
    if(min===max){ min-=1; max+=1; }
    const nx=i=> pad + (i*(w-2*pad)/(arr.length-1));
    const ny=v=> h-pad - ((v-min)/(max-min))*(h-2*pad);
    // ãƒ‘ã‚¹ç”Ÿæˆ
    let d='M'+nx(0)+','+ny(arr[0]);
    for(let i=1;i<arr.length;i++){ d+=' L'+nx(i)+','+ny(arr[i]); }
    const pos = el.getAttribute('data-pos')==='1';
    const strokeClass = pos ? 'spark-pos' : 'spark-neg';
    const svg =
`<svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-hidden="true">
   <path class="spark-base" d="M0 ${h/2} H ${w}" />
   <path class="spark-path ${strokeClass}" d="${d}"/>
 </svg>`;
    el.innerHTML=svg;
  });
})();
</script>