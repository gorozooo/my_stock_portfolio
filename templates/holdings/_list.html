{% load humanize num %}

<style>
  /* ==== ã‚µãƒãƒªãƒ¼ï¼ˆè»½ãåœ§ç¸®ã®ã¾ã¾ï¼‰ ==== */
  .sumbox{border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(255,255,255,.03);margin:6px 0 10px}
  .sumbox .sumhead{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,.10);cursor:pointer}
  .sumbox .sumtitle{display:flex;gap:6px;align-items:center;font-weight:800}
  .sumbox .sumchev{font-size:12px;opacity:.8;transform:rotate(-90deg);transition:transform .15s ease}
  .sumbox.is-open .sumchev{transform:rotate(0deg)}
  .sumbox .sumhint{opacity:.6;font-size:11px}
  .sumbox:not(.is-open) .sumtitle{display:none}
  .summini{display:flex;gap:6px;flex-wrap:nowrap;overflow-x:auto;max-width:100%;padding-bottom:2px}
  .summini .pill{white-space:nowrap;font-size:11px;border:1px solid rgba(255,255,255,.12);border-radius:9999px;padding:4px 8px;background:rgba(255,255,255,.05)}
  .summini .pill .k{opacity:.7;margin-right:4px}
  .summini .pos{color:#22c55e}.summini .neg{color:#ef4444}
  .sumbox.is-open .summini{display:none}
  .sumbox .sumbody{display:none;padding:8px}
  .sumbox.is-open .sumbody{display:block}

  /* ==== KPIï¼ˆåœ§ç¸®ï¼‰ ==== */
  .kpi-grid{display:grid;gap:4px;grid-template-columns:repeat(auto-fit,minmax(110px,1fr))}
  .kpi{min-width:100px;border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:4px 6px;background:rgba(255,255,255,.04)}
  .kpi-k{font-size:10px;color:#9fb0c8}
  .kpi-v{font-size:13px;font-weight:600}
  .kpi-v.pos{color:#22c55e}.kpi-v.neg{color:#ef4444}

  /* ================= ã‚«ãƒ¼ãƒ‰ ================= */
  .row{border:1px solid rgba(255,255,255,.11);border-radius:11px;background:rgba(255,255,255,.03);overflow:hidden}
  .row + .row{margin-top:8px}
  .track{padding:4px 8px}

  /* ------ ä¸Šæ®µï¼šè¦‹å‡ºã—ï¼ˆâ€œã‚†ã¨ã‚Šã‚ã‚Šâ€ï¼‰ ------ */
  .head{
    display:grid;grid-template-columns:1fr auto;align-items:flex-start;gap:8px;
    padding:8px 2px 10px; /* ã‚†ã£ãŸã‚Š */
    border-bottom:1px dashed rgba(255,255,255,.10);
  }
  .head__left{min-width:0}
  .name{
    font-weight:780;font-size:16px;line-height:1.18;letter-spacing:.01em;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
  .chip{font-size:10.5px;border:1px solid rgba(255,255,255,.14);border-radius:9999px;padding:3px 7px;color:#cfe1ff;background:rgba(255,255,255,.05)}
  .chip.code{color:#a8c6ff}
  .chip.buy{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.30)}
  .chip.sell{background:rgba(244,63,94,.12);border-color:rgba(244,63,94,.30)}
  .head__spark{width:64px !important;height:18px !important;flex:0 0 64px !important}
  .head__spark svg{width:100% !important;height:100% !important}

  /* ------ ä¸‹æ®µï¼šæ˜ç´°ï¼ˆâ€œå®Œå…¨ã«è©°ã‚ã‚‹â€ï¼‰ ------ */
  .stats-compact{
    display:grid !important;
    grid-template-columns:1fr 1fr !important;
    gap:2px;
    margin-top:2px;
    padding-top:2px;
    border-top:1px dashed rgba(255,255,255,.08);
  }
  .stats-col{display:grid;row-gap:1px}
  .kv2{display:flex;align-items:baseline;justify-content:space-between;gap:2px}
  .kv2 .k{font-size:10px;color:#9fb0c8;letter-spacing:.01em;line-height:1}
  .kv2 .k::after{content:"ï¼š";opacity:.5}
  .kv2 .v{font-size:12.5px;font-weight:600;font-variant-numeric:tabular-nums;line-height:1}
  .kv2.small .v{font-size:12px}
  .unit{opacity:.7;font-size:10px;margin-left:2px;line-height:1}
  .pct{font-size:10px;margin-left:2px;opacity:.9;line-height:1}
  .pct.pos{color:#3b82f6}.pct.neg{color:#ef4444}

  /* ã©ã®å¹…ã§ã‚‚1ã‚«ãƒ©ãƒ ã«ã—ãªã„ï¼ˆä¿é™ºï¼‰ */
  @media (max-width:520px){
    .stats-compact{grid-template-columns:1fr 1fr !important}
    .head{grid-template-columns:1fr auto}
  }

  /* ===== è©³ç´°ï¼šãƒœã‚¿ãƒ³ã§é–‹é–‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤ºï¼‰ ===== */
.more{
  display:none;                 /* ãƒœã‚¿ãƒ³ã§ .show-detail ã‚’ä»˜ã‘ãŸæ™‚ã ã‘è¡¨ç¤º */
  margin-top:2px;
  padding-top:2px;
  border-top:1px dashed rgba(255,255,255,.08);
}
.row.show-detail .more{display:block}

/* è©³ç´°ã‚°ãƒªãƒƒãƒ‰ï¼šä¸‹æ®µã¨åŒã˜ã‚¿ã‚¤ãƒˆã• */
.moregrid{
  display:grid;
  grid-template-columns:1fr 1fr; /* å¸¸ã«2åˆ— */
  gap:2px;
}
.moregrid .kv2{
  /* .kv2 ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆâ†“ã¯ä¿é™ºã§ã®æœ€å°ä¸Šæ›¸ãï¼‰ */
  min-width:0;
}
.moregrid .kv2 .v{
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
/* ãƒ¡ãƒ¢ã¯æ¨ªå¹…ã„ã£ã±ã„ */
.moregrid .kv2.memo{ grid-column:1 / -1; }

  @media (max-width:520px){
    .moregrid{grid-template-columns:1fr 1fr;}
  }

  /* ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ—¢å­˜ï¼‰ */
  .actions{position:absolute;inset:0 0 0 auto;width:max(56vw,220px);transform:translateX(100%)}
  .action-panel{height:100%;display:flex;gap:8px;align-items:center;justify-content:flex-end;padding:0 10px;background:linear-gradient(90deg,rgba(13,17,23,0),rgba(13,17,23,.92))}
  .item{display:flex;gap:6px;align-items:center;border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:8px 10px;background:rgba(255,255,255,.06);font-size:12px}
  .item.delete{background:rgba(239,68,68,.1);border-color:rgba(239,68,68,.45)}
  .row.is-open .actions{transform:translateX(0)}
</style>

<div class="sumbox" id="holdings-sumbox">
  <div class="sumhead" data-toggle>
    <div class="sumtitle"><span class="sumchev">â–¸</span><span>KPIã‚µãƒãƒªãƒ¼</span></div>
    <div class="summini">
      <span class="pill"><span class="k">å–å¾—</span>Â¥{{ summary.acq|floatformat:0|intcomma }}</span>
      <span class="pill"><span class="k">å«ã¿æç›Š</span><span class="{% if summary.pnl and summary.pnl < 0 %}neg{% else %}pos{% endif %}">{% if summary.pnl is not None %}Â¥{{ summary.pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}</span></span>
      <span class="pill"><span class="k">æç›Šç‡</span><span class="{% if summary.pnl_pct and summary.pnl_pct < 0 %}neg{% else %}pos{% endif %}">{% if summary.pnl_pct is not None %}{{ summary.pnl_pct|floatformat:2 }}%{% else %}â€”{% endif %}</span></span>
    </div>
    <div class="sumhint">ã‚¿ãƒƒãƒ—ã§é–‹é–‰</div>
  </div>
  <div class="sumbody">
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-k">ä»¶æ•°</div><div class="kpi-v">{{ summary.count|default:"0" }}</div></div>
      <div class="kpi"><div class="kpi-k">å‹ç‡</div><div class="kpi-v">{% if summary.win_rate is not None %}{{ summary.win_rate|floatformat:1 }}%{% else %}â€”{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">å–å¾—é¡åˆè¨ˆ</div><div class="kpi-v">Â¥{{ summary.acq|floatformat:0|intcomma }}</div></div>
      <div class="kpi"><div class="kpi-k">è©•ä¾¡é¡åˆè¨ˆ</div><div class="kpi-v">{% if summary.val is not None %}Â¥{{ summary.val|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">å«ã¿æç›Š</div><div class="kpi-v {% if summary.pnl and summary.pnl < 0 %}neg{% else %}pos{% endif %}">{% if summary.pnl is not None %}Â¥{{ summary.pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">æç›Šç‡</div><div class="kpi-v {% if summary.pnl_pct and summary.pnl_pct < 0 %}neg{% else %}pos{% endif %}">{% if summary.pnl_pct is not None %}{{ summary.pnl_pct|floatformat:2 }}%{% else %}â€”{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">å‹ã¡ä»¶æ•° / è² ã‘ä»¶æ•°</div><div class="kpi-v">{{ summary.winners|default:"0" }} / {{ summary.losers|default:"0" }}</div></div>
      <div class="kpi"><div class="kpi-k">å¹³å‡ä¿æœ‰æ—¥æ•°</div><div class="kpi-v">{% if summary.avg_days is not None %}{{ summary.avg_days|floatformat:0 }}æ—¥{% else %}â€”{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">ä¸­å¤®å€¤ï¼ˆä¿æœ‰æ—¥æ•°ï¼‰</div><div class="kpi-v">{% if summary.med_days is not None %}{{ summary.med_days|floatformat:0 }}æ—¥{% else %}â€”{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">å¹³å‡ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚º</div><div class="kpi-v">{% if summary.avg_pos_size is not None %}Â¥{{ summary.avg_pos_size|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">æœ€å¤§ç›Š</div><div class="kpi-v {% if summary.top_gain_pnl and summary.top_gain_pnl < 0 %}neg{% else %}pos{% endif %}">{% if summary.top_gain_pnl is not None %}Â¥{{ summary.top_gain_pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">æœ€å¤§æ</div><div class="kpi-v {% if summary.top_loss_pnl and summary.top_loss_pnl < 0 %}neg{% else %}pos{% endif %}">{% if summary.top_loss_pnl is not None %}Â¥{{ summary.top_loss_pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
    </div>
  </div>
</div>

<script>
  function initHoldingsSumbox(ctx){
    const box=(ctx||document).querySelector('#holdings-sumbox'); if(!box) return;
    const KEY='holdings.sumbox.open.v2', head=box.querySelector('[data-toggle]');
    const saved=localStorage.getItem(KEY); if(saved==='1'){box.classList.add('is-open')}else{box.classList.remove('is-open')}
    head.onclick=()=>{ box.classList.toggle('is-open'); localStorage.setItem(KEY, box.classList.contains('is-open')?'1':'0'); };
  }
  initHoldingsSumbox(document);
  document.body.addEventListener('htmx:load', e=>initHoldingsSumbox(e.target));
</script>

{% if page.object_list %}
  <div class="stack">
    {% for r in page.object_list %}
      {% with h=r.obj %}
      <article class="card row" data-swipe>
        <!-- actions -->
        <div class="actions">
          <div class="action-panel" onclick="event.stopPropagation()">
            <button type="button" class="item detail" data-action="detail"><span class="ico">ğŸ“„</span><span>è©³ç´°</span></button>
            <a class="item edit" href="{% url 'holding_edit' h.id %}"><span class="ico">âœï¸</span><span>ç·¨é›†</span></a>
            <a class="item sell" href="{% url 'holding_close_sheet' h.id %}"><span class="ico">ğŸ’±</span><span>å£²å´</span></a>
            <button class="item delete"
                    hx-post="{% url 'holding_delete' h.id %}"
                    hx-confirm="å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
                    hx-target="closest [data-swipe]"
                    hx-swap="outerHTML swap:15ms">
              <span class="ico">ğŸ—‘ï¸</span><span>å‰Šé™¤</span>
            </button>
          </div>
        </div>

        <div class="track">
          <!-- header -->
          <header class="head">
            <div class="head__left">
              <div class="name" title="{{ h.name|default:'-' }}">{{ h.name|default:"-" }}</div>
              <div class="chips">
                <span class="chip code">{{ h.ticker|default:"â€”" }}</span>
                <span class="chip">{{ h.get_broker_display|default:"â€”" }}</span>
                <span class="chip">{{ h.get_account_display|default:"â€”" }}</span>
                <span class="chip {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side|default:"â€”" }}</span>
              </div>
            </div>
            <div class="head__spark">
              <svg class="spark" viewBox="0 0 96 24" preserveAspectRatio="none"
                   data-rate="{{ r.pnl_pct|default:0 }}"
                   data-s7i='{{ r.s7_idx|default:"[]"|safe }}'
                   data-s30i='{{ r.s30_idx|default:"[]"|safe }}'
                   data-s90i='{{ r.s90_idx|default:"[]"|safe }}'
                   data-s7r='{{ r.s7_raw|default:"[]"|safe }}'
                   data-s30r='{{ r.s30_raw|default:"[]"|safe }}'
                   data-s90r='{{ r.s90_raw|default:"[]"|safe }}'></svg>
            </div>
          </header>

          <!-- 2-col stats -->
          <section class="stats-compact">
            <!-- left -->
            <div class="stats-col">
              <div class="kv2 small">
                <div class="k">ç¾åœ¨å€¤</div>
                <div class="v">
                  <span class="cur-price"
                        data-val="{{ r.valuation|default:0 }}"
                        data-qty="{{ h.quantity|default:0 }}">â€”</span>
                  <span class="unit">å††</span>
                </div>
              </div>
              <div class="kv2 small">
                <div class="k">å–å¾—å˜ä¾¡</div>
                <div class="v">
                  {% if h.avg_cost is not None %}Â¥{{ h.avg_cost|floatformat:2|intcomma }}{% else %}â€”{% endif %}
                </div>
              </div>
              <div class="kv2 small">
                <div class="k">ç¾åœ¨åˆ©å›ã‚Š</div>
                <div class="v">{% if r.yield_now is not None %}{{ r.yield_now|floatformat:2 }}%{% else %}â€”{% endif %}</div>
              </div>
              <div class="kv2 small">
                <div class="k">å–å¾—åˆ©å›ã‚Š</div>
                <div class="v">{% if r.yield_cost is not None %}{{ r.yield_cost|floatformat:2 }}%{% else %}â€”{% endif %}</div>
              </div>
            </div>

            <!-- right -->
            <div class="stats-col">
              <div class="kv2">
                <div class="k">ä¿æœ‰æ•°</div>
                <div class="v">{{ h.quantity|default:0|intcomma }}<span class="unit">æ ª</span></div>
              </div>
              <div class="kv2">
                <div class="k">å–å¾—é¡</div>
                <div class="v">
                  {% if h.avg_cost is not None and h.quantity %}
                    Â¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}
                  {% else %}â€”{% endif %}
                </div>
              </div>
              <div class="kv2">
                <div class="k">è©•ä¾¡é¡</div>
                <div class="v">
                  {% if r.valuation is not None %}Â¥{{ r.valuation|floatformat:0|intcomma }}{% else %}â€”{% endif %}
                  {% if r.pnl_pct is not None %}
                    <span class="pct {% if r.pnl_pct < 0 %}neg{% else %}pos{% endif %}">
                      ({% if r.pnl_pct > 0 %}+{% endif %}{{ r.pnl_pct|floatformat:2 }} %)
                    </span>
                  {% endif %}
                </div>
              </div>
              <div class="kv2">
                <div class="k">å¹´é–“é…å½“</div>
                <div class="v">{% if r.div_annual is not None %}Â¥{{ r.div_annual|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div>
              </div>
            </div>
          </section>

          <!-- è©³ç´°ï¼ˆä»»æ„ï¼‰ -->
          <section class="more">
            {% with opened=h.opened_at days=r.days updated=h.updated_at %}
            <div class="moregrid">
              <div class="kv2">
                <div class="k">ä¿æœ‰é–‹å§‹</div>
                <div class="v">{% if opened %}{{ opened|date:"Y-m-d" }}{% else %}â€”{% endif %}</div>
              </div>
          
              <div class="kv2">
                <div class="k">ä¿æœ‰æ—¥æ•°</div>
                <div class="v">{% if days is not None %}{{ days|months_from_days }}{% else %}â€”{% endif %}</div>
              </div>
          
              <div class="kv2">
                <div class="k">æ›´æ–°</div>
                <div class="v">{% if updated %}{{ updated|date:"Y-m-d" }}{% else %}â€”{% endif %}</div>
              </div>
          
              {% if h.memo %}
              <div class="kv2 memo">
                <div class="k">ãƒ¡ãƒ¢</div>
                <div class="v">{{ h.memo }}</div>
              </div>
              {% endif %}
            </div>
            {% endwith %}
          </section>
        </div>  {# /.track #}
      </article>
      {% endwith %}
    {% endfor %}
  </div>

  {% if page.paginator.num_pages > 1 %}
    <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
      {% if page.has_previous %}
        <a hx-get="{% url 'holding_list_partial' %}?page={{page.previous_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
           hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">å‰ã¸</a>
      {% endif %}
      <div style="opacity:.75;padding:8px 12px">Page {{page.number}} / {{page.paginator.num_pages}}</div>
      {% if page.has_next %}
        <a hx-get="{% url 'holding_list_partial' %}?page={{page.next_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
           hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">æ¬¡ã¸</a>
      {% endif %}
    </div>
  {% endif %}
{% else %}
  <div class="text-slate-400">ä¿æœ‰ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
{% endif %}

<script>
  /* ã€Œã€œ ç¾åœ¨å€¤ã€= è©•ä¾¡é¡ / æ ªæ•°ï¼ˆå°æ•°1æ¡ãƒ»åƒåŒºåˆ‡ã‚Šï¼‰ */
  (function(){
    const fmt1 = n => { if(!isFinite(n)) return 'â€”'; const s=(Math.round(n*10)/10).toFixed(1); return s.replace(/\B(?=(\d{3})+(?!\d))/g, ','); };
    document.querySelectorAll('.cur-price').forEach(el=>{
      const val = parseFloat(el.dataset.val||'0');
      const qty = parseFloat(el.dataset.qty||'0');
      el.textContent = (qty>0 && isFinite(val) && val>0) ? 'ã€œ ' + fmt1(val/qty) : 'â€”';
    });
  })();
</script>