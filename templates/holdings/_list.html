{% load humanize num %}

<!-- â˜… KPIã®â€œã‚½ãƒ¼ã‚¹â€ã€‚list.html ã® JS ãŒ #kpiMount ã«ç§»æ¤ã—ã¦è¡¨ç¤ºã—ã¾ã™ -->
<div id="kpiStickyInner" aria-hidden="true">
  <div class="kpi-grid">
    <div class="kpi"><div class="kpi-k">ä»¶æ•°</div><div class="kpi-v">{{ summary.count|default:"0" }}</div></div>
    <div class="kpi"><div class="kpi-k">å‹ç‡</div><div class="kpi-v">{% if summary.win_rate is not None %}{{ summary.win_rate|floatformat:1 }}%{% else %}â€”{% endif %}</div></div>
    <div class="kpi"><div class="kpi-k">å–å¾—é¡åˆè¨ˆ</div><div class="kpi-v">Â¥{{ summary.acq|floatformat:0|intcomma }}</div></div>
    <div class="kpi"><div class="kpi-k">è©•ä¾¡é¡åˆè¨ˆ</div><div class="kpi-v">{% if summary.val is not None %}Â¥{{ summary.val|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
    <div class="kpi"><div class="kpi-k">å«ã¿æç›Š</div><div class="kpi-v {% if summary.pnl and summary.pnl < 0 %}neg{% else %}pos{% endif %}">{% if summary.pnl is not None %}Â¥{{ summary.pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
    <div class="kpi"><div class="kpi-k">æç›Šç‡</div><div class="kpi-v {% if summary.pnl_pct and summary.pnl_pct < 0 %}neg{% else %}pos{% endif %}">{% if summary.pnl_pct is not None %}{{ summary.pnl_pct|floatformat:2 }}%{% else %}â€”{% endif %}</div></div>
    <div class="kpi"><div class="kpi-k">å‹ã¡ä»¶æ•° / è² ã‘ä»¶æ•°</div><div class="kpi-v">{{ summary.winners|default:"0" }} / {{ summary.losers|default:"0" }}</div></div>
    <div class="kpi"><div class="kpi-k">å¹³å‡ä¿æœ‰æ—¥æ•°</div><div class="kpi-v">{% if summary.avg_days is not None %}{{ summary.avg_days|floatformat:0 }}æ—¥{% else %}â€”{% endif %}</div></div>
    <div class="kpi"><div class="kpi-k">ä¸­å¤®å€¤</div><div class="kpi-v">{% if summary.med_days is not None %}{{ summary.med_days|floatformat:0 }}æ—¥{% else %}â€”{% endif %}</div></div>
    <div class="kpi"><div class="kpi-k">å¹³å‡ãƒã‚¸ã‚·ãƒ§ãƒ³</div><div class="kpi-v">{% if summary.avg_pos_size is not None %}Â¥{{ summary.avg_pos_size|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
    <div class="kpi"><div class="kpi-k">æœ€å¤§ç›Š</div><div class="kpi-v {% if summary.top_gain_pnl and summary.top_gain_pnl < 0 %}neg{% else %}pos{% endif %}">{% if summary.top_gain_pnl is not None %}Â¥{{ summary.top_gain_pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
    <div class="kpi"><div class="kpi-k">æœ€å¤§æ</div><div class="kpi-v {% if summary.top_loss_pnl and summary.top_loss_pnl < 0 %}neg{% else %}pos{% endif %}">{% if summary.top_loss_pnl is not None %}Â¥{{ summary.top_loss_pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
  </div>
</div>

{% if page.object_list %}
  <div class="stack">
    {% for r in page.object_list %}
      {% with h=r.obj %}
      <article class="card row" data-swipe>
        <div class="actions">
          <div class="action-panel" onclick="event.stopPropagation()">
            <button type="button" class="item detail" data-action="detail"><span class="ico">ğŸ“„</span><span>è©³ç´°</span></button>
            <a class="item edit" href="{% url 'holding_edit' h.id %}"><span class="ico">âœï¸</span><span>ç·¨é›†</span></a>
            <a class="item sell" href="{% url 'holding_close_sheet' h.id %}"><span class="ico">ğŸ’±</span><span>æ‰‹ä»•èˆã„</span></a>
            <button class="item delete" hx-post="{% url 'holding_delete' h.id %}" hx-confirm="å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ" hx-target="closest [data-swipe]" hx-swap="outerHTML swap:15ms"><span class="ico">ğŸ—‘ï¸</span><span>å‰Šé™¤</span></button>
          </div>
        </div>

        <div class="track">
          <!-- è¦‹å‡ºã— -->
          <header class="head">
            <div class="head__left">
              <div class="name" title="{{ h.name|default:'-' }}">{{ h.name|default:"-" }}</div>
              <div class="chips">
                <span class="chip code">{{ h.ticker }}</span>
                <span class="chip">{{ h.get_broker_display }}</span>
                <span class="chip">{{ h.get_account_display }}</span>
                <span class="chip {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
                {% if h.currency == "USD" %}
                  <span class="chip fx">USD ğŸ’²</span>
                {% endif %}
              </div>
            </div>
            <div class="head__spark">
              <svg class="spark" viewBox="0 0 96 24" preserveAspectRatio="none"
                   data-rate="{{ r.pnl_pct|default:0 }}"
                   data-s7i='{{ r.s7_idx|default:"[]"|safe }}'
                   data-s30i='{{ r.s30_idx|default:"[]"|safe }}'
                   data-s90i='{{ r.s90_idx|default:"[]"|safe }}'
                   data-s7r='{{ r.s7_raw|default:"[]"|safe }}'
                   data-s30r='{{ r.s30_raw|default:"[]"|safe }}'
                   data-s90r='{{ r.s90_raw|default:"[]"|safe }}'></svg>
            </div>
          </header>

          <!-- æ˜ç´° -->
          <section class="stats-compact">
            <!-- å·¦åˆ— -->
            <div class="stats-col">
              <div class="kv2 small">
                <div class="k">ç¾åœ¨å€¤</div>
                <div class="v">
                  {% if r.price_now is not None %}
                    {% if h.currency == "USD" %}
                      ${{ r.price_now|floatformat:2|intcomma }}
                    {% else %}
                      Â¥{{ r.price_now|floatformat:1|intcomma }}
                    {% endif %}
                  {% else %}â€”{% endif %}
                </div>
              </div>
              <div class="kv2 small">
                <div class="k">å–å¾—å˜ä¾¡</div>
                <div class="v">
                  {% if h.currency == "USD" %}
                    ${{ h.avg_cost|floatformat:2|intcomma }}
                  {% else %}
                    Â¥{{ h.avg_cost|floatformat:2|intcomma }}
                  {% endif %}
                </div>
              </div>
              <div class="kv2 small">
                <div class="k">ç¾åœ¨åˆ©å›ã‚Š</div>
                <div class="v">{% if r.yield_now is not None %}{{ r.yield_now|floatformat:2 }}%{% else %}â€”{% endif %}</div>
              </div>
              <div class="kv2 small">
                <div class="k">å–å¾—åˆ©å›ã‚Š</div>
                <div class="v">{% if r.yield_cost is not None %}{{ r.yield_cost|floatformat:2 }}%{% else %}â€”{% endif %}</div>
              </div>
            </div>

            <!-- å³åˆ— -->
            <div class="stats-col">
              <div class="kv2">
                <div class="k">ä¿æœ‰æ•°</div>
                <div class="v">{{ h.quantity|intcomma }}<span class="unit">æ ª</span></div>
              </div>
              <div class="kv2">
                <div class="k">å«ã¿æç›Š</div>
                <div class="v {% if r.pnl is not None %}{% if r.pnl < 0 %}neg{% else %}pos{% endif %}{% endif %}">
                  {% if r.pnl is not None %}
                    {% if h.currency == "USD" %}
                      {% if r.pnl < 0 %}${{ r.pnl|mul:-1|floatformat:0|intcomma }}{% else %}${{ r.pnl|floatformat:0|intcomma }}{% endif %}
                    {% else %}
                      Â¥{% if r.pnl < 0 %}{{ r.pnl|mul:-1|floatformat:0|intcomma }}{% else %}{{ r.pnl|floatformat:0|intcomma }}{% endif %}
                    {% endif %}
                  {% else %}â€”{% endif %}
                </div>
              </div>
              <div class="kv2">
                <div class="k">æç›Šç‡</div>
                <div class="v {% if r.pnl_pct is not None %}{% if r.pnl_pct < 0 %}neg{% else %}pos{% endif %}{% endif %}">
                  {% if r.pnl_pct is not None %}
                    {% if r.pnl_pct < 0 %}{{ r.pnl_pct|mul:-1|floatformat:2 }}{% else %}{{ r.pnl_pct|floatformat:2 }}{% endif %} %
                  {% else %}â€”{% endif %}
                </div>
              </div>
              <div class="kv2">
                <div class="k">ç´¯è¨ˆé…å½“</div>
                <div class="v">
                  {% if r.div_received is not None %}
                    {% if h.currency == "USD" %}
                      ${{ r.div_received|floatformat:0|intcomma }}
                    {% else %}
                      Â¥{{ r.div_received|floatformat:0|intcomma }}
                    {% endif %}
                  {% else %}â€”{% endif %}
                </div>
              </div>
              <div class="kv2">
                <div class="k">å¹´é–“é…å½“</div>
                <div class="v">
                  {% if r.div_annual is not None %}
                    {% if h.currency == "USD" %}
                      ${{ r.div_annual|floatformat:0|intcomma }}
                    {% else %}
                      Â¥{{ r.div_annual|floatformat:0|intcomma }}
                    {% endif %}
                  {% else %}â€”{% endif %}
                </div>
              </div>
            </div>
          </section>

          <!-- è©³ç´° -->
          <section class="more">
            {% with opened=h.opened_at days=r.days updated=h.updated_at %}
            <div class="moregrid">
              <div class="kv2">
                <div class="k">å–å¾—é¡</div>
                <div class="v">
                  {% if h.currency == "USD" %}
                    ${{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}
                  {% else %}
                    Â¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}
                  {% endif %}
                </div>
              </div>
              <div class="kv2">
                <div class="k">è©•ä¾¡é¡</div>
                <div class="v">
                  {% if r.valuation is not None %}
                    {% if h.currency == "USD" %}
                      ${{ r.valuation|floatformat:0|intcomma }}
                    {% else %}
                      Â¥{{ r.valuation|floatformat:0|intcomma }}
                    {% endif %}
                  {% else %}â€”{% endif %}
                </div>
              </div>
              <div class="kv2"><div class="k">ä¿æœ‰é–‹å§‹</div><div class="v">{% if opened %}{{ opened|date:"Y-m-d" }}{% else %}â€”{% endif %}</div></div>
              <div class="kv2"><div class="k">ä¿æœ‰æ—¥æ•°</div><div class="v">{% if days is not None %}{{ days|months_from_days }}{% else %}â€”{% endif %}</div></div>
              <div class="kv2"><div class="k">æ›´æ–°</div><div class="v">{% if updated %}{{ updated|date:"Y-m-d" }}{% else %}â€”{% endif %}</div></div>
              {% if h.memo %}<div class="kv2 memo"><div class="k">ãƒ¡ãƒ¢</div><div class="v">{{ h.memo }}</div></div>{% endif %}
            </div>
            {% endwith %}
          </section>
        </div>
      </article>
      {% endwith %}
    {% endfor %}
  </div>

  {% if page.paginator.num_pages > 1 %}
    <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
      {% if page.has_previous %}
        <a hx-get="{% url 'holding_list_partial' %}?page={{page.previous_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
           hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">å‰ã¸</a>
      {% endif %}
      <div style="opacity:.75;padding:8px 12px">Page {{page.number}} / {{page.paginator.num_pages}}</div>
      {% if page.has_next %}
        <a hx-get="{% url 'holding_list_partial' %}?page={{page.next_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
           hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">æ¬¡ã¸</a>
      {% endif %}
    </div>
  {% endif %}
{% else %}
  <div class="text-slate-400">ä¿æœ‰ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
{% endif %}