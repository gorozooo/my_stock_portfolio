{% load humanize num %}

{# === 折りたたみサマリー === #}
<section class="sumbox" id="sumBox">
  <div class="sumbox__head">
    <div class="ttl">集計</div>
    <div class="sumbox__mini">
      <span class="mini-pill">取得 ¥{{ summary.acq|floatformat:0|intcomma }}</span>
      <span class="mini-pill">{% if summary.val is not None %}評価 ¥{{ summary.val|floatformat:0|intcomma }}{% else %}評価 —{% endif %}</span>
      <span class="mini-pill {% if summary.pnl and summary.pnl < 0 %}neg{% else %}pos{% endif %}">
        {% if summary.pnl is not None %}含み ¥{{ summary.pnl|floatformat:0|intcomma }}{% else %}含み —{% endif %}
      </span>
      <span class="mini-pill {% if summary.pnl_pct and summary.pnl_pct < 0 %}neg{% else %}pos{% endif %}">
        {% if summary.pnl_pct is not None %}損益率 {{ summary.pnl_pct|floatformat:2 }}%{% else %}損益率 —{% endif %}
      </span>
      <span class="mini-pill">{% if summary.win_rate is not None %}勝率 {{ summary.win_rate|floatformat:1 }}%{% else %}勝率 —{% endif %}</span>
    </div>
    <button type="button" class="sumbox__toggle" id="sumToggle">開く</button>
  </div>

  <div class="sumbox__body">
    {# 全体KPI（既存の summary-bar を流用） #}
    <div class="summary-bar">
      <div class="sb-item"><div class="sb-k">取得額合計</div><div class="sb-v">¥{{ summary.acq|floatformat:0|intcomma }}</div></div>
      <div class="sb-item"><div class="sb-k">評価額合計</div><div class="sb-v">{% if summary.val is not None %}¥{{ summary.val|floatformat:0|intcomma }}{% else %}—{% endif %}</div></div>
      <div class="sb-item"><div class="sb-k">含み損益</div><div class="sb-v {% if summary.pnl and summary.pnl < 0 %}neg{% else %}pos{% endif %}">{% if summary.pnl is not None %}¥{{ summary.pnl|floatformat:0|intcomma }}{% else %}—{% endif %}</div></div>
      <div class="sb-item"><div class="sb-k">損益率</div><div class="sb-v {% if summary.pnl_pct and summary.pnl_pct < 0 %}neg{% else %}pos{% endif %}">{% if summary.pnl_pct is not None %}{{ summary.pnl_pct|floatformat:2 }}%{% else %}—{% endif %}</div></div>
      <div class="sb-item"><div class="sb-k">勝率</div><div class="sb-v">{% if summary.win_rate is not None %}{{ summary.win_rate|floatformat:1 }}%{% else %}—{% endif %}</div></div>
    </div>

    {# ブローカー別 #}
    {% if breakdown.broker %}
    <section class="card" style="margin-top:10px">
      <div class="sumbox__head" style="border-bottom:1px dashed rgba(255,255,255,.08)"><div class="ttl">ブローカー別</div><span style="opacity:.65;font-size:12px">（件数 / 取得 / 評価 / PnL / PnL% / 勝率）</span></div>
      <div style="padding:10px; display:grid; gap:10px">
        {% for b in breakdown.broker %}
        <div class="card" style="padding:10px">
          <div class="name" style="margin-bottom:8px">{{ b.label }}</div>
          <div class="break-kpi">
            <div class="sb-item"><div class="sb-k">件数</div><div class="sb-v">{{ b.count }}</div></div>
            <div class="sb-item"><div class="sb-k">取得額</div><div class="sb-v">¥{{ b.acq|floatformat:0|intcomma }}</div></div>
            <div class="sb-item"><div class="sb-k">評価額</div><div class="sb-v">{% if b.val is not None %}¥{{ b.val|floatformat:0|intcomma }}{% else %}—{% endif %}</div></div>
            <div class="sb-item"><div class="sb-k">含み損益</div><div class="sb-v {% if b.pnl and b.pnl < 0 %}neg{% else %}pos{% endif %}">{% if b.pnl is not None %}¥{{ b.pnl|floatformat:0|intcomma }}{% else %}—{% endif %}</div></div>
            <div class="sb-item"><div class="sb-k">損益率</div><div class="sb-v {% if b.pnl_pct and b.pnl_pct < 0 %}neg{% else %}pos{% endif %}">{% if b.pnl_pct is not None %}{{ b.pnl_pct|floatformat:2 }}%{% else %}—{% endif %}</div></div>
            <div class="sb-item"><div class="sb-k">勝率</div><div class="sb-v">{% if b.win_rate is not None %}{{ b.win_rate|floatformat:1 }}%{% else %}—{% endif %}</div></div>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    {# 口座別 #}
    {% if breakdown.account %}
    <section class="card" style="margin-top:10px">
      <div class="sumbox__head" style="border-bottom:1px dashed rgba(255,255,255,.08)"><div class="ttl">口座別</div><span style="opacity:.65;font-size:12px">（件数 / 取得 / 評価 / PnL / PnL% / 勝率）</span></div>
      <div style="padding:10px; display:grid; gap:10px">
        {% for a in breakdown.account %}
        <div class="card" style="padding:10px">
          <div class="name" style="margin-bottom:8px">{{ a.label }}</div>
          <div class="break-kpi">
            <div class="sb-item"><div class="sb-k">件数</div><div class="sb-v">{{ a.count }}</div></div>
            <div class="sb-item"><div class="sb-k">取得額</div><div class="sb-v">¥{{ a.acq|floatformat:0|intcomma }}</div></div>
            <div class="sb-item"><div class="sb-k">評価額</div><div class="sb-v">{% if a.val is not None %}¥{{ a.val|floatformat:0|intcomma }}{% else %}—{% endif %}</div></div>
            <div class="sb-item"><div class="sb-k">含み損益</div><div class="sb-v {% if a.pnl and a.pnl < 0 %}neg{% else %}pos{% endif %}">{% if a.pnl is not None %}¥{{ a.pnl|floatformat:0|intcomma }}{% else %}—{% endif %}</div></div>
            <div class="sb-item"><div class="sb-k">損益率</div><div class="sb-v {% if a.pnl_pct and a.pnl_pct < 0 %}neg{% else %}pos{% endif %}">{% if a.pnl_pct is not None %}{{ a.pnl_pct|floatformat:2 }}%{% else %}—{% endif %}</div></div>
            <div class="sb-item"><div class="sb-k">勝率</div><div class="sb-v">{% if a.win_rate is not None %}{{ a.win_rate|floatformat:1 }}%{% else %}—{% endif %}</div></div>
          </div>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}
  </div>
</section>

{# === ここから既存カード一覧（保有日数フィルタを反映） === #}
{% if page.object_list %}
  <div class="stack">
    {% for r in page.object_list %}{% with h=r.obj %}
    <article class="card row" data-swipe>
      <div class="actions"> … </div>
      <div class="track">
        …（中略：ヘッダ/メトリクスはそのまま）…
        <section class="more">
          <div class="moregrid">
            <div class="kv"><div class="k">取得額</div><div class="v">¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div></div>
            <div class="kv"><div class="k">保有開始</div><div class="v">{{ h.opened_at|date:"Y-m-d"|default:"—" }}</div></div>
            <div class="kv"><div class="k">保有日数</div><div class="v">{{ r.days|months_from_days }}</div></div>
            <div class="kv"><div class="k">更新</div><div class="v">{{ h.updated_at|date:"Y-m-d" }}</div></div>
            {% if h.memo %}<div class="kv" style="grid-column:1/-1"><div class="k">メモ</div><div class="v">{{ h.memo }}</div></div>{% endif %}
          </div>
        </section>
      </div>
    </article>
    {% endwith %}{% endfor %}
  </div>
{% else %}
  <div class="text-slate-400">保有はまだありません。</div>
{% endif %}

{# 折りたたみトグル：状態保存 #}
<script>
(function(){
  const box = document.getElementById('sumBox');
  const btn = document.getElementById('sumToggle');
  const KEY = 'holdings.summary.collapsed';
  const setUi = ()=>{
    const col = localStorage.getItem(KEY) === '1';
    box.classList.toggle('is-collapsed', col);
    btn.textContent = col ? '開く' : '閉じる';
  };
  btn.addEventListener('click', ()=>{
    const col = !(localStorage.getItem(KEY) === '1');
    localStorage.setItem(KEY, col ? '1' : '0');
    setUi();
  });
  setUi();
})();
</script>