{% load humanize num %}

{# ========== sumbox（折りたたみ式サマリー） ========== #}
<style>
  .sumbox{border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(255,255,255,.03);margin:6px 0 12px}
  .sumbox .sumhead{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,.10);cursor:pointer}
  .sumbox .sumtitle{display:flex;gap:8px;align-items:center;font-weight:800}
  .sumbox .sumchev{font-size:14px;opacity:.8;transform:rotate(-90deg);transition:transform .15s ease}
  .sumbox.is-open  .sumchev{transform:rotate(0deg)}
  .sumbox .sumhint{opacity:.6;font-size:12px}
  .sumbox:not(.is-open) .sumtitle{display:none}

  .summini{display:flex;gap:6px;flex-wrap:nowrap;overflow-x:auto;max-width:100%;padding-bottom:2px}
  .summini .pill{white-space:nowrap;font-size:11px;border:1px solid rgba(255,255,255,.12);border-radius:9999px;padding:4px 8px;background:rgba(255,255,255,.05)}
  .summini .pill .k{opacity:.7;margin-right:4px}
  .summini .pos{color:#22c55e}.summini .neg{color:#ef4444}
  .sumbox.is-open .summini{display:none}

  .sumbox .sumbody{display:none;padding:10px}
  .sumbox.is-open .sumbody{display:block}

  /* KPI */
  .kpi-grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
  .kpi{min-width:120px;flex:1;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;background:rgba(255,255,255,.04)}
  .kpi-k{font-size:12px;color:#9fb0c8}
  .kpi-v{font-size:16px}
  .kpi-v.pos{color:#22c55e}.kpi-v.neg{color:#ef4444}
</style>

<div class="sumbox" id="holdings-sumbox">
  <div class="sumhead" data-toggle>
    <div class="sumtitle">
      <span class="sumchev">▸</span><span>KPIサマリー</span>
    </div>
    <div class="summini">
      <span class="pill"><span class="k">取得</span>¥{{ summary.acq|floatformat:0|intcomma }}</span>
      <span class="pill"><span class="k">含み損益</span>
        <span class="{% if summary.pnl and summary.pnl < 0 %}neg{% else %}pos{% endif %}">
          {% if summary.pnl is not None %}¥{{ summary.pnl|floatformat:0|intcomma }}{% else %}—{% endif %}
        </span>
      </span>
      <span class="pill"><span class="k">損益率</span>
        <span class="{% if summary.pnl_pct and summary.pnl_pct < 0 %}neg{% else %}pos{% endif %}">
          {% if summary.pnl_pct is not None %}{{ summary.pnl_pct|floatformat:2 }}%{% else %}—{% endif %}
        </span>
      </span>
    </div>
    <div class="sumhint">タップで開閉</div>
  </div>

  <div class="sumbody">
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-k">件数</div><div class="kpi-v">{{ summary.count|default:"0" }}</div></div>
      <div class="kpi"><div class="kpi-k">勝率</div><div class="kpi-v">{% if summary.win_rate is not None %}{{ summary.win_rate|floatformat:1 }}%{% else %}—{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">取得額合計</div><div class="kpi-v">¥{{ summary.acq|floatformat:0|intcomma }}</div></div>
      <div class="kpi"><div class="kpi-k">評価額合計</div><div class="kpi-v">{% if summary.val is not None %}¥{{ summary.val|floatformat:0|intcomma }}{% else %}—{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">含み損益</div><div class="kpi-v {% if summary.pnl and summary.pnl < 0 %}neg{% else %}pos{% endif %}">{% if summary.pnl is not None %}¥{{ summary.pnl|floatformat:0|intcomma }}{% else %}—{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">損益率</div><div class="kpi-v {% if summary.pnl_pct and summary.pnl_pct < 0 %}neg{% else %}pos{% endif %}">{% if summary.pnl_pct is not None %}{{ summary.pnl_pct|floatformat:2 }}%{% else %}—{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">勝ち件数 / 負け件数</div><div class="kpi-v">{{ summary.winners|default:"0" }} / {{ summary.losers|default:"0" }}</div></div>
      <div class="kpi"><div class="kpi-k">平均保有日数</div><div class="kpi-v">{% if summary.avg_days is not None %}{{ summary.avg_days|floatformat:0 }}日{% else %}—{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">中央値（保有日数）</div><div class="kpi-v">{% if summary.med_days is not None %}{{ summary.med_days|floatformat:0 }}日{% else %}—{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">平均ポジションサイズ</div><div class="kpi-v">{% if summary.avg_pos_size is not None %}¥{{ summary.avg_pos_size|floatformat:0|intcomma }}{% else %}—{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">最大益</div><div class="kpi-v {% if summary.top_gain_pnl and summary.top_gain_pnl < 0 %}neg{% else %}pos{% endif %}">{% if summary.top_gain_pnl is not None %}¥{{ summary.top_gain_pnl|floatformat:0|intcomma }}{% else %}—{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">最大損</div><div class="kpi-v {% if summary.top_loss_pnl and summary.top_loss_pnl < 0 %}neg{% else %}pos{% endif %}">{% if summary.top_loss_pnl is not None %}¥{{ summary.top_loss_pnl|floatformat:0|intcomma }}{% else %}—{% endif %}</div></div>
    </div>
  </div>
</div>

<script>
  function initHoldingsSumbox(ctx){
    const box=(ctx||document).querySelector('#holdings-sumbox'); if(!box) return;
    const KEY='holdings.sumbox.open.v2', head=box.querySelector('[data-toggle]');
    const saved=localStorage.getItem(KEY); if(saved==='1'){box.classList.add('is-open')}else{box.classList.remove('is-open')}
    head.onclick=()=>{ box.classList.toggle('is-open'); localStorage.setItem(KEY, box.classList.contains('is-open')?'1':'0'); };
  }
  initHoldingsSumbox(document);
  document.body.addEventListener('htmx:load', e=>initHoldingsSumbox(e.target));
</script>

{# ========== カード一覧 ========== #}
{% if page.object_list %}
  <div class="stack">
    {% for r in page.object_list %}{% with h=r.obj %}
    <article class="card row" data-swipe>
      <!-- swipe actions -->
      <div class="actions">
        <div class="action-panel" onclick="event.stopPropagation()">
          <button type="button" class="item detail" data-action="detail"><span class="ico">📄</span><span>詳細</span></button>
          <a class="item edit" href="{% url 'holding_edit' h.id %}"><span class="ico">✏️</span><span>編集</span></a>
          <a class="item sell" href="{% url 'holding_close_sheet' h.id %}"><span class="ico">💱</span><span>売却</span></a>
          <button class="item delete" hx-post="{% url 'holding_delete' h.id %}" hx-confirm="削除しますか？" hx-target="closest [data-swipe]" hx-swap="outerHTML swap:15ms"><span class="ico">🗑️</span><span>削除</span></button>
        </div>
      </div>

      <div class="track">
        <!-- header -->
        <header class="head">
          <div class="head__left">
            <div class="name" title="{{ h.name|default:'-' }}">{{ h.name|default:"-" }}</div>
            <div class="chips">
              <span class="chip code">{{ h.ticker }}</span>
              <span class="chip">{{ h.get_broker_display }}</span>
              <span class="chip">{{ h.get_account_display }}</span>
              <span class="chip {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
            </div>
          </div>
          <div class="head__spark">
            <svg class="spark" viewBox="0 0 96 24" preserveAspectRatio="none"
                 data-rate="{{ r.pnl_pct|default:0 }}"
                 data-s7i='{{ r.s7_idx|default:"[]"|safe }}'
                 data-s30i='{{ r.s30_idx|default:"[]"|safe }}'
                 data-s90i='{{ r.s90_idx|default:"[]"|safe }}'
                 data-s7r='{{ r.s7_raw|default:"[]"|safe }}'
                 data-s30r='{{ r.s30_raw|default:"[]"|safe }}'
                 data-s90r='{{ r.s90_raw|default:"[]"|safe }}'></svg>
          </div>
        </header>

        {# ===== “白アプリ風” 2カラム明細 ===== #}
        <section class="stats-compact">
          <!-- 左カラム -->
          <div class="stats-col">
            <div class="kv2 small">
              <div class="k">〜 現在値</div>
              <div class="v">
                <span class="cur-price"
                      data-val="{{ r.valuation|default:0 }}"
                      data-qty="{{ h.quantity|default:0 }}">—</span>
                <span class="unit">円</span>
              </div>
            </div>
            <div class="kv2 small">
              <div class="k">取得単価</div>
              <div class="v">¥{{ h.avg_cost|floatformat:2|intcomma }}</div>
            </div>
            <div class="kv2 small">
              <div class="k">現在利回り</div>
              <div class="v">{% if r.yield_now is not None %}{{ r.yield_now|floatformat:2 }}%{% else %}—{% endif %}</div>
            </div>
            <div class="kv2 small">
              <div class="k">取得利回り</div>
              <div class="v">{% if r.yield_cost is not None %}{{ r.yield_cost|floatformat:2 }}%{% else %}—{% endif %}</div>
            </div>
          </div>

          <!-- 右カラム -->
          <div class="stats-col">
            <div class="kv2">
              <div class="k">保有数</div>
              <div class="v">{{ h.quantity|intcomma }}<span class="unit">株</span></div>
            </div>
            <div class="kv2">
              <div class="k">取得額</div>
              <div class="v">¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div>
            </div>
            <div class="kv2">
              <div class="k">評価額</div>
              <div class="v">
                {% if r.valuation is not None %}¥{{ r.valuation|floatformat:0|intcomma }}{% else %}—{% endif %}
                {% if r.pnl_pct is not None %}
                  <span class="pct {% if r.pnl_pct < 0 %}neg{% else %}pos{% endif %}">
                    ({% if r.pnl_pct > 0 %}+{% endif %}{{ r.pnl_pct|floatformat:2 }} %)
                  </span>
                {% endif %}
              </div>
            </div>
            <div class="kv2">
              <div class="k">年間配当</div>
              <div class="v">{% if r.div_annual is not None %}¥{{ r.div_annual|floatformat:0|intcomma }}{% else %}—{% endif %}</div>
            </div>
          </div>
        </section>

        <!-- 追加詳細 -->
        <section class="more">
          <div class="moregrid">
            <div class="kv"><div class="k">保有開始</div><div class="v">{{ h.opened_at|date:"Y-m-d"|default:"—" }}</div></div>
            <div class="kv"><div class="k">保有日数</div><div class="v">{{ r.days|months_from_days }}</div></div>
            <div class="kv"><div class="k">更新</div><div class="v">{{ h.updated_at|date:"Y-m-d" }}</div></div>
            {% if h.memo %}<div class="kv" style="grid-column:1/-1"><div class="k">メモ</div><div class="v">{{ h.memo }}</div></div>{% endif %}
          </div>
        </section>
      </div>
    </article>
    {% endwith %}{% endfor %}
  </div>

  {% if page.paginator.num_pages > 1 %}
  <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
    {% if page.has_previous %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.previous_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">前へ</a>
    {% endif %}
    <div style="opacity:.75;padding:8px 12px">Page {{page.number}} / {{page.paginator.num_pages}}</div>
    {% if page.has_next %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.next_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">次へ</a>
    {% endif %}
  </div>
  {% endif %}
{% else %}
  <div class="text-slate-400">保有はまだありません。</div>
{% endif %}

<script>
  /* 「〜 現在値」= 評価額 / 株数 を小数1桁・千区切りで表示（無ければ “—”） */
  (function(){
    const fmt1 = n => {
      if (!isFinite(n)) return '—';
      const s = (Math.round(n*10)/10).toFixed(1);
      return s.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    };
    document.querySelectorAll('.cur-price').forEach(el=>{
      const val = parseFloat(el.dataset.val||'0');
      const qty = parseFloat(el.dataset.qty||'0');
      el.textContent = (qty>0 && isFinite(val) && val>0) ? '〜 ' + fmt1(val/qty) : '—';
    });
  })();
</script>