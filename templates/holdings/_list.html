{# templates/holdings/_list.html #}
{% load humanize num %}

{% if page.object_list %}
  <div class="vstack">
    {% for r in page.object_list %}
      {% with h=r.obj %}
      <article class="card row" data-swipe>
        <!-- 横並びアクション -->
        <div class="actions">
          <div class="action-panel">
            <button type="button" class="item detail" data-action="detail" aria-label="詳細を開く">
              <span class="ico">📄</span><span>詳細</span>
            </button>
            <a class="item edit" href="{% url 'holding_edit' h.id %}" aria-label="編集へ">
              <span class="ico">✏️</span><span>編集</span>
            </a>
            <button class="item delete"
                    hx-post="{% url 'holding_delete' h.id %}"
                    hx-confirm="削除しますか？"
                    hx-target="closest [data-swipe]"
                    hx-swap="outerHTML swap:15ms"
                    aria-label="削除">
              <span class="ico">🗑️</span><span>削除</span>
            </button>
          </div>
        </div>

        <!-- 本文（固定） -->
        <div class="track">
          <div class="body">
            <header class="title">
              <div class="name name-fit" title="{{ h.name|default:'-' }}">{{ h.name|default:"-" }}</div>
              <div class="subline">
                <div class="badges">
                  <span class="badge badge--code">{{ h.ticker }}</span>
                  <span class="badge">{{ h.get_broker_display }}</span>
                  <span class="badge">{{ h.get_account_display }}</span>
                  <span class="badge {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
                </div>
              </div>
            </header>

            <div class="grid">
              <div class="kv"><div class="k">数量</div><div class="v">{{ h.quantity|intcomma }}</div></div>
              <div class="kv"><div class="k">平均取得</div><div class="v">¥{{ h.avg_cost|floatformat:0|intcomma }}</div></div>

              <div class="kv"><div class="k">評価額</div>
                <div class="v">
                  {% if r.valuation is not None %}¥{{ r.valuation|floatformat:0|intcomma }}{% else %}—{% endif %}
                </div>
              </div>
              <div class="kv"><div class="k">含み損益</div>
                <div class="v">
                  {% if r.pnl is not None %}¥{{ r.pnl|floatformat:0|intcomma }}{% else %}—{% endif %}
                </div>
              </div>
              <div class="kv"><div class="k">保有日数</div><div class="v">{{ r.days|default:"—" }}</div></div>
            </div>
          </div>

          <div class="more">
            <div class="moregrid">
              <div class="kv" style="border:none;padding:0">
                <div class="k">取得額</div>
                <div class="v">¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div>
              </div>
              <div class="kv" style="border:none;padding:0">
                <div class="k">保有開始</div>
                <div class="v">{{ h.opened_at|date:"Y-m-d"|default:"—" }}</div>
              </div>
              <div class="kv"><div class="k">作成</div><div class="v">{{ h.created_at|date:"Y-m-d" }}</div></div>
              <div class="kv"><div class="k">更新</div><div class="v">{{ h.updated_at|date:"Y-m-d" }}</div></div>
            </div>
          </div>
        </div>
      </article>
      {% endwith %}
    {% endfor %}
  </div>

  {# ページング #}
  {% if page.paginator.num_pages > 1 %}
  <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
    {% if page.has_previous %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.previous_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">前へ</a>
    {% endif %}
    <div style="opacity:.75;padding:8px 12px">Page {{page.number}} / {{page.paginator.num_pages}}</div>
    {% if page.has_next %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.next_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">次へ</a>
    {% endif %}
  </div>
  {% endif %}
{% else %}
  <div class="text-slate-400">保有はまだありません。</div>
{% endif %}

<script>
/* ===== スワイプパネル（本文は固定）＋ 詳細の閉じやすさ改善 ===== */
(function(){
  const rows = document.querySelectorAll('[data-swipe]');

  function getOpenW(actions){
    const v = getComputedStyle(actions).getPropertyValue('--open-w').trim().replace('px','');
    return parseFloat(v || '220');
  }
  function closeAll(except){
    document.querySelectorAll('[data-swipe].is-open').forEach(r=>{
      if(r===except) return;
      r.classList.remove('is-open');
      const a = r.querySelector('.actions');
      a.style.right = (-getOpenW(a)) + 'px';
      a.style.pointerEvents = 'none';
    });
  }

  rows.forEach(row=>{
    const actions = row.querySelector('.actions');
    const detailBtn = row.querySelector('[data-action="detail"]');
    const track = row.querySelector('.track');
    const OPEN_W = getOpenW(actions);

    actions.style.right = (-OPEN_W) + 'px';
    actions.style.pointerEvents = 'none';

    let startX=0,startY=0,drag=false,horiz=false,opened=false,baseRight=-OPEN_W;

    const setRight = (px)=> actions.style.right = px + 'px';

    const onStart = (e)=>{
      if (e.target.closest('.actions')) return;
      const t = e.touches ? e.touches[0] : e;
      startX=t.clientX; startY=t.clientY;
      drag=true; horiz=false;
      baseRight = opened ? 0 : -OPEN_W;
      actions.style.transition='none';
      if(document.querySelector('[data-swipe].is-open') && !row.classList.contains('is-open')){
        closeAll(row);
      }
    };
    const onMove = (e)=>{
      if(!drag) return;
      const t = e.touches ? e.touches[0] : e;
      const dx=t.clientX-startX, dy=t.clientY-startY;
      if(!horiz){
        if(Math.abs(dx)<8) return;
        if(Math.abs(dx)>Math.abs(dy)) horiz=true; else { drag=false; actions.style.transition=''; return; }
      }
      if(e.cancelable) e.preventDefault();
      let nr = baseRight - dx; if(nr>0) nr=0; if(nr<-OPEN_W) nr=-OPEN_W; setRight(nr);
    };
    const onEnd = ()=>{
      if(!drag) return;
      drag=false; actions.style.transition='right .18s ease-out';
      const curRight = parseFloat(getComputedStyle(actions).right) || -OPEN_W;
      opened = (curRight > -OPEN_W/2);
      if(opened){ row.classList.add('is-open'); setRight(0); actions.style.pointerEvents='auto'; }
      else      { row.classList.remove('is-open'); setRight(-OPEN_W); actions.style.pointerEvents='none'; }
    };

    row.addEventListener('touchstart', onStart, {passive:true});
    row.addEventListener('touchmove',  onMove,  {passive:false});
    row.addEventListener('touchend',   onEnd);

    detailBtn.addEventListener('click', ()=>{
      row.classList.toggle('show-detail');
      opened=false; row.classList.remove('is-open'); setRight(-OPEN_W);
      actions.style.pointerEvents = 'none';
      window.requestAnimationFrame(()=> {
        const ev = new Event('reflow'); document.dispatchEvent(ev);
      });
    });

    track.addEventListener('click', (ev)=>{
      const hitAction = ev.target.closest('.actions, .item, a, button');
      if (hitAction) return;
      if (row.classList.contains('show-detail')){
        row.classList.remove('show-detail');
      }
      if (row.classList.contains('is-open')){
        row.classList.remove('is-open'); setRight(-OPEN_W); actions.style.pointerEvents='none';
      }
    });
  });

  document.addEventListener('click', (e)=>{
    if (e.target.closest('.actions')) return;
    const r = e.target.closest('[data-swipe]');
    if(!r) document.querySelectorAll('[data-swipe].is-open').forEach(rr=>{
      rr.classList.remove('is-open');
      const a = rr.querySelector('.actions');
      a.style.right = (-getOpenW(a)) + 'px';
      a.style.pointerEvents = 'none';
    });
  });
})();
</script>