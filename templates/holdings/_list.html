{# templates/holdings/_list.html #}
{% load humanize num %}

<style>
  /* --- ã‚¹ã‚¯ã‚·ãƒ§é¢¨ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆä¸Šï¼šæƒ…å ±ã€å³ï¼šæŒ‡æ¨™ï¼‰ --- */
  .hcard{position:relative;border:1px solid rgba(255,255,255,.08);border-radius:16px;background:rgba(255,255,255,.04);overflow:hidden}
  .hrow{display:flex;gap:12px;padding:14px}

  /* å·¦ã‚«ãƒ©ãƒ ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ï¼‹éŠ˜æŸ„æƒ…å ±ï¼‰ */
  .hleft{display:flex;gap:12px;min-width:0;align-items:flex-start}
  .h-ava{width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,.08);display:grid;place-items:center;
         font-weight:800}
  .h-ava small{opacity:.7;font-size:10px}

  .h-tit{min-width:0}
  .h-name{font-size:18px;font-weight:800;letter-spacing:.02em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .h-sub{margin-top:2px;font-size:12px;color:#9aa4b2}
  .h-chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .h-chip{font-size:11px;padding:3px 8px;border:1px solid rgba(255,255,255,.16);border-radius:9999px;color:#dbe3f4}
  .h-chip.buy{background:rgba(16,185,129,.12);border-color:rgba(16,185,129,.35)}
  .h-chip.sell{background:rgba(244,63,94,.12);border-color:rgba(244,63,94,.35)}

  /* å³ã‚«ãƒ©ãƒ ï¼ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼‰ */
  .hright{margin-left:auto;display:grid;grid-template-columns:1fr;gap:8px;min-width:180px}
  .h-met{display:flex;justify-content:space-between;gap:10px;border:1px dashed rgba(255,255,255,.10);
         border-radius:12px;padding:10px 12px;background:rgba(255,255,255,.03)}
  .h-met .k{font-size:12px;color:#97a3b6}
  .h-met .v{font-size:18px}
  .h-met .unit{font-size:12px;opacity:.7;margin-left:4px}
  .h-met.pos .v{color:#22c55e}
  .h-met.neg .v{color:#ef4444}
  .h-met .pct{font-size:12px;opacity:.8;margin-left:6px}

  /* è©³ç´°ï¼ˆåˆæœŸã¯éè¡¨ç¤ºã€‚è¡Œã« .show-detail ã§è¡¨ç¤ºï¼‰ */
  .h-more{display:none;border-top:1px dashed rgba(255,255,255,.10);padding:10px 14px}
  .row.show-detail .h-more{display:block}
  .h-moregrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .h-kv{display:flex;justify-content:space-between;gap:8px}
  .h-kv .k{font-size:12px;color:#97a3b6}
  .h-kv .v{font-size:16px}

  /* ã‚¹ãƒ¯ã‚¤ãƒ—é ˜åŸŸï¼ˆæ—¢å­˜JSã¨åŒã˜ã‚¯ãƒ©ã‚¹åã‚’è¸è¥²ï¼‰ */
  .row[data-swipe]{position:relative}
  .row .track{position:relative;z-index:2}
  .row .actions{position:absolute;inset:0 0 0 auto;width:260px;display:flex;justify-content:flex-end;align-items:center;
                gap:8px;padding:0 12px;background:rgba(12,18,28,.96);border-left:1px solid rgba(255,255,255,.07);z-index:1}
  .action-panel .item{display:flex;align-items:center;gap:6px;padding:9px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.18)}
  .action-panel .item.delete{border-color:rgba(244,63,94,.35);background:rgba(244,63,94,.12)}

  @media (max-width:480px){
    .hright{min-width:0;width:100%;grid-template-columns:1fr 1fr}
  }
</style>

{% if page.object_list %}
  <div class="stack" style="gap:14px">
    {% for r in page.object_list %}{% with h=r.obj %}
    <article class="hcard row" data-swipe>
      {# ã‚¹ãƒ¯ã‚¤ãƒ—ã§å‡ºã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ #}
      <div class="actions">
        <div class="action-panel" onclick="event.stopPropagation()">
          <button type="button" class="item detail" data-action="detail">ğŸ“„ è©³ç´°</button>
          <a class="item edit" href="{% url 'holding_edit' h.id %}">âœï¸ ç·¨é›†</a>
          <a class="item sell" href="{% url 'holding_close_sheet' h.id %}">ğŸ’± å£²å´</a>
          <button class="item delete"
                  hx-post="{% url 'holding_delete' h.id %}"
                  hx-confirm="å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
                  hx-target="closest [data-swipe]"
                  hx-swap="outerHTML swap:15ms">ğŸ—‘ï¸ å‰Šé™¤</button>
        </div>
      </div>

      <div class="track">
        <div class="hrow">
          <!-- å·¦ï¼šéŠ˜æŸ„æƒ…å ± -->
          <div class="hleft">
            <div class="h-ava">
              {{ h.name|default:"-"|first }}
              <small></small>
            </div>
            <div class="h-tit">
              <div class="h-name">{{ h.name|default:"-" }}</div>
              <div class="h-sub">{{ h.ticker }}ï¼»{{ h.get_account_display }}ï¼½</div>
              <div class="h-chips">
                <span class="h-chip">{{ h.get_broker_display }}</span>
                <span class="h-chip {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
              </div>
            </div>
          </div>

          <!-- å³ï¼šãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆæ•°é‡ / å¹³å‡å–å¾— / å«ã¿æç›Šï¼‰ -->
          <div class="hright">
            <div class="h-met">
              <div class="k">ä¿æœ‰æ•°</div>
              <div class="v">{{ h.quantity|intcomma }}<span class="unit">æ ª</span></div>
            </div>
            <div class="h-met">
              <div class="k">å¹³å‡å–å¾—</div>
              <div class="v">Â¥{{ h.avg_cost|floatformat:0|intcomma }}</div>
            </div>
            <div class="h-met {% if r.pnl is not None and r.pnl < 0 %}neg{% else %}pos{% endif %}">
              <div class="k">å«ã¿æç›Š</div>
              <div class="v">
                {% if r.pnl is not None %}Â¥{{ r.pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}
                {% if r.pnl_pct is not None %}<span class="pct">({{ r.pnl_pct|floatformat:2 }}%)</span>{% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- è©³ç´°ï¼ˆå–å¾—é¡ãƒ»è©•ä¾¡é¡ãªã©ã¯ã“ã“ã«æ®‹ã™ï¼‰ -->
        <section class="h-more">
          <div class="h-moregrid">
            <div class="h-kv"><div class="k">å–å¾—é¡</div>
              <div class="v">Â¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div></div>
            <div class="h-kv"><div class="k">è©•ä¾¡é¡</div>
              <div class="v">{% if r.val is not None %}Â¥{{ r.val|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
            <div class="h-kv"><div class="k">ä¿æœ‰é–‹å§‹</div>
              <div class="v">{{ h.opened_at|date:"Y-m-d"|default:"â€”" }}</div></div>
            <div class="h-kv"><div class="k">æ›´æ–°</div>
              <div class="v">{{ h.updated_at|date:"Y-m-d" }}</div></div>
            {% if h.memo %}
            <div class="h-kv" style="grid-column:1/-1"><div class="k">ãƒ¡ãƒ¢</div><div class="v">{{ h.memo }}</div></div>
            {% endif %}
          </div>
        </section>
      </div>
    </article>
    {% endwith %}{% endfor %}
  </div>

  {% if page.paginator.num_pages > 1 %}
  <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
    {% if page.has_previous %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.previous_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">å‰ã¸</a>
    {% endif %}
    <div style="opacity:.75;padding:8px 12px">Page {{page.number}} / {{page.paginator.num_pages}}</div>
    {% if page.has_next %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.next_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">æ¬¡ã¸</a>
    {% endif %}
  </div>
  {% endif %}
{% else %}
  <div class="text-slate-400">ä¿æœ‰ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
{% endif %}