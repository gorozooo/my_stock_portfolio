{# templates/holdings/_list.html #}
{% load humanize num %}

{% if page.object_list %}
  <div class="stack">
    {% for r in page.object_list %}{% with h=r.obj %}
    <article class="card row" data-swipe>
      <!-- å³ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="actions">
        <div class="action-panel" onclick="event.stopPropagation()">
          <button type="button" class="item detail" data-action="detail"><span class="ico">ğŸ“„</span><span>è©³ç´°</span></button>
          <a class="item edit" href="{% url 'holding_edit' h.id %}"><span class="ico">âœï¸</span><span>ç·¨é›†</span></a>
          <button class="item delete"
                  hx-post="{% url 'holding_delete' h.id %}"
                  hx-confirm="å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
                  hx-target="closest [data-swipe]"
                  hx-swap="outerHTML swap:15ms"><span class="ico">ğŸ—‘ï¸</span><span>å‰Šé™¤</span></button>
        </div>
      </div>

      <!-- æœ¬æ–‡ -->
      <div class="track">
        <!-- ãƒ˜ãƒƒãƒ€ï¼šå·¦=éŠ˜æŸ„å/ãƒãƒƒãƒ—ã€å³=ã‚¹ãƒ‘ãƒ¼ã‚¯ -->
        <header class="head">
          <div class="head__left">
            <div class="name" title="{{ h.name|default:'-' }}">{{ h.name|default:"-" }}</div>
            <div class="chips">
              <span class="chip code">{{ h.ticker }}</span>
              <span class="chip">{{ h.get_broker_display }}</span>
              <span class="chip">{{ h.get_account_display }}</span>
              <span class="chip {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
            </div>
          </div>
          <div class="head__spark">
            <svg class="spark"
                 viewBox="0 0 96 24" preserveAspectRatio="none"
                 data-rate="{{ r.pnl_pct|default:0 }}"
                 data-s7i='{{ r.s7_idx|default:"[]"|safe }}'
                 data-s30i='{{ r.s30_idx|default:"[]"|safe }}'
                 data-s90i='{{ r.s90_idx|default:"[]"|safe }}'
                 data-s7r='{{ r.s7_raw|default:"[]"|safe }}'
                 data-s30r='{{ r.s30_raw|default:"[]"|safe }}'
                 data-s90r='{{ r.s90_raw|default:"[]"|safe }}'></svg>
          </div>
        </header>

        <!-- ãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
        <section class="stats">
          <div class="stat">
            <div class="stat__k">æ•°é‡</div>
            <div class="stat__v">{{ h.quantity|intcomma }}</div>
          </div>
          <div class="stat">
            <div class="stat__k">å¹³å‡å–å¾—</div>
            <div class="stat__v">Â¥{{ h.avg_cost|floatformat:0|intcomma }}</div>
          </div>
          <div class="stat {% if r.pnl is not None and r.pnl < 0 %}neg{% else %}pos{% endif %}">
            <div class="stat__k">å«ã¿æç›Š</div>
            <div class="stat__v">
              {% if r.pnl is not None %}Â¥{{ r.pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}
            </div>
          </div>
          <div class="stat {% if r.pnl_pct is not None and r.pnl_pct < 0 %}neg{% else %}pos{% endif %}">
            <div class="stat__k">æç›Šç‡</div>
            <div class="stat__v">
              {% if r.pnl_pct is not None %}{{ r.pnl_pct|floatformat:2 }}%{% else %}â€”{% endif %}
            </div>
          </div>
        </section>

        <!-- è©³ç´° -->
        <section class="more">
          <div class="moregrid">
            <div class="kv"><div class="k">å–å¾—é¡</div><div class="v">Â¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div></div>
            <div class="kv"><div class="k">ä¿æœ‰é–‹å§‹</div><div class="v">{{ h.opened_at|date:"Y-m-d"|default:"â€”" }}</div></div>
            <div class="kv">
              <div class="k">ä¿æœ‰æ—¥æ•°</div>
              <div class="v">{{ r.days|months_from_days }}</div>
            </div>
            <div class="kv"><div class="k">æ›´æ–°</div><div class="v">{{ h.updated_at|date:"Y-m-d" }}</div></div>
            {% if h.memo %}<div class="kv" style="grid-column:1/-1"><div class="k">ãƒ¡ãƒ¢</div><div class="v">{{ h.memo }}</div></div>{% endif %}
          </div>
        </section>
      </div>
    </article>
    {% endwith %}{% endfor %}
  </div>

  {# ãƒšãƒ¼ã‚¸ãƒ³ã‚°ï¼ˆå¿…è¦ãªã‚‰ãã®ã¾ã¾ï¼‰ #}
  {% if page.paginator.num_pages > 1 %}
  <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
    {% if page.has_previous %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.previous_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">å‰ã¸</a>
    {% endif %}
    <div style="opacity:.75;padding:8px 12px">Page {{page.number}} / {{page.paginator.num_pages}}</div>
    {% if page.has_next %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.next_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">æ¬¡ã¸</a>
    {% endif %}
  </div>
  {% endif %}

  {# ã‚¹ãƒ‘ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã“ã“ã«ç½®ãã€‚base.html ã«ç½®ã„ã¦ã‚‚OKï¼‰ #}
  <div id="sparkModal" class="spark-modal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:9999">
    <div class="spark-modal-content" style="width:min(540px,90vw);background:#0b1220;border:1px solid #223046;border-radius:12px;overflow:hidden">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #223046">
        <div id="sparkTitle" style="font-weight:700">â€”</div>
        <button id="sparkClose" class="btn-ghost" style="padding:6px 10px;border:1px solid #334155;border-radius:8px;background:transparent;color:#e5e7eb">é–‰ã˜ã‚‹</button>
      </div>
      <div style="padding:12px">
        <canvas id="sparkCanvas" style="width:100%;height:240px;display:block"></canvas>
        <div class="spark-ctrl" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin-top:10px">
          <div style="margin-right:auto;opacity:.8">æœŸé–“ / è¡¨ç¤º</div>
          <button class="btn" data-span="7">7æ—¥</button>
          <button class="btn" data-span="30">30æ—¥</button>
          <button class="btn" data-span="90">90æ—¥</button>
          <button class="btn" data-mode="idx">æŒ‡æ•°</button>
          <button class="btn" data-mode="raw">å®Ÿå€¤</button>
        </div>
      </div>
    </div>
  </div>
{% else %}
  <div class="text-slate-400">ä¿æœ‰ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
{% endif %}