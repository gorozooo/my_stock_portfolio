{% load humanize num %}

{# ========== sumboxï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ã‚µãƒãƒªãƒ¼ï¼‰ ========== #}
<style>
  .sumbox{border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(255,255,255,.03);margin:6px 0 12px}
  .sumbox .sumhead{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px dashed rgba(255,255,255,.10);cursor:pointer}
  .sumbox .sumtitle{display:flex;gap:8px;align-items:center;font-weight:800}
  .sumbox .sumchev{font-size:14px;opacity:.8;transform:rotate(-90deg);transition:transform .15s ease}
  .sumbox.is-open  .sumchev{transform:rotate(0deg)}
  .sumbox .sumhint{opacity:.6;font-size:12px}
  .sumbox:not(.is-open) .sumtitle{display:none}

  /* ãƒŸãƒ‹ãƒ”ãƒ«ï¼ˆé–‰ã˜ã¦ã„ã‚‹ã¨ãã ã‘1è¡Œã§è¡¨ç¤ºï¼‰ */
  .summini{display:flex;gap:6px;flex-wrap:nowrap;overflow-x:auto;max-width:100%;padding-bottom:2px}
  .summini .pill{white-space:nowrap;font-size:11px;border:1px solid rgba(255,255,255,.12);border-radius:9999px;padding:4px 8px;background:rgba(255,255,255,.05)}
  .summini .pill .k{opacity:.7;margin-right:4px}
  .summini .pos{color:#22c55e}.summini .neg{color:#ef4444}
  .sumbox.is-open .summini{display:none}

  .sumbox .sumbody{display:none;padding:10px}
  .sumbox.is-open .sumbody{display:block}

  /* KPIï¼ˆæœ¬ä½“è¡¨ç¤ºï¼‰ */
  .kpi-grid{display:flex;gap:10px;flex-wrap:wrap}
  .kpi{min-width:120px;flex:1;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;background:rgba(255,255,255,.04)}
  .kpi-k{font-size:12px;color:#9fb0c8}
  .kpi-v{font-size:16px}
  .kpi-v.pos{color:#22c55e}.kpi-v.neg{color:#ef4444}

  /* Breakdownï¼ˆKPIãƒ”ãƒ«ã¨åŒèª¿ï¼‰ */
  .bd-wrap{display:grid;grid-template-columns:1fr;gap:12px;margin-top:10px}
  .bd-sec{border:1px solid rgba(255,255,255,.10);border-radius:12px;background:rgba(255,255,255,.02)}
  .bd-head{display:flex;gap:8px;align-items:center;padding:8px 10px;border-bottom:1px dashed rgba(255,255,255,.08)}
  .bd-note{opacity:.65;font-size:12px}
  .bd-list{display:flex;flex-direction:column;gap:10px;padding:10px}
  .bd-row{display:flex;flex-direction:column;gap:8px;border:1px solid rgba(255,255,255,.08);border-radius:10px;background:rgba(255,255,255,.04);padding:10px}
  .bd-label{font-weight:800}
  .bd-kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
  @media (min-width:460px){ .bd-kpis{grid-template-columns:repeat(6,minmax(0,1fr));} }
</style>

<div class="sumbox" id="holdings-sumbox">
  <div class="sumhead" data-toggle>
    <div class="sumtitle">
      <span class="sumchev">â–¸</span><span>ã‚µãƒãƒªãƒ¼ / å†…è¨³</span>
    </div>
    <div class="summini">
      <span class="pill"><span class="k">å–å¾—</span>Â¥{{ summary.acq|floatformat:0|intcomma }}</span>
      <span class="pill"><span class="k">å«ã¿æç›Š</span>
        <span class="{% if summary.pnl and summary.pnl < 0 %}neg{% else %}pos{% endif %}">
          {% if summary.pnl is not None %}Â¥{{ summary.pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}
        </span>
      </span>
      <span class="pill"><span class="k">æç›Šç‡</span>
        <span class="{% if summary.pnl_pct and summary.pnl_pct < 0 %}neg{% else %}pos{% endif %}">
          {% if summary.pnl_pct is not None %}{{ summary.pnl_pct|floatformat:2 }}%{% else %}â€”{% endif %}
        </span>
      </span>
    </div>
    <div class="sumhint">ã‚¿ãƒƒãƒ—ã§é–‹é–‰</div>
  </div>

  <div class="sumbody">
    <div class="kpi-grid">
      <div class="kpi"><div class="kpi-k">å–å¾—é¡åˆè¨ˆ</div><div class="kpi-v">Â¥{{ summary.acq|floatformat:0|intcomma }}</div></div>
      <div class="kpi"><div class="kpi-k">è©•ä¾¡é¡åˆè¨ˆ</div><div class="kpi-v">{% if summary.val is not None %}Â¥{{ summary.val|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">å«ã¿æç›Š</div><div class="kpi-v {% if summary.pnl and summary.pnl < 0 %}neg{% else %}pos{% endif %}">{% if summary.pnl is not None %}Â¥{{ summary.pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">æç›Šç‡</div><div class="kpi-v {% if summary.pnl_pct and summary.pnl_pct < 0 %}neg{% else %}pos{% endif %}">{% if summary.pnl_pct is not None %}{{ summary.pnl_pct|floatformat:2 }}%{% else %}â€”{% endif %}</div></div>
      <div class="kpi"><div class="kpi-k">å‹ç‡</div><div class="kpi-v">{% if summary.win_rate is not None %}{{ summary.win_rate|floatformat:1 }}%{% else %}â€”{% endif %}</div></div>
    </div>

    {% if breakdown.broker or breakdown.account %}
      <div class="bd-wrap">
        {% if breakdown.broker %}
          <section class="bd-sec">
            <div class="bd-head"><strong>ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼åˆ¥</strong><span class="bd-note">ï¼ˆä»¶æ•° / å–å¾— / è©•ä¾¡ / PnL / PnL% / å‹ç‡ï¼‰</span></div>
            <div class="bd-list">
              {% for b in breakdown.broker %}
                <div class="bd-row">
                  <div class="bd-label">{{ b.label }}</div>
                  <div class="bd-kpis">
                    <div class="kpi"><div class="kpi-k">ä»¶æ•°</div><div class="kpi-v">{{ b.count }}</div></div>
                    <div class="kpi"><div class="kpi-k">å–å¾—é¡</div><div class="kpi-v">Â¥{{ b.acq|floatformat:0|intcomma }}</div></div>
                    <div class="kpi"><div class="kpi-k">è©•ä¾¡é¡</div><div class="kpi-v">{% if b.val is not None %}Â¥{{ b.val|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
                    <div class="kpi"><div class="kpi-k">å«ã¿æç›Š</div><div class="kpi-v {% if b.pnl and b.pnl < 0 %}neg{% else %}pos{% endif %}">{% if b.pnl is not None %}Â¥{{ b.pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
                    <div class="kpi"><div class="kpi-k">æç›Šç‡</div><div class="kpi-v {% if b.pnl_pct and b.pnl_pct < 0 %}neg{% else %}pos{% endif %}">{% if b.pnl_pct is not None %}{{ b.pnl_pct|floatformat:2 }}%{% else %}â€”{% endif %}</div></div>
                    <div class="kpi"><div class="kpi-k">å‹ç‡</div><div class="kpi-v">{% if b.win_rate is not None %}{{ b.win_rate|floatformat:1 }}%{% else %}â€”{% endif %}</div></div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </section>
        {% endif %}

        {% if breakdown.account %}
          <section class="bd-sec">
            <div class="bd-head"><strong>å£åº§åˆ¥</strong><span class="bd-note">ï¼ˆä»¶æ•° / å–å¾— / è©•ä¾¡ / PnL / PnL% / å‹ç‡ï¼‰</span></div>
            <div class="bd-list">
              {% for a in breakdown.account %}
                <div class="bd-row">
                  <div class="bd-label">{{ a.label }}</div>
                  <div class="bd-kpis">
                    <div class="kpi"><div class="kpi-k">ä»¶æ•°</div><div class="kpi-v">{{ a.count }}</div></div>
                    <div class="kpi"><div class="kpi-k">å–å¾—é¡</div><div class="kpi-v">Â¥{{ a.acq|floatformat:0|intcomma }}</div></div>
                    <div class="kpi"><div class="kpi-k">è©•ä¾¡é¡</div><div class="kpi-v">{% if a.val is not None %}Â¥{{ a.val|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
                    <div class="kpi"><div class="kpi-k">å«ã¿æç›Š</div><div class="kpi-v {% if a.pnl and a.pnl < 0 %}neg{% else %}pos{% endif %}">{% if a.pnl is not None %}Â¥{{ a.pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div></div>
                    <div class="kpi"><div class="kpi-k">æç›Šç‡</div><div class="kpi-v {% if a.pnl_pct and a.pnl_pct < 0 %}neg{% else %}pos{% endif %}">{% if a.pnl_pct is not None %}{{ a.pnl_pct|floatformat:2 }}%{% else %}â€”{% endif %}</div></div>
                    <div class="kpi"><div class="kpi-k">å‹ç‡</div><div class="kpi-v">{% if a.win_rate is not None %}{{ a.win_rate|floatformat:1 }}%{% else %}â€”{% endif %}</div></div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </section>
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>

<script>
  function initHoldingsSumbox(ctx){
    const box = (ctx||document).querySelector('#holdings-sumbox');
    if(!box) return;
    const KEY = 'holdings.sumbox.open.v2';
    const head = box.querySelector('[data-toggle]');
    const saved = localStorage.getItem(KEY);
    if(saved === '1'){ box.classList.add('is-open'); } else { box.classList.remove('is-open'); }
    head.onclick = function(){
      box.classList.toggle('is-open');
      localStorage.setItem(KEY, box.classList.contains('is-open') ? '1' : '0');
    };
  }
  initHoldingsSumbox(document);
</script>

{# ========== ã“ã“ã‹ã‚‰æ—¢å­˜ã‚«ãƒ¼ãƒ‰ä¸€è¦§ ========== #}
{% if page.object_list %}
  <div class="stack">
    {% for r in page.object_list %}{% with h=r.obj %}
    <article class="card row" data-swipe>
      <div class="actions">
        <div class="action-panel" onclick="event.stopPropagation()">
          <button type="button" class="item detail" data-action="detail"><span class="ico">ğŸ“„</span><span>è©³ç´°</span></button>
          <a class="item edit" href="{% url 'holding_edit' h.id %}"><span class="ico">âœï¸</span><span>ç·¨é›†</span></a>

          {# â˜… å£²å´ï¼ˆRealized ã®ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã‚’ #sheetRoot ã«å·®ã—è¾¼ã¿ï¼‰ #}
          <button type="button"
                  class="item sell"
                  hx-get="{% url 'realized_close_sheet' h.id %}"
                  hx-target="#sheetRoot"
                  hx-swap="innerHTML"
                  onclick="event.stopPropagation()">
            <span class="ico">ğŸ’±</span><span>å£²å´</span>
          </button>

          <button class="item delete"
                  hx-post="{% url 'holding_delete' h.id %}"
                  hx-confirm="å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"
                  hx-target="closest [data-swipe]"
                  hx-swap="outerHTML swap:15ms"><span class="ico">ğŸ—‘ï¸</span><span>å‰Šé™¤</span></button>
        </div>
      </div>

      <div class="track">
        <header class="head">
          <div class="head__left">
            <div class="name" title="{{ h.name|default:'-' }}">{{ h.name|default:"-" }}</div>
            <div class="chips">
              <span class="chip code">{{ h.ticker }}</span>
              <span class="chip">{{ h.get_broker_display }}</span>
              <span class="chip">{{ h.get_account_display }}</span>
              <span class="chip {% if h.side == 'SELL' %}sell{% else %}buy{% endif %}">{{ h.side }}</span>
            </div>
          </div>
          <div class="head__spark">
            <svg class="spark" viewBox="0 0 96 24" preserveAspectRatio="none"
                 data-rate="{{ r.pnl_pct|default:0 }}"
                 data-s7i='{{ r.s7_idx|default:"[]"|safe }}'
                 data-s30i='{{ r.s30_idx|default:"[]"|safe }}'
                 data-s90i='{{ r.s90_idx|default:"[]"|safe }}'
                 data-s7r='{{ r.s7_raw|default:"[]"|safe }}'
                 data-s30r='{{ r.s30_raw|default:"[]"|safe }}'
                 data-s90r='{{ r.s90_raw|default:"[]"|safe }}'></svg>
          </div>
        </header>

        <section class="stats">
          <div class="stat"><div class="stat__k">æ•°é‡</div><div class="stat__v">{{ h.quantity|intcomma }}</div></div>
          <div class="stat"><div class="stat__k">å¹³å‡å–å¾—</div><div class="stat__v">Â¥{{ h.avg_cost|floatformat:0|intcomma }}</div></div>
          <div class="stat {% if r.pnl is not None and r.pnl < 0 %}neg{% else %}pos{% endif %}">
            <div class="stat__k">å«ã¿æç›Š</div><div class="stat__v">{% if r.pnl is not None %}Â¥{{ r.pnl|floatformat:0|intcomma }}{% else %}â€”{% endif %}</div>
          </div>
          <div class="stat {% if r.pnl_pct is not None and r.pnl_pct < 0 %}neg{% else %}pos{% endif %}">
            <div class="stat__k">æç›Šç‡</div><div class="stat__v">{% if r.pnl_pct is not None %}{{ r.pnl_pct|floatformat:2 }}%{% else %}â€”{% endif %}</div>
          </div>
        </section>

        <section class="more">
          <div class="moregrid">
            <div class="kv"><div class="k">å–å¾—é¡</div><div class="v">Â¥{{ h.quantity|mul:h.avg_cost|floatformat:0|intcomma }}</div></div>
            <div class="kv"><div class="k">ä¿æœ‰é–‹å§‹</div><div class="v">{{ h.opened_at|date:"Y-m-d"|default:"â€”" }}</div></div>
            <div class="kv"><div class="k">ä¿æœ‰æ—¥æ•°</div><div class="v">{{ r.days|months_from_days }}</div></div>
            <div class="kv"><div class="k">æ›´æ–°</div><div class="v">{{ h.updated_at|date:"Y-m-d" }}</div></div>
            {% if h.memo %}<div class="kv" style="grid-column:1/-1"><div class="k">ãƒ¡ãƒ¢</div><div class="v">{{ h.memo }}</div></div>{% endif %}
          </div>
        </section>
      </div>
    </article>
    {% endwith %}{% endfor %}
  </div>

  {% if page.paginator.num_pages > 1 %}
  <div style="display:flex;gap:8px;justify-content:center;margin-top:14px">
    {% if page.has_previous %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.previous_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">å‰ã¸</a>
    {% endif %}
    <div style="opacity:.75;padding:8px 12px">Page {{page.number}} / {{page.paginator.num_pages}}</div>
    {% if page.has_next %}
      <a hx-get="{% url 'holding_list_partial' %}?page={{page.next_page_number}}&sort={{sort}}&order={{order}}&broker={{filters.broker}}&account={{filters.account}}&ticker={{filters.ticker}}&side={{filters.side}}&pnl={{filters.pnl}}"
         hx-target="#holdingsBody" hx-swap="innerHTML" class="btn-ghost">æ¬¡ã¸</a>
    {% endif %}
  </div>
  {% endif %}
{% else %}
  <div class="text-slate-400">ä¿æœ‰ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
{% endif %}

{# --- htmx æŒ¿å…¥å¾Œï¼šãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆã‚’â€œä¸­ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½â€ã«ã™ã‚‹æœ€å°ãƒ‘ãƒƒãƒ --- #}
<script>
(function(){
  // #sheetRoot ã¸ã‚·ãƒ¼ãƒˆãŒå·®ã—è¾¼ã¾ã‚ŒãŸç›´å¾Œã« CSS ã‚’æ³¨å…¥ã—ã€iOS ã§ã‚‚åº•ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  document.body.addEventListener('htmx:afterSwap', function(ev){
    if(ev.target && ev.target.id === 'sheetRoot'){
      // 1) æœ€å°CSSã‚’ä¸€åº¦ã ã‘æ³¨å…¥
      if(!document.getElementById('sheetPatch')){
        const css = `
#sheetRoot{position:fixed;inset:0;z-index:70}
#sheetRoot .sheet{position:absolute;left:0;right:0;bottom:0;max-height:88vh;display:flex;flex-direction:column;border-top-left-radius:14px;border-top-right-radius:14px;background:rgba(18,24,33,.98);border:1px solid rgba(255,255,255,.12);box-shadow:0 -10px 30px rgba(0,0,0,.4)}
#sheetRoot .sheet-head{padding:12px 14px;border-bottom:1px dashed rgba(255,255,255,.12)}
#sheetRoot .sheet-body{overflow:auto;-webkit-overflow-scrolling:touch;padding:12px}
#sheetRoot .sheet-foot{position:sticky;bottom:0;padding:10px 12px calc(10px + env(safe-area-inset-bottom));background:linear-gradient(180deg, rgba(18,24,33,.6), rgba(18,24,33,.98) 36%)}
html.lock-scroll,html.lock-scroll body{overflow:hidden;touch-action:none}
        `;
        const st = document.createElement('style'); st.id='sheetPatch'; st.textContent = css; document.head.appendChild(st);
      }
      // 2) èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ãƒ­ãƒƒã‚¯
      document.documentElement.classList.add('lock-scroll');
    }
  });

  // sheet ã‚’ç©ºã«ã—ãŸã‚‰ãƒ­ãƒƒã‚¯è§£é™¤ï¼ˆcloseãƒœã‚¿ãƒ³ã¯ data-dismiss="sheet" ã‚’ä»˜ã‘ã¦ãŠãï¼‰
  document.addEventListener('click', function(e){
    const btn = e.target.closest('[data-dismiss="sheet"]');
    if(btn){
      const root = document.getElementById('sheetRoot');
      if(root){ root.innerHTML = ''; }
      document.documentElement.classList.remove('lock-scroll');
    }
  });
})();
</script>