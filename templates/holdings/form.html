{% extends "base.html" %}
{% block title %}{% if mode == "edit" %}保有を編集{% else %}保有を追加{% endif %}{% endblock %}

{% block head %}
<style>
  .form-card{
    display:grid; gap:16px; padding:18px;
    border-radius:16px; background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08);
    max-width:600px; margin:0 auto;
  }
  .fi label{ display:block; font-size:13px; color:#9aa4b2; margin-bottom:4px; }
  .fi input, .fi select, .fi textarea{
    width:100%; padding:10px 12px; font-size:15px;
    border-radius:12px; border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06); color:#e6ebff; outline:none;
  }
  .fi textarea{ min-height:96px; resize:vertical; line-height:1.5; }
  .grid-fields{ display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(120px,1fr)); }
  .btn-bar{ display:flex; gap:12px; margin-top:4px; }
  .btn-bar button, .btn-bar a{
    flex:1; text-align:center; padding:12px; border-radius:12px;
    border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06);
    color:#e6ebff; text-decoration:none;
  }
  .btn-bar button:hover, .btn-bar a:hover{ background:rgba(255,255,255,.12); }
  .error-box{ padding:10px; border:1px solid #ff9aa9; background:#2b1f24; color:#ffd1d1; border-radius:8px; font-size:14px; }
  .hint {font-size:12px;color:#888}
</style>
{% endblock %}

{% block content %}
<div class="pnl">
  <h1 style="margin-bottom:12px">{% if mode == "edit" %}保有を編集{% else %}保有を追加{% endif %}</h1>

  <form method="post" class="form-card">
    {% csrf_token %}

    <div class="fi">
      <label>コード <span class="hint">例: 7203</span></label>
      {{ form.ticker }}
    </div>
    <div class="fi">
      <label>銘柄 <span class="hint">コード入力で自動反映（上書き可能）</span></label>
      {{ form.name }}
    </div>

    <div class="grid-fields">
      <div class="fi"><label>証券会社</label>{{ form.broker }}</div>
      <div class="fi"><label>口座区分</label>{{ form.account }}</div>
      <div class="fi"><label>BUY/SELL</label>{{ form.side }}</div>
    </div>

    <div class="grid-fields">
      <div class="fi"><label>株数</label>{{ form.quantity }}</div>
      <div class="fi"><label>平均取得単価</label>{{ form.avg_cost }}</div>
      <div class="fi"><label>保有開始日</label>{{ form.opened_at }}</div>
    </div>

    <div class="fi">
      <label>メモ <span class="hint">自由記入（売買理由・補足など）</span></label>
      {{ form.memo }}
    </div>

    {% if form.errors %}
      <div class="error-box">入力に誤りがあります。確認してください。</div>
    {% endif %}

    <div class="btn-bar">
      <button type="submit">保存</button>
      <a href="{% url 'holding_list' %}">戻る</a>
    </div>
  </form>
</div>

<script>
(function(){
  const endpoint = "{% url 'api_ticker_name' %}";
  const $ticker = document.querySelector('input[name="ticker"]');
  const $name   = document.querySelector('input[name="name"]');
  if (!$ticker || !$name) return;

  let userEditedName = false;         // ユーザーが手で編集したら true
  let nameAutofilled = false;         // 直前に自動で入れたら true
  let lastResolved   = { code: "", name: "" }; // 直前の自動入力値

  // ユーザーが銘柄名を手入力したら上書きは控える
  $name.addEventListener('input', ()=>{
    userEditedName = true;
    nameAutofilled = false;
  });

  // ★ コードが変わったら再び自動上書きを許可（手間なく反映させる）
  $ticker.addEventListener('input', ()=>{
    const v = ($ticker.value || '').trim();
    if (v !== lastResolved.code) {
      userEditedName = false;   // 次の lookup で上書きOKに戻す
    }
  });

  function debounce(fn, ms){
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), ms); };
  }

  function applyName(data){
    if (!data || !data.name) return;
    const curCode = ($ticker.value || '').trim();
    const curName = ($name.value  || '').trim();

    const codeChanged = data.code && data.code !== lastResolved.code;
    const safeToOverwrite =
      !userEditedName        // まだユーザー未編集
      || nameAutofilled      // 直前も自動入力（連続上書きOK）
      || !curName            // 現在空
      || curName === lastResolved.name; // 以前の自動値のまま

    if (codeChanged || safeToOverwrite) {
      if (data.code) $ticker.value = data.code;
      $name.value = data.name;
      nameAutofilled = true;
      userEditedName = false;                 // 自動入力直後は未編集扱い
      lastResolved = { code: data.code || curCode, name: data.name };
    }
  }

  function lookup(){
    const v = ($ticker.value || '').trim();
    if (!v) return;
    fetch(`${endpoint}?code=${encodeURIComponent(v)}`, {credentials:'same-origin'})
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(applyName)
      .catch(()=>{ /* 無視 */ });
  }

  $ticker.addEventListener('input',  debounce(lookup, 250));
  $ticker.addEventListener('change', lookup);
  $ticker.addEventListener('blur',   lookup);
})();
</script>
{% endblock %}