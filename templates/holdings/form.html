{% extends "base.html" %}
{% load static %}
{% block title %}{% if mode == "edit" %}ä¿æœ‰ã‚’ç·¨é›†{% else %}ä¿æœ‰ã‚’è¿½åŠ {% endif %}{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/holdings_form.css' %}?v=1">
{% endblock %}

{% block content %}
<div class="pnl">
  <h1 style="margin-bottom:12px">{% if mode == "edit" %}ä¿æœ‰ã‚’ç·¨é›†{% else %}ä¿æœ‰ã‚’è¿½åŠ {% endif %}</h1>

  <form method="post" class="form-card">
    {% csrf_token %}

    {# å¸‚å ´ãƒ»é€šè²¨ï¼ˆHiddenï¼‰#}
    {{ form.market }}
    {{ form.currency }}

    <!-- ã‚³ãƒ¼ãƒ‰ -->
    <div class="fi">
      <label>ã‚³ãƒ¼ãƒ‰ <span class="hint">ä¾‹: 7203 / AAPL</span><span class="loading-dot" id="codeSpin" style="display:none"></span></label>
      <input
        type="text"
        name="ticker"
        inputmode="latin"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
        style="text-transform:uppercase"
        placeholder="7203 / AAPL"
        value="{{ form.ticker.value|default_if_none:'' }}">
    </div>

    <!-- éŠ˜æŸ„å -->
    <div class="fi">
      <label>éŠ˜æŸ„ <span class="hint">ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã§è‡ªå‹•åæ˜ ï¼ˆä¸Šæ›¸ãå¯èƒ½ï¼‰</span></label>
      {{ form.name }}
    </div>

    <!-- ã‚»ã‚¯ã‚¿ãƒ¼ -->
    <div class="fi">
      <label>ã‚»ã‚¯ã‚¿ãƒ¼ <span class="hint">ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã§è‡ªå‹•åæ˜ ï¼ˆ33æ¥­ç¨®åˆ†é¡ï¼‰</span></label>
      <input
        type="text"
        name="sector"
        autocomplete="off"
        placeholder="ä¾‹: è¼¸é€ç”¨æ©Ÿå™¨"
        value="{{ form.sector.value|default_if_none:'' }}">
    </div>

    <!-- è¨¼åˆ¸ä¼šç¤¾ãƒ»å£åº§åŒºåˆ†ãƒ»æ–¹å‘ -->
    <div class="grid-fields">
      <div class="fi"><label>è¨¼åˆ¸ä¼šç¤¾</label>{{ form.broker }}</div>
      <div class="fi"><label>å£åº§åŒºåˆ†</label>{{ form.account }}</div>
      <div class="fi"><label>BUY/SELL</label>{{ form.side }}</div>
    </div>

    <!-- æ ªæ•°ãƒ»å˜ä¾¡ãƒ»é–‹å§‹æ—¥ -->
    <div class="grid-fields">
      <div class="fi">
        <label>æ ªæ•°</label>
        <input type="number" step="0.01" inputmode="decimal" name="quantity"
               value="{% if form.quantity.value and form.quantity.value != '0' %}{{ form.quantity.value }}{% endif %}">
      </div>
      <div class="fi">
        <label>å¹³å‡å–å¾—å˜ä¾¡</label>
        <input type="number" step="0.01" inputmode="decimal" name="avg_cost"
               value="{% if form.avg_cost.value and form.avg_cost.value != '0' %}{{ form.avg_cost.value }}{% endif %}">
      </div>
      <div class="fi">
        <label>ä¿æœ‰é–‹å§‹æ—¥</label>
        {{ form.opened_at }}
      </div>
    </div>

    <!-- ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ -->
    <div class="fi">
      <label>ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ <span class="hint">ç±³å›½æ ªãªã©JPYä»¥å¤–ã®ã¨ãå¿…é ˆã€‚ä¾‹: 155.250000ï¼ˆ1é€šè²¨ã‚ãŸã‚Šã®å††ï¼‰</span></label>
      {{ form.fx_rate }}
    </div>

    <!-- ãƒ¡ãƒ¢ -->
    <div class="fi">
      <label>ãƒ¡ãƒ¢ <span class="hint">è‡ªç”±è¨˜å…¥ï¼ˆå£²è²·ç†ç”±ãƒ»è£œè¶³ãªã©ï¼‰</span></label>
      {{ form.memo }}
    </div>

    {% if form.errors %}
      <div class="error-box">å…¥åŠ›ã«èª¤ã‚ŠãŒã‚ã‚Šã¾ã™ã€‚ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
    {% endif %}

    <div class="btn-bar">
      <button type="submit">ä¿å­˜</button>
      <a href="{% url 'holding_list' %}">æˆ»ã‚‹</a>
    </div>
  </form>
</div>

<script>
(function(){
  const endpoint = "{% url 'api_ticker_name' %}";
  const $ticker = document.querySelector('input[name="ticker"]');
  const $name   = document.querySelector('input[name="name"]');
  const $sector = document.querySelector('input[name="sector"]');
  const $spin   = document.getElementById('codeSpin');

  if (!$ticker || !$name) return;

  let userEditedName = false;
  let nameAutofilled = false;
  let lastResolved   = { code: "", name: "", sector: "" };

  // ç«¶åˆå¯¾ç­–ï¼šæœ€æ–°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã ã‘æœ‰åŠ¹ã«ã™ã‚‹
  let ac = null; // AbortController

  // å…¨è§’è‹±æ•°å­— â†’ åŠè§’è‹±æ•°å­—
  function toHalfWidth(str){
    return (str || "").replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, function(ch){
      return String.fromCharCode(ch.charCodeAt(0) - 0xFEE0);
    });
  }

  // ğŸ”  å…¥åŠ›ä¸­ã«åŠè§’è‹±æ•°å­—ã ã‘ã‚’è¨±å¯ & å¤§æ–‡å­—åŒ–
  $ticker.addEventListener('input', ()=>{
    // 1) å…¨è§’ã‚’åŠè§’ã¸
    let v = toHalfWidth($ticker.value);
    // 2) è‹±æ•°å­—ä»¥å¤–ã¯å…¨éƒ¨å‰Šé™¤ï¼ˆæ—¥æœ¬èªã¯ã“ã“ã§æ¶ˆãˆã‚‹ï¼‰
    v = v.replace(/[^0-9A-Za-z]/g, '');
    // 3) å¤§æ–‡å­—åŒ–
    v = v.toUpperCase();

    const changed = v !== lastResolved.code;
    $ticker.value = v;

    // ã‚³ãƒ¼ãƒ‰ãŒå¤‰ã‚ã£ãŸã‚‰ã‚»ã‚¯ã‚¿ãƒ¼ã¯ã„ã£ãŸã‚“ã‚¯ãƒªã‚¢
    if (changed && $sector) $sector.value = "";

    debLookup();
  });

  $name.addEventListener('input', ()=>{
    userEditedName = true;
    nameAutofilled = false;
  });

  function debounce(fn, ms){
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), ms); };
  }

  function applyData(data){
    if (!data) return;

    const curCode = ($ticker.value || '').trim();
    const codeChanged = !!data.code && data.code !== lastResolved.code;

    if (data.code) $ticker.value = String(data.code).toUpperCase();

    const safeToOverwriteName =
      !userEditedName || nameAutofilled || !$name.value || $name.value === lastResolved.name;
    if ((codeChanged || safeToOverwriteName) && data.name) {
      $name.value = data.name;
      nameAutofilled = true;
      userEditedName = false;
    }

    if ($sector && data.sector !== undefined) {
      // å¸¸ã«ä¸Šæ›¸ãï¼ˆç©ºæ–‡å­—ã‚‚æ˜ç¤ºçš„ã«åæ˜ ï¼‰
      $sector.value = data.sector || "";
    }

    lastResolved = {
      code: data.code || curCode,
      name: $name.value || "",
      sector: $sector ? ($sector.value || "") : ""
    };
  }

  function setLoading(on){
    if ($spin) $spin.style.display = on ? '' : 'none';
  }

  function lookup(tryCount=0){
    const v = ($ticker.value || '').trim();
    if (!v) return;

    // æ—¢å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    if (ac) ac.abort();
    ac = new AbortController();

    setLoading(true);
    fetch(`${endpoint}?code=${encodeURIComponent(v)}`, {
      credentials:'same-origin',
      signal: ac.signal
    })
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(data => {
        setLoading(false);
        applyData(data);

        // ã‚»ã‚¯ã‚¿ãƒ¼ãŒç©ºãªã‚‰è»½ããƒªãƒˆãƒ©ã‚¤ï¼ˆAPIå´ãŒãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§åŸ‹ã¾ã‚‹ã¾ã§ã®çŒ¶äºˆï¼‰
        if ((!data || !data.sector) && tryCount < 2) {
          setTimeout(()=>lookup(tryCount+1), 600);
        }
      })
      .catch(err => {
        setLoading(false);
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä»¥å¤–ã¯æ§ãˆã‚ã«1å›ã ã‘å†è©¦è¡Œ
        if (tryCount < 1 && (!err || err.name !== 'AbortError')) {
          setTimeout(()=>lookup(tryCount+1), 600);
        }
      });
  }

  const debLookup = debounce(lookup, 300);

  // å…¥åŠ›ç¢ºå®šç³»ã§ã‚‚å‘¼ã¶
  $ticker.addEventListener('change', ()=>lookup(0));
  $ticker.addEventListener('blur',   ()=>lookup(0));

  // åˆæœŸå€¤ãŒå…¥ã£ã¦ã‚‹ã¨ãã¯ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«è‡ªå‹•è§£æ±º
  if (($ticker.value || '').trim()) {
    // ã“ã“ã‚‚ãƒ•ã‚£ãƒ«ã‚¿ã‚’é€šã—ã¦ã‹ã‚‰å®Ÿè¡Œ
    let v = toHalfWidth($ticker.value).replace(/[^0-9A-Za-z]/g,'').toUpperCase();
    $ticker.value = v;
    lookup(0);
  }
})();
</script>
{% endblock %}