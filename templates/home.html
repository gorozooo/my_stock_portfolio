{# templates/home.html #}
{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% block title %}Home{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=107">

<div class="home-shell">
  <!-- Top: ticker -->
  <div class="home-top">
    <div class="pill pill-ticker" id="newsTicker">
      <div class="ticker-icon">ğŸ“°</div>
      <div class="ticker-track">
        <div class="ticker-text" id="tickerText">
          {% for d in decks %}
            {% if d.key == "news_trends" %}
              {% if d.payload.items %}
                NEWS:
                {% for it in d.payload.items|slice:":6" %}
                  {{ it.source }}ã€Œ{{ it.title }}ã€ /
                {% endfor %}
              {% else %}
                NEWS: æº–å‚™ä¸­
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Deck rail -->
  <div class="rail" id="rail">
    {% for d in decks %}
      <section class="deck" data-key="{{ d.key }}">
        <div class="deck-card">

          <div class="deck-head">
            <div class="deck-title">{{ d.title }}</div>
            {% if d.payload.as_of %}
              <div class="deck-sub">æ›´æ–°: {{ d.payload.as_of }}</div>
            {% endif %}
          </div>

          <!-- =========================
               ASSETS
               ========================= -->
          {% if d.key == "assets" %}
            {% with a=d.payload %}
              <div class="grid2">
                <div class="kpi">
                  <div class="kpi-label">å®Ÿç¾æç›Š YTD</div>
                  <div class="kpi-val {% if a.realized.ytd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.ytd.total|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.ytd.count }}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">ä»Šæœˆ MTD</div>
                  <div class="kpi-val {% if a.realized.mtd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.mtd.total|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.mtd.count }}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">ä»Šé€± WTD</div>
                  <div class="kpi-val {% if a.realized.wtd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.wtd.total|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.wtd.count }}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">å¹´é–“ç›®æ¨™ï¼ˆå…¨ä½“ï¼‰</div>
                  <div class="kpi-val">
                    Â¥{{ a.goals.year_total|intcomma }}
                  </div>
                  <div class="kpi-sub">æ®‹ã‚Šæœˆ{{ a.pace.remaining_months_including_current }} / æ®‹ã‚Šé€±{{ a.pace.remaining_weeks_including_current }}</div>
                </div>
              </div>

              <div class="sec">
                <div class="sec-title">å¿…è¦ãƒšãƒ¼ã‚¹ï¼ˆã“ã‚Œã‹ã‚‰ï¼‰</div>
                <div class="grid2">
                  <div class="kpi">
                    <div class="kpi-label">æœˆãƒšãƒ¼ã‚¹</div>
                    <div class="kpi-val {% if a.pace.total_need_per_month.need_per_slot > 0 %}warn{% else %}pos{% endif %}">
                      Â¥{{ a.pace.total_need_per_month.need_per_slot|floatformat:0|intcomma }}
                    </div>
                    <div class="kpi-sub">
                      æ®‹ã‚Š
                      <span class="{% if a.pace.total_need_per_month.remaining > 0 %}warn{% else %}pos{% endif %}">
                        Â¥{{ a.pace.total_need_per_month.remaining|floatformat:0|intcomma }}
                      </span>
                    </div>
                  </div>

                  <div class="kpi">
                    <div class="kpi-label">é€±ãƒšãƒ¼ã‚¹</div>
                    <div class="kpi-val {% if a.pace.total_need_per_week.need_per_slot > 0 %}warn{% else %}pos{% endif %}">
                      Â¥{{ a.pace.total_need_per_week.need_per_slot|floatformat:0|intcomma }}
                    </div>
                    <div class="kpi-sub">
                      æ®‹ã‚Š
                      <span class="{% if a.pace.total_need_per_week.remaining > 0 %}warn{% else %}pos{% endif %}">
                        Â¥{{ a.pace.total_need_per_week.remaining|floatformat:0|intcomma }}
                      </span>
                    </div>
                  </div>
                </div>
                <div class="hint">â€» æœªé”ï¼ˆæ®‹ã‚Š/å¿…è¦ãƒšãƒ¼ã‚¹ãŒãƒ—ãƒ©ã‚¹ï¼‰â†’é»„è‰²ã€‚é”æˆï¼ˆãƒã‚¤ãƒŠã‚¹/ã‚¼ãƒ­ï¼‰â†’ç·‘ã€‚</div>
              </div>

              <div class="sec">
                <div class="sec-title">è¨¼åˆ¸ä¼šç¤¾åˆ¥ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰</div>

                <div class="broker-cards">
                  {% for r in a.pace.by_broker_rows %}
                    <div class="bcard">
                      <div class="bcard-top">
                        <div class="bcard-name">{{ r.label }}</div>
                        <div class="bcard-ytd {% if r.ytd >= 0 %}pos{% else %}neg{% endif %}">
                          Â¥{{ r.ytd|floatformat:0|intcomma }}
                        </div>
                      </div>

                      <div class="brow">
                        <div class="lk">å¹´ç›®æ¨™</div>
                        <div class="lv">Â¥{{ r.goal_year|intcomma }}</div>
                      </div>

                      <div class="brow">
                        <div class="lk">æ®‹ã‚Šï¼ˆæœˆåŸºæº–ï¼‰</div>
                        <div class="lv {% if r.pace_month.remaining > 0 %}warn{% else %}pos{% endif %}">
                          Â¥{{ r.pace_month.remaining|floatformat:0|intcomma }}
                        </div>
                      </div>

                      <div class="brow">
                        <div class="lk">æœˆãƒšãƒ¼ã‚¹</div>
                        <div class="lv {% if r.pace_month.need_per_slot > 0 %}warn{% else %}pos{% endif %}">
                          Â¥{{ r.pace_month.need_per_slot|floatformat:0|intcomma }}
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>

                <div class="hint">æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ï¼šYTD / ç›®æ¨™ / æ®‹ã‚Š / æœˆãƒšãƒ¼ã‚¹</div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- =========================
               AI BRIEFï¼ˆæœ€çµ‚ä»•æ§˜ï¼‰
               ========================= -->
          {% if d.key == "ai_brief" %}
            {% with b=d.payload %}
              <div class="brief">

                {# ---- 1) è¦ç´„ï¼ˆ100ã€œ160æ–‡å­—ï¼‰ ---- #}
                {% if b.summary %}
                  <div class="brief-headline">{{ b.summary }}</div>
                {% else %}
                  <div class="brief-headline">{{ b.headline|default:"ï¼ˆæº–å‚™ä¸­ï¼‰" }}</div>
                {% endif %}

                {# ---- 2) æ ¹æ‹ ï¼ˆæœ€å¤§5ï¼‰: ã‚¢ãƒ—ãƒªå†…ãƒ‡ãƒ¼ã‚¿ã®ã¿ ---- #}
                {% if b.reasons %}
                  <div class="sec" style="margin-top:10px;">
                    <div class="sec-title">æ ¹æ‹ </div>
                    <div class="brief-list">
                      {% for s in b.reasons|slice:":5" %}
                        <div class="brief-item">â€¢ {{ s }}</div>
                      {% endfor %}
                    </div>
                  </div>
                {% else %}
                  {# äº’æ›ï¼ˆæ—§ï¼‰ #}
                  {% if b.bullets %}
                    <div class="brief-list">
                      {% for s in b.bullets %}
                        <div class="brief-item">â€¢ {{ s }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endif %}

                {# ---- 3) æ‡¸å¿µï¼ˆæœ€å¤§2ï¼‰ ---- #}
                {% if b.concerns %}
                  <div class="sec" style="margin-top:12px;">
                    <div class="sec-title">æ‡¸å¿µ</div>
                    <div class="brief-list">
                      {% for s in b.concerns|slice:":2" %}
                        <div class="brief-item">â€¢ {{ s }}</div>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}

                {# ---- 4) é€ƒã’é“ï¼ˆ1è¡Œï¼‰ ---- #}
                {% if b.escape %}
                  <div class="sec" style="margin-top:12px;">
                    <div class="sec-title">é€ƒã’é“</div>
                    <div class="market-summary">{{ b.escape }}</div>
                  </div>
                {% endif %}

                {# ---- 5) å¤–éƒ¨ãƒ‹ãƒ¥ãƒ¼ã‚¹ï¼ˆå‚è€ƒï¼šã»ã©ã»ã©ï¼‰ ---- #}
                {% if b.reference_news %}
                  <div class="sec" style="margin-top:12px;">
                    <div class="sec-title">å‚è€ƒï¼ˆå¤–éƒ¨ï¼‰</div>
                    <a class="li" href="{{ b.reference_news.link }}" target="_blank" rel="noopener">
                      <div class="badge">{{ b.reference_news.source|default:"NEWS" }}</div>
                      <div class="li-title">{{ b.reference_news.title }}</div>
                      <div class="li-sub">
                        <span class="host">{{ b.reference_news.host }}</span>
                        {% if b.reference_news.hint %}
                          ãƒ»{{ b.reference_news.hint }}
                        {% endif %}
                      </div>
                    </a>
                  </div>
                {% endif %}

                <div class="hint">ç›®çš„ï¼šAIã®äººæ ¼ï¼ˆè¦ç´„â†’æ ¹æ‹ â†’æ‡¸å¿µâ†’é€ƒã’é“ï¼‰ã€‚æ ¹æ‹ ã¯ã‚¢ãƒ—ãƒªå†…ãƒ‡ãƒ¼ã‚¿ã®ã¿ã€‚å¤–éƒ¨ã¯å‚è€ƒæ ã«éš”é›¢ã€‚</div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- =========================
               RISK
               ========================= -->
          {% if d.key == "risk" %}
            {% with r=d.payload %}
              <div class="sec">
                <div class="sec-title">ä»Šæ—¥ã®ãƒªã‚¹ã‚¯æ </div>

                {% if r.metrics %}
                  <div class="risk-grid">
                    {% for m in r.metrics %}
                      <div class="risk-kpi">
                        <div class="rk-label">{{ m.label }}</div>
                        <div class="rk-val {% if m.kind == 'bad' %}neg{% elif m.kind == 'warn' %}warn{% else %}pos{% endif %}">
                          {{ m.value }}
                        </div>
                        {% if m.sub %}
                          <div class="rk-sub">{{ m.sub }}</div>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="empty">RISK ç”Ÿæˆä¸­â€¦</div>
                {% endif %}

                {% if r.alerts %}
                  <div class="sec" style="margin-top:12px;">
                    <div class="sec-title">æ³¨æ„</div>
                    <div class="plan">
                      {% for a in r.alerts %}
                        <div class="plan-item">
                          <div class="plan-head">
                            <span class="tag {% if a.kind == 'bad' %}tag-primary{% else %}tag-check{% endif %}">
                              {% if a.kind == 'bad' %}ALERT{% else %}CHECK{% endif %}
                            </span>
                            <div class="plan-title">{{ a.title }}</div>
                          </div>
                          <div class="plan-desc">{{ a.desc }}</div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}

                {% if r.rules %}
                  <div class="sec" style="margin-top:12px;">
                    <div class="sec-title">ä»Šæ—¥ã®ãƒ«ãƒ¼ãƒ«</div>
                    <div class="rule-box">
                      {% for s in r.rules %}
                        <div class="rule-item">âœ“ {{ s }}</div>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}

                {% if r.notes %}
                  <div class="hint" style="margin-top:10px;">
                    {% for s in r.notes %}
                      <div>ãƒ»{{ s }}</div>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            {% endwith %}
          {% endif %}

          <!-- =========================
               MARKET
               ========================= -->
          {% if d.key == "market" %}
            {% with m=d.payload %}
              <div class="sec">
                <div class="sec-title">ä»Šæ—¥ã®ç›¸å ´ãƒ¡ãƒ¢</div>
                <div class="market-summary">{{ m.summary|default:"ï¼ˆæº–å‚™ä¸­ï¼‰" }}</div>

                <div class="sec" style="margin-top:12px;">
                  <div class="sec-title">NEWSï¼ˆä¸Šä½ï¼‰</div>
                  <div class="list">
                    {% for it in m.news %}
                      <a class="li" href="{{ it.link }}" target="_blank" rel="noopener">
                        <div class="badge">{{ it.source }}</div>
                        <div class="li-title">{{ it.title }}</div>
                        <div class="li-sub">
                          <span class="host">{{ it.host }}</span>
                        </div>
                      </a>
                    {% empty %}
                      <div class="empty">ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ä¸­â€¦</div>
                    {% endfor %}
                  </div>
                </div>

                <div class="sec" style="margin-top:12px;">
                  <div class="sec-title">ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆä»£æ›¿ï¼‰</div>
                  <div class="list">
                    {% for it in m.trends %}
                      <a class="li" href="{{ it.link }}" target="_blank" rel="noopener">
                        <div class="badge">Trends</div>
                        <div class="li-title">{{ it.title }}</div>
                        <div class="li-sub">
                          <span class="host">{{ it.host }}</span>
                        </div>
                      </a>
                    {% empty %}
                      <div class="empty">ãƒˆãƒ¬ãƒ³ãƒ‰å–å¾—ä¸­â€¦</div>
                    {% endfor %}
                  </div>
                </div>

                <div class="hint">ç›®çš„ï¼šç›¸å ´ã‚’â€œèª­ã‚€â€ã˜ã‚ƒãªãã€ç›£è¦–æ¡ä»¶ã«å¤‰ãˆã‚‹ã€‚</div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- =========================
               TODAY PLAN
               ========================= -->
          {% if d.key == "today_plan" %}
            {% with t=d.payload %}
              <div class="sec">
                <div class="sec-title">ä»Šæ—¥ã®ä½œæˆ¦</div>

                {% if t.tasks %}
                  <div class="plan">
                    {% for x in t.tasks %}
                      <div class="plan-item">
                        <div class="plan-head">
                          <span class="tag
                            {% if x.kind == "primary" %}tag-primary
                            {% elif x.kind == "broker" %}tag-broker
                            {% elif x.kind == "ok" %}tag-ok
                            {% else %}tag-check{% endif %}
                          ">
                            {% if x.kind == "primary" %}PRIORITY
                            {% elif x.kind == "broker" %}BROKER
                            {% elif x.kind == "ok" %}OK
                            {% else %}CHECK{% endif %}
                          </span>
                          <div class="plan-title">{{ x.title }}</div>
                        </div>
                        <div class="plan-desc">{{ x.desc|linebreaksbr }}</div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="empty">TODAY PLAN ç”Ÿæˆä¸­â€¦</div>
                {% endif %}

                <div class="hint">ASSETSï¼ˆç›®æ¨™å·®åˆ†ï¼‰ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã€‚å¾Œã§ Policy/Watch ã«æ¥ç¶šã—ã¦è‡ªå‹•ã§â€œå…·ä½“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³â€ã¸ã€‚</div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- =========================
               NEWS & TRENDS
               ========================= -->
          {% if d.key == "news_trends" %}
            {% with n=d.payload %}
              <div class="sec">
                <div class="sec-title">æ³¨ç›®ã‚»ã‚¯ã‚¿ãƒ¼ï¼ˆã–ã£ãã‚Šï¼‰</div>
                <div class="chips">
                  {% for s in n.sectors %}
                    <div class="chip">{{ s.sector }} Ã—{{ s.count }}</div>
                  {% empty %}
                    <div class="chip">ãã®ä»– Ã—0</div>
                  {% endfor %}
                </div>
                <div class="deck-sub" style="margin-top:10px;">æ›´æ–°: {{ n.as_of }}</div>
              </div>

              <div class="sec">
                <div class="sec-title">ãƒ‹ãƒ¥ãƒ¼ã‚¹</div>
                <div class="list">
                  {% for it in n.items|slice:":10" %}
                    <a class="li" href="{{ it.link }}" target="_blank" rel="noopener">
                      <div class="badge">{{ it.source }}</div>
                      <div class="li-title">{{ it.title }}</div>
                      <div class="li-sub">
                        <span class="host">{{ it.host }}</span>
                      </div>
                    </a>
                  {% empty %}
                    <div class="empty">ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ä¸­â€¦</div>
                  {% endfor %}
                </div>
              </div>

              <div class="sec">
                <div class="sec-title">ãƒãƒƒãƒˆ/ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆä»£æ›¿ï¼‰</div>
                <div class="list">
                  {% for it in n.trends|slice:":10" %}
                    <a class="li" href="{{ it.link }}" target="_blank" rel="noopener">
                      <div class="badge">Trends</div>
                      <div class="li-title">{{ it.title }}</div>
                      <div class="li-sub">
                        <span class="host">{{ it.host }}</span>
                      </div>
                    </a>
                  {% empty %}
                    <div class="empty">ãƒˆãƒ¬ãƒ³ãƒ‰å–å¾—ä¸­â€¦</div>
                  {% endfor %}
                </div>
              </div>
            {% endwith %}
          {% endif %}

        </div>
      </section>
    {% endfor %}
  </div>

  <!-- dots -->
  <div class="dots" id="dots"></div>
</div>

<script src="{% static 'js/home.js' %}?v=103" defer></script>
{% endblock %}