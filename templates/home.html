{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% block title %}Home{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=103">

<div class="home-shell">
  <!-- Top: date pill + ticker -->
  <div class="home-top">
    <div class="pill pill-date">
      <div class="pill-cap">æœ¬æ—¥</div>
      <div class="pill-main">{{ today_label }}</div>
    </div>

    <div class="pill pill-ticker" id="newsTicker">
      <div class="ticker-icon">ğŸ“°</div>
      <div class="ticker-track">
        <div class="ticker-text" id="tickerText">
          {% for d in decks %}
            {% if d.key == "news_trends" %}
              {% if d.payload.items %}
                NEWS:
                {% for it in d.payload.items|slice:":6" %}
                  {{ it.source }}ã€Œ{{ it.title }}ã€ /
                {% endfor %}
              {% else %}
                NEWS: æº–å‚™ä¸­
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Deck rail -->
  <div class="rail" id="rail">
    {% for d in decks %}
      <section class="deck" data-key="{{ d.key }}">
        <div class="deck-card">

          <div class="deck-head">
            <div class="deck-title">{{ d.title }}</div>
            {% if d.payload.as_of %}
              <div class="deck-sub">æ›´æ–°: {{ d.payload.as_of }}</div>
            {% endif %}
          </div>

          <!-- ASSETS -->
          {% if d.key == "assets" %}
            {% with a=d.payload %}
              <div class="grid2">
                <div class="kpi">
                  <div class="kpi-label">å®Ÿç¾æç›Š YTD</div>
                  <div class="kpi-val {% if a.realized.ytd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.ytd.total|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.ytd.count }}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">ä»Šæœˆ MTD</div>
                  <div class="kpi-val {% if a.realized.mtd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.mtd.total|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.mtd.count }}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">ä»Šé€± WTD</div>
                  <div class="kpi-val {% if a.realized.wtd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.wtd.total|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.wtd.count }}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">å¹´é–“ç›®æ¨™ï¼ˆå…¨ä½“ï¼‰</div>
                  <div class="kpi-val">
                    Â¥{{ a.goals.year_total|intcomma }}
                  </div>
                  <div class="kpi-sub">æ®‹ã‚Šæœˆ{{ a.pace.remaining_months_including_current }} / æ®‹ã‚Šé€±{{ a.pace.remaining_weeks_including_current }}</div>
                </div>
              </div>

              <div class="sec">
                <div class="sec-title">å¿…è¦ãƒšãƒ¼ã‚¹ï¼ˆã“ã‚Œã‹ã‚‰ï¼‰</div>
                <div class="grid2">
                  <div class="kpi">
                    <div class="kpi-label">æœˆ</div>
                    <div class="kpi-val {% if a.pace.total_need_per_month.need_per_slot >= 0 %}pos{% else %}neg{% endif %}">
                      Â¥{{ a.pace.total_need_per_month.need_per_slot|floatformat:0|intcomma }}
                    </div>
                    <div class="kpi-sub">æ®‹ã‚Š Â¥{{ a.pace.total_need_per_month.remaining|floatformat:0|intcomma }}</div>
                  </div>
                  <div class="kpi">
                    <div class="kpi-label">é€±</div>
                    <div class="kpi-val {% if a.pace.total_need_per_week.need_per_slot >= 0 %}pos{% else %}neg{% endif %}">
                      Â¥{{ a.pace.total_need_per_week.need_per_slot|floatformat:0|intcomma }}
                    </div>
                    <div class="kpi-sub">æ®‹ã‚Š Â¥{{ a.pace.total_need_per_week.remaining|floatformat:0|intcomma }}</div>
                  </div>
                </div>
              </div>

              <div class="sec">
                <div class="sec-title">è¨¼åˆ¸ä¼šç¤¾åˆ¥ï¼ˆYTD / ç›®æ¨™ / å¿…è¦ãƒšãƒ¼ã‚¹ï¼‰</div>
                <div class="table">
                  <div class="tr th">
                    <div>è¨¼åˆ¸ä¼šç¤¾</div>
                    <div class="r">YTD</div>
                    <div class="r">ç›®æ¨™</div>
                    <div class="r">æœˆãƒšãƒ¼ã‚¹</div>
                  </div>
                  {% for r in a.pace.by_broker_rows %}
                    <div class="tr">
                      <div class="bname">{{ r.label }}</div>
                      <div class="r {% if r.ytd >= 0 %}pos{% else %}neg{% endif %}">
                        {{ r.ytd|floatformat:0|intcomma }}
                      </div>
                      <div class="r">{{ r.goal_year|intcomma }}</div>
                      <div class="r {% if r.pace_month.need_per_slot >= 0 %}pos{% else %}neg{% endif %}">
                        {{ r.pace_month.need_per_slot|floatformat:0|intcomma }}
                      </div>
                    </div>
                  {% endfor %}
                </div>
                <div class="hint">ï¼ˆä¾‹ï¼‰YTD / å¹´ç›®æ¨™ / æœˆãƒšãƒ¼ã‚¹</div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- TODAY PLAN -->
          {% if d.key == "today_plan" %}
            {% with p=d.payload %}
              {% if p.actions and p.status == "ok" %}
                <div class="plan">
                  <div class="plan-top">
                    <div class="plan-mode tone-{{ p.mode.tone|default:'mid' }}">
                      <span class="plan-mode-cap">MODE</span>
                      <span class="plan-mode-main">{{ p.mode.label|default:"é‹ç”¨" }}</span>
                    </div>
                    <div class="plan-theme">
                      <div class="plan-theme-cap">THEME</div>
                      <div class="plan-theme-main">{{ p.theme|default:"å…¨ä½“ï¼ˆãƒã‚¯ãƒ­ï¼‰" }}</div>
                    </div>
                  </div>

                  {% for a in p.actions %}
                    <div class="plan-card lv-{{ a.level|default:'mid' }}">
                      <div class="plan-card-head">
                        <div class="plan-rank">#{{ a.rank }}</div>
                        <div class="plan-tag">{{ a.tag }}</div>
                      </div>
                      <div class="plan-title">{{ a.title }}</div>

                      <div class="plan-block">
                        <div class="plan-cap">WHY</div>
                        <ul class="plan-ul">
                          {% for w in a.why %}
                            <li>{{ w }}</li>
                          {% endfor %}
                        </ul>
                      </div>

                      <div class="plan-block">
                        <div class="plan-cap">DO</div>
                        <ul class="plan-ul">
                          {% for w in a.do %}
                            <li>{{ w }}</li>
                          {% endfor %}
                        </ul>
                      </div>

                      <div class="plan-block">
                        <div class="plan-cap">WATCH</div>
                        <div class="plan-chips">
                          {% for w in a.watch %}
                            <span class="plan-chip">{{ w }}</span>
                          {% endfor %}
                        </div>
                      </div>
                    </div>
                  {% endfor %}

                  {% if p.notes %}
                    <div class="plan-notes">
                      {% for n in p.notes %}
                        <div class="plan-note">â€¢ {{ n }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}
                </div>
              {% else %}
                <div class="stub">
                  <div class="stub-title">ï¼ˆæº–å‚™ä¸­ï¼‰</div>
                  <div class="stub-sub">TODAY PLAN ç”ŸæˆãŒã¾ã æº–å‚™ä¸­ã§ã™ï¼ˆstatus: {{ p.status|default:"stub" }}ï¼‰</div>
                  {% if p.error %}
                    <div class="stub-sub" style="margin-top:10px;color:rgba(255,180,180,.8);">error: {{ p.error }}</div>
                  {% endif %}
                </div>
              {% endif %}
            {% endwith %}
          {% endif %}

          <!-- NEWS & TRENDS -->
          {% if d.key == "news_trends" %}
            {% with n=d.payload %}
              <div class="sec">
                <div class="sec-title">æ³¨ç›®ã‚»ã‚¯ã‚¿ãƒ¼ï¼ˆã–ã£ãã‚Šï¼‰</div>
                <div class="chips">
                  {% for s in n.sectors %}
                    <div class="chip">{{ s.sector }} Ã—{{ s.count }}</div>
                  {% empty %}
                    <div class="chip">ãã®ä»– Ã—0</div>
                  {% endfor %}
                </div>
                <div class="deck-sub" style="margin-top:10px;">æ›´æ–°: {{ n.as_of }}</div>
              </div>

              <div class="sec">
                <div class="sec-title">ãƒ‹ãƒ¥ãƒ¼ã‚¹</div>
                <div class="list">
                  {% for it in n.items|slice:":10" %}
                    <a class="li" href="{{ it.link }}" target="_blank" rel="noopener">
                      <div class="badge">{{ it.source }}</div>
                      <div class="li-title">{{ it.title }}</div>
                      <div class="li-sub">
                        <span class="host">{{ it.host }}</span>
                      </div>
                    </a>
                  {% empty %}
                    <div class="empty">ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ä¸­â€¦</div>
                  {% endfor %}
                </div>
              </div>

              <div class="sec">
                <div class="sec-title">ãƒãƒƒãƒˆ/ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆä»£æ›¿ï¼‰</div>
                <div class="list">
                  {% for it in n.trends|slice:":10" %}
                    <a class="li" href="{{ it.link }}" target="_blank" rel="noopener">
                      <div class="badge">Trends</div>
                      <div class="li-title">{{ it.title }}</div>
                      <div class="li-sub">
                        <span class="host">{{ it.host }}</span>
                      </div>
                    </a>
                  {% empty %}
                    <div class="empty">ãƒˆãƒ¬ãƒ³ãƒ‰å–å¾—ä¸­â€¦</div>
                  {% endfor %}
                </div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- STUB decks -->
          {% if d.key != "assets" and d.key != "news_trends" and d.key != "today_plan" %}
            <div class="stub">
              <div class="stub-title">ï¼ˆæº–å‚™ä¸­ï¼‰</div>
              <div class="stub-sub">ã“ã“ã¯å¾Œã§ aiapp ã®çŸ¥èƒ½ãƒ»ãƒãƒªã‚·ãƒ¼ãƒ»ãƒ¬ã‚¸ãƒ¼ãƒ ç­‰ã¨åˆä½“ã—ã¦â€œè‡ªåˆ†ã§è€ƒãˆã¦ç™ºè¨€ã™ã‚‹AIâ€ã«é€²åŒ–ã•ã›ã‚‹</div>
            </div>
          {% endif %}

        </div>
      </section>
    {% endfor %}
  </div>

  <!-- dots -->
  <div class="dots" id="dots"></div>
</div>

<script src="{% static 'js/home.js' %}?v=101" defer></script>
{% endblock %}