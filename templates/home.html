{% extends "base.html" %}
{% load static humanize %}

{% block title %}ホーム | My株ポートフォリオ{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=7">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="{% static 'js/home.js' %}?v=7"></script>
{% endblock %}

{% block content %}

<!-- 🧠 AIヘッダー -->
<section class="ai-header glass">
  <div class="ai-title">AIアドバイザー</div>
  <div class="ai-tools">
    <button class="btn ghost" id="btn-ai-weekly">週次レポート</button>
    <button class="btn ghost" id="btn-ai-rebalance">次の一手</button>
  </div>
  {% if ai_note %}
    <p class="ai-note">{{ ai_note }}</p>
  {% endif %}
  {% if ai_actions %}
    <ul class="ai-actions">
      {% for a in ai_actions %}
        <li>• {{ a }}</li>
      {% endfor %}
    </ul>
  {% endif %}
</section>

<!-- 📊 KPI -->
<section class="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-label">総資産（評価＋現金）</div>
    <div class="kpi-value">¥{{ kpis.total_assets|intcomma }}</div>
    <div class="kpi-sub">＝現物＋信用の評価額 ＋ 現金</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">未実現損益（現物＋信用）</div>
    <div class="kpi-value kpi-pnl" data-sign="{{ kpis.unrealized_pnl }}">¥{{ kpis.unrealized_pnl|intcomma }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">今月の実現</div>
    <div class="kpi-value kpi-pnl" data-sign="{{ kpis.realized_month }}">¥{{ kpis.realized_month|intcomma }}</div>
    <div class="kpi-sub muted">配当 ¥{{ kpis.dividend_month|intcomma }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">ROI（投下資金比）</div>
    <div class="kpi-value">{% if kpis.roi_pct != None %}{{ kpis.roi_pct }}%{% else %}—{% endif %}</div>
    <div class="kpi-sub muted">投下資金 ¥{{ kpis.invested|intcomma }}</div>
  </div>
</section>

<!-- 💸 今すぐ全て現金化したら（視覚重視カード） -->
<section class="liquid glass">
  <div class="liquid-head">
    <div class="title">今すぐ全て現金化したら</div>
    <div class="chip">流動性 <strong>{{ kpis.liquidity_rate_pct }}%</strong></div>
  </div>

  <div class="liquid-hero">
    <div class="liquid-amount">¥{{ kpis.liquidation|intcomma }}</div>
    <div class="liquid-caption">税・手数料は考慮なし</div>
  </div>

  <div class="liquid-grid">
    <div class="li-row">
      <span>現物の評価額</span>
      <strong>¥{{ breakdown.spot_mv|intcomma }}</strong>
    </div>
    <div class="li-row">
      <span>信用の<strong>含み損益</strong></span>
      <strong class="{% if breakdown.margin_unrealized >= 0 %}pos{% else %}neg{% endif %}">
        ¥{{ breakdown.margin_unrealized|intcomma }}
      </strong>
    </div>
    <div class="li-row">
      <span>現金残高</span>
      <strong>¥{{ kpis.cash_total|intcomma }}</strong>
    </div>
  </div>

  <div class="li-bar" role="img" aria-label="即時現金化率ゲージ">
    <div class="li-bar-fill" style="width: {{ kpis.liquidity_rate_pct }}%"></div>
  </div>

  <ul class="li-badges">
    <li class="pill">現物比率 {{ breakdown_pct.spot_pct }}%</li>
    <li class="pill warn">信用比率 {{ breakdown_pct.margin_pct }}%</li>
  </ul>

  {% if risk_flags %}
    <div class="warn-list">
      {% for w in risk_flags %}
        <div class="warn-item">⚠️ {{ w }}</div>
      {% endfor %}
    </div>
  {% endif %}
</section>

<!-- 🧾 内訳（現物 / 信用）: 比率ゲージ + ドーナツ + 数値 -->
<section class="glass breakdown">
  <div class="strip-title">内訳（現物 / 信用）</div>

  <!-- ① 横バー比率ゲージ -->
  <div class="bd-gauge" role="img" aria-label="現物と信用の比率">
    <div class="bd-gauge-spot"   style="width: {{ breakdown_pct.spot_pct }}%"></div>
    <div class="bd-gauge-margin" style="width: {{ breakdown_pct.margin_pct }}%"></div>
  </div>
  <div class="bd-legend">
    <span><i class="dot spot"></i>現物 {{ breakdown_pct.spot_pct }}%</span>
    <span><i class="dot margin"></i>信用 {{ breakdown_pct.margin_pct }}%</span>
  </div>

  <!-- ② ドーナツ -->
  <div class="bd-donut-wrap">
    <div class="bd-donut"
         style="--spot: {{ breakdown_pct.spot_pct }}; --margin: {{ breakdown_pct.margin_pct }};"
         aria-label="現物と信用のドーナツ構成"
         role="img">
      <div class="bd-donut-hole">
        <div class="bd-donut-total">¥{{ kpis.total_assets|intcomma }}</div>
        <div class="bd-donut-caption">総資産（評価＋現金）</div>
      </div>
    </div>
    <ul class="bd-legend-rows">
      <li>
        <span class="dot spot"></span>
        <span>現物 評価額</span>
        <strong>¥{{ breakdown.spot_mv|intcomma }}</strong>
      </li>
      <li class="sub">
        <span></span><span>取得額</span>
        <span>¥{{ breakdown.spot_cost|intcomma }}</span>
      </li>
      <li>
        <span class="dot margin"></span>
        <span>信用 評価額</span>
        <strong>¥{{ breakdown.margin_mv|intcomma }}</strong>
      </li>
      <li class="sub">
        <span></span><span>取得額</span>
        <span>¥{{ breakdown.margin_cost|intcomma }}</span>
      </li>
    </ul>
  </div>
</section>

<!-- 📈 セクター横スク -->
<section class="sector-strip glass">
  <div class="strip-title">セクター別パフォーマンス</div>
  <div class="strip-scroll">
    {% for s in sectors %}
      <div class="sector-chip">
        <div class="sec-name">{{ s.sector }}</div>
        <div class="sec-meta">
          <span class="mv">¥{{ s.mv|intcomma }}</span>
          <span class="rate {% if s.rate >= 0 %}pos{% else %}neg{% endif %}">{{ s.rate }}%</span>
        </div>
      </div>
    {% empty %}
      <div class="empty">データがありません</div>
    {% endfor %}
  </div>
</section>

<!-- 💰 今月のキャッシュフロー（棒グラフ） -->
<section class="cash glass">
  <div class="cash-head">今月のキャッシュフロー</div>
  <canvas id="cashflowChart" height="140"></canvas>
</section>

<!-- 🧪 ストレステスト（復活） -->
<section class="stress glass">
  <div class="stress-head">
    <div>ストレステスト（日経変動を仮定）</div>
    <div class="stress-result"><span id="stressPct">-5</span>% → 推定資産 <strong id="stressMV">¥0</strong></div>
  </div>
  <input type="range" min="-10" max="10" value="-5" step="1" id="stressSlider" />
</section>

<!-- ✅ 次のアクション（復活） -->
<section class="todo glass">
  <div class="todo-head">次のアクション</div>
  <ul class="todo-list" id="todoList">
    {% for a in ai_actions %}
      <li>✅ {{ a }}</li>
    {% empty %}
      <li class="muted">提案はありません</li>
    {% endfor %}
  </ul>
</section>

<!-- データ供給（JS用） -->
<script id="home-data" type="application/json">
{
  "total_mv": {{ kpis.total_assets|default:0 }},
  "cash_bars": {{ cash_bars|safe }},
  "liquidation": {{ kpis.liquidation|default:0 }},
  "liquidity_rate_pct": {{ kpis.liquidity_rate_pct|default:0 }},
  "stress_base_mv": {{ kpis.total_assets|default:0 }}
}
</script>

{% endblock %}