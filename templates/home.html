{% extends "base.html" %}
{% load static humanize %}

{% block title %}ãƒ›ãƒ¼ãƒ  | Myæ ªãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token }}">
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=20">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="{% static 'js/home.js' %}?v=21"></script>
{% endblock %}

{% block content %}

<!-- ğŸ§  AIã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ -->
<section class="ai-header glass">
  <div class="ai-title">AIã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</div>

  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼è¦ç´„ï¼ˆè‡ªç„¶æ–‡ï¼‰ -->
  <p class="ai-note">{{ ai_note }}</p>

  <!-- ææ¡ˆãƒªã‚¹ãƒˆï¼ˆãƒã‚§ãƒƒã‚¯ã§æ¡ç”¨/éæ¡ç”¨ã‚’ãƒˆã‚°ãƒ«ï¼‰ -->
  <ul class="ai-actions" id="aiAdviceList" data-session="{{ ai_session_id }}">
    {% for it in ai_items %}
      <li class="ai-item" data-id="{{ it.id|default:0 }}" data-taken="{{ it.taken|yesno:'1,0' }}">
        <button type="button" class="ai-check" aria-pressed="{{ it.taken|yesno:'true,false' }}">
          {% if it.taken %}âœ…{% else %}â˜‘ï¸{% endif %}
        </button>
        <span class="ai-msg">{{ it.message }}</span>
        {% if it.score %}
          <span class="ai-score">å„ªå…ˆåº¦ {{ it.score|floatformat:2 }}</span>
        {% endif %}
      </li>
    {% empty %}
      <li>â€¢ åˆ†æä¸­ã§ã™ã€‚</li>
    {% endfor %}
  </ul>

  <div class="ai-tools">
    <button class="btn ghost" id="btn-ai-weekly" type="button">é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</button>
    <button class="btn ghost" id="btn-ai-rebalance" type="button">æ¬¡ã®ä¸€æ‰‹</button>
  </div>
</section>

<!-- ğŸ“Š KPI -->
<section class="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-label">ç·è³‡ç”£</div>
    <div class="kpi-value">Â¥{{ kpis.total_assets|intcomma }}</div>
  </div>

  <div class="kpi-card">
    <div class="kpi-label">å«ã¿æç›Š</div>
    {% with v=kpis.unrealized_pnl %}
      <div class="kpi-value {% if v > 0 %}pos{% elif v < 0 %}neg{% endif %}">Â¥{{ v|intcomma }}</div>
    {% endwith %}
  </div>

  <div class="kpi-card">
    <div class="kpi-label">ç·å®Ÿç¾æç›Š</div>
    {% with v=kpis.realized_cum %}
      <div class="kpi-value {% if v > 0 %}pos{% elif v < 0 %}neg{% endif %}">Â¥{{ v|intcomma }}</div>
    {% endwith %}
  </div>

  <div class="kpi-card">
    <div class="kpi-label">ä»Šæœˆã®å®Ÿç¾æç›Š</div>
    {% with v=kpis.realized_month %}
      <div class="kpi-value {% if v > 0 %}pos{% elif v < 0 %}neg{% endif %}">Â¥{{ v|intcomma }}</div>
    {% endwith %}
  </div>

  <!-- ğŸŸ¢/ğŸ”µ 2æ®µå¼ ROI -->
  <div class="kpi-card roi-card">
    <div class="roi-row eval">
      <div class="roi-label">ROIï¼ˆè©•ä¾¡ãƒ™ãƒ¼ã‚¹ï¼‰</div>
      <div class="roi-value {% if kpis.roi_eval_pct > 0 %}pos{% elif kpis.roi_eval_pct < 0 %}neg{% endif %}">
        {% if kpis.roi_eval_pct != None %}{{ kpis.roi_eval_pct|floatformat:2 }}%{% else %}--{% endif %}
      </div>
    </div>
    <div class="roi-row liquid">
      <div class="roi-label">ROIï¼ˆç¾é‡‘åŒ–ãƒ™ãƒ¼ã‚¹ï¼‰</div>
      <div class="roi-value">
        {% if kpis.roi_liquid_pct != None %}{{ kpis.roi_liquid_pct|floatformat:2 }}%{% else %}--{% endif %}
      </div>
    </div>
    <div class="roi-foot">
      æŠ•ä¸‹è³‡é‡‘ Â¥{{ kpis.invested|intcomma }}
      {% if kpis.roi_gap_abs %}<span class="roi-gap">ä¹–é›¢ {{ kpis.roi_gap_abs|floatformat:1 }}pt</span>{% endif %}
    </div>
  </div>
</section>

<!-- ğŸ’µ ä»Šã™ãå…¨ã¦ç¾é‡‘åŒ–ã—ãŸã‚‰ï¼ˆãƒ’ãƒ¼ãƒ­ãƒ¼ï¼‹3ã‚µãƒãƒªãƒ¼ï¼‰ -->
<section class="liquidation glass">
  <div class="liq-head">
    <div class="title">ä»Šã™ãå…¨ã¦ç¾é‡‘åŒ–ã—ãŸã‚‰</div>
    <div class="chip">æµå‹•æ€§ {{ kpis.liquidity_rate_pct }}%</div>
  </div>

  <div class="liq-hero">
    <div class="liq-total">Â¥{{ kpis.liquidation|intcomma }}</div>
    <div class="kpi-sub">ç¨ãƒ»æ‰‹æ•°æ–™ã¯è€ƒæ…®ãªã—</div>
  </div>

  <div class="li-sum-grid">
    <div class="li-item">
      <div class="li-ic spot"></div>
      <div class="li-meta">
        <div class="li-label">ç¾ç‰©ã®è©•ä¾¡é¡</div>
        <div class="li-value">Â¥{{ breakdown.spot_mv|intcomma }}</div>
      </div>
    </div>
    <div class="li-item">
      <div class="li-ic margin"></div>
      <div class="li-meta">
        <div class="li-label">ä¿¡ç”¨ã®å«ã¿æç›Š</div>
        <div class="li-value {% if kpis.margin_unrealized < 0 %}neg{% else %}pos{% endif %}">
          Â¥{{ kpis.margin_unrealized|intcomma }}
        </div>
      </div>
    </div>
    <div class="li-item">
      <div class="li-ic cash"></div>
      <div class="li-meta">
        <div class="li-label">ç¾é‡‘æ®‹é«˜</div>
        <div class="li-value">Â¥{{ kpis.cash_total|intcomma }}</div>
      </div>
    </div>
  </div>

  {% if risk_flags and risk_flags|length > 0 %}
    <div class="warn-list">
      {% for m in risk_flags %}<div class="warn-item">âš ï¸ {{ m }}</div>{% endfor %}
    </div>
  {% endif %}
</section>

<!-- ğŸ§¾ å†…è¨³ï¼ˆç¾ç‰© / ä¿¡ç”¨ï¼‰ -->
<section class="glass breakdown">
  <div class="strip-title">å†…è¨³ï¼ˆç¾ç‰© / ä¿¡ç”¨ï¼‰</div>

  <div class="bd-gauge" role="img" aria-label="ç¾ç‰©ã¨ä¿¡ç”¨ã®æ¯”ç‡">
    <div class="bd-gauge-spot"   style="width: {{ breakdown_pct.spot_pct }}%"></div>
    <div class="bd-gauge-margin" style="width: {{ breakdown_pct.margin_pct }}%"></div>
  </div>
  <div class="bd-legend">
    <span><i class="dot spot"></i>ç¾ç‰© {{ breakdown_pct.spot_pct }}%</span>
    <span><i class="dot margin"></i>ä¿¡ç”¨ {{ breakdown_pct.margin_pct }}%</span>
  </div>

  <div class="bd-donut-wrap">
    <div class="bd-donut"
         style="--spot: {{ breakdown_pct.spot_pct }}; --margin: {{ breakdown_pct.margin_pct }};"
         role="img" aria-label="ç¾ç‰©ã¨ä¿¡ç”¨ã®ãƒ‰ãƒ¼ãƒŠãƒ„æ§‹æˆ">
      <div class="bd-donut-hole">
        <div class="bd-donut-total">Â¥{{ kpis.total_assets|intcomma }}</div>
        <div class="bd-donut-caption">ç·è³‡ç”£ï¼ˆè©•ä¾¡ï¼‹ç¾é‡‘ï¼‰</div>
      </div>
    </div>
    <ul class="bd-legend-rows">
      <li><span class="dot spot"></span><span>ç¾ç‰© è©•ä¾¡é¡</span><strong>Â¥{{ breakdown.spot_mv|intcomma }}</strong></li>
      <li class="sub"><span></span><span>å–å¾—é¡</span><span>Â¥{{ breakdown.spot_cost|intcomma }}</span></li>
      <li><span class="dot margin"></span><span>ä¿¡ç”¨ è©•ä¾¡é¡</span><strong>Â¥{{ breakdown.margin_mv|intcomma }}</strong></li>
      <li class="sub"><span></span><span>å–å¾—é¡</span><span>Â¥{{ breakdown.margin_cost|intcomma }}</span></li>
    </ul>
  </div>
</section>

<!-- ğŸ“ˆ ã‚»ã‚¯ã‚¿ãƒ¼æ¨ªã‚¹ã‚¯ -->
<section class="sector-strip glass">
  <div class="strip-title">ã‚»ã‚¯ã‚¿ãƒ¼åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</div>
  <div class="strip-scroll">
    {% for s in sectors %}
      <div class="sector-chip">
        <div class="sec-name">{{ s.sector }}</div>
        <div class="sec-meta">
          <span class="mv">Â¥{{ s.mv|intcomma }}</span>
          <span class="rate {% if s.rate > 0 %}pos{% elif s.rate < 0 %}neg{% endif %}">{{ s.rate }}%</span>
        </div>
      </div>
    {% empty %}
      <div class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
    {% endfor %}
  </div>
</section>

<!-- ğŸ§ª ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ -->
<section class="stress glass">
  <div class="stress-head">
    <div>ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆæ ªå¼Î²=0.9ã€ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æŒ‡æ•°å¤‰å‹•ã‚’ä»®å®šï¼‰</div>
    <div class="stress-result"><span id="stressPct">-5</span>% â†’ æ¨å®šç·è³‡ç”£ <strong id="stressMV">Â¥{{ stressed_default|intcomma }}</strong></div>
  </div>
  <input type="range" min="-10" max="10" value="-5" step="1" id="stressSlider" />
</section>

<!-- ğŸ’° ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ -->
<section class="cash glass">
  <div class="cash-head">ä»Šæœˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼</div>
  <canvas id="cashflowChart" height="140"></canvas>
</section>

<!-- ãƒ‡ãƒ¼ã‚¿ä¾›çµ¦ï¼ˆJSç”¨ï¼‰ -->
<script id="home-data" type="application/json">
{
  "total_mv": {{ kpis.total_assets|default:0 }},
  "sectors": {{ sectors|safe }},
  "cash_bars": [
    {"label":"é…å½“","value": {{ kpis.dividend_month|default:0 }}},
    {"label":"å®Ÿç¾ç›Š","value": {{ kpis.realized_month|default:0 }}}
  ]
}
</script>
<script>
  window.weekly_draft = {{ weekly_draft|safe|escapejs }};
  window.nextmove_draft = {{ nextmove_draft|safe|escapejs }};
</script>

{% endblock %}