{% extends "base.html" %}
{% load static humanize %}

{% block title %}ホーム | My株ポートフォリオ{% endblock %}

{% block head %}
<meta name="csrf-token" content="{{ csrf_token }}">
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=28">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="{% static 'js/home.js' %}?v=28"></script>
{% endblock %}

{% block content %}

<section class="ai-header glass" data-ab-variant="{{ ab_variant|default:'A' }}">
  <div class="ai-title">AIアドバイザー（{{ ab_variant|default:'A' }}版）</div>
  <p class="ai-note">{{ ai_note }}</p>

  <ul class="ai-actions" id="aiAdviceList" data-session="{{ ai_session_id }}" data-ab-variant="{{ ab_variant|default:'A' }}">
    {% for it in ai_items %}
      {% with p=it.score|default:0 %}
      <li class="ai-item" data-id="{{ it.id|default:0 }}" data-taken="{{ it.taken|yesno:'1,0' }}" style="--prio:{{ p|floatformat:2 }}">
        <button type="button" class="ai-check" aria-pressed="{{ it.taken|yesno:'true,false' }}">
          {% if it.taken %}✅{% else %}☑️{% endif %}
        </button>
        <div class="ai-text">
          <div class="msg">{{ it.message }}</div>
          <div class="meta-row">
            <div class="bar" aria-hidden="true"><span></span></div>
            <span class="prio-badge">優先度 {{ p|floatformat:2 }}</span>
          </div>
        </div>
      </li>
      {% endwith %}
    {% empty %}
      <li class="ai-empty">• 分析中です。</li>
    {% endfor %}
  </ul>

  <div class="ai-tools">
    <button class="btn ghost" id="btn-ai-weekly" type="button">週次レポート</button>
    <button class="btn ghost" id="btn-ai-rebalance" type="button">次の一手</button>
  </div>

  {# ← 改善要因（AI推定）を表示：バックエンドで ctx に渡している想定 #}
  {% if ai_insights_bullets and ai_insights_bullets|length > 0 %}
    <div class="ai-insights">
      <div class="ins-title">{{ ai_insights_title }}</div>
      <ul class="ins-list">
        {% for t in ai_insights_bullets %}
          <li>{{ t }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
</section>

<!-- KPI -->
<section class="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-label">総資産</div>
    <div class="kpi-value">¥{{ kpis.total_assets|intcomma }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">含み損益</div>
    {% with v=kpis.unrealized_pnl %}
      <div class="kpi-value {% if v > 0 %}pos{% elif v < 0 %}neg{% endif %}">¥{{ v|intcomma }}</div>
    {% endwith %}
  </div>
  <div class="kpi-card">
    <div class="kpi-label">総実現損益</div>
    {% with v=kpis.realized_cum %}
      <div class="kpi-value {% if v > 0 %}pos{% elif v < 0 %}neg{% endif %}">¥{{ v|intcomma }}</div>
    {% endwith %}
  </div>
  <div class="kpi-card">
    <div class="kpi-label">今月の実現損益</div>
    {% with v=kpis.realized_month %}
      <div class="kpi-value {% if v > 0 %}pos{% elif v < 0 %}neg{% endif %}">¥{{ v|intcomma }}</div>
    {% endwith %}
  </div>

  <div class="kpi-card roi-card">
    <div class="roi-row eval">
      <div class="roi-label">ROI（評価ベース）</div>
      <div class="roi-value {% if kpis.roi_eval_pct > 0 %}pos{% elif kpis.roi_eval_pct < 0 %}neg{% endif %}">
        {% if kpis.roi_eval_pct != None %}{{ kpis.roi_eval_pct|floatformat:2 }}%{% else %}--{% endif %}
      </div>
    </div>
    <div class="roi-row liquid">
      <div class="roi-label">ROI（現金化ベース）</div>
      <div class="roi-value">{% if kpis.roi_liquid_pct != None %}{{ kpis.roi_liquid_pct|floatformat:2 }}%{% else %}--{% endif %}</div>
    </div>
    <div class="roi-foot">
      投下資金 ¥{{ kpis.invested|intcomma }}
      {% if kpis.roi_gap_abs %}<span class="roi-gap">乖離 {{ kpis.roi_gap_abs|floatformat:1 }}pt</span>{% endif %}
    </div>
  </div>
</section>

<!-- 現金化シミュレーション -->
<section class="liquidation glass">
  <div class="liq-head">
    <div class="title">今すぐ全て現金化したら</div>
    <div class="chip">流動性 {{ kpis.liquidity_rate_pct }}%</div>
  </div>

  <div class="liq-hero">
    <div class="liq-total">¥{{ kpis.liquidation|intcomma }}</div>
    <div class="kpi-sub">税・手数料は考慮なし</div>
  </div>

  <div class="li-sum-grid">
    <div class="li-item">
      <div class="li-ic spot"></div>
      <div class="li-meta">
        <div class="li-label">現物 評価額</div>
        <div class="li-value">¥{{ breakdown.spot_mv|intcomma }}</div>
      </div>
    </div>
    <div class="li-item">
      <div class="li-ic margin"></div>
      <div class="li-meta">
        <div class="li-label">信用 含み損益</div>
        <div class="li-value {% if kpis.margin_unrealized < 0 %}neg{% else %}pos{% endif %}">¥{{ kpis.margin_unrealized|intcomma }}</div>
      </div>
    </div>
    <div class="li-item">
      <div class="li-ic cash"></div>
      <div class="li-meta">
        <div class="li-label">現金残高</div>
        <div class="li-value">¥{{ kpis.cash_total|intcomma }}</div>
      </div>
    </div>
  </div>

  {% if risk_flags and risk_flags|length > 0 %}
    <div class="warn-list">
      {% for m in risk_flags %}<div class="warn-item">⚠️ {{ m }}</div>{% endfor %}
    </div>
  {% endif %}
</section>

<!-- 現物/信用 内訳 -->
<section class="glass breakdown">
  <div class="strip-title">内訳（現物 / 信用）</div>

  <div class="bd-gauge" role="img" aria-label="現物と信用の比率">
    <div class="bd-gauge-spot"   style="width: {{ breakdown_pct.spot_pct }}%"></div>
    <div class="bd-gauge-margin" style="width: {{ breakdown_pct.margin_pct }}%"></div>
  </div>
  <div class="bd-legend">
    <span><i class="dot spot"></i>現物 {{ breakdown_pct.spot_pct }}%</span>
    <span><i class="dot margin"></i>信用 {{ breakdown_pct.margin_pct }}%</span>
  </div>

  <div class="bd-donut-wrap">
    <div class="bd-donut"
         style="--spot: {{ breakdown_pct.spot_pct }}; --margin: {{ breakdown_pct.margin_pct }};"
         role="img" aria-label="現物と信用のドーナツ構成">
      <div class="bd-donut-hole">
        <div class="bd-donut-total">¥{{ kpis.total_assets|intcomma }}</div>
        <div class="bd-donut-caption">総資産（評価＋現金）</div>
      </div>
    </div>
    <ul class="bd-legend-rows">
      <li><span class="dot spot"></span><span>現物 評価額</span><strong>¥{{ breakdown.spot_mv|intcomma }}</strong></li>
      <li class="sub"><span></span><span>取得額</span><span>¥{{ breakdown.spot_cost|intcomma }}</span></li>
      <li><span class="dot margin"></span><span>信用 評価額</span><strong>¥{{ breakdown.margin_mv|intcomma }}</strong></li>
      <li class="sub"><span></span><span>取得額</span><span>¥{{ breakdown.margin_cost|intcomma }}</span></li>
    </ul>
  </div>
</section>

<!-- セクター配分 -->
<section class="sector-strip glass">
  <div class="strip-title">セクター別構成</div>
  <div class="strip-scroll">
    {% for s in sectors %}
      <div class="sector-chip">
        <div class="sec-name">{{ s.sector|default:"不明" }}</div>
        <div class="sec-meta">
          <span class="mv">¥{{ s.mv|default:0|intcomma }}</span>
          <span class="share">{{ s.share_pct|default:0 }}%</span>
        </div>
        <div class="sec-sub">
          参考: 騰落
          {% if s.perf_pct != None %}
            <strong class="{% if s.perf_pct > 0 %}pos{% elif s.perf_pct < 0 %}neg{% endif %}">
              {{ s.perf_pct|floatformat:2 }}%
            </strong>
          {% else %}
            <span class="muted">—</span>
          {% endif %}
        </div>
      </div>
    {% empty %}
      <div class="empty">データがありません</div>
    {% endfor %}
  </div>
</section>

<!-- ストレステスト -->
<section class="stress glass" id="stressRoot" data-total-mv="{{ kpis.total_assets|default:0 }}">
  <div class="stress-head">
    <div>ストレステスト（株式β=0.9）</div>
    <div class="stress-result"><span id="stressPct">-5</span>% → 推定総資産 <strong id="stressMV">¥0</strong></div>
  </div>
  <input type="range" min="-10" max="10" value="-5" step="1" id="stressSlider" />
</section>

<!-- キャッシュフロー（JSで空時はメッセージ） -->
<section class="cash glass" id="cashRoot"
         data-dividend="{{ kpis.dividend_month|default:0 }}"
         data-realized="{{ kpis.realized_month|default:0 }}">
  <div class="cash-head">今月のキャッシュフロー</div>
  <canvas id="cashflowChart" height="140"></canvas>
  <div class="empty-msg" style="display:none;opacity:.7">今月のデータがありません</div>
</section>

<script>
  window.weekly_draft = {{ weekly_draft|safe|escapejs }};
  window.nextmove_draft = {{ nextmove_draft|safe|escapejs }};
</script>

{% endblock %}