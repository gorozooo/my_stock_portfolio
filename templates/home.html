{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="home-shell">
  <!-- Top: date pill + ticker -->
  <div class="home-top">
    <div class="pill pill-date">
      <div class="pill-cap">æœ¬æ—¥</div>
      <div class="pill-main">{{ today_label }}</div>
    </div>

    <div class="pill pill-ticker" id="newsTicker">
      <div class="ticker-icon">ğŸ“°</div>
      <div class="ticker-track">
        <div class="ticker-text" id="tickerText">
          {% for d in decks %}
            {% if d.key == "news_trends" %}
              {% if d.payload.items %}
                NEWS:
                {% for it in d.payload.items|slice:":6" %}
                  {{ it.source }}ã€Œ{{ it.title }}ã€ /
                {% endfor %}
              {% else %}
                NEWS: æº–å‚™ä¸­
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Deck rail -->
  <div class="rail" id="rail">
    {% for d in decks %}
      <section class="deck" data-key="{{ d.key }}">
        <div class="deck-card">

          <div class="deck-head">
            <div class="deck-title">{{ d.title }}</div>
            {% if d.payload.as_of %}
              <div class="deck-sub">æ›´æ–°: {{ d.payload.as_of }}</div>
            {% endif %}
          </div>

          <!-- ASSETS -->
          {% if d.key == "assets" %}
            {% with a=d.payload %}
              <div class="grid2">
                <div class="kpi">
                  <div class="kpi-label">å®Ÿç¾æç›Š YTD</div>
                  <div class="kpi-val {% if a.realized.ytd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.ytd.total|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.ytd.count }}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">ä»Šæœˆ MTD</div>
                  <div class="kpi-val {% if a.realized.mtd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.mtd.total|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.mtd.count }}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">ä»Šé€± WTD</div>
                  <div class="kpi-val {% if a.realized.wtd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.wtd.total|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.wtd.count }}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">å¹´é–“ç›®æ¨™ï¼ˆå…¨ä½“ï¼‰</div>
                  <div class="kpi-val">
                    Â¥{{ a.goals.year_total|intcomma }}
                  </div>
                  <div class="kpi-sub">æ®‹ã‚Šæœˆ{{ a.pace.remaining_months_including_current }} / æ®‹ã‚Šé€±{{ a.pace.remaining_weeks_including_current }}</div>
                </div>
              </div>

              <div class="sec">
                <div class="sec-title">å¿…è¦ãƒšãƒ¼ã‚¹ï¼ˆã“ã‚Œã‹ã‚‰ï¼‰</div>
                <div class="grid2">
                  <div class="kpi">
                    <div class="kpi-label">æœˆ</div>
                    <div class="kpi-val {% if a.pace.total_need_per_month.need_per_slot >= 0 %}pos{% else %}neg{% endif %}">
                      Â¥{{ a.pace.total_need_per_month.need_per_slot|floatformat:0|intcomma }}
                    </div>
                    <div class="kpi-sub">æ®‹ã‚Š Â¥{{ a.pace.total_need_per_month.remaining|floatformat:0|intcomma }}</div>
                  </div>
                  <div class="kpi">
                    <div class="kpi-label">é€±</div>
                    <div class="kpi-val {% if a.pace.total_need_per_week.need_per_slot >= 0 %}pos{% else %}neg{% endif %}">
                      Â¥{{ a.pace.total_need_per_week.need_per_slot|floatformat:0|intcomma }}
                    </div>
                    <div class="kpi-sub">æ®‹ã‚Š Â¥{{ a.pace.total_need_per_week.remaining|floatformat:0|intcomma }}</div>
                  </div>
                </div>
              </div>

              <div class="sec">
                <div class="sec-title">è¨¼åˆ¸ä¼šç¤¾åˆ¥ï¼ˆYTD / ç›®æ¨™ / å¿…è¦ãƒšãƒ¼ã‚¹ï¼‰</div>
                <div class="table">
                  <div class="tr th">
                    <div>è¨¼åˆ¸ä¼šç¤¾</div>
                    <div class="r">YTD</div>
                    <div class="r">ç›®æ¨™</div>
                    <div class="r">æœˆãƒšãƒ¼ã‚¹</div>
                  </div>
                  {% for r in a.pace.by_broker_rows %}
                    <div class="tr">
                      <div class="bname">{{ r.label }}</div>
                      <div class="r {% if r.ytd >= 0 %}pos{% else %}neg{% endif %}">
                        {{ r.ytd|floatformat:0|intcomma }}
                      </div>
                      <div class="r">{{ r.goal_year|intcomma }}</div>
                      <div class="r {% if r.pace_month.need_per_slot >= 0 %}pos{% else %}neg{% endif %}">
                        {{ r.pace_month.need_per_slot|floatformat:0|intcomma }}
                      </div>
                    </div>
                  {% endfor %}
                </div>
                <div class="hint">ï¼ˆä¾‹ï¼‰YTD / å¹´ç›®æ¨™ / æœˆãƒšãƒ¼ã‚¹</div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- NEWS & TRENDS -->
          {% if d.key == "news_trends" %}
            {% with n=d.payload %}
              <div class="sec">
                <div class="sec-title">æ³¨ç›®ã‚»ã‚¯ã‚¿ãƒ¼ï¼ˆã–ã£ãã‚Šï¼‰</div>
                <div class="chips">
                  {% for s in n.sectors %}
                    <div class="chip">{{ s.sector }} Ã—{{ s.count }}</div>
                  {% empty %}
                    <div class="chip">ãã®ä»– Ã—0</div>
                  {% endfor %}
                </div>
                <div class="deck-sub" style="margin-top:10px;">æ›´æ–°: {{ n.as_of }}</div>
              </div>

              <div class="sec">
                <div class="sec-title">ãƒ‹ãƒ¥ãƒ¼ã‚¹</div>
                <div class="list">
                  {% for it in n.items|slice:":10" %}
                    <a class="li" href="{{ it.link }}" target="_blank" rel="noopener">
                      <div class="badge">{{ it.source }}</div>
                      <div class="li-title">{{ it.title }}</div>
                      <div class="li-sub">
                        <span class="host">{{ it.host }}</span>
                      </div>
                    </a>
                  {% empty %}
                    <div class="empty">ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ä¸­â€¦</div>
                  {% endfor %}
                </div>
              </div>

              <div class="sec">
                <div class="sec-title">ãƒãƒƒãƒˆ/ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆä»£æ›¿ï¼‰</div>
                <div class="list">
                  {% for it in n.trends|slice:":10" %}
                    <a class="li" href="{{ it.link }}" target="_blank" rel="noopener">
                      <div class="badge">Trends</div>
                      <div class="li-title">{{ it.title }}</div>
                      <div class="li-sub">
                        <span class="host">{{ it.host }}</span>
                      </div>
                    </a>
                  {% empty %}
                    <div class="empty">ãƒˆãƒ¬ãƒ³ãƒ‰å–å¾—ä¸­â€¦</div>
                  {% endfor %}
                </div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- STUB decks -->
          {% if d.key != "assets" and d.key != "news_trends" %}
            <div class="stub">
              <div class="stub-title">ï¼ˆæº–å‚™ä¸­ï¼‰</div>
              <div class="stub-sub">ã“ã“ã¯å¾Œã§ aiapp ã®çŸ¥èƒ½ãƒ»ãƒãƒªã‚·ãƒ¼ãƒ»ãƒ¬ã‚¸ãƒ¼ãƒ ç­‰ã¨åˆä½“ã—ã¦â€œè‡ªåˆ†ã§è€ƒãˆã¦ç™ºè¨€ã™ã‚‹AIâ€ã«é€²åŒ–ã•ã›ã‚‹</div>
            </div>
          {% endif %}

        </div>
      </section>
    {% endfor %}
  </div>

  <!-- dots -->
  <div class="dots" id="dots"></div>
</div>

<script>
(function(){
  const rail = document.getElementById("rail");
  const decks = Array.from(rail.querySelectorAll(".deck"));
  const dots = document.getElementById("dots");
  if (!rail || decks.length === 0 || !dots) return;

  dots.innerHTML = decks.map((_,i)=>`<span class="dot ${i===0?'on':''}" data-i="${i}"></span>`).join("");
  const dotEls = Array.from(dots.querySelectorAll(".dot"));

  const setOn = (idx) => {
    dotEls.forEach((d,i)=>d.classList.toggle("on", i===idx));
  };

  const onScroll = () => {
    const x = rail.scrollLeft;
    const w = rail.clientWidth || 1;
    const idx = Math.round(x / w);
    setOn(Math.max(0, Math.min(decks.length-1, idx)));
  };

  rail.addEventListener("scroll", () => {
    window.requestAnimationFrame(onScroll);
  });

  dotEls.forEach(el=>{
    el.addEventListener("click", ()=>{
      const i = parseInt(el.getAttribute("data-i") || "0", 10);
      rail.scrollTo({ left: i * rail.clientWidth, behavior: "smooth" });
    });
  });
})();
</script>

<style>
/* ===== iPhoneå°‚ç”¨: è¦‹åˆ‡ã‚Œã‚¼ãƒ­ ===== */
*{ box-sizing:border-box; }
:root{
  --bg:#020617;
  --card:rgba(15,23,42,.92);
  --card2:rgba(15,23,42,.72);
  --fg:#e5edff;
  --sub:rgba(229,237,255,.72);
  --muted:rgba(148,163,184,.75);
  --line:rgba(148,163,184,.22);

  --pos:#22c55e;
  --neg:#ef4444;
  --accent:#60a5fa;
}
body{ background:var(--bg); color:var(--fg); }

.home-shell{
  width:100%;
  max-width:430px;  /* iPhoneä¸Šé™ */
  margin:0 auto;
  padding:10px 10px 90px;
}

/* top */
.home-top{
  display:flex;
  gap:10px;
  align-items:stretch;
  margin-bottom:10px;
}
.pill{
  border:1px solid var(--line);
  background:rgba(2,6,23,.35);
  backdrop-filter: blur(14px);
  -webkit-backdrop-filter: blur(14px);
  border-radius:16px;
  padding:10px 12px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
.pill-date{ flex:0 0 auto; min-width:150px; }
.pill-cap{ font-size:12px; color:var(--muted); line-height:1; }
.pill-main{ font-size:16px; font-weight:700; margin-top:6px; }

.pill-ticker{
  flex:1 1 auto;
  display:flex;
  align-items:center;
  gap:10px;
  overflow:hidden;
}
.ticker-icon{ font-size:16px; opacity:.9; }
.ticker-track{
  position:relative;
  overflow:hidden;
  width:100%;
  height:20px;
}
.ticker-text{
  display:inline-block;
  white-space:nowrap;
  will-change:transform;
  animation: marquee 22s linear infinite;
  color:rgba(229,237,255,.85);
  font-size:13px;
}
@keyframes marquee{
  0%{ transform:translateX(100%); }
  100%{ transform:translateX(-120%); }
}

/* rail */
.rail{
  display:flex;
  width:100%;
  overflow-x:auto;
  scroll-snap-type:x mandatory;
  -webkit-overflow-scrolling:touch;
  gap:12px;
  padding:0;       /* ä½™ç™½ã§ã‚ºãƒ¬ãªã„ */
  margin:0;        /* ä½™ç™½ã§ã‚ºãƒ¬ãªã„ */
}
.rail::-webkit-scrollbar{ display:none; }

.deck{
  flex:0 0 100%;
  width:100%;
  scroll-snap-align:start;
}

.deck-card{
  border:1px solid var(--line);
  border-radius:18px;
  background:linear-gradient(180deg, rgba(96,165,250,.12), rgba(0,0,0,0) 40%), var(--card);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  box-shadow:0 14px 40px rgba(0,0,0,.35);
  padding:14px;
}

.deck-head{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  padding-bottom:10px;
  border-bottom:1px solid rgba(148,163,184,.18);
  margin-bottom:10px;
}
.deck-title{
  letter-spacing:.12em;
  font-weight:800;
  font-size:14px;
}
.deck-sub{
  font-size:12px;
  color:var(--muted);
}

/* assets blocks */
.grid2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.kpi{
  border:1px solid rgba(148,163,184,.18);
  background:rgba(2,6,23,.25);
  border-radius:14px;
  padding:12px;
  min-height:86px;
}
.kpi-label{ font-size:12px; color:var(--muted); }
.kpi-val{
  margin-top:8px;
  font-size:20px;
  font-weight:900;
  letter-spacing:.02em;
}
.kpi-sub{ margin-top:6px; font-size:12px; color:rgba(229,237,255,.62); }

.pos{ color:var(--pos); }
.neg{ color:var(--neg); }

.sec{ margin-top:14px; }
.sec-title{
  font-size:13px;
  color:rgba(229,237,255,.85);
  margin:0 0 10px;
  font-weight:800;
}

/* table */
.table{
  border:1px solid rgba(148,163,184,.18);
  border-radius:14px;
  overflow:hidden;
}
.tr{
  display:grid;
  grid-template-columns: 1.1fr 1fr .8fr 1fr;
  gap:10px;
  padding:10px 12px;
  align-items:center;
  background:rgba(2,6,23,.22);
  border-top:1px solid rgba(148,163,184,.12);
}
.tr.th{
  background:rgba(2,6,23,.36);
  border-top:none;
  color:rgba(229,237,255,.75);
  font-size:12px;
  font-weight:800;
}
.r{ text-align:right; font-variant-numeric: tabular-nums; }
.bname{ font-weight:800; }
.hint{ margin-top:8px; color:rgba(229,237,255,.55); font-size:12px; }

/* chips/list */
.chips{ display:flex; flex-wrap:wrap; gap:8px; }
.chip{
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.18);
  background:rgba(2,6,23,.25);
  font-size:12px;
  color:rgba(229,237,255,.85);
}
.list{ display:flex; flex-direction:column; gap:10px; }
.li{
  display:block;
  text-decoration:none;
  border:1px solid rgba(148,163,184,.18);
  background:rgba(2,6,23,.25);
  border-radius:14px;
  padding:12px;
}
.badge{
  display:inline-block;
  font-size:12px;
  font-weight:800;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(96,165,250,.22);
  border:1px solid rgba(96,165,250,.35);
  color:rgba(229,237,255,.92);
}
.li-title{
  margin-top:10px;
  font-size:14px;
  font-weight:800;
  color:rgba(229,237,255,.92);
  line-height:1.35;
}
.li-sub{
  margin-top:8px;
  font-size:12px;
  color:rgba(229,237,255,.55);
}
.host{ opacity:.95; }

.empty{
  padding:14px;
  color:rgba(229,237,255,.6);
  font-size:13px;
  border:1px dashed rgba(148,163,184,.22);
  border-radius:14px;
}

/* stub */
.stub{
  padding:16px;
  border:1px dashed rgba(148,163,184,.25);
  border-radius:14px;
  background:rgba(2,6,23,.20);
}
.stub-title{ font-weight:900; }
.stub-sub{ margin-top:10px; font-size:13px; color:rgba(229,237,255,.65); line-height:1.5; }

/* dots */
.dots{
  margin-top:10px;
  display:flex;
  justify-content:center;
  gap:6px;
}
.dot{
  width:7px; height:7px;
  border-radius:999px;
  background:rgba(148,163,184,.35);
}
.dot.on{ background:rgba(96,165,250,.95); }
</style>
{% endblock %}