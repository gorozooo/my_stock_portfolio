{# templates/home.html #}
{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% block title %}Home{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=110">

<div class="home-shell">
  <!-- Top: ticker -->
  <div class="home-top">
    <div class="pill pill-ticker" id="newsTicker">
      <div class="ticker-icon">ğŸ“°</div>
      <div class="ticker-track">
        <div class="ticker-text" id="tickerText">
          {% for d in decks %}
            {% if d.key == "news_trends" %}
              {% if d.payload.items %}
                NEWS:
                {% for it in d.payload.items|slice:":6" %}
                  {{ it.source }}ã€Œ{{ it.title }}ã€ /
                {% endfor %}
              {% else %}
                NEWS: æº–å‚™ä¸­
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Deck rail -->
  <div class="rail" id="rail">
    {% for d in decks %}
      <section class="deck" data-key="{{ d.key }}">
        <div class="deck-card">

          <div class="deck-head">
            <div class="deck-title">{{ d.title }}</div>
            {% if d.payload.as_of %}
              <div class="deck-sub">
                æ›´æ–°:
                <span class="js-asof" data-iso="{{ d.payload.as_of }}">{{ d.payload.as_of }}</span>
              </div>
            {% endif %}
          </div>

          <!-- =========================
               ASSETS
               ========================= -->
          {% if d.key == "assets" %}
            {% with a=d.payload %}
              <div class="grid2">
                <div class="kpi">
                  <div class="kpi-label">å®Ÿç¾æç›Š YTD</div>
                  <div class="kpi-val {% if a.realized.ytd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.ytd.total|default:0|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.ytd.count|default:0 }}</div>
                </div>

                <div class="kpi">
                  <div class="kpi-label">ä»Šæœˆ MTD</div>
                  <div class="kpi-val {% if a.realized.mtd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.mtd.total|default:0|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.mtd.count|default:0 }}</div>
                </div>

                <div class="kpi">
                  <div class="kpi-label">ä»Šé€± WTD</div>
                  <div class="kpi-val {% if a.realized.wtd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.wtd.total|default:0|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.wtd.count|default:0 }}</div>
                </div>

                <div class="kpi">
                  <div class="kpi-label">å¹´é–“ç›®æ¨™ï¼ˆå…¨ä½“ï¼‰</div>
                  <div class="kpi-val">
                    Â¥{{ a.goals.year_total|default:0|intcomma }}
                  </div>

                  <div class="kpi-sub">
                    æ®‹ã‚Šæœˆ{{ a.pace.remaining_months_including_current|default:"â€”" }} / æ®‹ã‚Šé€±{{ a.pace.remaining_weeks_including_current|default:"â€”" }}
                    <br>
                    å‰å¹´ï¼ˆå¹´åˆè¨ˆï¼‰
                    {% if a.realized.prev_year_total is not None %}
                      Â¥{{ a.realized.prev_year_total|floatformat:0|intcomma }}
                    {% else %}
                      â€”
                    {% endif %}
                    <br>
                    å‰å¹´æ¯”
                    {% if a.realized.ytd_yoy_pct is not None %}
                      <span class="{% if a.realized.ytd_yoy_pct >= 0 %}pos{% else %}neg{% endif %}">
                        {{ a.realized.ytd_yoy_pct|floatformat:1 }}%
                      </span>
                    {% else %}
                      â€”
                    {% endif %}
                    <br>
                    å‰å¹´åŒæœˆæ¯”
                    {% if a.realized.mtd_yoy_pct is not None %}
                      <span class="{% if a.realized.mtd_yoy_pct >= 0 %}pos{% else %}neg{% endif %}">
                        {{ a.realized.mtd_yoy_pct|floatformat:1 }}%
                      </span>
                    {% else %}
                      â€”
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="sec">
                <div class="sec-title">å¿…è¦ãƒšãƒ¼ã‚¹ï¼ˆã“ã‚Œã‹ã‚‰ï¼‰</div>
                <div class="grid2">
                  <div class="kpi">
                    <div class="kpi-label">æœˆãƒšãƒ¼ã‚¹</div>
                    <div class="kpi-val {% if a.pace.total_need_per_month.need_per_slot > 0 %}warn{% else %}pos{% endif %}">
                      Â¥{{ a.pace.total_need_per_month.need_per_slot|default:0|floatformat:0|intcomma }}
                    </div>
                    <div class="kpi-sub">
                      æ®‹ã‚Š
                      <span class="{% if a.pace.total_need_per_month.remaining > 0 %}warn{% else %}pos{% endif %}">
                        Â¥{{ a.pace.total_need_per_month.remaining|default:0|floatformat:0|intcomma }}
                      </span>
                    </div>
                  </div>

                  <div class="kpi">
                    <div class="kpi-label">é€±ãƒšãƒ¼ã‚¹</div>
                    <div class="kpi-val {% if a.pace.total_need_per_week.need_per_slot > 0 %}warn{% else %}pos{% endif %}">
                      Â¥{{ a.pace.total_need_per_week.need_per_slot|default:0|floatformat:0|intcomma }}
                    </div>
                    <div class="kpi-sub">
                      æ®‹ã‚Š
                      <span class="{% if a.pace.total_need_per_week.remaining > 0 %}warn{% else %}pos{% endif %}">
                        Â¥{{ a.pace.total_need_per_week.remaining|default:0|floatformat:0|intcomma }}
                      </span>
                    </div>
                  </div>
                </div>
                <div class="hint">â€» æœªé”ï¼ˆæ®‹ã‚Š/å¿…è¦ãƒšãƒ¼ã‚¹ãŒãƒ—ãƒ©ã‚¹ï¼‰â†’é»„è‰²ã€‚é”æˆï¼ˆãƒã‚¤ãƒŠã‚¹/ã‚¼ãƒ­ï¼‰â†’ç·‘ã€‚</div>
              </div>

              <div class="sec">
                <div class="sec-title">è¨¼åˆ¸ä¼šç¤¾åˆ¥ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰</div>

                <div class="broker-cards">
                  {% for r in a.pace.by_broker_rows %}
                    <div class="bcard">
                      <div class="bcard-top">
                        <div class="bcard-name">{{ r.label }}</div>
                        <div class="bcard-ytd {% if r.ytd >= 0 %}pos{% else %}neg{% endif %}">
                          Â¥{{ r.ytd|default:0|floatformat:0|intcomma }}
                        </div>
                      </div>

                      <div class="brow">
                        <div class="lk">å¹´ç›®æ¨™</div>
                        <div class="lv">Â¥{{ r.goal_year|default:0|intcomma }}</div>
                      </div>

                      <div class="brow">
                        <div class="lk">æ®‹ã‚Šï¼ˆæœˆåŸºæº–ï¼‰</div>
                        <div class="lv {% if r.pace_month.remaining > 0 %}warn{% else %}pos{% endif %}">
                          Â¥{{ r.pace_month.remaining|default:0|floatformat:0|intcomma }}
                        </div>
                      </div>

                      <div class="brow">
                        <div class="lk">æœˆãƒšãƒ¼ã‚¹</div>
                        <div class="lv {% if r.pace_month.need_per_slot > 0 %}warn{% else %}pos{% endif %}">
                          Â¥{{ r.pace_month.need_per_slot|default:0|floatformat:0|intcomma }}
                        </div>
                      </div>

                      <div class="brow">
                        <div class="lk">å‰å¹´ï¼ˆå¹´åˆè¨ˆï¼‰</div>
                        <div class="lv">
                          {% if r.prev_year_total is not None %}
                            Â¥{{ r.prev_year_total|floatformat:0|intcomma }}
                          {% else %}
                            â€”
                          {% endif %}
                        </div>
                      </div>

                      <div class="brow">
                        <div class="lk">å‰å¹´æ¯”ï¼ˆYTD vs å‰å¹´å¹´åˆè¨ˆï¼‰</div>
                        <div class="lv">
                          {% if r.ytd_yoy_pct is not None %}
                            <span class="{% if r.ytd_yoy_pct >= 0 %}pos{% else %}neg{% endif %}">
                              {{ r.ytd_yoy_pct|floatformat:1 }}%
                            </span>
                          {% else %}
                            â€”
                          {% endif %}
                        </div>
                      </div>

                      <div class="brow">
                        <div class="lk">å‰å¹´åŒæœˆæ¯”ï¼ˆMTDï¼‰</div>
                        <div class="lv">
                          {% if r.mtd_yoy_pct is not None %}
                            <span class="{% if r.mtd_yoy_pct >= 0 %}pos{% else %}neg{% endif %}">
                              {{ r.mtd_yoy_pct|floatformat:1 }}%
                            </span>
                          {% else %}
                            â€”
                          {% endif %}
                        </div>
                      </div>

                    </div>
                  {% endfor %}
                </div>

                <div class="hint">æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ï¼šYTD / ç›®æ¨™ / æ®‹ã‚Š / æœˆãƒšãƒ¼ã‚¹ / å‰å¹´ / å‰å¹´æ¯” / å‰å¹´åŒæœˆæ¯”</div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- =========================
               AI BRIEFï¼ˆæœ€çµ‚ä»•æ§˜ï¼‰
               ========================= -->
          {% if d.key == "ai_brief" %}
            {% with b=d.payload %}
              <div class="brief">
                {% if b.summary %}
                  <div class="brief-headline">{{ b.summary }}</div>
                {% else %}
                  <div class="brief-headline">{{ b.headline|default:"ï¼ˆæº–å‚™ä¸­ï¼‰" }}</div>
                {% endif %}

                {% if b.reasons %}
                  <div class="sec" style="margin-top:10px;">
                    <div class="sec-title">æ ¹æ‹ </div>
                    <div class="brief-list">
                      {% for s in b.reasons|slice:":5" %}
                        <div class="brief-item">â€¢ {{ s }}</div>
                      {% endfor %}
                    </div>
                  </div>
                {% else %}
                  {% if b.bullets %}
                    <div class="brief-list">
                      {% for s in b.bullets %}
                        <div class="brief-item">â€¢ {{ s }}</div>
                      {% endfor %}
                    </div>
                  {% endif %}
                {% endif %}

                {% if b.concerns %}
                  <div class="sec" style="margin-top:12px;">
                    <div class="sec-title">æ‡¸å¿µ</div>
                    <div class="brief-list">
                      {% for s in b.concerns|slice:":2" %}
                        <div class="brief-item">â€¢ {{ s }}</div>
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}

                {% if b.escape %}
                  <div class="sec" style="margin-top:12px;">
                    <div class="sec-title">é€ƒã’é“</div>
                    <div class="market-summary">{{ b.escape }}</div>
                  </div>
                {% endif %}

                {% if b.reference_news %}
                  <div class="sec" style="margin-top:12px;">
                    <div class="sec-title">å‚è€ƒï¼ˆå¤–éƒ¨ï¼‰</div>
                    <a class="li" href="{{ b.reference_news.link }}" target="_blank" rel="noopener">
                      <div class="badge">{{ b.reference_news.source|default:"NEWS" }}</div>
                      <div class="li-title">{{ b.reference_news.title }}</div>
                      <div class="li-sub">
                        <span class="host">{{ b.reference_news.host }}</span>
                        {% if b.reference_news.hint %}
                          ãƒ»{{ b.reference_news.hint }}
                        {% endif %}
                      </div>
                    </a>
                  </div>
                {% endif %}

                <div class="hint">ç›®çš„ï¼šAIã®äººæ ¼ï¼ˆè¦ç´„â†’æ ¹æ‹ ï¼‰ã€‚æ ¹æ‹ ã¯ã‚¢ãƒ—ãƒªå†…ãƒ‡ãƒ¼ã‚¿ã®ã¿ã€‚å¤–éƒ¨ã¯å‚è€ƒæ ã«éš”é›¢ã€‚</div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- =========================
               NEWS & TRENDS
               ========================= -->
          {% if d.key == "news_trends" %}
            {% with n=d.payload %}
              <div class="sec">
                <div class="sec-title">æ³¨ç›®ã‚»ã‚¯ã‚¿ãƒ¼ï¼ˆã–ã£ãã‚Šï¼‰</div>
                <div class="chips">
                  {% for s in n.sectors %}
                    <div class="chip">{{ s.sector }} Ã—{{ s.count }}</div>
                  {% empty %}
                    <div class="chip">ãã®ä»– Ã—0</div>
                  {% endfor %}
                </div>
                {% if n.as_of %}
                  <div class="deck-sub" style="margin-top:10px;">
                    æ›´æ–°:
                    <span class="js-asof" data-iso="{{ n.as_of }}">{{ n.as_of }}</span>
                  </div>
                {% endif %}
              </div>

              <div class="sec">
                <div class="sec-title">ãƒ‹ãƒ¥ãƒ¼ã‚¹</div>
                <div class="list">
                  {% for it in n.items|slice:":10" %}
                    <a class="li" href="{{ it.link }}" target="_blank" rel="noopener">
                      <div class="badge">{{ it.source }}</div>
                      <div class="li-title">{{ it.title }}</div>
                      <div class="li-sub">
                        <span class="host">{{ it.host }}</span>
                      </div>
                    </a>
                  {% empty %}
                    <div class="empty">ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ä¸­â€¦</div>
                  {% endfor %}
                </div>
              </div>

              <div class="sec">
                <div class="sec-title">ãƒãƒƒãƒˆ/ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆä»£æ›¿ï¼‰</div>
                <div class="list">
                  {% for it in n.trends|slice:":10" %}
                    <a class="li" href="{{ it.link }}" target="_blank" rel="noopener">
                      <div class="badge">Trends</div>
                      <div class="li-title">{{ it.title }}</div>
                      <div class="li-sub">
                        <span class="host">{{ it.host }}</span>
                      </div>
                    </a>
                  {% empty %}
                    <div class="empty">ãƒˆãƒ¬ãƒ³ãƒ‰å–å¾—ä¸­â€¦</div>
                  {% endfor %}
                </div>
              </div>
            {% endwith %}
          {% endif %}

        </div>
      </section>
    {% endfor %}
  </div>

  <!-- dots -->
  <div class="dots" id="dots"></div>
</div>

<script src="{% static 'js/home.js' %}?v=103" defer></script>

<script>
(function(){
  // ISOæ–‡å­—åˆ—(UTCç­‰) â†’ JST(Asia/Tokyo)ã§ "YYYY-MM-DD HH:mm"ï¼ˆç§’ãªã—ï¼‰ã«ã—ã¦ç½®ãæ›ãˆã‚‹
  const fmtJST = (iso) => {
    try{
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      const parts = new Intl.DateTimeFormat("ja-JP", {
        timeZone: "Asia/Tokyo",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      }).formatToParts(d);

      const map = {};
      for (const p of parts) map[p.type] = p.value;

      const y = map.year || "";
      const m = map.month || "";
      const da = map.day || "";
      const h = map.hour || "";
      const mi = map.minute || "";
      if (!y || !m || !da || !h || !mi) return "";
      return `${y}-${m}-${da} ${h}:${mi}`;
    }catch(e){
      return "";
    }
  };

  const els = document.querySelectorAll(".js-asof[data-iso]");
  els.forEach(el => {
    const iso = (el.getAttribute("data-iso") || "").trim();
    const jst = fmtJST(iso);
    if (jst) el.textContent = jst;
  });
})();
</script>

{% endblock %}