{% extends "base.html" %}
{% load static humanize %}

{% block title %}ãƒ›ãƒ¼ãƒ  | Myæ ªãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=3">
<script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="{% static 'js/home.js' %}?v=3"></script>
{% endblock %}

{% block content %}

<!-- ğŸ§  AIãƒ˜ãƒƒãƒ€ãƒ¼ -->
<section class="ai-header glass">
  <div class="ai-title">AIã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼</div>
  <p class="ai-note">{{ ai_note }}</p>
  <ul class="ai-actions">
    {% for a in ai_actions %}<li>â€¢ {{ a }}</li>{% endfor %}
  </ul>
  <div class="ai-tools">
    <button class="btn ghost" id="btn-ai-weekly">é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</button>
    <button class="btn ghost" id="btn-ai-rebalance">æ¬¡ã®ä¸€æ‰‹</button>
  </div>
</section>

<!-- ğŸ“Š KPIï¼ˆè©•ä¾¡ãƒ™ãƒ¼ã‚¹ï¼‰ -->
<section class="kpi-grid">
  <div class="kpi-card">
    <div class="kpi-label">ç·è³‡ç”£ï¼ˆè©•ä¾¡+ç¾é‡‘ï¼‰</div>
    <div class="kpi-value">Â¥{{ kpis.total_assets|intcomma }}</div>
    <div class="kpi-sub">= ç¾ç‰©+ä¿¡ç”¨ã®è©•ä¾¡é¡ + ç¾é‡‘</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">æœªå®Ÿç¾æç›Šï¼ˆç¾ç‰©+ä¿¡ç”¨ï¼‰</div>
    <div class="kpi-value {% if kpis.unrealized_pnl > 0 %}pos{% elif kpis.unrealized_pnl < 0 %}neg{% endif %}">
      Â¥{{ kpis.unrealized_pnl|intcomma }}
    </div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">ä»Šæœˆã®å®Ÿç¾</div>
    <div class="kpi-value {% if kpis.realized_month > 0 %}pos{% elif kpis.realized_month < 0 %}neg{% endif %}">
      Â¥{{ kpis.realized_month|intcomma }}
    </div>
    <div class="kpi-sub">é…å½“ Â¥{{ kpis.dividend_month|intcomma }}</div>
  </div>
  <div class="kpi-card">
    <div class="kpi-label">ROIï¼ˆæŠ•ä¸‹è³‡é‡‘æ¯”ï¼‰</div>
    <div class="kpi-value">{% if kpis.roi_pct != None %}{{ kpis.roi_pct }}%{% else %}â€”{% endif %}</div>
    <div class="kpi-sub">æŠ•ä¸‹è³‡é‡‘ Â¥{{ kpis.invested|intcomma }}</div>
  </div>
</section>

<!-- ğŸ’¼ ã‚‚ã—ä»Šã™ãå…¨ã¦ç¾é‡‘åŒ–ã—ãŸã‚‰ -->
<section class="glass liq">
  <div class="liq-title">ä»Šã™ãå…¨ã¦ç¾é‡‘åŒ–ã—ãŸã‚‰</div>
  <div class="liq-rows">
    <div>ç¾ç‰©+ä¿¡ç”¨ã®è©•ä¾¡é¡</div><div>Â¥{{ breakdown.spot_mv|add:breakdown.margin_mv|intcomma }}</div>
    <div>ç¾é‡‘æ®‹é«˜</div><div>Â¥{{ kpis.cash_total|intcomma }}</div>
    <div class="sum">åˆè¨ˆï¼ˆç¨ãƒ»æ‰‹æ•°æ–™è€ƒæ…®ãªã—ï¼‰</div><div class="sum">Â¥{{ kpis.liquidation|intcomma }}</div>
  </div>
</section>

<!-- ğŸ§¾ å†…è¨³ï¼ˆç¾ç‰© / ä¿¡ç”¨ï¼‰: æ¯”ç‡ã‚²ãƒ¼ã‚¸ + ãƒ‰ãƒ¼ãƒŠãƒ„ + æ•°å€¤ -->
<section class="glass breakdown">
  <div class="strip-title">å†…è¨³ï¼ˆç¾ç‰© / ä¿¡ç”¨ï¼‰</div>

  <!-- æ¨ªãƒãƒ¼æ¯”ç‡ã‚²ãƒ¼ã‚¸ -->
  <div class="bd-gauge" role="img" aria-label="ç¾ç‰©ã¨ä¿¡ç”¨ã®æ¯”ç‡">
    <div class="bd-gauge-spot"   style="width: {{ breakdown_pct.spot_pct }}%"></div>
    <div class="bd-gauge-margin" style="width: {{ breakdown_pct.margin_pct }}%"></div>
  </div>
  <div class="bd-legend">
    <span><i class="dot spot"></i>ç¾ç‰© {{ breakdown_pct.spot_pct }}%</span>
    <span><i class="dot margin"></i>ä¿¡ç”¨ {{ breakdown_pct.margin_pct }}%</span>
  </div>

  <!-- ãƒ‰ãƒ¼ãƒŠãƒ„ -->
  <div class="bd-donut-wrap">
    <div class="bd-donut"
         style="--spot: {{ breakdown_pct.spot_pct }}; --margin: {{ breakdown_pct.margin_pct }};"
         role="img" aria-label="ç¾ç‰©ã¨ä¿¡ç”¨ã®ãƒ‰ãƒ¼ãƒŠãƒ„æ§‹æˆ">
      <div class="bd-donut-hole">
        <div class="bd-donut-total">Â¥{{ kpis.total_assets|intcomma }}</div>
        <div class="bd-donut-caption">ç·è³‡ç”£ï¼ˆè©•ä¾¡+ç¾é‡‘ï¼‰</div>
      </div>
    </div>
    <ul class="bd-legend-rows">
      <li><span class="dot spot"></span><span>ç¾ç‰© è©•ä¾¡é¡</span><strong>Â¥{{ breakdown.spot_mv|intcomma }}</strong></li>
      <li class="sub"><span></span><span>å–å¾—é¡</span><span>Â¥{{ breakdown.spot_cost|intcomma }}</span></li>
      <li><span class="dot margin"></span><span>ä¿¡ç”¨ è©•ä¾¡é¡</span><strong>Â¥{{ breakdown.margin_mv|intcomma }}</strong></li>
      <li class="sub"><span></span><span>å–å¾—é¡</span><span>Â¥{{ breakdown.margin_cost|intcomma }}</span></li>
    </ul>
  </div>
</section>

<!-- ğŸ¦ è¨¼åˆ¸ä¼šç¤¾åˆ¥ã‚µãƒãƒªãƒ¼ï¼ˆç¾é‡‘ï¼‹ãƒã‚¸ã‚·ãƒ§ãƒ³ï¼‰ -->
<section class="glass broker-sum">
  <div class="strip-title">è¨¼åˆ¸ä¼šç¤¾åˆ¥ã‚µãƒãƒªãƒ¼</div>
  <div class="broker-grid">
    {% for r in broker_rows %}
      <div class="broker-card">
        <div class="b-row name">{{ r.broker }}</div>
        <div class="b-row"><span>ç¾é‡‘</span><strong>Â¥{{ r.cash|intcomma }}</strong></div>
        <div class="b-row"><span>ãƒã‚¸ã‚·ãƒ§ãƒ³è©•ä¾¡</span><strong>Â¥{{ r.pos_mv|intcomma }}</strong></div>
        <div class="b-row total"><span>åˆè¨ˆ</span><strong>Â¥{{ r.total|intcomma }}</strong></div>
      </div>
    {% empty %}
      <div class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
    {% endfor %}
  </div>
</section>

<!-- ğŸ“ˆ ã‚»ã‚¯ã‚¿ãƒ¼ï¼ˆ=brokerï¼‰åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ï¼ˆç¾ç‰©ã®ã¿ï¼‰ -->
<section class="sector-strip glass">
  <div class="strip-title">ç¾ç‰©ãƒã‚¸ã‚·ãƒ§ãƒ³ã®æˆç¸¾ï¼ˆè¨¼åˆ¸ä¼šç¤¾åˆ¥ï¼‰</div>
  <div class="strip-scroll">
    {% for s in sectors %}
      <div class="sector-chip">
        <div class="sec-name">{{ s.sector }}</div>
        <div class="sec-meta">
          <span class="mv">Â¥{{ s.mv|intcomma }}</span>
          <span class="rate {% if s.rate > 0 %}pos{% elif s.rate < 0 %}neg{% endif %}">{{ s.rate }}%</span>
        </div>
      </div>
    {% empty %}
      <div class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
    {% endfor %}
  </div>
</section>

<!-- ğŸ’° ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ï¼ˆä»Šæœˆï¼‰ -->
<section class="cash glass">
  <div class="cash-head">ä»Šæœˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼</div>
  <canvas id="cashflowChart" height="140" aria-label="ä»Šæœˆã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼" role="img"></canvas>
</section>

<!-- âœ… æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
<section class="todo glass">
  <div class="todo-head">æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</div>
  <ul class="todo-list" id="todoList">
    {% for a in ai_actions %}<li>âœ… {{ a }}</li>{% endfor %}
  </ul>
</section>

<!-- JS ã¸ãƒ‡ãƒ¼ã‚¿ä¾›çµ¦ -->
<script id="home-data" type="application/json">
{
  "total_mv": {{ kpis.total_assets|default:0 }},
  "cash_bars": {{ cash_bars|safe }}
}
</script>

{% endblock %}