{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% block title %}Home{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/home.css' %}?v=102">

<div class="home-shell">
  <!-- Top: date pill + ticker -->
  <div class="home-top">
    <div class="pill pill-date">
      <div class="pill-cap">æœ¬æ—¥</div>
      <div class="pill-main">{{ today_label|default:"" }}</div>
    </div>

    <div class="pill pill-ticker" id="newsTicker">
      <div class="ticker-icon">ğŸ“°</div>
      <div class="ticker-track">
        <div class="ticker-text" id="tickerText">
          {% for d in decks %}
            {% if d.key == "news_trends" %}
              {% if d.payload.items %}
                NEWS:
                {% for it in d.payload.items|slice:":6" %}
                  {{ it.source }}ã€Œ{{ it.title }}ã€ /
                {% endfor %}
              {% else %}
                NEWS: æº–å‚™ä¸­
              {% endif %}
            {% endif %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Deck rail -->
  <div class="rail" id="rail">
    {% for d in decks %}
      <section class="deck" data-key="{{ d.key }}">
        <div class="deck-card">

          <div class="deck-head">
            <div class="deck-title">{{ d.title }}</div>
            {% if d.payload.as_of %}
              <div class="deck-sub">æ›´æ–°: {{ d.payload.as_of }}</div>
            {% endif %}
          </div>

          <!-- =========================
               ASSETS
               ========================= -->
          {% if d.key == "assets" %}
            {% with a=d.payload %}
              <div class="grid2">
                <div class="kpi">
                  <div class="kpi-label">å®Ÿç¾æç›Š YTD</div>
                  <div class="kpi-val {% if a.realized.ytd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.ytd.total|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.ytd.count }}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">ä»Šæœˆ MTD</div>
                  <div class="kpi-val {% if a.realized.mtd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.mtd.total|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.mtd.count }}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">ä»Šé€± WTD</div>
                  <div class="kpi-val {% if a.realized.wtd.total >= 0 %}pos{% else %}neg{% endif %}">
                    Â¥{{ a.realized.wtd.total|floatformat:0|intcomma }}
                  </div>
                  <div class="kpi-sub">ä»¶æ•° {{ a.realized.wtd.count }}</div>
                </div>
                <div class="kpi">
                  <div class="kpi-label">å¹´é–“ç›®æ¨™ï¼ˆå…¨ä½“ï¼‰</div>
                  <div class="kpi-val">
                    Â¥{{ a.goals.year_total|intcomma }}
                  </div>
                  <div class="kpi-sub">æ®‹ã‚Šæœˆ{{ a.pace.remaining_months_including_current }} / æ®‹ã‚Šé€±{{ a.pace.remaining_weeks_including_current }}</div>
                </div>
              </div>

              <div class="sec">
                <div class="sec-title">å¿…è¦ãƒšãƒ¼ã‚¹ï¼ˆã“ã‚Œã‹ã‚‰ï¼‰</div>
                <div class="grid2">
                  <div class="kpi">
                    <div class="kpi-label">æœˆãƒšãƒ¼ã‚¹</div>
                    {# â˜…æœªé”ï¼ˆneed_per_slot > 0ï¼‰ã¯ warnï¼ˆé»„ï¼‰ #}
                    <div class="kpi-val {% if a.pace.total_need_per_month.need_per_slot > 0 %}warn{% else %}pos{% endif %}">
                      Â¥{{ a.pace.total_need_per_month.need_per_slot|floatformat:0|intcomma }}
                    </div>
                    <div class="kpi-sub">
                      æ®‹ã‚Š
                      <span class="{% if a.pace.total_need_per_month.remaining > 0 %}warn{% else %}pos{% endif %}">
                        Â¥{{ a.pace.total_need_per_month.remaining|floatformat:0|intcomma }}
                      </span>
                    </div>
                  </div>

                  <div class="kpi">
                    <div class="kpi-label">é€±ãƒšãƒ¼ã‚¹</div>
                    <div class="kpi-val {% if a.pace.total_need_per_week.need_per_slot > 0 %}warn{% else %}pos{% endif %}">
                      Â¥{{ a.pace.total_need_per_week.need_per_slot|floatformat:0|intcomma }}
                    </div>
                    <div class="kpi-sub">
                      æ®‹ã‚Š
                      <span class="{% if a.pace.total_need_per_week.remaining > 0 %}warn{% else %}pos{% endif %}">
                        Â¥{{ a.pace.total_need_per_week.remaining|floatformat:0|intcomma }}
                      </span>
                    </div>
                  </div>
                </div>
                <div class="hint">â€» æœªé”ï¼ˆæ®‹ã‚Š/å¿…è¦ãƒšãƒ¼ã‚¹ãŒãƒ—ãƒ©ã‚¹ï¼‰â†’é»„è‰²ã€‚é”æˆï¼ˆãƒã‚¤ãƒŠã‚¹/ã‚¼ãƒ­ï¼‰â†’ç·‘ã€‚</div>
              </div>

              <div class="sec">
                <div class="sec-title">è¨¼åˆ¸ä¼šç¤¾åˆ¥ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰</div>

                <div class="broker-cards">
                  {% for r in a.pace.by_broker_rows %}
                    <div class="bcard">
                      <div class="bcard-top">
                        <div class="bcard-name">{{ r.label }}</div>
                        <div class="bcard-ytd {% if r.ytd >= 0 %}pos{% else %}neg{% endif %}">
                          Â¥{{ r.ytd|floatformat:0|intcomma }}
                        </div>
                      </div>

                      <div class="brow">
                        <div class="lk">å¹´ç›®æ¨™</div>
                        <div class="lv">Â¥{{ r.goal_year|intcomma }}</div>
                      </div>

                      <div class="brow">
                        <div class="lk">æ®‹ã‚Šï¼ˆæœˆåŸºæº–ï¼‰</div>
                        <div class="lv {% if r.pace_month.remaining > 0 %}warn{% else %}pos{% endif %}">
                          Â¥{{ r.pace_month.remaining|floatformat:0|intcomma }}
                        </div>
                      </div>

                      <div class="brow">
                        <div class="lk">æœˆãƒšãƒ¼ã‚¹</div>
                        <div class="lv {% if r.pace_month.need_per_slot > 0 %}warn{% else %}pos{% endif %}">
                          Â¥{{ r.pace_month.need_per_slot|floatformat:0|intcomma }}
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>

                <div class="hint">æ¨ªã‚¹ãƒ¯ã‚¤ãƒ—ï¼šYTD / ç›®æ¨™ / æ®‹ã‚Š / æœˆãƒšãƒ¼ã‚¹</div>
              </div>

              <div class="sec">
                <div class="sec-title">è¨¼åˆ¸ä¼šç¤¾åˆ¥ï¼ˆè¡¨ï¼‰</div>
                <div class="table">
                  <div class="tr th">
                    <div>è¨¼åˆ¸ä¼šç¤¾</div>
                    <div class="r">YTD</div>
                    <div class="r">ç›®æ¨™</div>
                    <div class="r">æœˆãƒšãƒ¼ã‚¹</div>
                  </div>
                  {% for r in a.pace.by_broker_rows %}
                    <div class="tr">
                      <div class="bname">{{ r.label }}</div>
                      <div class="r {% if r.ytd >= 0 %}pos{% else %}neg{% endif %}">
                        {{ r.ytd|floatformat:0|intcomma }}
                      </div>
                      <div class="r">{{ r.goal_year|intcomma }}</div>
                      <div class="r {% if r.pace_month.need_per_slot > 0 %}warn{% else %}pos{% endif %}">
                        {{ r.pace_month.need_per_slot|floatformat:0|intcomma }}
                      </div>
                    </div>
                  {% endfor %}
                </div>
                <div class="hint">ï¼ˆä¾‹ï¼‰YTD / å¹´ç›®æ¨™ / æœˆãƒšãƒ¼ã‚¹</div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- =========================
               TODAY PLAN
               ========================= -->
          {% if d.key == "today_plan" %}
            {% with t=d.payload %}
              <div class="sec">
                <div class="sec-title">ä»Šæ—¥ã®ä½œæˆ¦</div>

                {% if t.tasks %}
                  <div class="plan">
                    {% for x in t.tasks %}
                      <div class="plan-item">
                        <div class="plan-head">
                          <span class="tag
                            {% if x.kind == "primary" %}tag-primary
                            {% elif x.kind == "broker" %}tag-broker
                            {% elif x.kind == "ok" %}tag-ok
                            {% else %}tag-check{% endif %}
                          ">
                            {% if x.kind == "primary" %}PRIORITY
                            {% elif x.kind == "broker" %}BROKER
                            {% elif x.kind == "ok" %}OK
                            {% else %}CHECK{% endif %}
                          </span>
                          <div class="plan-title">{{ x.title }}</div>
                        </div>
                        <div class="plan-desc">{{ x.desc }}</div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="empty">TODAY PLAN ç”Ÿæˆä¸­â€¦</div>
                {% endif %}

                <div class="hint">ASSETSï¼ˆç›®æ¨™å·®åˆ†ï¼‰ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã€‚å¾Œã§ Policy/Watch ã«æ¥ç¶šã—ã¦è‡ªå‹•ã§â€œå…·ä½“ã‚¢ã‚¯ã‚·ãƒ§ãƒ³â€ã¸ã€‚</div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- =========================
               NEWS & TRENDS
               ========================= -->
          {% if d.key == "news_trends" %}
            {% with n=d.payload %}
              <div class="sec">
                <div class="sec-title">æ³¨ç›®ã‚»ã‚¯ã‚¿ãƒ¼ï¼ˆã–ã£ãã‚Šï¼‰</div>
                <div class="chips">
                  {% for s in n.sectors %}
                    <div class="chip">{{ s.sector }} Ã—{{ s.count }}</div>
                  {% empty %}
                    <div class="chip">ãã®ä»– Ã—0</div>
                  {% endfor %}
                </div>
                <div class="deck-sub" style="margin-top:10px;">æ›´æ–°: {{ n.as_of }}</div>
              </div>

              <div class="sec">
                <div class="sec-title">ãƒ‹ãƒ¥ãƒ¼ã‚¹</div>
                <div class="list">
                  {% for it in n.items|slice:":10" %}
                    <a class="li" href="{{ it.link }}" target="_blank" rel="noopener">
                      <div class="badge">{{ it.source }}</div>
                      <div class="li-title">{{ it.title }}</div>
                      <div class="li-sub">
                        <span class="host">{{ it.host }}</span>
                      </div>
                    </a>
                  {% empty %}
                    <div class="empty">ãƒ‹ãƒ¥ãƒ¼ã‚¹å–å¾—ä¸­â€¦</div>
                  {% endfor %}
                </div>
              </div>

              <div class="sec">
                <div class="sec-title">ãƒãƒƒãƒˆ/ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆä»£æ›¿ï¼‰</div>
                <div class="list">
                  {% for it in n.trends|slice:":10" %}
                    <a class="li" href="{{ it.link }}" target="_blank" rel="noopener">
                      <div class="badge">Trends</div>
                      <div class="li-title">{{ it.title }}</div>
                      <div class="li-sub">
                        <span class="host">{{ it.host }}</span>
                      </div>
                    </a>
                  {% empty %}
                    <div class="empty">ãƒˆãƒ¬ãƒ³ãƒ‰å–å¾—ä¸­â€¦</div>
                  {% endfor %}
                </div>
              </div>
            {% endwith %}
          {% endif %}

          <!-- STUB decks -->
          {% if d.key != "assets" and d.key != "news_trends" and d.key != "today_plan" %}
            <div class="stub">
              <div class="stub-title">ï¼ˆæº–å‚™ä¸­ï¼‰</div>
              <div class="stub-sub">ã“ã“ã¯å¾Œã§ aiapp ã®çŸ¥èƒ½ãƒ»ãƒãƒªã‚·ãƒ¼ãƒ»ãƒ¬ã‚¸ãƒ¼ãƒ ç­‰ã¨åˆä½“ã—ã¦â€œè‡ªåˆ†ã§è€ƒãˆã¦ç™ºè¨€ã™ã‚‹AIâ€ã«é€²åŒ–ã•ã›ã‚‹</div>
            </div>
          {% endif %}

        </div>
      </section>
    {% endfor %}
  </div>

  <!-- dots -->
  <div class="dots" id="dots"></div>
</div>

<script src="{% static 'js/home.js' %}?v=102" defer></script>
{% endblock %}