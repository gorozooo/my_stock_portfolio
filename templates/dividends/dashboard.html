{% extends "base.html" %}
{% load static %}
{% block title %}配当ダッシュボード{% endblock %}

{% block head %}
<style>
  .wrap{max-width:960px;margin:0 auto}
  .bar{padding:10px 12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:12px;display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr 1fr}
  @media (max-width:780px){ .bar{grid-template-columns:1fr 1fr} }
  .bar select,.bar button,.bar a{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#eaf0ff;text-align:center;text-decoration:none;display:inline-block}
  .kpis{display:grid;gap:12px;margin-top:12px;grid-template-columns:repeat(4,1fr)}
  @media (max-width:780px){ .kpis{grid-template-columns:repeat(2,1fr)} }
  .kpi{padding:14px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.04)}
  .kpi .t{font-size:12px;color:#9aa4b2}
  .kpi .v{font-size:22px;margin-top:4px}
  .grid{display:grid;gap:12px;margin-top:14px;grid-template-columns:1fr 1fr}
  @media (max-width:780px){ .grid{grid-template-columns:1fr} }
  .card{padding:14px 16px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.04)}
  .sec-title{font-weight:600;margin-bottom:8px}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th{font-size:12px;color:#9aa4b2;text-align:left;padding:0 8px}
  td{padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
  td:first-child{border-radius:10px 0 0 10px}
  td:last-child{border-radius:0 10px 10px 0;text-align:right}
  .muted{font-size:12px;color:#9aa4b2}

  .barwrap{height:160px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.03);padding:8px;position:relative}
  .legend{display:flex;gap:12px;margin-top:6px}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
  .tip{position:absolute;pointer-events:none;background:rgba(30,32,46,.95);border:1px solid rgba(255,255,255,.08);
       padding:6px 8px;border-radius:8px;font-size:12px;transform:translate(-50%,-100%);display:none;z-index:5}
  .clear-btn{background:none;border:1px dashed rgba(255,255,255,.22)}

  /* link rows (JSで生成するときの簡易見た目) */
  .rows .row{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;margin:6px 0;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:10px;text-decoration:none;color:inherit}
  .rows .row .l{opacity:.9}
  .rows .row .r{opacity:.9}

  /* goal */
  .goal-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  @media (max-width:780px){ .goal-grid{grid-template-columns:1fr} }
  .goal-form{display:flex;gap:8px;margin-top:10px}
  .goal-form input[type="number"]{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#eaf0ff}
  .goal-form button{padding:10px 16px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(79,123,255,.25);color:#fff}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <h1 class="text-xl font-semibold mb-3">配当ダッシュボード</h1>

  <!-- フィルタバー -->
  <form class="bar" method="get" id="flt_form">
    <div>
      <label class="muted">年</label>
      <select name="year" id="flt_year">
        {% for y in year_options %}
          <option value="{{ y }}" {% if flt.year == y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="muted">証券会社</label>
      <select name="broker" id="flt_broker">
        <option value="">すべて</option>
        {% for val,label in BROKERS %}
          <option value="{{ val }}" {% if flt.broker == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="muted">口座区分</label>
      <select name="account" id="flt_account">
        <option value="">すべて</option>
        {% for val,label in ACCOUNTS %}
          <option value="{{ val }}" {% if flt.account == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="align-self:end;display:flex;gap:8px">
      <button type="submit" id="btn_apply">反映</button>
      <a class="clear-btn" href="?year={{ flt.year }}" id="btn_clear">条件クリア</a>
    </div>
  </form>

  <!-- KPI -->
  <div class="kpis">
    <div class="kpi"><div class="t">件数（{{ flt.year }}）</div><div class="v" id="kpi_count">{{ kpi.count|default:"0" }}</div></div>
    <div class="kpi"><div class="t">税引前合計</div><div class="v" id="kpi_gross">{{ kpi.gross|floatformat:2 }}</div></div>
    <div class="kpi"><div class="t">税額合計</div><div class="v" id="kpi_tax">{{ kpi.tax|floatformat:2 }}</div></div>
    <div class="kpi"><div class="t">税引後合計</div><div class="v" id="kpi_net">{{ kpi.net|floatformat:2 }}</div></div>
  </div>
  <div class="kpi" style="margin-top:12px">
    <div class="t">概算利回り（年・税引後/元本）</div>
    <div class="v"><span id="kpi_yield">{{ kpi.yield_pct|floatformat:2 }}</span>%</div>
    <div class="muted" style="margin-top:6px">※ 元本＝株数×取得単価（保有/配当のいずれか入力がある明細のみ合算）</div>
  </div>

  <!-- 年間目標（税引後） -->
  <div class="card" style="margin-top:12px">
    <div class="sec-title">年間目標（税引後）</div>
    <div class="goal-grid">
      <div class="kpi"><div class="t">目標</div><div class="v" id="goal_amount">{{ goal.amount|floatformat:2 }}</div></div>
      <div class="kpi"><div class="t">達成率</div><div class="v"><span id="goal_progress">{{ goal.progress_pct|floatformat:2 }}</span>%</div></div>
      <div class="kpi"><div class="t">残額</div><div class="v" id="goal_remaining">{{ goal.remaining|floatformat:2 }}</div></div>
    </div>
    <form method="post" action="{% url 'dividend_save_goal' %}" class="goal-form">
      {% csrf_token %}
      <input type="hidden" id="goal_year" name="year" value="{{ flt.year }}">
      <input type="number" name="amount" id="goal_amount_input" step="0.01" min="0" placeholder="目標額 (税引後)" value="{{ goal.amount }}">
      <button type="submit">保存</button>
    </form>
  </div>

  <div class="grid">
    <!-- 月次グラフ -->
    <div class="card">
      <div class="sec-title">月次（税引後＋税額）</div>
      <div class="barwrap" id="chartWrap">
        <div id="monthly_svg" style="width:100%;height:100%"></div>
        <div class="tip" id="chartTip"></div>
      </div>
      <div class="legend">
        <span><i class="dot" style="background:#6ea8ff"></i> 税引後</span>
        <span><i class="dot" style="background:#a0aec0"></i> 税額</span>
      </div>
      <div class="muted" style="margin-top:6px">バーをタップで明細へ移動します。</div>
    </div>

    <!-- 証券会社別 -->
    <div class="card">
      <div class="sec-title">証券会社別（税引後合計）</div>
      <div class="rows" id="tbl_broker">
        {% for r in by_broker %}
          <a class="row" href="{% url urls.list %}?year={{ flt.year }}&broker={{ r.broker }}"><span class="l">{{ r.broker }}</span><span class="r">{{ r.net|floatformat:2 }}</span></a>
        {% empty %}
          <div class="muted">データなし</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 口座区分別 & トップ銘柄 -->
  <div class="grid">
    <div class="card">
      <div class="sec-title">口座区分別（税引後合計）</div>
      <div class="rows" id="tbl_account"><div class="muted">—</div></div>
    </div>
    <div class="card">
      <div class="sec-title">税引後 上位銘柄（Top 10 / {{ flt.year }}）</div>
      <div class="rows" id="tbl_top">
        {% for r in top_symbols %}
          <div class="row"><span class="l">{{ r.label }}</span><span class="r">{{ r.net|floatformat:2 }}</span></div>
        {% empty %}
          <div class="muted">データなし</div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- 初期月次データ（JS未対応の環境向け） -->
{{ monthly|json_script:"js-monthly" }}

<!-- ルーティング（JS用） -->
<script>
  window.DIVD_URLS = {
    json: "{% url 'dividend_dashboard_json' %}",
    list: "{% url urls.list %}",
    year: "{{ flt.year|default_if_none:'' }}",
    broker: "{{ flt.broker|default_if_none:'' }}",
    account: "{{ flt.account|default_if_none:'' }}"
  };
</script>
<script src="{% static 'js/dividends_dashboard.js' %}?v=3" defer></script>
{% endblock %}