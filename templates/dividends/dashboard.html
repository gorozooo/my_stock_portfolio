{% extends "base.html" %}
{% load static %}
{% block title %}配当ダッシュボード{% endblock %}

{% block head %}
<style>
  .wrap{max-width:960px;margin:0 auto}
  .bar{padding:10px 12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:12px;display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr 1fr}
  @media (max-width:780px){ .bar{grid-template-columns:1fr 1fr} }
  .bar select,.bar button,.bar a{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#eaf0ff;text-align:center;text-decoration:none;display:inline-block}
  .kpis{display:grid;gap:12px;margin-top:12px;grid-template-columns:repeat(4,1fr)}
  @media (max-width:780px){ .kpis{grid-template-columns:repeat(2,1fr)} }
  .kpi{padding:14px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.04)}
  .kpi .t{font-size:12px;color:#9aa4b2}
  .kpi .v{font-size:22px;margin-top:4px}

  .grid{display:grid;gap:12px;margin-top:14px;grid-template-columns:1fr 1fr}
  @media (max-width:780px){ .grid{grid-template-columns:1fr} }
  .card{padding:14px 16px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.04)}
  .sec-title{font-weight:600;margin-bottom:8px}
  .muted{font-size:12px;color:#9aa4b2}

  /* 月次バー */
  .barwrap{height:160px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.03);padding:8px;position:relative}
  .legend{display:flex;gap:12px;margin-top:6px}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
  .tip{position:absolute;pointer-events:none;background:rgba(30,32,46,.95);border:1px solid rgba(255,255,255,.08);
       padding:6px 8px;border-radius:8px;font-size:12px;transform:translate(-50%,-100%);display:none;z-index:5}
  .clear-btn{background:none;border:1px dashed rgba(255,255,255,.22)}

  /* 年間目標（進捗） */
  .goal-card{margin-top:12px}
  .goal-grid{display:grid;gap:10px;grid-template-columns:1fr 1fr}
  @media (max-width:780px){ .goal-grid{grid-template-columns:1fr} }
  .goal-box{padding:12px;border:1px solid rgba(255,255,255,.10);border-radius:12px;background:rgba(255,255,255,.04)}
  .goal-box .ttl{font-size:12px;color:#9aa4b2;margin-bottom:6px}
  .goal-input{display:flex;gap:8px;margin-top:10px}
  .goal-input input{flex:1;min-width:0;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#eaf0ff}
  .goal-input button{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.10);color:#eaf0ff}
  .goal-bar{height:14px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.10)}
  .goal-bar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#6ea8ff,#9f7aea);transition:width .35s ease}
  .achieved{border-color:rgba(255,215,81,.65)!important;box-shadow:0 0 0 1px rgba(255,215,81,.25) inset, 0 0 28px rgba(255,215,81,.18)}
  .achieved .goal-bar{border-color:rgba(255,215,81,.55)}
  .achieved .goal-bar > i{background:linear-gradient(90deg,#ffd751,#ffb300)}
  #dashToast{position:fixed;left:50%;bottom:120px;transform:translate(-50%,24px);
    background:rgba(30,32,46,.96);color:#fff;padding:8px 12px;font-size:13px;border-radius:10px;
    border:1px solid rgba(255,255,255,.08);box-shadow:0 10px 28px rgba(0,0,0,.45);opacity:0;pointer-events:none;
    transition:opacity .16s ease, transform .16s ease;z-index:100050}

  /* ドーナツ：右側凡例 */
  .donut-block{display:flex;gap:14px;align-items:center;justify-content:flex-start;min-height:150px}
  .donut-svg{width:150px;height:150px;flex:0 0 150px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.03);display:flex;align-items:center;justify-content:center}
  .donut-legend{flex:1;display:flex;flex-direction:column;gap:8px}
  .legend-item{display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);padding:8px 10px;border-radius:10px;text-decoration:none;color:inherit}
  .legend-left{display:flex;align-items:center;gap:8px}
  .legend-dot{width:10px;height:10px;border-radius:50%}
  .legend-lbl{opacity:.95}
  .legend-val{opacity:.95}
  @media (max-width:780px){
    .donut-block{flex-direction:row} /* スマホでも右配置のまま */
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <h1 class="text-xl font-semibold mb-3">配当ダッシュボード</h1>

  <!-- フィルタバー -->
  <form class="bar" method="get" id="flt_form">
    <div>
      <label class="muted">年</label>
      <select name="year" id="flt_year">
        {% for y in year_options %}
          <option value="{{ y }}" {% if flt.year == y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="muted">証券会社</label>
      <select name="broker" id="flt_broker">
        <option value="">すべて</option>
        {% for val,label in BROKERS %}
          <option value="{{ val }}" {% if flt.broker == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="muted">口座区分</label>
      <select name="account" id="flt_account">
        <option value="">すべて</option>
        {% for val,label in ACCOUNTS %}
          <option value="{{ val }}" {% if flt.account == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="align-self:end;display:flex;gap:8px">
      <button type="submit" id="btn_apply">反映</button>
      <a class="clear-btn" href="?year={{ flt.year }}" id="btn_clear">条件クリア</a>
    </div>
  </form>

  <!-- KPI -->
  <div class="kpis">
    <div class="kpi"><div class="t">件数（{{ flt.year }}）</div><div class="v" id="kpi_count">{{ kpi.count|default:"0" }}</div></div>
    <div class="kpi"><div class="t">税引前合計</div><div class="v" id="kpi_gross">{{ kpi.gross|floatformat:2 }}</div></div>
    <div class="kpi"><div class="t">税額合計</div><div class="v" id="kpi_tax">{{ kpi.tax|floatformat:2 }}</div></div>
    <div class="kpi"><div class="t">税引後合計</div><div class="v" id="kpi_net">{{ kpi.net|floatformat:2 }}</div></div>
  </div>
  <div class="kpi" style="margin-top:12px">
    <div class="t">概算利回り（年・税引後/元本）</div>
    <div class="v"><span id="kpi_yield">{{ kpi.yield_pct|floatformat:2 }}</span>%</div>
    <div class="muted" style="margin-top:6px">※ 元本＝株数×取得単価（保有/配当のいずれか入力がある明細のみ合算）</div>
  </div>

  <!-- 年間目標 -->
  <div class="card goal-card" id="goal_card">
    <div class="sec-title">年間目標（税引後）</div>
    <div class="goal-grid">
      <div class="goal-box">
        <div class="ttl">目標</div>
        <div class="v" id="goal_amount_view">{{ goal.amount|floatformat:2 }}</div>
        <div class="goal-input">
          <input type="number" step="0.01" inputmode="decimal" id="goal_amount_input" value="{{ goal.amount|floatformat:2 }}" placeholder="500000.00">
          <button type="button" id="goal_save_btn">保存</button>
        </div>
      </div>
      <div class="goal-box">
        <div class="ttl">達成率</div>
        <div class="v" id="goal_progress_view">{{ goal.progress_pct|default:0|floatformat:2 }}%</div>
        <div class="goal-bar" aria-label="進捗ゲージ"><i id="goal_bar_inner" style="width: {{ goal.progress_pct|default:0 }}%"></i></div>
        <div class="ttl" style="margin-top:10px">残額</div>
        <div class="v" id="goal_remaining_view">{{ goal.remaining|default:0|floatformat:2 }}</div>
      </div>
    </div>
  </div>

  <!-- 月次 -->
  <div class="grid">
    <div class="card">
      <div class="sec-title">月次（税引後＋税額）</div>
      <div class="barwrap" id="chartWrap">
        <div id="monthly_svg" style="width:100%;height:100%"></div>
        <div class="tip" id="chartTip"></div>
      </div>
      <div class="legend">
        <span><i class="dot" style="background:#6ea8ff"></i> 税引後</span>
        <span><i class="dot" style="background:#a0aec0"></i> 税額</span>
      </div>
      <div class="muted" style="margin-top:6px">バーをタップで明細へ移動します。</div>
    </div>

    <!-- 構成（ドーナツ2種：右凡例） -->
    <div class="card">
      <div class="sec-title">構成（税引後合計）</div>

      <!-- 証券会社 -->
      <div class="donut-block" id="donut_broker">
        <div class="donut-svg"><svg viewBox="0 0 160 160"></svg></div>
        <div class="donut-legend"></div>
      </div>

      <!-- 口座区分 -->
      <div class="donut-block" id="donut_account" style="margin-top:10px">
        <div class="donut-svg"><svg viewBox="0 0 160 160"></svg></div>
        <div class="donut-legend"></div>
      </div>

      <div class="muted" style="margin-top:8px">凡例をタップで明細にドリルダウンします。</div>
    </div>
  </div>

  <!-- トップ銘柄 -->
  <div class="card" style="margin-top:12px">
    <div class="sec-title">税引後 上位銘柄（Top 10 / {{ flt.year }}）</div>
    <div class="rows" id="tbl_top">
      {% for r in top_symbols %}
        <div class="legend-item"><span class="legend-left"><span class="legend-lbl">{{ r.label }}</span></span><span class="legend-val">{{ r.net|floatformat:2 }}</span></div>
      {% empty %}
        <div class="muted">データなし</div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ダッシュボード用トースト -->
<div id="dashToast" role="status" aria-live="polite"></div>

<!-- 初期月次データ（JS未対応の環境向け） -->
{{ monthly|json_script:"js-monthly" }}

<!-- ラベル変換（日本語） -->
<script>
  // ★ 日本語表記マッピング
  window.DIVD_LABELS = {
    broker: { {% for v,l in BROKERS %}"{{ v }}":"{{ l|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %} },
    account: { {% for v,l in ACCOUNTS %}"{{ v }}":"{{ l|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %} }
  }
</script>

<!-- ルーティング（JS用） -->
<script>
  window.DIVD_URLS = {
    json: "{% url 'dividend_dashboard_json' %}",
    save_goal: "{% url 'dividend_save_goal' %}",
    list: "{% url urls.list %}",
    year: "{{ flt.year|default_if_none:'' }}",
    broker: "{{ flt.broker|default_if_none:'' }}",
    account: "{{ flt.account|default_if_none:'' }}"
  };
</script>
<script src="{% static 'js/dividends_dashboard.js' %}?v=3" defer></script>
{% endblock %}