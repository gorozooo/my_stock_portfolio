{% extends "base.html" %}
{% load static %}
{% block title %}配当ダッシュボード{% endblock %}

{% block head %}
<style>
  .wrap{max-width:960px;margin:0 auto;overflow-x:hidden}

  .bar{padding:10px 12px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:12px;
       display:grid;gap:10px;grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width:780px){ .bar{grid-template-columns:repeat(2,minmax(0,1fr))} }
  .bar select,.bar button,.bar a{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);
       background:rgba(255,255,255,.06);color:#eaf0ff;text-align:center;text-decoration:none;display:inline-block}

  .kpis{display:grid;gap:12px;margin-top:12px;grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width:780px){ .kpis{grid-template-columns:repeat(2,minmax(0,1fr))} }
  .kpi{padding:14px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.04)}
  .kpi .t{font-size:12px;color:#9aa4b2}
  .kpi .v{font-size:22px;margin-top:4px}

  .grid{display:grid;gap:12px;margin-top:14px;grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:780px){ .grid{grid-template-columns:minmax(0,1fr)} }
  .card{padding:14px 16px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.04);overflow:hidden}
  .sec-title{font-weight:600;margin-bottom:8px}

  /* 月次ミニ棒グラフ */
  .barwrap{height:160px;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:rgba(255,255,255,.03);
           padding:8px;position:relative;overflow:hidden}
  .legend{display:flex;gap:12px;margin-top:6px;flex-wrap:wrap}
  .dot{display:inline-block;width:10px;height:10px;border-radius:50%}
  .tip{position:absolute;pointer-events:none;background:rgba(30,32,46,.95);border:1px solid rgba(255,255,255,.08);
       padding:6px 8px;border-radius:8px;font-size:12px;transform:translate(-50%,-100%);display:none;z-index:5}
  .clear-btn{background:none;border:1px dashed rgba(255,255,255,.22)}

  /* 年間目標（進捗） */
  .goal-card{margin-top:12px}
  .goal-grid{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:780px){ .goal-grid{grid-template-columns:minmax(0,1fr)} }
  .goal-box{padding:12px;border:1px solid rgba(255,255,255,.10);border-radius:12px;background:rgba(255,255,255,.04)}
  .goal-box .ttl{font-size:12px;color:#9aa4b2;margin-bottom:6px}
  .goal-input{display:flex;gap:8px;margin-top:10px}
  .goal-input input{flex:1;min-width:0;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:#eaf0ff}
  .goal-input button{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.10);color:#eaf0ff}
  .goal-bar{height:14px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;border:1px solid rgba(255,255,255,.10)}
  .goal-bar > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#6ea8ff,#9f7aea);transition:width .35s ease}
  .achieved{border-color:rgba(255,215,81,.65)!important;box-shadow:0 0 0 1px rgba(255,215,81,.25) inset, 0 0 28px rgba(255,215,81,.18)}
  .achieved .goal-bar{border-color:rgba(255,215,81,.55)}
  .achieved .goal-bar > i{background:linear-gradient(90deg,#ffd751,#ffb300)}

  /* ダッシュボード内トースト */
  #dashToast{position:fixed;left:50%;bottom:120px;transform:translate(-50%,24px);
    background:rgba(30,32,46,.96);color:#fff;padding:8px 12px;font-size:13px;border-radius:10px;
    border:1px solid rgba(255,255,255,.08);box-shadow:0 10px 28px rgba(0,0,0,.45);opacity:0;pointer-events:none;
    transition:opacity .16s ease, transform .16s ease;z-index:100050}

  /* ドーナツ（右凡例。左は最小120px〜最大32%） */
  .pie-grid{
    display:grid;
    grid-template-columns:minmax(120px,32%) minmax(0,1fr);
    gap:12px;
    align-items:center;
  }
  .pie{width:100%;max-width:140px;aspect-ratio:1/1;margin:0 auto;overflow:hidden}
  .legend-list{min-width:0}
  .legend-list .row{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:10px}
  .legend-list .row:hover{background:rgba(255,255,255,.06);cursor:pointer}
  .legend-list .l{display:flex;align-items:center;gap:8px;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .legend-list .label{overflow:hidden;text-overflow:ellipsis}
  .legend-list .r{display:flex;gap:10px;white-space:nowrap;flex-shrink:0}
  .legend-list .money{white-space:nowrap}
  .legend-list .pct{color:#9aa4b2;font-size:12px}
  .legend-list .swatch{display:inline-block;width:10px;height:10px;border-radius:50%}

  /* 簡易行（Top銘柄） */
  .rows .row{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;margin:6px 0;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:10px;text-decoration:none;color:inherit}
  .rows .row .l{opacity:.9;min-width:0;overflow:hidden;text-overflow:ellipsis}
  .rows .row .r{opacity:.9;white-space:nowrap}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <!-- フィルタバー -->
  <form class="bar" method="get" id="flt_form">
    <div>
      <label class="muted">年</label>
      <select name="year" id="flt_year">
        {% for y in year_options %}
          <option value="{{ y }}" {% if flt.year == y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="muted">証券会社</label>
      <select name="broker" id="flt_broker">
        <option value="">すべて</option>
        {% for val,label in BROKERS %}
          <option value="{{ val }}" {% if flt.broker == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label class="muted">口座区分</label>
      <select name="account" id="flt_account">
        <option value="">すべて</option>
        {% for val,label in ACCOUNTS %}
          <option value="{{ val }}" {% if flt.account == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>
    <div style="align-self:end;display:flex;gap:8px">
      <button type="submit" id="btn_apply">反映</button>
      <a class="clear-btn" href="?year={{ flt.year }}" id="btn_clear">条件クリア</a>
    </div>
  </form>

  <!-- KPI -->
  <div class="kpis">
    <div class="kpi"><div class="t">件数（{{ flt.year }}）</div><div class="v" id="kpi_count">{{ kpi.count|default:"0" }}</div></div>
    <div class="kpi"><div class="t">税引前合計</div><div class="v" id="kpi_gross">{{ kpi.gross|floatformat:0 }}円</div></div>
    <div class="kpi"><div class="t">税額合計</div><div class="v" id="kpi_tax">{{ kpi.tax|floatformat:0 }}円</div></div>
    <div class="kpi"><div class="t">税引後合計</div><div class="v" id="kpi_net">{{ kpi.net|floatformat:0 }}円</div></div>
  </div>
  <div class="kpi" style="margin-top:12px">
    <div class="t">概算利回り（年・税引後/元本）</div>
    <div class="v"><span id="kpi_yield">{{ kpi.yield_pct|floatformat:2 }}</span>%</div>
    <div class="muted" style="margin-top:6px">※ 元本＝株数×取得単価（保有/配当のいずれか入力がある明細のみ合算）</div>
  </div>

  <!-- 年間目標 -->
  <div class="card goal-card" id="goal_card">
    <div class="sec-title">年間目標（税引後）</div>
    <div class="goal-grid">
      <div class="goal-box">
        <div class="ttl">目標</div>
        <div class="v" id="goal_amount_view">{{ goal.amount|floatformat:0 }}円</div>
        <div class="goal-input">
          <input type="number" step="1" inputmode="numeric" id="goal_amount_input" value="{{ goal.amount|floatformat:0 }}" placeholder="500000">
          <button type="button" id="goal_save_btn">保存</button>
        </div>
      </div>
      <div class="goal-box">
        <div class="ttl">達成率</div>
        <div class="v" id="goal_progress_view">{{ goal.progress_pct|default:0|floatformat:2 }}%</div>
        <div class="goal-bar" aria-label="進捗ゲージ"><i id="goal_bar_inner" style="width: {{ goal.progress_pct|default:0 }}%"></i></div>
        <div class="ttl" style="margin-top:10px">残額</div>
        <div class="v" id="goal_remaining_view">{{ goal.remaining|default:0|floatformat:0 }}円</div>
      </div>
    </div>
  </div>

  <!-- 月次 & 構成 -->
  <div class="grid">
    <div class="card">
      <div class="sec-title">月次（税引後＋税額）</div>
      <div class="barwrap" id="chartWrap">
        <div id="monthly_svg" style="width:100%;height:100%"></div>
        <div class="tip" id="chartTip"></div>
      </div>
      <div class="legend">
        <span><i class="dot" style="background:#6ea8ff"></i> 税引後</span>
        <span><i class="dot" style="background:#a0aec0"></i> 税額</span>
      </div>
      <div class="muted" style="margin-top:6px">バーをタップで明細へ移動します。</div>
    </div>

    <div class="card">
      <div class="sec-title">構成（税引後合計）</div>
      <div class="pie-grid">
        <div>
          <svg class="pie" id="donut_broker" viewBox="0 0 120 120" aria-label="証券会社別"></svg>
        </div>
        <div class="legend-list" id="legend_broker"></div>

        <div>
          <svg class="pie" id="donut_account" viewBox="0 0 120 120" aria-label="口座区分別"></svg>
        </div>
        <div class="legend-list" id="legend_account"></div>
      </div>
      <div class="muted" style="margin-top:8px">凡例をタップで明細にドリルダウンします。</div>
    </div>
  </div>

  <!-- トップ銘柄 -->
  <div class="card" style="margin-top:12px">
    <div class="sec-title">税引後 上位銘柄（Top 10 / {{ flt.year }}）</div>
    <div class="rows" id="tbl_top">
      {% for r in top_symbols %}
        <div class="row">
          <span class="l">
            {% if r.name %}{{ r.name }}{% elif r.display_name %}{{ r.display_name }}{% else %}{{ r.label }}{% endif %}
          </span>
          <span class="r">{{ r.net|floatformat:0 }}円</span>
        </div>
      {% empty %}
        <div class="muted">データなし</div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- ダッシュボード用トースト -->
<div id="dashToast" role="status" aria-live="polite"></div>

<!-- 初期月次データ（JSフォールバック用） -->
{{ monthly|json_script:"js-monthly" }}

<!-- ルーティング / 日本語ラベルマップ -->
<script>
  window.DIVD_URLS = {
    json: "{% url 'dividend_dashboard_json' %}",
    save_goal: "{% url 'dividend_save_goal' %}",
    list: "{% url urls.list %}",
    year: "{{ flt.year|default_if_none:'' }}",
    broker: "{{ flt.broker|default_if_none:'' }}",
    account: "{{ flt.account|default_if_none:'' }}"
  };
  window.DIVD_LABELS = {
    broker: { {% for v,l in BROKERS %}"{{ v }}":"{{ l|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %} },
    account: { {% for v,l in ACCOUNTS %}"{{ v }}":"{{ l|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %} }
  };
</script>

<!-- 目標保存のための最小JS（JSON POST + CSRF） -->
<script>
(function(){
  const $ = s => document.querySelector(s);
  const btn   = $('#goal_save_btn');
  const input = $('#goal_amount_input');
  const toast = $('#dashToast');

  function showToast(msg){
    if(!toast) return;
    toast.textContent = msg;
    toast.style.opacity = '1';
    toast.style.transform = 'translate(-50%,0)';
    setTimeout(()=>{ toast.style.opacity='0'; toast.style.transform='translate(-50%,24px)'; }, 1600);
  }

  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? decodeURIComponent(m.pop()) : '';
  }

  async function saveGoal(){
    const year = parseInt(String(window.DIVD_URLS.year || new Date().getFullYear()), 10);
    const amount = Number(input.value || 0);

    if (isNaN(year) || isNaN(amount)) {
      showToast('入力値が不正です');
      return;
    }

    try{
      const res = await fetch(window.DIVD_URLS.save_goal, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({ year: year, amount: amount })
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error(t || '保存に失敗しました');
      }
      // 成功：表示を更新（簡易的にリロードするのが確実）
      showToast('年間目標を保存しました');
      setTimeout(()=>{ location.reload(); }, 300);
    }catch(err){
      console.error(err);
      showToast('エラー: 保存できませんでした');
    }
  }

  btn?.addEventListener('click', saveGoal);
})();
</script>

<script src="{% static 'js/dividends_dashboard.js' %}?v=12" defer></script>
{% endblock %}