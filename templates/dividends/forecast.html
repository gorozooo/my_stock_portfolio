{% extends "base.html" %}
{% load static %}
{% block title %}配当予測{% endblock %}

{% block head %}
<style>
  .wrap{max-width:980px;margin:0 auto}
  .filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:6px 0 10px}
  .filters select,.filters button{
    padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);color:#eaf0ff
  }
  .seg{display:flex;border:1px solid rgba(255,255,255,.14);border-radius:10px;overflow:hidden}
  .seg button{background:transparent;border:0;padding:10px 14px;color:#cfd7ff}
  .seg button.active{background:rgba(255,255,255,.12);font-weight:700}

  .card{
    border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);
    border-radius:14px;padding:12px
  }

  /* ← グラフが伸び続けないように親に固定高を持たせる */
  .chart-box{
    position:relative;
    height:320px;        /* モバイル向け高さ */
    max-width:980px;
    margin:8px auto 0;
  }
  @media (min-width:768px){
    .chart-box{ height:360px; }
  }
  /* Chart.js を親の高さにフィットさせる */
  #fChart{ width:100% !important; height:100% !important; display:block; }

  .sum{margin-top:8px;color:#cfd7ff}
</style>
<!-- Chart.js（CDN） -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="wrap">
  <h1 class="text-xl font-semibold mb-3">配当予測（12ヶ月）</h1>

  <!-- フィルター -->
  <form id="forecastFilter" class="filters">
    <select id="fYear" name="year">
      {% for y in year_options %}
        <option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>
      {% endfor %}
    </select>

    <!-- セグメント切替（hidden に反映して JS は hidden を読む） -->
    <div class="seg" id="segStack">
      <button type="button" data-v="none"    class="{% if stack == 'none' %}active{% endif %}">合計</button>
      <button type="button" data-v="broker"  class="{% if stack == 'broker' %}active{% endif %}">証券会社</button>
      <button type="button" data-v="account" class="{% if stack == 'account' %}active{% endif %}">口座</button>
    </div>
    <input type="hidden" id="fStack" name="stack" value="{{ stack|default:'none' }}">
  </form>

  <div class="card">
    <!-- 1枚のキャンバスを使い回す。高さは .chart-box が管理 -->
    <div class="chart-box">
      <canvas id="fChart"></canvas>
    </div>
    <div class="sum" id="fcSum"></div>
  </div>
</div>

<script>
  // セグメント押下で hidden を更新して change を投げる
  (()=>{
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const seg = $("#segStack"), hidden = $("#fStack"), form = $("#forecastFilter");
    if(seg && hidden && form){
      seg.addEventListener("click",(e)=>{
        const btn = e.target.closest("button[data-v]");
        if(!btn) return;
        $$("#segStack button").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        hidden.value = btn.dataset.v || "none";
        // フィルター変更通知（外部JSが拾う）
        form.dispatchEvent(new Event("change",{bubbles:false}));
      }, {passive:true});
    }
  })();
</script>

<!-- 予測描画スクリプト（destroy して再生成する版） -->
<script src="{% static 'js/dividends_forecast.js' %}?v=10"></script>
<script>
  // 初期ペイロード（JS はこれがあればAPI叩かず即描画）
  window.__FORECAST_INIT__ = {{ payload_json|safe }};
</script>
{% endblock %}