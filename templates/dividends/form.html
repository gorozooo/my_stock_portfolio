{% extends "base.html" %}
{% load static %}

{% block title %}配当を記録{% endblock %}

{% block content %}
<h1 class="text-xl font-bold mb-3">配当を記録</h1>

<form method="post" class="space-y-4">
  {% csrf_token %}

  <div class="p-3 rounded-lg border border-slate-700/60 bg-slate-800/40">
    <label class="block text-slate-300 mb-1">保有（任意）</label>
    {{ form.holding }}
    {% if form.holding.errors %}<div class="text-red-400 text-sm">{{ form.holding.errors }}</div>{% endif %}
  </div>

  <div class="p-3 rounded-lg border border-slate-700/60 bg-slate-800/40">
    <label class="block text-slate-300 mb-1">ティッカー/コード（保有未選択時は必須）</label>
    {{ form.ticker }}
    {% if form.ticker.errors %}<div class="text-red-400 text-sm">{{ form.ticker.errors }}</div>{% endif %}
  </div>

  <div class="p-3 rounded-lg border border-slate-700/60 bg-slate-800/40">
    <label class="block text-slate-300 mb-1">銘柄名（任意）</label>
    {{ form.name }}
    {% if form.name.errors %}<div class="text-red-400 text-sm">{{ form.name.errors }}</div>{% endif %}
  </div>

  <div class="grid grid-cols-2 gap-3">
    <div class="p-3 rounded-lg border border-slate-700/60 bg-slate-800/40">
      <label class="block text-slate-300 mb-1">受取日</label>
      {{ form.date }}
      {% if form.date.errors %}<div class="text-red-400 text-sm">{{ form.date.errors }}</div>{% endif %}
    </div>
    <div class="p-3 rounded-lg border border-slate-700/60 bg-slate-800/40">
      <label class="block text-slate-300 mb-1">受取額（税引後）</label>
      {{ form.amount }}
      {% if form.amount.errors %}<div class="text-red-400 text-sm">{{ form.amount.errors }}</div>{% endif %}
    </div>
  </div>

  <div class="grid grid-cols-2 gap-3">
    <div class="p-3 rounded-lg border border-slate-700/60 bg-slate-800/40">
      <label class="block text-slate-300 mb-1">税率</label>
      {{ form.tax_rate }}
    </div>
    <div class="p-3 rounded-lg border border-slate-700/60 bg-slate-800/40">
      <label class="block text-slate-300 mb-1">税込/税引後</label>
      {{ form.is_net }}
    </div>
  </div>

  {{ form.tax }} {# Hidden: 自動計算で埋まる #}

  <div class="p-3 rounded-lg border border-slate-700/60 bg-slate-800/40">
    <label class="block text-slate-300 mb-1">メモ</label>
    {{ form.memo }}
  </div>

  <div class="flex gap-3 pt-2">
    <button class="px-4 py-2 rounded-lg border border-slate-600 bg-slate-700">保存</button>
    <a href="{% url 'dividend_list' %}" class="px-4 py-2 rounded-lg border border-slate-600">一覧へ戻る</a>
  </div>
</form>

<script>
  // Holdingを選んだら ticker/name を薄く補完（空欄のときだけ）
  (function(){
    const sel = document.getElementById("id_holding");
    const tck = document.getElementById("id_ticker");
    const nam = document.getElementById("id_name");
    if (!sel) return;
    sel.addEventListener("change", ()=>{
      const opt = sel.selectedOptions[0];
      if (!opt) return;
      const txt = opt.textContent || "";
      // ラベルが「銘柄名 (CODE)」形式ならざっくり抽出（フォーム側でoptions整えてもOK）
      const m = txt.match(/\(([^)]+)\)/);
      const code = m ? m[1] : "";
      if (!tck.value && code) tck.value = code;
      if (!nam.value) {
        const nameOnly = txt.replace(/\s*\([^)]+\)\s*$/, "");
        if (nameOnly) nam.value = nameOnly;
      }
    });
  })();
</script>
{% endblock %}