{% extends "base.html" %}
{% block title %}配当を記録{% endblock %}

{% block head %}
<style>
  /* カード */
  .form-card{
    display:grid; gap:16px; padding:18px;
    border-radius:16px; background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08);
    max-width:680px; margin:0 auto;
  }
  /* フィールド共通 */
  .fi label{ display:block; font-size:13px; color:#a7b0c0; margin:0 0 6px; }
  .fi input, .fi select, .fi textarea{
    width:100%; padding:12px 14px; font-size:16px; line-height:1.25;
    border-radius:12px; border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06); color:#e8eeff; outline:none;
  }
  .fi input::placeholder, .fi textarea::placeholder{ color:#9aa3b2; }
  .fi textarea{ min-height:96px; resize:vertical; }
  .hint{ font-size:12px; color:#8a93a6; margin-top:6px; }

  /* グリッド */
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  @media (max-width: 420px){ .grid-2{ grid-template-columns:1fr; } }

  /* 税率＋税込行を整える */
  .tax-row{ display:grid; grid-template-columns:1fr auto; gap:12px; align-items:end; }
  @media (max-width: 420px){
    .tax-row{ grid-template-columns:1fr; }
  }
  .chk-line{
    display:flex; align-items:center; gap:10px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06); color:#e8eeff;
    border-radius:12px; padding:12px 14px; height:48px;
  }
  .chk-line input[type="checkbox"]{ width:18px; height:18px; }

  /* ボタン */
  .btn-bar{ display:flex; gap:12px; margin-top:4px; }
  .btn-bar button, .btn-bar a{
    flex:1; text-align:center; padding:12px; border-radius:12px;
    border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.08);
    color:#e8eeff; text-decoration:none;
  }
  .btn-bar button:hover, .btn-bar a:hover{ background:rgba(255,255,255,.16); }

  .error-box{ padding:10px; border:1px solid #ff9aa9; background:#2b1f24; color:#ffd1d1; border-radius:8px; font-size:14px; }
</style>
{% endblock %}

{% block content %}
<h1 class="text-xl font-semibold mb-3">配当を記録</h1>

<form method="post" class="form-card" novalidate>
  {% csrf_token %}

  <!-- 保有（任意） -->
  <div class="fi">
    <label>保有（任意）</label>
    {{ form.holding }}
    <div class="hint">未登録の銘柄でも、下のティッカー/銘柄名で直接登録できます</div>
  </div>

  <!-- ティッカー / 銘柄名 -->
  <div class="fi">
    <label>ティッカー/コード（保有未選択時は必須） <span class="hint">例: 7203 / 167A</span></label>
    {{ form.ticker }}
  </div>
  <div class="fi">
    <label>銘柄名（任意・自動補完／手入力可）</label>
    {{ form.name }}
    <div class="hint">ティッカー入力後、自動で補完されます（取得できない場合は手入力）</div>
  </div>

  <!-- 受取日 / 受取額 -->
  <div class="grid-2">
    <div class="fi">
      <label>受取日</label>
      {{ form.date }}
    </div>
    <div class="fi">
      <label>受取額（税引後）</label>
      {{ form.amount }}
    </div>
  </div>

  <!-- 税率 / 税込-税引後 -->
  <div class="tax-row">
    <div class="fi">
      <label>税率</label>
      {{ form.tax_rate }}
    </div>
    <div class="fi">
      <label>税込/税引後</label>
      <div class="chk-line">
        {{ form.is_net }} <span>チェックON＝税引後（デフォルト）</span>
      </div>
    </div>
  </div>

  <!-- メモ -->
  <div class="fi">
    <label>メモ</label>
    {{ form.memo }}
  </div>

  {% if form.errors %}
    <div class="error-box">入力に誤りがあります。確認してください。</div>
  {% endif %}

  <div class="btn-bar">
    <button type="submit">保存</button>
    <a href="{% url 'dividend_list' %}">一覧へ戻る</a>
  </div>
</form>

<!-- ティッカー → 銘柄名 自動補完 -->
<script>
(function(){
  const endpoint = "{% url 'dividend_lookup_name' %}";
  const $ticker = document.getElementById("id_ticker");
  const $name   = document.getElementById("id_name");
  if (!$ticker || !$name) return;

  let userEditedName = false;
  let nameAutofilled = false;
  let lastCode = "";

  $name.addEventListener("input", ()=>{ userEditedName = true; nameAutofilled = false; });

  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a), ms); } }

  function applyName(nm){
    if (!nm) return;
    const curName = ($name.value||"").trim();
    const canOverwrite = !userEditedName || nameAutofilled || !curName;
    if (canOverwrite){ $name.value = nm; nameAutofilled = true; userEditedName = false; }
  }

  function lookup(){
    const raw = ($ticker.value||"").trim();
    if (!raw || raw === lastCode) return;
    lastCode = raw;
    fetch(`${endpoint}?q=${encodeURIComponent(raw)}`, {credentials:"same-origin"})
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(j => applyName(j && j.name))
      .catch(()=>{});
  }

  $ticker.addEventListener("input",  debounce(lookup, 220));
  $ticker.addEventListener("change", lookup);
  $ticker.addEventListener("blur",   lookup);
})();
</script>
{% endblock %}