{% extends "base.html" %}
{% load static %}

{% block title %}配当を記録{% endblock %}

{% block head %}
<style>
  /* ----- 見やすさ強化 ----- */
  .card{background:rgba(18,24,33,.96);border:1px solid rgba(255,255,255,.10);border-radius:14px;
        padding:14px 14px 18px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .fld{margin:10px 0 12px}
  .lbl{display:block;font-size:13px;color:#b9c3dc;margin:6px 0 6px}
  .in, .sel, .chkwrap input[type="checkbox"]{
      width:100%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.16);
      color:#e8eeff;border-radius:12px;padding:12px 12px;font-size:15px;line-height:1.2
  }
  .sel{appearance:none}
  .hint{font-size:12px;color:#90a1c2;margin-top:6px}
  .actions{display:flex;gap:10px;margin-top:14px}
  .btn{flex:1;padding:12px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.16)}
  .btn.primary{background:#2748ff;border-color:#3453ff;color:#fff}
  .btn.ghost{background:transparent;color:#e6ecff}
  .note{font-size:12px;color:#91a0bd}
</style>
{% endblock %}

{% block content %}
<h1 class="text-xl font-semibold mb-3">配当を記録</h1>

<div class="card">
  <form method="post" novalidate>
    {% csrf_token %}

    <!-- 保有（任意） -->
    <div class="fld">
      <label class="lbl">保有（任意）</label>
      {{ form.holding|add_class:"sel" }}
      <div class="hint">未登録の銘柄でも下のティッカー/銘柄名で直接登録できます</div>
    </div>

    <!-- ティッカー / 銘柄名 -->
    <div class="fld">
      <label class="lbl">ティッカー/コード（保有未選択時は必須）</label>
      {{ form.ticker|add_class:"in" }}
    </div>
    <div class="fld">
      <label class="lbl">銘柄名（任意・自動補完/手入力可）</label>
      {{ form.name|add_class:"in" }}
      <div class="hint">コード入力後に自動補完を試みます（見つからない場合は手入力してください）</div>
    </div>

    <!-- 受取日 / 受取額 -->
    <div class="row">
      <div class="fld">
        <label class="lbl">受取日</label>
        {{ form.date|add_class:"in" }}
      </div>
      <div class="fld">
        <label class="lbl">受取額（税引後）</label>
        {{ form.amount|add_class:"in" }}
      </div>
    </div>

    <!-- 税率 / 税込 or 税引後 -->
    <div class="row">
      <div class="fld">
        <label class="lbl">税率</label>
        {{ form.tax_rate|add_class:"sel" }}
      </div>
      <div class="fld">
        <label class="lbl">税込/税引後</label>
        <div class="chkwrap">
          {{ form.is_net }}
        </div>
        <div class="hint">チェックON＝税引後（デフォルト）</div>
      </div>
    </div>

    <!-- メモ -->
    <div class="fld">
      <label class="lbl">メモ</label>
      {{ form.memo|add_class:"in" }}
    </div>

    <div class="actions">
      <button class="btn primary" type="submit">保存</button>
      <a class="btn ghost" href="{% url 'dividend_list' %}">一覧へ戻る</a>
    </div>

    <p class="note mt-2">コード入力で銘柄名が自動補完されます。必要なら上書きしてください。</p>
  </form>
</div>

<!-- 自動補完用JS：holding に関係なくティッカー/銘柄名は常に編集可能 -->
<script>
  (function(){
    const $ = s => document.querySelector(s);
    const code = document.getElementById("id_ticker");
    const name = document.getElementById("id_name");
    const holding = document.getElementById("id_holding");

    // どの状態でも編集可能に（誤って disabled にされないよう明示）
    [code, name].forEach(el => { if (el){ el.removeAttribute("disabled"); el.readOnly = false; } });

    // ティッカー入力→銘柄名をゆるく補完
    function lookupName(q){
      if (!q || q.trim().length < 3) return;
      fetch("{% url 'dividend_lookup_name' %}?q=" + encodeURIComponent(q.trim()))
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(j => {
          if (j && j.name && !name.value.trim()){
            name.value = j.name;
          }
        })
        .catch(() => {});
    }
    if (code){
      code.addEventListener("blur", () => lookupName(code.value));
      code.addEventListener("change", () => lookupName(code.value));
    }

    // 保有を選んでもティッカー/銘柄名はロックしない（いつでも上書き可）
    if (holding){
      holding.addEventListener("change", () => {
        // ここでは何もしない：ユーザーの手で自由に入力させる
      });
    }
  })();
</script>
{% endblock %}