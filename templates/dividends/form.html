{% extends "base.html" %}
{% load static %}
{% block title %}配当を記録{% endblock %}

{% block head %}
<style>
  .card    {padding:18px;border:1px solid rgba(255,255,255,.08);border-radius:16px;background:rgba(255,255,255,.04);max-width:680px;margin:0 auto}
  .fi      {margin:10px 0}
  .lbl     {display:block;font-size:13px;color:#9aa4b2;margin:0 0 6px}
  .in,.sel {width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:#e6ebff;font-size:16px}
  .row-2   {display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media (max-width:480px){ .row-2{grid-template-columns:1fr} }
  .hint    {font-size:12px;color:#8b93a7;margin-top:6px}
  .btns    {display:flex;gap:12px;margin-top:14px}
  .btns .btn{flex:1;text-align:center;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);color:#e6ebff;text-decoration:none}
  .btns .btn:hover{background:rgba(255,255,255,.12)}

  /* 税率トグル（見やすい行） */
  .tax-row{display:flex;gap:12px;align-items:center}
  .tax-row .toggle{
    display:flex;align-items:center;gap:10px;
    width:100%;padding:12px;border-radius:12px;
    border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);
    color:#e6ebff;font-size:15px
  }
  .tax-row .toggle input[type="checkbox"]{width:18px;height:18px}
  .subnote{font-size:12px;color:#8b93a7}
</style>
{% endblock %}

{% block content %}
<h1 class="text-xl font-semibold mb-3">配当を記録</h1>

<form method="post" class="card" novalidate>
  {% csrf_token %}

  <!-- 保有（任意） -->
  <div class="fi">
    <label class="lbl">保有（任意）</label>
    {{ form.holding }}
    <div class="hint">未登録の銘柄でも、下のティッカー/銘柄名で直接登録できます</div>
  </div>

  <!-- ティッカー / 銘柄名 -->
  <div class="fi">
    <label class="lbl">ティッカー/コード（保有未選択時は必須） 例: 7203 / 167A</label>
    {{ form.ticker }}
  </div>
  <div class="fi">
    <label class="lbl">銘柄名（任意・自動補完／手入力可）</label>
    {{ form.name }}
    <div class="hint">ティッカー入力後、自動で補完されます（取得できない場合は手入力）</div>
  </div>

  <!-- 受取日 / 受取額 -->
  <div class="row-2">
    <div class="fi">
      <label class="lbl">受取日</label>
      {{ form.date }}
    </div>
    <div class="fi">
      <label class="lbl">受取額（税引後）</label>
      {{ form.amount }}
    </div>
  </div>

  <!-- 税率（チェックボックスON=20.315% / OFF=0%） -->
  <div class="fi">
    <label class="lbl">税率</label>
    <label class="toggle">
      {{ form.apply_tax }}
      <span>国内源泉 20.315% を適用</span>
    </label>
    <div class="subnote">OFF にすると課税なし（0%）として登録されます</div>
  </div>

  <!-- 隠し項目: 税引後固定 / 計算済み税額 -->
  {{ form.is_net }}
  {{ form.tax }}

  <div class="fi">
    <label class="lbl">メモ</label>
    {{ form.memo }}
  </div>

  <div class="btns">
    <button class="btn" type="submit">保存</button>
    <a class="btn" href="{% url 'dividend_list' %}">一覧へ戻る</a>
  </div>
</form>

<script>
(function(){
  // コード→銘柄名 自動補完（既存の /api/ticker-name を利用）
  const endpoint = "{% url 'api_ticker_name' %}";
  const $ticker  = document.getElementById('id_ticker');
  const $name    = document.getElementById('id_name');
  if (!$ticker || !$name) return;

  let edited = false, last = {code:"", name:""};

  $name.addEventListener('input', ()=> edited = true);

  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
  function apply(data){
    if (!data || !data.name) return;
    const curCode = ($ticker.value||'').trim();
    const curName = ($name.value||'').trim();
    const canOverwrite = !edited || !curName || curName === last.name;
    if (canOverwrite){
      $name.value = data.name;
      last = {code: curCode, name: data.name};
      edited = false;
    }
  }
  function lookup(){
    const v = ($ticker.value||'').trim();
    if (!v) return;
    fetch(`${endpoint}?code=${encodeURIComponent(v)}`, {credentials:'same-origin'})
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(apply).catch(()=>{});
  }
  $ticker.addEventListener('input', debounce(lookup, 250));
  $ticker.addEventListener('change', lookup);
  $ticker.addEventListener('blur',   lookup);
})();
</script>
{% endblock %}