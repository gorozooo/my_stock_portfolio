{% extends "base.html" %}
{% load static %}

{% block title %}配当を記録{% endblock %}

{% block head %}
<style>
  /* 保有フォームに寄せた見た目 */
  .form-card{
    display:grid; gap:16px; padding:18px;
    border-radius:16px; background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.08);
    max-width:600px; margin:0 auto;
  }
  .fi label{ display:block; font-size:13px; color:#9aa4b2; margin-bottom:6px; }
  .hint{ font-size:12px; color:#8a93a5; margin-top:6px; }
  .fi input,.fi select,.fi textarea{
    width:100%; padding:10px 12px; font-size:15px;
    border-radius:12px; border:1px solid rgba(255,255,255,.16);
    background:rgba(255,255,255,.06); color:#e6ebff; outline:none;
  }
  .fi textarea{ min-height:96px; resize:vertical; line-height:1.5; }
  .grid-2{ display:grid; gap:12px; grid-template-columns:repeat(2, minmax(0,1fr)); }
  .btn-bar{ display:flex; gap:12px; margin-top:4px; }
  .btn-bar button,.btn-bar a{
    flex:1; text-align:center; padding:12px; border-radius:12px;
    border:1px solid rgba(255,255,255,.16); background:rgba(255,255,255,.06);
    color:#e6ebff; text-decoration:none;
  }
  .btn-bar button:hover,.btn-bar a:hover{ background:rgba(255,255,255,.12); }
</style>
{% endblock %}

{% block content %}
<h1 class="text-xl font-semibold mb-3">配当を記録</h1>

<form method="post" class="form-card" novalidate>
  {% csrf_token %}

  <!-- 保有（任意） -->
  <div class="fi">
    <label>保有（任意）</label>
    {{ form.holding }}
    <div class="hint">未登録の銘柄でも、下のティッカー/銘柄名で直接登録できます</div>
  </div>

  <!-- ティッカー / 銘柄名（保有未選択時はここで登録） -->
  <div class="fi">
    <label>ティッカー/コード（保有未選択時は必須） <span class="hint">例: 7203 / 167A</span></label>
    <!-- 数字＋英字を許容。headコード(3〜5桁/英数)想定 -->
    <input id="id_ticker" name="ticker" type="text"
           inputmode="text" pattern="[0-9A-Za-z]{3,6}"
           placeholder="7203 / 167A"
           value="{{ form.ticker.value|default_if_none:'' }}">
  </div>

  <div class="fi">
    <label>銘柄名（任意・自動補完／手入力可）</label>
    <input id="id_name" name="name" type="text" placeholder="自動補完／手入力可"
           value="{{ form.name.value|default_if_none:'' }}">
    <div class="hint">ティッカー入力後、自動で補完されます（取得できない場合は手入力）</div>
  </div>

  <!-- 受取日 / 受取額 -->
  <div class="grid-2">
    <div class="fi">
      <label>受取日</label>
      {{ form.date }}
    </div>
    <div class="fi">
      <label>受取額（税引後）</label>
      {{ form.amount }}
    </div>
  </div>

  <!-- 税率 / 税込フラグ -->
  <div class="grid-2">
    <div class="fi">
      <label>税率</label>
      {{ form.tax_rate }}
    </div>
    <div class="fi" style="display:flex;align-items:center;gap:10px">
      <label style="margin:0">税込/税引後</label>
      {{ form.is_net }}
      <span class="hint">チェックON＝税引後（デフォルト）</span>
    </div>
  </div>

  <!-- メモ -->
  <div class="fi">
    <label>メモ</label>
    {{ form.memo }}
  </div>

  <div class="btn-bar">
    <button type="submit">保存</button>
    <a href="{% url 'dividend_list' %}">一覧へ戻る</a>
  </div>
</form>

<script>
(function(){
  // 保有フォームと同等の「コード→自動銘柄名」ロジック
  const endpoint = "{% url 'dividend_lookup_name' %}";
  const $ticker  = document.getElementById('id_ticker');
  const $name    = document.getElementById('id_name');
  const $holding = document.getElementById('id_holding');

  // 保有選択 → optionテキストから ticker/name を補完（空欄のときのみ）
  $holding?.addEventListener('change', ()=>{
    const opt = $holding.options[$holding.selectedIndex];
    if (!opt) return;
    if ($ticker && !$ticker.value && opt.textContent){
      const m = opt.textContent.trim().match(/^([0-9A-Z]{3,6})\s+/);
      if (m) $ticker.value = m[1];
    }
    if ($name && !$name.value){
      const txt = opt.textContent.trim();
      const sp  = txt.indexOf(" ");
      if (sp > 0) $name.value = txt.slice(sp+1);
    }
  });

  let userEditedName = false;
  let nameAutofilled = false;
  let lastResolved   = { code:"", name:"" };

  $name?.addEventListener('input', ()=>{
    userEditedName = true;
    nameAutofilled = false;
  });

  function debounce(fn, ms){
    let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), ms); };
  }

  function applyName(data){
    if (!data || !data.name) return;
    const curCode = ($ticker.value || '').trim();
    const curName = ($name.value  || '').trim();
    const codeChanged = data.code && data.code !== lastResolved.code;
    const safeToOverwrite =
      !userEditedName || nameAutofilled || !curName || curName === lastResolved.name;

    if (codeChanged || safeToOverwrite) {
      if (data.code) $ticker.value = data.code;
      $name.value = data.name;
      nameAutofilled = true;
      userEditedName = false;
      lastResolved = { code: data.code || curCode, name: data.name };
    }
  }

  function lookup(){
    const v = ($ticker.value || '').trim();
    if (!v) return;
    fetch(`${endpoint}?q=${encodeURIComponent(v)}`, {credentials:'same-origin'})
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(applyName)
      .catch(()=>{});
  }

  $ticker?.addEventListener('input',  debounce(lookup, 250));
  $ticker?.addEventListener('change', lookup);
  $ticker?.addEventListener('blur',   lookup);
})();
</script>
{% endblock %}