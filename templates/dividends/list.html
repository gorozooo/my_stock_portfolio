{% extends "base.html" %}
{% load static %}
{% block title %}配当一覧{% endblock %}

{% block head %}
<style>
  :root{
    --bg-card: rgba(255,255,255,.04);
    --bd-card: rgba(255,255,255,.10);
    --txt-main: #e8edff;
    --txt-sub : #9aa4b2;
    --pill-bg : rgba(255,255,255,.06);
    --pill-bd : rgba(255,255,255,.16);
    --accent  : #6ea8ff;
    --danger  : #ff6b6b;
  }

  .wrap{max-width:1000px;margin:0 auto;padding-inline:6px}

  /* タイトル & 追加ボタン */
  .headerbar{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    margin:8px 0 14px;
  }
  .title{
    font-size:22px; font-weight:700; color:var(--txt-main); letter-spacing:.2px;
  }
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:.5em;
    padding:10px 14px;border-radius:12px;
    background:var(--pill-bg); border:1px solid var(--pill-bd);
    color:var(--txt-main); text-decoration:none; font-weight:600;
  }
  .btn:hover{ background:rgba(255,255,255,.10) }
  .btn.small{ padding:8px 10px;font-weight:600 }
  .btn.ghost{ background:transparent }
  .btn.danger{ background:rgba(255,0,0,.07); border-color:rgba(255,0,0,.22); color:#ffd5d5 }
  .btn.danger:hover{ background:rgba(255,0,0,.12) }

  /* サマリー（横スクロール可） */
  .stats{
    display:flex; gap:10px; overflow:auto; padding-bottom:6px; margin-bottom:12px;
    scroll-snap-type:x proximity;
  }
  .stat{
    min-width:180px; flex:0 0 auto; scroll-snap-align:start;
    padding:12px 14px;border-radius:14px;
    background:var(--bg-card); border:1px solid var(--bd-card);
  }
  .stat .label{font-size:12px;color:var(--txt-sub);margin-bottom:4px}
  .stat .value{font-size:18px;font-variant-numeric:tabular-nums;color:var(--txt-main);font-weight:700}

  /* リスト */
  .list{ display:grid; gap:12px }
  .item{
    display:grid; grid-template-columns: 1fr auto; gap:12px;
    padding:14px;border-radius:16px;
    background:var(--bg-card); border:1px solid var(--bd-card);
  }
  @media (max-width:640px){ .item{ grid-template-columns:1fr } }

  .left .name{
    font-size:18px; font-weight:700; color:var(--txt-main); letter-spacing:.2px;
  }
  .left .date{ font-size:12px; color:var(--txt-sub); margin-top:2px }

  /* バッジ群 */
  .badges{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
  .badge{
    padding:6px 10px; border-radius:999px; font-size:12px;
    background:var(--pill-bg); border:1px solid var(--pill-bd); color:#cfd7ff;
  }

  /* 金額カラム */
  .money{
    text-align:right; align-self:center; min-width:210px;
  }
  .money .net{
    font-size:20px; font-weight:800; color:var(--txt-main);
    font-variant-numeric:tabular-nums;
  }
  .money .labels{ font-size:11px; color:var(--txt-sub); margin-top:2px }

  /* メモ & アクション */
  .memo{ margin-top:8px; font-size:13px; color:#cfd4eb }
  .actions{ display:flex; gap:8px; margin-top:10px }

  /* 空表示 */
  .empty{
    padding:28px;text-align:center;color:var(--txt-sub);
    border:1px dashed var(--bd-card); border-radius:16px;
    background:rgba(255,255,255,.02);
  }

  /* モーダル */
  .modal-mask{position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.55); backdrop-filter: blur(2px); z-index:100050}
  .modal-mask.show{ display:flex }
  .modal{
    width:min(520px,92vw); background:#141827; color:var(--txt-main);
    border:1px solid var(--bd-card); border-radius:16px; padding:18px;
  }
  .modal h3{ margin:0 0 6px; font-size:18px; font-weight:700 }
  .modal .desc{ font-size:13px; color:var(--txt-sub); margin-bottom:12px }
  .modal .btns{ display:flex; gap:10px; justify-content:flex-end }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="headerbar">
    <div class="title">配当一覧</div>
    <a class="btn" href="{% url 'dividend_create' %}">＋ 配当を記録</a>
  </div>

  <div class="stats">
    <div class="stat">
      <div class="label">件数</div>
      <div class="value">{{ items|length }} 件</div>
    </div>
    <div class="stat">
      <div class="label">税引前合計</div>
      <div class="value">{{ total_gross|floatformat:2 }}</div>
    </div>
    <div class="stat">
      <div class="label">税額合計</div>
      <div class="value">{{ total_tax|floatformat:2 }}</div>
    </div>
    <div class="stat">
      <div class="label">税引後合計</div>
      <div class="value">{{ total_net|floatformat:2 }}</div>
    </div>
  </div>

  {% if not items %}
    <div class="empty">まだ配当がありません。右上の「＋ 配当を記録」から登録してください。</div>
  {% else %}
    <div class="list">
      {% for it in items %}
      <div class="item">
        <div class="left">
          <div class="name">
            {{ it.display_ticker }}{% if it.display_name %} / {{ it.display_name }}{% endif %}
          </div>
          <div class="date">{{ it.date|date:"Y-m-d" }}</div>

          <div class="badges">
            {% if it.broker %}
              <span class="badge">証券: {{ it.get_broker_display|default:it.broker }}</span>
            {% endif %}
            {% if it.account %}
              <span class="badge">口座: {{ it.get_account_display|default:it.account }}</span>
            {% endif %}
            {% if it.quantity %}
              <span class="badge">株数: {{ it.quantity }}</span>
            {% endif %}
            {% if it.purchase_price %}
              <span class="badge">取得単価: {{ it.purchase_price }}</span>
            {% endif %}
          </div>

          {% if it.memo %}
            <div class="memo">{{ it.memo }}</div>
          {% endif %}

          <div class="actions">
            <a class="btn small" href="{% url 'dividend_edit' it.id %}">編集</a>
            <button
              type="button"
              class="btn small danger js-del"
              data-url="{% url 'dividend_delete' it.id %}"
              data-title="{{ it.display_ticker }}{% if it.display_name %} / {{ it.display_name }}{% endif %}"
              data-date="{{ it.date|date:'Y-m-d' }}"
              data-net="{{ it.net_amount|floatformat:2 }}"
            >削除</button>
          </div>
        </div>

        <div class="money">
          <div class="net">税引後 {{ it.net_amount|floatformat:2 }}</div>
          <div class="labels">税引前 {{ it.gross_amount|floatformat:2 }} ／ 税額 {{ it.tax|default:0|floatformat:2 }}</div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% endif %}
</div>

<!-- 削除POST用の隠しフォーム（CSRF付き） -->
<form id="delForm" method="post" style="display:none">
  {% csrf_token %}
</form>

<!-- 確認モーダル -->
<div class="modal-mask" id="delModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="delTitle">
    <h3 id="delTitle">配当を削除しますか？</h3>
    <div class="desc" id="delDesc"></div>
    <div class="btns">
      <button type="button" class="btn ghost" id="delCancel">キャンセル</button>
      <button type="button" class="btn danger" id="delOk">削除する</button>
    </div>
  </div>
</div>

<script>
(function(){
  const modal = document.getElementById('delModal');
  const desc  = document.getElementById('delDesc');
  const btnOk = document.getElementById('delOk');
  const btnCancel = document.getElementById('delCancel');
  const form  = document.getElementById('delForm');

  let pendingUrl = null;

  function openModal(payload){
    pendingUrl = payload.url;
    desc.textContent = `${payload.title} ／ ${payload.date} ／ 税引後 ${payload.net}`;
    modal.classList.add('show');
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden','true');
    pendingUrl = null;
  }

  document.querySelectorAll('.js-del').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      openModal({
        url: btn.dataset.url,
        title: btn.dataset.title || '',
        date: btn.dataset.date || '',
        net: btn.dataset.net || ''
      });
    });
  });

  btnCancel.addEventListener('click', closeModal);
  modal.addEventListener('click', (e)=>{ if (e.target === modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeModal(); });

  btnOk.addEventListener('click', ()=>{
    if (!pendingUrl) return closeModal();
    form.setAttribute('action', pendingUrl);
    form.submit();
  });
})();
</script>
{% endblock %}