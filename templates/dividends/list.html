{% extends "base.html" %}
{% load static %}
{% block title %}配当一覧{% endblock %}

{% block head %}
<style>
  .kpis{
    display:grid;gap:12px;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    max-width:960px;margin:0 auto 16px
  }
  .kpi{
    border:1px solid rgba(255,255,255,.09);
    background:rgba(255,255,255,.04);
    border-radius:12px;padding:10px
  }
  .kpi .lbl{font-size:12px;color:#9aa4b2;margin-bottom:2px}
  .kpi .val{font-size:18px;font-weight:700}

  .filter{
    max-width:960px;margin:0 auto 14px;
    display:grid;gap:8px;grid-template-columns:1fr 1fr 1fr 1.4fr .8fr;
  }
  @media (max-width:860px){
    .filter{grid-template-columns:1fr 1fr 1fr}
    .filter .more{grid-column:1/-1;display:flex;gap:8px}
  }
  .filter select,.filter input,.filter button,.filter a{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);color:#eaf0ff;text-decoration:none;text-align:center
  }

  .list{max-width:960px;margin:0 auto;display:grid;gap:10px}

  /* swipe */
  [data-swipe]{
    position:relative;border:1px solid rgba(255,255,255,.09);
    background:rgba(255,255,255,.04);border-radius:12px;overflow:hidden
  }
  /* ← track は z-index:1、actions を必ず前面に出す */
  [data-swipe] .track{position:relative;z-index:1;padding:12px 12px 10px}
  [data-swipe] .actions{
    position:absolute; inset:0 0 0 auto; width:180px; display:flex;
    transform:translateX(100%); transition:transform .16s ease;
    pointer-events:none; z-index:3; /* ← これが効く */
  }
  [data-swipe] .actions .pane{flex:1;display:flex;align-items:center;justify-content:center}
  [data-swipe] .actions .pane a, [data-swipe] .actions .pane button{pointer-events:auto}
  [data-swipe] .actions .edit{background:rgba(39,71,109,.55);color:#eaf3ff}
  [data-swipe] .actions .del{background:rgba(127,35,44,.55);color:#ffeaf0}
  [data-swipe].is-open .actions{
    transform:translateX(0);
    pointer-events:auto; /* JS が死んでも押せる保険 */
  }

  .title{font-size:15px;font-weight:700;margin-bottom:2px}
  .date{font-size:12px;color:#9aa4b2;margin-bottom:6px}
  .meta-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px}
  .chip{padding:4px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.16);
        background:rgba(255,255,255,.06);font-size:11px}
  .nums{display:flex;justify-content:space-between;align-items:baseline;margin-top:2px;gap:8px}
  .net{font-size:16px;font-weight:700}
  .sub{color:#9aa4b2;font-size:11px;white-space:nowrap}

  /* pagination */
  .pager{max-width:960px;margin:14px auto 4px;display:flex;justify-content:center;gap:10px;align-items:center}
  .pager a,.pager span.badge{
    padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.05);color:#e6ebff;text-decoration:none;font-size:14px
  }
  .pager a:hover{background:rgba(255,255,255,.12)}
  .pager .muted{color:#9aa4b2}
</style>
{% endblock %}

{% block content %}
<h1 class="text-xl font-semibold mb-3">配当一覧</h1>

<!-- フィルタバー -->
<form class="filter" method="get">
  <select name="year">
    <option value="">年(すべて)</option>
    {% for y in year_options %}
      <option value="{{ y }}" {% if flt.year|default:'' == y|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
    {% endfor %}
  </select>
  <select name="broker">
    <option value="">証券会社(すべて)</option>
    {% for val,label in BROKERS %}
      <option value="{{ val }}" {% if flt.broker == val %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
  </select>
  <select name="account">
    <option value="">口座(すべて)</option>
    {% for val,label in ACCOUNTS %}
      <option value="{{ val }}" {% if flt.account == val %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
  </select>
  <div class="more">
    <input type="search" name="q" value="{{ flt.q }}" placeholder="銘柄/コード/キーワード">
    <button type="submit">反映</button>
    <a href="{% url 'dividend_list' %}">条件クリア</a>
  </div>
</form>

<!-- KPI -->
<div class="kpis">
  <div class="kpi">
    <div class="lbl">件数</div>
    <div class="val">
      {% if page_obj %}{{ page_obj.paginator.count }}{% else %}{{ items|length }}{% endif %}
    </div>
  </div>
  <div class="kpi"><div class="lbl">税引前合計</div>
    <div class="val">{{ total_gross|default:0|floatformat:0 }}円</div></div>
  <div class="kpi"><div class="lbl">税額合計</div>
    <div class="val">{{ total_tax|default:0|floatformat:0 }}円</div></div>
  <div class="kpi"><div class="lbl">税引後合計</div>
    <div class="val">{{ total_net|default:0|floatformat:0 }}円</div></div>
</div>

<!-- List -->
<div class="list">
  {% for d in items %}
  <div class="row" data-swipe>
    <div class="actions">
      <div class="pane edit">
        <a class="item" href="{% url 'dividend_edit' d.id %}">編集</a>
      </div>
      <div class="pane del">
        <form method="post" action="{% url 'dividend_delete' d.id %}"
              onsubmit="return confirm('削除してよろしいですか？');">
          {% csrf_token %}
          <button type="submit" class="item delete">削除</button>
        </form>
      </div>
    </div>

    <div class="track">
      <div class="title">{{ d.display_ticker }} / {{ d.display_name }}</div>
      <div class="date">{{ d.date|date:"Y年n月j日" }}</div>

      <div class="meta-row">
        {% if d.broker %}
          <span class="chip">{{ d.get_broker_display }}</span>
        {% elif d.holding and d.holding.broker %}
          <span class="chip">{{ d.holding.get_broker_display }}</span>
        {% endif %}

        {% if d.account %}
          <span class="chip">{{ d.get_account_display }}</span>
        {% elif d.holding and d.holding.account %}
          <span class="chip">{{ d.holding.get_account_display }}</span>
        {% endif %}

        {% if d.quantity %}
          <span class="chip">株数: {{ d.quantity }}</span>
        {% endif %}

        {% if d.purchase_price is not None %}
          <span class="chip">取得: {{ d.purchase_price|floatformat:0 }}円</span>
        {% elif d.holding and d.holding.avg_cost is not None %}
          <span class="chip">取得: {{ d.holding.avg_cost|floatformat:0 }}円</span>
        {% endif %}
      </div>

      <div class="nums">
        <div class="net">税引後 {{ d.net_amount|default:0|floatformat:0 }}円</div>
        <div class="sub">
          税引前 {{ d.gross_amount|default:0|floatformat:0 }}円 ／ 税額 {{ d.tax|default:0|floatformat:0 }}円
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <div class="text-slate-400">まだ配当の記録がありません。</div>
  {% endfor %}
</div>

{% if page_obj %}
  <div class="pager">
    {% if page_obj.has_previous %}
      <a href="?page={{ page_obj.previous_page_number }}&year={{ flt.year }}&broker={{ flt.broker }}&account={{ flt.account }}&q={{ flt.q }}">← 前へ</a>
    {% else %}
      <span class="muted">← 前へ</span>
    {% endif %}
    <span class="badge">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
      <a href="?page={{ page_obj.next_page_number }}&year={{ flt.year }}&broker={{ flt.broker }}&account={{ flt.account }}&q={{ flt.q }}">次へ →</a>
    {% else %}
      <span class="muted">次へ →</span>
    {% endif %}
  </div>
{% endif %}

<script src="{% static 'js/dividends.js' %}?v=2"></script>
{% endblock %}