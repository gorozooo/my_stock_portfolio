{% extends "base.html" %}
{% load static %}
{% block title %}配当カレンダー{% endblock %}

{% block head %}
<style>
  .cal-wrap{max-width:980px;margin:0 auto}

  /* フィルター: 2列→広い時は4列 */
  .filters{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:6px}
  .filters select{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);color:#eaf0ff
  }
  @media (min-width:880px){ .filters{grid-template-columns:repeat(4,1fr)} }

  /* 曜日 */
  .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin:10px 2px 6px}
  .dow span{font-size:13px;color:#9aa4b2;text-align:center}

  /* 42セルの骨組み（JSが中身を埋める） */
  .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cell{
    position:relative;height:72px;border-radius:18px;
    background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
    overflow:hidden
  }
  /* 日付は左上 */
  .cell .d{position:absolute;top:7px;left:10px;font-weight:700;color:#cfd7ff;font-size:13px}

  /* —— 件数バッジ（右下、日付に被らない） —— */
  .badge{
    position:absolute;right:8px;bottom:6px;
    min-width:20px; height:20px; padding:0 6px;
    border-radius:10px;
    background:rgba(138,180,255,.18); border:1px solid rgba(164,197,255,.55);
    color:#eaf0ff; font-weight:800; font-size:12px; line-height:20px;
    text-align:center; box-shadow:0 2px 8px rgba(0,0,0,.25);
  }
  .cell.has-items{cursor:pointer}
  .cell.has-items:active{transform:translateY(1px)}

  /* バックドロップ */
  .backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(1px);
    opacity:0;pointer-events:none;transition:opacity .18s ease;
  }
  .backdrop.is-open{opacity:1;pointer-events:auto}

  /* ボトムシート（下タブに被らないよう底上げ） */
  :root{ --sheet-offset: calc(84px + env(safe-area-inset-bottom, 0px)); }
  @media (min-width:880px){ :root{ --sheet-offset: 0px; } } /* PC 等は下固定 */

  .sheet{
    position:fixed;left:0;right:0;bottom:-100%;
    background:rgba(26,33,48,.98);border-top-left-radius:18px;border-top-right-radius:18px;
    border:1px solid rgba(255,255,255,.08);padding:14px 16px 18px;
    max-height:65vh;overflow:auto;transition:bottom .18s ease;
    box-shadow:0 -10px 30px rgba(0,0,0,.35);
  }
  .sheet.is-open{ bottom: var(--sheet-offset); }

  .sheet .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .sheet h3{font-size:16px;font-weight:800;margin:0}
  .sheet .x{
    border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);
    color:#eaf0ff;border-radius:10px;padding:6px 10px
  }
  .sheet .sum{font-weight:800;font-size:16px;margin:8px 0 12px}

  .sheet .list{display:grid;gap:8px}
  .sheet .row{
    display:flex;justify-content:space-between;gap:10px;
    border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);
    border-radius:10px;padding:10px
  }
  .sheet .row .info{min-width:0}
  .sheet .row .name{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sheet .row .meta{margin-top:4px;display:flex;gap:6px;flex-wrap:wrap}
  .sheet .row .chip{
    border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);
    color:#cfd7ff;border-radius:999px;padding:2px 8px;font-size:11px
  }
  .sheet .row .amt{white-space:nowrap;font-weight:800}
</style>
{% endblock %}

{% block content %}
<div class="cal-wrap">

  <form id="calFilter" class="filters">
    <select name="year" id="fYear">
      {% for y in year_options %}<option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>{% endfor %}
    </select>
    <select name="month" id="fMonth">
      {% for m in month_options %}<option value="{{ m }}" {% if month == m %}selected{% endif %}>{{ m }}</option>{% endfor %}
    </select>
    <select name="broker" id="fBroker">
      <option value="">証券会社(すべて)</option>
      {% for v,l in BROKERS %}<option value="{{ v }}" {% if flt.broker == v %}selected{% endif %}>{{ l }}</option>{% endfor %}
    </select>
    <select name="account" id="fAccount">
      <option value="">口座(すべて)</option>
      {% for v,l in ACCOUNTS %}<option value="{{ v }}" {% if flt.account == v %}selected{% endif %}>{{ l }}</option>{% endfor %}
    </select>
  </form>

  <div class="dow"><span>日</span><span>月</span><span>火</span><span>水</span><span>木</span><span>金</span><span>土</span></div>

  <!-- 42 セルの骨組み（JS が上書き） -->
  <div id="cal" class="cal" data-year="{{ year }}" data-month="{{ month }}">
    {% for i in "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" %}
      <div class="cell" data-idx="{{ forloop.counter0 }}"><div class="d"></div></div>
    {% endfor %}
  </div>

  <p style="color:#9aa4b2;margin:12px 4px 0">セルのバッジをタップすると内訳を表示します。</p>
</div>

<!-- backdrop + bottom sheet -->
<div id="backdrop" class="backdrop" aria-hidden="true"></div>
<div id="sheet" class="sheet" aria-hidden="true">
  <div class="head">
    <h3 id="sheetTitle"></h3>
    <button type="button" class="x" id="sheetClose">閉じる</button>
  </div>
  <div class="sum" id="sheetSum"></div>
  <div class="list" id="sheetList"></div>
</div>

<script src="{% static 'js/dividends_calendar.js' %}?v=14"></script>
<script>window.__DIVCAL_INIT__ = {{ payload_json|safe }};</script>
{% endblock %}