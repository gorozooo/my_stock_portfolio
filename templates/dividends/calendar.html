{% extends "base.html" %}
{% load static %}
{% block title %}配当カレンダー{% endblock %}

{% block head %}
<style>
  .cal-wrap{max-width:980px;margin:0 auto}

  /* フィルター: 2列→広い時は4列 */
  .filters{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:6px}
  .filters select{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06);color:#eaf0ff
  }
  @media (min-width:880px){ .filters{grid-template-columns:repeat(4,1fr)} }

  /* 曜日 */
  .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin:10px 2px 6px}
  .dow span{font-size:13px;color:#9aa4b2;text-align:center}

  /* 42セルの骨組み（JSが中身を埋める） */
  .cal{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .cell{
    position:relative;height:72px;border-radius:18px;
    background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);
    overflow:hidden
  }
  /* --- 白丸（中央のリング） --- */
  .cell .d{
    position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
    width:100%;height:100%;
  }
  .cell .d::before{
    content:""; width:42px;height:42px;border-radius:999px;border:2px solid rgba(255,255,255,.85);
    background:transparent; display:block;
  }
  .cell .day{
    position:absolute; top:18px; font-weight:800; color:#e9eeff; font-size:14px; line-height:1;
  }
  .cell .cnt{
    position:absolute; bottom:18px; font-weight:800; color:#0b1020; font-size:12px; line-height:1;
    background:rgba(255,255,255,.85); border-radius:8px; padding:2px 6px; min-width:20px; text-align:center;
    transform:translateY(6px);   /* 白丸の内側下寄せに見えるよう微調整 */
  }
  .cell .d:not(.has-items) .cnt{ display:none; }
  .cell.has-items{cursor:pointer}
  .cell.has-items:active{transform:translateY(1px)}

  /* ボトムシート + バックドロップ */
  .backdrop{
    position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(1px);
    opacity:0;pointer-events:none;transition:opacity .18s ease;
  }
  .backdrop.is-open{opacity:1;pointer-events:auto}

  .sheet{
    position:fixed;left:0;right:0;bottom:-100%;
    background:rgba(26,33,48,.98);border-top-left-radius:18px;border-top-right-radius:18px;
    border:1px solid rgba(255,255,255,.08);padding:14px 16px 18px;max-height:65vh;overflow:auto;
    transition:bottom .18s ease; box-shadow:0 -10px 30px rgba(0,0,0,.35)
  }
  .sheet.is-open{bottom:0}
  .sheet .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .sheet h3{font-size:16px;font-weight:800;margin:0}
  .sheet .x{
    border:1px solid rgba(255,255,255,.16);background:rgba(255,255,255,.06);
    color:#eaf0ff;border-radius:10px;padding:6px 10px
  }
  .sheet .sum{font-weight:800;font-size:16px;margin:8px 0 12px}
  .sheet .list{display:grid;gap:8px}
  .sheet .row{
    display:flex;justify-content:space-between;gap:8px;
    border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.03);
    border-radius:10px;padding:10px 12px
  }
  .sheet .row .name{font-weight:700}
  .sheet .row .amt{white-space:nowrap}
</style>
{% endblock %}

{% block content %}
<div class="cal-wrap">
  <h1 class="text-xl font-semibold mb-3">配当カレンダー</h1>

  <form id="calFilter" class="filters">
    <select name="year" id="fYear">
      {% for y in year_options %}<option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}</option>{% endfor %}
    </select>
    <select name="month" id="fMonth">
      {% for m in month_options %}<option value="{{ m }}" {% if month == m %}selected{% endif %}>{{ m }}</option>{% endfor %}
    </select>
    <select name="broker" id="fBroker">
      <option value="">証券会社(すべて)</option>
      {% for v,l in BROKERS %}<option value="{{ v }}" {% if flt.broker == v %}selected{% endif %}>{{ l }}</option>{% endfor %}
    </select>
    <select name="account" id="fAccount">
      <option value="">口座(すべて)</option>
      {% for v,l in ACCOUNTS %}<option value="{{ v }}" {% if flt.account == v %}selected{% endif %}>{{ l }}</option>{% endfor %}
    </select>
  </form>

  <div class="dow"><span>日</span><span>月</span><span>火</span><span>水</span><span>木</span><span>金</span><span>土</span></div>

  <!-- 42 セルの骨組み（JS が上書き） -->
  <div id="cal" class="cal" data-year="{{ year }}" data-month="{{ month }}">
    {% for i in "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" %}
      <div class="cell" data-idx="{{ forloop.counter0 }}">
        <div class="d">
          <span class="day"></span>
          <span class="cnt"></span>
        </div>
      </div>
    {% endfor %}
  </div>

  <p style="color:#9aa4b2;margin:12px 4px 0">セルのバッジをタップすると内訳を表示します。</p>
</div>

<!-- backdrop + bottom sheet -->
<div id="backdrop" class="backdrop" aria-hidden="true"></div>
<div id="sheet" class="sheet" aria-hidden="true">
  <div class="head">
    <h3 id="sheetTitle"></h3>
    <button type="button" class="x" id="sheetClose">閉じる</button>
  </div>
  <div class="sum" id="sheetSum"></div>
  <div class="list" id="sheetList"></div>
</div>

<script src="{% static 'js/dividends_calendar.js' %}?v=12"></script>
<script>window.__DIVCAL_INIT__ = {{ payload_json|safe }};</script>
{% endblock %}