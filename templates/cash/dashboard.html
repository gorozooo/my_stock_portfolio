{% extends "base.html" %}
{% load static humanize %}
{% block title %}ç¾é‡‘ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %}

{% block content %}
<style>
/* ===== Global ===== */
*,
*::before,
*::after{
  box-sizing:border-box;
}
html,body{
  max-width:100%;
  overflow-x:hidden;
}

/* ===== Layout ===== */
.cash-wrap{
  max-width:980px;
  margin:12px auto 0;
  padding:12px 10px 140px;
}

/* ===== Broker Card ===== */
.grid-broker{
  display:grid;
  grid-template-columns:1fr;
  gap:16px;
}
.card{
  padding:10px 12px 12px;
  border-radius:14px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.08);
  backdrop-filter:blur(8px);
  overflow:hidden;
}
.card h3{
  font-size:15px;
  margin:0 0 8px;
}

/* ===== KPI ===== */
.kpi-row{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
}
.kpi{
  padding:8px 8px;
  border-radius:10px;
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.08);
}
.kpi .head{
  display:flex;
  align-items:center;
  gap:4px;
  margin-bottom:2px;
  min-height:18px;
}
.kpi .label{
  font-size:10px;
  color:#9aa4b2;
  letter-spacing:.03em;
  white-space:nowrap;
}
.kpi .value{
  line-height:1.1;
  display:flex;
  align-items:baseline;
  gap:3px;
}
.kpi .num{
  font-size:13px;
  font-weight:700;
  letter-spacing:.01em;
}
.kpi .unit{
  font-size:11px;
  opacity:.75;
}

/* ä½™åŠ›ã®ãƒ’ãƒ¼ãƒ­ãƒ¼è¡¨ç¤ºï¼‹ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
.hero-kpi{
  padding:10px 10px;
  border-radius:12px;
  background:linear-gradient(135deg,rgba(45,212,191,.15),rgba(56,189,248,.10));
  border:1px solid rgba(45,212,191,.45);
  box-shadow:0 0 0 1px rgba(15,118,110,.35) inset;
  margin-bottom:8px;
}
.hero-kpi.warn{
  background:linear-gradient(135deg,rgba(234,179,8,.18),rgba(248,250,252,.03));
  border-color:rgba(234,179,8,.7);
  box-shadow:0 0 0 1px rgba(202,138,4,.45) inset;
}
.hero-kpi.danger{
  background:linear-gradient(135deg,rgba(248,113,113,.2),rgba(15,23,42,.4));
  border-color:rgba(239,68,68,.85);
  box-shadow:0 0 0 1px rgba(239,68,68,.6) inset;
}
.hero-top{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:8px;
}
.hero-main-label{
  font-size:12px;
  color:#cbd5f5;
  letter-spacing:.05em;
}
.hero-main-value{
  display:flex;
  align-items:baseline;
  gap:4px;
}
.hero-main-num{
  font-size:18px;
  font-weight:800;
  letter-spacing:.03em;
}
.hero-main-unit{
  font-size:11px;
  opacity:.8;
}
.hero-pct{
  font-size:11px;
  color:#e5e7eb;
  opacity:.8;
  white-space:nowrap;
  flex-shrink:0;
}

/* ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
.meter{
  height:6px;
  border-radius:999px;
  background:rgba(148,163,184,.35);
  overflow:hidden;
  margin-top:6px;
}
.meter-inner{
  height:100%;
  border-radius:inherit;
  background:linear-gradient(90deg,#22c55e,#eab308,#ef4444);
  transform-origin:left center;
}

/* å†…è¨³ã®å¼ï¼ˆ3è¡Œã«åˆ†å‰²ï¼‰ */
.hero-sub{
  margin-top:6px;
  font-size:11px;
  color:#a1a8c4;
  line-height:1.4;
}
.hero-sub-label{
  display:inline-block;
  margin-right:4px;
}

/* å°KPIæ è‰² */
.kpi.cash{
  border-color:rgba(125,160,255,.24);
  box-shadow:0 0 0 1px rgba(125,160,255,.10) inset;
}
.kpi.invested{
  border-color:rgba(168,85,247,.32);
  box-shadow:0 0 0 1px rgba(168,85,247,.14) inset;
}
.kpi.restricted{
  border-color:rgba(255,90,90,.26);
  box-shadow:0 0 0 1px rgba(255,255,255,.12) inset;
}

.small{
  font-size:11px;
  margin-top:8px;
  color:#a1a8c4;
}

/* ===== Bottom Action Dock ===== */
.cash-dock{
  position:fixed;
  left:0;
  right:0;
  bottom:0;
  z-index:2000;      /* â˜… ãƒœãƒˆãƒ ã‚¿ãƒ–ã‚ˆã‚Šå‰é¢ã«å‡ºã™ */
  pointer-events:none;
}
.cash-dock .inner{
  pointer-events:auto;
  max-width:980px;
  margin:0 auto;
  padding:8px 12px calc(8px + env(safe-area-inset-bottom));
  background:rgba(13,16,24,.84);
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
  border-top:1px solid rgba(255,255,255,.08);
  border-radius:16px 16px 0 0;
}
.cash-dock .bar{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
}
.cash-dock .bar button{
  padding:10px;
  font-size:14px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.06);
  color:#e6ebff;
  font-weight:600;
}

/* ===== Modal ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100300;
}
.modal.show{display:flex}
.modal .box{
  width:min(520px,92vw);
  background:rgba(20,24,36,.92);
  border:1px solid rgba(255,255,255,.12);
  border-radius:16px;
  padding:16px;
  backdrop-filter:blur(12px);
}
.form-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:10px;
}
.form-grid label{
  font-size:12px;
  color:#9aa4b2;
  display:block;
  margin-bottom:4px;
}
.form-grid select,
.form-grid input{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.06);
  color:#e6ebff;
}
.form-actions{
  display:flex;
  gap:8px;
  justify-content:flex-end;
  margin-top:12px;
}
.btn{
  padding:10px 14px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.05);
  color:#e6ebff;
}
.btn.primary{border-color:rgba(0,255,209,.45)}
.form-note{
  font-size:11px;
  color:#9aa4b2;
  margin-top:6px;
}

/* ===== Responsive (ã‚¹ãƒãƒ›å¹…) ===== */
@media (max-width:480px){
  .cash-wrap{
    padding:12px 8px 140px;
  }
  .hero-top{
    flex-direction:column;
    align-items:flex-start;
  }
  .hero-main-num{
    font-size:16px;
  }
  .hero-pct{
    margin-top:2px;
  }
  .kpi-row{
    grid-template-columns:1fr;
  }
}
</style>

<div class="cash-wrap">
  <h1 style="margin:6px 2px 12px">ğŸ’µ ç¾é‡‘ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆè¨¼åˆ¸ä¼šç¤¾åˆ¥ï¼‰</h1>

  {% if brokers %}
    <div class="grid-broker">
      {% for b in brokers %}
      {% with pct=b.pct_available %}
      <div class="card">
        <h3>{{ b.broker }} è¨¼åˆ¸</h3>

        {# ===== ä½™åŠ›ãƒ’ãƒ¼ãƒ­ãƒ¼ï¼‹ãƒ¡ãƒ¼ã‚¿ãƒ¼ ===== #}
        <div class="hero-kpi
          {% if b.available < 0 %}danger{% elif pct and pct <= 30 and b.available >= 0 %}warn{% endif %}">
          <div class="hero-top">
            <div>
              <div class="hero-main-label">ğŸ’° ä½™åŠ›ï¼ˆä»Šã™ãä½¿ãˆã‚‹è³‡é‡‘ï¼‰</div>
              <div class="hero-main-value">
                <span class="hero-main-num">{{ b.available|intcomma }}</span>
                <span class="hero-main-unit">å††</span>
              </div>
            </div>
            {% if pct is not None %}
              <div class="hero-pct">{{ pct|floatformat:1 }}%</div>
            {% endif %}
          </div>

          {% if pct is not None %}
          <div class="meter">
            {% with raw=pct %}
              {% if raw < 0 %}
                {% with w=0 %}
                  <div class="meter-inner" style="width:{{ w }}%;"></div>
                {% endwith %}
              {% elif raw > 100 %}
                {% with w=100 %}
                  <div class="meter-inner" style="width:{{ w }}%;"></div>
                {% endwith %}
              {% else %}
                <div class="meter-inner" style="width:{{ raw|floatformat:0 }}%;"></div>
              {% endif %}
            {% endwith %}
          </div>
          {% endif %}

          <div class="hero-sub">
            <span class="hero-sub-label">ï¼ ä½™åŠ›ã®å†…è¨³</span><br>
            ãƒ»é ã‚Šé‡‘ {{ b.cash|intcomma }} å††<br>
            ãƒ»å–å¾—åŸä¾¡æ®‹ {{ b.invested_cost|intcomma }} å††<br>
            ãƒ»æ‹˜æŸ {{ b.restricted|intcomma }} å††
          </div>
        </div>

        {# ===== å†…è¨³3ãƒœãƒƒã‚¯ã‚¹ ===== #}
        <div class="kpi-row">
          <div class="kpi cash">
            <div class="head"><div class="label">ğŸ¦ é ã‚Šé‡‘ï¼ˆå£åº§ã®ç¾é‡‘ï¼‰</div></div>
            <div class="value">
              <span class="num">{{ b.cash|intcomma }}</span><span class="unit">å††</span>
            </div>
          </div>

          <div class="kpi invested">
            <div class="head"><div class="label">ğŸ“‰ å–å¾—åŸä¾¡æ®‹ï¼ˆè²·ä»˜æ¸ˆã¿å…ƒæœ¬ï¼‰</div></div>
            <div class="value">
              <span class="num">{{ b.invested_cost|intcomma }}</span><span class="unit">å††</span>
            </div>
          </div>

          <div class="kpi restricted">
            <div class="head"><div class="label">ğŸ”’ æ‹˜æŸé‡‘</div></div>
            <div class="value">
              <span class="num">{{ b.restricted|intcomma }}</span><span class="unit">å††</span>
            </div>
          </div>
        </div>

        <div class="small">ğŸ“… ä»Šæœˆã®å…¥å‡ºé‡‘å·®åˆ†ï¼š{{ b.month_net|intcomma }} å††</div>
      </div>
      {% endwith %}
      {% endfor %}
    </div>
  {% else %}
    <div class="card">ã¾ãšã¯ç®¡ç†ç”»é¢ã§ã€ŒBrokerAccountã€ã‚’ä½œæˆã—ã¦ã­ï¼ˆæ¥½å¤©/æ¾äº•/SBIã®ã©ã‚Œã‹ã§OKï¼‰ã€‚</div>
  {% endif %}
</div>

<!-- === Bottom Action Dock === -->
<div class="cash-dock" aria-label="Cash Actions">
  <div class="inner">
    <div class="bar">
      <button data-open="deposit">å…¥é‡‘</button>
      <button data-open="withdraw">å‡ºé‡‘</button>
      <button data-open="restrict">æ‹˜æŸé‡‘</button>
      <button data-open="tax">ç¨é‡‘</button>
    </div>
  </div>
</div>

<!-- ===== Modals ===== -->
<div class="modal" id="modal-deposit" aria-hidden="true">
  <div class="box">
    <h3>â• å…¥é‡‘</h3>
    <form method="post" action="{% url 'cash_dashboard' %}">
      {% csrf_token %}
      <input type="hidden" name="op" value="deposit">
      <div class="form-grid">
        <div>
          <label>è¨¼åˆ¸ä¼šç¤¾</label>
          <select name="broker" id="dep-broker" required>
            <option value="æ¥½å¤©">æ¥½å¤©è¨¼åˆ¸</option>
            <option value="æ¾äº•">æ¾äº•è¨¼åˆ¸</option>
            <option value="SBI">SBIè¨¼åˆ¸</option>
          </select>
        </div>
        <div>
          <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
          <input type="number" name="amount" inputmode="numeric" min="1" required>
        </div>
        <div>
          <label>ãƒ¡ãƒ¢</label>
          <input type="text" name="memo" placeholder="ä»»æ„">
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" data-close>é–‰ã˜ã‚‹</button>
        <button class="btn primary" type="submit">ä¿å­˜</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="modal-withdraw" aria-hidden="true">
  <div class="box">
    <h3>â– å‡ºé‡‘</h3>
    <form method="post" action="{% url 'cash_dashboard' %}">
      {% csrf_token %}
      <input type="hidden" name="op" value="withdraw">
      <div class="form-grid">
        <div>
          <label>è¨¼åˆ¸ä¼šç¤¾</label>
          <select name="broker" id="wd-broker" required>
            <option value="æ¥½å¤©">æ¥½å¤©è¨¼åˆ¸</option>
            <option value="æ¾äº•">æ¾äº•è¨¼åˆ¸</option>
            <option value="SBI">SBIè¨¼åˆ¸</option>
          </select>
        </div>
        <div>
          <label>é‡‘é¡ï¼ˆå††ï¼‰</label>
          <input type="number" name="amount" inputmode="numeric" min="1" required>
        </div>
        <div>
          <label>ãƒ¡ãƒ¢</label>
          <input type="text" name="memo" placeholder="ä»»æ„">
        </div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" data-close>é–‰ã˜ã‚‹</button>
        <button class="btn primary" type="submit">ä¿å­˜</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="modal-restrict" aria-hidden="true">
  <div class="box">
    <h3>â›” æ‹˜æŸé‡‘ã‚’è¨­å®š</h3>
    <form method="post" action="{% url 'cash_dashboard' %}">
      {% csrf_token %}
      <input type="hidden" name="op" value="restrict">
      <div class="form-grid">
        <div>
          <label>è¨¼åˆ¸ä¼šç¤¾</label>
          <select name="broker" id="rs-broker" required>
            <option value="æ¥½å¤©">æ¥½å¤©è¨¼åˆ¸</option>
            <option value="æ¾äº•">æ¾äº•è¨¼åˆ¸</option>
            <option value="SBI">SBIè¨¼åˆ¸</option>
          </select>
        </div>
        <div>
          <label>æ‹˜æŸé‡‘ï¼ˆå††ï¼‰</label>
          <input type="number" name="amount" inputmode="numeric" min="0" required>
        </div>
      </div>
      <div class="form-note">â€»ä¿å­˜ã™ã‚‹ã¨å½“æ—¥ã®æ‹˜æŸé‡‘ã‚’<strong>ä¸Šæ›¸ã</strong>ã—ã¾ã™ï¼ˆéå»åˆ†ã¯å¤‰æ›´ã—ã¾ã›ã‚“ï¼‰ã€‚</div>
      <div class="form-actions">
        <button type="button" class="btn" data-close>é–‰ã˜ã‚‹</button>
        <button class="btn primary" type="submit">ä¿å­˜</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="modal-tax" aria-hidden="true">
  <div class="box">
    <h3>ğŸ§¾ ç¨é‡‘ï¼ˆæºæ³‰å¾´åï¼‰ã‚’æœˆæ¬¡ã§è¨˜éŒ²</h3>
    <form method="post" action="{% url 'cash_dashboard' %}">
      {% csrf_token %}
      <input type="hidden" name="op" value="tax">
      <div class="form-grid">
        <div>
          <label>è¨¼åˆ¸ä¼šç¤¾</label>
          <select name="broker" id="tx-broker" required>
            <option value="æ¥½å¤©">æ¥½å¤©è¨¼åˆ¸</option>
            <option value="æ¾äº•">æ¾äº•è¨¼åˆ¸</option>
            <option value="SBI">SBIè¨¼åˆ¸</option>
          </select>
        </div>
        <div>
          <label>å¯¾è±¡æœˆ</label>
          <input type="month" name="month" required>
        </div>
        <div>
          <label>ç¨é¡ï¼ˆåˆè¨ˆï¼å††ï¼‰</label>
          {# â˜… ã“ã“ã ã‘ãƒã‚¤ãƒŠã‚¹å¯ã«ã™ã‚‹ #}
          <input
            type="number"
            name="amount"
            inputmode="numeric"
            step="1"
            required
            placeholder="ä¾‹ï¼š-1200"
            pattern="-?[0-9]*"
            id="tax-amount"
          >
        </div>
        <div>
          <label>ãƒ¡ãƒ¢</label>
          <input type="text" name="memo" placeholder="ä»»æ„ï¼ˆä¾‹ï¼šæ‰€å¾—ï¼‹ä½æ°‘ã®åˆç®—ï¼‰">
        </div>
      </div>
      <div class="form-note">â€»å¯¾è±¡æœˆã®<strong>æœˆæœ«æ—¥</strong>ã§ã€Œå‡ºé‡‘ã€ã¨ã—ã¦è¨˜å¸³ã—ã¾ã™ã€‚åŒæœˆãƒ»åŒç¤¾ã¯å†ä¿å­˜ã§ä¸Šæ›¸ãã€‚</div>
      <div class="form-actions">
        <button type="button" class="btn" data-close>é–‰ã˜ã‚‹</button>
        <button class="btn primary" type="submit">ä¿å­˜</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modals = {
    deposit : document.getElementById("modal-deposit"),
    withdraw: document.getElementById("modal-withdraw"),
    restrict: document.getElementById("modal-restrict"),
    tax     : document.getElementById("modal-tax"),
  };
  document.querySelectorAll("[data-open]").forEach(b=>{
    b.addEventListener("click", ()=> show(modals[b.dataset.open]));
  });
  document.querySelectorAll("[data-close]").forEach(b=>{
    b.addEventListener("click", closeAll);
  });

  const act = new URLSearchParams(location.search).get("action");
  if (act && modals[act]) show(modals[act]);

  function show(el){
    if(!el) return;
    el.classList.add("show");
    el.setAttribute("aria-hidden","false");
  }
  function closeAll(){
    document.querySelectorAll(".modal.show").forEach(m=>{
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
    });
  }

  // â˜… ç¨é¡ input ã®ã€Œå…¨è§’ãƒã‚¤ãƒŠã‚¹ã€ãªã©ã‚’è»½ãæ­£è¦åŒ–ï¼ˆé€ä¿¡å‰ï¼‰
  const taxModal = modals.tax;
  if (taxModal) {
    const form = taxModal.querySelector("form");
    const amountEl = taxModal.querySelector("#tax-amount");
    if (form && amountEl) {
      form.addEventListener("submit", () => {
        if (!amountEl.value) return;
        amountEl.value = String(amountEl.value)
          .replace(/[âˆ’ãƒ¼â€•]/g, "-")   // å…¨è§’/é•·éŸ³/ãƒ€ãƒƒã‚·ãƒ¥ç³» -> "-"
          .replace(/[^\d-]/g, "");  // æ•°å­—ã¨ - ä»¥å¤–é™¤å»ï¼ˆå¿µã®ãŸã‚ï¼‰
      });
    }
  }

  const wrap = document.querySelector(".cash-wrap");
  const dock = document.querySelector(".cash-dock");
  const inner = document.querySelector(".cash-dock .inner");
  const bottomTab = document.getElementById("bottomTabRoot");
  const adjust = ()=>{
    const dockH = inner ? inner.getBoundingClientRect().height : 0;
    const tabH  = bottomTab ? bottomTab.getBoundingClientRect().height : 0;
    if(dock){
      dock.style.bottom = tabH + "px";
    }
    if(wrap){
      wrap.style.paddingBottom = (dockH + tabH + 24) + "px";
    }
  };
  adjust();
  window.addEventListener("resize", adjust);
});
</script>
{% endblock %}