{% load humanize %}

{% for r in page.object_list %}
  <div class="card">
    <div class="flex items-start justify-between gap-3">

      {# 左：金額 + メタ + メモ(※システムメモは非表示) #}
      <div class="min-w-0">
        <div class="amount">{{ r.amount|intcomma }} 円</div>

        <div class="meta">
          {{ r.at|default:"" }} ｜ {{ r.account.broker|default:"" }} ｜ 種別：
          {% if r.kind == r.Kind.DEPOSIT %}入金{% elif r.kind == r.Kind.WITHDRAW %}出金
          {% elif r.kind == r.Kind.XFER_IN %}振替(入){% elif r.kind == r.Kind.XFER_OUT %}振替(出)
          {% else %}その他{% endif %}
        </div>

        {# メモが “実現損益/配当” 始まりなら出さない #}
        {% with m=r.memo|default_if_none:"" %}
          {% if m and m|slice:":4" != "実現損益" and m|slice:":2" != "配当" %}
            <div class="memo">{{ m }}</div>
          {% endif %}
        {% endwith %}
      </div>

      {# 右：元データバッジ（常に TICKER 名称 で出す） #}
      <div class="text-right shrink-0">

        {# --- 優先1: src_badge がある #}
        {% if r.src_badge %}
          {% if r.src_badge.kind == "配当" %}
            <span class="{{ r.src_badge.class|default:'chip chip-sky' }}">
              【配当】 {% firstof r.ticker r.code '' %} {% firstof r.company_name r.name r.src_badge.label '' %}
            </span>
          {% elif r.src_badge.kind == "実損" %}
            <span class="{{ r.src_badge.class|default:'chip chip-emerald' }}">
              【実損】 {% firstof r.ticker r.code '' %} {% firstof r.company_name r.name r.src_badge.label '' %}
            </span>
          {% else %}
            <span class="chip">{% firstof r.src_badge.label '取引' %}</span>
          {% endif %}

        {# --- 優先2: source_type で判定 #}
        {% elif r.source_type == r.SourceType.DIVIDEND %}
          <span class="chip chip-sky">
            【配当】 {% firstof r.ticker r.code '' %} {% firstof r.company_name r.name '' %}
          </span>
        {% elif r.source_type == r.SourceType.REALIZED %}
          <span class="chip chip-emerald">
            【実損】 {% firstof r.ticker r.code '' %} {% firstof r.company_name r.name '' %}
          </span>

        {# --- 優先3: メモ先頭でフォールバック判定（これで「取引」を消す） #}
        {% else %}
          {% with m=r.memo|default_if_none:"" %}
            {% if m|slice:":2" == "配当" %}
              <span class="chip chip-sky">
                【配当】 {% firstof r.ticker r.code '' %} {% firstof r.company_name r.name '' %}
              </span>
            {% elif m|slice:":4" == "実現損益" or "REAL:" in m %}
              <span class="chip chip-emerald">
                【実損】 {% firstof r.ticker r.code '' %} {% firstof r.company_name r.name '' %}
              </span>
            {% else %}
              {# 何も判定できない最終保険（極力出ない想定） #}
              <span class="chip">
                {% firstof r.ticker r.code '取引' %} {% firstof r.company_name r.name '' %}
              </span>
            {% endif %}
          {% endwith %}
        {% endif %}

        <div class="actions">
          <a href="{% url 'cash_ledger_edit' r.id %}">編集</a>
          <form method="post" action="{% url 'cash_ledger_delete' r.id %}">
            {% csrf_token %}
            <button>削除</button>
          </form>
        </div>
      </div>

    </div>
  </div>
{% empty %}
  <div class="text-slate-400">該当データがありません。</div>
{% endfor %}