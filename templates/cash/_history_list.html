{% load humanize %}

{% for r in page.object_list %}
  <div class="card" data-ledger-id="{{ r.id }}">
    <div class="flex items-start justify-between gap-3">
      <!-- 左：金額/メタ/メモ -->
      <div class="min-w-0">
        <div class="amount">{{ r.amount|intcomma }} 円</div>
        <div class="meta">
          {{ r.at|default:"" }} ｜ {{ r.account.broker|default:"" }} ｜ 種別：
          {% if r.kind == r.Kind.DEPOSIT %}入金{% elif r.kind == r.Kind.WITHDRAW %}出金
          {% elif r.kind == r.Kind.XFER_IN %}振替(入){% elif r.kind == r.Kind.XFER_OUT %}振替(出)
          {% else %}その他{% endif %}
        </div>
        {% with m=r.memo|default_if_none:"" %}
          {% if m and m|slice:":4" != "実現損益" and m|slice:":2" != "配当" %}
            <div class="memo">{{ m }}</div>
          {% endif %}
        {% endwith %}
      </div>

      <!-- 右：バッジ/操作 -->
      <div class="text-right shrink-0">
        {% if r.src_badge %}
          {% if r.src_badge.kind == "配当" %}
            <span class="{{ r.src_badge.class }}">【配当】 {{ r.src_badge.label }}</span>
          {% elif r.src_badge.kind == "実損" %}
            <span class="{{ r.src_badge.class }}">【実損】 {{ r.src_badge.label }}</span>
          {% endif %}
        {% endif %}
        <div class="actions">
          <a href="{% url 'cash_ledger_edit' r.id %}">編集</a>
          <form method="post" action="{% url 'cash_ledger_delete' r.id %}">
            {% csrf_token %}<button>削除</button>
          </form>
        </div>
      </div>
    </div>
  </div>
{% empty %}
  <div class="text-slate-400">該当データがありません。</div>
{% endfor %}

{# === 無限スクロールの sentinel はここだけに配置（重複発火防止） === #}
{% if cursor %}
  {# カーソル方式（優先） #}
  <div id="more-sentinel-{{ page.number }}"
       class="text-center text-slate-400 py-2 text-[12px]"
       hx-disinherit="*"
       hx-swap="afterend"
       hx-trigger="intersect once threshold:0.2"
       hx-get="{% url 'cash_history_page' %}?cursor_at={{ cursor.0|urlencode }}&cursor_id={{ cursor.1|urlencode }}{% for k,v in params.items %}{% if k != 'page' and k != 'cursor_at' and k != 'cursor_id' %}&{{ k }}={{ v|urlencode }}{% endif %}{% endfor %}"
       hx-on:htmx:beforeRequest="if(this.dataset.busy==='1'){event.preventDefault();return}; this.dataset.busy='1';"
       hx-on:htmx:afterSwap="this.remove()">
    読み込み中…
  </div>
{% elif page.has_next %}
  {# フォールバック：ページ番号方式（万一カーソルが無い場合） #}
  <div id="more-sentinel-{{ page.number }}"
       class="text-center text-slate-400 py-2 text-[12px]"
       hx-disinherit="*"
       hx-swap="afterend"
       hx-trigger="intersect once threshold:0.2"
       hx-get="{% url 'cash_history_page' %}?{% for k,v in params.items %}{% if k != 'page' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page.next_page_number }}"
       hx-on:htmx:beforeRequest="if(this.dataset.busy==='1'){event.preventDefault();return}; this.dataset.busy='1';"
       hx-on:htmx:afterSwap="this.remove()">
    読み込み中…
  </div>
{% endif %}