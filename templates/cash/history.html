{% extends "base.html" %}
{% load humanize %}
{% block title %}ç¾é‡‘å°å¸³{% endblock %}

{% block head %}
<style>
  #topSticky{
    position: sticky; top: env(safe-area-inset-top, 0px); z-index: 12;
    border:1px solid rgba(255,255,255,.12); border-radius:12px;
    background:rgba(15,20,30,.96); backdrop-filter: blur(8px);
    padding:8px; margin:0 0 8px; box-shadow:0 2px 0 rgba(255,255,255,.06) inset;
  }

  .quickbar{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:6px; align-items:center;}
  .qb-ctl,.qb-btn{height:30px; padding:0 8px; font-size:12px; color:#dbe3f4;
                  background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.14);
                  border-radius:8px; min-width:0;}
  input[type="date"].qb-ctl{ color-scheme: dark; }
  .qb-btn{ background:rgba(255,255,255,.06); }
  #qb-broker{grid-column:1/2;} #qb-kind{grid-column:2/3;} #qb-q{grid-column:3/5;}
  #qb-start{grid-column:1/3;}  #qb-end{grid-column:3/5;}
  .btn-row{grid-column:1/-1; display:flex; justify-content:center; gap:8px; margin-top:6px;}
  .sum-wrap{display:grid; gap:6px; grid-template-columns:repeat(2,1fr); margin-top:6px}
  .pill{border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.05);
        border-radius:8px; padding:6px 8px; text-align:center; font-size:12px; color:#cbd5e1}
  .sum-total{grid-column:1/-1; background:rgba(255,255,255,.07); font-weight:600}

  /* ===== å„ã‚«ãƒ¼ãƒ‰ ===== */
  .card{
    border:1px solid rgba(255,255,255,.08);
    background:rgba(255,255,255,.04);
    border-radius:14px;
    padding:10px 12px;
    margin-bottom:10px;
    display:flex;
    flex-direction:column;
    gap:4px;
  }

  .chip{display:inline-flex; align-items:center; gap:.4em; padding:.25rem .5rem;
        border-radius:9999px; border:1px solid; font-size:11px; line-height:1;
        white-space:nowrap; margin-bottom:2px;}

  /* ã‚½ãƒ¼ã‚¹ä»˜ãï¼ˆé…å½“/å®Ÿæ/ä¿æœ‰ï¼‰ */
  .chip-violet{border-color:rgba(139,92,246,.35); color:#ddd6fe; background:rgba(139,92,246,.10)}   /* é…å½“ */
  .chip-emerald{border-color:rgba(16,185,129,.35); color:#bbf7d0; background:rgba(16,185,129,.08)} /* å®Ÿæ */
  .chip-amber{border-color:rgba(245,158,11,.35); color:#fde68a; background:rgba(245,158,11,.10)}   /* ä¿æœ‰ */

  /* æ‰‹å…¥åŠ›/ãƒ¡ãƒ¢ç”¨ï¼ˆå…¥é‡‘/å‡ºé‡‘/æŒ¯æ›¿/ãã®ä»–ï¼‰ */
  .chip-blue{border-color:rgba(59,130,246,.35); color:#bfdbfe; background:rgba(59,130,246,.10)}    /* å…¥é‡‘ */
  .chip-rose{border-color:rgba(244,63,94,.35); color:#fecdd3; background:rgba(244,63,94,.10)}      /* å‡ºé‡‘ */
  .chip-cyan{border-color:rgba(34,211,238,.35); color:#a5f3fc; background:rgba(34,211,238,.10)}    /* æŒ¯æ›¿(å…¥) */
  .chip-fuchsia{border-color:rgba(217,70,239,.35); color:#f5d0fe; background:rgba(217,70,239,.10)} /* æŒ¯æ›¿(å‡º) */
  .chip-slate{border-color:rgba(148,163,184,.35); color:#e2e8f0; background:rgba(148,163,184,.10)} /* ãã®ä»–/ã‚·ã‚¹ãƒ†ãƒ  */

  .meta{font-size:11px; color:#94a3b8}
  .amount{ text-align:right; font-size:20px; font-weight:800; color:#e6ebff; letter-spacing:0.02em; }
  .memo{margin-top:2px; font-size:11px; color:#cbd5e1; word-break:break-word}
</style>
{% endblock %}

{% block content %}
<h1 class="text-base font-semibold mb-2">ğŸ’µ ç¾é‡‘å°å¸³</h1>

<div id="topSticky">
  <form method="get" class="quickbar">
    <select id="qb-broker" name="broker" class="qb-ctl">
      {% with b=params.broker|default:"ALL" %}
        <option value="ALL"  {% if b == "ALL" %}selected{% endif %}>è¨¼åˆ¸ä¼šç¤¾: ã™ã¹ã¦</option>
        <option value="æ¥½å¤©" {% if b == "æ¥½å¤©" %}selected{% endif %}>æ¥½å¤©è¨¼åˆ¸</option>
        <option value="æ¾äº•" {% if b == "æ¾äº•" %}selected{% endif %}>æ¾äº•è¨¼åˆ¸</option>
        <option value="SBI"  {% if b == "SBI" %}selected{% endif %}>SBIè¨¼åˆ¸</option>
      {% endwith %}
    </select>

    <select id="qb-kind" name="kind" class="qb-ctl">
      {% with k=params.kind|default:"ALL" %}
        <option value="ALL"      {% if k == "ALL" %}selected{% endif %}>ç¨®åˆ¥: ã™ã¹ã¦</option>
        <option value="DEPOSIT"  {% if k == "DEPOSIT" %}selected{% endif %}>å…¥é‡‘</option>
        <option value="WITHDRAW" {% if k == "WITHDRAW" %}selected{% endif %}>å‡ºé‡‘</option>
        <option value="XFER"     {% if k == "XFER" %}selected{% endif %}>æŒ¯æ›¿</option>
        <option value="SYSTEM"   {% if k == "SYSTEM" %}selected{% endif %}>ã‚·ã‚¹ãƒ†ãƒ </option>
      {% endwith %}
    </select>

    <input id="qb-q" type="text" name="q" value="{{ params.q|default_if_none:'' }}"
           placeholder="ä¾‹: é…å½“ / å®Ÿç¾ç›Š / REAL:21 ãªã©" class="qb-ctl">

    <input id="qb-start" type="date" name="start" value="{{ params.start|default_if_none:'' }}" class="qb-ctl">
    <input id="qb-end" type="date" name="end" value="{{ params.end|default_if_none:'' }}" class="qb-ctl">

    <div class="btn-row">
      <button class="qb-btn" type="submit">é©ç”¨</button>
      <button class="qb-btn" type="button" onclick="location.href='{% url 'cash_history' %}'">ã‚¯ãƒªã‚¢</button>
    </div>
  </form>

  {% if summary %}
    <div class="sum-wrap">
      <div class="pill sum-total">ğŸ’° åˆè¨ˆ {{ summary.total|intcomma }} å††</div>
      <div class="pill">å…¥é‡‘ {{ summary.deposit|intcomma }} å††</div>
      <div class="pill">å‡ºé‡‘ {{ summary.withdraw|intcomma }} å††</div>
      <div class="pill">æŒ¯æ›¿(å…¥) {{ summary.xfer_in|intcomma }} å††</div>
      <div class="pill">æŒ¯æ›¿(å‡º) {{ summary.xfer_out|intcomma }} å††</div>
    </div>
  {% endif %}
</div>

{% for r in page.object_list %}
  <div class="card" data-ledger-id="{{ r.id }}">

    {# === 1è¡Œç›®ï¼šãƒãƒƒãƒ—ï¼ˆã‚½ãƒ¼ã‚¹ãŒã‚ã‚Œã°ã‚½ãƒ¼ã‚¹ã€ãªã‘ã‚Œã°ãƒ¡ãƒ¢ã‚’ãƒãƒƒãƒ—åŒ–ï¼‰ === #}
    {% if r.src_badge %}
      {% if r.src_badge.kind == "é…å½“" %}
        <span class="chip chip-violet">ã€é…å½“ã€‘ {{ r.src_badge.label }}</span>
      {% elif r.src_badge.kind == "å®Ÿæ" %}
        <span class="chip chip-emerald">ã€å®Ÿæã€‘ {{ r.src_badge.label }}</span>
      {% elif r.src_badge.kind == "ä¿æœ‰" %}
        <span class="chip chip-amber">ã€ä¿æœ‰ã€‘ {{ r.src_badge.label }}</span>
      {% endif %}
    {% else %}
      {% with memo_txt=r.memo|default_if_none:"" %}
        {% if r.kind == r.Kind.DEPOSIT %}
          <span class="chip chip-blue">ã€å…¥é‡‘ã€‘ {{ memo_txt|default:"æ‰‹å…¥åŠ›" }}</span>
        {% elif r.kind == r.Kind.WITHDRAW %}
          <span class="chip chip-rose">ã€å‡ºé‡‘ã€‘ {{ memo_txt|default:"æ‰‹å…¥åŠ›" }}</span>
        {% elif r.kind == r.Kind.XFER_IN %}
          <span class="chip chip-cyan">ã€æŒ¯æ›¿(å…¥)ã€‘ {{ memo_txt|default:"æ‰‹å…¥åŠ›" }}</span>
        {% elif r.kind == r.Kind.XFER_OUT %}
          <span class="chip chip-fuchsia">ã€æŒ¯æ›¿(å‡º)ã€‘ {{ memo_txt|default:"æ‰‹å…¥åŠ›" }}</span>
        {% else %}
          <span class="chip chip-slate">ã€ãã®ä»–ã€‘ {{ memo_txt|default:"æ‰‹å…¥åŠ›" }}</span>
        {% endif %}
      {% endwith %}
    {% endif %}

    {# === 2è¡Œç›®ï¼šæ—¥ä»˜ | è¨¼åˆ¸ä¼šç¤¾ | ç¨®åˆ¥ === #}
    <div class="meta">
      {{ r.at|default:"" }} ï½œ {{ r.account.broker|default:"" }} ï½œ ç¨®åˆ¥ï¼š
      {% if r.kind == r.Kind.DEPOSIT %}å…¥é‡‘{% elif r.kind == r.Kind.WITHDRAW %}å‡ºé‡‘
      {% elif r.kind == r.Kind.XFER_IN %}æŒ¯æ›¿(å…¥){% elif r.kind == r.Kind.XFER_OUT %}æŒ¯æ›¿(å‡º)
      {% else %}ãã®ä»–{% endif %}
    </div>

    {# === 3è¡Œç›®ï¼šé‡‘é¡ï¼ˆå³å¯„ã›ï¼‰ === #}
    <div class="amount">{{ r.amount|intcomma }} å††</div>

  </div>
{% empty %}
  <div class="text-slate-400">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
{% endfor %}

{% if page.paginator.num_pages > 1 %}
  <div class="flex items-center justify-center gap-8 my-3 text-[12px]">
    {% if page.has_previous %}
      <a class="qb-btn" href="?{{ params.urlencode }}&page={{ page.previous_page_number }}">â† å‰ã¸</a>
    {% endif %}
    <span>ãƒšãƒ¼ã‚¸ {{ page.number }} / {{ page.paginator.num_pages }}</span>
    {% if page.has_next %}
      <a class="qb-btn" href="?{{ params.urlencode }}&page={{ page.next_page_number }}">æ¬¡ã¸ â†’</a>
    {% endif %}
  </div>
{% endif %}
{% endblock %}