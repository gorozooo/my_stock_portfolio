{% extends "base.html" %}
{% load humanize %}
{% block title %}現金台帳{% endblock %}

{% block head %}
<style>
  :root{ --qbH: 30px; }

  /* ====== 上部：保有画面の QuickBar と同じ思想 ====== */
  #topSticky{
    position: sticky;
    top: env(safe-area-inset-top, 0px);
    z-index: 12;
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    background:rgba(15,20,30,.96);
    backdrop-filter: blur(8px);
    padding:8px;
    margin:0 0 8px;
    box-shadow:0 2px 0 rgba(255,255,255,.06) inset;
  }
  .quickbar{
    display:grid;
    grid-template-columns: repeat(4, minmax(0,1fr));
    gap:6px;
    align-items:center;
  }
  /* ラベルは視覚的に隠す（スクリーンリーダー用には残す） */
  .vh{ position:absolute !important; width:1px; height:1px; padding:0; margin:-1px;
       overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }

  .qb-ctl, .qb-btn{
    height: var(--qbH);
    padding: 0 8px;
    font-size:12px;
    color:#dbe3f4;
    background: rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.14);
    border-radius:8px;
    min-width:0;
  }
  input[type="date"].qb-ctl{ color-scheme: dark; }
  .qb-btn{ background:rgba(255,255,255,.06); }
  .qb-btn.ghost{ background:transparent; }

  /* 配置：保有画面と同じ“コンパクト横並び” */
  /* 1行目: 証券会社 / 種別 / 開始日 / 終了日 */
  #qb-broker { grid-column: 1 / 2; }
  #qb-kind   { grid-column: 2 / 3; }
  #qb-start  { grid-column: 3 / 4; }
  #qb-end    { grid-column: 4 / 5; }
  /* 2行目: メモ（3枠ぶん） + 適用（右端） */
  #qb-q      { grid-column: 1 / 4; }
  #qb-apply  { grid-column: 4 / 5; }
  /* 3行目: クリア（左端に小さく） */
  #qb-clear  { grid-column: 1 / 2; }

  /* 画面幅が狭い時の保険 */
  @media (max-width:420px){
    .quickbar{ grid-template-columns: repeat(4, minmax(0,1fr)); }
  }

  /* ====== サマリー（※触らないと言われた構成を維持） ====== */
  .sum-wrap{ display:grid; gap:6px; grid-template-columns:repeat(2,1fr); margin-top:6px }
  .pill{ border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.05);
         border-radius:8px; padding:6px 8px; text-align:center; font-size:12px; color:#cbd5e1 }
  .sum-total{ grid-column:1 / -1; background:rgba(255,255,255,.07); font-weight:600 }

  /* ====== リスト（既存） ====== */
  .card{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);
        border-radius:14px;padding:10px 12px;margin-bottom:10px}
  .amount{font-size:20px;font-weight:800}
  .meta{margin-top:2px;font-size:11px;color:#94a3b8}
  .memo{margin-top:2px;font-size:11px;color:#cbd5e1;word-break:break-word}
  .chip{display:inline-flex;align-items:center;gap:.4em;padding:.25rem .5rem;border-radius:9999px;border:1px solid;
        font-size:11px;line-height:1;white-space:nowrap}
  .chip-sky{border-color:rgba(125,160,255,.35);color:#c7d2fe;background:rgba(125,160,255,.08)}
  .chip-emerald{border-color:rgba(16,185,129,.35);color:#bbf7d0;background:rgba(16,185,129,.08)}
  .actions{margin-top:6px;display:flex;justify-content:flex-end;gap:6px}
  .actions a,.actions button{padding:5px 8px;font-size:11px;border-radius:8px;border:1px solid rgba(255,255,255,.2)}
</style>
{% endblock %}

{% block content %}
<h1 class="text-base font-semibold mb-2">💵 現金台帳</h1>

<div id="topSticky">
  <!-- ==== QuickBar（保有画面と同コンセプト） ==== -->
  <form method="get" class="quickbar" id="qb">
    <label for="qb-broker" class="vh">証券会社</label>
    <select id="qb-broker" name="broker" class="qb-ctl">
      {% with b=params.broker|default:"ALL" %}
        <option value="ALL"  {% if b == "ALL" %}selected{% endif %}>すべて</option>
        <option value="楽天" {% if b == "楽天" %}selected{% endif %}>楽天</option>
        <option value="松井" {% if b == "松井" %}selected{% endif %}>松井</option>
        <option value="SBI" {% if b == "SBI" %}selected{% endif %}>SBI</option>
      {% endwith %}
    </select>

    <label for="qb-kind" class="vh">種別</label>
    <select id="qb-kind" name="kind" class="qb-ctl">
      {% with k=params.kind|default:"ALL" %}
        <option value="ALL"      {% if k == "ALL" %}selected{% endif %}>すべて</option>
        <option value="DEPOSIT"  {% if k == "DEPOSIT" %}selected{% endif %}>入金</option>
        <option value="WITHDRAW" {% if k == "WITHDRAW" %}selected{% endif %}>出金</option>
        <option value="XFER"     {% if k == "XFER" %}selected{% endif %}>振替</option>
        <option value="SYSTEM"   {% if k == "SYSTEM" %}selected{% endif %}>システム</option>
      {% endwith %}
    </select>

    <label for="qb-start" class="vh">開始日</label>
    <input id="qb-start" type="date" name="start"
           value="{{ params.start|default_if_none:'' }}" class="qb-ctl">

    <label for="qb-end" class="vh">終了日</label>
    <input id="qb-end" type="date" name="end"
           value="{{ params.end|default_if_none:'' }}" class="qb-ctl">

    <label for="qb-q" class="vh">メモ検索</label>
    <input id="qb-q" type="text" name="q" class="qb-ctl" placeholder="例: 配当 / REAL:21 など"
           value="{{ params.q|default_if_none:'' }}">

    <button id="qb-apply" class="qb-btn" type="submit">適用</button>
    <a id="qb-clear" class="qb-btn ghost" href="{% url 'cash_history' %}">クリア</a>
  </form>

  <!-- ==== サマリー（合計1行 + 2列×2行） ==== -->
  {% if summary %}
    <div class="sum-wrap">
      <div class="pill sum-total">💰 合計 {{ summary.total|intcomma }} 円</div>
      <div class="pill">入金 {{ summary.deposit|intcomma }} 円</div>
      <div class="pill">出金 {{ summary.withdraw|intcomma }} 円</div>
      <div class="pill">振替(入) {{ summary.xfer_in|intcomma }} 円</div>
      <div class="pill">振替(出) {{ summary.xfer_out|intcomma }} 円</div>
    </div>
  {% endif %}
</div>

<!-- ==== リスト ==== -->
<div id="historyContainer">
  {% include "cash/_history_list.html" with page=page params=params %}
</div>

{% if page.has_next %}
  <div
    hx-get="{% url 'cash_history_page' %}?page={{ page.next_page_number }}&{{ params.urlencode }}"
    hx-trigger="revealed"
    hx-swap="afterend"
    class="text-center text-slate-400 py-2 text-[12px]">
    読み込み中…
  </div>
{% endif %}
{% endblock %}