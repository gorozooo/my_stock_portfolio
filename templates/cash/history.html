{% extends "base.html" %}
{% load humanize %}
{% block title %}ç¾é‡‘å°å¸³{% endblock %}

{% block head %}
<style>
  /* ===== ã‚¹ãƒ†ã‚£ãƒƒã‚­ãƒ¼æ ï¼ˆãã®ã¾ã¾ï¼‰ ===== */
  #topSticky{
    position: sticky;
    top: env(safe-area-inset-top, 0px);
    z-index: 12;
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    background:rgba(15,20,30,.96);
    backdrop-filter: blur(8px);
    padding:10px;
    margin-bottom:8px;
    box-shadow:0 2px 0 rgba(255,255,255,.06) inset;
  }

  /* ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ===== */
  .filter-grid{ display:grid; grid-template-columns:repeat(12,1fr); gap:8px; }
  .field{ position:relative; grid-column:span 4; }    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ 4 ã‚«ãƒ©ãƒ å¹… */
  .field.w6{ grid-column:span 6; }                    /* æ—¥ä»˜ç”¨ï¼š6 ã‚«ãƒ©ãƒ å¹… */
  .prefix{
    position:absolute; left:10px; top:6px;
    font-size:11px; color:#9fb0c8; pointer-events:none;
  }
  .ctl, .btn{
    height:32px; font-size:13px; color:#e6ebff;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.14);
    border-radius:8px; padding:0 10px; width:100%; box-sizing:border-box;
  }
  /* ãƒ©ãƒ™ãƒ«åˆ†ã®å·¦ä½™ç™½ï¼ˆselect/date ã‚‚åŒã˜ã«ã™ã‚‹ï¼‰ */
  .field .ctl{ padding-left:56px; }
  input[type="date"].ctl{ color-scheme: dark; }

  /* ãƒœã‚¿ãƒ³ï¼šé©ç”¨ â†’ ã‚¯ãƒªã‚¢ï¼ˆä¸­å¤®å¯„ã›ï¼å…ƒã‚µã‚¤ã‚ºï¼‰ */
  .btnrow{ grid-column:1 / -1; display:flex; justify-content:center; gap:10px; }
  .btn.ghost{ background:transparent; }

  /* ===== ã‚µãƒãƒªãƒ¼ï¼ˆå‰å›OKã®ã¾ã¾ï¼‰ ===== */
  .sum-wrap{ display:grid; gap:6px; grid-template-columns:repeat(2,1fr); margin-top:6px }
  .pill{ border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.05);
         border-radius:8px; padding:6px 8px; text-align:center; font-size:12px; color:#cbd5e1 }
  .sum-total{ grid-column:1 / -1; background:rgba(255,255,255,.07); font-weight:600 }
</style>
{% endblock %}

{% block content %}
<h1 class="text-base font-semibold mb-2">ğŸ’µ ç¾é‡‘å°å¸³</h1>

<div id="topSticky">
  <form method="get" class="filter-grid">

    <!-- 1) è¨¼åˆ¸ä¼šç¤¾ -->
    <div class="field">
      <span class="prefix">è¨¼åˆ¸ä¼šç¤¾</span>
      <select name="broker" class="ctl">
        {% with b=params.broker|default:"ALL" %}
          <option value="ALL"  {% if b == "ALL" %}selected{% endif %}>ã™ã¹ã¦</option>
          <option value="æ¥½å¤©" {% if b == "æ¥½å¤©" %}selected{% endif %}>æ¥½å¤©</option>
          <option value="æ¾äº•" {% if b == "æ¾äº•" %}selected{% endif %}>æ¾äº•</option>
          <option value="SBI"  {% if b == "SBI" %}selected{% endif %}>SBI</option>
        {% endwith %}
      </select>
    </div>

    <!-- 2) ç¨®åˆ¥ -->
    <div class="field">
      <span class="prefix">ç¨®åˆ¥</span>
      <select name="kind" class="ctl">
        {% with k=params.kind|default:"ALL" %}
          <option value="ALL" {% if k == "ALL" %}selected{% endif %}>ã™ã¹ã¦</option>
          <option value="DEPOSIT"  {% if k == "DEPOSIT" %}selected{% endif %}>å…¥é‡‘</option>
          <option value="WITHDRAW" {% if k == "WITHDRAW" %}selected{% endif %}>å‡ºé‡‘</option>
          <option value="XFER"     {% if k == "XFER" %}selected{% endif %}>æŒ¯æ›¿</option>
          <option value="SYSTEM"   {% if k == "SYSTEM" %}selected{% endif %}>ã‚·ã‚¹ãƒ†ãƒ </option>
        {% endwith %}
      </select>
    </div>

    <!-- 3) ãƒ¡ãƒ¢æ¤œç´¢ï¼ˆä¾‹æ–‡ã¯ã“ã®ã¾ã¾ï¼‰ -->
    <div class="field">
      <span class="prefix">ãƒ¡ãƒ¢æ¤œç´¢</span>
      <input type="text" name="q" class="ctl"
             placeholder="ä¾‹: é…å½“ / å®Ÿç¾ç›Š / REAL:21"
             value="{{ params.q|default_if_none:'' }}">
    </div>

    <!-- 4) é–‹å§‹æ—¥ -->
    <div class="field w6">
      <span class="prefix">é–‹å§‹æ—¥</span>
      <input type="date" name="start" value="{{ params.start|default_if_none:'' }}" class="ctl">
    </div>

    <!-- 5) çµ‚äº†æ—¥ï¼ˆåŒã˜æ®µã«ä¸¦ã¹ã‚‹ï¼‰ -->
    <div class="field w6">
      <span class="prefix">çµ‚äº†æ—¥</span>
      <input type="date" name="end"   value="{{ params.end|default_if_none:'' }}" class="ctl">
    </div>

    <!-- 6) ãƒœã‚¿ãƒ³ï¼šé©ç”¨ â†’ ã‚¯ãƒªã‚¢ï¼ˆä¸­å¤®å¯„ã›ï¼‰ -->
    <div class="btnrow">
      <button class="btn" type="submit">é©ç”¨</button>
      <a href="{% url 'cash_history' %}" class="btn ghost">ã‚¯ãƒªã‚¢</a>
    </div>

  </form>

  {% if summary %}
    <div class="sum-wrap">
      <div class="pill sum-total">ğŸ’° åˆè¨ˆ {{ summary.total|intcomma }} å††</div>
      <div class="pill">å…¥é‡‘ {{ summary.deposit|intcomma }} å††</div>
      <div class="pill">å‡ºé‡‘ {{ summary.withdraw|intcomma }} å††</div>
      <div class="pill">æŒ¯æ›¿(å…¥) {{ summary.xfer_in|intcomma }} å††</div>
      <div class="pill">æŒ¯æ›¿(å‡º) {{ summary.xfer_out|intcomma }} å††</div>
    </div>
  {% endif %}
</div>

<!-- â–¼ å±¥æ­´ã‚«ãƒ¼ãƒ‰ï¼ˆå…ƒã«æˆ»ã™ï¼‰ -->
<div id="historyContainer">
  {% include "cash/_history_list.html" with page=page params=params %}
</div>

{% if page.has_next %}
  <div
    hx-get="{% url 'cash_history_page' %}?page={{ page.next_page_number }}&{{ params.urlencode }}"
    hx-trigger="revealed"
    hx-swap="afterend"
    class="text-center text-slate-400 py-2 text-[12px]">
    èª­ã¿è¾¼ã¿ä¸­â€¦
  </div>
{% endif %}
{% endblock %}