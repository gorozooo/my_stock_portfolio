{% extends "base.html" %}
{% load humanize %}
{% block title %}ç¾é‡‘å°å¸³{% endblock %}

{% block content %}
<h1 class="text-base font-semibold mb-3">ğŸ’µ ç¾é‡‘å°å¸³</h1>

<form method="get" class="grid grid-cols-2 gap-2 mb-3 text-sm">
  <select name="broker" class="border border-slate-700 bg-slate-900 rounded px-2 py-1">
    {% with b=request.GET.broker|default:"ALL" %}
      <option value="ALL"  {% if b == "ALL" %}selected{% endif %}>è¨¼åˆ¸ä¼šç¤¾: ã™ã¹ã¦</option>
      <option value="æ¥½å¤©" {% if b == "æ¥½å¤©" %}selected{% endif %}>æ¥½å¤©</option>
      <option value="æ¾äº•" {% if b == "æ¾äº•" %}selected{% endif %}>æ¾äº•</option>
      <option value="SBI"  {% if b == "SBI" %}selected{% endif %}>SBI</option>
    {% endwith %}
  </select>
  <select name="kind" class="border border-slate-700 bg-slate-900 rounded px-2 py-1">
    {% with k=request.GET.kind|default:"ALL" %}
      <option value="ALL"      {% if k == "ALL" %}selected{% endif %}>ç¨®åˆ¥: ã™ã¹ã¦</option>
      <option value="DEPOSIT"  {% if k == "DEPOSIT" %}selected{% endif %}>å…¥é‡‘</option>
      <option value="WITHDRAW" {% if k == "WITHDRAW" %}selected{% endif %}>å‡ºé‡‘</option>
      <option value="XFER"     {% if k == "XFER" %}selected{% endif %}>æŒ¯æ›¿</option>
      <option value="SYSTEM"   {% if k == "SYSTEM" %}selected{% endif %}>ã‚·ã‚¹ãƒ†ãƒ </option>
    {% endwith %}
  </select>
  <input type="date" name="start" value="{{ request.GET.start|default_if_none:'' }}"
         class="border border-slate-700 bg-slate-900 rounded px-2 py-1 col-span-1">
  <input type="date" name="end" value="{{ request.GET.end|default_if_none:'' }}"
         class="border border-slate-700 bg-slate-900 rounded px-2 py-1 col-span-1">
  <input type="text" name="q" value="{{ request.GET.q|default_if_none:'' }}" placeholder="ãƒ¡ãƒ¢æ¤œç´¢"
         class="border border-slate-700 bg-slate-900 rounded px-2 py-1 col-span-2">
  <div class="col-span-2 flex gap-2 justify-center mt-1">
    <button class="px-3 py-1 rounded border border-slate-600 bg-slate-800">é©ç”¨</button>
    <a href="{% url 'cash_history' %}" class="px-3 py-1 rounded border border-slate-600 bg-slate-800">ã‚¯ãƒªã‚¢</a>
  </div>
</form>

{% if summary %}
  <div class="grid grid-cols-2 gap-2 text-xs text-slate-300 mb-3">
    <div class="border border-slate-700 bg-slate-900 rounded px-2 py-1">åˆè¨ˆ {{ summary.total|intcomma }} å††</div>
    <div class="border border-slate-700 bg-slate-900 rounded px-2 py-1">å…¥é‡‘ {{ summary.deposit|intcomma }} å††</div>
    <div class="border border-slate-700 bg-slate-900 rounded px-2 py-1">å‡ºé‡‘ {{ summary.withdraw|intcomma }} å††</div>
    <div class="border border-slate-700 bg-slate-900 rounded px-2 py-1">æŒ¯æ›¿(å…¥) {{ summary.xfer_in|intcomma }} å††</div>
    <div class="border border-slate-700 bg-slate-900 rounded px-2 py-1">æŒ¯æ›¿(å‡º) {{ summary.xfer_out|intcomma }} å††</div>
  </div>
{% endif %}

{% for r in page.object_list %}
  <div class="mb-2 border border-slate-700 bg-slate-900 rounded p-2">
    <div class="text-lg font-extrabold">{{ r.amount|intcomma }} å††</div>
    <div class="text-xs text-slate-400 mt-0.5">
      {{ r.at|date:"Y-m-d" }} ï½œ {{ r.account.broker }} ï½œ ç¨®åˆ¥ï¼š
      {% if r.kind == r.Kind.DEPOSIT %}å…¥é‡‘{% elif r.kind == r.Kind.WITHDRAW %}å‡ºé‡‘
      {% elif r.kind == r.Kind.XFER_IN %}æŒ¯æ›¿(å…¥){% elif r.kind == r.Kind.XFER_OUT %}æŒ¯æ›¿(å‡º)
      {% elif r.kind == r.Kind.SYSTEM %}ã‚·ã‚¹ãƒ†ãƒ {% else %}ãã®ä»–{% endif %}
      {% if r.src_badge %}
        <span class="{{ r.src_badge.class }} inline-flex gap-1 align-middle ml-1 px-2 py-0.5 rounded-full border text-[11px]">
          ã€{{ r.src_badge.kind }}ã€‘ {{ r.src_badge.label }}
        </span>
      {% endif %}
    </div>
    {% with m=r.memo|default_if_none:"" %}
      {% if m %}
        <div class="text-xs text-slate-200 mt-0.5">{{ m }}</div>
      {% endif %}
    {% endwith %}
  </div>
{% empty %}
  <div class="text-slate-400">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
{% endfor %}

{% if page.paginator.num_pages > 1 %}
  <div class="flex items-center justify-center gap-8 my-3 text-[12px]">
    {% if page.has_previous %}
      <a class="px-2 py-1 border border-slate-600 rounded bg-slate-800"
         href="?page={{ page.previous_page_number }}&{{ params.urlencode }}">â† å‰ã¸</a>
    {% endif %}
    <span>ãƒšãƒ¼ã‚¸ {{ page.number }} / {{ page.paginator.num_pages }}</span>
    {% if page.has_next %}
      <a class="px-2 py-1 border border-slate-600 rounded bg-slate-800"
         href="?{{ params.urlencode }}&page={{ page.next_page_number }}">æ¬¡ã¸ â†’</a>
    {% endif %}
  </div>
{% endif %}
{% endblock %}