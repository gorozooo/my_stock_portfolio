{% extends "base.html" %}
{% load humanize %}
{% block title %}現金台帳{% endblock %}

{% block head %}
<style>
  .qb-btn{
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.15);
    border-radius:8px;
    padding:6px 12px;
    color:#e0e8ff;
    font-size:14px;
  }
</style>
{% endblock %}

{% block content %}
<h1>💵 現金台帳</h1>

<form method="get">
  <select name="broker">
    <option value="ALL">すべて</option>
    <option value="楽天" {% if params.broker == "楽天" %}selected{% endif %}>楽天</option>
    <option value="松井" {% if params.broker == "松井" %}selected{% endif %}>松井</option>
    <option value="SBI" {% if params.broker == "SBI" %}selected{% endif %}>SBI</option>
  </select>
  <button type="submit" class="qb-btn">適用</button>
</form>

{% if summary %}
  <div style="margin:10px 0;">
    💰合計 {{ summary.total|intcomma }}円　
    入金 {{ summary.deposit|intcomma }}円　
    出金 {{ summary.withdraw|intcomma }}円
  </div>
{% endif %}

<div id="historyContainer">
  {% include "cash/_history_list.html" with page=page params=params %}
</div>

<script>
document.addEventListener("click", e=>{
  if(e.target.matches("#loadMoreBtn")){
    const btn=e.target;
    btn.disabled=true;
    btn.textContent="読み込み中…";
    const next=btn.dataset.next;
    fetch(`{% url 'cash_history_page' %}?page=${next}`)
    .then(r=>r.text())
    .then(html=>{
      btn.insertAdjacentHTML("beforebegin",html);
      btn.remove();
    })
    .catch(()=>{
      btn.textContent="通信エラー";
      btn.disabled=false;
    });
  }
});
</script>
{% endblock %}