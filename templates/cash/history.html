{% extends "base.html" %}
{% load humanize %}
{% block title %}ç¾é‡‘å°å¸³{% endblock %}

{% block head %}
<style>
  #topSticky{
    position: sticky;
    top: env(safe-area-inset-top, 0px);
    z-index: 12;
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    background:rgba(15,20,30,.96);
    backdrop-filter: blur(8px);
    padding:8px;
    margin:0 0 8px;
    box-shadow:0 2px 0 rgba(255,255,255,.06) inset;
  }

  /* ===== ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆ4ã‚«ãƒ©ãƒ ï¼šä¿æœ‰ç”»é¢ã¨åŒã˜ç¸®å°ºï¼‰ ===== */
  .quickbar{
    display:grid;
    grid-template-columns: repeat(4, minmax(0,1fr));
    gap:6px;
    align-items:center;
  }
  .qb-ctl, .qb-btn{
    height:30px;
    padding:0 8px;
    font-size:12px;
    color:#dbe3f4;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.14);
    border-radius:8px;
    min-width:0;
  }
  input[type="date"].qb-ctl{ color-scheme: dark; }
  .qb-btn{ background:rgba(255,255,255,.06); }
  .qb-btn.ghost{ background:transparent; }

  /* 1æ®µç›®ï¼šè¨¼åˆ¸ä¼šç¤¾ / ç¨®åˆ¥ / ãƒ¡ãƒ¢(50%) */
  #qb-broker { grid-column: 1 / 2; }
  #qb-kind   { grid-column: 2 / 3; }
  #qb-q      { grid-column: 3 / 5; }

  /* 2æ®µç›®ï¼šé–‹å§‹ãƒ»çµ‚äº†ï¼ˆ50%/50%ï¼‰ */
  #qb-start  { grid-column: 1 / 3; }
  #qb-end    { grid-column: 3 / 5; }

  /* 3æ®µç›®ï¼šãƒœã‚¿ãƒ³ä¸­å¤®å¯„ã›ï¼ˆé©ç”¨â†’ã‚¯ãƒªã‚¢ï¼‰ */
  .btn-row{
    grid-column: 1 / -1;
    display:flex; justify-content:center; gap:8px;
    margin-top:6px;
  }

  /* ===== ã‚µãƒãƒªãƒ¼ï¼ˆè§¦ã‚‰ãªã„ï¼‰ ===== */
  .sum-wrap{ display:grid; gap:6px; grid-template-columns:repeat(2,1fr); margin-top:6px }
  .pill{ border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.05);
         border-radius:8px; padding:6px 8px; text-align:center; font-size:12px; color:#cbd5e1 }
  .sum-total{ grid-column:1 / -1; background:rgba(255,255,255,.07); font-weight:600 }

  /* ===== ãƒªã‚¹ãƒˆï¼ˆæ—¢å­˜ï¼‰ ===== */
  .card{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);
        border-radius:14px;padding:10px 12px;margin-bottom:10px}
  .amount{font-size:20px;font-weight:800}
  .meta{margin-top:2px;font-size:11px;color:#94a3b8}
  .memo{margin-top:2px;font-size:11px;color:#cbd5e1;word-break:break-word}
  .chip{display:inline-flex;align-items:center;gap:.4em;padding:.25rem .5rem;border-radius:9999px;border:1px solid;
        font-size:11px;line-height:1;white-space:nowrap}
  .chip-sky{border-color:rgba(125,160,255,.35);color:#c7d2fe;background:rgba(125,160,255,.08)}
  .chip-emerald{border-color:rgba(16,185,129,.35);color:#bbf7d0;background:rgba(16,185,129,.08)}
  .actions{margin-top:6px;display:flex;justify-content:flex-end;gap:6px}
  .actions a,.actions button{padding:5px 8px;font-size:11px;border-radius:8px;border:1px solid rgba(255,255,255,.2)}
</style>
{% endblock %}

{% block content %}
<h1 class="text-base font-semibold mb-2">ğŸ’µ ç¾é‡‘å°å¸³</h1>

<div id="topSticky">
  <form method="get" class="quickbar">
    <!-- 1æ®µç›® -->
    <select id="qb-broker" name="broker" class="qb-ctl">
      {% with b=params.broker|default:"ALL" %}
        <option value="ALL"  {% if b == "ALL" %}selected{% endif %}>è¨¼åˆ¸ä¼šç¤¾: ã™ã¹ã¦</option>
        <option value="æ¥½å¤©" {% if b == "æ¥½å¤©" %}selected{% endif %}>æ¥½å¤©è¨¼åˆ¸</option>
        <option value="æ¾äº•" {% if b == "æ¾äº•" %}selected{% endif %}>æ¾äº•è¨¼åˆ¸</option>
        <option value="SBI"  {% if b == "SBI" %}selected{% endif %}>SBIè¨¼åˆ¸</option>
      {% endwith %}
    </select>

    <select id="qb-kind" name="kind" class="qb-ctl">
      {% with k=params.kind|default:"ALL" %}
        <option value="ALL"      {% if k == "ALL" %}selected{% endif %}>ç¨®åˆ¥: ã™ã¹ã¦</option>
        <option value="DEPOSIT"  {% if k == "DEPOSIT" %}selected{% endif %}>å…¥é‡‘</option>
        <option value="WITHDRAW" {% if k == "WITHDRAW" %}selected{% endif %}>å‡ºé‡‘</option>
        <option value="XFER"     {% if k == "XFER" %}selected{% endif %}>æŒ¯æ›¿</option>
      {% endwith %}
    </select>

    <input id="qb-q" type="text" name="q"
           value="{{ params.q|default_if_none:'' }}"
           placeholder="ä¾‹: é…å½“ / å®Ÿç¾ç›Š / REAL:21 ãªã©"
           class="qb-ctl">

    <!-- 2æ®µç›® -->
    <input id="qb-start" type="date" name="start"
           value="{{ params.start|default_if_none:'' }}"
           placeholder="ä¾‹: 2025/10/01" class="qb-ctl">
    <input id="qb-end" type="date" name="end"
           value="{{ params.end|default_if_none:'' }}"
           placeholder="ä¾‹: 2025/10/08" class="qb-ctl">

    <!-- 3æ®µç›® -->
    <div class="btn-row">
      <button class="qb-btn" type="submit">é©ç”¨</button>
      <button class="qb-btn" type="button" onclick="location.href='{% url 'cash_history' %}'">ã‚¯ãƒªã‚¢</button>
    </div>
  </form>

  {% if summary %}
    <div class="sum-wrap">
      <div class="pill sum-total">ğŸ’° åˆè¨ˆ {{ summary.total|intcomma }} å††</div>
      <div class="pill">å…¥é‡‘ {{ summary.deposit|intcomma }} å††</div>
      <div class="pill">å‡ºé‡‘ {{ summary.withdraw|intcomma }} å††</div>
      <div class="pill">æŒ¯æ›¿(å…¥) {{ summary.xfer_in|intcomma }} å††</div>
      <div class="pill">æŒ¯æ›¿(å‡º) {{ summary.xfer_out|intcomma }} å††</div>
    </div>
  {% endif %}
</div>

<div id="historyContainer">
  {% include "cash/_history_list.html" with page=page params=params %}
</div>

{% if page.has_next %}
  {# --- ç„¡é™ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼šé‡è¤‡é˜²æ­¢ç‰ˆï¼ˆ1å›ã ã‘ç™ºç«â†’å®Œäº†å¾Œã«æ¬¡ãƒšãƒ¼ã‚¸ã¸å·®ã—æ›¿ãˆï¼‰ --- #}
  <div id="moreSentinel"
       class="text-center text-slate-400 py-2 text-[12px]"
       data-page="{{ page.next_page_number }}"
       data-broker="{{ params.broker|default_if_none:''|urlencode }}"
       data-kind="{{ params.kind|default_if_none:''|urlencode }}"
       data-start="{{ params.start|default_if_none:''|urlencode }}"
       data-end="{{ params.end|default_if_none:''|urlencode }}"
       data-q="{{ params.q|default_if_none:''|urlencode }}"
       hx-trigger="intersect once"
       hx-swap="afterend">
    èª­ã¿è¾¼ã¿ä¸­â€¦
  </div>

  <script>
    (function(){
      const baseUrl = "{% url 'cash_history_page' %}";
      const el = document.getElementById('moreSentinel');
      if(!el) return;

      function buildURL(){
        const p = new URLSearchParams();
        p.set('page', el.dataset.page || '2');
        if(el.dataset.broker) p.set('broker', el.dataset.broker);
        if(el.dataset.kind)   p.set('kind',   el.dataset.kind);
        if(el.dataset.start)  p.set('start',  el.dataset.start);
        if(el.dataset.end)    p.set('end',    el.dataset.end);
        if(el.dataset.q)      p.set('q',      el.dataset.q);
        return baseUrl + '?' + p.toString();
      }

      // åˆå›ã ã‘ç™ºç« â†’ é€ä¿¡ä¸­ã¯äºŒåº¦æŠ¼ã—é˜²æ­¢ â†’ å®Œäº†å¾Œã«æ¬¡ãƒšãƒ¼ã‚¸ç•ªå·ã‚’æ›´æ–°ã—ã€å†æ­¦è£…
      el.setAttribute('hx-get', buildURL());
      let busy = false;

      el.addEventListener('htmx:beforeRequest', function(){
        if(busy) return false;
        busy = true;
      });

      el.addEventListener('htmx:afterSwap', function(e){
        // è¿½åŠ åˆ†ã¯ afterend ã§æŒ¿å…¥æ¸ˆã¿ã€‚æ¬¡ãƒšãƒ¼ã‚¸ãŒå¿…è¦ãªã‚‰ç•ªå·ã‚’+1ã—ã¦å†æ­¦è£…ã€‚
        // ã‚µãƒ¼ãƒå´ã®éƒ¨åˆ†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã¯ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’è¿”ã—ã¦ã„ãªã„å‰æã€‚
        const next = (parseInt(el.dataset.page || '1', 10) + 1).toString();
        el.dataset.page = next;
        el.setAttribute('hx-get', buildURL());

        // ã™ãå†ç™ºç«ã•ã›ãšã€è¦–ç•Œã‹ã‚‰å¤–ã‚Œã¦å†åº¦ intersect ã™ã‚‹ã¾ã§å¾…ã¤
        el.setAttribute('hx-trigger', 'intersect once');
        busy = false;
      });

      // å¿µã®ãŸã‚ï¼šé€šä¿¡ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ busy ã‚’è§£é™¤
      el.addEventListener('htmx:afterRequest', function(){ busy = false; });
    })();
  </script>
{% endif %}
{% endblock %}