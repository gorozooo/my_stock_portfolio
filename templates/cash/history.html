{% extends "base.html" %}
{% load humanize %}
{% block title %}ç¾é‡‘å°å¸³{% endblock %}

{% block head %}
<style>
  #topSticky{position:sticky;top:env(safe-area-inset-top,0px);z-index:12;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(15,20,30,.96);backdrop-filter:blur(8px);padding:8px;margin:0 0 8px;box-shadow:0 2px 0 rgba(255,255,255,.06) inset}
  .quickbar{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:6px;align-items:center}
  .qb-ctl,.qb-btn{height:30px;padding:0 8px;font-size:12px;color:#dbe3f4;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.14);border-radius:8px;min-width:0}
  input[type="date"].qb-ctl{color-scheme:dark}
  .qb-btn{background:rgba(255,255,255,.06)} .qb-btn.ghost{background:transparent}
  #qb-broker{grid-column:1/2} #qb-kind{grid-column:2/3} #qb-q{grid-column:3/5}
  #qb-start{grid-column:1/3}  #qb-end{grid-column:3/5}
  .btn-row{grid-column:1/-1;display:flex;justify-content:center;gap:8px;margin-top:6px}
  .sum-wrap{display:grid;gap:6px;grid-template-columns:repeat(2,1fr);margin-top:6px}
  .pill{border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05);border-radius:8px;padding:6px 8px;text-align:center;font-size:12px;color:#cbd5e1}
  .sum-total{grid-column:1/-1;background:rgba(255,255,255,.07);font-weight:600}
  .card{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:14px;padding:10px 12px;margin-bottom:10px}
  .amount{font-size:20px;font-weight:800}
  .meta{margin-top:2px;font-size:11px;color:#94a3b8}
  .memo{margin-top:2px;font-size:11px;color:#cbd5e1;word-break:break-word}
  .chip{display:inline-flex;align-items:center;gap:.4em;padding:.25rem .5rem;border-radius:9999px;border:1px solid;font-size:11px;line-height:1;white-space:nowrap}
  .chip-sky{border-color:rgba(125,160,255,.35);color:#c7d2fe;background:rgba(125,160,255,.08)}
  .chip-emerald{border-color:rgba(16,185,129,.35);color:#bbf7d0;background:rgba(16,185,129,.08)}
  .actions{margin-top:6px;display:flex;justify-content:flex-end;gap:6px}
  .actions a,.actions button{padding:5px 8px;font-size:11px;border-radius:8px;border:1px solid rgba(255,255,255,.2)}
</style>
{% endblock %}

{% block content %}
<h1 class="text-base font-semibold mb-2">ğŸ’µ ç¾é‡‘å°å¸³</h1>

<div id="topSticky">
  <form method="get" class="quickbar">
    <select id="qb-broker" name="broker" class="qb-ctl">
      {% with b=params.broker|default:"ALL" %}
        <option value="ALL"  {% if b == "ALL" %}selected{% endif %}>è¨¼åˆ¸ä¼šç¤¾: ã™ã¹ã¦</option>
        <option value="æ¥½å¤©" {% if b == "æ¥½å¤©" %}selected{% endif %}>æ¥½å¤©è¨¼åˆ¸</option>
        <option value="æ¾äº•" {% if b == "æ¾äº•" %}selected{% endif %}>æ¾äº•è¨¼åˆ¸</option>
        <option value="SBI"  {% if b == "SBI" %}selected{% endif %}>SBIè¨¼åˆ¸</option>
      {% endwith %}
    </select>

    <select id="qb-kind" name="kind" class="qb-ctl">
      {% with k=params.kind|default:"ALL" %}
        <option value="ALL"      {% if k == "ALL" %}selected{% endif %}>ç¨®åˆ¥: ã™ã¹ã¦</option>
        <option value="DEPOSIT"  {% if k == "DEPOSIT" %}selected{% endif %}>å…¥é‡‘</option>
        <option value="WITHDRAW" {% if k == "WITHDRAW" %}selected{% endif %}>å‡ºé‡‘</option>
        <option value="XFER"     {% if k == "XFER" %}selected{% endif %}>æŒ¯æ›¿</option>
      {% endwith %}
    </select>

    <input id="qb-q" type="text" name="q"
           value="{{ params.q|default_if_none:'' }}"
           placeholder="ä¾‹: é…å½“ / å®Ÿç¾ç›Š / REAL:21 ãªã©"
           class="qb-ctl">

    <input id="qb-start" type="date" name="start"
           value="{{ params.start|default_if_none:'' }}" class="qb-ctl">
    <input id="qb-end" type="date" name="end"
           value="{{ params.end|default_if_none:'' }}" class="qb-ctl">

    <div class="btn-row">
      <button class="qb-btn" type="submit">é©ç”¨</button>
      <button class="qb-btn" type="button" onclick="location.href='{% url 'cash_history' %}'">ã‚¯ãƒªã‚¢</button>
    </div>
  </form>

  {% if summary %}
    <div class="sum-wrap">
      <div class="pill sum-total">ğŸ’° åˆè¨ˆ {{ summary.total|intcomma }} å††</div>
      <div class="pill">å…¥é‡‘ {{ summary.deposit|intcomma }} å††</div>
      <div class="pill">å‡ºé‡‘ {{ summary.withdraw|intcomma }} å††</div>
      <div class="pill">æŒ¯æ›¿(å…¥) {{ summary.xfer_in|intcomma }} å††</div>
      <div class="pill">æŒ¯æ›¿(å‡º) {{ summary.xfer_out|intcomma }} å††</div>
    </div>
  {% endif %}
</div>

{# ===== ãƒªã‚¹ãƒˆ ===== #}
{% for r in page.object_list %}
  <div class="card">
    <div class="amount">{{ r.amount|intcomma }} å††</div>
    <div class="meta">
      {{ r.at|default:"" }} ï½œ {{ r.account.broker|default:"" }} ï½œ ç¨®åˆ¥ï¼š
      {% if r.kind == r.Kind.DEPOSIT %}å…¥é‡‘
      {% elif r.kind == r.Kind.WITHDRAW %}å‡ºé‡‘
      {% elif r.kind == r.Kind.XFER_IN %}æŒ¯æ›¿(å…¥)
      {% elif r.kind == r.Kind.XFER_OUT %}æŒ¯æ›¿(å‡º)
      {% else %}ãã®ä»–{% endif %}
      {% if r.src_badge %}
        <span class="{{ r.src_badge.class }}">
          {% if r.src_badge.kind == "é…å½“" %}ã€é…å½“ã€‘{% else %}ã€å®Ÿæã€‘{% endif %} {{ r.src_badge.label }}
        </span>
      {% endif %}
    </div>
    {% with m=r.memo|default_if_none:"" %}
      {% if m and m|slice:":4" != "å®Ÿç¾æç›Š" and m|slice:":2" != "é…å½“" %}
        <div class="memo">{{ m }}</div>
      {% endif %}
    {% endwith %}
    <div class="actions">
      <a href="{% url 'cash_ledger_edit' r.id %}">ç·¨é›†</a>
      <form method="post" action="{% url 'cash_ledger_delete' r.id %}">
        {% csrf_token %}<button>å‰Šé™¤</button>
      </form>
    </div>
  </div>
{% empty %}
  <div class="text-slate-400">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
{% endfor %}

{# ===== ãƒšãƒ¼ã‚¸ãƒ£ï¼ˆpage ã‚’é™¤å¤–ã—ã¦ä»˜ã‘ç›´ã—ã€‚ç©ºå€¤æ’é™¤ï¼‰ ===== #}
{% if page.paginator.num_pages > 1 %}
  <div class="flex items-center justify-center gap-8 my-3 text-[12px]">
    {% if page.has_previous %}
      <a class="qb-btn"
         href="?{% for k,v in params.items %}{% if k != 'page' and v != None and v != '' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page.previous_page_number }}">
        â† å‰ã¸
      </a>
    {% endif %}
    <span>ãƒšãƒ¼ã‚¸ {{ page.number }} / {{ page.paginator.num_pages }}</span>
    {% if page.has_next %}
      <a class="qb-btn"
         href="?{% for k,v in params.items %}{% if k != 'page' and v != None and v != '' %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page.next_page_number }}">
        æ¬¡ã¸ â†’
      </a>
    {% endif %}
  </div>
{% endif %}
{% endblock %}