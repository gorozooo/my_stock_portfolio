{% extends "base.html" %}
{% load humanize %}
{% block title %}現金台帳{% endblock %}

{% block content %}
<style>
/* --- 極小フィルター --- */
.form-card{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);
           border-radius:12px;padding:8px}
.form-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
.form-grid .ctl{display:flex;flex-direction:column;gap:2px;min-width:0}
.form-grid label{font-size:10px;color:#94a3b8}
.input,.select,.btn{width:100%;padding:5px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.12);
                    background:rgba(255,255,255,.06);color:#e5e7eb;font-size:12px;line-height:1.1}
.btn{background:rgba(255,255,255,.08)}
.btn.ghost{background:transparent;border-color:rgba(255,255,255,.1)}
/* --- サマリー（別チップ列） --- */
.sum-wrap{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.sum-chip{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.05);
          border-radius:999px;padding:6px 10px;font-size:12px;color:#cbd5e1}
/* --- 一覧カード --- */
.card{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);
      border-radius:14px;padding:12px 14px;margin-bottom:10px}
.amount{font-size:22px;font-weight:800}
.meta{margin-top:2px;font-size:12px;color:#94a3b8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.memo{margin-top:2px;font-size:12px;color:#cbd5e1;word-break:break-word}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:12px;font-size:12px;line-height:1;
       border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06)}
.badge.g{border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.10)}
.badge.sky{border-color:rgba(125,160,255,.35);background:rgba(125,160,255,.10)}
.actions{margin-top:6px;display:flex;justify-content:flex-end;gap:8px}
.actions a,.actions button{padding:6px 10px;font-size:12px;border-radius:10px;border:1px solid rgba(255,255,255,.2)}
/* 小画面での詰め */
@media (max-width:480px){
  .amount{font-size:20px}
  .actions a,.actions button{padding:5px 9px;font-size:12px}
}
</style>

<h1 class="text-base font-semibold mb-2">💵 現金台帳</h1>

<!-- フィルター（超コンパクト） -->
<form method="get" class="form-card">
  <div class="form-grid">
    <div class="ctl" style="grid-column:span 2;">
      <label>証券会社</label>
      <select name="broker" class="select">
        {% with b=params.broker|default:"ALL" %}
          <option value="ALL"  {% if b == "ALL" %}selected{% endif %}>すべて</option>
          <option value="楽天" {% if b == "楽天" %}selected{% endif %}>楽天</option>
          <option value="松井" {% if b == "松井" %}selected{% endif %}>松井</option>
          <option value="SBI" {% if b == "SBI" %}selected{% endif %}>SBI</option>
        {% endwith %}
      </select>
    </div>
    <div class="ctl" style="grid-column:span 2;">
      <label>種別</label>
      <select name="kind" class="select">
        {% with k=params.kind|default:"ALL" %}
          <option value="ALL"      {% if k == "ALL" %}selected{% endif %}>すべて</option>
          <option value="DEPOSIT"  {% if k == "DEPOSIT" %}selected{% endif %}>入金</option>
          <option value="WITHDRAW" {% if k == "WITHDRAW" %}selected{% endif %}>出金</option>
          <option value="XFER"     {% if k == "XFER" %}selected{% endif %}>振替</option>
          <option value="SYSTEM"   {% if k == "SYSTEM" %}selected{% endif %}>システム</option>
        {% endwith %}
      </select>
    </div>
    <div class="ctl">
      <label>開始日</label>
      <input type="date" name="start" value="{{ params.start|default_if_none:'' }}" class="input">
    </div>
    <div class="ctl">
      <label>終了日</label>
      <input type="date" name="end" value="{{ params.end|default_if_none:'' }}" class="input">
    </div>

    <div class="ctl" style="grid-column:span 4;">
      <label>メモ検索</label>
      <input type="text" name="q" value="{{ params.q|default_if_none:'' }}" placeholder="例: 配当 / REAL:21 など" class="input">
    </div>
    <div class="ctl" style="align-self:end;display:flex;gap:6px;">
      <button class="btn" type="submit">適用</button>
      <a href="{% url 'cash_history' %}" class="btn ghost">クリア</a>
    </div>
  </div>
</form>

<!-- サマリー（別行・チップ） -->
{% if summary %}
  <div class="sum-wrap">
    <span class="sum-chip">合計 {{ summary.total|intcomma }} 円</span>
    <span class="sum-chip">入金 {{ summary.deposit|intcomma }} 円</span>
    <span class="sum-chip">出金 {{ summary.withdraw|intcomma }} 円</span>
    <span class="sum-chip">振替(入) {{ summary.xfer_in|intcomma }} 円</span>
    <span class="sum-chip">振替(出) {{ summary.xfer_out|intcomma }} 円</span>
  </div>
{% endif %}

<!-- 一覧 -->
<div id="historyContainer">
  {% include "cash/_history_list.html" with page=page params=params %}
</div>

<!-- 追加読み込み（HTMX） -->
{% if page.has_next %}
  <div
    hx-get="{% url 'cash_history_page' %}?page={{ page.next_page_number }}&{{ params.urlencode }}"
    hx-trigger="revealed"
    hx-swap="afterend"
    class="text-center text-slate-400 py-2 text-[12px]">
    読み込み中…
  </div>
{% endif %}
{% endblock %}