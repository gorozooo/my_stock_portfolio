{% extends "base.html" %}
{% load static %}

{% block title %}AIアドバイザー 通知ダッシュボード{% endblock %}

{% block content %}
<style>
  /* ---- レイアウト共通 ---- */
  .wrap { max-width: 1000px; margin: 0 auto; padding: 16px 12px 120px; }
  .h1   { font-size: 1.6rem; font-weight: 700; letter-spacing: .02em; margin: 4px 0 14px; }

  /* ---- セグメント（上部サブナビ） ---- */
  .seg-wrap { position: sticky; top: 8px; z-index: 30; display: flex; justify-content: center; margin: 6px 0 14px; }
  .seg { display: inline-flex; gap: 8px; padding: 6px; border-radius: 999px; background: rgba(255,255,255,.06);
         backdrop-filter: blur(6px); box-shadow: 0 6px 20px rgba(0,0,0,.25) inset, 0 6px 30px rgba(0,0,0,.06); }
  .seg-btn { appearance: none; border: 0; cursor: pointer; padding: 10px 16px; border-radius: 999px; font-weight: 600;
             letter-spacing: .02em; color: #cfd3dc; background: transparent; transition: transform .1s ease, background .2s ease, color .2s ease; white-space: nowrap; }
  .seg-btn:hover { transform: translateY(-1px); }
  .seg-btn.active { background: linear-gradient(180deg,#3b82f6,#2563eb); color: #fff; box-shadow: 0 6px 16px rgba(37,99,235,.35); }

  /* ---- サマリカード ---- */
  .grid { display: grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap: 10px; }
  @media (min-width: 540px){ .grid { grid-template-columns: repeat(4,minmax(0,1fr)); } }
  .card { border-radius: 14px; padding: 14px 16px; background: rgba(255,255,255,.04);
          box-shadow: 0 10px 30px rgba(0,0,0,.16), inset 0 1px 0 rgba(255,255,255,.04); }
  .card .cap { font-size: .82rem; opacity:.8; margin-bottom: 4px; }
  .card .val { font-size: 1.6rem; font-weight: 800; letter-spacing: .02em; }

  /* ---- セクション見出し & 小要素 ---- */
  .sec-ttl { display:flex; align-items:center; gap:.6rem; margin:18px 2px 10px; font-weight:700; }
  .chip    { display:inline-flex; align-items:center; gap:.4rem; font-size:.78rem; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); }

  /* ---- テーブル ---- */
  table.basic { width:100%; border-collapse: collapse; }
  table.basic th, table.basic td { padding: 10px 10px; text-align: left; }
  table.basic thead th { font-size:.86rem; font-weight:700; opacity:.85; border-bottom:1px solid rgba(255,255,255,.08); }
  table.basic tbody tr { border-bottom: 1px dashed rgba(255,255,255,.06); }
  table.basic tbody tr:last-child { border-bottom: 0; }
  .num { text-align:right; font-variant-numeric: tabular-nums; }

  /* ---- ポリシー/セクター用の枠 ---- */
  .panel { border-radius: 14px; padding: 14px 16px; margin-top: 10px; background: rgba(255,255,255,.03); box-shadow: inset 0 1px 0 rgba(255,255,255,.04); }
  .tiny { font-size:.86rem; opacity:.8; }

  /* ---- セクター表 ---- */
  .bar { height:8px; border-radius:999px; background:rgba(255,255,255,.08); overflow:hidden; }
  .bar .fill { height:100%; width:0%; border-radius:999px; background:linear-gradient(90deg,#60a5fa,#2563eb); }
  .rsbar .fill { background:linear-gradient(90deg,#f59e0b,#10b981); }
  .badge { display:inline-flex; align-items:center; gap:.35rem; padding:4px 8px; border-radius:999px; font-size:.78rem; font-weight:700; letter-spacing:.02em; }
  .badge.weak    { color:#fca5a5; background:rgba(239,68,68,.12); }
  .badge.neutral { color:#e5e7eb; background:rgba(148,163,184,.14); }
  .badge.strong  { color:#86efac; background:rgba(16,185,129,.14); }

  /* ---- セクションの表示切替 ---- */
  .sec { display:none; } .sec.show { display:block; }

  /* ---- 地合いカードのレジーム色 ---- */
  .regime { font-weight:800; }
  .regime.RISK_ON  { color:#86efac; }
  .regime.NEUTRAL  { color:#e5e7eb; }
  .regime.RISK_OFF { color:#fca5a5; }
</style>

<div class="wrap">
  <h1 class="h1">AIアドバイザー 通知ダッシュボード</h1>

  <!-- 上部サブナビ（中央・固定） -->
  <div class="seg-wrap">
    <div class="seg" role="tablist" aria-label="セクション切替">
      <button class="seg-btn active" data-target="#sec-dashboard" role="tab" aria-selected="true">ダッシュボード</button>
      <button class="seg-btn" data-target="#sec-sectors" role="tab">セクター</button>
      <button class="seg-btn" data-target="#sec-policy" role="tab">しきい値</button>
    </div>
  </div>

  <!-- ===== ダッシュボード ===== -->
  <section id="sec-dashboard" class="sec show" aria-labelledby="tab-dashboard">
    <div class="chip">サマリ　過去 {{ days }} 日</div>

    <div class="grid" style="margin:10px 0 16px;">
      <div class="card"><div class="cap">今週の通知</div><div class="val">{{ week_total|default:"0" }}</div></div>
      <div class="card"><div class="cap">今週の採用</div><div class="val">{{ week_taken|default:"0" }}</div></div>
      <div class="card"><div class="cap">採用率</div><div class="val">{{ week_rate|floatformat:2|default:"0.00" }}</div></div>
      <div class="card"><div class="cap">API</div><div class="val">JSON</div></div>
    </div>

    <!-- 地合い（ブレッドス）サマリ -->
    <div class="sec-ttl">地合い（ブレッドス）</div>
    <div class="panel">
      <div class="grid">
        <div class="card">
          <div class="cap">レジーム</div>
          <div class="val regime {{ breadth.regime|default:'NEUTRAL' }}">{{ breadth.regime|default:"NEUTRAL" }}</div>
        </div>
        <div class="card">
          <div class="cap">スコア</div>
          <div class="val">{{ breadth.score|floatformat:2|default:"—" }}</div>
        </div>
        <div class="card">
          <div class="cap">騰落比（Adv/Dec）</div>
          <div class="val">{{ breadth.ad_ratio|floatformat:2|default:"—" }}</div>
        </div>
        <div class="card">
          <div class="cap">出来高比（Up/Down）</div>
          <div class="val">{{ breadth.vol_ratio|floatformat:2|default:"—" }}</div>
        </div>
      </div>
      <div class="tiny" style="margin-top:6px;">
        新高値-新安値: {{ breadth.hl_diff|floatformat:0|default:"—" }}
      </div>
    </div>

    <div class="sec-ttl">週次トレンド</div>
    <div class="panel">
      <table class="basic">
        <thead>
          <tr>
            <th style="width:34%;">週 (Mon)</th>
            <th class="num">通知合計</th>
            <th class="num">採用数</th>
            <th class="num">採用率</th>
          </tr>
        </thead>
        <tbody>
          {% for w in weekly %}
          <tr>
            <td>{{ w.week }}</td>
            <td class="num">{{ w.total }}</td>
            <td class="num">{{ w.taken }}</td>
            <td class="num">{{ w.rate|floatformat:2 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- ===== セクター（PF×RS） ===== -->
  <section id="sec-sectors" class="sec" aria-labelledby="tab-sectors">
    <div class="sec-ttl">セクター概況 <span class="chip">ウェイト × RS（弱≦{{ rs_weak|floatformat:2 }} / 強≧{{ rs_strong|floatformat:2 }}）</span></div>
    <div class="panel">
      <table class="basic">
        <thead>
          <tr>
            <th>セクター</th>
            <th style="width:36%;">ウェイト</th>
            <th style="width:24%;">RS</th>
            <th style="width:10%;" class="num">比率</th>
          </tr>
        </thead>
        <tbody>
        {% for r in sectors %}
          <tr>
            <td>
              <div style="display:flex;align-items:center;gap:.5rem;">
                <span>{{ r.sector }}</span>
                <span class="badge {{ r.level_cls }}">{{ r.level_txt }}</span>
              </div>
            </td>
            <td>
              <div class="bar"><div class="fill" style="width: {{ r.weight_bar }}%;"></div></div>
            </td>
            <td>
              <div style="display:flex;align-items:center;gap:.6rem;">
                <div class="rsbar bar" style="flex:1;"><div class="fill" style="width: {{ r.rs_norm }}%;"></div></div>
                <div class="num" style="width:3.8rem;">{{ r.rs|floatformat:2 }}</div>
              </div>
            </td>
            <td class="num">{{ r.weight_pct|floatformat:2 }}%</td>
          </tr>
        {% empty %}
          <tr><td colspan="4" class="tiny">保有がありません。</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="tiny" style="margin-top:8px;">総評価額: ¥{{ total_mv|floatformat:0 }}（ウェイト最大を100%スケールとして棒長表示）</div>
  </section>

  <!-- ===== しきい値（policy.json：サーバ描画のカード） ===== -->
  <section id="sec-policy" class="sec" aria-labelledby="tab-policy">
    <div class="sec-ttl">しきい値（policy.json）</div>

    {% with p=policy_text %}
      <div class="panel tiny" style="margin-bottom:6px;">
        <span class="chip">更新: {{ p.updated_at|default:"--" }}</span>
        <span class="chip">窓: 過去 {{ p.window_days|default:"—" }} 日</span>
        <span class="chip">通知が多い週は <code>advisor_notify_tune</code> が tighten（目標10/週）</span>
        <span class="chip">静かな週は loosen</span>
      </div>

      <div class="cards">
        <!-- セクション見出し -->
        <div class="p-card" style="grid-column:1/-1;background:rgba(255,255,255,.03);">
          <div class="cap">セクション</div><div class="val" style="font-size:1.1rem;">RS（相対強弱）しきい値</div>
        </div>
        <div class="p-card"><div class="cap">rs 弱め</div><div class="val">{{ p.rs_weak|default:"—" }}</div></div>
        <div class="p-card"><div class="cap">rs 強め</div><div class="val">{{ p.rs_strong|default:"—" }}</div></div>

        <div class="p-card" style="grid-column:1/-1;background:rgba(255,255,255,.03);">
          <div class="cap">セクション</div><div class="val" style="font-size:1.1rem;">通知トリガー（評価指標）</div>
        </div>
        <div class="p-card"><div class="cap">ROI乖離 min</div><div class="val">{{ p.gap_min|default:"—" }}</div></div>
        <div class="p-card"><div class="cap">流動性 max</div><div class="val">{{ p.liq_max|default:"—" }}</div></div>
        <div class="p-card"><div class="cap">信用比率 min</div><div class="val">{{ p.margin_min|default:"—" }}</div></div>

        <div class="p-card" style="grid-column:1/-1;background:rgba(255,255,255,.03);">
          <div class="cap">セクション</div><div class="val" style="font-size:1.1rem;">構成（セクター制約）</div>
        </div>
        <div class="p-card"><div class="cap">上位セクター max</div><div class="val">{{ p.top_share_max|default:"—" }}</div></div>
        <div class="p-card"><div class="cap">未分類 max</div><div class="val">{{ p.uncat_share_max|default:"—" }}</div></div>

        <div class="p-card" style="grid-column:1/-1;background:rgba(255,255,255,.03);">
          <div class="cap">セクション</div><div class="val" style="font-size:1.1rem;">地合い（ブレッドス）</div>
        </div>
        <div class="p-card"><div class="cap">地合い 弱</div><div class="val">{{ p.breadth_bad|default:"—" }}</div></div>
        <div class="p-card"><div class="cap">地合い 強</div><div class="val">{{ p.breadth_good|default:"—" }}</div></div>
      </div>
    {% endwith %}

    <details class="panel tiny">
      <summary>RAW表示（policy.json サマリ）</summary>
      <pre>{{ policy_preview }}</pre>
    </details>

    <div class="tiny" style="margin-top:10px;">
      <a href="{% url 'notify_dashboard' %}?format=json" target="_blank" rel="noopener">
        ▶ API: /advisor/notify-dashboard/?format=json
      </a>
    </div>
  </section>
</div>

<script>
  // セグメント切替（ローカル保存して復元）
  (function(){
    const KEY = 'notify_dash_seg';
    const buttons = document.querySelectorAll('.seg-btn');
    const secs = ['#sec-dashboard','#sec-sectors','#sec-policy'].map(id => document.querySelector(id));
    function activate(targetId){
      buttons.forEach(b => b.classList.toggle('active', b.dataset.target === targetId));
      secs.forEach(s => s.classList.toggle('show', '#'+s.id === targetId));
      try { localStorage.setItem(KEY, targetId); } catch(e){}
    }
    buttons.forEach(b => b.addEventListener('click', () => activate(b.dataset.target)));
    let saved = null; try { saved = localStorage.getItem(KEY) } catch(e){}
    const initial = saved && document.querySelector(saved) ? saved : '#sec-dashboard';
    activate(initial);
  })();
</script>
{% endblock %}