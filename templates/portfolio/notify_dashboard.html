{% extends "base.html" %}
{% load static %}
{% block title %}AIアドバイザー 通知ダッシュボード{% endblock %}

{% block extra_css %}
<style>
  /* ===== chips ===== */
  .chip{display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .6rem;border-radius:9999px;
        background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);backdrop-filter:saturate(120%) blur(2px)}
  .chip .v{font-weight:700}
  .chip.ok{background:rgba(25,135,84,.10);border-color:rgba(25,135,84,.35)}
  .chip.warn{background:rgba(255,193,7,.10);border-color:rgba(255,193,7,.35)}
  .chip.bad{background:rgba(220,53,69,.10);border-color:rgba(220,53,69,.35)}

  /* ===== cards ===== */
  .kpi{border-radius:.9rem}
  .kpi .t{opacity:.85;font-size:.9rem}
  .kpi .v{font-weight:800;font-size:1.35rem}

  /* ===== section ===== */
  .section-title{font-weight:800;font-size:1.05rem;margin-bottom:.5rem}
  .section{border-radius:1rem;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.02)}
  .pre-json{white-space:pre-wrap;word-break:break-word;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.9rem;margin:0}

  /* ===== weekly table ===== */
  .table thead th{position:sticky;top:0;background:var(--bs-body-bg)}
  .bar{height:.5rem;border-radius:6px;background:rgba(255,255,255,.08)}
  .bar > span{display:block;height:100%;border-radius:6px;background:var(--bs-primary)}
</style>
{% endblock %}

{% block content %}
<div class="container py-3">

  <!-- Header -->
  <div class="d-flex align-items-center mb-3">
    <h1 class="h5 mb-0">AIアドバイザー 通知ダッシュボード</h1>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="?format=json&days={{ days|default:'90' }}">JSON</a>
    </div>
  </div>

  <!-- KPI chips -->
  <div class="row g-2 mb-3">
    <div class="col-6 col-md-3">
      <div class="card kpi p-3">
        <div class="t">期間</div>
        <div class="v">{{ days|default:'90' }} 日</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card kpi p-3">
        <div class="t">今週の通知</div>
        <div class="v">{{ week_total|default:'0' }} 件</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="card kpi p-3">
        <div class="t">今週の採用</div>
        <div class="v">{{ week_taken|default:'0' }} 件</div>
      </div>
    </div>
    <div class="col-6 col-md-3">
      {% with r=week_rate|default:0 %}
      <div class="card kpi p-3">
        <div class="t">採用率</div>
        <div class="v">{{ r|floatformat:2 }}</div>
        <div class="mt-2">
          <span class="chip {% if r >= 0.5 %}ok{% elif r >= 0.2 %}warn{% else %}bad{% endif %}">
            目標 0.50 / <span class="v">{{ r|floatformat:2 }}</span>
          </span>
        </div>
      </div>
      {% endwith %}
    </div>
  </div>

  <!-- policy chips -->
  <div class="section p-3 mb-3">
    <div class="section-title">しきい値（policy.json）</div>

    {% comment %} view から policy(dict) を渡している前提。null/未設定は '—' 表示。 {% endcomment %}
    {% with P=policy %}
      {% if P %}
        {% with RS=P.rs_thresholds NT=P.notify_thresholds %}
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <span class="chip">rs 弱気: <span class="v">
              {% if RS and RS.weak is not None %}{{ RS.weak|floatformat:2 }}{% else %}—{% endif %}
            </span></span>
            <span class="chip">rs 強気: <span class="v">
              {% if RS and RS.strong is not None %}{{ RS.strong|floatformat:2 }}{% else %}—{% endif %}
            </span></span>

            <span class="chip">ROI乖離 min: <span class="v">
              {% if NT and NT.gap_min is not None %}{{ NT.gap_min|floatformat:0 }}pt{% else %}—{% endif %}
            </span></span>
            <span class="chip">流動性 max: <span class="v">
              {% if NT and NT.liq_max is not None %}{{ NT.liq_max|floatformat:0 }}%{% else %}—{% endif %}
            </span></span>
            <span class="chip">信用比率 min: <span class="v">
              {% if NT and NT.margin_min is not None %}{{ NT.margin_min|floatformat:0 }}%{% else %}—{% endif %}
            </span></span>
            <span class="chip">上位セクター max: <span class="v">
              {% if NT and NT.top_share_max is not None %}{{ NT.top_share_max|floatformat:0 }}%{% else %}—{% endif %}
            </span></span>
            <span class="chip">未分類 max: <span class="v">
              {% if NT and NT.uncat_share_max is not None %}{{ NT.uncat_share_max|floatformat:0 }}%{% else %}—{% endif %}
            </span></span>
            <span class="chip">地合い 弱: <span class="v">
              {% if NT and NT.breadth_bad is not None %}{{ NT.breadth_bad|floatformat:2 }}{% else %}—{% endif %}
            </span></span>
            <span class="chip">地合い 強: <span class="v">
              {% if NT and NT.breadth_good is not None %}{{ NT.breadth_good|floatformat:2 }}{% else %}—{% endif %}
            </span></span>
          </div>
        {% endwith %}
      {% else %}
        <div class="text-muted small">policy.json の要約が未設定（ビューが <code>policy</code> を渡していないか、ファイル未生成）。</div>
      {% endif %}
    {% endwith %}

    {% if policy_preview %}
      <details class="mt-2">
        <summary class="small text-muted">RAW表示（policy.json サマリ）</summary>
        <pre class="pre-json mt-2">{{ policy_preview }}</pre>
      </details>
    {% endif %}
  </div>

  <!-- how to -->
  <div class="section p-3 mb-3">
    <div class="section-title">使い方</div>
    <ul class="mb-0 small">
      <li>通知が多い週は <code>advisor_notify_tune</code> が自動で tighten（目標 週10件）</li>
      <li>静かな週は loosen</li>
      <li>API: <code>/advisor/notify-dashboard/?format=json</code></li>
    </ul>
  </div>

  <!-- weekly trend -->
  <div class="section p-0">
    <div class="p-3 section-title mb-0">週次トレンド</div>
    {% if weekly %}
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th style="min-width:120px">週 (Mon)</th>
              <th class="text-end">通知合計</th>
              <th class="text-end">採用数</th>
              <th class="text-end">採用率</th>
              <th style="min-width:120px">推移</th>
            </tr>
          </thead>
          <tbody>
            {% for row in weekly %}
              <tr>
                <td>{{ row.week }}</td>
                <td class="text-end">{{ row.total }}</td>
                <td class="text-end">{{ row.taken }}</td>
                <td class="text-end">{{ row.rate|default:0|floatformat:2 }}</td>
                <td>
                  {% if weekly_max %}
                    {% with pct=row.total|divisibleby:weekly_max %}
                    <div class="bar"><span style="width: {{ row.total|floatformat:0|add:'0'|floatformat:0|floatformat:'0' }}%"></span></div>
                    {% endwith %}
                  {% else %}
                    <div class="bar"><span style="width: {% if row.total > 0 %}100{% else %}0{% endif %}%"></span></div>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="p-3 text-muted small">データがありません。まずは通知が生成される操作（例：スナップショット/アドバイス生成）を実行してください。</div>
    {% endif %}
  </div>

</div>
{% endblock %}