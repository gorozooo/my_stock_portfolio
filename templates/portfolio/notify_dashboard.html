{% extends "base.html" %}
{% load static %}

{% block title %}AIアドバイザー 通知ダッシュボード{% endblock %}

{% block content %}
<style>
/* ---- コンパクト版 ---- */
.page{max-width:980px;margin:0 auto;padding:12px 14px 80px;}
.hint{opacity:.75;font-size:.92rem}

/* セグメント（非 sticky／控えめ・中央揃え） */
.seg{display:flex;justify-content:center;gap:10px;margin:6px 0 10px}
.seg-btn{
  appearance:none;border:1px solid rgba(255,255,255,.16);
  background:rgba(255,255,255,.06);color:#fff;
  padding:6px 12px;border-radius:999px;font-size:.95rem
}
.seg-btn.active{background:rgba(255,255,255,.14);border-color:transparent}

/* チップ */
.chips{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin:6px 0}
.chip{padding:3px 10px;border-radius:999px;font-size:.85rem;
  background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)}

/* 小さめカード */
.cards{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin:6px 0 8px}
@media (min-width:640px){.cards{grid-template-columns:repeat(4,1fr)}}
.card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10);
  border-radius:10px;padding:10px 12px}
.card h4{margin:0 0 4px;font-size:.82rem;opacity:.78}
.card .v{font-size:1.2rem;font-weight:700}

/* 週次テーブル（コンパクト行高） */
.tbl{width:100%;border-collapse:collapse;margin-top:6px}
.tbl th,.tbl td{padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.08);text-align:right}
.tbl th:first-child,.tbl td:first-child{text-align:left}
.tbl thead th{font-weight:700;opacity:.85}

/* セクター（行カード + 細バー） */
.sectors{display:flex;flex-direction:column;gap:8px}
.sector{display:grid;grid-template-columns:1fr auto;gap:6px 10px;
  padding:10px;border-radius:10px;background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.10)}
.sector .name{font-weight:700}
.badge{padding:3px 9px;border-radius:999px;font-size:.8rem;border:1px solid transparent}
.badge.neutral{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.12)}
.badge.strong{background:rgba(46,204,113,.18);border-color:rgba(46,204,113,.35)}
.badge.weak{background:rgba(231,76,60,.20);border-color:rgba(231,76,60,.38)}
.meta{opacity:.78;font-size:.88rem}
.bar-wrap{grid-column:1 / -1}
.bar{height:8px;border-radius:999px;overflow:hidden;
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12)}
.bar>i{display:block;height:100%}
.fill{background:linear-gradient(90deg,#7aa8ff,#b7d2ff)}

/* セクション切替 */
.section{display:none}
.section.active{display:block}
.tiny{opacity:.7;font-size:.85rem}
</style>

<div class="page">
  <h2>AIアドバイザー 通知ダッシュボード</h2>

  <!-- セグメント（非 sticky） -->
  <div class="seg" role="tablist" aria-label="sections">
    <button class="seg-btn active" data-target="#sec-dashboard">ダッシュボード</button>
    <button class="seg-btn" data-target="#sec-sectors">セクター</button>
    <button class="seg-btn" data-target="#sec-policy">しきい値</button>
  </div>

  <!-- = ダッシュボード = -->
  <section id="sec-dashboard" class="section active">
    <div class="chips">
      <span class="chip">サマリ</span>
      <span class="chip">過去 {{ days }} 日</span>
    </div>

    <div class="cards">
      <div class="card"><h4>今週の通知</h4><div class="v">{{ week_total|default:0 }}</div></div>
      <div class="card"><h4>今週の採用</h4><div class="v">{{ week_taken|default:0 }}</div></div>
      <div class="card"><h4>採用率</h4><div class="v">{{ week_rate|floatformat:2 }}</div></div>
      <div class="card"><h4>API</h4><div class="v"><a href="{% url 'notify_dashboard' %}?format=json" target="_blank">JSON</a></div></div>
    </div>

    <h3 style="margin:6px 0 0;">週次トレンド</h3>
    <table class="tbl">
      <thead><tr><th>週 (Mon)</th><th>通知合計</th><th>採用数</th><th>採用率</th></tr></thead>
      <tbody>
      {% for r in weekly %}
        <tr><td>{{ r.week }}</td><td>{{ r.total }}</td><td>{{ r.taken }}</td><td>{{ r.rate|floatformat:2 }}</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- = セクター = -->
  <section id="sec-sectors" class="section">
    <div class="chips">
      <span class="chip">セクター概況</span>
      <span class="chip">ウェイト × RS</span>
      <span class="chip">総評価額: ¥{{ total_mv|floatformat:0 }}</span>
      <span class="chip">更新: {{ now|date:"Y-m-d H:i" }}</span>
    </div>

    <div class="sectors">
      {% for row in sector_rows %}
        {% with rs=row.rs %}
        <div class="sector" data-rs="{{ rs }}">
          <div class="name">{{ row.sector }}</div>
          <div class="badge neutral">RS {{ rs|floatformat:2 }}</div>
          <div class="meta">ウェイト {{ row.weight_pct|floatformat:2 }}%{% if row.rs_date %} ／ RS基準日: {{ row.rs_date }}{% endif %}</div>
          <div class="bar-wrap"><div class="bar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ row.weight_pct|floatformat:2 }}"><i class="fill" style="width:{{ row.weight_pct|floatformat:2 }}%"></i></div></div>
        </div>
        {% endwith %}
      {% empty %}
        <p class="hint">保有ポートフォリオが見つかりませんでした。</p>
      {% endfor %}
    </div>
  </section>

  <!-- = しきい値 = -->
  <section id="sec-policy" class="section">
    <div class="chips"><span class="chip">しきい値（policy.json サマリ）</span></div>

    {% if policy_text %}
      <div class="cards" style="grid-template-columns:repeat(2,1fr);">
        <div class="card"><h4>rs 弱<=</h4><div class="v">{{ policy_text.rs_weak|default:"—" }}</div></div>
        <div class="card"><h4>rs 強>=</h4><div class="v">{{ policy_text.rs_strong|default:"—" }}</div></div>
        <div class="card"><h4>ROI乖離 min</h4><div class="v">{{ policy_text.gap_min|default:"—" }}</div></div>
        <div class="card"><h4>流動性 max</h4><div class="v">{{ policy_text.liq_max|default:"—" }}</div></div>
        <div class="card"><h4>信用比率 min</h4><div class="v">{{ policy_text.margin_min|default:"—" }}</div></div>
        <div class="card"><h4>上位セクター max</h4><div class="v">{{ policy_text.top_share_max|default:"—" }}</div></div>
        <div class="card"><h4>未分類 max</h4><div class="v">{{ policy_text.uncat_share_max|default:"—" }}</div></div>
        <div class="card"><h4>地合い 弱<=</h4><div class="v">{{ policy_text.breadth_bad|default:"—" }}</div></div>
        <div class="card"><h4>地合い 強>=</h4><div class="v">{{ policy_text.breadth_good|default:"—" }}</div></div>
      </div>
      <div class="tiny" style="margin-top:6px">
        <a class="chip" href="{% url 'notify_dashboard' %}?format=json" target="_blank">RAW表示（policy.json サマリ）</a>
      </div>
    {% else %}
      <div class="hint">表示できるサマリがありません（policy.json 未生成）</div>
    {% endif %}
  </section>
</div>

<script>
(function(){
  // タブ切替（非 sticky）
  const btns=document.querySelectorAll('.seg-btn');
  const secs=['#sec-dashboard','#sec-sectors','#sec-policy'].map(s=>document.querySelector(s));
  btns.forEach(b=>{
    b.addEventListener('click',()=>{
      btns.forEach(x=>x.classList.remove('active')); b.classList.add('active');
      const t=b.getAttribute('data-target');
      secs.forEach(s=>s.classList.toggle('active','#'+s.id===t));
      window.scrollTo({top:0,behavior:'smooth'});
    });
  });

  // RSバッジ色分け（ポリシー無い時はデフォルト）
  const RS_WEAK = {{ policy_text.rs_weak|default:"-0.25" }};
  const RS_STRONG = {{ policy_text.rs_strong|default:"0.35" }};
  document.querySelectorAll('.sector').forEach(sec=>{
    const rs=parseFloat(sec.dataset.rs||'0'), badge=sec.querySelector('.badge');
    badge.classList.remove('neutral','weak','strong');
    if(!isFinite(rs)){ badge.classList.add('neutral'); badge.textContent='RS —'; return; }
    if(rs<=RS_WEAK) badge.classList.add('weak'); else if(rs>=RS_STRONG) badge.classList.add('strong'); else badge.classList.add('neutral');
    badge.textContent=`RS ${rs.toFixed(2)}`;
  });
})();
</script>
{% endblock %}