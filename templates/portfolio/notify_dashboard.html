{% extends "base.html" %}
{% load static %}

{% block title %}AIアドバイザー 通知ダッシュボード{% endblock %}

{% block extra_head %}
<style>
  :root{
    --card-bg: rgba(255,255,255,0.04);
    --chip-bg: rgba(255,255,255,0.06);
    --chip-active: rgba(140, 180, 255, 0.20);
    --text-dim: rgba(255,255,255,0.7);
  }

  /* ==== サブナビ（上部・中央・sticky） ==== */
  .subnav-wrap{
    position: sticky;
    top: calc(env(safe-area-inset-top, 0px) + 0px); /* iOS安全域 */
    z-index: 9;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    background: linear-gradient(180deg, rgba(10,12,24,0.85) 0%, rgba(10,12,24,0.45) 100%);
    padding: 10px 12px 12px;
    margin: 0 -12px; /* baseの左右paddingを相殺して全幅に */
  }
  .subnav{
    display: flex;
    justify-content: center;   /* 中央寄せ */
    align-items: center;
    gap: 10px;
  }
  .seg-btn{
    appearance: none;
    border: none;
    border-radius: 999px;
    padding: 10px 16px;
    font-weight: 700;
    letter-spacing: .02em;
    background: var(--chip-bg);
    color: #fff;
    transition: transform .04s ease, background .2s ease, opacity .2s ease;
    opacity: .9;
  }
  .seg-btn:active{ transform: translateY(1px); }
  .seg-btn[aria-current="true"]{
    background: var(--chip-active);
    outline: 1px solid rgba(160,190,255,.25);
    opacity: 1;
  }

  /* セクション余白調整（サブナビ直下の見出しを少し詰める） */
  .section-head{
    margin-top: 10px;
    margin-bottom: 8px;
    font-size: 0.92rem;
    color: var(--text-dim);
  }

  /* カード/テーブルは既存スタイルを利用。スマホでの左右余白だけ微調整 */
  .metric-cards{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media (min-width: 520px){
    .metric-cards{ grid-template-columns: repeat(4, 1fr); }
  }
  .card{
    background: var(--card-bg);
    border-radius: 14px;
    padding: 16px 14px;
  }
  .card .title{ font-size:.88rem; color:var(--text-dim); margin-bottom:6px;}
  .card .value{ font-size:1.8rem; font-weight:800; letter-spacing:.02em; }

  /* テーブルのスクロール影 */
  .table-wrap{ overflow:auto; border-radius: 12px; background: var(--card-bg); }
  table{ width:100%; border-collapse: collapse; min-width: 560px; }
  th, td{ padding: 12px 14px; border-bottom: 1px solid rgba(255,255,255,0.06); }
  th{ text-align:left; color:var(--text-dim); font-weight:700; font-size:.9rem; }

  /* セクター表のプログレス（簡易バー） */
  .bar{
    height: 8px; border-radius: 6px; background: rgba(255,255,255,.08); overflow: hidden;
  }
  .bar > i{
    display:block; height:100%; width:var(--w,0%); background: rgba(160,190,255,.55);
  }

  /* 小さめリンク */
  .tiny a{ color:#aecdff; text-decoration: underline dotted; }
</style>
{% endblock %}

{% block content %}
<div class="container py-3">

  <h1 class="mb-2">AIアドバイザー 通知ダッシュボード</h1>

  <!-- ==== サブナビ（上部・中央・sticky） ==== -->
  <div class="subnav-wrap">
    <nav class="subnav" role="tablist" aria-label="通知ダッシュボード内ナビ">
      <button class="seg-btn" aria-current="true" data-target="#sec-dashboard">ダッシュボード</button>
      <button class="seg-btn" data-target="#sec-sectors">セクター</button>
      <button class="seg-btn" data-target="#sec-policy">しきい値</button>
    </nav>
  </div>

  <!-- ==== サマリ（任意の説明文） ==== -->
  <div class="section-head">サマリ　過去 {{ days }} 日</div>

  <!-- ==== 概要カード ==== -->
  <div class="metric-cards mb-3">
    <div class="card">
      <div class="title">今週の通知</div>
      <div class="value">{{ week_total }}</div>
    </div>
    <div class="card">
      <div class="title">今週の採用</div>
      <div class="value">{{ week_taken }}</div>
    </div>
    <div class="card">
      <div class="title">採用率</div>
      <div class="value">{{ week_rate|floatformat:2 }}</div>
    </div>
    <div class="card">
      <div class="title">API</div>
      <div class="value" style="font-size:1.6rem;">JSON</div>
    </div>
  </div>

  <!-- ===================== セクション：ダッシュボード ===================== -->
  <section id="sec-dashboard" class="mb-4">
    <h3 class="mb-2">週次トレンド</h3>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>週 (Mon)</th><th>通知合計</th><th>採用数</th><th>採用率</th></tr>
        </thead>
        <tbody>
          {% for r in weekly %}
          <tr>
            <td>{{ r.week }}</td>
            <td>{{ r.total }}</td>
            <td>{{ r.taken }}</td>
            <td>{{ r.rate|floatformat:2 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- ===================== セクション：セクター（任意・あれば） ===================== -->
  {% if sectors %}
  <section id="sec-sectors" class="mb-5" hidden>
    <h3 class="mb-2">セクター概況 <span class="text-muted">（ウェイト × RS）</span></h3>
    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>セクター</th><th>ウェイト</th><th style="width:160px;">バー</th><th>RS</th><th>所感</th></tr>
        </thead>
        <tbody>
          {% for s in sectors %}
          <tr>
            <td>{{ s.sector }}</td>
            <td>{{ s.weight_pct|floatformat:2 }}%</td>
            <td>
              <div class="bar"><i style="--w: {{ s.weight_pct|stringformat:'d' }}%;"></i></div>
            </td>
            <td>{{ s.rs|floatformat:2 }}</td>
            <td class="text-muted">{{ s.note }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  {% endif %}

  <!-- ===================== セクション：しきい値（policy.json） ===================== -->
  <section id="sec-policy" class="mb-3" hidden>
    <h3 class="mb-2">しきい値（policy.json）</h3>
    <div class="card mb-2">
      {% if policy_text %}
        <div class="mb-1" style="font-weight:700;">サマリ</div>
        <div class="text-muted" style="line-height:1.7;">
          rs 弱気: <b>{{ policy_text.rs_weak|default:"—" }}</b> ｜
          rs 強気: <b>{{ policy_text.rs_strong|default:"—" }}</b> ｜
          ROI乖離 min: <b>{{ policy_text.gap_min|default:"—" }}</b> ｜
          流動性 max: <b>{{ policy_text.liq_max|default:"—" }}</b> ｜
          信用比率 min: <b>{{ policy_text.margin_min|default:"—" }}</b> ｜
          上位セクター max: <b>{{ policy_text.top_share_max|default:"—" }}</b> ｜
          未分類 max: <b>{{ policy_text.uncat_share_max|default:"—" }}</b> ｜
          地合い 弱: <b>{{ policy_text.breadth_bad|default:"—" }}</b> ｜
          地合い 強: <b>{{ policy_text.breadth_good|default:"—" }}</b>
        </div>
      {% else %}
        <div class="text-muted">表示できるサマリがありません（policy.json 未生成/空）。</div>
      {% endif %}
    </div>

    <div class="tiny">
      • <a href="/advisor/notify-dashboard/?format=json" target="_blank" rel="noopener">RAW表示（policy.json サマリ）</a>
    </div>
  </section>

</div>

<script>
  // セグメント切替：押したタブを active にして対象セクションだけ表示
  (function(){
    const buttons = document.querySelectorAll('.seg-btn');
    const secs = ['#sec-dashboard','#sec-sectors','#sec-policy'].map(s=>document.querySelector(s)).filter(Boolean);

    function activate(btn){
      buttons.forEach(b=>b.setAttribute('aria-current', b===btn ? 'true':'false'));
      const target = document.querySelector(btn.dataset.target);
      secs.forEach(s => s.hidden = (s !== target));
      // スクロール位置をサブナビのすぐ下へ
      const wrap = document.querySelector('.subnav-wrap');
      if (wrap) window.scrollTo({top: wrap.offsetTop, behavior: 'smooth'});
    }
    buttons.forEach(b=>b.addEventListener('click', ()=>activate(b)));

    // 初期状態（1番目をactive）
    const current = document.querySelector('.seg-btn[aria-current="true"]') || buttons[0];
    if (current) activate(current);
  })();
</script>
{% endblock %}