{% extends "base.html" %}
{% load static %}

{% block title %}AIアドバイザー 通知ダッシュボード{% endblock %}

{% block content %}
<style>
  /* ---- 基本 ---- */
  .page-wrap{max-width:960px;margin:0 auto;padding:16px 12px;}
  .h1{font-size:1.35rem;font-weight:700;margin:4px 0 14px;}
  .muted{opacity:.7}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border-color,rgba(255,255,255,.15));
        border-radius:999px;font-size:.92rem;line-height:1;background:rgba(255,255,255,.05)}
  .chip .k{opacity:.7}
  .card{border:1px solid var(--border-color,rgba(255,255,255,.12));border-radius:12px;padding:14px 14px;margin:12px 0;background:rgba(255,255,255,.03)}
  .card h3{margin:0 0 10px;font-size:1.02rem}
  .kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .kpi{padding:10px;border-radius:10px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08)}
  .kpi .v{font-weight:700;font-size:1.25rem}
  .kpi small{opacity:.7}
  @media (max-width:640px){.kpi-grid{grid-template-columns:1fr 1fr}}
  /* ---- テーブル ---- */
  table.tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
  .tbl th{font-weight:600;opacity:.85}
  .bar{height:8px;border-radius:6px;background:rgba(255,255,255,.08);position:relative;overflow:hidden}
  .bar > i{position:absolute;left:0;top:0;bottom:0;width:0;background:currentColor;border-radius:6px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);font-size:.85rem}
  .good{color:#7cd67c}.warn{color:#e6c16a}.bad{color:#ee7f85}
  /* ---- 折りたたみ ---- */
  details.jsonbox{margin-top:6px}
  details.jsonbox pre{max-height:360px;overflow:auto;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.1);
                      border-radius:10px;padding:10px 12px;font-size:.9rem}
</style>

<div class="page-wrap">
  <div class="h1">AIアドバイザー 通知ダッシュボード</div>

  <!-- 上段 KPI -->
  <div class="card">
    <div class="kpi-grid">
      <div class="kpi">
        <div class="v">{{ days }}</div>
        <small class="muted">期間（日）</small>
      </div>
      <div class="kpi">
        <div class="v">{{ week_total }}</div>
        <small class="muted">今週の通知</small>
      </div>
      <div class="kpi">
        <div class="v">{{ week_taken }}</div>
        <small class="muted">今週の採用</small>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;align-items:center;gap:10px">
      {% if week_rate >= 0.6 %}
        {% with cls="good" %}
          <span class="pill {{cls}}">採用率 {{ week_rate|floatformat:2 }}</span>
        {% endwith %}
      {% elif week_rate >= 0.4 %}
        <span class="pill warn">採用率 {{ week_rate|floatformat:2 }}</span>
      {% else %}
        <span class="pill bad">採用率 {{ week_rate|floatformat:2 }}</span>
      {% endif %}
      <span class="muted">目標 <strong>0.50</strong> / 現在 <strong>{{ week_rate|floatformat:2 }}</strong></span>
    </div>
  </div>

  <!-- policy スナップ -->
  <div class="card">
    <h3>しきい値（policy.json）</h3>
    <div class="chips">
      {% with rsw=policy.rs_thresholds.weak rsS=policy.rs_thresholds.strong %}
        <span class="chip"><span class="k">rs 弱気</span><b>{{ rsw|default:"—" }}</b></span>
        <span class="chip"><span class="k">rs 強気</span><b>{{ rsS|default:"—" }}</b></span>
      {% endwith %}
      {% with nt=policy.notify_thresholds %}
        <span class="chip"><span class="k">ROI乖離 min</span><b>{{ nt.gap_min|default:"—" }}</b></span>
        <span class="chip"><span class="k">流動性 max</span><b>{{ nt.liq_max|default:"—" }}</b></span>
        <span class="chip"><span class="k">信用比率 min</span><b>{{ nt.margin_min|default:"—" }}</b></span>
        <span class="chip"><span class="k">上位セクター max</span><b>{{ nt.top_share_max|default:"—" }}</b></span>
        <span class="chip"><span class="k">未分類 max</span><b>{{ nt.uncat_share_max|default:"—" }}</b></span>
        <span class="chip"><span class="k">地合い 弱</span><b>{{ nt.breadth_bad|default:"—" }}</b></span>
        <span class="chip"><span class="k">地合い 強</span><b>{{ nt.breadth_good|default:"—" }}</b></span>
      {% endwith %}
      <span class="chip"><span class="k">更新</span><b>{{ policy.updated_at|default:"—" }}</b></span>
    </div>

    <details class="jsonbox">
      <summary>RAW表示（policy.json サマリ）</summary>
      <pre><code>{{ policy_preview }}</code></pre>
    </details>
  </div>

  <!-- 使い方 -->
  <div class="card">
    <h3>使い方</h3>
    <div class="muted" style="line-height:1.7">
      通知数が多い週は <code>advisor_notify_tune</code> が自動で tighten（目標 週10件）。<br>
      静かな週は loosen。API は <code>/advisor/notify-dashboard/?format=json</code>。
    </div>
  </div>

  <!-- 週次トレンド -->
  <div class="card">
    <h3>週次トレンド</h3>
    <table class="tbl" id="weeklyTbl" data-max="{{ weekly_max|default:0 }}">
      <thead>
        <tr>
          <th style="width:32%">週（Mon）</th>
          <th style="width:20%">通知合計</th>
          <th style="width:20%">採用数</th>
          <th style="width:15%">採用率</th>
          <th>推移</th>
        </tr>
      </thead>
      <tbody>
        {% for r in weekly %}
        <tr data-total="{{ r.total }}">
          <td class="muted">{{ r.week }}</td>
          <td>{{ r.total }}</td>
          <td>{{ r.taken }}</td>
          <td>{{ r.rate|floatformat:2 }}</td>
          <td>
            <div class="bar" title="{{ r.total }}">
              <i style="color:rgba(120,165,255,.75)"></i>
            </div>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="5" class="muted">データがありません。まずは通知が発生する操作（スナップショット/アドバイス生成など）を実行してください。</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // 週次の簡易バー幅を JS で計算（Django テンプレでは割り算がしづらいため）
  (function(){
    const tbl = document.getElementById('weeklyTbl');
    if(!tbl) return;
    const max = parseFloat(tbl.dataset.max || '0') || 0;
    const rows = tbl.querySelectorAll('tbody tr');
    rows.forEach(tr=>{
      const total = parseFloat(tr.getAttribute('data-total') || '0') || 0;
      const el = tr.querySelector('.bar > i');
      if(!el) return;
      const w = (max>0)? Math.max(3, Math.round(total/max*100)) : 0; // 最低3%
      el.style.width = w + '%';
    });
  })();
</script>
{% endblock %}