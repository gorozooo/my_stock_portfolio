{% extends "base.html" %}
{% block title %}AIアドバイザー ダッシュボード{% endblock %}

{% block content %}
<style>
  .wrap{max-width:1000px;margin:0 auto;padding:16px 12px}
  .subnav{position:sticky;top:56px;z-index:5;display:flex;gap:8px;padding:8px;background:rgba(0,0,0,.25);backdrop-filter:blur(6px)}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid rgba(255,255,255,.2);border-radius:999px;font-size:.92rem}
  .chip.active{background:rgba(255,255,255,.08)}
  .cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media (min-width:740px){ .cards{grid-template-columns:repeat(4,minmax(0,1fr));} }
  .card{border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(255,255,255,.03);padding:14px}
  .k{font-size:.82rem;opacity:.75;margin-bottom:4px}
  .v{font-size:1.4rem;font-weight:700}
  .section{margin-top:18px}
  .h{font-weight:700;margin:6px 0 10px}
  table.tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);font-size:.85rem;opacity:.9}
  .muted{opacity:.72}
  /* sector */
  .bar{height:10px;border-radius:6px;background:rgba(255,255,255,.08);position:relative;overflow:hidden}
  .bar > i{position:absolute;left:0;top:0;bottom:0;width:0;background:rgba(120,165,255,.75);border-radius:6px}
  .rsdot{display:inline-flex;align-items:center;gap:6px}
  .dot{width:10px;height:10px;border-radius:50%}
  .good{color:#7cd67c}.bad{color:#ee7f85}.warn{color:#e6c16a}
  details.raw summary{cursor:pointer}
</style>

<div class="wrap">

  <!-- 上部タブ -->
  <div class="subnav">
    <a class="chip" href="#dash">ダッシュボード</a>
    <a class="chip" href="#sectors">セクター</a>
    <a class="chip" href="#policy">しきい値</a>
  </div>

  <!-- Top metrics -->
  <div id="dash" class="section">
    <div class="h">サマリ <span class="pill">過去 {{ days }} 日</span></div>
    <div class="cards">
      <div class="card"><div class="k">今週の通知</div><div class="v">{{ week_total }}</div></div>
      <div class="card"><div class="k">今週の採用</div><div class="v">{{ week_taken }}</div></div>
      <div class="card"><div class="k">採用率</div><div class="v">{{ week_rate|floatformat:2 }}</div></div>
      <div class="card"><div class="k">API</div><div class="v"><a href="?format=json" target="_blank">JSON</a></div></div>
    </div>

    <div class="section">
      <div class="h">週次トレンド</div>
      <table class="tbl">
        <thead><tr><th style="width:28%">週 (Mon)</th><th>通知合計</th><th>採用数</th><th>採用率</th></tr></thead>
        <tbody>
          {% for r in weekly %}
            <tr>
              <td>{{ r.week }}</td>
              <td>{{ r.total }}</td>
              <td>{{ r.taken }}</td>
              <td>{{ r.rate|floatformat:2 }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="4" class="muted">データがありません。</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Sector overview -->
  <div id="sectors" class="section">
    <div class="h">セクター概況 <span class="pill">ウェイト × RS</span></div>
    <div class="muted" style="margin-bottom:8px">総評価額: <b>¥{{ total_mv|floatformat:0 }}</b> / 更新: {{ now|date:"Y-m-d H:i" }}</div>

    <div class="card">
      <table class="tbl" id="sectTbl" data-max="{{ max_w|default:0 }}">
        <thead>
          <tr>
            <th style="width:36%">セクター</th>
            <th style="width:15%">ウェイト</th>
            <th style="width:25%">バー</th>
            <th style="width:12%">RS</th>
            <th>所感</th>
          </tr>
        </thead>
        <tbody>
          {% for r in sector_rows %}
            {% with rs=r.rs %}
            <tr data-w="{{ r.weight_pct|floatformat:4 }}">
              <td>{{ r.sector }}</td>
              <td>{{ r.weight_pct|floatformat:2 }}%</td>
              <td><div class="bar" title="{{ r.weight_pct|floatformat:2 }}%"><i></i></div></td>
              <td>
                {% if rs >= 0.35 %}
                  <span class="rsdot good"><span class="dot" style="background:#7cd67c"></span><b>{{ rs|floatformat:2 }}</b></span>
                {% elif rs <= -0.25 %}
                  <span class="rsdot bad"><span class="dot" style="background:#ee7f85"></span><b>{{ rs|floatformat:2 }}</b></span>
                {% else %}
                  <span class="rsdot warn"><span class="dot" style="background:#e6c16a"></span><b>{{ rs|floatformat:2 }}</b></span>
                {% endif %}
              </td>
              <td class="muted">{% if rs >= 0.35 %}強気：利伸ばし/段階利確{% elif rs <= -0.25 %}弱気：圧縮/乗換{% else %}中立{% endif %}</td>
            </tr>
            {% endwith %}
          {% empty %}
            <tr><td colspan="5" class="muted">保有がありません。</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Policy thresholds -->
  <div id="policy" class="section">
    <div class="h">しきい値（policy.json サマリ）</div>
    <div class="card">
      <div class="muted">運用の目安：通知が多い週は <code>advisor_notify_tune</code> が自動で tighten（目標週10件）。静かな週は自然に loosen。</div>
      <details class="raw" style="margin-top:10px">
        <summary>RAW表示（クリックで展開）</summary>
        <pre style="white-space:pre-wrap">{{ policy_preview }}</pre>
      </details>
    </div>
  </div>

</div>

<script>
  // タブのactive切替（アンカー）
  (function(){
    function sync(){
      const h = location.hash || '#dash';
      document.querySelectorAll('.subnav .chip').forEach(a=>{
        a.classList.toggle('active', a.getAttribute('href')===h);
      });
    }
    window.addEventListener('hashchange', sync);
    sync();
  })();

  // セクターバー幅
  (function(){
    const tbl = document.getElementById('sectTbl');
    if(!tbl) return;
    const max = parseFloat(tbl.dataset.max || '0') || 0;
    tbl.querySelectorAll('tbody tr').forEach(tr=>{
      const w = parseFloat(tr.getAttribute('data-w') || '0') || 0;
      const el = tr.querySelector('.bar > i');
      if(!el) return;
      const pct = (max>0)? Math.max(3, Math.round(w/max*100)) : 0; // 最低3%
      el.style.width = pct + '%';
    });
  })();
</script>
{% endblock %}