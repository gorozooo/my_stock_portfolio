{# templates/portfolio/holdings_list.html #}
{% extends "base.html" %}
{% load static %}
{% block title %}ä¿æœ‰ä¸€è¦§{% endblock %}

{% block content %}
  <h1 class="text-xl font-semibold mb-4">ä¿æœ‰ä¸€è¦§</h1>

  <!-- ä¸€è¦§å…¨ä½“ã‚’å·®ã—æ›¿ãˆã‚„ã™ã„ã‚ˆã†ã«ãƒ©ãƒƒãƒ— -->
  <div id="holdingsListRoot">
    {% if rows %}
      <div class="space-y-3">
        {% for r in rows %}
          <!-- 1ã‚«ãƒ¼ãƒ‰ -->
          <section
            class="rounded-2xl p-4 bg-white/5 ring-1 ring-white/10 shadow"
            data-holding-id="{{ r.id }}"
          >
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-semibold">
                  {{ r.ticker }}
                  <span class="text-slate-400 text-sm">{{ r.name }}</span>
                </div>
                <div class="text-slate-300 text-sm mt-1">
                  æ•°é‡: {{ r.quantity }} / å¹³å‡: Â¥{{ r.avg_cost }}
                </div>
              </div>
              <div class="text-right text-xs text-slate-400 shrink-0">
                æ›´æ–°: {{ r.updated_at|date:"Y-m-d H:i" }}
              </div>
            </div>

            <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³åˆ—ï¼ˆHTMXã§å£²å´ã‚·ãƒ¼ãƒˆè¡¨ç¤ºï¼‰ -->
            <div class="mt-3 grid grid-cols-3 gap-2 text-sm">
              <!-- å£²å´ï¼ˆã‚¯ãƒ­ãƒ¼ã‚ºï¼‰ -->
              <button
                type="button"  <!-- â˜… æ—¢å®šã®submitè¡çªã‚’é˜²æ­¢ -->
                class="px-3 py-2 rounded-lg bg-rose-500/15 hover:bg-rose-500/25 text-rose-200 ring-1 ring-rose-400/25 transition"
                hx-get="{% url 'realized_close_sheet' r.id %}"
                hx-target="#sheetRoot"
                hx-swap="innerHTML"
                aria-label="å£²å´ï¼ˆã‚¯ãƒ­ãƒ¼ã‚ºï¼‰"
              >
                ğŸ’± å£²å´ï¼ˆã‚¯ãƒ­ãƒ¼ã‚ºï¼‰
              </button>

              <!-- è©³ç´°ï¼ˆä»»æ„ã®è©³ç´°ãƒšãƒ¼ã‚¸ãŒã‚ã‚Œã°å·®ã—æ›¿ãˆï¼‰ -->
              <a
                href="{% url 'holdings_list' %}?q={{ r.ticker }}"
                class="px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 text-slate-200 ring-1 ring-white/10 text-center transition"
              >
                ğŸ” è©³ç´°
              </a>

              <!-- å®Ÿç¾æç›Šãƒšãƒ¼ã‚¸ã¸ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ -->
              <a
                href="{% url 'realized_list' %}?ticker={{ r.ticker|urlencode }}"
                class="px-3 py-2 rounded-lg bg-indigo-500/15 hover:bg-indigo-500/25 text-indigo-200 ring-1 ring-indigo-400/25 text-center transition"
              >
                ğŸ“„ å®Ÿæã‚’è¦‹ã‚‹
              </a>
            </div>

            <!-- JSãŒç„¡åŠ¹ã§ã‚‚ç§»å‹•ã§ãã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ -->
            <noscript>
              <div class="mt-2">
                <a
                  class="underline text-rose-300"
                  href="{% url 'realized_list' %}?ticker={{ r.ticker|urlencode }}&prefill_qty={{ r.quantity }}"
                >JSãªã—ã§å£²å´å…¥åŠ›ã¸</a>
              </div>
            </noscript>
          </section>
        {% endfor %}
      </div>
    {% else %}
      <div class="rounded-2xl p-4 bg-white/5 ring-1 ring-white/10 shadow">
        <div class="text-slate-300">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
        <div class="text-slate-400 text-sm mt-1">ç®¡ç†ç”»é¢ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆç®¡ç†â†’Holdingsï¼‰ã€‚</div>
      </div>
    {% endif %}
  </div>

  <!-- å£²å´ã‚·ãƒ¼ãƒˆã®å·®ã—è¾¼ã¿å…ˆï¼ˆHTMXãŒã“ã“ã¸æç”»ï¼‰ -->
  <div id="sheetRoot"></div>

  {# ---- inline helper: å£²å´ã‚·ãƒ¼ãƒˆã®é€ä¿¡/é–‰ã˜ã‚‹é…ç·šï¼ˆHTMXã§å·®ã—è¾¼ã¾ã‚ŒãŸå¾Œã«å®Ÿè¡Œï¼‰ ---- #}
  <script>
    (function () {
      const sheetRoot = document.getElementById('sheetRoot');

      function wireSheet(root) {
        if (!root) return;
        // close ãƒœã‚¿ãƒ³
        root.querySelectorAll('[data-dismiss="sheet"]').forEach(btn => {
          btn.addEventListener('click', () => { root.innerHTML = ''; }, { once: true });
        });

        // é€ä¿¡ï¼ˆfetchã§JSONã‚’å—ã‘å–ã‚Šå·®ã—æ›¿ãˆï¼‰
        const form = root.querySelector('.js-close-submit-form');
        if (!form) return;

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const fd = new FormData(form);
          try {
            const res = await fetch(form.action, { method: 'POST', body: fd, headers: {'X-Requested-With':'fetch'} });
            const data = await res.json();
            if (!data || data.ok !== true) {
              alert((data && data.error) || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'); return;
            }
            // ä¿æœ‰ä¸€è¦§ã®å·®ã—æ›¿ãˆï¼ˆã‚µãƒ¼ãƒãƒ¼ã¯ "holdings" ã‚’è¿”ã™ï¼‰
            if (data.holdings) {
              const list = document.getElementById('holdingsListRoot');
              if (list) list.outerHTML = data.holdings;
            }
            // å®Ÿç¾æç›Šãƒšãƒ¼ã‚¸ã‚’é–‹ã„ã¦ã„ãŸå ´åˆã®æ–­ç‰‡æ›´æ–°ã«ã‚‚å¯¾å¿œ
            if (data.table) {
              const t = document.getElementById('pnlTableWrap');
              if (t) t.outerHTML = data.table;
            }
            if (data.summary) {
              const s = document.getElementById('pnlSummaryWrap');
              if (s) s.outerHTML = data.summary;
            }
            // ã‚·ãƒ¼ãƒˆé–‰ã˜ã‚‹
            sheetRoot.innerHTML = '';
          } catch (err) {
            console.error(err);
            alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          }
        }, { once: true });
      }

      // HTMX ã§ sheetRoot ã¸å·®ã—æ›¿ã‚ã£ãŸç›´å¾Œã«é…ç·š
      document.addEventListener('htmx:afterSwap', (e) => {
        if (e.target && e.target.id === 'sheetRoot') wireSheet(sheetRoot);
      });

      // ç›´æ¥ innerHTML ã‚’å…¥ã‚ŒãŸå ´åˆã«ã‚‚ä¸€å¿œ
      const mo = new MutationObserver(() => wireSheet(sheetRoot));
      mo.observe(sheetRoot, { childList: true });
    })();
  </script>
{% endblock %}