{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="glass-card">
  <h2>⚙️ トレード設定</h2>
  <form method="post">
    {% csrf_token %}

    <!-- 口座残高 -->
    <div class="setting-item">
      <label>口座残高</label>
      <input type="number" name="account_equity"
             value="{{ setting.account_equity }}"
             step="10000" min="0"
             class="setting-input">
    </div>

    <!-- リスク％（スライダー + 数字連動） -->
    <div class="setting-item">
      <label>リスク％</label>
      <div class="slider-wrap">
        <input id="riskSlider" type="range" name="risk_pct"
               value="{{ setting.risk_pct }}"
               min="0.1" max="5" step="0.1">
        <span id="riskValue">{{ setting.risk_pct }}%</span>
      </div>
    </div>

    <div class="hr"></div>

    <!-- 年間目標（全体） -->
    <div class="setting-item">
      <label>年間目標（実現損益・全体 / 円）</label>
      <input type="number" name="year_goal_total"
             value="{{ setting.year_goal_total }}"
             step="10000" min="0"
             class="setting-input goal-input">
      <div class="hint">HomeのASSETSで「年残→残り月/週に割り直した必要ペース」を出すための目標（進捗は実現損益のみ）。</div>
    </div>

    <!-- 年間目標（証券会社別） -->
    <div class="setting-item">
      <label>年間目標（証券会社別 / 円）</label>

      <div class="broker-grid">
        {% for key,label in broker_choices %}
          <div class="broker-item">
            <div class="broker-name">{{ label }}</div>
            <input type="number"
                   name="year_goal_broker_{{ key }}"
                   value="{{ broker_goal_map.key|default:'' }}"
                   step="10000" min="0"
                   class="setting-input goal-input">
          </div>
        {% endfor %}
      </div>

      <div class="hint">未入力は0扱い。入力した分だけ保存（0は保存されません）。</div>
    </div>

    <button type="submit" class="btn-save">保存</button>
  </form>
</div>

<script>
  // リスク表示連動
  const slider = document.getElementById('riskSlider');
  const valueLabel = document.getElementById('riskValue');
  slider.addEventListener('input', () => {
    valueLabel.textContent = slider.value + "%";
  });

  // 数字入力を “表示だけ” 読みやすく（フォーカス外れたら整形）
  // ※ type=number はブラウザが勝手に整形することもあるので、ここは控えめ運用
  const goalInputs = document.querySelectorAll('.goal-input');
  goalInputs.forEach(inp => {
    inp.addEventListener('blur', () => {
      // 何もしない（type=numberのまま安全運用）
      // 見た目のカンマ整形までやりたい場合は type=text に変えて別実装にする
    });
  });
</script>

<style>
  .glass-card {
    margin:20px auto; padding:20px;
    border-radius:20px;
    background:rgba(255,255,255,0.05);
    backdrop-filter:blur(12px);
    box-shadow:0 4px 20px rgba(0,0,0,0.2);
    max-width:420px;
  }
  .glass-card h2 { margin:0 0 16px; font-size:20px; }
  .setting-item { margin-bottom:20px; }
  .setting-input {
    width:100%; padding:10px; border-radius:12px;
    border:1px solid rgba(255,255,255,0.2);
    background:rgba(255,255,255,0.1);
    color:#fff;
  }
  .slider-wrap { display:flex; align-items:center; gap:10px; }
  input[type=range] { flex:1; }
  .btn-save {
    width:100%; padding:12px;
    border:none; border-radius:12px;
    background:#26d07c; color:#fff;
    font-size:16px; font-weight:600;
  }

  .hr{
    height:1px;
    background:rgba(255,255,255,0.18);
    margin:14px 0 18px;
  }
  .hint{
    margin-top:8px;
    font-size:12px;
    color:rgba(255,255,255,0.7);
    line-height:1.35;
  }
  .broker-grid{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    margin-top:10px;
  }
  .broker-item{
    padding:10px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,0.14);
    background:rgba(255,255,255,0.04);
  }
  .broker-name{
    font-size:12px;
    color:rgba(255,255,255,0.75);
    margin-bottom:6px;
    font-weight:600;
  }
</style>
{% endblock %}