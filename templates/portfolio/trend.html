<!-- templates/portfolio/trend.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>éŠ˜æŸ„ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤å®š</title>

  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>

  <style>
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial; margin:16px; }
    h2 { font-size:28px; margin:0 0 12px; }
    .row { display:flex; gap:8px; }
    input[type=text]{ flex:1; font-size:16px; padding:12px; border:1px solid #ddd; border-radius:12px; }
    button{ padding:12px 16px; font-size:16px; border:none; border-radius:12px; background:#111; color:#fff; }
    .card{ margin-top:12px; border:1px solid #eee; border-radius:16px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.06);}
    .tag{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; }
    .up{ background:#e6ffed; color:#057a55; }
    .down{ background:#ffecec; color:#b00020; }
    .flat{ background:#f5f5f5; color:#555; }
    .sub{ color:#666; font-size:12px; }
    .chart-wrap { margin-top:12px; border:1px solid #eee; border-radius:16px; padding:12px; height:360px; }
    .htmx-indicator { display:none; }
    .htmx-request .htmx-indicator { display:block; }

    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    .kpi { padding:10px; border:1px solid #eee; border-radius:12px; background:#fafafa; }
    .kpi h4 { margin:0 0 6px; font-size:13px; color:#666; }
    .kpi .v { font-size:16px; font-weight:600; }

    .badge { display:inline-block; padding:2px 10px; border-radius:999px; font-size:12px; }
    .b-green{ background:#e6ffed; color:#057a55; }
    .b-red{ background:#ffecec; color:#b00020; }
    .b-gray{ background:#f5f5f5; color:#555; }
    .err { color:#b00020; margin-top:8px; }

    .badge-decision{display:inline-block;padding:6px 12px;border-radius:999px;font-size:14px;font-weight:700;color:#fff;}
    .badge-buy{background:#26d07c;}
    .badge-watch{background:#f4c542;color:#222;}
    .badge-skip{background:#ff4d4f;}
  </style>
</head>
<body>
  <h2>éŠ˜æŸ„ãƒˆãƒ¬ãƒ³ãƒ‰åˆ¤å®š</h2>

  <div class="row">
    <input id="ticker" type="text" placeholder="ä¾‹: AAPL / MSFT / 7203ï¼ˆ.Tä¸è¦ï¼‰"
           inputmode="latin" autocomplete="off" autocapitalize="characters" spellcheck="false">
    <button id="judgeBtn"
      hx-get="/trend/card"
      hx-target="#result"
      hx-swap="innerHTML"
      hx-indicator="#loading"
      hx-vals='js:{"ticker": document.getElementById("ticker").value.trim()}'>
      åˆ¤å®š
    </button>
  </div>

  <div id="loading" class="sub htmx-indicator">Loading...</div>

  <!-- åˆ¤å®šçµæœã‚«ãƒ¼ãƒ‰ -->
  <div id="result" class="card"></div>

  <!-- ãƒãƒ£ãƒ¼ãƒˆ -->
  <div class="chart-wrap">
    <canvas id="priceChart"></canvas>
  </div>

  <!-- æ ¹æ‹  + æ„æ€æ±ºå®š -->
  <div id="evidence" class="card" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <div class="sub" id="ev-asof"></div>
      <div id="ev-decision"></div>
    </div>
    <div class="grid" id="ev-grid"></div>
    <div id="ev-error" class="err" style="display:none;"></div>
  </div>

  <script>
    const tickerEl = document.getElementById('ticker');
    const btn = document.getElementById('judgeBtn');

    function normalizeTicker(raw){
      const t = (raw || '').trim().toUpperCase();
      if (!t) return t;
      if (t.includes('.')) return t;
      return /^[0-9A-Z]{4,5}$/.test(t) ? `${t}.T` : t;
    }
    tickerEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') btn.click(); });

    let chart;
    async function drawChart(input, days = 180) {
      const ticker = normalizeTicker(input);
      if (!ticker) return;

      try {
        // ä¾¡æ ¼ãƒ‡ãƒ¼ã‚¿
        const r = await fetch(`/api/ohlc?ticker=${encodeURIComponent(ticker)}&days=${days}`);
        const j = await r.json();

        const ctx = document.getElementById('priceChart').getContext('2d');
        if (chart) chart.destroy();

        if (!(j.ok && Array.isArray(j.labels) && j.labels.length)){
          document.querySelector('.chart-wrap').innerHTML =
            '<div style="color:#b00020;padding:8px;">ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
          return;
        }

        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: j.labels,
            datasets: [
              { label: 'Close', data: j.close, borderWidth: 2, pointRadius: 0 },
              { label: 'MA(10)', data: j.ma10, borderWidth: 1, pointRadius: 0, spanGaps: true },
              { label: 'MA(30)', data: j.ma30, borderWidth: 1, pointRadius: 0, spanGaps: true }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: { x: { display: false }, y: { beginAtZero: false, ticks: { callback: v => (typeof v === 'number'? v.toLocaleString(): v) } } },
            plugins: { legend: { display: true } }
          }
        });

        // === ã“ã“ã§ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—ã—ã¦ã€ã‚¨ãƒ³ãƒˆãƒªãƒ¼/æåˆ‡ã‚Šã®æ°´å¹³ãƒ©ã‚¤ãƒ³ã‚’é‡ã­ã‚‹ ===
        try {
          const mres = await fetch(`/api/metrics?ticker=${encodeURIComponent(ticker)}`);
          const m = await mres.json();
          if (m.ok && m.levels){
            const n = j.labels.length;
            const pushLine = (label, val, color, dash=[6,4]) => {
              if (val == null) return;
              chart.data.datasets.push({
                type: 'line',
                label,
                data: Array(n).fill(Number(val)),
                borderWidth: 1.5,
                borderColor: color,
                pointRadius: 0,
                borderDash: dash
              });
            };
            pushLine('Entry(æ¨å¥¨)', m.levels.entry, '#16a34a', [4,4]); // ç·‘
            pushLine('Stop(æ¨å¥¨)',  m.levels.stop,  '#ef4444', [6,4]); // èµ¤
            // å‚è€ƒï¼šã‚¹ã‚¤ãƒ³ã‚°é«˜å®‰ï¼ˆè–„è‰²ï¼‰
            pushLine('Swing High', m.levels.swing_high, '#60a5fa', [2,4]);
            pushLine('Swing Low',  m.levels.swing_low,  '#a78bfa', [2,4]);
            chart.update();
          }
        } catch(e){ console.warn('metrics overlay failed', e); }

      } catch(e) {
        const box = document.querySelector('.chart-wrap');
        box.innerHTML = '<div style="color:#b00020;padding:8px;">ãƒãƒ£ãƒ¼ãƒˆæç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</div>';
        console.error(e);
      }
    }

    // ===== Evidenceï¼ˆè»½é‡æ ¹æ‹  + æ„æ€æ±ºå®šï¼‰ =====
    function smallBadge(text, tone){
      const cls = tone === 'green' ? 'b-green' : tone === 'red' ? 'b-red' : 'b-gray';
      return `<span class="badge ${cls}">${text}</span>`;
    }
    function decisionBadge(label){
      if (label === 'BUY')   return `<span class="badge-decision badge-buy">âœ… è²·ã„å€™è£œ</span>`;
      if (label === 'AVOID') return `<span class="badge-decision badge-skip">ğŸš« è¦‹é€ã‚Š</span>`;
      return `<span class="badge-decision badge-watch">ğŸ‘€ è¦³å¯Ÿ</span>`;
    }
    function fmt(x, d=2){ return (x===null || x===undefined) ? '-' : Number(x).toFixed(d); }

    async function loadEvidence(input){
      const ticker = normalizeTicker(input);
      const box = document.getElementById('evidence');
      const grid = document.getElementById('ev-grid');
      const asof = document.getElementById('ev-asof');
      const err  = document.getElementById('ev-error');
      const dec  = document.getElementById('ev-decision');
      box.style.display = 'none';
      err.style.display = 'none'; err.textContent = ''; dec.innerHTML = '';

      try{
        const r = await fetch(`/api/metrics?ticker=${encodeURIComponent(ticker)}`);
        const j = await r.json();
        if(!j.ok){
          err.textContent = j.error || 'ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
          err.style.display = 'block';
          box.style.display = 'block';
          return;
        }
        asof.textContent = `æ ¹æ‹ ï¼ˆ${j.asof} æ™‚ç‚¹ï¼‰`;
        grid.innerHTML = '';

        // æ„æ€æ±ºå®šãƒãƒƒã‚¸ï¼ˆAPIã« decision ãŒç„¡ã„æƒ³å®šãªã®ã§ãƒ«ãƒ¼ãƒ«ã§æš«å®šï¼‰
        // ãƒ«ãƒ¼ãƒ«ä¾‹ï¼šADX>=20 ã‹ã¤ slope>0 â†’ BUY / slope<0 â†’ AVOID / ãã®ä»– WATCH
        const slope = j.trend?.slope_ann_pct_60 ?? 0;
        const adx = j.trend?.adx14 ?? 0;
        let label = 'WATCH';
        if (slope > 0 && adx >= 20) label = 'BUY';
        else if (slope < 0) label = 'AVOID';
        dec.innerHTML = decisionBadge(label);

        // ãƒˆãƒ¬ãƒ³ãƒ‰
        const ma = j.trend?.ma || {};
        const maStack = ma.stack === 'bull' ? smallBadge('MAæ•´åˆ—:å¼·','green')
                       : ma.stack === 'bear' ? smallBadge('MAæ•´åˆ—:å¼±','red')
                       : smallBadge('MAæ•´åˆ—:ä¸­ç«‹','gray');
        grid.insertAdjacentHTML('beforeend', `
          <div class="kpi"><h4>å›å¸°å‚¾ã(60æ—¥ãƒ»å¹´ç‡)</h4><div class="v">${fmt(slope)}%</div></div>
          <div class="kpi"><h4>ADX(14)</h4><div class="v">${fmt(adx)}</div></div>
          <div class="kpi"><h4>MA20/50/200</h4><div class="v">${fmt(ma["20"],0)} / ${fmt(ma["50"],0)} / ${fmt(ma["200"],0)}</div></div>
          <div class="kpi"><h4>MAæ•´åˆ—</h4><div class="v">${maStack}</div></div>
        `);

        // ç›¸å¯¾
        const rs6 = j.relative?.rs_6m_pct;
        const nearHigh = j.relative?.from_52w_high_pct ?? null;
        const nearLow  = j.relative?.from_52w_low_pct  ?? null;
        grid.insertAdjacentHTML('beforeend', `
          <div class="kpi"><h4>RS(6M,æŒ‡æ•°æ¯”)</h4><div class="v">${fmt(rs6)}%</div></div>
          <div class="kpi"><h4>52é€±é«˜å€¤ã¾ã§</h4><div class="v">${fmt(nearHigh)}%</div></div>
          <div class="kpi"><h4>52é€±å®‰å€¤ã‹ã‚‰</h4><div class="v">${fmt(nearLow)}%</div></div>
        `);

        // ãƒªã‚¹ã‚¯ãƒ»æµå‹•æ€§ + æŒ‡é‡
        const vol20 = j.risk?.vol20_ann_pct, vol60 = j.risk?.vol60_ann_pct, atr = j.risk?.atr14;
        const adv20 = j.liquidity?.adv20;
        const lv = j.levels || {};
        grid.insertAdjacentHTML('beforeend', `
          <div class="kpi"><h4>å¹´åŒ–ãƒœãƒ©20</h4><div class="v">${fmt(vol20)}%</div></div>
          <div class="kpi"><h4>å¹´åŒ–ãƒœãƒ©60</h4><div class="v">${fmt(vol60)}%</div></div>
          <div class="kpi"><h4>ATR(14)</h4><div class="v">${fmt(atr,0)}</div></div>
          <div class="kpi"><h4>ADV20(å£²è²·ä»£é‡‘)</h4><div class="v">${adv20 ? adv20.toLocaleString() : '-'}</div></div>
          <div class="kpi"><h4>æ¨å¥¨ã‚¨ãƒ³ãƒˆãƒªãƒ¼</h4><div class="v">${lv.entry ? lv.entry.toLocaleString() : '-'}</div></div>
          <div class="kpi"><h4>æ¨å¥¨ã‚¹ãƒˆãƒƒãƒ—</h4><div class="v">${lv.stop ? lv.stop.toLocaleString() : '-'}</div></div>
        `);

        box.style.display = 'block';
      }catch(e){
        const errBox = document.getElementById('ev-error');
        errBox.textContent = `ãƒ¡ãƒˆãƒªã‚¯ã‚¹å–å¾—ã‚¨ãƒ©ãƒ¼: ${e}`;
        errBox.style.display = 'block';
        document.getElementById('evidence').style.display = 'block';
      }
    }

    // HTMXã§ã‚«ãƒ¼ãƒ‰ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ã€åŒä¸€ãƒ†ã‚£ãƒƒã‚«ãƒ¼ã§ãƒãƒ£ãƒ¼ãƒˆï¼‹æ ¹æ‹ ã‚‚æ›´æ–°
    document.body.addEventListener('htmx:afterOnLoad', () => {
      const t = tickerEl.value.trim();
      if (t){
        drawChart(t);
        loadEvidence(t);
      }
    });
  </script>
</body>
</html>