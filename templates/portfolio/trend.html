<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>銘柄トレンド判定</title>

  <!-- htmx -->
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>

  <!-- Chart.js（チャート描画用） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:16px; }
    h2 { font-size:28px; margin:0 0 12px; }
    .row { display:flex; gap:8px; }
    input[type=text]{ flex:1; font-size:16px; padding:12px; border:1px solid #ddd; border-radius:12px; }
    button{ padding:12px 16px; font-size:16px; border:none; border-radius:12px; background:#111; color:#fff; }
    .card{ margin-top:12px; border:1px solid #eee; border-radius:16px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.06);}
    .tag{ display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; }
    .up{ background:#e6ffed; color:#057a55; }
    .down{ background:#ffecec; color:#b00020; }
    .flat{ background:#f5f5f5; color:#555; }
    .sub{ color:#666; font-size:12px; }
    .chart-wrap { margin-top:12px; border:1px solid #eee; border-radius:16px; padding:12px; height:260px; }
    /* htmx のインジケータ表示 */
    .htmx-indicator { display:none; }
    .htmx-request .htmx-indicator { display:block; }
  </style>
</head>
<body>
  <h2>銘柄トレンド判定</h2>

  <div class="row">
    <input
      id="ticker"
      type="text"
      placeholder="例: AAPL / MSFT / 7203（.T不要）"
      inputmode="latin"
      autocomplete="off"
      autocapitalize="characters"
      spellcheck="false">
    <button
      id="judgeBtn"
      hx-get="/trend/card"
      hx-target="#result"
      hx-swap="innerHTML"
      hx-indicator="#loading"
      hx-vals='js:{"ticker": document.getElementById("ticker").value.trim()}'>
      判定
    </button>
  </div>

  <!-- htmx の標準クラスで自動表示/非表示 -->
  <div id="loading" class="sub htmx-indicator">Loading...</div>

  <!-- 判定結果カード（HTMXで差し替え） -->
  <div id="result" class="card"></div>

  <!-- 価格チャート -->
  <div class="chart-wrap">
    <canvas id="priceChart"></canvas>
  </div>

  <script>
    // Enter で判定ボタン
    const tickerEl = document.getElementById('ticker');
    const btn = document.getElementById('judgeBtn');
    tickerEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') btn.click();
    });

    // Chart.js セットアップ
    let chart;
    async function drawChart(ticker, days = 180) {
      if (!ticker) return;
      try {
        const r = await fetch(`/api/ohlc?ticker=${encodeURIComponent(ticker)}&days=${days}`);
        const j = await r.json();
        if (!j.ok || !j.labels || !j.labels.length) return;

        const ctx = document.getElementById('priceChart').getContext('2d');
        if (chart) chart.destroy();

        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: j.labels,
            datasets: [
              { label: 'Close', data: j.close, borderWidth: 2, pointRadius: 0 },
              { label: 'MA(10)', data: j.ma10, borderWidth: 1.5, pointRadius: 0 },
              { label: 'MA(30)', data: j.ma30, borderWidth: 1.5, pointRadius: 0 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
              x: { display: false },
              y: {
                beginAtZero: false,
                ticks: { callback: v => (typeof v === 'number' ? v.toLocaleString() : v) }
              }
            },
            plugins: { legend: { display: true } }
          }
        });
      } catch (e) {
        console.error(e); // チャートは失敗してもUIを壊さない
      }
    }

    // HTMX でカードが更新されたらチャートも同じティッカーで更新
    document.body.addEventListener('htmx:afterOnLoad', (ev) => {
      if (!ev.detail || !ev.detail.elt) return;
      // 今回のリクエストが #result を更新したときだけ反応
      if (ev.detail.elt.id === 'result') {
        const t = tickerEl.value.trim();
        if (t) drawChart(t);
      }
    });
  </script>
</body>
</html>