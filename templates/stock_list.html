{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="portfolio-container" id="stock-cards-container">
  {% for stock in stocks %}
  <div class="stock-card-wrapper">
    <div class="stock-card"
         data-id="{{ stock.id }}"
         data-name="{{ stock.name }}"
         data-ticker="{{ stock.ticker }}"
         data-shares="{{ stock.shares }}"
         data-unit_price="{{ stock.unit_price|floatformat:0 }}"
         data-current_price="{{ stock.current_price|floatformat:0 }}"
         data-profit="{{ stock.profit_amount }}"
         data-profit_rate="{{ stock.profit_rate }}"
         data-chart='{{ stock.chart_history|safe }}'>
      
      <!-- 銘柄名とコード -->
      <div class="stock-header">
        <span class="stock-name">{{ stock.name }}</span>
        <span class="stock-code">{{ stock.ticker }}</span>
      </div>
      
      <!-- 株情報 -->
      <div class="stock-body">
        <div class="stock-row"><span>株数</span><span>{{ stock.shares }}株</span></div>
        <div class="stock-row"><span>取得単価</span><span>{{ stock.unit_price|floatformat:0|intcomma }}円</span></div>
        <div class="stock-row"><span>取得額</span><span>{{ stock.total_cost|intcomma }}円</span></div>
        <div class="stock-row"><span>現在株価</span><span>{{ stock.current_price|floatformat:0|intcomma }}円</span></div>
        <div class="stock-row gain {% if stock.profit_amount >= 0 %}positive{% else %}negative{% endif %}">
          <span>損益</span>
          <span>{{ stock.profit_amount|intcomma }}円 ({{ stock.profit_rate }}%)</span>
        </div>
      </div>
    </div>

    <!-- スワイプボタン（カード右側に常設） -->
    <button class="edit-btn">編集</button>
    <button class="sell-btn">売却</button>
  </div>
  {% empty %}
  <p>保有株データがありません。</p>
  {% endfor %}
</div>

<!-- 株カード詳細モーダル -->
<div id="stock-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2 id="modal-name">銘柄名</h2>
    <div class="modal-info">
      <p>コード: <span id="modal-code"></span></p>
      <p>株数: <span id="modal-shares"></span></p>
      <p>取得単価: <span id="modal-cost"></span></p>
      <p>現在株価: <span id="modal-price"></span></p>
      <p class="profit-label">損益: <span id="modal-profit"></span></p>
    </div>
    <canvas id="modal-chart"></canvas>
    <div class="modal-actions">
      <button id="edit-btn-modal" class="edit-button">編集</button>
      <button id="sell-btn-modal" class="sell-button">売却</button>
    </div>
  </div>
</div>

<!-- 共通確認モーダル -->
<div id="confirm-modal" class="confirm-modal">
  <div class="confirm-modal-content">
    <p id="confirm-message"></p>
    <div class="confirm-modal-buttons">
      <button id="confirm-cancel" class="btn-cancel">キャンセル</button>
      <button id="confirm-ok" class="btn-ok">OK</button>
    </div>
  </div>
</div>

<!-- トースト通知 -->
<div id="toast-container"></div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stock_list.css' %}">
{% endblock %}

{% block extra_js %}
<!-- Chart.js とローソク足プラグイン -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
<script src="{% static 'js/stock_list.js' %}"></script>
{% endblock %}