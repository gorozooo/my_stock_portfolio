<!--{# ==========================
   スマホファースト設計、HTML/CSS/JSは分離
   証券会社タブ + 横スクロール + モーダル + 編集/売却ボタン
   ※ broker が「文字列」でも「オブジェクト」でも壊れないように対応
   ※ regroup の by は stocks の並び順に依存するため、view 側で broker で order_by を推奨
========================== #}-->

{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="portfolio-container">

  {% if stocks %}
    {# --- まずは broker.name で regroup 試行（FK想定） --- #}
    {% regroup stocks by broker.name as broker_list_name %}
    {% if broker_list_name and broker_list_name.0.grouper %}
      {% with broker_list=broker_list_name broker_grouper_is_name=True %}
        {# broker はオブジェクトで .name を持っているケース #}
        <!-- 証券会社タブ -->
        <div class="broker-tabs-wrapper" role="tablist" aria-label="証券会社">
          {% for broker_group in broker_list %}
            {# タブの見出しは “grouper(=broker.name)” #}
            <button class="broker-tab"
                    data-broker-index="{{ forloop.counter0 }}"
                    data-broker-label="{{ broker_group.grouper }}"
                    role="tab" tabindex="0">
              {{ broker_group.grouper }}
            </button>
          {% endfor %}
        </div>

        <!-- 証券会社セクション（横スクロール） -->
        <div class="broker-horizontal-wrapper" id="broker-horizontal-wrapper" aria-live="polite">
          {% for broker_group in broker_list %}
            <section class="broker-section"
                     data-broker-index="{{ forloop.counter0 }}"
                     aria-label="{{ broker_group.grouper }}">
              <div class="broker-cards-wrapper">
                {% for stock in broker_group.list %}
                  <article class="stock-card-wrapper">
                    <div class="stock-card"
                         role="button"
                         tabindex="0"
                         data-id="{{ stock.id }}"
                         data-name="{{ stock.name }}"
                         data-ticker="{{ stock.ticker }}"
                         data-shares="{{ stock.shares }}"
                         data-unit_price="{{ stock.unit_price|floatformat:0 }}"
                         data-current_price="{{ stock.current_price|floatformat:0 }}"
                         data-profit="{{ stock.profit_amount }}"
                         data-profit_rate="{{ stock.profit_rate }}"
                         data-account="{{ stock.account }}"
                         data-position="{{ stock.position }}"
                         data-broker="{{ stock.broker.name }}">
                      <div class="stock-header">
                        <span class="stock-name">{{ stock.name }}</span>
                        <span class="stock-code">{{ stock.ticker }}</span>
                      </div>
                      <div class="stock-body">
                        <div class="stock-row"><span>株数</span><span>{{ stock.shares }}株</span></div>
                        <div class="stock-row"><span>取得単価</span><span>{{ stock.unit_price|floatformat:0|intcomma }}円</span></div>
                        <div class="stock-row"><span>取得額</span><span>{{ stock.total_cost|intcomma }}円</span></div>
                        <div class="stock-row"><span>現在株価</span><span>{{ stock.current_price|floatformat:0|intcomma }}円</span></div>
                        <div class="stock-row gain {% if stock.profit_amount >= 0 %}positive{% else %}negative{% endif %}">
                          <span>損益</span>
                          <span>{{ stock.profit_amount|intcomma }}円 ({{ stock.profit_rate }}%)</span>
                        </div>
                      </div>
                    </div>
                  </article>
                {% endfor %}
              </div>
            </section>
          {% endfor %}
        </div>
      {% endwith %}

    {% else %}
      {# --- 文字列の broker を想定して regroup をやり直し --- #}
      {% regroup stocks by broker as broker_list_str %}
      {% with broker_list=broker_list_str broker_grouper_is_name=False %}
        <!-- 証券会社タブ -->
        <div class="broker-tabs-wrapper" role="tablist" aria-label="証券会社">
          {% for broker_group in broker_list %}
            <button class="broker-tab"
                    data-broker-index="{{ forloop.counter0 }}"
                    data-broker-label="{{ broker_group.grouper }}"
                    role="tab" tabindex="0">
              {{ broker_group.grouper }}
            </button>
          {% endfor %}
        </div>

        <!-- 証券会社セクション（横スクロール） -->
        <div class="broker-horizontal-wrapper" id="broker-horizontal-wrapper" aria-live="polite">
          {% for broker_group in broker_list %}
            <section class="broker-section"
                     data-broker-index="{{ forloop.counter0 }}"
                     aria-label="{{ broker_group.grouper }}">
              <div class="broker-cards-wrapper">
                {% for stock in broker_group.list %}
                  <article class="stock-card-wrapper">
                    <div class="stock-card"
                         role="button"
                         tabindex="0"
                         data-id="{{ stock.id }}"
                         data-name="{{ stock.name }}"
                         data-ticker="{{ stock.ticker }}"
                         data-shares="{{ stock.shares }}"
                         data-unit_price="{{ stock.unit_price|floatformat:0 }}"
                         data-current_price="{{ stock.current_price|floatformat:0 }}"
                         data-profit="{{ stock.profit_amount }}"
                         data-profit_rate="{{ stock.profit_rate }}"
                         data-account="{{ stock.account }}"
                         data-position="{{ stock.position }}"
                         data-broker="{{ stock.broker }}">
                      <div class="stock-header">
                        <span class="stock-name">{{ stock.name }}</span>
                        <span class="stock-code">{{ stock.ticker }}</span>
                      </div>
                      <div class="stock-body">
                        <div class="stock-row"><span>株数</span><span>{{ stock.shares }}株</span></div>
                        <div class="stock-row"><span>取得単価</span><span>{{ stock.unit_price|floatformat:0|intcomma }}円</span></div>
                        <div class="stock-row"><span>取得額</span><span>{{ stock.total_cost|intcomma }}円</span></div>
                        <div class="stock-row"><span>現在株価</span><span>{{ stock.current_price|floatformat:0|intcomma }}円</span></div>
                        <div class="stock-row gain {% if stock.profit_amount >= 0 %}positive{% else %}negative{% endif %}">
                          <span>損益</span>
                          <span>{{ stock.profit_amount|intcomma }}円 ({{ stock.profit_rate }}%)</span>
                        </div>
                      </div>
                    </div>
                  </article>
                {% endfor %}
              </div>
            </section>
          {% endfor %}
        </div>
      {% endwith %}
    {% endif %}

  {% else %}
    <p>保有株データがありません。</p>
  {% endif %}

  <!-- 株モーダル（カードタップ→詳細） -->
  <div id="stock-modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <button class="modal-close" aria-label="閉じる">&times;</button>
      <div id="modal-body" role="document"></div>
      <div class="modal-actions">
        <button id="edit-stock-btn" class="modal-action-btn">編集</button>
        <button id="sell-stock-btn" class="modal-action-btn negative">売却</button>
      </div>
    </div>
  </div>

  <!-- 編集モーダル（タイトル固定＋編集項目のみ） -->
  <div id="edit-modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="edit-modal-title">
      <button class="modal-close" aria-label="閉じる">&times;</button>

      <!-- 上部中央に非編集の銘柄名＋コード（視覚的に強調） -->
      <div class="edit-heading">
        <h2 id="edit-modal-title" class="edit-title">
          <span class="edit-name" id="edit-name">—</span>
          <span class="edit-code-chip" id="edit-code">—</span>
        </h2>
      </div>

      <!-- 編集フォーム（編集するのは以下のみ） -->
      <form id="edit-form" novalidate>
        <!-- 送信用の必須ID -->
        <input type="hidden" name="stock_id" />
        <!-- name / ticker は編集しないが、バックエンド互換用にhiddenで送る -->
        <input type="hidden" name="name" />
        <input type="hidden" name="ticker" />

        <div class="form-grid">
          <div class="form-group">
            <label for="edit-shares">株数</label>
            <input id="edit-shares" name="shares" type="number" inputmode="numeric" min="0" step="1" placeholder="例: 100" required>
          </div>

          <div class="form-group">
            <label for="edit-unit_price">取得単価（円）</label>
            <input id="edit-unit_price" name="unit_price" type="number" inputmode="numeric" min="0" step="1" placeholder="例: 1,500" required>
          </div>

          <div class="form-group">
            <label for="edit-account">口座</label>
            <input id="edit-account" name="account" type="text" placeholder="例: 特定 / NISA" maxlength="50">
          </div>

          <div class="form-group">
            <label for="edit-position">ポジション</label>
            <select id="edit-position" name="position" required>
              <option value="買">買</option>
              <option value="売">売</option>
            </select>
          </div>
        </div>

        <div class="modal-actions sticky-actions">
          <button type="submit" class="modal-action-btn">保存</button>
          <button type="button" id="edit-cancel-btn" class="modal-action-btn negative">キャンセル</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 売却モーダル（既存のまま） -->
  <div id="sell-modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true">
      <button class="modal-close" aria-label="閉じる">&times;</button>
      <form id="sell-form">
        <input type="hidden" name="stock_id">
        <div class="form-group"><label>銘柄名<input name="name" type="text" readonly></label></div>
        <div class="form-group"><label>株数<input name="shares" type="number"></label></div>
        <div class="modal-actions">
          <button type="submit" class="modal-action-btn negative">売却</button>
          <button type="button" id="sell-cancel-btn" class="modal-action-btn">キャンセル</button>
        </div>
      </form>
    </div>
  </div>

</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stock_list.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/stock_list.js' %}" defer></script>
{% endblock %}