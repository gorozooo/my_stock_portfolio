{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="portfolio-container">

  {% regroup stocks by broker as broker_list %}

  <!-- 証券会社タブ -->
  <div class="broker-tabs-wrapper">
    {% for broker_group in broker_list %}
      <button class="broker-tab" data-broker-index="{{ forloop.counter0 }}">{{ broker_group.grouper }}</button>
    {% endfor %}
  </div>

  <!-- 証券会社ごとの株カード縦スクロール -->
  <div class="broker-vertical-wrapper">
    {% for broker_group in broker_list %}
      <div class="broker-section" data-broker-index="{{ forloop.counter0 }}">
        <h3 class="broker-title">{{ broker_group.grouper }}</h3>
        <div class="broker-cards-wrapper">
          {% for stock in broker_group.list %}
            <div class="stock-card-wrapper">
              <div class="stock-card"
                   data-id="{{ stock.id }}"
                   data-name="{{ stock.name }}"
                   data-ticker="{{ stock.ticker }}"
                   data-shares="{{ stock.shares }}"
                   data-unit_price="{{ stock.unit_price|floatformat:0 }}"
                   data-current_price="{{ stock.current_price|floatformat:0 }}"
                   data-profit="{{ stock.profit_amount }}"
                   data-profit_rate="{{ stock.profit_rate }}">
                
                <div class="stock-header">
                  <span class="stock-name">{{ stock.name }}</span>
                  <span class="stock-code">{{ stock.ticker }}</span>
                </div>

                <div class="stock-body">
                  <div class="stock-row"><span>株数</span><span>{{ stock.shares }}株</span></div>
                  <div class="stock-row"><span>取得単価</span><span>{{ stock.unit_price|floatformat:0|intcomma }}円</span></div>
                  <div class="stock-row"><span>取得額</span><span>{{ stock.total_cost|intcomma }}円</span></div>
                  <div class="stock-row"><span>現在株価</span><span>{{ stock.current_price|floatformat:0|intcomma }}円</span></div>
                  <div class="stock-row gain {% if stock.profit_amount >= 0 %}positive{% else %}negative{% endif %}">
                    <span>損益</span>
                    <span>{{ stock.profit_amount|intcomma }}円 ({{ stock.profit_rate }}%)</span>
                  </div>
                </div>

              </div>

              <button class="edit-btn">編集</button>
              <button class="sell-btn">売却</button>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  </div>

  {% if broker_list|length == 0 %}
    <p>保有株データがありません。</p>
  {% endif %}

</div>

<!-- 共通確認モーダル -->
<div id="confirm-modal" class="confirm-modal" aria-hidden="true">
  <div class="confirm-modal-content">
    <p id="confirm-message"></p>
    <div class="confirm-modal-buttons">
      <button id="confirm-cancel" class="btn-cancel">キャンセル</button>
      <button id="confirm-ok" class="btn-ok">OK</button>
    </div>
  </div>
</div>

<!-- トースト通知 -->
<div id="toast-container" aria-live="polite" aria-atomic="true"></div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stock_list.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/stock_list.js' %}" defer></script>
{% endblock %}