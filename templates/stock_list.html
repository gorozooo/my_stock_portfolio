<!--{# ==========================
   スマホファースト設計、HTML/CSS/JSは分離
   証券会社タブ + 横スクロール + モーダル + 編集/売却ボタン
   ※ broker_name / account_type_name は view 側で annotate 済み
========================== #}-->

{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="portfolio-container">

  {% if stocks %}
    {# 1段目：証券会社名でグルーピング（viewで annotate 済みの broker_name を使用） #}
    {% regroup stocks by broker_name as broker_groups %}

    {# ===== 証券会社タブ ===== #}
    <div class="broker-tabs-wrapper" role="tablist" aria-label="証券会社">
      {% for bg in broker_groups %}
        <button class="broker-tab"
                data-broker-index="{{ forloop.counter0 }}"
                role="tab" tabindex="0">
          {{ bg.grouper }}
        </button>
      {% endfor %}
    </div>

    {# ===== 証券会社セクション：横スクロールの外枠 ===== #}
    <div class="broker-horizontal-wrapper" id="broker-horizontal-wrapper" aria-live="polite">
      {% for bg in broker_groups %}
        <section class="broker-section"
                 data-broker-index="{{ forloop.counter0 }}"
                 aria-label="{{ bg.grouper }}">

          {# 2段目：この証券会社の中で口座区分でグルーピング（viewで annotate 済みの account_type_name を使用） #}
          {% regroup bg.list by account_type_name as account_groups %}

          {# 口座チップ：JSが見出しを読み取り自動生成（ここは空のまま） #}
          <div class="account-chips" role="tablist" aria-label="{{ bg.grouper }} の口座区分"></div>

          {# スクロールは1本：見出し（口座）→カード群…を1つのラッパーに連続配置 #}
          <div class="broker-cards-wrapper">
            {% for ag in account_groups %}
              {# 見出しIDは brokerIndex-accountIndex で一意化 #}
              <h3 class="account-heading" id="account-{{ forloop.parentloop.counter0 }}-{{ forloop.counter0 }}">
                {{ ag.grouper }}
              </h3>

              {% for stock in ag.list %}
                <article class="stock-card-wrapper">
                  <div class="stock-card"
                       role="group"
                       tabindex="0"
                       data-id="{{ stock.id }}"
                       data-name="{{ stock.name }}"
                       data-ticker="{{ stock.ticker }}"
                       data-shares="{{ stock.shares }}"
                       data-unit_price="{{ stock.unit_price|floatformat:0 }}"
                       data-current_price="{{ stock.current_price|floatformat:0 }}"
                       data-profit="{{ stock.profit_amount }}"
                       data-profit_rate="{{ stock.profit_rate }}"
                       data-account="{{ stock.account_type_name }}"
                       data-position="{{ stock.position }}"
                       data-broker="{{ stock.broker_name }}">
                    <div class="stock-header">
                      <span class="stock-name">{{ stock.name }}</span>
                      <span class="stock-code">{{ stock.ticker }}</span>
                    </div>
                    <div class="stock-body">
                      <div class="stock-row"><span>株数</span><span>{{ stock.shares }}株</span></div>
                      <div class="stock-row"><span>取得単価</span><span>{{ stock.unit_price|floatformat:0|intcomma }}円</span></div>
                      <div class="stock-row"><span>取得額</span><span>{{ stock.total_cost|intcomma }}円</span></div>
                      <div class="stock-row"><span>現在株価</span><span>{{ stock.current_price|floatformat:0|intcomma }}円</span></div>
                      <div class="stock-row gain {% if stock.profit_amount >= 0 %}positive{% else %}negative{% endif %}">
                        <span>損益</span>
                        <span>{{ stock.profit_amount|intcomma }}円 ({{ stock.profit_rate }}%)</span>
                      </div>
                    </div>

                    {# === 専用ページへのリンク（編集 / 売却） ===
                       既存のスワイプUI用CSSに合わせて .card-actions を配置。
                       左スワイプで表示されるほか、そのままでもタップ可。 #}
                    <div class="card-actions">
                      <a href="{% url 'stock_edit' stock.id %}" class="edit-btn modal-action-btn">編集</a>
                      <a href="{% url 'stock_sell' stock.id %}" class="sell-btn modal-action-btn negative">売却</a>
                    </div>
                  </div>
                </article>
              {% endfor %}
            {% endfor %}
          </div>
        </section>
      {% endfor %}
    </div>
  {% else %}
    <p>保有株データがありません。</p>
  {% endif %}

</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/stock_list.css' %}">
{% endblock %}

{% block extra_js %}
{# 既存のJS（タブ切替やスワイプなど）。モーダル参照があっても null セーフならそのままでOK。 #}
<script src="{% static 'js/stock_list.js' %}" defer></script>
{% endblock %}