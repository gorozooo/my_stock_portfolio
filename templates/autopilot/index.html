{% extends "base.html" %}
{% block title %}ã‚ªãƒ¼ãƒˆãƒ‘ã‚¤ãƒ­ãƒƒãƒˆï¼ˆÎ²ï¼‰{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#0b0f1a;--card:rgba(255,255,255,.06);--sub:#94a3b8;--fg:#f1f5f9;
    --accent:#2563eb;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;--muted:#334155;
  }
  body{background:var(--bg);color:var(--fg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial}
  h1{font-size:22px;margin:10px 0 14px}
  .row{display:flex;gap:8px;align-items:center}
  .inp{flex:1;padding:12px;border:1px solid var(--muted);border-radius:12px;background:#1e293b;color:#fff}
  .btn{padding:12px 16px;border:0;border-radius:12px;background:var(--accent);color:#fff;font-weight:700}
  .btn:disabled{opacity:.5}
  .btn-ghost{background:transparent;border:1px solid var(--muted);color:#fff;border-radius:12px;padding:12px}
  .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px;margin-top:12px}
  .sub{color:var(--sub);font-size:13px}
  .kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px}
  .kpi{background:rgba(255,255,255,.05);padding:10px;border-radius:10px}
  .kpi h4{margin:0 0 4px;font-size:12px;color:#cbd5e1}
  .kpi .v{font-weight:700}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px}
  .b-ok{background:var(--ok);color:#fff}.b-warn{background:var(--warn);color:#222}.b-bad{background:var(--bad);color:#fff}.b-mute{background:var(--muted);color:#e2e8f0}
  .chart{height:300px;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:8px;margin-top:12px}
  .field{display:flex;gap:8px;align-items:center;margin-top:6px}
  .sticky-actions{position:sticky;bottom:8px;z-index:5;display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px}
  .tiny{font-size:12px}
  .note{font-size:12px;color:var(--sub);margin-top:4px}
</style>
{% endblock %}

{% block content %}
<h1>ğŸ§­ ã‚ªãƒ¼ãƒˆãƒ‘ã‚¤ãƒ­ãƒƒãƒˆï¼ˆÎ²ï¼‰</h1>

<div class="row">
  <input id="tkr" class="inp" placeholder="éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ / ãƒ†ã‚£ãƒƒã‚«ãƒ¼ï¼ˆä¾‹: 6203 / AAPLï¼‰" inputmode="latin" />
  <button class="btn" id="goBtn">åˆ¤å®š</button>
</div>
<div class="sub">AIãŒã€Œãƒˆãƒ¬ãƒ³ãƒ‰Ã—éœ€çµ¦Ã—ãƒªã‚¹ã‚¯ã€ã‚’å­¦ç¿’ã—ã¦ã‚¹ã‚³ã‚¢åŒ–ã—ã¾ã™ã€‚</div>

<div class="card" id="verdict" style="display:none;">
  <div class="row" style="justify-content:space-between;align-items:flex-start">
    <div>
      <div id="titleBox" style="font-weight:800;font-size:18px;">â€”</div>
      <div class="sub" id="asof">â€”</div>
      <div id="verdictBadge" style="margin-top:6px"></div>
    </div>
    <div class="field">
      <button class="badge b-ok" id="sideLong">è²·ã„</button>
      <button class="badge b-bad" id="sideShort">å£²ã‚Š</button>
    </div>
  </div>

  <div class="kpis" style="margin-top:10px">
    <div class="kpi"><h4>ãƒˆãƒ¬ãƒ³ãƒ‰å‚¾ã(60æ—¥å¹´ç‡)</h4><div class="v" id="vSlope">-</div></div>
    <div class="kpi"><h4>ADX(14)</h4><div class="v" id="vAdx">-</div></div>
    <div class="kpi"><h4>RS(6M)</h4><div class="v" id="vRs">-</div></div>
    <div class="kpi"><h4>MAæ•´åˆ—</h4><div class="v" id="vMa">-</div></div>
    <div class="kpi"><h4>52é€±é«˜å€¤ã¾ã§</h4><div class="v" id="vHi">-</div></div>
    <div class="kpi"><h4>ATR(14)</h4><div class="v" id="vAtr">-</div></div>
  </div>

  <div class="chart"><canvas id="c"></canvas></div>

  <div class="card">
    <div class="sub">ğŸ“Œ æ¨å¥¨ãƒ—ãƒ©ãƒ³ï¼ˆAIåŸæ¡ˆ â†’ ä¿å®ˆã‚¬ãƒ¼ãƒ‰èª¿æ•´ï¼‰</div>
    <div class="field"><b>åŸæ¡ˆãƒ»å»ºå€¤</b><span id="pEntryRaw">-</span></div>
    <div class="field"><b>èª¿æ•´å¾Œå»ºå€¤</b><span id="pEntryAdj">-</span></div>
    <div class="note">â€» çµ‚å€¤ä»¥ä¸Šã®è¿½æ’ƒç¦æ­¢ãƒ»æœ€ä½0.35ATRæŠ¼ã—å¾…ã¡ãƒ»é«˜å€¤åœã¯ãƒ–ãƒ¬ã‚¤ã‚¯å†ãƒ†ã‚¹ãƒˆå¾…ã¡</div>
    <div class="field"><b>æåˆ‡ãƒ©ã‚¤ãƒ³</b><span id="pStop">-</span></div>
    <div class="note">â€» 1.1ATRä»¥å†…ã€‚RR<2ãªã‚‰ã€Œè¦³å¯Ÿã€æ‰±ã„</div>
    <div class="field"><b>åˆ©ç¢ºã‚ã‚„ã™</b><span id="pTargets">-</span></div>
    <div class="field"><b>æ¨å¥¨æ•°é‡</b>
      <input id="qty" class="inp" type="number" min="1" step="1"/>
      <span class="tiny sub" id="qtyHint"></span>
    </div>
    <div class="note" id="guardMsg"></div>
  </div>

  <div class="card">
    <div class="sub">ğŸ§  ç¾åœ¨ã®AIãƒãƒªã‚·ãƒ¼ï¼ˆadvisor/policyï¼‰</div>
    <div id="policyBox" class="tiny" style="white-space:pre-wrap;">å–å¾—ä¸­â€¦</div>
    <div class="row" style="margin-top:8px">
      <button class="btn-ghost" id="btnRefreshPolicy">ãƒãƒªã‚·ãƒ¼å†å–å¾—</button>
      <button class="btn" id="btnLearn">å­¦ç¿’ã‚’å®Ÿè¡Œ</button>
    </div>
    <div class="sub" id="learnMsg" style="margin-top:6px"></div>
  </div>

  <div class="sticky-actions">
    <button class="btn-ghost" id="btnWatch">â­ ã‚¦ã‚©ãƒƒãƒ</button>
    <button class="btn" id="btnAdd">ğŸ“¥ æ³¨æ–‡ãƒ—ãƒ©ãƒ³ã«è¿½åŠ </button>
  </div>
</div>

<script>
const el = id=>document.getElementById(id);
let chart,CURRENT={ticker:"",side:"LONG",metrics:null,lastClose:null};

// === Utility ===
function norm(t){if(!t)return"";t=t.trim().toUpperCase();if(t.includes('.'))return t;return/^[0-9A-Z]{4,5}$/.test(t)?t+".T":t;}
function num(x,d=2){if(x===null||x===undefined||isNaN(x))return"-";return Number(x).toLocaleString(undefined,{maximumFractionDigits:d});}
function badge(lbl){if(lbl==="BUY")return`<span class="badge b-ok">âœ… è²·ã„å€™è£œ</span>`;if(lbl==="SELL")return`<span class="badge b-bad">ğŸ“‰ å£²ã‚Šå€™è£œ</span>`;return`<span class="badge b-warn">ğŸ‘€ è¦³å¯Ÿ</span>`;}
async function fetchJSON(u){const r=await fetch(u,{credentials:"same-origin"});if(!r.ok)throw new Error("HTTP "+r.status);return await r.json();}

// === Guard Logicï¼ˆä¿å®ˆãƒ¢ãƒ¼ãƒ‰ï¼‰===
function guardrailAdjust(m,raw,lastClose){
  const atr=Number(m?.risk?.atr14||0);
  const hiPct=Number(m?.relative?.from_52w_high_pct);
  const loPct=Number(m?.relative?.from_52w_low_pct);
  const side=(CURRENT.side||"LONG");
  if(!raw||!lastClose||!atr)return{entryAdj:raw,guardNote:""};
  let entry=Number(raw);let note=[];
  if(side==="LONG"){
    if(entry>lastClose){entry=lastClose;note.push("çµ‚å€¤ä»¥ä¸Šã®è¿½æ’ƒç¦æ­¢");}
    const minPull=lastClose-0.35*atr;if(entry>minPull){entry=minPull;note.push("æœ€ä½0.35ATRæŠ¼ã—å¾…ã¡");}
    if(hiPct>-5&&hiPct<5){entry=Math.min(entry,lastClose-0.45*atr);note.push("é«˜å€¤åœâ†’å†ãƒ†ã‚¹ãƒˆå¾…ã¡");}
  }else{
    if(entry<lastClose){entry=lastClose;note.push("çµ‚å€¤ä»¥ä¸‹ã®è¿½æ’ƒç¦æ­¢");}
    const minRet=lastClose+0.35*atr;if(entry<minRet){entry=minRet;note.push("æœ€ä½+0.35ATRæˆ»ã‚Šå¾…ã¡");}
    if(loPct>-5&&loPct<5){entry=Math.max(entry,lastClose+0.45*atr);note.push("å®‰å€¤åœâ†’å†ãƒ†ã‚¹ãƒˆå¾…ã¡");}
  }
  return{entryAdj:Math.round(entry),guardNote:note.join(" / ")};
}

// === Target Logic (R/ATRãƒ™ãƒ¼ã‚¹) ===
function buildTargetsAndRR(m,entry,stop,side){
  if(!entry||!stop)return{targets:[],rr2ok:false};
  const risk=Math.abs(entry-stop);if(!risk)return{targets:[],rr2ok:false};
  let tp1=side==="SHORT"?entry-risk:entry+risk;
  let tp2=side==="SHORT"?entry-2*risk:entry+2*risk;
  let tp3=side==="SHORT"?entry-2.7*risk:entry+2.7*risk;
  const hiPct=Number(m?.relative?.from_52w_high_pct);
  const loPct=Number(m?.relative?.from_52w_low_pct);
  if(side==="LONG"&&hiPct>-5&&hiPct<5)tp3=Math.min(tp3,entry+2.2*risk);
  if(side==="SHORT"&&loPct>-5&&loPct<5)tp3=Math.max(tp3,entry-2.2*risk);
  const rr2ok=((Math.abs(tp2-entry)/risk)>=2);
  return{targets:[tp1,tp2,tp3].map(x=>Math.round(x)),rr2ok};
}

// === Qty Logic ===
function fallbackQty(m,entry,stop){
  const rps=Math.abs(entry-stop);if(!rps)return 0;
  const eq=Number(m?.sizing?.equity??1_000_000);
  const lot=Number(m?.sizing?.lot??100);
  const riskAmt=eq*0.004; // 0.4%
  const q=Math.floor((riskAmt/rps)/lot)*lot;
  const maxEq=eq*0.05;
  return Math.min(q,Math.floor((maxEq/entry)/lot)*lot);
}

// === Label Decision ===
function decideLabel(m){
  const s=m.trend?.slope_ann_pct_60??0,adx=m.trend?.adx14??0,rs=m.relative?.rs_6m_pct??0;
  if(s>=25&&adx>=18&&rs>=0)return"BUY";
  if(s<0&&adx>=18)return"SELL";
  return"WATCH";
}

// === Render ===
async function renderFor(t){
  const ticker=norm(t);if(!ticker)return;
  el("verdict").style.display="block";
  el("verdictBadge").innerHTML=badge("WATCH");
  const m=await fetchJSON(`/api/metrics?ticker=${ticker}`);
  CURRENT.metrics=m;el("asof").textContent=`è©•ä¾¡æ™‚ç‚¹ï¼š${m.asof}`;
  CURRENT.lastClose=m.close??null;
  el("titleBox").textContent=`${m.name||ticker}`;

  const label=decideLabel(m);
  el("verdictBadge").innerHTML=badge(label);
  CURRENT.side=(label==="SELL")?"SHORT":"LONG";

  const lv=m.levels||{};
  const raw=lv.entry??null,stop=lv.stop??null;
  const g=guardrailAdjust(m,raw,m.close);const adj=g.entryAdj;
  const tg=buildTargetsAndRR(m,adj,stop,CURRENT.side);
  const qty=fallbackQty(m,adj,stop);

  el("pEntryRaw").textContent=raw?num(raw,0)+" å††":"-";
  el("pEntryAdj").textContent=adj?num(adj,0)+" å††":"-";
  el("pStop").textContent=stop?num(stop,0)+" å††":"-";
  el("pTargets").textContent=tg.targets.map(x=>num(x,0)).join(" / ");
  el("qty").value=qty||"";
  el("qtyHint").textContent=qty?`ææ¡ˆ: ${qty}æ ª`:"æ•°é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
  el("guardMsg").textContent=g.guardNote;
}
el("goBtn").onclick=()=>renderFor(el("tkr").value);
el("btnRefreshPolicy").onclick=()=>fetchJSON("/advisor/policy").then(p=>el("policyBox").textContent=JSON.stringify(p,null,2)).catch(e=>el("policyBox").textContent="âŒ "+e);
</script>
{% endblock %}