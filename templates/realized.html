{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="realized-container">
  <!-- 上部：KPI / クイック / 年月 -->
  <div class="top-fixed" role="region" aria-label="絞り込みとサマリー">
    <!-- KPI：3段（既存のまま） -->
    <div class="kpi-row kpi-row1">
      <div class="kpi-card">
        <div class="kpi-header"><span class="kpi-icon">📄</span><span class="kpi-label">件数</span></div>
        <div class="kpi-value" id="sumCount">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-header"><span class="kpi-icon">🥇</span><span class="kpi-label">勝率</span></div>
        <div class="kpi-value" id="winRate">--%</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-header"><span class="kpi-icon">💰</span><span class="kpi-label">実現損益</span></div>
        <div class="kpi-value" id="netProfit">--</div>
      </div>
    </div>

    <div class="kpi-row kpi-row2">
      <div class="kpi-card">
        <div class="kpi-header"><span class="kpi-icon">⬆️</span><span class="kpi-label">利益金額合計</span></div>
        <div class="kpi-value profit" id="totalProfit">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-header"><span class="kpi-icon">⬇️</span><span class="kpi-label">損失金額合計</span></div>
        <div class="kpi-value loss" id="totalLoss">--</div>
      </div>
    </div>

    <div class="kpi-row kpi-row3">
      <div class="kpi-card">
        <div class="kpi-header"><span class="kpi-icon">📊</span><span class="kpi-label">平均損益</span></div>
        <div class="kpi-value" id="avgNet">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-header"><span class="kpi-icon">🔼</span><span class="kpi-label">平均利益</span></div>
        <div class="kpi-value profit" id="avgProfitOnly">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-header"><span class="kpi-icon">🔽</span><span class="kpi-label">平均損失</span></div>
        <div class="kpi-value loss" id="avgLossOnly">--</div>
      </div>
    </div>

    <!-- クイックフィルタ -->
    <div class="quick-chips chips-compact">
      <button type="button" data-range="this-month" class="chip">今月</button>
      <button type="button" data-range="last-month" class="chip">先月</button>
      <button type="button" data-range="this-year" class="chip">今年</button>
      <button type="button" data-range="all" class="chip active">すべて</button>
    </div>

    <!-- 年月フィルタ -->
    <div class="filter-box filter-compact">
      <select id="yearFilter" aria-label="年フィルタ">
        <option value="">年</option>
        <option value="2025">2025</option>
        <option value="2024">2024</option>
      </select>
      <select id="monthFilter" aria-label="月フィルタ">
        <option value="">月</option>
        <option value="01">1</option><option value="02">2</option>
        <option value="03">3</option><option value="04">4</option>
        <option value="05">5</option><option value="06">6</option>
        <option value="07">7</option><option value="08">8</option>
        <option value="09">9</option><option value="10">10</option>
        <option value="11">11</option><option value="12">12</option>
      </select>
    </div>
  </div>

  <p id="emptyState" class="empty-state" style="display:none;">該当データがありません</p>

  <!-- 表だけ縦スクロール & 横スクロール可 -->
  <div class="table-wrapper" id="tableWrapper" aria-label="損益一覧スクロール領域">
    <table id="realizedTable" aria-label="損益一覧">
      <thead>
        <tr>
          <th scope="col">日付</th>
          <th scope="col">銘柄</th>
          <th scope="col">証券会社</th>
          <th scope="col">口座区分</th>
          <th scope="col">区分</th>
          <th scope="col">株数</th>
          <th scope="col">損益額</th>
          <th scope="col">損益率</th>
        </tr>
      </thead>
      <tbody>
        {# === ここからDBの内容を出力 === #}
        {% for ym, trades in rows_by_ym.items %}
          {% with y=ym|slice:":4" m=ym|slice:"5:7" %}
            <tr class="group-row"><td colspan="8">{{ y }}年 {{ m }}月</td></tr>
          {% endwith %}

          {% for t in trades %}
            {% with jp_type="" %}
              {% if t.trade_type == 'sell' %}
                {% with jp_type="売却" %}{% endwith %}
              {% elif t.trade_type == 'dividend' %}
                {% with jp_type="配当" %}{% endwith %}
              {% else %}
                {% with jp_type=t.trade_type %}{% endwith %}
              {% endif %}
            {% endwith %}

            <tr
              data-date="{{ t.date|date:'Y-m-d' }}"
              data-name="{{ t.stock_name }}"
              data-code="{{ t.code }}"
              data-broker="{{ t.broker }}"
              data-account="{{ t.account_type }}"
              data-type="{% if t.trade_type == 'sell' %}売却{% elif t.trade_type == 'dividend' %}配当{% else %}{{ t.trade_type }}{% endif %}"
              data-quantity="{{ t.quantity }}"
              data-profit="{% if t.profit_amount %}{% if t.profit_amount > 0 %}+{% endif %}{{ t.profit_amount|intcomma }}{% else %}0{% endif %}"
              data-rate="{% if t.profit_rate is not None %}{% if t.profit_rate > 0 %}+{% endif %}{{ t.profit_rate }}%{% else %}0%{% endif %}"
              data-purchase="{{ t.purchase_price|default_if_none:''|intcomma }}"
              data-sell="{{ t.sell_price|default_if_none:''|intcomma }}"
              data-fee="{{ t.fee|default_if_none:0|intcomma }}"
            >
              <td>{{ t.date|date:"Y-m-d" }}</td>
              <td class="stock-name-cell"><span>{{ t.stock_name }}</span></td>
              <td>{{ t.broker }}</td>
              <td>{{ t.account_type }}</td>
              <td class="trade-type-cell"><span>{% if t.trade_type == 'sell' %}売却{% elif t.trade_type == 'dividend' %}配当{% else %}{{ t.trade_type }}{% endif %}</span></td>
              <td>
                {% if t.quantity is not None %}
                  {{ t.quantity|intcomma }}
                {% else %}
                  -
                {% endif %}
              </td>

              {% if t.profit_amount is not None and t.profit_amount < 0 %}
                <td class="loss">{{ t.profit_amount|intcomma }}</td>
              {% else %}
                <td class="profit">{% if t.profit_amount %}+{% endif %}{{ t.profit_amount|default_if_none:0|intcomma }}</td>
              {% endif %}

              {% if t.profit_rate is not None and t.profit_rate < 0 %}
                <td class="loss">{{ t.profit_rate }}%</td>
              {% else %}
                <td class="profit">{% if t.profit_rate %}+{% endif %}{{ t.profit_rate|default_if_none:0 }}%</td>
              {% endif %}
            </tr>
          {% endfor %}
        {% empty %}
          {# データ0件でも tbody は空のまま / JSで emptyState を表示 #}
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- モーダル（中央表示・リッチレイアウト） -->
<div id="stockModal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
  <div class="modal-content glass-box" role="document">
    <span class="close" aria-label="閉じる">&times;</span>

    <!-- タイトル：銘柄（証券コード）を中央に -->
    <h2 id="modalTitle" class="modal-title-center"></h2>

    <!-- まずは金額のサマリー（売却額 / 取得額） -->
    <div class="modal-amounts">
      <div class="amount-card">
        <div class="amount-label">売却額</div>
        <div class="amount-value" id="modalSellAmount">--</div>
      </div>
      <div class="amount-card">
        <div class="amount-label">取得額</div>
        <div class="amount-value" id="modalBuyAmount">--</div>
      </div>
    </div>

    <!-- 詳細（2カラム） -->
    <div class="modal-grid">
      <p><span class="k">売却単価</span><span id="modalSell"></span></p>
      <p><span class="k">取得単価</span><span id="modalPurchase"></span></p>

      <p><span class="k">株数</span><span id="modalQuantity"></span></p>
      <p><span class="k">手数料</span><span id="modalFee"></span></p>

      <p><span class="k">証券会社</span><span id="modalBroker"></span></p>
      <p><span class="k">口座区分</span><span id="modalAccount"></span></p>

      <p class="full"><span class="k">損益額</span><span id="modalProfit" class="pn"></span></p>
    </div>
  </div>
</div>

{% include "bottom_tab.html" %}

<link rel="stylesheet" href="{% static 'css/realized.css' %}">
<script src="{% static 'js/realized.js' %}"></script>
{% endblock %}