{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="realized-page">

  <!-- å›ºå®šãƒˆãƒƒãƒ—ï¼šKPI / ã‚¯ã‚¤ãƒƒã‚¯ / ãƒˆã‚°ãƒ« / å¹´æœˆ -->
  <section class="top-fixed" role="region" aria-label="çµã‚Šè¾¼ã¿ã¨ã‚µãƒãƒªãƒ¼">
    <!-- KPIãƒˆã‚°ãƒ«ï¼šå³ä¸Šï¼ˆåˆæœŸã¯ã€Œéš ã™ã€çŠ¶æ…‹ã®è¡¨è¨˜ã ãŒã€åˆæœŸã¯collapsed=trueã§éš ã—ã¾ã™ï¼‰ -->
    <button id="kpiToggle" class="kpi-toggle" aria-expanded="false" aria-controls="kpiBox">KPIã‚’è¡¨ç¤º</button>

    <!-- KPIãƒœãƒƒã‚¯ã‚¹ï¼ˆæ‰‹å‹•/è‡ªå‹•ã§åç´ãƒ»å±•é–‹ï¼‰ -->
    <div id="kpiBox" class="kpi-box">
      <!-- KPIï¼š3æ®µ -->
      <div class="kpi-row kpi-row1">
        <div class="kpi-card">
          <div class="kpi-header"><span class="kpi-icon">ğŸ“„</span><span class="kpi-label">ä»¶æ•°</span></div>
          <div class="kpi-value" id="sumCount">--</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-header"><span class="kpi-icon">ğŸ¥‡</span><span class="kpi-label">å‹ç‡</span></div>
          <div class="kpi-value" id="winRate">--%</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-header"><span class="kpi-icon">ğŸ’°</span><span class="kpi-label">å®Ÿç¾æç›Š</span></div>
          <div class="kpi-value" id="netProfit">--</div>
        </div>
      </div>

      <div class="kpi-row kpi-row2">
        <div class="kpi-card">
          <div class="kpi-header"><span class="kpi-icon">â¬†ï¸</span><span class="kpi-label">åˆ©ç›Šé‡‘é¡åˆè¨ˆ</span></div>
          <div class="kpi-value profit" id="totalProfit">--</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-header"><span class="kpi-icon">â¬‡ï¸</span><span class="kpi-label">æå¤±é‡‘é¡åˆè¨ˆ</span></div>
          <div class="kpi-value loss" id="totalLoss">--</div>
        </div>
      </div>

      <div class="kpi-row kpi-row3">
        <div class="kpi-card">
          <div class="kpi-header"><span class="kpi-icon">ğŸ“Š</span><span class="kpi-label">å¹³å‡æç›Š</span></div>
          <div class="kpi-value" id="avgNet">--</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-header"><span class="kpi-icon">ğŸ”¼</span><span class="kpi-label">å¹³å‡åˆ©ç›Š</span></div>
          <div class="kpi-value profit" id="avgProfitOnly">--</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-header"><span class="kpi-icon">ğŸ”½</span><span class="kpi-label">å¹³å‡æå¤±</span></div>
          <div class="kpi-value loss" id="avgLossOnly">--</div>
        </div>
      </div>
    </div><!-- /kpi-box -->

    <!-- ã‚¯ã‚¤ãƒƒã‚¯æœŸé–“ -->
    <div class="quick-chips chips-compact">
      <button type="button" data-range="this-month" class="chip">ä»Šæœˆ</button>
      <button type="button" data-range="last-month" class="chip">å…ˆæœˆ</button>
      <button type="button" data-range="this-year" class="chip">ä»Šå¹´</button>
      <button type="button" data-range="all" class="chip active">ã™ã¹ã¦</button>
    </div>

    <!-- è¡¨ç¤ºãƒˆã‚°ãƒ«ï¼ˆæç›Šé¡ â‡„ æç›Šç‡ï¼‰ -->
    <div class="seg-toggle" role="tablist" aria-label="è¡¨ç¤ºåˆ‡æ›¿">
      <button class="seg-btn active" data-show="amount" role="tab" aria-selected="true">æç›Šé¡</button>
      <button class="seg-btn" data-show="rate" role="tab" aria-selected="false">æç›Šç‡</button>
    </div>

    <!-- å¹´æœˆãƒ•ã‚£ãƒ«ã‚¿ -->
    <div class="filter-box filter-compact">
      <select id="yearFilter" aria-label="å¹´ãƒ•ã‚£ãƒ«ã‚¿">
        <option value="">å¹´</option>
        <option value="2025">2025</option>
        <option value="2024">2024</option>
      </select>
      <select id="monthFilter" aria-label="æœˆãƒ•ã‚£ãƒ«ã‚¿">
        <option value="">æœˆ</option>
        <option value="01">1</option><option value="02">2</option>
        <option value="03">3</option><option value="04">4</option>
        <option value="05">5</option><option value="06">6</option>
        <option value="07">7</option><option value="08">8</option>
        <option value="09">9</option><option value="10">10</option>
        <option value="11">11</option><option value="12">12</option>
      </select>
    </div>
  </section>

  <p id="emptyState" class="empty-state" style="display:none;">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>

  <!-- è¡¨ã ã‘ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆæ¨ªã‚‚å¯ï¼‰ -->
  <section class="table-wrapper" id="tableWrapper" aria-label="æç›Šä¸€è¦§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸ">
    <table id="realizedTable" aria-label="æç›Šä¸€è¦§">
      <thead>
        <tr>
          <th scope="col" data-key="date">æ—¥ä»˜</th>
          <th scope="col" data-key="name">éŠ˜æŸ„</th>
          <th scope="col" data-key="broker">è¨¼åˆ¸ä¼šç¤¾</th>
          <th scope="col" data-key="account">å£åº§åŒºåˆ†</th>
          <th scope="col" data-key="type">åŒºåˆ†</th>
          <th scope="col" data-key="qty">æ ªæ•°</th>
          <th scope="col" data-key="profit">æç›Šé¡</th>
          <th scope="col" data-key="rate">æç›Šç‡</th>
        </tr>
      </thead>
      <tbody>
        {% for ym, trades in rows_by_ym.items %}
          {% with y=ym|slice:":4" m=ym|slice:"5:7" %}
            <tr class="group-row"><td colspan="8">{{ y }}å¹´ {{ m }}æœˆ</td></tr>
          {% endwith %}
          {% for t in trades %}
            <tr
              data-date="{{ t.date|date:'Y-m-d' }}"
              data-name="{{ t.stock_name }}"
              data-code="{{ t.code }}"
              data-broker="{{ t.broker }}"
              data-account="{{ t.account_type }}"
              data-type="{% if t.trade_type == 'sell' %}å£²å´{% elif t.trade_type == 'dividend' %}é…å½“{% else %}{{ t.trade_type }}{% endif %}"
              data-quantity="{{ t.quantity|default_if_none:'' }}"
              data-profit="{% if t.profit_amount %}{% if t.profit_amount > 0 %}+{% endif %}{{ t.profit_amount|intcomma }}{% else %}0{% endif %}"
              data-rate="{% if t.profit_rate is not None %}{% if t.profit_rate > 0 %}+{% endif %}{{ t.profit_rate }}%{% else %}0%{% endif %}"
              data-purchase="{{ t.purchase_price|default_if_none:''|intcomma }}"
              data-sell="{{ t.sell_price|default_if_none:''|intcomma }}"
              data-fee="{{ t.fee|default_if_none:0|intcomma }}"
            >
              <td>{{ t.date|date:"Y-m-d" }}</td>
              <td class="stock-name-cell">
                <span class="name">{{ t.stock_name }}</span>
                <span class="code"> {{ t.code }}</span>
              </td>
              <td>{{ t.broker }}</td>
              <td>{{ t.account_type }}</td>
              <td class="trade-type-cell"><span>{% if t.trade_type == 'sell' %}å£²å´{% elif t.trade_type == 'dividend' %}é…å½“{% else %}{{ t.trade_type }}{% endif %}</span></td>
              <td>{% if t.quantity is not None %}{{ t.quantity|intcomma }}{% else %}-{% endif %}</td>

              {% if t.profit_amount is not None and t.profit_amount < 0 %}
                <td class="profit-cell loss">
                  <div class="pn">
                    <span class="num">{{ t.profit_amount|intcomma }}</span>
                    <span class="bar" data-pn="{{ t.profit_amount }}"></span>
                  </div>
                </td>
              {% else %}
                <td class="profit-cell profit">
                  <div class="pn">
                    <span class="num">{% if t.profit_amount %}+{% endif %}{{ t.profit_amount|default_if_none:0|intcomma }}</span>
                    <span class="bar" data-pn="{{ t.profit_amount|default_if_none:0 }}"></span>
                  </div>
                </td>
              {% endif %}

              {% if t.profit_rate is not None and t.profit_rate < 0 %}
                <td class="rate-cell loss"><span class="num">{{ t.profit_rate }}%</span></td>
              {% else %}
                <td class="rate-cell profit"><span class="num">{% if t.profit_rate %}+{% endif %}{{ t.profit_rate|default_if_none:0 }}%</span></td>
              {% endif %}
            </tr>
          {% endfor %}
        {% empty %}
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«Top FAB -->
  <button id="scrollTopFab" class="fab" aria-label="å…ˆé ­ã«æˆ»ã‚‹">â–²</button>

</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="stockModal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
  <div class="modal-content glass-box" role="document">
    <span class="close" aria-label="é–‰ã˜ã‚‹">&times;</span>
    <h2 id="modalTitle" class="modal-title-center"></h2>

    <div class="modal-amounts">
      <div class="amount-card">
        <div class="amount-label">å£²å´é¡</div>
        <div class="amount-value" id="modalSellAmount">--</div>
      </div>
      <div class="amount-card">
        <div class="amount-label">å–å¾—é¡</div>
        <div class="amount-value" id="modalBuyAmount">--</div>
      </div>
    </div>

    <div class="modal-grid">
      <p><span class="k">å£²å´å˜ä¾¡</span><span id="modalSell"></span></p>
      <p><span class="k">å–å¾—å˜ä¾¡</span><span id="modalPurchase"></span></p>

      <p><span class="k">æ ªæ•°</span><span id="modalQuantity"></span></p>
      <p><span class="k">æ‰‹æ•°æ–™</span><span id="modalFee"></span></p>

      <p><span class="k">è¨¼åˆ¸ä¼šç¤¾</span><span id="modalBroker"></span></p>
      <p><span class="k">å£åº§åŒºåˆ†</span><span id="modalAccount"></span></p>

      <p class="full"><span class="k">æç›Šé¡</span><span id="modalProfit" class="pn"></span></p>
    </div>
  </div>
</div>

{% include "bottom_tab.html" %}

<link rel="stylesheet" href="{% static 'css/realized.css' %}">
<script src="{% static 'js/realized.js' %}"></script>
{% endblock %}