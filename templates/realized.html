{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="rp-page theme-dark">
  <!-- èƒŒæ™¯ -->
  <div class="rp-ambient" aria-hidden="true">
    <span class="rp-blob b1"></span>
    <span class="rp-blob b2"></span>
    <span class="rp-blob b3"></span>
  </div>

  <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
  <header class="rp-topbar">
    <div class="brand">
      <span class="logo">ğŸš€</span>
      <span class="title">Neon Pulse â€” Realized</span>
    </div>
    <div class="actions">
      <button id="themeToggle" class="icon-btn" aria-label="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ—</button>
      <button id="densityToggle" class="icon-btn" aria-label="è¡¨ç¤ºå¯†åº¦">â†•ï¸</button>
    </div>
  </header>

  <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆæ¤œç´¢ / KPIï¼‰ -->
  <section class="rp-controls" role="region" aria-label="çµã‚Šè¾¼ã¿ã¨KPI">
    <div class="topline">
      <div class="searchbox">
        <input id="searchInput" type="search" placeholder="éŠ˜æŸ„ / ã‚³ãƒ¼ãƒ‰ / è¨¼åˆ¸ä¼šç¤¾ / åŒºåˆ†" aria-label="ãƒ†ãƒ¼ãƒ–ãƒ«æ¤œç´¢">
        <button id="clearSearch" class="icon-btn" aria-label="æ¤œç´¢ã‚¯ãƒªã‚¢">âœ–</button>
      </div>

      <button id="kpiToggle" class="kpi-toggle" aria-expanded="false" aria-controls="kpiBox">
        <span class="kpi-ico">ğŸ“Š</span><span class="kpi-txt">KPI</span><span class="kpi-caret">â–¼</span>
      </button>
    </div>

    <!-- ã‚¯ã‚¤ãƒƒã‚¯æœŸé–“ -->
    <div class="quick-chips">
      <button type="button" data-range="this-month" class="chip">ä»Šæœˆ</button>
      <button type="button" data-range="last-month" class="chip">å…ˆæœˆ</button>
      <button type="button" data-range="this-year" class="chip">ä»Šå¹´</button>
      <button type="button" data-range="all" class="chip active">ã™ã¹ã¦</button>
    </div>

    <!-- å¹´æœˆ -->
    <div class="filter-box">
      <select id="yearFilter" aria-label="å¹´">
        <option value="">å¹´</option>
        <option value="2025">2025</option>
        <option value="2024">2024</option>
      </select>
      <select id="monthFilter" aria-label="æœˆ">
        <option value="">æœˆ</option>
        <option value="01">1</option><option value="02">2</option>
        <option value="03">3</option><option value="04">4</option>
        <option value="05">5</option><option value="06">6</option>
        <option value="07">7</option><option value="08">8</option>
        <option value="09">9</option><option value="10">10</option>
        <option value="11">11</option><option value="12">12</option>
      </select>
    </div>

    <!-- KPI -->
    <div id="kpiBox" class="kpi-box">
      <div class="kpi-deck">
        <div class="kpi-card ring">
          <div class="ring-wrap">
            <!-- 12æ™‚èµ·ç‚¹ -->
            <svg viewBox="0 0 36 36" class="circular" aria-hidden="true">
              <path class="bg" pathLength="100" d="M18 2a16 16 0 1 1 0 32 16 16 0 1 1 0-32"/>
              <path id="winArc" class="fg" pathLength="100" stroke-dasharray="0 100" stroke-dashoffset="0" d="M18 2a16 16 0 1 1 0 32 16 16 0 1 1 0-32"/>
            </svg>
            <div class="ring-val"><span id="winRate">--%</span><small>å‹ç‡</small></div>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-header"><span>ğŸ“„</span><span>ä»¶æ•°</span></div>
          <div class="kpi-value" id="sumCount">--</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-header"><span>ğŸ’°</span><span>å®Ÿç¾æç›Š</span></div>
          <div class="kpi-value" id="netProfit">--</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-header"><span>â¬†ï¸</span><span>åˆ©ç›Šåˆè¨ˆ</span></div>
          <div class="kpi-value profit" id="totalProfit">--</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-header"><span>â¬‡ï¸</span><span>æå¤±åˆè¨ˆ</span></div>
          <div class="kpi-value loss" id="totalLoss">--</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-header"><span>ğŸ“Š</span><span>å¹³å‡æç›Š</span></div>
          <div class="kpi-value" id="avgNet">--</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-header"><span>ğŸ”¼</span><span>å¹³å‡åˆ©ç›Š</span></div>
          <div class="kpi-value profit" id="avgProfitOnly">--</div>
        </div>

        <div class="kpi-card">
          <div class="kpi-header"><span>ğŸ”½</span><span>å¹³å‡æå¤±</span></div>
          <div class="kpi-value loss" id="avgLossOnly">--</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ãƒ“ãƒ¥ãƒ¼ã‚¿ãƒ– -->
  <nav class="rp-tabs" role="tablist" aria-label="ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿">
    <button class="tab active" data-view="ledger" role="tab" aria-selected="true">Ledger</button>
    <button class="tab" data-view="tiles" role="tab" aria-selected="false">Tiles</button>
    <button class="tab" data-view="insights" role="tab" aria-selected="false">Insights</button>
  </nav>

  <!-- Ledgerï¼ˆè¡¨ï¼‰ -->
  <section id="view-ledger" class="view active">
    <div class="scroll-area">
      <p id="emptyState" class="empty-state" style="display:none;">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
      <div class="table-wrapper" id="tableWrapper" aria-label="æç›Šä¸€è¦§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸ">
        <table id="realizedTable" aria-label="æç›Šä¸€è¦§">
          <thead>
            <tr>
              <th scope="col" data-key="date">æ—¥ä»˜</th>
              <th scope="col" data-key="name">éŠ˜æŸ„</th>
              <th scope="col" data-key="broker">è¨¼åˆ¸ä¼šç¤¾</th>
              <th scope="col" data-key="account">å£åº§åŒºåˆ†</th>
              <th scope="col" data-key="type">åŒºåˆ†</th>
              <th scope="col" data-key="qty">æ ªæ•°</th>
              <th scope="col" data-key="pnl">æç›Šï¼ˆé¡ / ç‡ï¼‰</th>
            </tr>
          </thead>
          <tbody>
            {% for ym, trades in rows_by_ym.items %}
              {% with y=ym|slice:":4" m=ym|slice:"5:7" %}
                <tr class="group-row"><td colspan="7">{{ y }}å¹´ {{ m }}æœˆ</td></tr>
              {% endwith %}
              {% for t in trades %}
                <tr
                  data-date="{{ t.date|date:'Y-m-d' }}"
                  data-name="{{ t.stock_name }}"
                  data-code="{{ t.code }}"
                  data-broker="{{ t.broker }}"
                  data-account="{{ t.account_type }}"
                  data-type="{% if t.trade_type == 'sell' %}å£²å´{% elif t.trade_type == 'dividend' %}é…å½“{% else %}{{ t.trade_type }}{% endif %}"
                  data-quantity="{{ t.quantity|default_if_none:'' }}"
                  data-profit="{% if t.profit_amount %}{% if t.profit_amount > 0 %}+{% endif %}{{ t.profit_amount|intcomma }}{% else %}0{% endif %}"
                  data-rate="{% if t.profit_rate is not None %}{% if t.profit_rate > 0 %}+{% endif %}{{ t.profit_rate }}%{% else %}0%{% endif %}"
                  data-purchase="{{ t.purchase_price|default_if_none:''|intcomma }}"
                  data-sell="{{ t.sell_price|default_if_none:''|intcomma }}"
                  data-fee="{{ t.fee|default_if_none:0|intcomma }}"
                >
                  <td>{{ t.date|date:"Y-m-d" }}</td>

                  <td class="stock-name-cell">
                    <span class="name">{{ t.stock_name }}</span>
                    <span class="code">{{ t.code }}</span>
                  </td>

                  <td>{{ t.broker }}</td>
                  <td>{{ t.account_type }}</td>
                  <td class="trade-type-cell"><span>{% if t.trade_type == 'sell' %}å£²å´{% elif t.trade_type == 'dividend' %}é…å½“{% else %}{{ t.trade_type }}{% endif %}</span></td>
                  <td>{% if t.quantity is not None %}{{ t.quantity|intcomma }}{% else %}-{% endif %}</td>

                  <!-- æç›Šï¼ˆé¡ï¼‹ãƒãƒ¼ï¼‹ç‡ãƒãƒƒãƒ—ï¼‰-->
                  {% with pn_val=t.profit_amount|default_if_none:0 %}
                  <td class="pnl-cell {% if pn_val < 0 %}loss{% else %}profit{% endif %}">
                    <div class="pnl-wrap">
                      <div class="amount">
                        <!-- é‡‘é¡ï¼ˆå¿…ãšå‡ºã™ï¼‰ï¼šJSã§ãƒãƒƒãƒˆæç›Šã«æ­£è¦åŒ–ã—ã¦ä¸Šæ›¸ã -->
                        <span class="num">{% if t.profit_amount %}{% if t.profit_amount > 0 %}+{% endif %}{{ t.profit_amount|intcomma }}{% else %}0{% endif %}</span>
                        <span class="bar" data-pn="{{ pn_val }}"></span>
                      </div>
                      <span class="rate chip {% if t.profit_rate is not None and t.profit_rate < 0 %}loss{% else %}profit{% endif %}">
                        {% if t.profit_rate %}
                          {% if t.profit_rate > 0 %}+{% endif %}{{ t.profit_rate }}
                        {% else %}0{% endif %}%
                      </span>
                    </div>
                  </td>
                  {% endwith %}
                </tr>
              {% endfor %}
            {% empty %}{% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Tilesï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰ -->
  <section id="view-tiles" class="view">
    <div class="scroll-area">
      <div id="tilesGrid" class="tiles-grid" aria-live="polite"></div>
    </div>
  </section>

  <!-- Insights -->
  <section id="view-insights" class="view">
    <div class="scroll-area">
      <div class="insights-wrap">
        <div class="ins-panel">
          <h3>æœˆæ¬¡æç›Š</h3>
          <canvas id="monthlyChart" width="600" height="260" aria-label="æœˆæ¬¡æç›Šãƒãƒ£ãƒ¼ãƒˆ"></canvas>
        </div>
        <div class="ins-panel two-col">
          <div>
            <h3>Top Gainers</h3>
            <ol id="topGainers" class="rank-list"></ol>
          </div>
          <div>
            <h3>Top Losers</h3>
            <ol id="topLosers" class="rank-list"></ol>
          </div>
        </div>
        <div class="ins-panel">
          <h3>ãƒ–ãƒ­ãƒ¼ã‚«ãƒ¼åˆ¥ å®Ÿç¾æç›Š</h3>
          <ul id="byBroker" class="pill-list"></ul>
        </div>
      </div>
    </div>
  </section>

  <!-- FAB -->
  <button id="scrollTopFab" class="fab" aria-label="å…ˆé ­ã«æˆ»ã‚‹">â–²</button>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="stockModal" class="modal" aria-hidden="true" aria-modal="true" role="dialog">
  <div class="modal-content glass-box" role="document">
    <span class="close" aria-label="é–‰ã˜ã‚‹">&times;</span>
    <h2 id="modalTitle" class="modal-title-center"></h2>

    <div class="modal-amounts">
      <div class="amount-card">
        <div class="amount-label">å£²å´é¡</div>
        <div class="amount-value" id="modalSellAmount">--</div>
      </div>
      <div class="amount-card">
        <div class="amount-label">å–å¾—é¡</div>
        <div class="amount-value" id="modalBuyAmount">--</div>
      </div>
    </div>

    <div class="modal-grid">
      <p><span class="k">å£²å´å˜ä¾¡</span><span id="modalSell"></span></p>
      <p><span class="k">å–å¾—å˜ä¾¡</span><span id="modalPurchase"></span></p>
      <p><span class="k">æ ªæ•°</span><span id="modalQuantity"></span></p>
      <p><span class="k">æ‰‹æ•°æ–™</span><span id="modalFee"></span></p>
      <p><span class="k">è¨¼åˆ¸ä¼šç¤¾</span><span id="modalBroker"></span></p>
      <p><span class="k">å£åº§åŒºåˆ†</span><span id="modalAccount"></span></p>
      <p class="full"><span class="k">æç›Šé¡</span><span id="modalProfit" class="pn"></span></p>
    </div>
  </div>
</div>

{% include "bottom_tab.html" %}

<link rel="stylesheet" href="{% static 'css/realized.css' %}">
<script src="{% static 'js/realized.js' %}"></script>
{% endblock %}