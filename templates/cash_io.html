{% extends "base.html" %}
{% load static humanize %}

{% block title %}入出金{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cash_io.css' %}">
{% endblock %}

{% block content %}
<div class="cash-page">
  {% if messages %}
    <ul class="msgs">
      {% for m in messages %}
        <li class="msg {{ m.tags }}">{{ m }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <!-- 証券会社タブ -->
  <nav class="tabs" role="tablist" aria-label="証券会社">
    {% for key, label in tabs %}
      <a class="tab {% if key == active_broker %}active{% endif %}"
         href="{% url 'cash_io' %}?broker={{ key }}">{{ label }}</a>
    {% endfor %}
  </nav>

  <!-- 残高サマリー（3社分） -->
  <section class="summary real">
    <div class="pill {% if active_broker == 'rakuten' %}focus{% endif %}">
      <span class="k">楽天証券</span>
      <span class="v">¥{{ balances.rakuten|default:0|floatformat:0|intcomma }}</span>
    </div>
    <div class="pill {% if active_broker == 'matsui' %}focus{% endif %}">
      <span class="k">松井証券</span>
      <span class="v">¥{{ balances.matsui|default:0|floatformat:0|intcomma }}</span>
    </div>
    <div class="pill {% if active_broker == 'sbi' %}focus{% endif %}">
      <span class="k">SBI証券</span>
      <span class="v">¥{{ balances.sbi|default:0|floatformat:0|intcomma }}</span>
    </div>
  </section>

  <!-- 入出金フォーム -->
  <form id="cash-form" method="post" class="card" novalidate>
    {% csrf_token %}
    <input type="hidden" name="broker" value="{{ active_broker }}">

    <div class="mode-row" role="radiogroup" aria-label="入出金">
      <label class="mode"><input type="radio" name="flow_type" value="in" checked>入金</label>
      <label class="mode"><input type="radio" name="flow_type" value="out">出金</label>
    </div>

    <div class="amount-wrap">
      <div class="amt-display">
        <span class="currency">¥</span>
        <input id="amount" name="amount" type="text" inputmode="numeric" placeholder="0" autocomplete="off">
      </div>
      <div class="chips">
        <button type="button" class="chip" data-add="1000">+1,000</button>
        <button type="button" class="chip" data-add="5000">+5,000</button>
        <button type="button" class="chip" data-add="10000">+10,000</button>
        <button type="button" class="chip" data-clear="1">クリア</button>
      </div>
    </div>

    <div class="grid2">
      <div class="field">
        <label>日付</label>
        <input type="date" name="occurred_at" value="{{ today }}">
      </div>
      <div class="field">
        <label>メモ</label>
        <input type="text" name="memo" placeholder="例: 口座振替 / 出金依頼">
      </div>
    </div>

    <!-- テンキー -->
    <div class="numpad">
      <button type="button" data-key="1">1</button>
      <button type="button" data-key="2">2</button>
      <button type="button" data-key="3">3</button>
      <button type="button" data-key="4">4</button>
      <button type="button" data-key="5">5</button>
      <button type="button" data-key="6">6</button>
      <button type="button" data-key="7">7</button>
      <button type="button" data-key="8">8</button>
      <button type="button" data-key="9">9</button>
      <button type="button" data-key="00">00</button>
      <button type="button" data-key="0">0</button>
      <button type="button" data-back="1">⌫</button>
    </div>

    <div class="sticky-actions">
      <button class="btn primary" type="submit">登録する</button>
    </div>
  </form>

  <!-- 最近の入出金（選択中の証券会社） -->
  <section class="history">
    <h2 class="h-title">最近の入出金</h2>
    <ul class="list">
      {% for it in recent %}
        <li class="row">
          <span class="date">{{ it.occurred_at }}</span>
          <span class="type {% if it.flow_type == 'in' %}in{% else %}out{% endif %}">
            {% if it.flow_type == 'in' %}+{% else %}-{% endif %}¥{{ it.amount|floatformat:0|intcomma }}
          </span>
          <span class="memo">{{ it.memo }}</span>
        </li>
      {% empty %}
        <li class="empty">まだ入出金はありません</li>
      {% endfor %}
    </ul>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/cash_io.js' %}" defer></script>
{% endblock %}