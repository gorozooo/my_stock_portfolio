{% extends "base.html" %}
{% load static humanize %}

{% block title %}入出金{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cash_io.css' %}">
{% endblock %}

{% block content %}
<div class="cash-page">

  {% if messages %}
    <ul class="msgs">
      {% for m in messages %}
        <li class="msg {{ m.tags }}">{{ m }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if can_undo and undo_id %}
    <div class="undo-bar card" aria-live="polite">
      <div class="left">直前の入出金を取り消せます（約 {{ undo_seconds }} 秒以内）</div>
      <form method="post" action="{% url 'cash_undo' %}">{% csrf_token %}
        <button class="oplink" type="submit">取り消す</button>
      </form>
    </div>
  {% endif %}

  <!-- 証券会社タブ（?broker=... は q と range を維持） -->
  <nav class="tabs" role="tablist" aria-label="証券会社">
    {% for key, label in tabs %}
      <a
        class="tab {% if key == active_broker %}active{% endif %}"
        href="{% url 'cash_io' %}?broker={{ key }}&q={{ q|default:''|urlencode }}&range={{ range|default:'all' }}"
      >{{ label }}</a>
    {% endfor %}
  </nav>

  <!-- 残高サマリー -->
  <section class="summary real">
    <div class="pill {% if active_broker == 'rakuten' %}focus{% endif %}">
      <span class="k">楽天証券</span>
      <span class="v">¥{{ balances.rakuten|default:0|floatformat:0|intcomma }}</span>
    </div>
    <div class="pill {% if active_broker == 'matsui' %}focus{% endif %}">
      <span class="k">松井証券</span>
      <span class="v">¥{{ balances.matsui|default:0|floatformat:0|intcomma }}</span>
    </div>
    <div class="pill {% if active_broker == 'sbi' %}focus{% endif %}">
      <span class="k">SBI証券</span>
      <span class="v">¥{{ balances.sbi|default:0|floatformat:0|intcomma }}</span>
    </div>
  </section>

  <!-- 入出金フォーム -->
  <form id="cash-form" method="post" class="card" novalidate>
    {% csrf_token %}
    <input type="hidden" name="broker" value="{{ active_broker }}">

    <div class="mode-row" role="radiogroup" aria-label="入出金">
      <label class="mode"><input type="radio" name="flow_type" value="in" checked>入金</label>
      <label class="mode"><input type="radio" name="flow_type" value="out">出金</label>
    </div>

    <div class="amount-wrap">
      <div class="amt-display">
        <span class="currency">¥</span>
        <input id="amount" name="amount" type="text" inputmode="numeric" placeholder="0" autocomplete="off">
      </div>
      <div class="chips">
        <button type="button" class="chip" data-add="1000">+1,000</button>
        <button type="button" class="chip" data-add="5000">+5,000</button>
        <button type="button" class="chip" data-add="10000">+10,000</button>
        <button type="button" class="chip" data-clear="1">クリア</button>
      </div>
    </div>

    <div class="grid2">
      <div class="field">
        <label>日付</label>
        <input type="date" name="occurred_at" value="{{ today }}">
      </div>
      <div class="field">
        <label>メモ</label>
        <input type="text" name="memo" placeholder="例: 口座振替 / 出金依頼">
      </div>
    </div>

    <!-- テンキー -->
    <div class="numpad">
      <button type="button" data-key="1">1</button>
      <button type="button" data-key="2">2</button>
      <button type="button" data-key="3">3</button>
      <button type="button" data-key="4">4</button>
      <button type="button" data-key="5">5</button>
      <button type="button" data-key="6">6</button>
      <button type="button" data-key="7">7</button>
      <button type="button" data-key="8">8</button>
      <button type="button" data-key="9">9</button>
      <button type="button" data-key="00">00</button>
      <button type="button" data-key="0">0</button>
      <button type="button" data-back="1">⌫</button>
    </div>

    <div class="sticky-actions">
      <button class="btn primary" type="submit">登録する</button>
    </div>
  </form>

  <!-- クイックフィルター（7 / 30 / 90 / すべて） -->
  <div class="card filters" role="region" aria-label="最近の入出金フィルター">
    <div class="chips" aria-label="期間">
      <a class="chip {% if range == '7' %}active{% endif %}"
         href="{% url 'cash_io' %}?broker={{ active_broker }}&q={{ q|default:''|urlencode }}&range=7">直近7日</a>
      <a class="chip {% if range == '30' %}active{% endif %}"
         href="{% url 'cash_io' %}?broker={{ active_broker }}&q={{ q|default:''|urlencode }}&range=30">直近30日</a>
      <a class="chip {% if range == '90' %}active{% endif %}"
         href="{% url 'cash_io' %}?broker={{ active_broker }}&q={{ q|default:''|urlencode }}&range=90">直近90日</a>
      <a class="chip {% if not range or range == 'all' %}active{% endif %}"
         href="{% url 'cash_io' %}?broker={{ active_broker }}&q={{ q|default:''|urlencode }}&range=all">すべて</a>
    </div>

    <form method="get" action="{% url 'cash_io' %}">
      <input type="hidden" name="broker" value="{{ active_broker }}">
      <input type="hidden" name="range"  value="{{ range|default:'all' }}">
      <input class="field-input" type="text" name="q" value="{{ q }}" placeholder="メモ検索">
      <button class="btn secondary" type="submit">検索</button>
    </form>
  </div>

  <!-- 最近の入出金（見切れ防止レイアウト） -->
  <section class="history">
    <h2 class="h-title">最近の入出金（{{ active_label }}）</h2>
    <ul class="list">
      {% for it in recent %}
        <li class="row">
          <span class="date">{{ it.occurred_at|date:"n/j" }}</span>
          <span class="memo">{{ it.memo }}</span>
          <span class="type {% if it.flow_type == 'in' %}in{% else %}out{% endif %}">
            {% if it.flow_type == 'in' %}+{% else %}-{% endif %}¥{{ it.amount|floatformat:0|intcomma }}
          </span>
          <span class="ops">
            <a class="oplink" href="{% url 'cash_flow_edit' it.id %}">編集</a>
            <form method="post" action="{% url 'cash_flow_delete' it.id %}" style="display:inline">{% csrf_token %}
              <button type="submit" class="opdel" onclick="return confirm('削除しますか？');">削除</button>
            </form>
          </span>
        </li>
      {% empty %}
        <li class="empty">まだ入出金はありません</li>
      {% endfor %}
    </ul>

    <!-- 合計 -->
    <div class="card totals">
      <div class="totals-row">
        <div>入金合計：<strong>¥{{ totals_in|floatformat:0|intcomma }}</strong></div>
        <div>出金合計：<strong>¥{{ totals_out|floatformat:0|intcomma }}</strong></div>
        <div>差引：
          <strong class="{% if totals_net >= 0 %}type in{% else %}type out{% endif %}">
            ¥{{ totals_net|floatformat:0|intcomma }}
          </strong>
        </div>
      </div>
    </div>
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/cash_io.js' %}" defer></script>
{% endblock %}