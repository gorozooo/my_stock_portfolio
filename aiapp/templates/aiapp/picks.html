{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}AI Picks{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#0b0f1a; --card:rgba(255,255,255,0.06); --sub:#94a3b8; --fg:#eaf0ff;
    --accent:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --muted:#334155;
  }
  body{background:var(--bg);color:var(--fg)}
  .wrap{max-width:720px;margin:0 auto;padding:10px 12px 80px}
  .head{
    display:flex;align-items:center;justify-content:space-between;
    padding:14px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05);
    border-radius:16px;margin:6px 0 12px 0;backdrop-filter:blur(10px)
  }
  .head .ts{font-size:14px;color:#bac5d6}
  .head .btn{
    padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.07);color:#eaf0ff;text-decoration:none
  }
  .grid{display:grid;gap:10px}
  .card{
    border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05);
    border-radius:16px;padding:14px;backdrop-filter:blur(10px)
  }
  .ttl{display:flex;gap:8px;align-items:flex-start;justify-content:space-between}
  .ttl h3{font-size:16px;margin:0;line-height:1.3}
  .ttl .sub{font-size:12px;color:#9fb1c7}
  .stars{font-size:14px;letter-spacing:1px;text-align:right}
  .kpi{display:grid;gap:8px;margin-top:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
  .kpi .it{border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px}
  .kpi .lb{font-size:12px;color:#9fb1c7}
  .kpi .vl{font-size:16px}
  .kpi .pos{color:var(--ok)} .kpi .neg{color:var(--bad)}
  .reasons{margin:10px 0 0 0;padding-left:16px}
  .reasons li{margin:2px 0}
  .btns{display:flex;gap:8px;margin-top:12px}
  .btns a{
    flex:1;text-align:center;text-decoration:none;color:#eaf0ff;
    border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px 8px;background:rgba(255,255,255,.07)
  }
  .empty{
    margin-top:16px;padding:16px;border:1px dashed rgba(255,255,255,.15);border-radius:12px;color:#c7d2e0
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <!-- ヘッダ（更新時刻＋件数＋スナップショット種別） -->
  <div class="head">
    <div>
      <div class="ts">最終更新</div>
      <div style="font-weight:600">
        {{ last_updated_text|default:"-" }}
        <small style="opacity:.7;margin-left:.4em;">
          {{ items_count|default:0 }}件 / {{ snapshot_kind|default:"-" }}
        </small>
      </div>
    </div>
    <div>
      <a class="btn" href="{% url 'aiapp:toggle' %}?back=picks">LIVE/DEMO</a>
    </div>
  </div>

  {% if items and items|length > 0 %}
    <div class="grid">
      {% for item in items %}
        <div class="card">
          <div class="ttl">
            <div>
              <h3>{{ item.name_norm|default:item.name|default:"—" }}</h3>
              <div class="sub">
                {{ item.code|default:"-" }} ・ 
                {% if item.sector_name %}
                  {{ item.sector_name }}
                {% else %}
                  —
                {% endif %}
              </div>
            </div>
            <div class="stars">
              <div>
                {% with s=item.stars|default:0 %}
                  {% for _ in ""|center:s %}⭐️{% endfor %}
                {% endwith %}
                {% if item.score %}<span class="sub">（{{ item.score }}）</span>{% endif %}
              </div>
              {% if item.score_100 is not None %}
                <div class="sub">総合得点 {{ item.score_100 }} 点</div>
              {% endif %}
            </div>
          </div>

          <div class="kpi">
            <div class="it">
              <div class="lb">現在値</div>
              <div class="vl">
                {% if item.last_close %}{{ item.last_close|floatformat:1|intcomma }} 円{% else %}—{% endif %}
              </div>
            </div>
            <div class="it">
              <div class="lb">
                数量（{% if lot_size %}{{ lot_size }}{% else %}100{% endif %}株単元・リスク{% if risk_pct %}{{ risk_pct|floatformat:2 }}{% else %}0.02{% endif %}）
              </div>
              <div class="vl">{{ item.qty|default:0|intcomma }} 株</div>
            </div>
            <div class="it">
              <div class="lb">Entry / TP / SL</div>
              <div class="vl">
                {% if item.entry %}{{ item.entry|floatformat:1|intcomma }}{% else %}—{% endif %} /
                {% if item.tp %}{{ item.tp|floatformat:1|intcomma }}{% else %}—{% endif %} /
                {% if item.sl %}{{ item.sl|floatformat:1|intcomma }}{% else %}—{% endif %} 円
              </div>
            </div>
            <div class="it">
              <div class="lb">必要資金</div>
              <div class="vl">
                {% if item.required_cash %}{{ item.required_cash|floatformat:0|intcomma }} 円{% else %}—{% endif %}
              </div>
            </div>
            <div class="it">
              <div class="lb">想定利益</div>
              <div class="vl pos">
                {% if item.est_pl %}+{{ item.est_pl|floatformat:0|intcomma }} 円{% else %}—{% endif %}
              </div>
            </div>
            <div class="it">
              <div class="lb">想定損失</div>
              <div class="vl neg">
                {% if item.est_loss %}-{{ item.est_loss|floatformat:0|intcomma }} 円{% else %}—{% endif %}
              </div>
            </div>
          </div>

          {% if item.reasons %}
            <ul class="reasons">
              {% for line in item.reasons %}
                <li>{{ line }}</li>
              {% endfor %}
            </ul>
          {% endif %}

          <div class="btns">
            <a href="#">ウォッチ</a>
            <a href="#">シミュレ</a>
            <a href="#">今すぐで</a>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">
      候補が0件です。条件が厳しすぎる可能性があります。右上のLIVE/DEMO切替や、style/horizonを変更してください。
    </div>
  {% endif %}

</div>
{% endblock %}