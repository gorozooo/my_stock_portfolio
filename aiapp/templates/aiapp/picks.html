{# templates/aiapp/picks.html #}
{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}AI Picks{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#0b0f1a; --card:rgba(255,255,255,0.06); --sub:#94a3b8; --fg:#eaf0ff;
    --accent:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --muted:#334155;
  }
  body{background:var(--bg);color:var(--fg)}
  .wrap{max-width:720px;margin:0 auto;padding:10px 12px 80px}
  .head{
    display:flex;align-items:center;justify-content:space-between;
    padding:14px;border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05);
    border-radius:16px;margin:6px 0 12px 0;backdrop-filter:blur(10px)
  }
  .head .ts{font-size:14px;color:#bac5d6}
  .head .btn{
    padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.07);color:#eaf0ff;text-decoration:none
  }

  .grid{display:grid;gap:10px}
  .card{
    border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05);
    border-radius:16px;padding:14px;backdrop-filter:blur(10px)
  }
  .ttl{display:flex;gap:8px;align-items:flex-start;justify-content:space-between}
  .ttl h3{font-size:16px;margin:0;line-height:1.3}
  .ttl .sub{font-size:12px;color:#9fb1c7}

  /* æ˜Ÿï¼‹ã‚¹ã‚³ã‚¢ */
  .stars{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:4px;
    line-height:1;
  }
  .stars .star-wrap{position:relative;display:inline-block}
  .stars .star-base{color:#3a475a;letter-spacing:1px;font-size:16px}
  .stars .star-fill{
    position:absolute;inset:0;
    color:#ffd166;overflow:hidden;white-space:nowrap;letter-spacing:1px;font-size:16px
  }
  .stars .score-text{
    font-size:15px;
    font-weight:600;
    color:#fff;
    text-align:center;
    margin-top:2px;
  }

  .kpi{
    display:grid;
    gap:8px;
    margin-top:10px;
    grid-template-columns:repeat(2,minmax(0,1fr));
  }
  .kpi .it{
    border:1px solid rgba(255,255,255,.08);
    border-radius:12px;
    padding:8px;
  }
  .kpi .lb{font-size:12px;color:#9fb1c7}
  .kpi .vl{font-size:16px}
  .kpi .pos{color:var(--ok)}
  .kpi .neg{color:var(--bad)}

  /* æ¥½å¤©/æ¾äº• 2æ®µè¡¨ç¤º */
  .brokers{margin-top:4px;display:flex;flex-direction:column;gap:2px}
  .b-line{display:flex;justify-content:space-between;align-items:center;font-size:13px}
  .b-tag{
    padding:2px 7px;border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(15,23,42,.7);
    font-size:11px;color:#dbe4ff;
  }
  .b-val{font-variant-numeric:tabular-nums}

  /* Entry/TP/SL ãƒœãƒƒã‚¯ã‚¹ï¼ˆCæ¡ˆï¼‰ */
  .entry-box .plan{margin-top:4px;font-size:13px;display:flex;flex-direction:column;gap:2px}
  .plan-line{display:flex;align-items:center;gap:4px}
  .plan-line .ico{width:18px;text-align:center;font-size:13px}

  .reasons{margin:10px 0 0 0;padding-left:16px}
  .reasons li{margin:2px 0}
  .btns{display:flex;gap:8px;margin-top:12px}
  .btns a{
    flex:1;text-align:center;text-decoration:none;color:#eaf0ff;
    border:1px solid rgba(255,255,255,.12);border-radius:12px;
    padding:10px 8px;background:rgba(255,255,255,.07)
  }
  .empty{
    margin-top:16px;padding:16px;
    border:1px dashed rgba(255,255,255,.15);
    border-radius:12px;color:#c7d2e0
  }
  .meta{font-size:11px;color:#7f8da3;margin-top:4px}
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="head">
    <div>
      <div class="ts">æœ€çµ‚æ›´æ–°</div>
      <div style="font-weight:600">{{ updated_label }}</div>
      {% if items and items|length > 0 and items.0.price_date %}
        <div class="meta">ä¾¡æ ¼åŸºæº–: {{ items.0.price_date }} / {{ items.0.price_vendor|default:"" }}</div>
      {% endif %}
    </div>
    <div>
      {% if is_demo %}
        <a class="btn" href="?mode=live&reset=1">LIVE/DEMO</a>
      {% else %}
        <a class="btn" href="?mode=demo&reset=1">LIVE/DEMO</a>
      {% endif %}
    </div>
  </div>

  {% if items and items|length > 0 %}
    <div class="grid">
      {% for item in items %}
        <div class="card">
          <div class="ttl">
            <div>
              <h3>{{ item.name_norm|default:item.name }}</h3>
              <div class="sub">
                {{ item.code }} ãƒ» {{ item.sector_display|default:"æ¥­ç¨®ä¸æ˜" }}
              </div>
            </div>
            <div class="stars" aria-label="ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°"
                 title="{% if item.score_100 is not None %}{{ item.score_100|floatformat:0 }} / 100{% else %}N/A{% endif %}">
              {% with p=item.score_100|default:0 %}
                <div class="star-wrap">
                  <span class="star-base">â˜…â˜…â˜…â˜…â˜…</span>
                  <span class="star-fill" style="width: {{ p }}%;">â˜…â˜…â˜…â˜…â˜…</span>
                </div>
                <div class="score-text">{{ p|floatformat:0 }}ç‚¹</div>
              {% endwith %}
            </div>
          </div>

          <div class="kpi">
            {# ç¾åœ¨å€¤ #}
            <div class="it">
              <div class="lb">ç¾åœ¨å€¤</div>
              <div class="vl">
                {% if item.last_close %}
                  {% if item.is_etf or item.sector_display == 'ETF/ETN' %}
                    {{ item.last_close|floatformat:1|intcomma }} å††
                  {% else %}
                    {{ item.last_close|floatformat:0|intcomma }} å††
                  {% endif %}
                {% else %}
                  â€”
                {% endif %}
              </div>
              {% if item.price_date %}
                <div class="meta">{{ item.price_date }} / {{ item.price_vendor|default:"" }}</div>
              {% endif %}
            </div>

            {# æ•°é‡ï¼ˆæ¥½å¤©/æ¾äº• 2æ®µï¼‰ #}
            <div class="it">
              <div class="lb">
                æ•°é‡ï¼ˆ{{ item.lot_size|default:lot_size }}æ ªå˜å…ƒãƒ»ãƒªã‚¹ã‚¯{{ risk_pct|floatformat:2 }}ï¼…ï¼‰
              </div>
              <div class="brokers">
                <div class="b-line">
                  <span class="b-tag">æ¥½å¤©</span>
                  <span class="b-val">
                    {{ item.qty_rakuten|default:0|intcomma }} æ ª
                  </span>
                </div>
                <div class="b-line">
                  <span class="b-tag">æ¾äº•</span>
                  <span class="b-val">
                    {{ item.qty_matsui|default:0|intcomma }} æ ª
                  </span>
                </div>
              </div>
            </div>

            {# Entry / TP / SLï¼ˆã‚¢ã‚¤ã‚³ãƒ³ï¼‹ãƒ¢ãƒ¼ãƒ‰ã‚¿ã‚°ï¼‰ #}
            <div class="it entry-box">
              <div class="lb">Entry / TP / SL</div>
              <div class="plan">
                {% if item.is_etf or item.sector_display == 'ETF/ETN' %}
                  <div class="plan-line">
                    <span class="ico">ğŸŸ©</span>
                    <span>Entryï¼š{% if item.entry %}{{ item.entry|floatformat:1|intcomma }} å††{% else %}-{% endif %}</span>
                  </div>
                  <div class="plan-line">
                    <span class="ico">ğŸ”µ</span>
                    <span>TPï¼š{% if item.tp %}{{ item.tp|floatformat:1|intcomma }} å††{% else %}-{% endif %}</span>
                  </div>
                  <div class="plan-line">
                    <span class="ico">ğŸ”´</span>
                    <span>SLï¼š{% if item.sl %}{{ item.sl|floatformat:1|intcomma }} å††{% else %}-{% endif %}</span>
                  </div>
                {% else %}
                  <div class="plan-line">
                    <span class="ico">ğŸŸ©</span>
                    <span>Entryï¼š{% if item.entry %}{{ item.entry|floatformat:0|intcomma }} å††{% else %}-{% endif %}</span>
                  </div>
                  <div class="plan-line">
                    <span class="ico">ğŸ”µ</span>
                    <span>TPï¼š{% if item.tp %}{{ item.tp|floatformat:0|intcomma }} å††{% else %}-{% endif %}</span>
                  </div>
                  <div class="plan-line">
                    <span class="ico">ğŸ”´</span>
                    <span>SLï¼š{% if item.sl %}{{ item.sl|floatformat:0|intcomma }} å††{% else %}-{% endif %}</span>
                  </div>
                {% endif %}
              </div>
            </div>

            {# å¿…è¦è³‡é‡‘ï¼ˆæ¥½å¤©/æ¾äº•ï¼‰ #}
            <div class="it">
              <div class="lb">å¿…è¦è³‡é‡‘ï¼ˆæ¦‚ç®—ï¼‰</div>
              <div class="brokers">
                <div class="b-line">
                  <span class="b-tag">æ¥½å¤©</span>
                  <span class="b-val">
                    {{ item.required_cash_rakuten|default:0|floatformat:0|intcomma }} å††
                  </span>
                </div>
                <div class="b-line">
                  <span class="b-tag">æ¾äº•</span>
                  <span class="b-val">
                    {{ item.required_cash_matsui|default:0|floatformat:0|intcomma }} å††
                  </span>
                </div>
              </div>
            </div>

            {# æƒ³å®šåˆ©ç›Šï¼ˆæ¥½å¤©/æ¾äº•ï¼‰ #}
            <div class="it">
              <div class="lb">æƒ³å®šåˆ©ç›Š</div>
              <div class="brokers">
                <div class="b-line">
                  <span class="b-tag">æ¥½å¤©</span>
                  <span class="b-val pos">
                    {% if item.est_pl_rakuten %}
                      +{{ item.est_pl_rakuten|floatformat:0|intcomma }} å††
                    {% else %}
                      0 å††
                    {% endif %}
                  </span>
                </div>
                <div class="b-line">
                  <span class="b-tag">æ¾äº•</span>
                  <span class="b-val pos">
                    {% if item.est_pl_matsui %}
                      +{{ item.est_pl_matsui|floatformat:0|intcomma }} å††
                    {% else %}
                      0 å††
                    {% endif %}
                  </span>
                </div>
              </div>
            </div>

            {# æƒ³å®šæå¤±ï¼ˆæ¥½å¤©/æ¾äº•ï¼‰ #}
            <div class="it">
              <div class="lb">æƒ³å®šæå¤±</div>
              <div class="brokers">
                <div class="b-line">
                  <span class="b-tag">æ¥½å¤©</span>
                  <span class="b-val neg">
                    {% if item.est_loss_rakuten %}
                      -{{ item.est_loss_rakuten|floatformat:0|intcomma }} å††
                    {% else %}
                      0 å††
                    {% endif %}
                  </span>
                </div>
                <div class="b-line">
                  <span class="b-tag">æ¾äº•</span>
                  <span class="b-val neg">
                    {% if item.est_loss_matsui %}
                      -{{ item.est_loss_matsui|floatformat:0|intcomma }} å††
                    {% else %}
                      0 å††
                    {% endif %}
                  </span>
                </div>
              </div>
            </div>
          </div>

          {% if item.reasons_text %}
            <ul class="reasons">
              {% for line in item.reasons_text %}
                <li>{{ line }}</li>
              {% endfor %}
            </ul>
          {% endif %}

          <div class="btns">
            <a href="#">ã‚¦ã‚©ãƒƒãƒ</a>
            <a href="#">ã‚·ãƒŸãƒ¥ãƒ¬</a>
            <a href="#">ä»Šã™ãã§</a>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">
      å€™è£œãŒ0ä»¶ã§ã™ã€‚æ¡ä»¶ãŒå³ã—ã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚å³ä¸Šã®LIVE/DEMOåˆ‡æ›¿ã‚„ã€style/horizonã‚’å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
    </div>
  {% endif %}

</div>
{% endblock %}