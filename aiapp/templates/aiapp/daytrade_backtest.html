{% extends "base.html" %}
{% load static humanize %}

{% block title %}デイトレ バックテスト{% endblock %}

{% block content %}
<style>
  /* =========================
     Daytrade Backtest (Mobile First)
     ========================= */

  :root{
    --panel-bg: rgba(255,255,255,.05);
    --panel-bd: rgba(255,255,255,.10);
    --muted: rgba(255,255,255,.70);
    --muted2: rgba(255,255,255,.55);
    --ok: rgba(70, 220, 140, .18);
    --ng: rgba(255, 90, 90, .18);
    --chip: rgba(255,255,255,.08);
  }

  .dt-wrap{
    max-width: 980px;
    margin: 12px auto 0;
    padding: 12px 10px 140px;
  }

  .dt-title{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin: 4px 2px 12px;
  }
  .dt-title h1{
    font-size: 18px;
    margin:0;
    letter-spacing:.2px;
  }
  .dt-title .sub{
    font-size:12px;
    color: var(--muted2);
    white-space:nowrap;
  }

  .card{
    background: var(--panel-bg);
    border: 1px solid var(--panel-bd);
    border-radius: 16px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    overflow:hidden;
  }
  .card + .card{ margin-top: 14px; }

  .card-h{
    padding: 12px 12px 10px;
    border-bottom: 1px solid rgba(255,255,255,.06);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .card-h h2{
    font-size: 14px;
    margin: 0;
    color: rgba(255,255,255,.92);
  }
  .card-h .hint{
    font-size: 12px;
    color: var(--muted2);
  }
  .card-b{
    padding: 12px;
  }

  /* form */
  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }
  @media (min-width: 760px){
    .grid{
      grid-template-columns: 1.1fr .9fr;
      align-items:start;
    }
  }

  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .field label{
    font-size: 12px;
    color: var(--muted);
  }
  .field input[type="text"],
  .field input[type="number"],
  .field select,
  .field textarea{
    width:100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
    color: rgba(255,255,255,.92);
    outline:none;
  }
  .field textarea{
    min-height: 90px;
    resize: vertical;
    line-height: 1.35;
  }
  .row{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .row3{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }

  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top: 6px;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: var(--chip);
    color: rgba(255,255,255,.86);
    font-size: 12px;
    text-decoration:none;
    user-select:none;
  }
  .chip input{ margin:0; }

  .btns{
    display:flex;
    gap:10px;
    margin-top: 10px;
    flex-wrap:wrap;
  }
  .btn{
    appearance:none;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.08);
    color: rgba(255,255,255,.92);
    padding: 10px 12px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 700;
    cursor:pointer;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
  }
  .btn:active{ transform: translateY(1px); }
  .btn.primary{
    border-color: rgba(120,180,255,.35);
    background: rgba(120,180,255,.16);
  }
  .btn.ghost{
    background: rgba(255,255,255,.05);
  }
  .note{
    font-size: 12px;
    color: var(--muted2);
    line-height: 1.45;
    margin-top: 8px;
  }

  /* KPI */
  .kpis{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  @media (min-width: 760px){
    .kpis{ grid-template-columns: repeat(5, 1fr); }
  }
  .kpi{
    padding: 10px 10px 9px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.12);
  }
  .kpi .k{
    font-size: 11px;
    color: var(--muted2);
    margin-bottom: 6px;
  }
  .kpi .v{
    font-size: 15px;
    font-weight: 800;
    letter-spacing:.2px;
  }
  .kpi .s{
    font-size: 11px;
    color: var(--muted2);
    margin-top: 4px;
    line-height: 1.2;
  }

  /* tables */
  .table-wrap{
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
  }
  table{
    width:100%;
    border-collapse: collapse;
    min-width: 720px;
    background: rgba(0,0,0,.10);
  }
  th, td{
    padding: 10px 10px;
    border-bottom: 1px solid rgba(255,255,255,.06);
    text-align:left;
    font-size: 13px;
    white-space: nowrap;
  }
  th{
    font-size: 12px;
    color: var(--muted);
    background: rgba(255,255,255,.04);
    position: sticky;
    top: 0;
    z-index: 1;
  }
  tr:last-child td{ border-bottom:none; }

  .num{ text-align:right; font-variant-numeric: tabular-nums; }
  .pos{ background: var(--ok); }
  .neg{ background: var(--ng); }
  .muted{ color: var(--muted2); }

  /* log */
  .logbox{
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.20);
    border-radius: 14px;
    padding: 10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12px;
    line-height: 1.45;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 260px;
    overflow:auto;
  }

  /* howto */
  .howto{
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.12);
    border-radius: 14px;
    padding: 10px 12px;
  }
  .howto .t{
    font-weight: 800;
    font-size: 13px;
    margin-bottom: 6px;
    color: rgba(255,255,255,.92);
  }
  .howto ol{
    margin: 0;
    padding-left: 18px;
    color: rgba(255,255,255,.85);
    font-size: 12px;
    line-height: 1.4;
  }
  .howto li{
    margin: 3px 0;
  }
</style>

<div class="dt-wrap">

  <div class="dt-title">
    <h1>デイトレ バックテスト</h1>
    <div class="sub">開発用（本番と同じ形で育てる）</div>
  </div>

  <!-- =========================
       How to use (超初心者向け)
       ========================= -->
  <div class="card">
    <div class="card-h">
      <h2>使い方（これだけ）</h2>
      <div class="hint">迷ったら「開発おすすめ10銘柄」のまま実行</div>
    </div>
    <div class="card-b">
      <div class="howto">
        <div class="t">3ステップ</div>
        <ol>
          <li>期間（20 / 60 / 120）を選ぶ</li>
          <li>実行モードを選ぶ（最初は「開発おすすめ10銘柄」でOK）</li>
          <li><b>▶ バックテスト開始</b>を押す</li>
        </ol>
      </div>
    </div>
  </div>

  <!-- =========================
       Run Form
       ========================= -->
  <div class="card">
    <div class="card-h">
      <h2>バックテスト実行</h2>
      <div class="hint">ボタンを押すだけで実行できます</div>
    </div>
    <div class="card-b">
      <form method="post" action="">
        {% csrf_token %}

        <div class="grid">
          <!-- left -->
          <div>
            <div class="row">
              <div class="field">
                <label>期間（過去営業日）</label>
                <select name="n">
                  {% with v=form_n|default:20 %}
                    <option value="20"  {% if v|add:0 == 20 %}selected{% endif %}>20</option>
                    <option value="60"  {% if v|add:0 == 60 %}selected{% endif %}>60</option>
                    <option value="120" {% if v|add:0 == 120 %}selected{% endif %}>120</option>
                  {% endwith %}
                </select>
                <div class="note">※迷ったら 20 でOK（まずは動かす）</div>
              </div>

              <div class="field">
                <label>実行モード（mode）</label>
                <select name="mode">
                  {% with m=form_mode|default:"dev_default" %}
                    <option value="dev_default" {% if m == "dev_default" %}selected{% endif %}>開発おすすめ10銘柄（入力不要）</option>
                    <option value="manual"      {% if m == "manual" %}selected{% endif %}>手動：自分で銘柄を指定</option>
                    <option value="auto"        {% if m == "auto" %}selected{% endif %}>自動：候補から選ぶ（将来拡張）</option>
                  {% endwith %}
                </select>
                <div class="note">
                  {% with m=form_mode|default:"dev_default" %}
                    {{ help_mode_text.m|default:"" }}
                  {% endwith %}
                </div>
              </div>
            </div>

            <div class="field" style="margin-top:12px;">
              <label>銘柄コード（4桁）を入力（手動モードのときだけ使う）</label>
              <textarea name="tickers" placeholder="例：7203 6758 9984（空白区切り / カンマ区切りOK）">{{ form_tickers|default:"" }}</textarea>
              <div class="note">
                ※ 開発中は「開発おすすめ10銘柄」を使えば毎回すぐ回せます。<br>
                ※ 本番では朝バッチで候補を作って、ここは“読むだけ”にする予定です。
              </div>
            </div>

            <div class="row3" style="margin-top:12px;">
              <div class="field">
                <label>選ぶ銘柄数（上位N）</label>
                <input type="number" name="top" value="{{ form_top|default:40 }}" min="1" max="200">
                <div class="note">※自動モードで使う設定</div>
              </div>
              <div class="field">
                <label>候補を調べる数（上限）</label>
                <input type="number" name="scan_limit" value="{{ form_scan_limit|default:2000 }}" min="0" max="999999">
                <div class="note">※自動モードで使う設定（0=無制限）</div>
              </div>
              <div class="field">
                <label>事前に絞る数（候補プール）</label>
                <input type="number" name="pre_rank_pool" value="{{ form_pre_rank_pool|default:400 }}" min="10" max="5000">
                <div class="note">※StockMasterがある時の高速化用</div>
              </div>
            </div>

            <div class="btns">
              <button class="btn primary" type="submit">
                ▶ バックテスト開始
              </button>
              <a class="btn ghost" href="">
                ↻ 入力をリセット
              </a>
            </div>

            <div class="note">
              目的：<b>実行ボタンを押したらバックテストが走って、結果が日本語で分かる</b>こと。<br>
              いまはUI優先で固めて、次に「scriptを叩く方式」にも繋げられます。
            </div>
          </div>

          <!-- right -->
          <div>
            <div class="kpis">
              <div class="kpi">
                <div class="k">合計損益（円）</div>
                <div class="v {% if kpi_total_pnl|default:0 < 0 %}neg{% elif kpi_total_pnl|default:0 > 0 %}pos{% endif %}">
                  {{ kpi_total_pnl|default:"-"|intcomma }}
                </div>
                <div class="s">プラス=勝ち / マイナス=負け</div>
              </div>
              <div class="kpi">
                <div class="k">取引回数（合計）</div>
                <div class="v">{{ kpi_trades|default:"-" }}</div>
                <div class="s">回数が多いほど統計が安定</div>
              </div>
              <div class="kpi">
                <div class="k">勝率（勝ち割合）</div>
                <div class="v">{{ kpi_winrate|default:"-" }}</div>
                <div class="s">勝ち回数 ÷ 取引回数</div>
              </div>
              <div class="kpi">
                <div class="k">平均R（リスク基準）</div>
                <div class="v">{{ kpi_avg_r|default:"-" }}</div>
                <div class="s">R=損益 ÷ 許容損失</div>
              </div>
              <div class="kpi">
                <div class="k">最大DD（最悪の落ち込み）</div>
                <div class="v {% if kpi_max_dd|default:0 < 0 %}neg{% endif %}">
                  {{ kpi_max_dd|default:"-"|intcomma }}
                </div>
                <div class="s">大きいほど荒い</div>
              </div>
            </div>

            <div style="margin-top:12px;">
              <div class="field">
                <label>今回回した銘柄</label>
                <div class="chips">
                  {% if selected_tickers %}
                    {% for t in selected_tickers %}
                      <span class="chip">{{ t }}</span>
                    {% endfor %}
                  {% else %}
                    <span class="chip muted">（まだ未実行）</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <div style="margin-top:12px;">
              <div class="field">
                <label>ポリシーID（ルール名）</label>
                <input type="text" value="{{ policy_id|default:"-" }}" readonly>
              </div>
              <div class="field" style="margin-top:10px;">
                <label>1回の許容損失（円）</label>
                <input type="text" value="{{ budget_trade_loss_yen|default:"-" }}" readonly>
                <div class="note">※平均Rなどの計算基準に使います</div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- =========================
       Result Table (per ticker)
       ========================= -->
  <div class="card">
    <div class="card-h">
      <h2>銘柄ごとの結果</h2>
      <div class="hint">どの銘柄が良い/悪いかが一発で分かる</div>
    </div>
    <div class="card-b">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>銘柄</th>
              <th class="num">データがあった日数</th>
              <th class="num">取引した日数</th>
              <th class="num">取引回数</th>
              <th class="num">損益（円）</th>
              <th class="num">勝率</th>
              <th class="num">平均R</th>
              <th class="num">最大DD（円）</th>
            </tr>
          </thead>
          <tbody>
            {% if rows %}
              {% for r in rows %}
                <tr>
                  <td><b>{{ r.ticker }}</b></td>
                  <td class="num muted">{{ r.used_days }}</td>
                  <td class="num muted">{{ r.traded_days }}</td>
                  <td class="num">{{ r.trades }}</td>
                  <td class="num {% if r.pnl < 0 %}neg{% elif r.pnl > 0 %}pos{% endif %}">{{ r.pnl|intcomma }}</td>
                  <td class="num">{{ r.winrate }}</td>
                  <td class="num {% if r._avg_r_num < 0 %}neg{% elif r._avg_r_num > 0 %}pos{% endif %}">{{ r.avg_r }}</td>
                  <td class="num {% if r.max_dd_yen < 0 %}neg{% endif %}">{{ r.max_dd_yen|intcomma }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="8" class="muted">（まだ未実行）</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="note" style="margin-top:10px;">
        <b>見る場所：</b>まず「損益（円）」→次に「勝率」→最後に「最大DD」で荒さを見る。
      </div>
    </div>
  </div>

  <!-- =========================
       Exit Reason Breakdown
       ========================= -->
  <div class="card">
    <div class="card-h">
      <h2>取引が終わった理由（内訳）</h2>
      <div class="hint">戦略が「何で終わってるか」を見る</div>
    </div>
    <div class="card-b">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>終了理由</th>
              <th class="num">取引回数</th>
              <th class="num">勝ち回数</th>
              <th class="num">勝率</th>
              <th class="num">損益（円）</th>
              <th class="num">平均R</th>
              <th class="num">平均保有（分）</th>
              <th class="num">平均MFE（伸び）</th>
              <th class="num">平均MAE（逆行）</th>
            </tr>
          </thead>
          <tbody>
            {% if exit_rows %}
              {% for e in exit_rows %}
                <tr>
                  <td><b>{{ e.exit_reason_label }}</b><span class="muted">（{{ e.exit_reason }}）</span></td>
                  <td class="num">{{ e.trades }}</td>
                  <td class="num">{{ e.wins }}</td>
                  <td class="num">{{ e.winrate }}</td>
                  <td class="num {% if e.pnl < 0 %}neg{% elif e.pnl > 0 %}pos{% endif %}">{{ e.pnl|intcomma }}</td>
                  <td class="num {% if e.avg_r < 0 %}neg{% elif e.avg_r > 0 %}pos{% endif %}">{{ e.avg_r }}</td>
                  <td class="num muted">{{ e.avg_hold_min }}</td>
                  <td class="num muted">{{ e.avg_mfe_r }}</td>
                  <td class="num muted">{{ e.avg_mae_r }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="9" class="muted">（まだ未実行）</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="note" style="margin-top:10px;">
        <b>MFE/MAE：</b>その取引が「最大どれだけ伸びたか / どれだけ逆行したか」を、R（許容損失）基準で見ます。
      </div>
    </div>
  </div>

  <!-- =========================
       Logs
       ========================= -->
  <div class="card">
    <div class="card-h">
      <h2>実行ログ（何が起きたか）</h2>
      <div class="hint">困ったときの調査用（表示は日本語優先）</div>
    </div>
    <div class="card-b">
      <div class="logbox">{{ run_log|default:"（ここに実行ログが出ます）" }}</div>
    </div>
  </div>

</div>
{% endblock %}