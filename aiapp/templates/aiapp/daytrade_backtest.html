{% extends "base.html" %}
{% load static humanize %}

{% block title %}デイトレ・バックテスト{% endblock %}

{% block content %}
<style>
  :root{
    --panel-bg: rgba(255,255,255,.05);
    --panel-bd: rgba(255,255,255,.10);
    --muted: rgba(255,255,255,.70);
    --muted2: rgba(255,255,255,.55);
    --ok: rgba(70, 220, 140, .18);
    --ng: rgba(255, 90, 90, .18);
    --chip: rgba(255,255,255,.08);
  }

  .dt-wrap{
    max-width: 980px;
    margin: 12px auto 0;
    padding: 12px 10px 140px;
  }

  .dt-title{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin: 4px 2px 12px;
  }
  .dt-title h1{
    font-size: 18px;
    margin:0;
    letter-spacing:.2px;
  }
  .dt-title .sub{
    font-size:12px;
    color: var(--muted2);
    white-space:nowrap;
  }

  .card{
    background: var(--panel-bg);
    border: 1px solid var(--panel-bd);
    border-radius: 16px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    overflow:hidden;
  }
  .card + .card{ margin-top: 14px; }

  .card-h{
    padding: 12px 12px 10px;
    border-bottom: 1px solid rgba(255,255,255,.06);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .card-h h2{
    font-size: 14px;
    margin: 0;
    color: rgba(255,255,255,.92);
  }
  .card-h .hint{
    font-size: 12px;
    color: var(--muted2);
  }
  .card-b{
    padding: 12px;
  }

  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap: 12px;
  }
  @media (min-width: 760px){
    .grid{
      grid-template-columns: 1.1fr .9fr;
      align-items:start;
    }
  }

  .field{
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .field label{
    font-size: 12px;
    color: var(--muted);
  }
  .field input[type="text"],
  .field input[type="number"],
  .field select,
  .field textarea{
    width:100%;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.18);
    color: rgba(255,255,255,.92);
    outline:none;
  }
  .field textarea{
    min-height: 90px;
    resize: vertical;
    line-height: 1.35;
  }

  .row{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top: 6px;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: var(--chip);
    color: rgba(255,255,255,.86);
    font-size: 12px;
    text-decoration:none;
    user-select:none;
  }

  .btns{
    display:flex;
    gap:10px;
    margin-top: 10px;
    flex-wrap:wrap;
  }
  .btn{
    appearance:none;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.08);
    color: rgba(255,255,255,.92);
    padding: 10px 12px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 800;
    cursor:pointer;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
  }
  .btn:active{ transform: translateY(1px); }
  .btn.primary{
    border-color: rgba(120,180,255,.35);
    background: rgba(120,180,255,.16);
  }
  .btn.ghost{
    background: rgba(255,255,255,.05);
  }

  .note{
    font-size: 12px;
    color: var(--muted2);
    line-height: 1.45;
    margin-top: 8px;
  }

  .kpis{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  @media (min-width: 760px){
    .kpis{ grid-template-columns: repeat(5, 1fr); }
  }
  .kpi{
    padding: 10px 10px 9px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.12);
  }
  .kpi .k{
    font-size: 11px;
    color: var(--muted2);
    margin-bottom: 6px;
  }
  .kpi .v{
    font-size: 15px;
    font-weight: 900;
    letter-spacing:.2px;
  }

  .table-wrap{
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
  }
  table{
    width:100%;
    border-collapse: collapse;
    min-width: 760px;
    background: rgba(0,0,0,.10);
  }
  th, td{
    padding: 10px 10px;
    border-bottom: 1px solid rgba(255,255,255,.06);
    text-align:left;
    font-size: 13px;
    white-space: nowrap;
    vertical-align: top;
  }
  th{
    font-size: 12px;
    color: var(--muted);
    background: rgba(255,255,255,.04);
    position: sticky;
    top: 0;
    z-index: 1;
  }
  tr:last-child td{ border-bottom:none; }

  .num{ text-align:right; font-variant-numeric: tabular-nums; }
  .pos{ background: var(--ok); }
  .neg{ background: var(--ng); }
  .muted{ color: var(--muted2); }

  .logbox{
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.20);
    border-radius: 14px;
    padding: 10px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 12px;
    line-height: 1.45;
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 260px;
    overflow:auto;
  }

  details{
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.10);
    overflow:hidden;
  }
  summary{
    cursor:pointer;
    padding: 10px 12px;
    font-weight: 900;
    font-size: 13px;
    color: rgba(255,255,255,.90);
    list-style:none;
  }
  summary::-webkit-details-marker{ display:none; }
  .details-b{
    padding: 12px;
    border-top: 1px solid rgba(255,255,255,.06);
  }

  .badge{
    display:inline-flex;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    font-size: 12px;
    font-weight: 900;
  }

  .badge.ok{
    border-color: rgba(70,220,140,.35);
    background: rgba(70,220,140,.16);
  }
  .badge.ng{
    border-color: rgba(255,90,90,.35);
    background: rgba(255,90,90,.16);
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    font-size: 12px;
    font-weight: 900;
  }
  .pill.ok{ border-color: rgba(70,220,140,.35); background: rgba(70,220,140,.12); }
  .pill.ng{ border-color: rgba(255,90,90,.35); background: rgba(255,90,90,.12); }
</style>

<div class="dt-wrap">

  <div class="dt-title">
    <h1>デイトレ・バックテスト</h1>
    <div class="sub">ボタン押すだけで回す</div>
  </div>

  <!-- =========================
       かんたん実行
       ========================= -->
  <div class="card">
    <div class="card-h">
      <h2>かんたん実行（ここだけ触ればOK）</h2>
      <div class="hint">初心者向け：まずは開発おすすめで回す</div>
    </div>
    <div class="card-b">
      <form method="post" action="">
        {% csrf_token %}

        <div class="grid">
          <!-- left -->
          <div>
            <div class="row">
              <div class="field">
                <label>過去日数（N：過去営業日）</label>
                <select name="n">
                  {% with v=form_n|default:20 %}
                    <option value="20"  {% if v|add:0 == 20 %}selected{% endif %}>20</option>
                    <option value="60"  {% if v|add:0 == 60 %}selected{% endif %}>60</option>
                    <option value="120" {% if v|add:0 == 120 %}selected{% endif %}>120</option>
                  {% endwith %}
                </select>
                <div class="note">※ 迷ったら「20」でOK</div>
              </div>

              <div class="field">
                <label>実行対象</label>
                <select name="mode" id="modeSel">
                  {% with m=form_mode|default:"dev_default" %}
                    <option value="dev_default" {% if m == "dev_default" %}selected{% endif %}>開発おすすめ10銘柄（固定）</option>
                    <option value="manual"      {% if m == "manual" %}selected{% endif %}>自分で銘柄を指定</option>
                    <option value="auto"        {% if m == "auto" %}selected{% endif %}>自動で選ぶ（準備中）</option>
                  {% endwith %}
                </select>
                <div class="note">※ まずは「開発おすすめ10銘柄」を推奨</div>
              </div>
            </div>

            <div class="field" id="tickersBox" style="margin-top:12px; display:none;">
              <label>銘柄コード（例：7203 6758 9984）</label>
              <textarea name="tickers" placeholder="7203 6758 9984">{{ form_tickers|default:"" }}</textarea>
              <div class="note">空白/カンマ区切りOK。迷ったら空のままでも動く（おすすめに戻る）。</div>
            </div>

            <div class="field" style="margin-top:12px;">
              <label>Judge の基準（しきい値）</label>
              <select name="judge_mode">
                {% with jm=form_judge_mode|default:"dev" %}
                  <option value="dev"  {% if jm == "dev" %}selected{% endif %}>開発用（ゆるめ）</option>
                  <option value="prod" {% if jm == "prod" %}selected{% endif %}>本番用（厳しめ）</option>
                {% endwith %}
              </select>
              <div class="note">開発は「回るか/壊れてないか」を優先。本番は「事故らないか」を優先。</div>
            </div>

            <div class="btns">
              <button class="btn primary" type="submit">
                ▶ バックテスト実行
              </button>
              <a class="btn ghost" href="">
                ↻ 画面リセット
              </a>
            </div>

            <div class="note">
              目的：<b>「この戦略がデイトレで勝ちやすいか」</b>を、複数銘柄でざっくり確認する。<br>
              下の結果がプラスに寄ってくれば、次に銘柄選定や条件を詰める。
            </div>
          </div>

          <!-- right -->
          <div>
            <div class="kpis">
              <div class="kpi">
                <div class="k">合計損益（円）</div>
                <div class="v {% if kpi_total_pnl|default:0 < 0 %}neg{% elif kpi_total_pnl|default:0 > 0 %}pos{% endif %}">
                  {{ kpi_total_pnl|default:"-"|intcomma }}
                </div>
                <div class="note">プラス＝勝ち越し（採用後の結果）</div>
              </div>
              <div class="kpi">
                <div class="k">取引回数</div>
                <div class="v">{{ kpi_trades|default:"-" }}</div>
                <div class="note">多すぎ/少なすぎも癖</div>
              </div>
              <div class="kpi">
                <div class="k">勝率</div>
                <div class="v">{{ kpi_winrate|default:"-" }}</div>
                <div class="note">勝ち回数÷取引回数</div>
              </div>
              <div class="kpi">
                <div class="k">平均R</div>
                <div class="v {% if kpi_avg_r|default:0 < 0 %}neg{% elif kpi_avg_r|default:0 > 0 %}pos{% endif %}">
                  {{ kpi_avg_r|default:"-" }}
                </div>
                <div class="note">1回あたりの期待値</div>
              </div>
              <div class="kpi">
                <div class="k">最大DD（円）</div>
                <div class="v {% if kpi_max_dd|default:0 < 0 %}neg{% endif %}">
                  {{ kpi_max_dd|default:"-"|intcomma }}
                </div>
                <div class="note">一番キツい凹み</div>
              </div>
            </div>

            <div style="margin-top:12px;">
              <div class="field">
                <label>今回の銘柄</label>
                <div class="chips">
                  {% if selected_tickers %}
                    {% for t in selected_tickers %}
                      <span class="chip">{{ t }}</span>
                    {% endfor %}
                  {% else %}
                    <span class="chip muted">（まだ未実行）</span>
                  {% endif %}
                </div>
              </div>
            </div>

            <div style="margin-top:12px;">
              <div class="field">
                <label>使ったポリシーID</label>
                <input type="text" value="{{ policy_id|default:"-" }}" readonly>
              </div>
              <div class="field" style="margin-top:10px;">
                <label>1回の許容損（円）</label>
                <input type="text" value="{{ budget_trade_loss_yen|default:"-" }}" readonly>
                <div class="note">この金額を「1R」として平均Rを計算してる</div>
              </div>
            </div>

          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- =========================
       Judge / AutoFix
       ========================= -->
  <div class="card">
    <div class="card-h">
      <h2>判定（Judge）＋ 改善提案（自動）</h2>
      <div class="hint">本番で“俺がいなくても回る”ための仕組み</div>
    </div>
    <div class="card-b">

      {% if not judge_enabled %}
        <div class="note">Judge が無効です。</div>
      {% else %}

        {% if base_judge %}
          <div class="note">
            <span class="badge {% if base_judge.decision == 'GO' %}ok{% else %}ng{% endif %}">
              元の判定：{{ base_judge.decision }}{% if base_judge.mode %}（{{ base_judge.mode }}）{% endif %}
            </span>
            {% if applied_judge %}
              &nbsp;→&nbsp;
              <span class="badge {% if applied_judge.decision == 'GO' %}ok{% else %}ng{% endif %}">
                採用後の判定：{{ applied_judge.decision }}{% if applied_judge.mode %}（{{ applied_judge.mode }}）{% endif %}
              </span>
            {% endif %}
          </div>

          {% if base_judge.reasons %}
            <div class="note" style="margin-top:10px;"><b>元のNO_GO理由</b></div>
            <div class="table-wrap" style="margin-top:6px;">
              <table style="min-width:680px;">
                <thead>
                  <tr>
                    <th>理由</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in base_judge.reasons %}
                    <tr><td>{{ r }}</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}

          {% if applied_judge and applied_judge.reasons %}
            <div class="note" style="margin-top:12px;"><b>採用後NO_GO理由（まだNGの場合）</b></div>
            <div class="table-wrap" style="margin-top:6px;">
              <table style="min-width:680px;">
                <thead>
                  <tr>
                    <th>理由</th>
                  </tr>
                </thead>
                <tbody>
                  {% for r in applied_judge.reasons %}
                    <tr><td>{{ r }}</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% endif %}

          <details style="margin-top:12px;">
            <summary>判定に使った数値（metrics）を見る</summary>
            <div class="details-b">
              <div class="table-wrap">
                <table style="min-width:760px;">
                  <thead>
                    <tr>
                      <th>項目</th>
                      <th class="num">元</th>
                      <th class="num">採用後</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>平均R</td>
                      <td class="num">{{ base_judge.metrics.avg_r }}</td>
                      <td class="num">{% if applied_judge %}{{ applied_judge.metrics.avg_r }}{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                      <td>最大DD率</td>
                      <td class="num">{{ base_judge.metrics.max_dd_pct }}</td>
                      <td class="num">{% if applied_judge %}{{ applied_judge.metrics.max_dd_pct }}{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                      <td>最大連敗数</td>
                      <td class="num">{{ base_judge.metrics.max_consecutive_losses }}</td>
                      <td class="num">{% if applied_judge %}{{ applied_judge.metrics.max_consecutive_losses }}{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                      <td>日次損失上限ヒット率</td>
                      <td class="num">{{ base_judge.metrics.daylimit_days_pct }}</td>
                      <td class="num">{% if applied_judge %}{{ applied_judge.metrics.daylimit_days_pct }}{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                      <td>日数</td>
                      <td class="num">{{ base_judge.metrics.total_days }}</td>
                      <td class="num">{% if applied_judge %}{{ applied_judge.metrics.total_days }}{% else %}-{% endif %}</td>
                    </tr>
                    <tr>
                      <td>取引回数</td>
                      <td class="num">{{ base_judge.metrics.total_trades }}</td>
                      <td class="num">{% if applied_judge %}{{ applied_judge.metrics.total_trades }}{% else %}-{% endif %}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              {% if base_judge.metrics.thresholds %}
                <div class="note" style="margin-top:10px;">
                  しきい値：
                  max_dd_pct={{ base_judge.metrics.thresholds.max_dd_pct }},
                  max_consecutive_losses={{ base_judge.metrics.thresholds.max_consecutive_losses }},
                  max_daylimit_days_pct={{ base_judge.metrics.thresholds.max_daylimit_days_pct }},
                  min_avg_r={{ base_judge.metrics.thresholds.min_avg_r }}
                </div>
              {% endif %}
            </div>
          </details>

          {% if autofix_enabled %}
            <div class="note" style="margin-top:12px;">
              <b>auto_fix：</b>
              {% if fix_summary %}
                {% if fix_summary.used %}
                  ベスト案「{{ fix_summary.best_name }}」を採用（試した候補：{{ fix_summary.candidates_count }}件）
                {% else %}
                  今回は auto_fix の採用は無し（そのまま）
                {% endif %}
              {% else %}
                未実行
              {% endif %}
            </div>

            {% if fix_summary and fix_summary.used and fix_summary.diffs %}
              <div style="margin-top:10px;" class="table-wrap">
                <table style="min-width:680px;">
                  <thead>
                    <tr>
                      <th>変更ポイント</th>
                      <th class="num">変更前</th>
                      <th class="num">変更後</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for d in fix_summary.diffs %}
                      <tr>
                        <td><b>{{ d.label }}</b><div class="note">{{ d.path }}</div></td>
                        <td class="num muted">{{ d.before }}</td>
                        <td class="num">{{ d.after }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              <div class="note" style="margin-top:10px;">
                ここに出るのが「本番で自動的にいじる候補」。初心者は触らなくてOK（採用するかだけ判断）。
              </div>
            {% endif %}

            <!-- ★ 追加：候補一覧（candidates）テーブル -->
            <details style="margin-top:12px;">
              <summary>auto_fix の候補一覧（candidates）を見る</summary>
              <div class="details-b">

                {% if candidates_rows %}
                  <div class="note" style="margin-bottom:8px;">
                    目的：<b>「どの修正がどれだけ効いたか」</b>を見える化。ベストは最上段に★が付く。
                  </div>

                  <div class="table-wrap">
                    <table style="min-width:960px;">
                      <thead>
                        <tr>
                          <th>候補</th>
                          <th>判定</th>
                          <th class="num">avg_r</th>
                          <th class="num">max_dd_pct</th>
                          <th class="num">max_consecutive_losses</th>
                          <th class="num">daylimit_days_pct</th>
                          <th>NO_GO理由（要約）</th>
                          <th>変更点（diff）</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for c in candidates_rows %}
                          <tr>
                            <td>
                              <b>{{ c.name }}</b>
                              {% if c.is_best %}
                                &nbsp;<span class="pill ok">★ BEST</span>
                              {% endif %}
                              <div class="note">#{{ c.index }} / mode={{ c.judge_mode }}</div>
                            </td>

                            <td>
                              {% if c.decision == "GO" %}
                                <span class="pill ok">GO</span>
                              {% else %}
                                <span class="pill ng">NO_GO</span>
                              {% endif %}
                            </td>

                            <td class="num">{{ c.metrics.avg_r }}</td>
                            <td class="num">{{ c.metrics.max_dd_pct }}</td>
                            <td class="num">{{ c.metrics.max_consecutive_losses }}</td>
                            <td class="num">{{ c.metrics.daylimit_days_pct }}</td>

                            <td style="white-space:normal;">
                              {% if c.reasons %}
                                {% for r in c.reasons %}
                                  <div class="note">- {{ r }}</div>
                                {% endfor %}
                              {% else %}
                                <span class="muted">（なし）</span>
                              {% endif %}
                            </td>

                            <td style="white-space:normal;">
                              {% if c.diffs %}
                                {% for d in c.diffs %}
                                  <div class="note">
                                    • <b>{{ d.path }}</b>: {{ d.before }} → {{ d.after }}
                                  </div>
                                {% endfor %}
                              {% else %}
                                <span class="muted">（変更なし）</span>
                              {% endif %}
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>

                  {% if best_candidate %}
                    <div class="note" style="margin-top:10px;">
                      ベスト：<b>{{ best_candidate.name }}</b>（decision={{ best_candidate.decision }}）
                    </div>
                  {% endif %}

                {% else %}
                  <div class="note">候補一覧はまだありません（GOだった / auto_fix未実行 / 失敗 のいずれか）。</div>
                {% endif %}
              </div>
            </details>

          {% else %}
            <div class="note" style="margin-top:12px;">
              auto_fix は未接続（または import できない）ため、Judge のみ表示しています。
            </div>
          {% endif %}

          {% if base_kpi %}
            <details style="margin-top:12px;">
              <summary>元のKPI（参考）を見る</summary>
              <div class="details-b">
                <div class="table-wrap">
                  <table style="min-width:760px;">
                    <thead>
                      <tr>
                        <th>項目</th>
                        <th class="num">値</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td>合計損益（円）</td><td class="num">{{ base_kpi.total_pnl|intcomma }}</td></tr>
                      <tr><td>取引回数</td><td class="num">{{ base_kpi.trades }}</td></tr>
                      <tr><td>勝率</td><td class="num">{{ base_kpi.winrate }}</td></tr>
                      <tr><td>平均R</td><td class="num">{{ base_kpi.avg_r }}</td></tr>
                      <tr><td>最大DD（円）</td><td class="num">{{ base_kpi.max_dd_yen|intcomma }}</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </details>
          {% endif %}

        {% else %}
          <div class="note">未実行。まず上でバックテストを回すと、ここに判定が出ます。</div>
        {% endif %}

      {% endif %}
    </div>
  </div>

  <!-- =========================
       ログ
       ========================= -->
  <div class="card">
    <div class="card-h">
      <h2>実行ログ（詳細）</h2>
      <div class="hint">困った時だけ見る</div>
    </div>
    <div class="card-b">
      <details>
        <summary>ログを開く</summary>
        <div class="details-b">
          <div class="logbox">{{ run_log|default:"（ここにログが出る）" }}</div>
        </div>
      </details>
    </div>
  </div>

  <!-- =========================
       結果（銘柄別）
       ========================= -->
  <div class="card">
    <div class="card-h">
      <h2>結果（銘柄別）</h2>
      <div class="hint">どの銘柄が良い/悪いか</div>
    </div>
    <div class="card-b">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>銘柄</th>
              <th class="num">データ日数</th>
              <th class="num">取引した日数</th>
              <th class="num">取引回数</th>
              <th class="num">損益（円）</th>
              <th class="num">勝率</th>
              <th class="num">平均R</th>
              <th class="num">最大DD（円）</th>
            </tr>
          </thead>
          <tbody>
            {% if rows %}
              {% for r in rows %}
                <tr>
                  <td><b>{{ r.ticker }}</b></td>
                  <td class="num muted">{{ r.used_days }}</td>
                  <td class="num muted">{{ r.traded_days }}</td>
                  <td class="num">{{ r.trades }}</td>
                  <td class="num {% if r.pnl < 0 %}neg{% elif r.pnl > 0 %}pos{% endif %}">{{ r.pnl|intcomma }}</td>
                  <td class="num">{{ r.winrate }}</td>
                  <td class="num {% if r.avg_r_num < 0 %}neg{% elif r.avg_r_num > 0 %}pos{% endif %}">{{ r.avg_r }}</td>
                  <td class="num {% if r.max_dd_yen < 0 %}neg{% endif %}">{{ r.max_dd_yen|intcomma }}</td>
                </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="8" class="muted">（まだ未実行）</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <div class="note" style="margin-top:10px;">
        見方：損益がプラスで、平均Rもプラスに寄っていて、最大DDが浅いほど良い。
      </div>
    </div>
  </div>

  <!-- =========================
       売買終了理由（内訳）
       ========================= -->
  <div class="card">
    <div class="card-h">
      <h2>売買終了理由の内訳</h2>
      <div class="hint">戦略の“負け方/勝ち方”の癖が見える</div>
    </div>
    <div class="card-b">
      <details>
        <summary>内訳を開く</summary>
        <div class="details-b">
          <div class="table-wrap">
            <table style="min-width:820px;">
              <thead>
                <tr>
                  <th>終了理由</th>
                  <th class="num">取引回数</th>
                  <th class="num">勝ち回数</th>
                  <th class="num">勝率</th>
                  <th class="num">損益（円）</th>
                  <th class="num">平均R</th>
                  <th class="num">平均保有（分）</th>
                  <th class="num">平均MFE（R）</th>
                  <th class="num">平均MAE（R）</th>
                </tr>
              </thead>
              <tbody>
                {% if exit_rows %}
                  {% for e in exit_rows %}
                    <tr>
                      <td>
                        <b>{{ e.exit_reason_label }}</b>
                        <div class="note">{{ e.exit_reason }}</div>
                      </td>
                      <td class="num">{{ e.trades }}</td>
                      <td class="num">{{ e.wins }}</td>
                      <td class="num">{{ e.winrate }}</td>
                      <td class="num {% if e.pnl < 0 %}neg{% elif e.pnl > 0 %}pos{% endif %}">{{ e.pnl|intcomma }}</td>
                      <td class="num {% if e.avg_r_num < 0 %}neg{% elif e.avg_r_num > 0 %}pos{% endif %}">{{ e.avg_r }}</td>
                      <td class="num muted">{{ e.avg_hold_min }}</td>
                      <td class="num muted">{{ e.avg_mfe_r }}</td>
                      <td class="num muted">{{ e.avg_mae_r }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="9" class="muted">（まだ未実行）</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

          <div class="note" style="margin-top:10px;">
            用語：MFE＝一番伸びた最大含み益、MAE＝一番沈んだ最大含み損（どちらもR換算）。
          </div>
        </div>
      </details>
    </div>
  </div>

</div>

<script>
(function(){
  const sel = document.getElementById("modeSel");
  const box = document.getElementById("tickersBox");
  function sync(){
    const v = (sel && sel.value) ? sel.value : "dev_default";
    if (!box) return;
    box.style.display = (v === "manual") ? "block" : "none";
  }
  if (sel){
    sel.addEventListener("change", sync);
    sync();
  }
})();
</script>
{% endblock %}