{% extends "base.html" %}
{% load humanize %}
{% block title %}AI Picks 診断{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#020617;
    --card:rgba(15,23,42,.9);
    --fg:#e5edff;
    --sub:#9ca3af;
    --accent:#2563eb;
    --line:rgba(148,163,184,.35);
    --ok:#22c55e;
    --bad:#ef4444;
  }
  body{background:var(--bg);color:var(--fg);}
  body.modal-open{overflow:hidden;}

  .wrap{max-width:960px;margin:0 auto;padding:16px 10px 80px;}

  .head-card{
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px 14px;
    background:radial-gradient(circle at top left,rgba(37,99,235,.25),transparent 55%),
               rgba(15,23,42,.9);
    backdrop-filter:blur(10px);
    margin-bottom:12px;
  }
  .head-top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-bottom:6px;
  }
  .title{
    font-size:18px;
    font-weight:700;
  }
  .badge{
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.9);
    white-space:nowrap;
  }
  .meta{
    font-size:12px;
    color:var(--sub);
    line-height:1.5;
  }
  .meta span+span::before{
    content:" / ";
    margin:0 2px;
  }

  .filter-row{
    display:flex;
    gap:8px;
    margin:8px 0 12px;
  }
  .filter-input{
    flex:1;
    padding:10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(15,23,42,.9);
    color:var(--fg);
    font-size:14px;
  }
  .filter-input::placeholder{color:#64748b;}
  .pill{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    color:var(--sub);
    background:rgba(15,23,42,.9);
    white-space:nowrap;
  }

  .table-wrap{
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(15,23,42,.9);
    overflow:hidden;
  }
  .table-scroller{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  table{
    width:100%;
    min-width:420px;
    border-collapse:collapse;
    font-size:12px;
  }
  thead{
    background:rgba(15,23,42,1);
    position:sticky;
    top:0;
    z-index:1;
  }
  th,td{
    padding:8px 10px;
    border-bottom:1px solid rgba(30,41,59,.9);
    text-align:left;
    white-space:nowrap;
  }
  th{
    font-size:11px;
    color:#9ca3af;
    background:rgba(15,23,42,0.98);
    backdrop-filter:blur(10px);
  }
  tbody tr:nth-child(odd){
    background:rgba(15,23,42,0.9);
  }
  tbody tr:nth-child(even){
    background:rgba(15,23,42,0.96);
  }
  tbody tr:hover{
    background:rgba(30,64,175,.7);
  }
  .code{font-feature-settings:"tnum";font-weight:600;}
  .sector{color:var(--sub);font-size:11px;}
  .score{font-weight:700;text-align:right;}
  .score-high{color:#bfdbfe;}
  .score-mid{color:#a3e635;}
  .score-low{color:#f97316;}

  .foot-note{
    margin-top:8px;
    font-size:11px;
    color:var(--sub);
    line-height:1.5;
  }

  /* ===== モーダル ===== */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.7);
    display:none;
    align-items:center;            /* 画面の上下に余白をとって中央寄せ */
    justify-content:center;
    z-index:999;
  }
  .modal-backdrop.open{
    display:flex;
  }
  .modal-card{
    width:100%;
    max-width:720px;
    background:var(--card);
    border-radius:18px;
    box-shadow:0 18px 45px rgba(0,0,0,.7);
    padding:18px 16px 24px;
    padding-bottom:calc(24px + env(safe-area-inset-bottom, 0px));
    padding-top:calc(20px + env(safe-area-inset-top, 0px));
    max-height:calc(100vh - 48px); /* 上下 24px ずつ余白 */
    overflow-y:auto;
    overscroll-behavior:contain;
  }
  .modal-close{
    position:absolute;
    top:16px;
    right:18px;
    border:none;
    background:transparent;
    color:var(--sub);
    font-size:20px;
  }
  .modal-header{
    margin-bottom:12px;
  }
  .modal-title{
    font-size:18px;
    font-weight:700;
    margin-right:32px;
  }
  .modal-sector{
    font-size:12px;
    color:var(--sub);
    margin-top:2px;
    margin-bottom:8px;
  }
  .modal-top-badges{
    display:flex;
    gap:8px;
    margin-top:4px;
  }
  .badge-pill{
    font-size:11px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(15,23,42,.9);
  }

  /* ===== メトリクスカード群（白枠部分のレイアウト） ===== */
  .metric-grid{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:4px;
    margin-bottom:8px;
  }
  .metric-card{
    flex:1 1 calc(50% - 6px);
    min-width:150px;
    background:rgba(15,23,42,0.96);
    border-radius:12px;
    padding:10px 12px;
    border:1px solid rgba(148,163,184,.3);
  }
  .metric-title{
    font-size:12px;
    color:var(--sub);
    margin-bottom:4px;
  }
  .metric-main{
    font-size:18px;
    font-weight:600;
    text-align:left;
    font-variant-numeric:tabular-nums;
  }
  .metric-main-right{
    text-align:right;
  }
  .metric-sub{
    margin-top:4px;
    font-size:11px;
    color:var(--sub);
    display:flex;
    justify-content:space-between;
  }

  .metric-row{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    font-size:13px;
    padding:1px 0;
  }
  .metric-label{
    color:var(--sub);
  }
  .metric-value{
    font-variant-numeric:tabular-nums;
  }
  .metric-row-total{
    margin-top:2px;
    font-weight:600;
  }
  .metric-note{
    margin-top:4px;
    font-size:11px;
    color:var(--sub);
    line-height:1.4;
  }

  /* 理由セクション */
  .detail-section{
    margin-top:12px;
  }
  .section-title{
    font-size:13px;
    font-weight:600;
    padding-top:8px;
    margin:0 0 6px;
    border-top:1px solid rgba(148,163,184,.25);
  }
  .reason-block{
    font-size:12px;
    line-height:1.5;
  }
  .reason-subtitle{
    font-weight:600;
    margin-top:4px;
    margin-bottom:2px;
  }
  .reason-list{
    margin:0;
    padding-left:16px;
  }
  .reason-concern{
    font-size:12px;
    color:var(--sub);
  }

  @media (max-width: 480px){
    .head-top{
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .badge{
      margin-left:auto;
      margin-top:4px;
      font-size:10px;
      padding:3px 7px;
      white-space:normal;
    }
    .filter-row{
      flex-direction:column;
      align-items:stretch;
    }
    .pill{
      align-self:flex-end;
      font-size:10px;
      padding:4px 8px;
      max-width:100%;
      white-space:normal;
      text-align:right;
    }
    .metric-card{
      flex:1 1 100%;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="head-card">
    <div class="head-top">
      <div>
        {% if updated_at_label %}
          <div class="title">最終更新: {{ updated_at_label }}</div>
        {% endif %}

        <!-- モード / ユニバース -->
        <div class="meta">
          <span>モード: {{ meta.style|default:"aggressive" }}/{{ meta.horizon|default:"short" }}</span>
          <span>ユニバース: {{ meta.universe|default:"(不明)" }}</span>
          <span>TopK: {{ meta.topk|default:0 }}</span>
        </div>

        <!-- 件数まわり（総件数 / 対象件数） -->
        <div class="meta">
          総件数（ユニバース内）: {{ master_total|default:0|intcomma }} 件
        </div>
        <div class="meta">
          対象件数（フィルタ後・評価対象）: {{ meta.total|default:0|intcomma }} 件
        </div>

        <!-- フィルタ削除件数（日本語ラベル） -->
        {% if filter_stats %}
          <div class="meta">
            削除された銘柄:
            {% for label, val in filter_stats.items %}
              {{ label }}＝{{ val|intcomma }} 件{% if not forloop.last %} ／{% endif %}
            {% endfor %}
          </div>
        {% endif %}

        {% if source_file %}
          <div class="meta">ソース: <code style="font-size:11px">{{ source_file }}</code></div>
        {% endif %}
      </div>
      <div class="badge">DEBUG / INTERNAL</div>
    </div>

    <div class="meta">
      ※ picks_build が出力した JSON（PickItem 相当）をそのまま一覧表示します。<br>
      ※ 並び順は score_100 降順 → 株価降順です。
    </div>
  </div>

  <div class="filter-row">
    <input
      id="filterInput"
      class="filter-input"
      type="search"
      placeholder="コード・銘柄名・業種でフィルタ（例: 7203 / トヨタ / 保険）">
    <div class="pill">score 0〜100 ／ 詳細はタップでモーダル表示</div>
  </div>

  <div class="table-wrap">
    <div class="table-scroller">
      <table id="picksTable">
        <thead>
          <tr>
            <th>コード</th>
            <th>銘柄名 / 業種</th>
            <th style="text-align:right;">Score</th>
          </tr>
        </thead>
        <tbody>
        {% for it in items %}
          <tr class="pick-row"
              data-code="{{ it.code }}"
              data-name="{{ it.name|default:'(銘柄名なし)' }}"
              data-sector="{{ it.sector_display|default:'業種不明' }}"
              data-score="{{ it.score_100|default:'' }}"
              data-stars="{{ it.stars|default:0 }}"
              data-last="{{ it.last_close|default:'' }}"
              data-atr="{{ it.atr|default:'' }}"
              data-entry="{{ it.entry|default:'' }}"
              data-tp="{{ it.tp|default:'' }}"
              data-sl="{{ it.sl|default:'' }}"
              data-qty-rakuten="{{ it.qty_rakuten|default:'' }}"
              data-pl-rakuten="{{ it.est_pl_rakuten|default:'' }}"
              data-loss-rakuten="{{ it.est_loss_rakuten|default:'' }}"
              data-reason-rakuten="{{ it.reason_rakuten|default:'' }}"
              data-qty-matsui="{{ it.qty_matsui|default:'' }}"
              data-pl-matsui="{{ it.est_pl_matsui|default:'' }}"
              data-loss-matsui="{{ it.est_loss_matsui|default:'' }}"
              data-reason-matsui="{{ it.reason_matsui|default:'' }}"
              data-reasons="{% if it.reason_lines %}{{ it.reason_lines|join:'||' }}{% else %}{% endif %}"
              data-concern="{{ it.reason_concern|default:'' }}"
          >
            <td class="code">{{ it.code }}</td>
            <td>
              <div>{{ it.name|default:"(銘柄名なし)" }}</div>
              <div class="sector">{{ it.sector_display|default:"業種不明" }}</div>
            </td>
            <td class="score
              {% if it.score_100 and it.score_100|floatformat:0 >= 80 %}score-high
              {% elif it.score_100 and it.score_100|floatformat:0 >= 60 %}score-mid
              {% else %}score-low{% endif %}">
              {% if it.score_100 is not None %}
                {{ it.score_100|floatformat:0 }}
              {% else %}–{% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="3" style="text-align:center;color:#9ca3af;padding:16px 8px;">
              items が空です。picks_build がまだ走っていないか、ファイル読み込みに失敗しています。
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="foot-note">
    ・行をタップすると、数量・想定PL・理由などの詳細がモーダルで表示されます。<br>
    ・score / ⭐ / 数量 / 想定PL が想定とズレていないか確認できます。
  </div>

</div>

<!-- ===== 詳細モーダル ===== -->
<div id="pickModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card">
    <button type="button" id="modalCloseBtn" class="modal-close">×</button>

    <div class="modal-header">
      <div class="modal-title" id="modalTitle">コード 銘柄名</div>
      <div class="modal-sector" id="modalSector">業種</div>
      <div class="modal-top-badges">
        <span class="badge-pill" id="modalScoreBadge">Score: –</span>
        <span class="badge-pill" id="modalStarBadge">★ –</span>
      </div>
    </div>

    <!-- ★ 白枠だったゾーン：カードレイアウトに変更 -->
    <div class="metric-grid">

      <!-- 現在値＋ATR -->
      <div class="metric-card">
        <div class="metric-title">現在値</div>
        <div class="metric-main" id="detailLast">–</div>
        <div class="metric-sub">
          <span>ATR</span>
          <span id="detailAtr">–</span>
        </div>
      </div>

      <!-- 数量カード（楽天・松井・合計） -->
      <div class="metric-card">
        <div class="metric-title">数量</div>
        <div class="metric-row">
          <span class="metric-label">楽天</span>
          <span class="metric-value" id="detailQtyRakuten">–</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">松井</span>
          <span class="metric-value" id="detailQtyMatsui">–</span>
        </div>
        <div class="metric-row metric-row-total">
          <span class="metric-label">合計</span>
          <span class="metric-value" id="detailQtyTotal">–</span>
        </div>
        <div class="metric-note" id="detailReasonRakuten"></div>
        <div class="metric-note" id="detailReasonMatsui"></div>
      </div>

      <!-- Entry / TP / SL -->
      <div class="metric-card">
        <div class="metric-title">Entry / TP / SL</div>
        <div class="metric-row">
          <span class="metric-label">Entry</span>
          <span class="metric-value" id="detailEntry">–</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">TP</span>
          <span class="metric-value" id="detailTp">–</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">SL</span>
          <span class="metric-value" id="detailSl">–</span>
        </div>
      </div>

      <!-- 想定利益カード -->
      <div class="metric-card">
        <div class="metric-title">想定利益</div>
        <div class="metric-row">
          <span class="metric-label">楽天</span>
          <span class="metric-value" id="detailPlRakuten">–</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">松井</span>
          <span class="metric-value" id="detailPlMatsui">–</span>
        </div>
        <div class="metric-row metric-row-total">
          <span class="metric-label">合計</span>
          <span class="metric-value" id="detailPlTotal">–</span>
        </div>
      </div>

      <!-- 想定損失カード -->
      <div class="metric-card">
        <div class="metric-title">想定損失</div>
        <div class="metric-row">
          <span class="metric-label">楽天</span>
          <span class="metric-value" id="detailLossRakuten">–</span>
        </div>
        <div class="metric-row">
          <span class="metric-label">松井</span>
          <span class="metric-value" id="detailLossMatsui">–</span>
        </div>
        <div class="metric-row metric-row-total">
          <span class="metric-label">合計</span>
          <span class="metric-value" id="detailLossTotal">–</span>
        </div>
      </div>

    </div>

    <!-- 理由セクション -->
    <div class="detail-section">
      <div class="section-title">理由</div>
      <div class="reason-block">
        <div class="reason-subtitle">選定理由</div>
        <ul id="detailReasons" class="reason-list"></ul>
        <div class="reason-subtitle">懸念点</div>
        <div id="detailConcern" class="reason-concern"></div>
      </div>
    </div>

  </div>
</div>

<script>
(function(){
  const input = document.getElementById("filterInput");
  const table = document.getElementById("picksTable");

  // フィルタ
  if (input && table){
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    input.addEventListener("input", function(){
      const q = this.value.trim().toLowerCase();
      if (!q){
        rows.forEach(r => r.style.display = "");
        return;
      }
      rows.forEach(r => {
        const text = r.textContent.toLowerCase();
        r.style.display = text.includes(q) ? "" : "none";
      });
    });
  }

  const body   = document.body;
  const modal  = document.getElementById("pickModal");
  const closeBtn = document.getElementById("modalCloseBtn");
  if (!modal || !table) return;

  function setText(id, v, fmt){
    const el = document.getElementById(id);
    if (!el) return;
    if (v === undefined || v === null || v === "" || v === "NaN"){
      el.textContent = "–";
      return;
    }
    let txt = v;
    if (fmt === "int"){
      const n = Number(v);
      txt = isNaN(n) ? "–" : n.toLocaleString();
    }else if (fmt === "yen"){
      const n = Number(v);
      if (isNaN(n)){
        txt = "–";
      }else{
        txt = n.toLocaleString();
        if (n > 0) txt = "+" + txt;
      }
    }
    el.textContent = txt;
  }

  function openModal(row){
    const ds = row.dataset || {};

    document.getElementById("modalTitle").textContent =
      (ds.code || "") + " " + (ds.name || "");
    document.getElementById("modalSector").textContent = ds.sector || "";

    document.getElementById("modalScoreBadge").textContent =
      "Score: " + (ds.score || "–");
    document.getElementById("modalStarBadge").textContent =
      "★ " + (ds.stars || "–");

    setText("detailScoreBadge", ds.score, "int"); // 使っていないが保険

    setText("detailLast", ds.last, "int");
    setText("detailAtr", ds.atr, "int");
    setText("detailEntry", ds.entry, "int");
    setText("detailTp", ds.tp, "int");
    setText("detailSl", ds.sl, "int");

    setText("detailQtyRakuten", ds.qtyRakuten, "int");
    setText("detailPlRakuten", ds.plRakuten, "yen");
    setText("detailLossRakuten", ds.lossRakuten, "yen");
    document.getElementById("detailReasonRakuten").textContent =
      ds.reasonRakuten || "";

    setText("detailQtyMatsui", ds.qtyMatsui, "int");
    setText("detailPlMatsui", ds.plMatsui, "yen");
    setText("detailLossMatsui", ds.lossMatsui, "yen");
    document.getElementById("detailReasonMatsui").textContent =
      ds.reasonMatsui || "";

    const qtyTotal =
      (Number(ds.qtyRakuten || 0) || 0) + (Number(ds.qtyMatsui || 0) || 0);
    const plTotal =
      (Number(ds.plRakuten || 0) || 0) + (Number(ds.plMatsui || 0) || 0);
    const lossTotal =
      (Number(ds.lossRakuten || 0) || 0) + (Number(ds.lossMatsui || 0) || 0);

    setText("detailQtyTotal", qtyTotal, "int");
    setText("detailPlTotal", plTotal, "yen");
    setText("detailLossTotal", lossTotal, "yen");

    const ul = document.getElementById("detailReasons");
    ul.innerHTML = "";
    if (ds.reasons){
      ds.reasons.split("||").forEach(function(t){
        t = (t || "").trim();
        if (!t) return;
        const li = document.createElement("li");
        li.textContent = t;
        ul.appendChild(li);
      });
    }
    document.getElementById("detailConcern").textContent =
      ds.concern || "";

    modal.classList.add("open");
    body.classList.add("modal-open");
  }

  function closeModal(){
    modal.classList.remove("open");
    body.classList.remove("modal-open");
  }

  table.querySelectorAll("tbody tr").forEach(function(row){
    row.addEventListener("click", function(){
      if (!this.dataset.code) return;
      openModal(this);
    });
  });

  modal.addEventListener("click", function(e){
    if (e.target === modal){
      closeModal();
    }
  });
  if (closeBtn){
    closeBtn.addEventListener("click", closeModal);
  }
})();
</script>

{% endblock %}