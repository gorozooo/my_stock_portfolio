{# templates/aiapp/picks_debug.html #}
{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% block title %}AI Picks 診断{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'aiapp/css/picks_debug.css' %}?v=21">

<style>
  /* バナー最小CSS（picks_debug.cssに移してもOK） */
  .banner-row{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid rgba(148,163,184,.18);
  }
  .banner-date{
    font-weight:800;
    letter-spacing:.02em;
  }
  .banner-badges{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .banner-badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.35);
    font-size:12px;
    line-height:1;
    background:rgba(15,23,42,.55);
    user-select:none;
  }
  .banner-badge.ok{ border-color:rgba(34,197,94,.45); }
  .banner-badge.warn{ border-color:rgba(234,179,8,.45); }
  .banner-badge.bad{ border-color:rgba(239,68,68,.45); }
  .banner-badge.dim{ opacity:.85; }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="head-card">
    <div class="head-top">
      <div>
        {% if updated_at_label %}
          <div class="title">最終更新: {{ updated_at_label }}</div>
        {% endif %}

        <!-- モード / ユニバース -->
        <div class="meta">
          <span>モード: {{ meta.style|default:"aggressive" }}/{{ meta.horizon|default:"short" }}</span>
          <span>ユニバース: {{ meta.universe|default:"(不明)" }}</span>
        </div>

        <!-- 件数まわり（総件数 / 対象件数） -->
        <div class="meta">
          総件数（ユニバース内）: {{ master_total|default:0|intcomma }} 件
        </div>
        <div class="meta">
          対象件数（フィルタ後・評価対象）: {{ meta.total|default:0|intcomma }} 件
        </div>

        <!-- フィルタ削除件数（日本語ラベル） -->
        {% if filter_stats %}
          <div class="meta">
            削除された銘柄:
            {% for label, val in filter_stats.items %}
              {{ label }}＝{{ val|intcomma }} 件{% if not forloop.last %} ／{% endif %}
            {% endfor %}
          </div>
        {% endif %}

        {% if source_file %}
          <div class="meta">ソース: <code style="font-size:11px">{{ source_file }}</code></div>
        {% endif %}
      </div>
    </div>
    
  </div>

  <div class="filter-row">
    <input
      id="filterInput"
      class="filter-input"
      type="search"
      placeholder="コード・銘柄名・業種でフィルタ">
  </div>

  <div class="table-wrap">
    <div class="table-scroller">
      <table id="picksTable">
        <thead>
          <tr>
            <th class="th-rank">Rank</th>
            <th>Score</th>
            <th>コード</th>
            <th>銘柄名 / 業種</th>
            <th class="th-ev">期待値</th>
          </tr>
        </thead>
        <tbody>
        {% for it in items %}
          <tr class="pick-row"
              data-code="{{ it.code }}"
              data-name="{{ it.name|default:'(銘柄名なし)' }}"
              data-sector="{{ it.sector_display|default:'業種不明' }}"
              data-score="{{ it.score_100|default:'' }}"
              data-stars="{{ it.stars|default:0 }}"
              data-last="{{ it.last_close|default:'' }}"
              data-atr="{{ it.atr|default:'' }}"
              data-entry="{{ it.entry|default:'' }}"
              data-tp="{{ it.tp|default:'' }}"
              data-sl="{{ it.sl|default:'' }}"

              data-qty-rakuten="{{ it.qty_rakuten|default:'' }}"
              data-pl-rakuten="{{ it.est_pl_rakuten|default:'' }}"
              data-loss-rakuten="{{ it.est_loss_rakuten|default:'' }}"
              data-cash-rakuten="{{ it.required_cash_rakuten|default:'' }}"
              data-reason-rakuten="{{ it.reason_rakuten|default:'' }}"

              data-qty-matsui="{{ it.qty_matsui|default:'' }}"
              data-pl-matsui="{{ it.est_pl_matsui|default:'' }}"
              data-loss-matsui="{{ it.est_loss_matsui|default:'' }}"
              data-cash-matsui="{{ it.required_cash_matsui|default:'' }}"
              data-reason-matsui="{{ it.reason_matsui|default:'' }}"

              data-qty-sbi="{{ it.qty_sbi|default:'' }}"
              data-pl-sbi="{{ it.est_pl_sbi|default:'' }}"
              data-loss-sbi="{{ it.est_loss_sbi|default:'' }}"
              data-cash-sbi="{{ it.required_cash_sbi|default:'' }}"
              data-reason-sbi="{{ it.reason_sbi|default:'' }}"

              {# ★ EV_true（楽天/松井/SBI） #}
              data-evtrue-rakuten="{{ it.ev_true_rakuten|default:'' }}"
              data-evtrue-matsui="{{ it.ev_true_matsui|default:'' }}"
              data-evtrue-sbi="{{ it.ev_true_sbi|default:'' }}"

              data-reasons="{% if it.reason_lines %}{{ it.reason_lines|join:'||' }}{% endif %}"
              data-sizing-reasons="{% if it.reasons_text %}{{ it.reasons_text|join:'||' }}{% endif %}"

              {# ローソク足用 OHLC （CSV） #}
              data-chart-open="{% if it.chart_open %}{{ it.chart_open|join:',' }}{% endif %}"
              data-chart-high="{% if it.chart_high %}{{ it.chart_high|join:',' }}{% endif %}"
              data-chart-low="{% if it.chart_low %}{{ it.chart_low|join:',' }}{% endif %}"
              data-chart-close="{% if it.chart_closes %}{{ it.chart_closes|join:',' }}{% endif %}"
              data-chart-dates="{% if it.chart_dates %}{{ it.chart_dates|join:',' }}{% endif %}"

              {# MA / VWAP / RSI も CSV で埋め込む #}
              data-chart-ma-5="{% if it.chart_ma_5 %}{{ it.chart_ma_5|join:',' }}{% endif %}"
              data-chart-ma-25="{% if it.chart_ma_25 %}{{ it.chart_ma_25|join:',' }}{% endif %}"
              data-chart-ma-75="{% if it.chart_ma_75 %}{{ it.chart_ma_75|join:',' }}{% endif %}"
              data-chart-ma-100="{% if it.chart_ma_100 %}{{ it.chart_ma_100|join:',' }}{% endif %}"
              data-chart-ma-200="{% if it.chart_ma_200 %}{{ it.chart_ma_200|join:',' }}{% endif %}"
              data-chart-vwap="{% if it.chart_vwap %}{{ it.chart_vwap|join:',' }}{% endif %}"
              data-chart-rsi="{% if it.chart_rsi %}{{ it.chart_rsi|join:',' }}{% endif %}"

              {# 52週 / 上場来 高安値（水平線用） #}
              data-hi-52w="{{ it.hi_52w|default:'' }}"
              data-lo-52w="{{ it.lo_52w|default:'' }}"
              data-hi-all="{{ it.hi_all_time|default:'' }}"
              data-lo-all="{{ it.lo_all_time|default:'' }}"

              data-concern="{{ it.reason_concern|default:'' }}"
          >
            <td class="rank-cell">
              <span class="rank-pill" data-rank-pill>–</span>
            </td>

            <td class="score
              {% if it.score_100 and it.score_100|floatformat:0 >= 80 %}score-high
              {% elif it.score_100 and it.score_100|floatformat:0 >= 60 %}score-mid
              {% else %}score-low{% endif %}">
              {% if it.score_100 is not None %}
                {{ it.score_100|floatformat:0 }}
              {% else %}–{% endif %}
            </td>

            <td class="code">{{ it.code }}</td>

            <td class="td-name">
              <div class="td-name-main">{{ it.name|default:"(銘柄名なし)" }}</div>
              <div class="sector">{{ it.sector_display|default:"業種不明" }}</div>
            </td>

            <td class="td-ev">
              <span class="ev-pill" data-ev-pill="rakuten">R <b data-ev-text="rakuten">–</b></span>
              <span class="ev-pill" data-ev-pill="matsui">M <b data-ev-text="matsui">–</b></span>
              <span class="ev-pill" data-ev-pill="sbi">S <b data-ev-text="sbi">–</b></span>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" style="text-align:center;color:#9ca3af;padding:16px 8px;">
              items が空です。picks_build がまだ走っていないか、ファイル読み込みに失敗しています。
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== 詳細モーダル ===== -->
<div id="pickModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card">
    <button type="button" id="modalCloseBtn" class="modal-close">×</button>

    <div class="modal-header">
      <div class="modal-title" id="modalTitle">コード 銘柄名</div>
      <div class="modal-sector" id="modalSector">業種</div>
      <div class="modal-top-badges">
        <span class="badge-pill" id="modalScoreBadge">Score: –</span>
        <span class="badge-pill" id="modalStarBadge">★ –</span>
        <span class="badge-pill" id="modalRankBadge">Rank: –</span>
      </div>
    </div>

    <!-- チャートカード -->
    <div class="detail-card chart-card">
      <div class="chart-inner" id="detailChartContainer">
        <div id="detailChartPriceContainer" class="chart-price-container"></div>

        <div class="rsi-title-row">
          <span class="rsi-title">RSI</span>
        </div>

        <div id="detailChartRsiContainer" class="chart-rsi-container"></div>

        <div id="chartEmptyLabel" class="chart-empty-label">
          チャート用データが不足しています
        </div>
      </div>

      <!-- 凡例 -->
      <div class="chart-legend">
        <div class="legend-pill legend-close">
          終値 <span class="legend-value" id="legendCloseValue">–</span>
        </div>
        <div class="legend-pill legend-ma-5">
          5MA <span class="legend-value" id="legendMa5Value">–</span>
        </div>
        <div class="legend-pill legend-ma-25">
          25MA <span class="legend-value" id="legendMa25Value">–</span>
        </div>
        <div class="legend-pill legend-ma-75">
          75MA <span class="legend-value" id="legendMa75Value">–</span>
        </div>
        <div class="legend-pill legend-ma-100">
          100MA <span class="legend-value" id="legendMa100Value">–</span>
        </div>
        <div class="legend-pill legend-ma-200">
          200MA <span class="legend-value" id="legendMa200Value">–</span>
        </div>
        <div class="legend-pill legend-vwap">
          VWAP <span class="legend-value" id="legendVwapValue">–</span>
        </div>
        <div class="legend-pill legend-52w">
          52週高値 <span class="legend-value" id="legendHi52wValue">–</span>
        </div>
        <div class="legend-pill legend-52w">
          52週安値 <span class="legend-value" id="legendLo52wValue">–</span>
        </div>
        <div class="legend-pill legend-alltime">
          上場来高値 <span class="legend-value" id="legendHiAllValue">–</span>
        </div>
        <div class="legend-pill legend-alltime">
          上場来安値 <span class="legend-value" id="legendLoAllValue">–</span>
        </div>
      </div>
    </div>

    <div class="detail-grid">

      <!-- 現在値 ＋ ATR -->
      <div class="detail-card">
        <div class="detail-card-title">現在値</div>
        <div class="detail-main-value" id="detailLast">–</div>
        <div class="detail-main-sub">ATR <span id="detailAtr">–</span></div>
      </div>

      <!-- ★ EV_true -->
      <div class="detail-card">
        <div class="detail-card-title">期待値</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value ev-text" id="detailEvRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value ev-text" id="detailEvMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value ev-text" id="detailEvSbi">–</div>
        </div>
      </div>

      <!-- 数量 -->
      <div class="detail-card">
        <div class="detail-card-title">数量</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value" id="detailQtyRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value" id="detailQtyMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value" id="detailQtySbi">–</div>
        </div>
        <div class="detail-row detail-row-strong">
          <div class="detail-label">合計</div>
          <div class="detail-value" id="detailQtyTotal">–</div>
        </div>
      </div>

      <!-- Entry / TP / SL -->
      <div class="detail-card">
        <div class="detail-card-title">Entry / TP / SL</div>
        <div class="detail-row">
          <div class="detail-label">Entry</div>
          <div class="detail-value" id="detailEntry">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">TP</div>
          <div class="detail-value" id="detailTp">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SL</div>
          <div class="detail-value" id="detailSl">–</div>
        </div>
      </div>

      <!-- 必要資金 -->
      <div class="detail-card">
        <div class="detail-card-title">必要資金（概算）</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value" id="detailCashRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value" id="detailCashMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value" id="detailCashSbi">–</div>
        </div>
      </div>

      <!-- 想定利益 -->
      <div class="detail-card">
        <div class="detail-card-title">想定利益</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value detail-green" id="detailPlRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value detail-green" id="detailPlMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value detail-green" id="detailPlSbi">–</div>
        </div>
        <div class="detail-row detail-row-strong">
          <div class="detail-label">合計</div>
          <div class="detail-value detail-green" id="detailPlTotal">–</div>
        </div>
      </div>

      <!-- 想定損失 -->
      <div class="detail-card">
        <div class="detail-card-title">想定損失</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value detail-red" id="detailLossRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value detail-red" id="detailLossMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value detail-red" id="detailLossSbi">–</div>
        </div>
        <div class="detail-row detail-row-strong">
          <div class="detail-label">合計</div>
          <div class="detail-value detail-red" id="detailLossTotal">–</div>
        </div>
      </div>

    </div>

    <!-- 理由 -->
    <div class="reason-section">
      <div class="section-title">理由</div>
      <div class="reason-block">
        <div class="reason-subtitle">選定理由（AI）</div>
        <ul id="detailReasonsAi" class="reason-list"></ul>

        <div class="reason-subtitle">数量が0になる理由（発注条件）</div>
        <ul id="detailReasonsSizing" class="reason-list"></ul>

        <div class="reason-subtitle">懸念点</div>
        <div id="detailConcern" class="reason-concern"></div>
      </div>
    </div>

  </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js" defer></script>
<script src="{% static 'aiapp/js/picks_debug.js' %}?v=48" defer></script>
{% endblock %}