{% extends "base.html" %}
{% load humanize %}
{% block title %}AI Picks 診断{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#020617;
    --card:rgba(15,23,42,.9);
    --fg:#e5edff;
    --sub:#9ca3af;
    --accent:#2563eb;
    --line:rgba(148,163,184,.35);
    --ok:#22c55e;
    --bad:#ef4444;
  }
  body{background:var(--bg);color:var(--fg);}
  .wrap{max-width:960px;margin:0 auto;padding:16px 10px 80px;}

  .head-card{
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px 14px;
    background:radial-gradient(circle at top left,rgba(37,99,235,.25),transparent 55%),
               rgba(15,23,42,.9);
    backdrop-filter:blur(10px);
    margin-bottom:12px;
  }
  .head-top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-bottom:6px;
  }
  .title{font-size:18px;font-weight:700;}
  .badge{
    font-size:11px;padding:4px 8px;border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.9);
    white-space:nowrap;
  }
  .meta{font-size:12px;color:var(--sub);line-height:1.5;}
  .meta span+span::before{content:" / ";margin:0 2px;}

  .filter-row{
    display:flex;gap:8px;margin:8px 0 12px;
  }
  .filter-input{
    flex:1;padding:10px;border-radius:12px;border:1px solid var(--line);
    background:rgba(15,23,42,.9);color:var(--fg);font-size:14px;
  }
  .pill{
    font-size:11px;padding:6px 10px;border-radius:999px;
    border:1px solid var(--line);color:var(--sub);
    background:rgba(15,23,42,.9);white-space:nowrap;
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="head-card">
    <div class="head-top">
      <div>

        <div class="title">AI Picks 診断ビュー</div>

        <!-- ======= 基本メタ ======= -->
        <div class="meta">
          <span>モード: {{ meta.style }}/{{ meta.horizon }}</span>
          <span>ユニバース: {{ meta.universe }}</span>
        </div>

        <!-- ======= 件数メタ ======= -->
        <div class="meta">
          {% if meta.stockmaster_total %}
            <div>総件数（StockMaster）: {{ meta.stockmaster_total|intcomma }} 件</div>
          {% endif %}
          <div>対象件数（フィルタ後）: {{ meta.total|intcomma }} 件</div>
          <div>TopK: {{ meta.topk }}</div>
        </div>

        <!-- ======= フィルタ削除件数 ======= -->
        {% if filter_stats_jp %}
          <div class="meta">
            削除された銘柄:
            <ul style="margin:4px 0 0 12px;padding:0;list-style:disc;">
              {% for row in filter_stats_jp %}
                <li>{{ row.label }}: {{ row.count|intcomma }} 件</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <!-- ======= 更新日時 ======= -->
        {% if updated_at_label %}
          <div class="meta">最終更新: {{ updated_at_label }}</div>
        {% endif %}
        {% if source_file %}
          <div class="meta">ソース: <code>{{ source_file }}</code></div>
        {% endif %}

      </div>
      <div class="badge">DEBUG / INTERNAL</div>
    </div>

    <div class="meta">
      ※ picks_build が出力した JSON をそのまま表示しています。<br>
      ※ 並び順は score_100 → 株価 の降順です。
    </div>
  </div>

  <!-- ======= フィルタ UI ======= -->
  <div class="filter-row">
    <input id="filterInput" class="filter-input" type="search"
      placeholder="コード・銘柄名・業種でフィルタ（例: 7203 / トヨタ / 保険）">
    <div class="pill">score 0-100 ／ qty・PL は楽天+松井の合計</div>
  </div>

  <!-- ======= テーブル ======= -->
  <div class="table-wrap">
    <div class="table-scroller">
      <table id="picksTable">
        <thead>
          <tr>
            <th>コード</th>
            <th>銘柄名 / 業種</th>
            <th>Score</th>
            <th>⭐</th>
            <th>現在値</th>
            <th>ATR</th>
            <th>Entry</th>
            <th>TP</th>
            <th>SL</th>
            <th>数量 合計</th>
            <th>想定利益</th>
            <th>想定損失</th>
          </tr>
        </thead>
        <tbody>

{% for it in items %}
  <tr>
    <td class="code">{{ it.code }}</td>

    <td>
      <div>{{ it.name }}</div>
      <div class="sector">{{ it.sector_display }}</div>
    </td>

    <td>{{ it.score_100 }}</td>
    <td>{% if it.stars %}{{ it.stars }}★{% else %}–{% endif %}</td>

    <td>{{ it.last_close|floatformat:0|intcomma }}</td>
    <td>{{ it.atr|floatformat:0|intcomma }}</td>
    <td>{{ it.entry|floatformat:0|intcomma }}</td>
    <td>{{ it.tp|floatformat:0|intcomma }}</td>
    <td>{{ it.sl|floatformat:0|intcomma }}</td>

    <td>{{ it.qty_total|default:0|intcomma }}</td>

    <td>{{ it.pl_total|default:0|intcomma }}</td>
    <td>{{ it.loss_total|default:0|intcomma }}</td>
  </tr>
{% empty %}
  <tr><td colspan="12" style="text-align:center;">items が空です。</td></tr>
{% endfor %}

        </tbody>
      </table>
    </div>
  </div>

</div>

<script>
(function(){
  const input = document.getElementById("filterInput");
  const rows = document.querySelectorAll("#picksTable tbody tr");
  input.addEventListener("input", () => {
    const q = input.value.toLowerCase();
    rows.forEach(r => {
      r.style.display = r.textContent.toLowerCase().includes(q) ? "" : "none";
    });
  });
})();
</script>

{% endblock %}