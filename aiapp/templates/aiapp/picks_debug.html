{% extends "base.html" %}
{% load humanize %}
{% block title %}AI Picks 診断{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#020617;
    --card:rgba(15,23,42,.9);
    --fg:#e5edff;
    --sub:#9ca3af;
    --accent:#2563eb;
    --line:rgba(148,163,184,.35);
    --ok:#22c55e;
    --bad:#ef4444;
  }
  body{background:var(--bg);color:var(--fg);}
  .wrap{max-width:960px;margin:0 auto;padding:16px 10px 80px;}

  .head-card{
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px 14px;
    background:radial-gradient(circle at top left,rgba(37,99,235,.25),transparent 55%),
               rgba(15,23,42,.9);
    backdrop-filter:blur(10px);
    margin-bottom:12px;
  }
  .head-top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-bottom:6px;
  }
  .title{
    font-size:18px;
    font-weight:700;
  }
  .badge{
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.9);
    white-space:nowrap;
  }
  .meta{
    font-size:12px;
    color:var(--sub);
    line-height:1.5;
  }
  .meta span+span::before{
    content:" / ";
    margin:0 2px;
  }

  .filter-row{
    display:flex;
    gap:8px;
    margin:8px 0 12px;
  }
  .filter-input{
    flex:1;
    padding:10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(15,23,42,.9);
    color:var(--fg);
    font-size:14px;
  }
  .filter-input::placeholder{color:#64748b;}
  .pill{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    color:var(--sub);
    background:rgba(15,23,42,.9);
    white-space:nowrap;
  }

  .table-wrap{
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(15,23,42,.9);
    overflow:hidden;
  }
  .table-scroller{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  table{
    width:100%;
    min-width:820px;
    border-collapse:collapse;
    font-size:12px;
  }
  thead{
    background:rgba(15,23,42,1);
    position:sticky;
    top:0;
    z-index:1;
  }
  th,td{
    padding:6px 8px;
    border-bottom:1px solid rgba(30,41,59,.9);
    text-align:right;
    white-space:nowrap;
  }
  th:first-child,
  td:first-child{text-align:left;}
  th:nth-child(2),
  td:nth-child(2){text-align:left;}
  th{
    font-size:11px;
    color:#9ca3af;
    background:rgba(15,23,42,0.98);
    backdrop-filter:blur(10px);
  }
  tbody tr:nth-child(odd){
    background:rgba(15,23,42,0.9);
  }
  tbody tr:nth-child(even){
    background:rgba(15,23,42,0.96);
  }
  tbody tr:hover{
    background:rgba(30,64,175,.7);
  }
  .code{font-feature-settings:"tnum";font-weight:600;}
  .sector{color:var(--sub);font-size:11px;}
  .score{font-weight:700;}
  .score-high{color:#bfdbfe;}
  .score-mid{color:#a3e635;}
  .score-low{color:#f97316;}
  .stars{text-align:center;font-size:13px;}
  .pos{color:var(--ok);}
  .neg{color:var(--bad);}
  .zero{color:#64748b;}

  .foot-note{
    margin-top:8px;
    font-size:11px;
    color:var(--sub);
    line-height:1.5;
  }

  /* ===== 理由表示エリア ===== */
  .reason-row td{
    padding-top:4px;
    padding-bottom:8px;
    border-top:1px dashed rgba(51,65,85,.9);
    background:rgba(15,23,42,0.98);
  }
  .reason-block{
    font-size:11px;
    color:#cbd5f5;
    line-height:1.5;
  }
  .reason-title{
    font-weight:600;
    margin-top:2px;
    margin-bottom:2px;
    color:#e2e8f0;
  }
  .reason-list{
    margin:0 0 4px 1.2em;
    padding:0;
  }
  .reason-list li{
    margin:0;
    padding:0;
    list-style:disc;
  }
  .reason-text{
    margin:0 0 4px;
  }

  /* ===== スマホ幅調整 ===== */
  @media (max-width: 480px){
    .head-top{
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .badge{
      margin-left:auto;
      margin-top:4px;
      font-size:10px;
      padding:3px 7px;
      white-space:normal;
    }
    .filter-row{
      flex-direction:column;
      align-items:stretch;
    }
    .pill{
      align-self:flex-end;
      font-size:10px;
      padding:4px 8px;
      max-width:100%;
      white-space:normal;
      text-align:right;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="head-card">
    <div class="head-top">
      <div>
        {% if updated_at_label %}
          <div class="title">最終更新: {{ updated_at_label }}</div>
        {% else %}
          <div class="title">AI Picks 診断ビュー</div>
        {% endif %}

        <!-- モード / ユニバース -->
        <div class="meta">
          <span>モード: {{ meta.style|default:"aggressive" }}/{{ meta.horizon|default:"short" }}</span>
          <span>ユニバース: {{ meta.universe|default:"(不明)" }}</span>
          <span>TopK: {{ meta.topk|default:0 }}</span>
        </div>

        <!-- 件数まわり（総件数 / 対象件数） -->
        <div class="meta">
          {% with total_all=meta.stockmaster_total|default:meta.total %}
            <span>総件数（ユニバース内）: {{ total_all|default:0|intcomma }} 件</span>
          {% endwith %}
        </div>
        <div class="meta">
          対象件数（フィルタ後・評価対象）: {{ meta.total|default:0|intcomma }} 件
        </div>

        <!-- フィルタ削除件数（日本語ラベル） -->
        {% if filter_stats %}
          <div class="meta">
            削除された銘柄:
            {% for label, val in filter_stats.items %}
              {{ label }}＝{{ val|intcomma }} 件{% if not forloop.last %} ／{% endif %}
            {% endfor %}
          </div>
        {% endif %}

        {% if source_file %}
          <div class="meta">ソース: <code style="font-size:11px">{{ source_file }}</code></div>
        {% endif %}
      </div>

      <div class="badge">DEBUG / INTERNAL</div>
    </div>

    <div class="meta">
      ※ picks_build が出力した JSON（PickItem 相当）をそのまま一覧表示します。<br>
      ※ 並び順は score_100 降順 → 株価降順です。
    </div>
  </div>

  <div class="filter-row">
    <input
      id="filterInput"
      class="filter-input"
      type="search"
      placeholder="コード・銘柄名・業種でフィルタ（例: 7203 / トヨタ / 保険）">
    <div class="pill">score 0〜100 ／ qty・PL は楽天 + 松井の合計</div>
  </div>

  <div class="table-wrap">
    <div class="table-scroller">
      <table id="picksTable">
        <thead>
          <tr>
            <th>コード</th>
            <th>銘柄名 / 業種</th>
            <th>Score</th>
            <th>⭐</th>
            <th>現在値</th>
            <th>ATR</th>
            <th>Entry</th>
            <th>TP</th>
            <th>SL</th>
            <th>数量 合計</th>
            <th>想定利益 合計</th>
            <th>想定損失 合計</th>
          </tr>
        </thead>
        <tbody>

        {% for it in items %}
          <!-- メイン行 -->
          <tr>
            <td class="code">{{ it.code }}</td>

            <td>
              <div>{{ it.name|default:"(銘柄名なし)" }}</div>
              <div class="sector">{{ it.sector_display|default:"業種不明" }}</div>
            </td>

            <td class="score
              {% if it.score_100 and it.score_100|floatformat:0 >= 80 %}score-high
              {% elif it.score_100 and it.score_100|floatformat:0 >= 60 %}score-mid
              {% else %}score-low{% endif %}">
              {% if it.score_100 is not None %}
                {{ it.score_100|floatformat:0 }}
              {% else %}
                –
              {% endif %}
            </td>

            <td class="stars">
              {% if it.stars %}{{ it.stars }}★{% else %}–{% endif %}
            </td>

            <td>{% if it.last_close %}{{ it.last_close|floatformat:0|intcomma }}{% else %}—{% endif %}</td>
            <td>{% if it.atr %}{{ it.atr|floatformat:0|intcomma }}{% else %}—{% endif %}</td>
            <td>{% if it.entry %}{{ it.entry|floatformat:0|intcomma }}{% else %}—{% endif %}</td>
            <td>{% if it.tp %}{{ it.tp|floatformat:0|intcomma }}{% else %}—{% endif %}</td>
            <td>{% if it.sl %}{{ it.sl|floatformat:0|intcomma }}{% else %}—{% endif %}</td>

            <td>
              {% if it.qty_total %}
                {{ it.qty_total|floatformat:0|intcomma }}
              {% else %}
                <span class="zero">0</span>
              {% endif %}
            </td>

            <td>
              {% if it.pl_total and it.pl_total != 0 %}
                <span class="{% if it.pl_total > 0 %}pos{% else %}neg{% endif %}">
                  {{ it.pl_total|floatformat:0|intcomma }}
                </span>
              {% else %}
                <span class="zero">0</span>
              {% endif %}
            </td>

            <td>
              {% if it.loss_total and it.loss_total != 0 %}
                <span class="{% if it.loss_total < 0 %}neg{% else %}pos{% endif %}">
                  {{ it.loss_total|floatformat:0|intcomma }}
                </span>
              {% else %}
                <span class="zero">0</span>
              {% endif %}
            </td>
          </tr>

          {% if it.reason_lines or it.reason_concern or it.reasons_text or it.reason_rakuten or it.reason_matsui %}
          <tr class="reason-row">
            <td colspan="12">
              <div class="reason-block">
                {% if it.reason_lines %}
                  <div class="reason-title">選定理由</div>
                  <ul class="reason-list">
                    {% for line in it.reason_lines %}
                      <li>{{ line }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}

                {% if it.reason_concern %}
                  <div class="reason-title">懸念ポイント</div>
                  <p class="reason-text">{{ it.reason_concern }}</p>
                {% endif %}

                {% if it.reasons_text %}
                  <div class="reason-title">数量・サイズ関連メモ</div>
                  {% if it.reasons_text|length == 1 %}
                    <p class="reason-text">{{ it.reasons_text.0 }}</p>
                  {% else %}
                    <ul class="reason-list">
                      {% for line in it.reasons_text %}
                        <li>{{ line }}</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                {% endif %}

                {% if it.reason_rakuten or it.reason_matsui %}
                  <div class="reason-title">証券会社別メモ</div>
                  {% if it.reason_rakuten %}
                    <p class="reason-text">楽天: {{ it.reason_rakuten }}</p>
                  {% endif %}
                  {% if it.reason_matsui %}
                    <p class="reason-text">松井: {{ it.reason_matsui }}</p>
                  {% endif %}
                {% endif %}
              </div>
            </td>
          </tr>
          {% endif %}
        {% empty %}
          <tr>
            <td colspan="12" style="text-align:center;color:#9ca3af;padding:16px 8px;">
              items が空です。picks_build がまだ走っていないか、ファイル読み込みに失敗しています。
            </td>
          </tr>
        {% endfor %}

        </tbody>
      </table>
    </div>
  </div>

  <div class="foot-note">
    ・この画面は開発者向けの診断ビューです。<br>
    ・score / ⭐ / 数量 / 想定PL が想定とズレていないか確認できます。<br>
    ・各行の下に「選定理由 / 懸念 / 証券会社別メモ」が表示されます。<br>
    ・コード・銘柄名・業種で瞬間フィルタが可能です。
  </div>

</div>

<script>
(function(){
  const input = document.getElementById("filterInput");
  const table = document.getElementById("picksTable");
  if (!input || !table) return;

  const rows = Array.from(table.querySelectorAll("tbody tr"));

  input.addEventListener("input", function(){
    const q = this.value.trim().toLowerCase();
    if (!q){
      rows.forEach(r => r.style.display = "");
      return;
    }
    rows.forEach(r => {
      const text = r.textContent.toLowerCase();
      r.style.display = text.includes(q) ? "" : "none";
    });
  });
})();
</script>

{% endblock %}