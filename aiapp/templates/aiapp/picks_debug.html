{# templates/aiapp/picks_debug.html #}
{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% block title %}AI Picks 診断{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'aiapp/css/picks_debug.css' %}?v=17">
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="head-card">
    <div class="head-top">
      <div>
        {% if updated_at_label %}
          <div class="title">最終更新: {{ updated_at_label }}</div>
        {% endif %}

        <!-- モード / ユニバース -->
        <div class="meta">
          <span>モード: {{ meta.style|default:"aggressive" }}/{{ meta.horizon|default:"short" }}</span>
          <span>ユニバース: {{ meta.universe|default:"(不明)" }}</span>
          <span>TopK: {{ meta.topk|default:0 }}</span>
        </div>

        <!-- 件数まわり（総件数 / 対象件数） -->
        <div class="meta">
          総件数（ユニバース内）: {{ master_total|default:0|intcomma }} 件
        </div>
        <div class="meta">
          対象件数（フィルタ後・評価対象）: {{ meta.total|default:0|intcomma }} 件
        </div>

        <!-- フィルタ削除件数（日本語ラベル） -->
        {% if filter_stats %}
          <div class="meta">
            削除された銘柄:
            {% for label, val in filter_stats.items %}
              {{ label }}＝{{ val|intcomma }} 件{% if not forloop.last %} ／{% endif %}
            {% endfor %}
          </div>
        {% endif %}

        {% if source_file %}
          <div class="meta">ソース: <code style="font-size:11px">{{ source_file }}</code></div>
        {% endif %}
      </div>
      <div class="badge">DEBUG / INTERNAL</div>
    </div>

    <div class="meta">
      ※ picks_build が出力した JSON（PickItem 相当）をそのまま一覧表示します。<br>
      ※ 並び順は score_100 降順 → 株価降順です。
    </div>
  </div>

  <div class="filter-row">
    <input
      id="filterInput"
      class="filter-input"
      type="search"
      placeholder="コード・銘柄名・業種でフィルタ（例: 7203 / トヨタ / 保険）">
    <div class="pill">score 0〜100 ／ 詳細はタップでモーダル表示</div>
  </div>

  <div class="table-wrap">
    <div class="table-scroller">
      <table id="picksTable">
        <thead>
          <tr>
            <th>コード</th>
            <th>銘柄名 / 業種</th>
            <th style="text-align:right;">Score</th>
          </tr>
        </thead>
        <tbody>
        {% for it in items %}
          <tr class="pick-row"
              data-code="{{ it.code }}"
              data-name="{{ it.name|default:'(銘柄名なし)' }}"
              data-sector="{{ it.sector_display|default:'業種不明' }}"
              data-score="{{ it.score_100|default:'' }}"
              data-stars="{{ it.stars|default:0 }}"
              data-last="{{ it.last_close|default:'' }}"
              data-atr="{{ it.atr|default:'' }}"
              data-entry="{{ it.entry|default:'' }}"
              data-tp="{{ it.tp|default:'' }}"
              data-sl="{{ it.sl|default:'' }}"

              data-qty-rakuten="{{ it.qty_rakuten|default:'' }}"
              data-pl-rakuten="{{ it.est_pl_rakuten|default:'' }}"
              data-loss-rakuten="{{ it.est_loss_rakuten|default:'' }}"
              data-cash-rakuten="{{ it.required_cash_rakuten|default:'' }}"
              data-reason-rakuten="{{ it.reason_rakuten|default:'' }}"

              data-qty-matsui="{{ it.qty_matsui|default:'' }}"
              data-pl-matsui="{{ it.est_pl_matsui|default:'' }}"
              data-loss-matsui="{{ it.est_loss_matsui|default:'' }}"
              data-cash-matsui="{{ it.required_cash_matsui|default:'' }}"
              data-reason-matsui="{{ it.reason_matsui|default:'' }}"

              data-qty-sbi="{{ it.qty_sbi|default:'' }}"
              data-pl-sbi="{{ it.est_pl_sbi|default:'' }}"
              data-loss-sbi="{{ it.est_loss_sbi|default:'' }}"
              data-cash-sbi="{{ it.required_cash_sbi|default:'' }}"
              data-reason-sbi="{{ it.reason_sbi|default:'' }}"

              data-reasons="{% if it.reason_lines %}{{ it.reason_lines|join:'||' }}{% endif %}"
              data-sizing-reasons="{% if it.reasons_text %}{{ it.reasons_text|join:'||' }}{% endif %}"

              {# ローソク足用 OHLC （CSV） #}
              data-chart-open="{% if it.chart_open %}{{ it.chart_open|join:',' }}{% endif %}"
              data-chart-high="{% if it.chart_high %}{{ it.chart_high|join:',' }}{% endif %}"
              data-chart-low="{% if it.chart_low %}{{ it.chart_low|join:',' }}{% endif %}"
              data-chart-close="{% if it.chart_closes %}{{ it.chart_closes|join:',' }}{% endif %}"
              data-chart-dates="{% if it.chart_dates %}{{ it.chart_dates|join:',' }}{% endif %}"

              {# MA / VWAP / RSI も CSV で埋め込む #}
              data-chart-ma-short="{% if it.chart_ma_short %}{{ it.chart_ma_short|join:',' }}{% endif %}"
              data-chart-ma-mid="{% if it.chart_ma_mid %}{{ it.chart_ma_mid|join:',' }}{% endif %}"
              data-chart-vwap="{% if it.chart_vwap %}{{ it.chart_vwap|join:',' }}{% endif %}"
              data-chart-rsi="{% if it.chart_rsi %}{{ it.chart_rsi|join:',' }}{% endif %}"

              data-concern="{{ it.reason_concern|default:'' }}"
          >
            <td class="code">{{ it.code }}</td>
            <td class="td-name">
              <div class="td-name-main">{{ it.name|default:"(銘柄名なし)" }}</div>
              <div class="sector">{{ it.sector_display|default:"業種不明" }}</div>
            </td>
            <td class="score
              {% if it.score_100 and it.score_100|floatformat:0 >= 80 %}score-high
              {% elif it.score_100 and it.score_100|floatformat:0 >= 60 %}score-mid
              {% else %}score-low{% endif %}">
              {% if it.score_100 is not None %}
                {{ it.score_100|floatformat:0 }}
              {% else %}–{% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="3" style="text-align:center;color:#9ca3af;padding:16px 8px;">
              items が空です。picks_build がまだ走っていないか、ファイル読み込みに失敗しています。
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="foot-note">
    ・行をタップすると、数量・想定PL・理由などの詳細がモーダルで表示されます。<br>
    ・score / ⭐ / 数量 / 想定PL が想定とズレていないか確認できます。<br>
    ・楽天 / 松井 / SBI の3社分と、「なぜ0株なのか」の判定理由も確認できます。
  </div>

</div>

<!-- ===== 詳細モーダル ===== -->
<div id="pickModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card">
    <button type="button" id="modalCloseBtn" class="modal-close">×</button>

    <div class="modal-header">
      <div class="modal-title" id="modalTitle">コード 銘柄名</div>
      <div class="modal-sector" id="modalSector">業種</div>
      <div class="modal-top-badges">
        <span class="badge-pill" id="modalScoreBadge">Score: –</span>
        <span class="badge-pill" id="modalStarBadge">★ –</span>
      </div>
    </div>

    <!-- チャートカード（上段:終値+MA+VWAP+Entry/TP/SL、下段:RSI） -->
    <div class="detail-card chart-card">
      <div class="detail-card-title">日足チャート（終値・MA・VWAP・RSI）</div>
      <div class="chart-inner">
        <div id="detailChartContainer" class="chart-container">
          <div id="detailChartPriceContainer" class="chart-container chart-price"></div>

          <div class="rsi-header">
            <span class="rsi-label">RSI</span>
            <span class="rsi-badge">
              <span id="detailRsiLatest">–</span>
            </span>
          </div>

          <div id="detailChartRsiContainer" class="chart-container chart-rsi"></div>
        </div>
        <div id="chartEmptyLabel" class="chart-empty-label">
          チャート用データが不足しています
        </div>
      </div>

      <div class="chart-legend">
        <span class="legend-line legend-close">
          終値
          <span class="legend-value" id="legendCloseValue">–</span>
        </span>
        <span class="legend-line legend-ma-short">
          5MA
          <span class="legend-value" id="legendMaShortValue">–</span>
        </span>
        <span class="legend-line legend-ma-mid">
          25MA
          <span class="legend-value" id="legendMaMidValue">–</span>
        </span>
        <span class="legend-line legend-vwap">
          VWAP
          <span class="legend-value" id="legendVwapValue">–</span>
        </span>
        <span class="legend-line legend-rsi">
          RSI
          <span class="legend-value" id="legendRsiValue">–</span>
        </span>
        <span class="legend-line legend-entry">Entry</span>
        <span class="legend-line legend-tp">TP</span>
        <span class="legend-line legend-sl">SL</span>
      </div>
    </div>

    <!-- 2カラムカード -->
    <div class="detail-grid">

      <!-- 現在値 ＋ ATR -->
      <div class="detail-card">
        <div class="detail-card-title">現在値</div>
        <div class="detail-main-value" id="detailLast">–</div>
        <div class="detail-main-sub">ATR <span id="detailAtr">–</span></div>
      </div>

      <!-- 数量 -->
      <div class="detail-card">
        <div class="detail-card-title">数量</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value" id="detailQtyRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value" id="detailQtyMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value" id="detailQtySbi">–</div>
        </div>
        <div class="detail-row detail-row-strong">
          <div class="detail-label">合計</div>
          <div class="detail-value" id="detailQtyTotal">–</div>
        </div>
      </div>

      <!-- Entry / TP / SL -->
      <div class="detail-card">
        <div class="detail-card-title">Entry / TP / SL</div>
        <div class="detail-row">
          <div class="detail-label">Entry</div>
          <div class="detail-value" id="detailEntry">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">TP</div>
          <div class="detail-value" id="detailTp">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SL</div>
          <div class="detail-value" id="detailSl">–</div>
        </div>
      </div>

      <!-- 必要資金 -->
      <div class="detail-card">
        <div class="detail-card-title">必要資金（概算）</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value" id="detailCashRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value" id="detailCashMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value" id="detailCashSbi">–</div>
        </div>
      </div>

      <!-- 想定利益 -->
      <div class="detail-card">
        <div class="detail-card-title">想定利益</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value detail-green" id="detailPlRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value detail-green" id="detailPlMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value detail-green" id="detailPlSbi">–</div>
        </div>
        <div class="detail-row detail-row-strong">
          <div class="detail-label">合計</div>
          <div class="detail-value detail-green" id="detailPlTotal">–</div>
        </div>
      </div>

      <!-- 想定損失 -->
      <div class="detail-card">
        <div class="detail-card-title">想定損失</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value detail-red" id="detailLossRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value detail-red" id="detailLossMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value detail-red" id="detailLossSbi">–</div>
        </div>
        <div class="detail-row detail-row-strong">
          <div class="detail-label">合計</div>
          <div class="detail-value detail-red" id="detailLossTotal">–</div>
        </div>
      </div>

    </div>

    <!-- 理由 -->
    <div class="reason-section">
      <div class="section-title">理由</div>
      <div class="reason-block">
        <div class="reason-subtitle">選定理由（AI）</div>
        <ul id="detailReasonsAi" class="reason-list"></ul>

        <div class="reason-subtitle">数量が0になる理由（発注条件）</div>
        <ul id="detailReasonsSizing" class="reason-list"></ul>

        <div class="reason-subtitle">懸念点</div>
        <div id="detailConcern" class="reason-concern"></div>
      </div>
    </div>

  </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js" defer></script>
<script src="{% static 'aiapp/js/picks_debug.js' %}?v=43" defer></script>
{% endblock %}