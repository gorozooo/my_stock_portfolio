{# templates/aiapp/picks_debug.html #}
{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% block title %}AI Picks è¨ºæ–­{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'aiapp/css/picks_debug.css' %}?v=20">

<style>
  /* ãƒãƒŠãƒ¼æœ€å°CSSï¼ˆpicks_debug.cssã«ç§»ã—ã¦ã‚‚OKï¼‰ */
  .banner-row{
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
    margin-top:10px;
    padding-top:10px;
    border-top:1px solid rgba(148,163,184,.18);
  }
  .banner-date{
    font-weight:800;
    letter-spacing:.02em;
  }
  .banner-badges{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .banner-badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.35);
    font-size:12px;
    line-height:1;
    background:rgba(15,23,42,.55);
    user-select:none;
  }
  .banner-badge.ok{ border-color:rgba(34,197,94,.45); }
  .banner-badge.warn{ border-color:rgba(234,179,8,.45); }
  .banner-badge.bad{ border-color:rgba(239,68,68,.45); }
  .banner-badge.dim{ opacity:.85; }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="head-card">
    <div class="head-top">
      <div>
        {% if updated_at_label %}
          <div class="title">æœ€çµ‚æ›´æ–°: {{ updated_at_label }}</div>
        {% endif %}

        <!-- ãƒ¢ãƒ¼ãƒ‰ / ãƒ¦ãƒ‹ãƒãƒ¼ã‚¹ -->
        <div class="meta">
          <span>ãƒ¢ãƒ¼ãƒ‰: {{ meta.style|default:"aggressive" }}/{{ meta.horizon|default:"short" }}</span>
          <span>ãƒ¦ãƒ‹ãƒãƒ¼ã‚¹: {{ meta.universe|default:"(ä¸æ˜)" }}</span>
          <!--<span>TopK: {{ meta.topk|default:0 }}</span>-->
        </div>

        <!-- ä»¶æ•°ã¾ã‚ã‚Šï¼ˆç·ä»¶æ•° / å¯¾è±¡ä»¶æ•°ï¼‰ -->
        <div class="meta">
          ç·ä»¶æ•°ï¼ˆãƒ¦ãƒ‹ãƒãƒ¼ã‚¹å†…ï¼‰: {{ master_total|default:0|intcomma }} ä»¶
        </div>
        <div class="meta">
          å¯¾è±¡ä»¶æ•°ï¼ˆãƒ•ã‚£ãƒ«ã‚¿å¾Œãƒ»è©•ä¾¡å¯¾è±¡ï¼‰: {{ meta.total|default:0|intcomma }} ä»¶
        </div>

        <!-- ãƒ•ã‚£ãƒ«ã‚¿å‰Šé™¤ä»¶æ•°ï¼ˆæ—¥æœ¬èªãƒ©ãƒ™ãƒ«ï¼‰ -->
        {% if filter_stats %}
          <div class="meta">
            å‰Šé™¤ã•ã‚ŒãŸéŠ˜æŸ„:
            {% for label, val in filter_stats.items %}
              {{ label }}ï¼{{ val|intcomma }} ä»¶{% if not forloop.last %} ï¼{% endif %}
            {% endfor %}
          </div>
        {% endif %}

        {% if source_file %}
          <div class="meta">ã‚½ãƒ¼ã‚¹: <code style="font-size:11px">{{ source_file }}</code></div>
        {% endif %}
      </div>
    </div>

    <!-- ===== ã“ã“ãŒè¿½åŠ ï¼šæœ¬æ—¥ + è©•ä¾¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çŠ¶æ³ ===== -->
    <div class="banner-row">
      <div class="banner-date">
        ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³åæ˜ çµæœ
      </div>
      <div class="banner-badges">
        <span class="banner-badge">åˆè¨ˆ {{ behavior_banner.total|default:0 }}</span>
        <span class="banner-badge ok">âœ… è©•ä¾¡æ¸ˆ {{ behavior_banner.counts.evaluated|default:0 }}</span>
        <span class="banner-badge warn">â³ æœªæ¥ {{ behavior_banner.counts.pending_future|default:0 }}</span>
        <span class="banner-badge dim">ğŸ’¤ skip {{ behavior_banner.counts.skip|default:0 }}</span>
        <span class="banner-badge bad">â“ unknown {{ behavior_banner.counts.unknown|default:0 }}</span>
      </div>
    </div>
  </div>

  <div class="filter-row">
    <input
      id="filterInput"
      class="filter-input"
      type="search"
      placeholder="ã‚³ãƒ¼ãƒ‰ãƒ»éŠ˜æŸ„åãƒ»æ¥­ç¨®ã§ãƒ•ã‚£ãƒ«ã‚¿">
  </div>

  <div class="table-wrap">
    <div class="table-scroller">
      <table id="picksTable">
        <thead>
          <tr>
            <th>ã‚³ãƒ¼ãƒ‰</th>
            <th>éŠ˜æŸ„å / æ¥­ç¨®</th>
            <th style="text-align:right;">Score</th>
          </tr>
        </thead>
        <tbody>
        {% for it in items %}
          <tr class="pick-row"
              data-code="{{ it.code }}"
              data-name="{{ it.name|default:'(éŠ˜æŸ„åãªã—)' }}"
              data-sector="{{ it.sector_display|default:'æ¥­ç¨®ä¸æ˜' }}"
              data-score="{{ it.score_100|default:'' }}"
              data-stars="{{ it.stars|default:0 }}"
              data-last="{{ it.last_close|default:'' }}"
              data-atr="{{ it.atr|default:'' }}"
              data-entry="{{ it.entry|default:'' }}"
              data-tp="{{ it.tp|default:'' }}"
              data-sl="{{ it.sl|default:'' }}"

              data-qty-rakuten="{{ it.qty_rakuten|default:'' }}"
              data-pl-rakuten="{{ it.est_pl_rakuten|default:'' }}"
              data-loss-rakuten="{{ it.est_loss_rakuten|default:'' }}"
              data-cash-rakuten="{{ it.required_cash_rakuten|default:'' }}"
              data-reason-rakuten="{{ it.reason_rakuten|default:'' }}"

              data-qty-matsui="{{ it.qty_matsui|default:'' }}"
              data-pl-matsui="{{ it.est_pl_matsui|default:'' }}"
              data-loss-matsui="{{ it.est_loss_matsui|default:'' }}"
              data-cash-matsui="{{ it.required_cash_matsui|default:'' }}"
              data-reason-matsui="{{ it.reason_matsui|default:'' }}"

              data-qty-sbi="{{ it.qty_sbi|default:'' }}"
              data-pl-sbi="{{ it.est_pl_sbi|default:'' }}"
              data-loss-sbi="{{ it.est_loss_sbi|default:'' }}"
              data-cash-sbi="{{ it.required_cash_sbi|default:'' }}"
              data-reason-sbi="{{ it.reason_sbi|default:'' }}"

              data-reasons="{% if it.reason_lines %}{{ it.reason_lines|join:'||' }}{% endif %}"
              data-sizing-reasons="{% if it.reasons_text %}{{ it.reasons_text|join:'||' }}{% endif %}"

              {# ãƒ­ãƒ¼ã‚½ã‚¯è¶³ç”¨ OHLC ï¼ˆCSVï¼‰ #}
              data-chart-open="{% if it.chart_open %}{{ it.chart_open|join:',' }}{% endif %}"
              data-chart-high="{% if it.chart_high %}{{ it.chart_high|join:',' }}{% endif %}"
              data-chart-low="{% if it.chart_low %}{{ it.chart_low|join:',' }}{% endif %}"
              data-chart-close="{% if it.chart_closes %}{{ it.chart_closes|join:',' }}{% endif %}"
              data-chart-dates="{% if it.chart_dates %}{{ it.chart_dates|join:',' }}{% endif %}"

              {# MA / VWAP / RSI ã‚‚ CSV ã§åŸ‹ã‚è¾¼ã‚€ #}
              data-chart-ma-5="{% if it.chart_ma_5 %}{{ it.chart_ma_5|join:',' }}{% endif %}"
              data-chart-ma-25="{% if it.chart_ma_25 %}{{ it.chart_ma_25|join:',' }}{% endif %}"
              data-chart-ma-75="{% if it.chart_ma_75 %}{{ it.chart_ma_75|join:',' }}{% endif %}"
              data-chart-ma-100="{% if it.chart_ma_100 %}{{ it.chart_ma_100|join:',' }}{% endif %}"
              data-chart-ma-200="{% if it.chart_ma_200 %}{{ it.chart_ma_200|join:',' }}{% endif %}"
              data-chart-vwap="{% if it.chart_vwap %}{{ it.chart_vwap|join:',' }}{% endif %}"
              data-chart-rsi="{% if it.chart_rsi %}{{ it.chart_rsi|join:',' }}{% endif %}"

              {# 52é€± / ä¸Šå ´æ¥ é«˜å®‰å€¤ï¼ˆæ°´å¹³ç·šç”¨ï¼‰ #}
              data-hi-52w="{{ it.hi_52w|default:'' }}"
              data-lo-52w="{{ it.lo_52w|default:'' }}"
              data-hi-all="{{ it.hi_all_time|default:'' }}"
              data-lo-all="{{ it.lo_all_time|default:'' }}"

              data-concern="{{ it.reason_concern|default:'' }}"
          >
            <td class="code">{{ it.code }}</td>
            <td class="td-name">
              <div class="td-name-main">{{ it.name|default:"(éŠ˜æŸ„åãªã—)" }}</div>
              <div class="sector">{{ it.sector_display|default:"æ¥­ç¨®ä¸æ˜" }}</div>
            </td>
            <td class="score
              {% if it.score_100 and it.score_100|floatformat:0 >= 80 %}score-high
              {% elif it.score_100 and it.score_100|floatformat:0 >= 60 %}score-mid
              {% else %}score-low{% endif %}">
              {% if it.score_100 is not None %}
                {{ it.score_100|floatformat:0 }}
              {% else %}â€“{% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="3" style="text-align:center;color:#9ca3af;padding:16px 8px;">
              items ãŒç©ºã§ã™ã€‚picks_build ãŒã¾ã èµ°ã£ã¦ã„ãªã„ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
<div id="pickModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card">
    <button type="button" id="modalCloseBtn" class="modal-close">Ã—</button>

    <div class="modal-header">
      <div class="modal-title" id="modalTitle">ã‚³ãƒ¼ãƒ‰ éŠ˜æŸ„å</div>
      <div class="modal-sector" id="modalSector">æ¥­ç¨®</div>
      <div class="modal-top-badges">
        <span class="badge-pill" id="modalScoreBadge">Score: â€“</span>
        <span class="badge-pill" id="modalStarBadge">â˜… â€“</span>
      </div>
    </div>

    <!-- ãƒãƒ£ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ï¼ˆä¸Š: ä¾¡æ ¼, ä¸‹: RSI, ä¸‹éƒ¨ã«å‡¡ä¾‹ï¼‰ -->
    <div class="detail-card chart-card">
      <div class="chart-inner" id="detailChartContainer">
        <div id="detailChartPriceContainer" class="chart-price-container"></div>

        <div class="rsi-title-row">
          <span class="rsi-title">RSI</span>
        </div>

        <div id="detailChartRsiContainer" class="chart-rsi-container"></div>

        <div id="chartEmptyLabel" class="chart-empty-label">
          ãƒãƒ£ãƒ¼ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™
        </div>
      </div>

      <!-- å‡¡ä¾‹ï¼šçµ‚å€¤ / å„MA / VWAP / é«˜å®‰å€¤ -->
      <div class="chart-legend">
        <div class="legend-pill legend-close">
          çµ‚å€¤ <span class="legend-value" id="legendCloseValue">â€“</span>
        </div>
        <div class="legend-pill legend-ma-5">
          5MA <span class="legend-value" id="legendMa5Value">â€“</span>
        </div>
        <div class="legend-pill legend-ma-25">
          25MA <span class="legend-value" id="legendMa25Value">â€“</span>
        </div>
        <div class="legend-pill legend-ma-75">
          75MA <span class="legend-value" id="legendMa75Value">â€“</span>
        </div>
        <div class="legend-pill legend-ma-100">
          100MA <span class="legend-value" id="legendMa100Value">â€“</span>
        </div>
        <div class="legend-pill legend-ma-200">
          200MA <span class="legend-value" id="legendMa200Value">â€“</span>
        </div>
        <div class="legend-pill legend-vwap">
          VWAP <span class="legend-value" id="legendVwapValue">â€“</span>
        </div>
        <div class="legend-pill legend-52w">
          52é€±é«˜å€¤ <span class="legend-value" id="legendHi52wValue">â€“</span>
        </div>
        <div class="legend-pill legend-52w">
          52é€±å®‰å€¤ <span class="legend-value" id="legendLo52wValue">â€“</span>
        </div>
        <div class="legend-pill legend-alltime">
          ä¸Šå ´æ¥é«˜å€¤ <span class="legend-value" id="legendHiAllValue">â€“</span>
        </div>
        <div class="legend-pill legend-alltime">
          ä¸Šå ´æ¥å®‰å€¤ <span class="legend-value" id="legendLoAllValue">â€“</span>
        </div>
      </div>
    </div>

    <!-- 2ã‚«ãƒ©ãƒ ã‚«ãƒ¼ãƒ‰ -->
    <div class="detail-grid">

      <!-- ç¾åœ¨å€¤ ï¼‹ ATR -->
      <div class="detail-card">
        <div class="detail-card-title">ç¾åœ¨å€¤</div>
        <div class="detail-main-value" id="detailLast">â€“</div>
        <div class="detail-main-sub">ATR <span id="detailAtr">â€“</span></div>
      </div>

      <!-- æ•°é‡ -->
      <div class="detail-card">
        <div class="detail-card-title">æ•°é‡</div>
        <div class="detail-row">
          <div class="detail-label">æ¥½å¤©</div>
          <div class="detail-value" id="detailQtyRakuten">â€“</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">æ¾äº•</div>
          <div class="detail-value" id="detailQtyMatsui">â€“</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value" id="detailQtySbi">â€“</div>
        </div>
        <div class="detail-row detail-row-strong">
          <div class="detail-label">åˆè¨ˆ</div>
          <div class="detail-value" id="detailQtyTotal">â€“</div>
        </div>
      </div>

      <!-- Entry / TP / SL -->
      <div class="detail-card">
        <div class="detail-card-title">Entry / TP / SL</div>
        <div class="detail-row">
          <div class="detail-label">Entry</div>
          <div class="detail-value" id="detailEntry">â€“</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">TP</div>
          <div class="detail-value" id="detailTp">â€“</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SL</div>
          <div class="detail-value" id="detailSl">â€“</div>
        </div>
      </div>

      <!-- å¿…è¦è³‡é‡‘ -->
      <div class="detail-card">
        <div class="detail-card-title">å¿…è¦è³‡é‡‘ï¼ˆæ¦‚ç®—ï¼‰</div>
        <div class="detail-row">
          <div class="detail-label">æ¥½å¤©</div>
          <div class="detail-value" id="detailCashRakuten">â€“</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">æ¾äº•</div>
          <div class="detail-value" id="detailCashMatsui">â€“</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value" id="detailCashSbi">â€“</div>
        </div>
      </div>

      <!-- æƒ³å®šåˆ©ç›Š -->
      <div class="detail-card">
        <div class="detail-card-title">æƒ³å®šåˆ©ç›Š</div>
        <div class="detail-row">
          <div class="detail-label">æ¥½å¤©</div>
          <div class="detail-value detail-green" id="detailPlRakuten">â€“</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">æ¾äº•</div>
          <div class="detail-value detail-green" id="detailPlMatsui">â€“</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value detail-green" id="detailPlSbi">â€“</div>
        </div>
        <div class="detail-row detail-row-strong">
          <div class="detail-label">åˆè¨ˆ</div>
          <div class="detail-value detail-green" id="detailPlTotal">â€“</div>
        </div>
      </div>

      <!-- æƒ³å®šæå¤± -->
      <div class="detail-card">
        <div class="detail-card-title">æƒ³å®šæå¤±</div>
        <div class="detail-row">
          <div class="detail-label">æ¥½å¤©</div>
          <div class="detail-value detail-red" id="detailLossRakuten">â€“</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">æ¾äº•</div>
          <div class="detail-value detail-red" id="detailLossMatsui">â€“</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value detail-red" id="detailLossSbi">â€“</div>
        </div>
        <div class="detail-row detail-row-strong">
          <div class="detail-label">åˆè¨ˆ</div>
          <div class="detail-value detail-red" id="detailLossTotal">â€“</div>
        </div>
      </div>

    </div>

    <!-- ç†ç”± -->
    <div class="reason-section">
      <div class="section-title">ç†ç”±</div>
      <div class="reason-block">
        <div class="reason-subtitle">é¸å®šç†ç”±ï¼ˆAIï¼‰</div>
        <ul id="detailReasonsAi" class="reason-list"></ul>

        <div class="reason-subtitle">æ•°é‡ãŒ0ã«ãªã‚‹ç†ç”±ï¼ˆç™ºæ³¨æ¡ä»¶ï¼‰</div>
        <ul id="detailReasonsSizing" class="reason-list"></ul>

        <div class="reason-subtitle">æ‡¸å¿µç‚¹</div>
        <div id="detailConcern" class="reason-concern"></div>
      </div>
    </div>

  </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js" defer></script>
<script src="{% static 'aiapp/js/picks_debug.js' %}?v=47" defer></script>
{% endblock %}