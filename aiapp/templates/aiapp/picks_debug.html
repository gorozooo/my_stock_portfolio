{% extends "base.html" %}
{% load humanize %}
{% block title %}AI Picks 診断{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#020617;
    --card:rgba(15,23,42,.94);
    --fg:#e5edff;
    --sub:#9ca3af;
    --accent:#2563eb;
    --line:rgba(148,163,184,.35);
    --ok:#22c55e;
    --bad:#ef4444;
  }
  body{background:var(--bg);color:var(--fg);}
  body.modal-open{overflow:hidden;}

  .wrap{max-width:960px;margin:0 auto;padding:16px 10px 80px;}

  .head-card{
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px 14px;
    background:radial-gradient(circle at top left,rgba(37,99,235,.25),transparent 55%),
               rgba(15,23,42,.9);
    backdrop-filter:blur(10px);
    margin-bottom:12px;
  }
  .head-top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-bottom:6px;
  }
  .title{
    font-size:18px;
    font-weight:700;
  }
  .badge{
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.9);
    white-space:nowrap;
  }
  .meta{
    font-size:12px;
    color:var(--sub);
    line-height:1.5;
  }
  .meta span+span::before{
    content:" / ";
    margin:0 2px;
  }

  .filter-row{
    display:flex;
    gap:8px;
    margin:8px 0 12px;
  }
  .filter-input{
    flex:1;
    padding:10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(15,23,42,.9);
    color:var(--fg);
    font-size:14px;
  }
  .filter-input::placeholder{color:#64748b;}
  .pill{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    color:var(--sub);
    background:rgba(15,23,42,.9);
    white-space:nowrap;
  }

  .table-wrap{
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(15,23,42,.9);
    overflow:hidden;
  }
  .table-scroller{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:12px;
    table-layout:fixed;
  }
  thead{
    background:rgba(15,23,42,1);
    position:sticky;
    top:0;
    z-index:1;
  }
  th,td{
    padding:8px 10px;
    border-bottom:1px solid rgba(30,41,59,.9);
    text-align:left;
    white-space:nowrap;
  }
  th{
    font-size:11px;
    color:#9ca3af;
    background:rgba(15,23,42,0.98);
    backdrop-filter:blur(10px);
  }
  tbody tr:nth-child(odd){
    background:rgba(15,23,42,0.9);
  }
  tbody tr:nth-child(even){
    background:rgba(15,23,42,0.96);
  }
  tbody tr:hover{
    background:rgba(30,64,175,.7);
  }
  .code{font-feature-settings:"tnum";font-weight:600;}
  .sector{color:var(--sub);font-size:11px;}
  .score{font-weight:700;text-align:right;}
  .score-high{color:#bfdbfe;}
  .score-mid{color:#a3e635;}
  .score-low{color:#f97316;}

  .td-name-main{
    display:block;
    max-width:160px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  @media (max-width:480px){
    .td-name-main{
      max-width:140px;
    }
  }

  .foot-note{
    margin-top:8px;
    font-size:11px;
    color:var(--sub);
    line-height:1.5;
  }

  /* ===== モーダル ===== */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,0.78);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:999;
  }
  .modal-backdrop.open{
    display:flex;
  }
  .modal-card{
    width:100%;
    max-width:720px;
    background:var(--card);
    border-radius:24px;
    box-shadow:0 22px 60px rgba(0,0,0,.85);
    padding:24px 18px;
    padding-top:calc(32px + env(safe-area-inset-top, 0px));
    padding-bottom:calc(96px + env(safe-area-inset-bottom, 0px));
    max-height:calc(100vh - 56px);
    overflow-y:auto;
    overscroll-behavior:contain;
  }
  .modal-close{
    position:absolute;
    top:18px;
    right:20px;
    border:none;
    background:transparent;
    color:var(--sub);
    font-size:22px;
  }
  .modal-header{
    margin-bottom:10px;
  }
  .modal-title{
    font-size:18px;
    font-weight:700;
    margin-right:32px;
  }
  .modal-sector{
    font-size:12px;
    color:var(--sub);
    margin-top:2px;
    margin-bottom:8px;
  }
  .modal-top-badges{
    display:flex;
    gap:8px;
    margin-bottom:4px;
  }
  .badge-pill{
    font-size:11px;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    background:rgba(15,23,42,.9);
  }

  .detail-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
    margin-top:8px;
    margin-bottom:16px;
  }
  @media (max-width:360px){
    .detail-grid{
      grid-template-columns:1fr;
    }
  }

  .detail-card{
    border-radius:18px;
    border:1px solid var(--line);
    padding:12px 14px;
    background:rgba(15,23,42,0.98);
    box-shadow:0 10px 26px rgba(0,0,0,.45);
  }
  .detail-card-title{
    font-size:13px;
    font-weight:600;
    margin-bottom:6px;
  }
  .detail-main-value{
    font-size:20px;
    font-weight:700;
    margin-bottom:4px;
    font-variant-numeric:tabular-nums;
  }
  .detail-main-sub{
    font-size:11px;
    color:var(--sub);
  }

  .detail-row{
    display:flex;
    justify-content:space-between;
    align-items:baseline;
    gap:8px;
    padding:1px 0;
    font-size:13px;
    line-height:1.25;
  }
  .detail-label{
    flex:0 0 auto;
    min-width:44px;
    color:var(--sub);
  }
  .detail-value{
    flex:1 0 auto;
    text-align:right;
    font-variant-numeric:tabular-nums;
  }
  .detail-row-strong .detail-label{
    font-weight:600;
  }
  .detail-row-strong .detail-value{
    font-weight:700;
  }
  .detail-green{color:var(--ok);}
  .detail-red{color:var(--bad);}

  .reason-section{
    margin-top:4px;
  }
  .section-title{
    font-size:13px;
    font-weight:600;
    padding-top:10px;
    margin:0 0 6px;
    border-top:1px solid rgba(148,163,184,.25);
  }
  .reason-block{
    font-size:12px;
    line-height:1.6;
  }
  .reason-subtitle{
    font-weight:600;
    margin-top:4px;
    margin-bottom:2px;
  }
  .reason-list{
    margin:0;
    margin-left:1.2em;
    padding-left:0.2em;
    list-style:disc;
  }
  .reason-list li{
    margin-bottom:2px;
  }
  .reason-concern{
    font-size:12px;
    color:var(--sub);
  }

  @media (max-width: 480px){
    .head-top{
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .badge{
      margin-left:auto;
      margin-top:4px;
      font-size:10px;
      padding:3px 7px;
      white-space:normal;
    }
    .filter-row{
      flex-direction:column;
      align-items:stretch;
    }
    .pill{
      align-self:flex-end;
      font-size:10px;
      padding:4px 8px;
      max-width:100%;
      white-space:normal;
      text-align:right;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="head-card">
    <div class="head-top">
      <div>
        {% if updated_at_label %}
          <div class="title">最終更新: {{ updated_at_label }}</div>
        {% endif %}

        <div class="meta">
          <span>モード: {{ meta.style|default:"aggressive" }}/{{ meta.horizon|default:"short" }}</span>
          <span>ユニバース: {{ meta.universe|default:"(不明)" }}</span>
          <span>TopK: {{ meta.topk|default:0 }}</span>
        </div>

        <div class="meta">
          総件数（ユニバース内）: {{ master_total|default:0|intcomma }} 件
        </div>
        <div class="meta">
          対象件数（フィルタ後・評価対象）: {{ meta.total|default:0|intcomma }} 件
        </div>

        {% if filter_stats %}
          <div class="meta">
            削除された銘柄:
            {% for label, val in filter_stats.items %}
              {{ label }}＝{{ val|intcomma }} 件{% if not forloop.last %} ／{% endif %}
            {% endfor %}
          </div>
        {% endif %}

        {% if source_file %}
          <div class="meta">ソース: <code style="font-size:11px">{{ source_file }}</code></div>
        {% endif %}
      </div>
      <div class="badge">DEBUG / INTERNAL</div>
    </div>

    <div class="meta">
      ※ picks_build が出力した JSON（PickItem 相当）をそのまま一覧表示します。<br>
      ※ 並び順は score_100 降順 → 株価降順です。
    </div>
  </div>

  <div class="filter-row">
    <input
      id="filterInput"
      class="filter-input"
      type="search"
      placeholder="コード・銘柄名・業種でフィルタ（例: 7203 / トヨタ / 保険）">
    <div class="pill">score 0〜100 ／ 詳細はタップでモーダル表示</div>
  </div>

  <div class="table-wrap">
    <div class="table-scroller">
      <table id="picksTable">
        <thead>
          <tr>
            <th>コード</th>
            <th>銘柄名 / 業種</th>
            <th style="text-align:right;">Score</th>
          </tr>
        </thead>
        <tbody>
        {% for it in items %}
          <tr class="pick-row"
              data-code="{{ it.code }}"
              data-name="{{ it.name|default:'(銘柄名なし)' }}"
              data-sector="{{ it.sector_display|default:'業種不明' }}"
              data-score="{{ it.score_100|default:'' }}"
              data-stars="{{ it.stars|default:0 }}"
              data-last="{{ it.last_close|default:'' }}"
              data-atr="{{ it.atr|default:'' }}"
              data-entry="{{ it.entry|default:'' }}"
              data-tp="{{ it.tp|default:'' }}"
              data-sl="{{ it.sl|default:'' }}"
              data-qty-rakuten="{{ it.qty_rakuten|default:'' }}"
              data-pl-rakuten="{{ it.est_pl_rakuten|default:'' }}"
              data-loss-rakuten="{{ it.est_loss_rakuten|default:'' }}"
              data-cash-rakuten="{{ it.required_cash_rakuten|default:'' }}"
              data-reason-rakuten="{{ it.reason_rakuten|default:'' }}"
              data-qty-matsui="{{ it.qty_matsui|default:'' }}"
              data-pl-matsui="{{ it.est_pl_matsui|default:'' }}"
              data-loss-matsui="{{ it.est_loss_matsui|default:'' }}"
              data-cash-matsui="{{ it.required_cash_matsui|default:'' }}"
              data-reason-matsui="{{ it.reason_matsui|default:'' }}"
              data-qty-sbi="{{ it.qty_sbi|default:'' }}"
              data-pl-sbi="{{ it.est_pl_sbi|default:'' }}"
              data-loss-sbi="{{ it.est_loss_sbi|default:'' }}"
              data-cash-sbi="{{ it.required_cash_sbi|default:'' }}"
              data-reason-sbi="{{ it.reason_sbi|default:'' }}"
              data-reasons="{% if it.reason_lines %}{{ it.reason_lines|join:'||' }}{% endif %}"
              data-sizing-reasons="{% if it.reasons_text %}{{ it.reasons_text|join:'||' }}{% endif %}"
              data-concern="{{ it.reason_concern|default:'' }}"
          >
            <td class="code">{{ it.code }}</td>
            <td class="td-name">
              <div class="td-name-main">{{ it.name|default:"(銘柄名なし)" }}</div>
              <div class="sector">{{ it.sector_display|default:"業種不明" }}</div>
            </td>
            <td class="score
              {% if it.score_100 and it.score_100|floatformat:0 >= 80 %}score-high
              {% elif it.score_100 and it.score_100|floatformat:0 >= 60 %}score-mid
              {% else %}score-low{% endif %}">
              {% if it.score_100 is not None %}
                {{ it.score_100|floatformat:0 }}
              {% else %}–{% endif %}
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="3" style="text-align:center;color:#9ca3af;padding:16px 8px;">
              items が空です。picks_build がまだ走っていないか、ファイル読み込みに失敗しています。
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="foot-note">
    ・行をタップすると、数量・想定PL・理由などの詳細がモーダルで表示されます。<br>
    ・score / ⭐ / 数量 / 想定PL が想定とズレていないか確認できます。<br>
    ・楽天 / 松井 / SBI の3社分と、「なぜ0株なのか」の判定理由も確認できます。
  </div>

</div>

<!-- ===== 詳細モーダル ===== -->
<div id="pickModal" class="modal-backdrop" aria-hidden="true">
  <div class="modal-card">
    <button type="button" id="modalCloseBtn" class="modal-close">×</button>

    <div class="modal-header">
      <div class="modal-title" id="modalTitle">コード 銘柄名</div>
      <div class="modal-sector" id="modalSector">業種</div>
      <div class="modal-top-badges">
        <span class="badge-pill" id="modalScoreBadge">Score: –</span>
        <span class="badge-pill" id="modalStarBadge">★ –</span>
      </div>
    </div>

    <div class="detail-grid">

      <!-- 現在値 ＋ ATR -->
      <div class="detail-card">
        <div class="detail-card-title">現在値</div>
        <div class="detail-main-value" id="detailLast">–</div>
        <div class="detail-main-sub">ATR <span id="detailAtr">–</span></div>
      </div>

      <!-- 数量 -->
      <div class="detail-card">
        <div class="detail-card-title">数量</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value" id="detailQtyRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value" id="detailQtyMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value" id="detailQtySbi">–</div>
        </div>
        <div class="detail-row detail-row-strong">
          <div class="detail-label">合計</div>
          <div class="detail-value" id="detailQtyTotal">–</div>
        </div>
      </div>

      <!-- Entry / TP / SL -->
      <div class="detail-card">
        <div class="detail-card-title">Entry / TP / SL</div>
        <div class="detail-row">
          <div class="detail-label">Entry</div>
          <div class="detail-value" id="detailEntry">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">TP</div>
          <div class="detail-value" id="detailTp">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SL</div>
          <div class="detail-value" id="detailSl">–</div>
        </div>
      </div>

      <!-- 必要資金 -->
      <div class="detail-card">
        <div class="detail-card-title">必要資金（概算）</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value" id="detailCashRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value" id="detailCashMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value" id="detailCashSbi">–</div>
        </div>
      </div>

      <!-- 想定利益 -->
      <div class="detail-card">
        <div class="detail-card-title">想定利益</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value detail-green" id="detailPlRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value detail-green" id="detailPlMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value detail-green" id="detailPlSbi">–</div>
        </div>
        <div class="detail-row detail-row-strong">
          <div class="detail-label">合計</div>
          <div class="detail-value detail-green" id="detailPlTotal">–</div>
        </div>
      </div>

      <!-- 想定損失 -->
      <div class="detail-card">
        <div class="detail-card-title">想定損失</div>
        <div class="detail-row">
          <div class="detail-label">楽天</div>
          <div class="detail-value detail-red" id="detailLossRakuten">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">松井</div>
          <div class="detail-value detail-red" id="detailLossMatsui">–</div>
        </div>
        <div class="detail-row">
          <div class="detail-label">SBI</div>
          <div class="detail-value detail-red" id="detailLossSbi">–</div>
        </div>
        <div class="detail-row detail-row-strong">
          <div class="detail-label">合計</div>
          <div class="detail-value detail-red" id="detailLossTotal">–</div>
        </div>
      </div>

    </div>

    <!-- 理由 -->
    <div class="reason-section">
      <div class="section-title">理由</div>
      <div class="reason-block">
        <div class="reason-subtitle">選定理由（AI）</div>
        <ul id="detailReasonsAi" class="reason-list"></ul>

        <div class="reason-subtitle">数量が0になる理由（発注条件）</div>
        <ul id="detailReasonsSizing" class="reason-list"></ul>

        <div class="reason-subtitle">懸念点</div>
        <div id="detailConcern" class="reason-concern"></div>
      </div>
    </div>

  </div>
</div>

<script>
(function(){
  const input = document.getElementById("filterInput");
  const table = document.getElementById("picksTable");

  if (input && table){
    const rows = Array.from(table.querySelectorAll("tbody tr"));
    input.addEventListener("input", function(){
      const q = this.value.trim().toLowerCase();
      if (!q){
        rows.forEach(r => r.style.display = "");
        return;
      }
      rows.forEach(r => {
        const text = r.textContent.toLowerCase();
        r.style.display = text.includes(q) ? "" : "none";
      });
    });
  }

  const body   = document.body;
  const modal  = document.getElementById("pickModal");
  const closeBtn = document.getElementById("modalCloseBtn");
  if (!modal || !table) return;

  function setText(id, v, fmt){
    const el = document.getElementById(id);
    if (!el) return;
    if (v === undefined || v === null || v === "" || v === "NaN"){
      el.textContent = "–";
      return;
    }
    let txt = v;
    if (fmt === "int"){
      const n = Number(v);
      txt = isNaN(n) ? "–" : n.toLocaleString();
    }else if (fmt === "yen"){
      const n = Number(v);
      if (isNaN(n)){
        txt = "–";
      }else{
        txt = n.toLocaleString();
        if (n > 0) txt = "+" + txt;
      }
    }
    el.textContent = txt;
  }

  function openModal(row){
    const ds = row.dataset || {};

    document.getElementById("modalTitle").textContent =
      (ds.code || "") + " " + (ds.name || "");
    document.getElementById("modalSector").textContent = ds.sector || "";

    document.getElementById("modalScoreBadge").textContent =
      "Score: " + (ds.score || "–");
    document.getElementById("modalStarBadge").textContent =
      "★ " + (ds.stars || "–");

    // 価格・指標
    setText("detailLast", ds.last, "int");
    setText("detailAtr", ds.atr, "int");

    // 数量
    setText("detailQtyRakuten", ds.qtyRakuten, "int");
    setText("detailQtyMatsui", ds.qtyMatsui, "int");
    setText("detailQtySbi", ds.qtySbi, "int");

    // Entry / TP / SL
    setText("detailEntry", ds.entry, "int");
    setText("detailTp", ds.tp, "int");
    setText("detailSl", ds.sl, "int");

    // 必要資金
    setText("detailCashRakuten", ds.cashRakuten, "yen");
    setText("detailCashMatsui", ds.cashMatsui, "yen");
    setText("detailCashSbi", ds.cashSbi, "yen");

    // 想定PL
    setText("detailPlRakuten", ds.plRakuten, "yen");
    setText("detailPlMatsui", ds.plMatsui, "yen");
    setText("detailPlSbi", ds.plSbi, "yen");

    // 想定損失
    setText("detailLossRakuten", ds.lossRakuten, "yen");
    setText("detailLossMatsui", ds.lossMatsui, "yen");
    setText("detailLossSbi", ds.lossSbi, "yen");

    // 合計
    const qtyTotal =
      (Number(ds.qtyRakuten || 0) || 0) +
      (Number(ds.qtyMatsui || 0) || 0) +
      (Number(ds.qtySbi || 0) || 0);
    const plTotal =
      (Number(ds.plRakuten || 0) || 0) +
      (Number(ds.plMatsui || 0) || 0) +
      (Number(ds.plSbi || 0) || 0);
    const lossTotal =
      (Number(ds.lossRakuten || 0) || 0) +
      (Number(ds.lossMatsui || 0) || 0) +
      (Number(ds.lossSbi || 0) || 0);

    setText("detailQtyTotal", qtyTotal, "int");
    setText("detailPlTotal", plTotal, "yen");
    setText("detailLossTotal", lossTotal, "yen");

    // 理由（AI）
    const ulAi = document.getElementById("detailReasonsAi");
    ulAi.innerHTML = "";
    if (ds.reasons){
      ds.reasons.split("||").forEach(function(t){
        t = (t || "").trim();
        if (!t) return;
        const li = document.createElement("li");
        li.textContent = t;
        ulAi.appendChild(li);
      });
    }

    // 理由（数量0など発注条件）
    const ulSizing = document.getElementById("detailReasonsSizing");
    ulSizing.innerHTML = "";
    if (ds.sizingReasons){
      ds.sizingReasons.split("||").forEach(function(t){
        t = (t || "").trim();
        if (!t) return;
        // sizing_service 側で "・楽天: ..." のように付けているので、
        // 先頭の "・" があれば削る（見た目を整える）
        if (t[0] === "・"){
          t = t.slice(1).trim();
        }
        const li = document.createElement("li");
        li.textContent = t;
        ulSizing.appendChild(li);
      });
    }

    document.getElementById("detailConcern").textContent =
      ds.concern || "";

    modal.classList.add("open");
    body.classList.add("modal-open");
  }

  function closeModal(){
    modal.classList.remove("open");
    body.classList.remove("modal-open");
  }

  table.querySelectorAll("tbody tr").forEach(function(row){
    row.addEventListener("click", function(){
      if (!this.dataset.code) return;
      openModal(this);
    });
  });

  modal.addEventListener("click", function(e){
    if (e.target === modal){
      closeModal();
    }
  });
  if (closeBtn){
    closeModal();
    closeBtn.addEventListener("click", closeModal);
  }
})();
</script>

{% endblock %}