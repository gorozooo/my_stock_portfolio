{% extends "base.html" %}
{% load humanize %}
{% block title %}AI Picks 診断{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#020617;
    --card:rgba(15,23,42,.9);
    --fg:#e5edff;
    --sub:#9ca3af;
    --accent:#2563eb;
    --line:rgba(148,163,184,.35);
    --ok:#22c55e;
    --bad:#ef4444;
  }
  body{background:var(--bg);color:var(--fg);}
  .wrap{max-width:960px;margin:0 auto;padding:16px 10px 80px;}

  .head-card{
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px 14px;
    background:radial-gradient(circle at top left,rgba(37,99,235,.25),transparent 55%),
               rgba(15,23,42,.9);
    backdrop-filter:blur(10px);
    margin-bottom:12px;
  }
  .head-top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    margin-bottom:6px;
  }
  .title{
    font-size:18px;
    font-weight:700;
  }
  .badge{
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(15,23,42,.9);
    white-space:nowrap;
  }
  .meta{
    font-size:12px;
    color:var(--sub);
    line-height:1.5;
  }
  .meta span+span::before{
    content:" / ";
    margin:0 2px;
  }

  .filter-row{
    display:flex;
    gap:8px;
    margin:8px 0 12px;
  }
  .filter-input{
    flex:1;
    padding:10px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(15,23,42,.9);
    color:var(--fg);
    font-size:14px;
  }
  .filter-input::placeholder{color:#64748b;}
  .pill{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--line);
    color:var(--sub);
    background:rgba(15,23,42,.9);
    white-space:nowrap;
  }

  .table-wrap{
    border:1px solid var(--line);
    border-radius:16px;
    background:rgba(15,23,42,.9);
    overflow:hidden;
  }
  .table-scroller{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:12px;
  }
  thead{
    background:rgba(15,23,42,1);
    position:sticky;
    top:0;
    z-index:1;
  }
  th,td{
    padding:8px 10px;
    border-bottom:1px solid rgba(30,41,59,.9);
    white-space:nowrap;
  }
  th:first-child,
  td:first-child{text-align:left;width:76px;}
  th:nth-child(2),
  td:nth-child(2){text-align:left;}
  th:nth-child(3),
  td:nth-child(3){text-align:right;width:74px;}
  th{
    font-size:11px;
    color:#9ca3af;
    background:rgba(15,23,42,0.98);
    backdrop-filter:blur(10px);
  }
  tbody tr:nth-child(odd){
    background:rgba(15,23,42,0.9);
  }
  tbody tr:nth-child(even){
    background:rgba(15,23,42,0.96);
  }
  tbody tr.pick-row:hover{
    background:rgba(30,64,175,.7);
  }
  .code{font-feature-settings:"tnum";font-weight:600;}
  .sector{color:var(--sub);font-size:11px;}

  .score-cell{
    text-align:right;
    font-size:11px;
  }
  .score-badge{
    display:inline-block;
    min-width:30px;
    padding:2px 6px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    margin-right:4px;
    text-align:center;
    font-feature-settings:"tnum";
  }
  .score-star{
    font-size:11px;
    color:#facc15;
  }

  .zero{color:#64748b;}

  .foot-note{
    margin-top:8px;
    font-size:11px;
    color:var(--sub);
    line-height:1.5;
  }

  /* ===== 理由ブロック（元のレイアウトをそのまま再利用） ===== */
  .reason-block{
    font-size:11px;
    color:#cbd5f5;
    line-height:1.5;
  }
  .reason-title{
    font-weight:600;
    margin-top:2px;
    margin-bottom:2px;
    color:#e2e8f0;
  }
  .reason-list{
    margin:0 0 4px 1.2em;
    padding:0;
  }
  .reason-list li{
    margin:0;
    padding:0;
    list-style:disc;
  }
  .reason-text{
    margin:0 0 4px;
  }

  /* hidden 行はテーブル上では非表示 */
  tr.reason-source-row{
    display:none;
  }

  /* ===== モーダル（ボトムシート） ===== */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,.75);
    backdrop-filter:blur(6px);
    display:none;
    align-items:flex-end;
    justify-content:center;
    z-index:80;
    overscroll-behavior:contain;
  }
  .modal-backdrop.show{
    display:flex;
  }
  .modal-card{
    width:100%;
    max-width:720px;
    background:var(--card);
    border-radius:18px 18px 0 0;
    box-shadow:0 -18px 45px rgba(0,0,0,.7);
    padding:14px 16px 22px;
    max-height:85vh;
    overflow-y:auto;
  }
  .modal-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
    margin-bottom:6px;
  }
  .modal-title-main{
    font-size:16px;
    font-weight:700;
  }
  .modal-title-sub{
    font-size:11px;
    color:var(--sub);
  }
  .modal-close{
    border:none;
    background:transparent;
    color:#9ca3af;
    font-size:22px;
    line-height:1;
    padding:2px 6px;
    cursor:pointer;
  }
  .modal-meta{
    font-size:11px;
    color:var(--sub);
    display:flex;
    flex-wrap:wrap;
    gap:4px 8px;
    margin-bottom:8px;
  }
  .modal-chip{
    border-radius:999px;
    border:1px solid rgba(148,163,184,.6);
    padding:2px 8px;
  }
  .modal-section{
    margin-top:10px;
    margin-bottom:4px;
    border-top:1px solid rgba(148,163,184,.25);
    padding-top:6px;
  }
  .modal-sec-title{
    font-size:12px;
    font-weight:600;
    margin-bottom:4px;
    color:#e2e8f0;
  }
  .modal-dl{
    display:grid;
    grid-template-columns:auto 1fr;
    gap:4px 10px;
    font-size:12px;
  }
  .modal-dl dt{
    color:#9ca3af;
  }
  .modal-dl dd{
    margin:0;
    text-align:right;
  }

  /* ===== 背景スクロールロック用 ===== */
  body.modal-open{
    overflow:hidden;
    overscroll-behavior:none;
    touch-action:none;
  }

  /* ===== スマホ幅調整 ===== */
  @media (max-width: 480px){
    .head-top{
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .badge{
      margin-left:auto;
      margin-top:4px;
      font-size:10px;
      padding:3px 7px;
      white-space:normal;
    }
    .filter-row{
      flex-direction:column;
      align-items:stretch;
    }
    .pill{
      align-self:flex-end;
      font-size:10px;
      padding:4px 8px;
      max-width:100%;
      white-space:normal;
      text-align:right;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="head-card">
    <div class="head-top">
      <div>
        {% if updated_at_label %}
          <div class="title">最終更新: {{ updated_at_label }}</div>
        {% else %}
          <div class="title">AI Picks 診断ビュー</div>
        {% endif %}

        <!-- モード / ユニバース -->
        <div class="meta">
          <span>モード: {{ meta.style|default:"aggressive" }}/{{ meta.horizon|default:"short" }}</span>
          <span>ユニバース: {{ meta.universe|default:"(不明)" }}</span>
          <span>TopK: {{ meta.topk|default:0 }}</span>
        </div>

        <!-- 件数まわり（総件数 / 対象件数） -->
        <div class="meta">
          {% with total_all=meta.stockmaster_total|default:meta.total %}
            <span>総件数（ユニバース内）: {{ total_all|default:0|intcomma }} 件</span>
          {% endwith %}
        </div>
        <div class="meta">
          対象件数（フィルタ後・評価対象）: {{ meta.total|default:0|intcomma }} 件
        </div>

        <!-- フィルタ削除件数（日本語ラベル） -->
        {% if filter_stats %}
          <div class="meta">
            削除された銘柄:
            {% for label, val in filter_stats.items %}
              {{ label }}＝{{ val|intcomma }} 件{% if not forloop.last %} ／{% endif %}
            {% endfor %}
          </div>
        {% endif %}

        {% if source_file %}
          <div class="meta">ソース: <code style="font-size:11px">{{ source_file }}</code></div>
        {% endif %}
      </div>

      <div class="badge">DEBUG / INTERNAL</div>
    </div>

    <div class="meta">
      ※ picks_build が出力した JSON（PickItem 相当）をそのまま一覧表示します。<br>
      ※ 並び順は score_100 降順 → 株価降順です。
    </div>
  </div>

  <div class="filter-row">
    <input
      id="filterInput"
      class="filter-input"
      type="search"
      placeholder="コード・銘柄名・業種でフィルタ（例: 7203 / トヨタ / 保険）">
    <div class="pill">タップで詳細（Score / 価格 / 理由 など）を表示</div>
  </div>

  <div class="table-wrap">
    <div class="table-scroller">
      <table id="picksTable">
        <thead>
          <tr>
            <th>コード</th>
            <th>銘柄名 / 業種</th>
            <th>Score / ⭐</th>
          </tr>
        </thead>
        <tbody>

        {% for it in items %}
          <tr class="pick-row"
              data-code="{{ it.code }}"
              data-name="{{ it.name|default:'(銘柄名なし)' }}"
              data-sector="{{ it.sector_display|default:'業種不明' }}"
              data-score="{{ it.score_100|default:'' }}"
              data-stars="{{ it.stars|default:'' }}"
              data-last="{{ it.last_close|default:'' }}"
              data-atr="{{ it.atr|default:'' }}"
              data-entry="{{ it.entry|default:'' }}"
              data-tp="{{ it.tp|default:'' }}"
              data-sl="{{ it.sl|default:'' }}"
              data-qty-total="{{ it.qty_total|default:'' }}"
              data-pl-total="{{ it.pl_total|default:'' }}"
              data-loss-total="{{ it.loss_total|default:'' }}">
            <td class="code">{{ it.code }}</td>
            <td>
              <div>{{ it.name|default:"(銘柄名なし)" }}</div>
              <div class="sector">{{ it.sector_display|default:"業種不明" }}</div>
            </td>
            <td class="score-cell">
              {% if it.score_100 is not None or it.stars %}
                <span class="score-badge">
                  {% if it.score_100 is not None %}
                    {{ it.score_100|floatformat:0 }}
                  {% else %}
                    —
                  {% endif %}
                </span>
                <span class="score-star">
                  {% if it.stars %}{{ it.stars }}★{% else %}–{% endif %}
                </span>
              {% else %}
                <span class="zero">–</span>
              {% endif %}
            </td>
          </tr>

          <!-- 理由ブロックのソース（テーブルでは非表示） -->
          <tr class="reason-source-row">
            <td colspan="3">
              <div class="reason-block-source">
                {% if it.reason_lines or it.reason_concern or it.reasons_text or it.reason_rakuten or it.reason_matsui %}
                  <div class="reason-block">
                    {% if it.reason_lines %}
                      <div class="reason-title">選定理由</div>
                      <ul class="reason-list">
                        {% for line in it.reason_lines %}
                          <li>{{ line }}</li>
                        {% endfor %}
                      </ul>
                    {% endif %}

                    {% if it.reason_concern %}
                      <div class="reason-title">懸念ポイント</div>
                      <p class="reason-text">{{ it.reason_concern }}</p>
                    {% endif %}

                    {% if it.reasons_text %}
                      <div class="reason-title">数量・サイズ関連メモ</div>
                      {% if it.reasons_text|length == 1 %}
                        <p class="reason-text">{{ it.reasons_text.0 }}</p>
                      {% else %}
                        <ul class="reason-list">
                          {% for line in it.reasons_text %}
                            <li>{{ line }}</li>
                          {% endfor %}
                        </ul>
                      {% endif %}
                    {% endif %}

                    {% if it.reason_rakuten or it.reason_matsui %}
                      <div class="reason-title">証券会社別メモ</div>
                      {% if it.reason_rakuten %}
                        <p class="reason-text">楽天: {{ it.reason_rakuten }}</p>
                      {% endif %}
                      {% if it.reason_matsui %}
                        <p class="reason-text">松井: {{ it.reason_matsui }}</p>
                      {% endif %}
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            </td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="3" style="text-align:center;color:#9ca3af;padding:16px 8px;">
              items が空です。picks_build がまだ走っていないか、ファイル読み込みに失敗しています。
            </td>
          </tr>
        {% endfor %}

        </tbody>
      </table>
    </div>
  </div>

  <div class="foot-note">
    ・この画面は開発者向けの診断ビューです。<br>
    ・行をタップすると、Score / 価格・ATR / Entry・TP・SL / 想定PL / 各種理由をモーダルで確認できます。<br>
    ・コード・銘柄名・業種で瞬間フィルタが可能です。
  </div>

</div>

<!-- ===== モーダル本体 ===== -->
<div id="pickModal" class="modal-backdrop">
  <div class="modal-card">
    <div class="modal-header">
      <div>
        <div class="modal-title-main">
          <span id="mCode" class="code"></span>
          <span id="mName"></span>
        </div>
        <div class="modal-title-sub" id="mSector"></div>
      </div>
      <button id="mClose" class="modal-close" type="button">&times;</button>
    </div>

    <div class="modal-meta">
      <span class="modal-chip" id="mScoreChip"></span>
      <span class="modal-chip" id="mStarsChip"></span>
    </div>

    <div class="modal-section">
      <div class="modal-sec-title">価格・指標</div>
      <dl class="modal-dl">
        <dt>Score</dt><dd id="mScore"></dd>
        <dt>⭐</dt><dd id="mStars"></dd>
        <dt>現在値</dt><dd id="mLast"></dd>
        <dt>ATR</dt><dd id="mAtr"></dd>
        <dt>Entry</dt><dd id="mEntry"></dd>
        <dt>TP</dt><dd id="mTp"></dd>
        <dt>SL</dt><dd id="mSl"></dd>
      </dl>
    </div>

    <div class="modal-section">
      <div class="modal-sec-title">数量・想定PL</div>
      <dl class="modal-dl">
        <dt>数量 合計</dt><dd id="mQty"></dd>
        <dt>想定利益 合計</dt><dd id="mPl"></dd>
        <dt>想定損失 合計</dt><dd id="mLoss"></dd>
      </dl>
    </div>

    <div class="modal-section">
      <div class="modal-sec-title">理由</div>
      <div id="mReasons"></div>
    </div>
  </div>
</div>

<script>
(function(){
  const input = document.getElementById("filterInput");
  const table = document.getElementById("picksTable");
  if (!table) return;

  const pickRows = Array.from(table.querySelectorAll("tbody tr.pick-row"));
  const allRows = Array.from(table.querySelectorAll("tbody tr"));

  // ===== フィルタ =====
  if (input) {
    input.addEventListener("input", function(){
      const q = this.value.trim().toLowerCase();
      if (!q){
        allRows.forEach(r => {
          if (r.classList.contains("reason-source-row")){
            r.style.display = "none";
          } else {
            r.style.display = "";
          }
        });
        return;
      }
      pickRows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const show = text.includes(q);
        row.style.display = show ? "" : "none";
        const src = row.nextElementSibling;
        if (src && src.classList.contains("reason-source-row")) {
          src.style.display = "none";  // 常に非表示
        }
      });
    });
  }

  // ===== モーダル =====
  const modal = document.getElementById("pickModal");
  const mClose = document.getElementById("mClose");

  const mCode = document.getElementById("mCode");
  const mName = document.getElementById("mName");
  const mSector = document.getElementById("mSector");
  const mScoreChip = document.getElementById("mScoreChip");
  const mStarsChip = document.getElementById("mStarsChip");

  const mScore = document.getElementById("mScore");
  const mStars = document.getElementById("mStars");
  const mLast = document.getElementById("mLast");
  const mAtr = document.getElementById("mAtr");
  const mEntry = document.getElementById("mEntry");
  const mTp = document.getElementById("mTp");
  const mSl = document.getElementById("mSl");

  const mQty = document.getElementById("mQty");
  const mPl = document.getElementById("mPl");
  const mLoss = document.getElementById("mLoss");
  const mReasons = document.getElementById("mReasons");

  const nf0 = new Intl.NumberFormat("ja-JP", { maximumFractionDigits: 0 });
  const nf1 = new Intl.NumberFormat("ja-JP", { maximumFractionDigits: 1 });

  function parseNum(v){
    if (v === undefined || v === null || v === "" || v === "None") return null;
    const n = Number(v);
    if (!isFinite(n)) return null;
    return n;
  }

  function fmt0(v){
    const n = parseNum(v);
    if (n === null) return "—";
    return nf0.format(n);
  }

  function fmtSigned(v){
    const n = parseNum(v);
    if (n === null) return "—";
    const s = nf0.format(Math.abs(n));
    return (n > 0 ? "+" : n < 0 ? "-" : "") + s;
  }

  function openModalForRow(row){
    const ds = row.dataset;

    mCode.textContent = ds.code || "";
    mName.textContent = ds.name || "";
    mSector.textContent = ds.sector || "";

    const score = parseNum(ds.score);
    const stars = ds.stars || "";
    mScore.textContent = score !== null ? nf0.format(score) : "—";
    mStars.textContent = stars || "—";

    mScoreChip.textContent = score !== null ? `Score: ${nf0.format(score)}` : "Score: —";
    mStarsChip.textContent = stars ? `⭐ ${stars}` : "⭐ —";

    mLast.textContent = fmt0(ds.last);
    mAtr.textContent = fmt0(ds.atr);
    mEntry.textContent = fmt0(ds.entry);
    mTp.textContent = fmt0(ds.tp);
    mSl.textContent = fmt0(ds.sl);

    const qty = parseNum(ds.qtyTotal);
    mQty.textContent = qty !== null ? nf0.format(qty) : "—";
    mPl.textContent = fmtSigned(ds.plTotal);
    mLoss.textContent = fmtSigned(ds.lossTotal);

    // 理由（hidden 行から HTML をコピー）
    let reasonHtml = "";
    const src = row.nextElementSibling;
    if (src && src.classList.contains("reason-source-row")) {
      const block = src.querySelector(".reason-block-source");
      if (block) {
        reasonHtml = block.innerHTML;
      }
    }
    mReasons.innerHTML = reasonHtml || "<p class=\"reason-text\">理由情報はありません。</p>";

    modal.classList.add("show");
    document.body.classList.add("modal-open");
  }

  function closeModal(){
    modal.classList.remove("show");
    document.body.classList.remove("modal-open");
  }

  pickRows.forEach(row => {
    row.addEventListener("click", function(){
      openModalForRow(this);
    });
  });

  if (mClose) {
    mClose.addEventListener("click", closeModal);
  }
  if (modal) {
    modal.addEventListener("click", function(e){
      if (e.target === modal){
        closeModal();
      }
    });

    // 背景スクロール防止（モーダル外タッチのみ抑止）
    modal.addEventListener("touchmove", function(e){
      if (e.target === modal){
        e.preventDefault();
      }
    }, { passive:false });
  }
})();
</script>

{% endblock %}