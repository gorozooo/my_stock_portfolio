{% extends "base.html" %}
{% load humanize %}

{% block title %}AI 行動ダッシュボード{% endblock %}

{% block head %}
<style>
:root{
  --bg:#020617;
  --card:rgba(15,23,42,0.96);
  --sub:#9ca3af;
  --fg:#e5e7eb;
  --accent:#38bdf8;
  --ok:#22c55e;
  --bad:#f97373;
  --muted:#64748b;
  --border:rgba(148,163,184,0.45);
}
body{background:var(--bg);color:var(--fg);}
.wrap{max-width:720px;margin:0 auto;padding:14px 14px 80px;}

.section{
  margin-top:14px;
  padding:14px;
  border-radius:18px;
  border:1px solid var(--border);
  background:
    radial-gradient(circle at top left,rgba(56,189,248,0.22),transparent 55%),
    radial-gradient(circle at bottom right,rgba(15,23,42,0.95),rgba(15,23,42,0.98));
  backdrop-filter:blur(16px);
}

/* ヘッダー */
.head-title{font-size:18px;font-weight:750;margin-bottom:4px;}
.head-sub{font-size:12px;color:#cbd5f5;line-height:1.5;}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:10px;}
.kpi-card{border-radius:14px;border:1px solid rgba(148,163,184,0.6);background:rgba(15,23,42,0.98);padding:8px 10px;font-size:11px;}
.kpi-label{color:var(--muted);margin-bottom:4px;}
.kpi-value{font-size:16px;font-weight:700;font-variant-numeric:tabular-nums;}
.kpi-sub{font-size:11px;color:var(--sub);}

/* key-value */
.kv-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px 12px;}
.kv-row{display:flex;justify-content:space-between;font-size:13px;}
.kv-key{color:var(--sub);}
.kv-val{font-variant-numeric:tabular-nums;}

/* バッジ */
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(148,163,184,0.7);background:rgba(15,23,42,0.9);}

/* インサイト */
.insight-list{margin:4px 0 0 0;padding-left:18px;font-size:12px;}
.insight-list li{margin-bottom:4px;}

/* セクター */
.sector-row{display:flex;justify-content:space-between;align-items:center;font-size:12px;padding:6px 0;border-bottom:1px dashed rgba(148,163,184,0.35);}
.sector-row:last-child{border-bottom:none;}
.sector-name{max-width:48%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sector-meta{text-align:right;font-variant-numeric:tabular-nums;}

/* 分布 */
.dist-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:6px 12px;}
.dist-item{border-radius:10px;border:1px solid rgba(148,163,184,0.4);padding:6px 8px;background:rgba(15,23,42,0.98);font-size:11px;}
.dist-label{color:var(--muted);margin-bottom:2px;}
.dist-val{font-variant-numeric:tabular-nums;}

/* TOP */
.list-item{margin-top:8px;padding:10px;border-radius:14px;border:1px solid rgba(148,163,184,0.45);background:rgba(15,23,42,0.98);}
.code-name{font-size:13px;font-weight:650;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sub-line{font-size:11px;color:var(--sub);display:flex;justify-content:space-between;}
.pl-pos{color:var(--ok);}
.pl-neg{color:var(--bad);}

/* 行動モデル */
.model-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px 10px;}
.model-block{border-radius:12px;border:1px solid rgba(148,163,184,0.5);padding:8px;background:rgba(15,23,42,0.98);font-size:11px;}
.model-title{font-size:12px;font-weight:600;margin-bottom:3px;}
.model-row{display:flex;justify-content:space-between;}
.model-key{color:var(--muted);}
.model-val{font-variant-numeric:tabular-nums;}
</style>
{% endblock %}

{% block content %}
<div class="wrap">

{% if not has_data %}
  <div class="section">
    まだ AI シミュレの行動データがありません。
  </div>
{% else %}

<!-- ヘッダー -->
<div class="section">
  <div class="head-title">AI 行動ダッシュボード（PRO）</div>
  <div class="head-sub">
    PRO口座でのシミュレ結果をもとに、あなたのトレード傾向を分析しています。
  </div>

  <!-- KPI -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-label">勝率</div>
      <div class="kpi-value">
        {% if kpi_win_rate %}{{ kpi_win_rate|floatformat:1 }}%{% else %}-{% endif %}
      </div>
      <div class="kpi-sub">win / lose</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">平均R</div>
      <div class="kpi-value">
        {% if kpi_avg_r %}{{ kpi_avg_r|floatformat:2 }}{% else %}-{% endif %}
      </div>
      <div class="kpi-sub">1トレードあたり</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">平均利益</div>
      <div class="kpi-value">
        {% if kpi_avg_win %}+{{ kpi_avg_win|floatformat:0|intcomma }}円{% else %}-{% endif %}
      </div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">平均損失</div>
      <div class="kpi-value">
        {% if kpi_avg_loss %}{{ kpi_avg_loss|floatformat:0|intcomma }}円{% else %}-{% endif %}
      </div>
    </div>
  </div>

  <!-- 件数 -->
  <div style="margin-top:12px;" class="kv-grid">
    <div class="kv-row"><div class="kv-key">総トレード</div><div class="kv-val">{{ total }}</div></div>
    <div class="kv-row"><div class="kv-key">LIVE</div><div class="kv-val">{{ mode_counts.live }}</div></div>
    <div class="kv-row"><div class="kv-key">DEMO</div><div class="kv-val">{{ mode_counts.demo }}</div></div>
    <div class="kv-row"><div class="kv-key">その他</div><div class="kv-val">{{ mode_counts.other }}</div></div>
  </div>
</div>

<!-- 勝敗サマリ -->
<div class="section">
  <div class="head-title">勝敗サマリ（PRO）</div>
  <div class="kv-grid">
    <div class="kv-row"><div class="kv-key">勝ち</div><div class="kv-val">{{ pl_counts.win|default:0 }}</div></div>
    <div class="kv-row"><div class="kv-key">負け</div><div class="kv-val">{{ pl_counts.lose|default:0 }}</div></div>
    <div class="kv-row"><div class="kv-key">引き分け</div><div class="kv-val">{{ pl_counts.flat|default:0 }}</div></div>
    <div class="kv-row"><div class="kv-key">ポジションなし</div><div class="kv-val">{{ pl_counts.no_position|default:0 }}</div></div>
  </div>
</div>

<!-- セクター -->
<div class="section">
  <div class="head-title">セクター別勝率（PRO）</div>
  {% for s in sector_stats %}
    <div class="sector-row">
      <div class="sector-name">{{ s.name }}</div>
      <div class="sector-meta">
        {{ s.wins }}/{{ s.trials }}（{{ s.win_rate|floatformat:1 }}%）
      </div>
    </div>
  {% empty %}
    <div style="font-size:12px;color:var(--sub);">データがまだありません。</div>
  {% endfor %}
</div>

<!-- 相性 -->
<div class="section">
  <div class="head-title">相性マップ</div>
  <div class="dist-grid">
    {% for t in trend_stats %}
      <div class="dist-item">
        <div class="dist-label">トレンド：{{ t.name }}</div>
        <div class="dist-val">{{ t.count }} 件</div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- TOP -->
<div class="section">
  <div class="head-title">TOP 勝ちトレード（PRO）</div>
  {% for r in top_win %}
    <div class="list-item">
      <div class="code-name">{{ r.code }} {{ r.name }}</div>
      <div class="sub-line">
        <span class="pl-pos">+{{ r.pl|floatformat:0|intcomma }}円</span>
        <span>{{ r.mode }} / {{ r.ts_label }}</span>
      </div>
    </div>
  {% empty %}
    <div style="font-size:12px;color:var(--sub);">まだありません。</div>
  {% endfor %}
</div>

<div class="section">
  <div class="head-title">TOP 負けトレード（PRO）</div>
  {% for r in top_lose %}
    <div class="list-item">
      <div class="code-name">{{ r.code }} {{ r.name }}</div>
      <div class="sub-line">
        <span class="pl-neg">{{ r.pl|floatformat:0|intcomma }}円</span>
        <span>{{ r.mode }} / {{ r.ts_label }}</span>
      </div>
    </div>
  {% empty %}
    <div style="font-size:12px;color:var(--sub);">まだありません。</div>
  {% endfor %}
</div>

{% endif %}
</div>
{% endblock %}