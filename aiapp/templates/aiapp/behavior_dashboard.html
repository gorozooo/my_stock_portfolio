{% extends "base.html" %}
{% load humanize %}

{% block title %}AI 行動ダッシュボード{% endblock %}

{% block head %}
<style>
:root{
  /* 明るめ（でも目が痛くならない） */
  --bg:#0b1220;
  --bg2:#111c33;
  --card:rgba(255,255,255,0.10);
  --card2:rgba(255,255,255,0.14);
  --fg:#0b1020;
  --txt:#0b1020;
  --txt2:rgba(11,16,32,0.70);
  --line:rgba(11,16,32,0.12);

  --ink:#0b1020;
  --white:#ffffff;

  --accent:#2dd4bf;
  --accent2:#60a5fa;
  --accent3:#f472b6;

  --ok:#16a34a;
  --bad:#ef4444;
  --muted:#64748b;

  --pill:rgba(255,255,255,0.70);
  --shadow:0 12px 30px rgba(2,6,23,0.18);

  /* テロップ速度（秒） */
  --ticker-sec: 12;
}

body{
  background:
    radial-gradient(1200px 600px at 12% 12%, rgba(96,165,250,0.18), transparent 55%),
    radial-gradient(900px 500px at 88% 18%, rgba(45,212,191,0.16), transparent 55%),
    radial-gradient(800px 500px at 70% 88%, rgba(244,114,182,0.14), transparent 60%),
    linear-gradient(180deg, var(--bg), var(--bg2));
  color: var(--ink);
}

.wrap{
  max-width: 880px;
  margin: 0 auto;
  padding: 14px 12px 92px;
}

/* ===== 上部バー（今日 + テロップ） ===== */
.topbar{
  position: sticky;
  top: 0;
  z-index: 30;
  padding-top: 10px;
  padding-bottom: 8px;
  background: linear-gradient(180deg, rgba(11,18,32,0.92), rgba(11,18,32,0.75), rgba(11,18,32,0.00));
  backdrop-filter: blur(10px);
}

.topbar-inner{
  display:flex;
  align-items:center;
  gap:10px;
}

.today-pill{
  flex: 0 0 auto;
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,0.85);
  box-shadow: var(--shadow);
  border: 1px solid rgba(11,16,32,0.08);
  font-weight: 800;
  font-size: 12px;
  color: var(--ink);
}

.today-pill .sub{
  font-weight: 700;
  color: rgba(11,16,32,0.55);
}

.ticker{
  flex: 1 1 auto;
  overflow:hidden;
  border-radius: 999px;
  background: rgba(255,255,255,0.78);
  box-shadow: var(--shadow);
  border: 1px solid rgba(11,16,32,0.08);
  height: 36px;
  display:flex;
  align-items:center;
  position: relative;
}

.ticker::before{
  content:"";
  position:absolute;
  left:0; top:0; bottom:0;
  width:24px;
  background: linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,255,255,0.00));
  pointer-events:none;
}
.ticker::after{
  content:"";
  position:absolute;
  right:0; top:0; bottom:0;
  width:24px;
  background: linear-gradient(270deg, rgba(255,255,255,0.95), rgba(255,255,255,0.00));
  pointer-events:none;
}

.ticker-track{
  display:flex;
  align-items:center;
  gap: 18px;
  padding-left: 18px;
  will-change: transform;
  transform: translate3d(0,0,0);
}

.ticker-item{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  white-space: nowrap;
  font-size: 13px;
  font-weight: 800;
  color: rgba(11,16,32,0.82);
}

.dot{
  width:8px; height:8px;
  border-radius: 50%;
  background: var(--accent2);
  box-shadow: 0 0 0 4px rgba(96,165,250,0.18);
}

.ticker-date{
  position:absolute;
  right:10px;
  font-size: 11px;
  font-weight: 800;
  color: rgba(11,16,32,0.48);
}

/* ===== セクション / カード ===== */
.section{
  margin-top: 14px;
  border-radius: 18px;
  padding: 14px;
  background: rgba(255,255,255,0.72);
  box-shadow: var(--shadow);
  border: 1px solid rgba(11,16,32,0.08);
}

.h-title{
  font-size: 16px;
  font-weight: 900;
  margin-bottom: 6px;
  letter-spacing: 0.2px;
}
.h-sub{
  font-size: 12px;
  font-weight: 800;
  color: rgba(11,16,32,0.58);
  line-height: 1.5;
}

.badges{
  margin-top: 8px;
  display:flex;
  flex-wrap: wrap;
  gap: 6px;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  border-radius: 999px;
  padding: 4px 10px;
  font-size: 11px;
  font-weight: 900;
  background: rgba(255,255,255,0.82);
  border: 1px solid rgba(11,16,32,0.10);
  color: rgba(11,16,32,0.78);
}

.badge .chip{
  width:10px; height:10px;
  border-radius: 4px;
  background: var(--accent);
}

.grid2{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px;
  margin-top: 12px;
}
@media (max-width: 520px){
  .grid2{ grid-template-columns: 1fr; }
}

.kpi{
  border-radius: 16px;
  padding: 12px 12px;
  background: rgba(255,255,255,0.78);
  border: 1px solid rgba(11,16,32,0.08);
}
.kpi .lab{
  font-size: 11px;
  font-weight: 900;
  color: rgba(11,16,32,0.52);
  margin-bottom: 6px;
}
.kpi .val{
  font-size: 22px;
  font-weight: 1000;
  color: rgba(11,16,32,0.92);
  font-variant-numeric: tabular-nums;
  line-height: 1.1;
}
.kpi .sub{
  margin-top: 6px;
  font-size: 11px;
  font-weight: 900;
  color: rgba(11,16,32,0.54);
}

.hr{
  height:1px;
  background: rgba(11,16,32,0.08);
  margin: 12px 0;
}

.list{
  display:flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 10px;
}
.card{
  border-radius: 16px;
  padding: 12px 12px;
  background: rgba(255,255,255,0.80);
  border: 1px solid rgba(11,16,32,0.08);
}

.row{
  display:flex;
  justify-content: space-between;
  gap: 10px;
  align-items: baseline;
}
.row .k{
  font-size: 12px;
  font-weight: 900;
  color: rgba(11,16,32,0.54);
}
.row .v{
  font-size: 12px;
  font-weight: 1000;
  color: rgba(11,16,32,0.88);
  font-variant-numeric: tabular-nums;
}

.pills{
  display:flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 10px;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 1000;
  border: 1px solid rgba(11,16,32,0.10);
  background: rgba(255,255,255,0.85);
  color: rgba(11,16,32,0.80);
}
.pill b{ font-weight: 1100; }

.seq{
  margin-top: 10px;
  display:flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
}
.seq-dot{
  width: 28px;
  height: 28px;
  border-radius: 10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 1000;
  border: 1px solid rgba(11,16,32,0.10);
  background: rgba(255,255,255,0.85);
  color: rgba(11,16,32,0.78);
}
.seq-dot.win{ background: rgba(34,197,94,0.18); border-color: rgba(34,197,94,0.35); }
.seq-dot.lose{ background: rgba(239,68,68,0.16); border-color: rgba(239,68,68,0.32); }
.seq-dot.flat{ background: rgba(99,102,241,0.14); border-color: rgba(99,102,241,0.26); }

.small{
  font-size: 11px;
  font-weight: 900;
  color: rgba(11,16,32,0.56);
}

.pl-pos{ color: var(--ok); }
.pl-neg{ color: var(--bad); }

/* ===== 空状態 ===== */
.empty{
  margin-top: 16px;
  border-radius: 18px;
  padding: 16px;
  background: rgba(255,255,255,0.70);
  border: 1px dashed rgba(11,16,32,0.18);
  box-shadow: var(--shadow);
  color: rgba(11,16,32,0.78);
  font-weight: 900;
  line-height: 1.6;
}

/* iPhone向け：テロップはCSSアニメより JS（transform）で動かす */
.no-js .ticker-track{
  animation: tickerMove var(--ticker-sec) linear infinite;
}
@keyframes tickerMove{
  0%{ transform: translate3d(0,0,0); }
  100%{ transform: translate3d(-50%,0,0); }
}
</style>
{% endblock %}

{% block content %}
<div class="wrap no-js" id="behaviorRoot">

  <!-- 上部：今日 + テロップ -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="today-pill">
        <span>本日</span>
        <span class="sub">{{ today_label }}</span>
      </div>

      <div class="ticker" aria-label="ticker">
        <div class="ticker-track" id="tickerTrack">
          {% if ticker_lines %}
            {% for line in ticker_lines %}
              <div class="ticker-item"><span class="dot"></span>{{ line }}</div>
            {% endfor %}
            {% for line in ticker_lines %}
              <div class="ticker-item"><span class="dot"></span>{{ line }}</div>
            {% endfor %}
          {% else %}
            <div class="ticker-item"><span class="dot"></span>テロップ未生成（16:20の生成を待機）</div>
            <div class="ticker-item"><span class="dot"></span>テロップ未生成（16:20の生成を待機）</div>
          {% endif %}
        </div>
        <div class="ticker-date">{% if ticker_date %}{{ ticker_date }}{% endif %}</div>
      </div>
    </div>
  </div>

  {% if not has_data %}
    <div class="empty">
      まだ行動データがありません。<br>
      <span class="small">simulate（PRO）にログが溜まり、さらに ai_sim_eval → sync_simulate_pro_eval が走ると分析が出ます。</span><br>
      <div class="pills" style="margin-top:10px;">
        <span class="pill"><b>simulate files</b> {{ sim_files }}</span>
        <span class="pill"><b>理解度</b> {{ understanding_label }}</span>
      </div>
    </div>
  {% else %}

    <!-- 概要 -->
    <div class="section">
      <div class="h-title">AI 行動ダッシュボード（PRO）</div>
      <div class="h-sub">
        「結果」だけじゃなく、これからは <b>入った理由（entry_reason）</b> を軸にクセを学習していく。
      </div>

      <div class="badges">
        <span class="badge"><span class="chip" style="background:var(--accent2)"></span>simulate files: {{ sim_files }}</span>
        <span class="badge"><span class="chip" style="background:var(--accent)"></span>qty_pro: {{ sim_total|intcomma }}</span>
        <span class="badge"><span class="chip" style="background:var(--accent3)"></span>win/lose: {{ wl_total|intcomma }}</span>
        <span class="badge"><span class="chip" style="background:#a78bfa"></span>理解度: {{ understanding_label }}</span>
      </div>

      <div class="grid2">
        <div class="kpi">
          <div class="lab">勝率（win/lose）</div>
          <div class="val">{% if win_rate is not None %}{{ win_rate|floatformat:1 }}%{% else %}-{% endif %}</div>
          <div class="sub">carry/skipは母数に含めない</div>
        </div>
        <div class="kpi">
          <div class="lab">平均R</div>
          <div class="val">{% if avg_r is not None %}{{ avg_r|floatformat:2 }}{% else %}-{% endif %}</div>
          <div class="sub">Rが無い日は学習に弱めに反映</div>
        </div>
        <div class="kpi">
          <div class="lab">平均PL</div>
          <div class="val">{% if avg_pl is not None %}{{ avg_pl|floatformat:0|intcomma }}円{% else %}-{% endif %}</div>
          <div class="sub">PLは評価済みのみ</div>
        </div>
        <div class="kpi">
          <div class="lab">学習対象トレード数（モデル）</div>
          <div class="val">{% if model.has_model %}{{ model.total_trades|intcomma }}{% else %}-{% endif %}</div>
          <div class="sub">latest_behavior_model_u*.json</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="k">直近ストリーク</div>
        <div class="v">{{ streak_label }}</div>
      </div>

      <div class="seq" aria-label="sequence">
        {% for s in sequence %}
          <div class="seq-dot {{ s.label }}">{{ s.text }}</div>
        {% endfor %}
        <div class="small">直近12個</div>
      </div>
    </div>

    <!-- 仮説 -->
    <div class="section">
      <div class="h-title">AIの仮説</div>
      <div class="h-sub">今の少量データから “それっぽいクセ” を仮置き。データが増えるほど鋭くなる。</div>

      <div class="list">
        {% for h in hypotheses %}
          <div class="card">
            <div style="font-weight:1000; color:rgba(11,16,32,0.84); font-size:13px;">{{ h }}</div>
          </div>
        {% endfor %}
      </div>

      <div class="pills">
        {% for n in notes %}
          <span class="pill">{{ n }}</span>
        {% endfor %}
      </div>
    </div>

    <!-- バイアスマップ -->
    <div class="section">
      <div class="h-title">バイアスマップ</div>
      <div class="h-sub">あなたの “癖の種類” を4軸で表示。</div>

      <div class="grid2">
        {% for b in bias_map %}
          <div class="card">
            <div class="row">
              <div class="k">{{ b.name }}</div>
              <div class="v">{{ b.value }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- entry_reason別（ここが本命） -->
    <div class="section">
      <div class="h-title">entry_reason 別 成績</div>
      <div class="h-sub">
        ここからが本番。<b>「何で入ったか」</b>で勝率とRが変わるなら、あなたの型が見える。
      </div>

      {% if entry_reason_stats %}
        <div class="list">
          {% for r in entry_reason_stats %}
            <div class="card">
              <div class="row">
                <div class="k">{{ r.reason }}</div>
                <div class="v">{{ r.wins }}/{{ r.trials }}（{{ r.win_rate|floatformat:1 }}%）</div>
              </div>
              <div class="row" style="margin-top:6px;">
                <div class="k">avgR</div>
                <div class="v">{% if r.avg_r is not None %}{{ r.avg_r|floatformat:2 }}{% else %}-{% endif %}</div>
              </div>
              <div class="row" style="margin-top:6px;">
                <div class="k">avgPL</div>
                <div class="v">
                  {% if r.avg_pl is not None %}
                    {{ r.avg_pl|floatformat:0|intcomma }}円
                  {% else %}
                    -
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty" style="margin-top:12px;">
          entry_reason のデータがまだありません。<br>
          <span class="small">次に VirtualTrade に entry_reason を追加して、シミュレ登録時に保存します。</span>
        </div>
      {% endif %}
    </div>

    <!-- 欲しいデータ -->
    <div class="section">
      <div class="h-title">次に欲しいデータ</div>
      <div class="h-sub">これが揃うほど “言い当て精度” が上がる。</div>

      <div class="list">
        {% for w in wanted %}
          <div class="card">
            <div style="font-weight:1000; font-size:13px; color:rgba(11,16,32,0.86);">{{ w }}</div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- 最近のトレード -->
    <div class="section">
      <div class="h-title">最近の評価（抜粋）</div>
      <div class="h-sub">勝ち/負けだけじゃなく、理由とセットで見るための足場。</div>

      <div class="list">
        {% for t in recent_trades %}
          <div class="card">
            <div class="row">
              <div class="k">{{ t.code }}</div>
              <div class="v">
                {% if t.label == "win" %}
                  <span class="pl-pos">WIN</span>
                {% elif t.label == "lose" %}
                  <span class="pl-neg">LOSE</span>
                {% else %}
                  FLAT
                {% endif %}
              </div>
            </div>
            <div class="row" style="margin-top:6px;">
              <div class="k">PL</div>
              <div class="v {% if t.pl >= 0 %}pl-pos{% else %}pl-neg{% endif %}">
                {{ t.pl|floatformat:0|intcomma }}円
              </div>
            </div>
            <div class="row" style="margin-top:6px;">
              <div class="k">R</div>
              <div class="v">{% if t.r is not None %}{{ t.r|floatformat:2 }}{% else %}-{% endif %}</div>
            </div>
            <div class="row" style="margin-top:6px;">
              <div class="k">meta</div>
              <div class="v" style="font-weight:900;color:rgba(11,16,32,0.58);">{{ t.meta }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% endif %}
</div>

<script>
(function(){
  // JS動作の印
  var root = document.getElementById("behaviorRoot");
  if (root) root.classList.remove("no-js");

  // iPhoneでCSS animationが「体感変わらない」問題に対処：
  // requestAnimationFrame + translate3d で確実に動かす
  var track = document.getElementById("tickerTrack");
  if (!track) return;

  // 速度：秒（短いほど速い）
  // 「2秒でも変わらない」対策として、px/secベースで制御する
  var pxPerSec = 110; // ← ここが体感スピード。もっと速くしたければ 140, 180 に。
  var gap = 18;       // CSSのgapと同じイメージ
  var x = 0;
  var last = performance.now();

  // ループ距離（半分で戻す：重複並べている前提）
  function getLoopWidth(){
    // 全幅の半分を目安にループ
    return Math.max(1, track.scrollWidth / 2);
  }
  var loopW = getLoopWidth();

  // リサイズで再計算
  window.addEventListener("resize", function(){
    loopW = getLoopWidth();
  });

  // iOSはバックグラウンド復帰時に時間差が大きくなるのでclamp
  function step(now){
    var dt = (now - last) / 1000;
    last = now;
    if (dt > 0.05) dt = 0.05;

    x -= pxPerSec * dt;
    if (-x >= loopW){
      x = 0;
    }
    track.style.transform = "translate3d(" + x.toFixed(2) + "px,0,0)";
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
})();
</script>
{% endblock %}