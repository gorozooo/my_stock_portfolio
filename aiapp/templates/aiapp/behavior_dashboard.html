{% extends "base.html" %}
{% load humanize %}

{% block title %}AI Behavior Lab{% endblock %}

{% block head %}
<style>
/* =========================================================
   AI Behavior Lab — Bright Glass + iPhone Fast Ticker
   ========================================================= */

:root{
  /* 明るい“ネイビー昼光” */
  --bg:#081a3a;
  --fg:#f1f5ff;
  --sub:#d2dcff;
  --muted:#a9b7e8;

  --card:rgba(255,255,255,.09);
  --card2:rgba(12,24,54,.58);
  --border:rgba(255,255,255,.18);

  --accent:#60a5fa;
  --accent2:#34d399;
  --accent3:#a78bfa;

  --ok:#22c55e;
  --bad:#fb7185;

  /* ticker speed */
  --ticker-sec: 8s; /* base */
}

/* iOS(iPhone/iPad)だけ速くする */
@supports (-webkit-touch-callout: none){
  :root{ --ticker-sec: 3.2s; }
}

html, body{
  background: transparent;
}
body{
  color:var(--fg);
  background:
    radial-gradient(circle at 20% 10%, rgba(96,165,250,.28), transparent 55%),
    radial-gradient(circle at 80% 0%, rgba(52,211,153,.18), transparent 50%),
    radial-gradient(circle at 55% 110%, rgba(167,139,250,.18), transparent 55%),
    var(--bg);
}

/* wrap */
.wrap{
  max-width: 860px;
  margin: 0 auto;
  padding: 14px 14px 92px;
}

/* section */
.section{
  margin-top:14px;
  padding:14px;
  border-radius:20px;
  border:1px solid var(--border);
  background:
    radial-gradient(circle at top left, rgba(96,165,250,.20), transparent 55%),
    radial-gradient(circle at bottom right, rgba(255,255,255,.10), transparent 60%),
    var(--card2);
  box-shadow:
    0 10px 30px rgba(0,0,0,.25),
    0 0 0 1px rgba(255,255,255,.06) inset;
  backdrop-filter: blur(16px);
}

/* header */
.hero{
  padding:16px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.20);
  background:
    linear-gradient(135deg, rgba(96,165,250,.18), rgba(52,211,153,.08) 55%, rgba(167,139,250,.10)),
    rgba(255,255,255,.06);
  box-shadow:
    0 18px 40px rgba(0,0,0,.28),
    0 0 0 1px rgba(255,255,255,.08) inset;
  backdrop-filter: blur(18px);
}

.hero-title{
  font-size:20px;
  font-weight:800;
  letter-spacing:.3px;
  margin-bottom:4px;
}
.hero-sub{
  font-size:12px;
  color:var(--sub);
  line-height:1.6;
  opacity:.95;
}

/* chips */
.chips{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:12px;
}
.chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.08);
  color:var(--fg);
  font-size:12px;
  line-height:1;
  white-space:nowrap;
}
.chip.ok{
  border-color: rgba(34,197,94,.35);
  box-shadow: 0 0 0 1px rgba(34,197,94,.10) inset;
}
.chip.mid{
  border-color: rgba(96,165,250,.35);
  box-shadow: 0 0 0 1px rgba(96,165,250,.10) inset;
}
.chip.warn{
  border-color: rgba(251,113,133,.35);
  box-shadow: 0 0 0 1px rgba(251,113,133,.08) inset;
}
.dot{
  width:8px;height:8px;border-radius:99px;
  background: rgba(255,255,255,.65);
}
.dot.ok{ background: rgba(34,197,94,.95); }
.dot.mid{ background: rgba(96,165,250,.95); }
.dot.warn{ background: rgba(251,113,133,.95); }

/* =========================================================
   Ticker (telop)
   - iPhone speed via --ticker-sec
   - pause via JS class "is-paused"
   ========================================================= */

.ticker{
  margin-top: 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.07);
  overflow: hidden;
  position: relative;
}

.ticker-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:10px 12px 6px;
  font-size:12px;
  color: var(--sub);
}

.ticker-date{
  font-weight:800;
  letter-spacing:.2px;
  color: var(--fg);
}
.ticker-hint{
  font-size:11px;
  color: var(--sub);
  opacity:.9;
  white-space:nowrap;
}

.ticker-body{
  padding: 0 12px 10px;
}

.ticker-viewport{
  width: 100%;
  overflow: hidden;
}

.ticker-rail{
  display: inline-flex;
  gap: 28px;
  white-space: nowrap;
  animation: marquee var(--ticker-sec) linear infinite !important;
  will-change: transform;
  font-size: 13px;
  color: var(--fg);
}

.ticker.is-paused .ticker-rail{
  animation-play-state: paused !important;
}

/* iOS :activeの暴発対策（CSSで止めない） */
.ticker:active .ticker-rail{
  animation-play-state: running !important;
}

.ticker-strong{
  color: var(--accent);
  font-weight: 800;
}

@keyframes marquee{
  0%   { transform: translateX(0); }
  100% { transform: translateX(-100%); }
}

/* KPI strip */
.kpi-strip{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px;
  margin-top: 12px;
}
.kpi-box{
  border-radius: 16px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.07);
  padding:10px 12px;
}
.kpi-label{
  font-size: 11px;
  color: var(--sub);
  margin-bottom: 4px;
  opacity:.95;
}
.kpi-value{
  font-size: 16px;
  font-weight: 900;
  font-variant-numeric: tabular-nums;
}
.kpi-mini{
  margin-top:4px;
  font-size: 11px;
  color: var(--muted);
}

/* Lab blocks */
.lab-title{
  font-size: 15px;
  font-weight: 850;
  margin-bottom: 10px;
}
.card-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap: 10px;
}

.hypo{
  border-radius: 18px;
  border:1px dashed rgba(255,255,255,.18);
  background: rgba(255,255,255,.06);
  padding: 12px;
}
.hypo-top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
  margin-bottom: 8px;
}
.hypo-tag{
  font-size:12px;
  color: var(--sub);
  opacity:.9;
}
.hypo-badge{
  font-size: 11px;
  padding: 3px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.07);
}
.hypo-text{
  font-size: 13px;
  line-height: 1.65;
  color: var(--fg);
}

/* Stats list */
.mini-kv{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 12px;
  margin-top: 10px;
}
.kv-row{
  display:flex;
  justify-content:space-between;
  gap: 10px;
  font-size: 12px;
  color: var(--fg);
}
.kv-key{
  color: var(--sub);
  opacity:.95;
}
.kv-val{
  font-variant-numeric: tabular-nums;
}

/* top list */
.trade-item{
  border-radius: 16px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.07);
  padding: 10px 12px;
}
.trade-title{
  font-size: 13px;
  font-weight: 800;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 4px;
}
.trade-sub{
  display:flex;
  justify-content:space-between;
  gap: 10px;
  font-size: 11px;
  color: var(--sub);
  opacity:.95;
}
.pl-pos{ color: var(--ok); font-weight: 900; }
.pl-neg{ color: var(--bad); font-weight: 900; }

/* empty */
.empty{
  margin-top: 16px;
  padding: 16px;
  border-radius: 18px;
  border: 1px dashed rgba(255,255,255,.22);
  background: rgba(255,255,255,.06);
  color: var(--sub);
  line-height: 1.7;
  font-size: 13px;
}
</style>

<script>
/* iPhone向け：タップ/長押し中だけ停止（CSS :active の暴発を回避） */
document.addEventListener("DOMContentLoaded", () => {
  const ticker = document.querySelector(".ticker");
  if (!ticker) return;

  const pause = () => ticker.classList.add("is-paused");
  const play  = () => ticker.classList.remove("is-paused");

  ticker.addEventListener("touchstart", pause, {passive:true});
  ticker.addEventListener("touchend", play, {passive:true});
  ticker.addEventListener("touchcancel", play, {passive:true});
});
</script>
{% endblock %}

{% block content %}
<div class="wrap">

  {% if not has_data %}
    <div class="hero">
      <div class="hero-title">AI Behavior Lab</div>
      <div class="hero-sub">
        成績表じゃない。<br>
        「あなたの判断のクセ」を、AIが“仮説→検証”で増殖させる実験室。
      </div>
    </div>

    <div class="empty">
      まだ PRO 行動データ（評価付き）がありません。<br>
      先に <span class="ticker-strong">ai_sim_eval → sync_simulate_pro_eval → build_behavior_dataset → train_behavior_model</span>
      が揃うと、ここに “学習内容 / 傾向 / 改善の打ち手” が出ます。
    </div>

  {% else %}

    <!-- HERO -->
    <div class="hero">
      <div class="hero-title">AI Behavior Lab</div>
      <div class="hero-sub">
        成績表じゃない。<br>
        「あなたの判断のクセ」を、AIが“仮説→検証”で増殖させる実験室。
      </div>

      <!-- CHIPS -->
      <div class="chips">
        <div class="chip"><span class="dot mid"></span> PRO仕様</div>
        <div class="chip mid">today: {{ today }}</div>
        <div class="chip">simulate files: {{ simulate_files|default:0 }}</div>

        {% if model_ready %}
          <div class="chip ok"><span class="dot ok"></span> model: ready</div>
        {% else %}
          <div class="chip warn"><span class="dot warn"></span> model: none</div>
        {% endif %}

        <div class="chip mid">understanding: {{ understanding|default:"MID" }}</div>
      </div>

      <!-- TICKER -->
      <div class="ticker">
        <div class="ticker-head">
          <div class="ticker-date">本日 {{ today }}</div>
          <div class="ticker-hint">（長押し/タップ中は停止）</div>
        </div>
        <div class="ticker-body">
          <div class="ticker-viewport">
            <div class="ticker-rail">
              <span>学習: WL={{ wl_total }} 勝率={{ kpi_win_rate|floatformat:1 }}%（W{{ wl_win }}/L{{ wl_lose }}）</span>
              <span class="ticker-strong">平均R: {{ kpi_avg_r|floatformat:3 }}</span>
              <span>平均PL: {{ behavior_model.avg_pl|floatformat:0|intcomma }}円</span>
              <span>相性TOP: {{ best_sector_name|default:"-" }}</span>

              <!-- 同じ文をもう一回（-100%移動で切れないように） -->
              <span>学習: WL={{ wl_total }} 勝率={{ kpi_win_rate|floatformat:1 }}%（W{{ wl_win }}/L{{ wl_lose }}）</span>
              <span class="ticker-strong">平均R: {{ kpi_avg_r|floatformat:3 }}</span>
              <span>平均PL: {{ behavior_model.avg_pl|floatformat:0|intcomma }}円</span>
              <span>相性TOP: {{ best_sector_name|default:"-" }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI STRIP -->
      <div class="kpi-strip">
        <div class="kpi-box">
          <div class="kpi-label">学習（win/lose）</div>
          <div class="kpi-value">WL={{ wl_total }} 勝率={{ kpi_win_rate|floatformat:1 }}%（W{{ wl_win }}/L{{ wl_lose }}）</div>
          <div class="kpi-mini">PROのみ（carry/skipは除外）</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">平均R</div>
          <div class="kpi-value">{{ kpi_avg_r|floatformat:3 }}</div>
          <div class="kpi-mini">Rが取れている分だけで計算</div>
        </div>
      </div>
    </div>

    <!-- Hypotheses -->
    <div class="section">
      <div class="lab-title">AI の現在の仮説</div>

      <div class="card-grid">
        {% for h in hypotheses %}
          <div class="hypo">
            <div class="hypo-top">
              <div class="hypo-tag">仮説 {{ forloop.counter|stringformat:"02d" }}</div>
              <div class="hypo-badge">{{ h.level }}</div>
            </div>
            <div class="hypo-text">{{ h.text }}</div>
          </div>
        {% empty %}
          <div class="hypo">
            <div class="hypo-text">
              まだ仮説を作るにはデータが足りません。もう少し PRO 評価付きログが増えると、
              “勝ち筋/負け筋” を切り分けた仮説が増殖します。
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="mini-kv">
        <div class="kv-row"><div class="kv-key">総レコード（表示対象）</div><div class="kv-val">{{ total|intcomma }}</div></div>
        <div class="kv-row"><div class="kv-key">WL対象</div><div class="kv-val">{{ wl_total }}</div></div>
        <div class="kv-row"><div class="kv-key">DEMO</div><div class="kv-val">{{ mode_counts.demo|default:0 }}</div></div>
        <div class="kv-row"><div class="kv-key">LIVE</div><div class="kv-val">{{ mode_counts.live|default:0 }}</div></div>
      </div>
    </div>

    <!-- Model summary -->
    <div class="section">
      <div class="lab-title">学習サマリ（behavior model）</div>

      {% if behavior_model.has_model %}
        <div class="mini-kv">
          <div class="kv-row"><div class="kv-key">学習トレード数</div><div class="kv-val">{{ behavior_model.total_trades|default:0 }}</div></div>
          <div class="kv-row"><div class="kv-key">勝ち</div><div class="kv-val">{{ behavior_model.wins|default:0 }}</div></div>
          <div class="kv-row"><div class="kv-key">勝率</div><div class="kv-val">{{ behavior_model.win_rate|floatformat:1 }}%</div></div>
          <div class="kv-row"><div class="kv-key">平均PL</div><div class="kv-val">{{ behavior_model.avg_pl|floatformat:0|intcomma }}円</div></div>
          <div class="kv-row"><div class="kv-key">平均R</div><div class="kv-val">{{ behavior_model.avg_r|floatformat:3 }}</div></div>
          <div class="kv-row"><div class="kv-key">更新時刻</div><div class="kv-val">{{ behavior_model.updated_at|default:"-" }}</div></div>
        </div>
      {% else %}
        <div class="empty" style="margin-top:8px;">
          まだ学習モデルがありません。<br>
          <span class="ticker-strong">train_behavior_model</span> 実行後にここが埋まります。
        </div>
      {% endif %}
    </div>

    <!-- TOP win / lose -->
    <div class="section">
      <div class="lab-title">TOP 勝ち（PRO）</div>
      {% if top_win %}
        {% for r in top_win %}
          <div class="trade-item">
            <div class="trade-title">{{ r.code }} {{ r.name }}</div>
            <div class="trade-sub">
              <div class="pl-pos">+{{ r.pl|floatformat:0|intcomma }} 円</div>
              <div>{{ r.mode }} ／ {{ r.ts_label }}</div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty">勝ちトレードがまだありません。</div>
      {% endif %}
    </div>

    <div class="section">
      <div class="lab-title">TOP 負け（PRO）</div>
      {% if top_lose %}
        {% for r in top_lose %}
          <div class="trade-item">
            <div class="trade-title">{{ r.code }} {{ r.name }}</div>
            <div class="trade-sub">
              <div class="pl-neg">{{ r.pl|floatformat:0|intcomma }} 円</div>
              <div>{{ r.mode }} ／ {{ r.ts_label }}</div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty">負けトレードがまだありません。</div>
      {% endif %}
    </div>

  {% endif %}

</div>
{% endblock %}