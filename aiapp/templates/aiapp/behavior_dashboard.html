{% extends "base.html" %}
{% load humanize %}

{% block title %}AI 行動ダッシュボード{% endblock %}

{% block head %}
<style>
:root{
  /* ===== いままでの暗め（ガラス）寄りに戻す ===== */
  --bg:#020617;
  --card:rgba(15,23,42,.86);
  --card2:rgba(15,23,42,.72);
  --fg:#e5edff;
  --sub:rgba(229,237,255,.70);
  --muted:rgba(229,237,255,.55);
  --line:rgba(148,163,184,.22);

  --accent:#7c3aed;   /* 紫 */
  --accent2:#38bdf8;  /* 水色 */
  --accent3:#fb7185;  /* ピンク */

  --ok:#22c55e;
  --bad:#ef4444;

  --shadow:0 14px 40px rgba(0,0,0,.35);
  --shadow2:0 10px 26px rgba(0,0,0,.26);

  /* テロップ速度は px/sec で制御（JS側） */
}

body{
  background:
    radial-gradient(1200px 700px at 10% 10%, rgba(124,58,237,.22), transparent 55%),
    radial-gradient(900px 520px at 85% 15%, rgba(56,189,248,.18), transparent 55%),
    radial-gradient(900px 520px at 70% 90%, rgba(251,113,133,.12), transparent 60%),
    linear-gradient(180deg, var(--bg), #071028);
  color: var(--fg);
}

.wrap{
  max-width: 920px;
  margin: 0 auto;
  padding: 12px 12px 92px;
}

/* ===== 上部バー（今日 + テロップ） ===== */
.topbar{
  position: sticky;
  top: 0;
  z-index: 40;
  padding-top: 10px;
  padding-bottom: 10px;
  background: linear-gradient(180deg, rgba(2,6,23,.92), rgba(2,6,23,.70), rgba(2,6,23,0));
  backdrop-filter: blur(10px);
}

.topbar-inner{
  display:flex;
  align-items:center;
  gap:10px;
}

.today-pill{
  flex: 0 0 auto;
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius: 999px;
  background: rgba(15,23,42,.86);
  border: 1px solid var(--line);
  box-shadow: var(--shadow2);
  font-weight: 900;
  font-size: 12px;
  color: var(--fg);
}

.today-pill .sub{
  font-weight: 800;
  color: var(--muted);
}

.ticker{
  flex: 1 1 auto;
  overflow:hidden;
  border-radius: 999px;
  background: rgba(15,23,42,.86);
  border: 1px solid var(--line);
  box-shadow: var(--shadow2);
  height: 36px;
  display:flex;
  align-items:center;
  position: relative;
}

.ticker::before{
  content:"";
  position:absolute;
  left:0; top:0; bottom:0;
  width:24px;
  background: linear-gradient(90deg, rgba(2,6,23,.95), rgba(2,6,23,0));
  pointer-events:none;
}
.ticker::after{
  content:"";
  position:absolute;
  right:0; top:0; bottom:0;
  width:24px;
  background: linear-gradient(270deg, rgba(2,6,23,.95), rgba(2,6,23,0));
  pointer-events:none;
}

.ticker-track{
  display:flex;
  align-items:center;
  gap: 16px;
  padding-left: 16px;
  will-change: transform;
  transform: translate3d(0,0,0);
}

.ticker-item{
  display:inline-flex;
  align-items:center;
  gap: 8px;
  white-space: nowrap;
  font-size: 13px;
  font-weight: 900;
  color: rgba(229,237,255,.86);
}

.dot{
  width:8px; height:8px;
  border-radius: 50%;
  background: var(--accent2);
  box-shadow: 0 0 0 4px rgba(56,189,248,.16);
}

/* ★ うっすら日付を完全に消す（邪魔なので） */
.ticker-date{ display:none !important; }

/* ===== セクション / カード ===== */
.section{
  margin-top: 12px;
  border-radius: 18px;
  padding: 12px;
  background: linear-gradient(180deg, rgba(15,23,42,.88), rgba(15,23,42,.76));
  box-shadow: var(--shadow);
  border: 1px solid var(--line);
}

.h-title{
  font-size: 15px;
  font-weight: 1000;
  margin-bottom: 6px;
  letter-spacing: 0.2px;
}
.h-sub{
  font-size: 12px;
  font-weight: 800;
  color: var(--sub);
  line-height: 1.55;
}

.badges{
  margin-top: 10px;
  display:flex;
  flex-wrap: wrap;
  gap: 6px;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  border-radius: 999px;
  padding: 5px 10px;
  font-size: 11px;
  font-weight: 950;
  background: rgba(2,6,23,.35);
  border: 1px solid rgba(148,163,184,.20);
  color: rgba(229,237,255,.86);
}
.badge .chip{
  width:10px; height:10px;
  border-radius: 4px;
  background: var(--accent);
}

.grid2{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px;
  margin-top: 10px;
}
@media (max-width: 520px){
  .grid2{ grid-template-columns: 1fr; }
}

/* ★ KPIをコンパクト化（縦に間延びしない） */
.kpi{
  border-radius: 16px;
  padding: 10px 12px;
  background: rgba(2,6,23,.32);
  border: 1px solid rgba(148,163,184,.20);
}
.kpi .lab{
  font-size: 11px;
  font-weight: 900;
  color: rgba(229,237,255,.62);
  margin-bottom: 4px;
}
.kpi .val{
  font-size: 20px;
  font-weight: 1000;
  color: rgba(229,237,255,.95);
  font-variant-numeric: tabular-nums;
  line-height: 1.12;
}
.kpi .sub{
  margin-top: 4px;
  font-size: 11px;
  font-weight: 850;
  color: rgba(229,237,255,.56);
}

.hr{
  height:1px;
  background: rgba(148,163,184,.18);
  margin: 10px 0;
}

.list{
  display:flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 10px;
}
.card{
  border-radius: 16px;
  padding: 10px 12px;
  background: rgba(2,6,23,.30);
  border: 1px solid rgba(148,163,184,.18);
}

.row{
  display:flex;
  justify-content: space-between;
  gap: 10px;
  align-items: baseline;
}
.row .k{
  font-size: 12px;
  font-weight: 900;
  color: rgba(229,237,255,.62);
}
.row .v{
  font-size: 12px;
  font-weight: 1000;
  color: rgba(229,237,255,.92);
  font-variant-numeric: tabular-nums;
}

.pills{
  display:flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 10px;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap: 6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 11px;
  font-weight: 1000;
  border: 1px solid rgba(148,163,184,.18);
  background: rgba(2,6,23,.34);
  color: rgba(229,237,255,.86);
}
.pill b{ font-weight: 1100; }

.seq{
  margin-top: 10px;
  display:flex;
  flex-wrap: wrap;
  gap: 6px;
  align-items: center;
}
.seq-dot{
  width: 26px;
  height: 26px;
  border-radius: 10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 1000;
  border: 1px solid rgba(148,163,184,.20);
  background: rgba(2,6,23,.34);
  color: rgba(229,237,255,.82);
  font-size: 12px;
}
.seq-dot.win{ background: rgba(34,197,94,0.18); border-color: rgba(34,197,94,0.35); }
.seq-dot.lose{ background: rgba(239,68,68,0.16); border-color: rgba(239,68,68,0.32); }
.seq-dot.flat{ background: rgba(99,102,241,0.14); border-color: rgba(99,102,241,0.26); }

.small{
  font-size: 11px;
  font-weight: 850;
  color: rgba(229,237,255,.58);
}

.pl-pos{ color: var(--ok); }
.pl-neg{ color: var(--bad); }

/* ===== 空状態 ===== */
.empty{
  margin-top: 14px;
  border-radius: 18px;
  padding: 14px;
  background: rgba(15,23,42,.75);
  border: 1px dashed rgba(148,163,184,.25);
  box-shadow: var(--shadow2);
  color: rgba(229,237,255,.86);
  font-weight: 900;
  line-height: 1.6;
}

/* ===== AIの仮説：見づらさ改善（折りたたみ + 要点） ===== */
.hypo-wrap{
  margin-top: 10px;
  display:flex;
  flex-direction: column;
  gap: 10px;
}
details.hypo{
  border-radius: 16px;
  background: rgba(2,6,23,.30);
  border: 1px solid rgba(148,163,184,.18);
  overflow:hidden;
}
details.hypo > summary{
  list-style: none;
  cursor: pointer;
  padding: 10px 12px;
  display:flex;
  align-items:flex-start;
  gap: 10px;
}
details.hypo > summary::-webkit-details-marker{ display:none; }
.hypo-badge{
  flex: 0 0 auto;
  width: 28px;
  height: 28px;
  border-radius: 10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight: 1000;
  background: rgba(124,58,237,.18);
  border: 1px solid rgba(124,58,237,.30);
  color: rgba(229,237,255,.92);
}
.hypo-title{
  flex: 1 1 auto;
  font-size: 12px;
  font-weight: 950;
  color: rgba(229,237,255,.92);
  line-height: 1.45;
}
.hypo-open{
  flex: 0 0 auto;
  font-size: 12px;
  font-weight: 1000;
  color: rgba(229,237,255,.55);
  padding-top: 2px;
}
.hypo-body{
  padding: 0 12px 12px;
  color: rgba(229,237,255,.80);
  font-size: 12px;
  font-weight: 850;
  line-height: 1.7;
}
.hypo-body .mini{
  margin-top: 8px;
  font-size: 11px;
  color: rgba(229,237,255,.55);
  font-weight: 850;
}

/* iPhone向け：tickerは JS transform で動かす */
.no-js .ticker-track{
  animation: tickerMove 12s linear infinite;
}
@keyframes tickerMove{
  0%{ transform: translate3d(0,0,0); }
  100%{ transform: translate3d(-50%,0,0); }
}
</style>
{% endblock %}

{% block content %}
<div class="wrap no-js" id="behaviorRoot">

  <!-- 上部：今日 + テロップ -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="today-pill">
        <span>本日</span>
        <span class="sub">{{ today_label }}</span>
      </div>

      <div class="ticker" aria-label="ticker">
        <div class="ticker-track" id="tickerTrack">
          {% if ticker_lines %}
            {% for line in ticker_lines %}
              <div class="ticker-item"><span class="dot"></span>{{ line }}</div>
            {% endfor %}
            {% for line in ticker_lines %}
              <div class="ticker-item"><span class="dot"></span>{{ line }}</div>
            {% endfor %}
          {% else %}
            <div class="ticker-item"><span class="dot"></span>テロップ未生成（生成ジョブ待機中）</div>
            <div class="ticker-item"><span class="dot"></span>テロップ未生成（生成ジョブ待機中）</div>
          {% endif %}
        </div>

        {# ★ 右側の薄い日付は邪魔なので表示しない（CSSでdisplay:noneにしてある） #}
        <div class="ticker-date">{% if ticker_date %}{{ ticker_date }}{% endif %}</div>
      </div>
    </div>
  </div>

  {% if not has_data %}
    <div class="empty">
      まだ行動データがありません。<br>
      <span class="small">simulate（PRO）にログが溜まり、さらに ai_sim_eval → sync_simulate_pro_eval が走ると分析が出ます。</span><br>
      <div class="pills" style="margin-top:10px;">
        <span class="pill"><b>simulate files</b> {{ sim_files }}</span>
        <span class="pill"><b>理解度</b> {{ understanding_label }}</span>
      </div>
    </div>
  {% else %}

    <!-- 概要（コンパクト版） -->
    <div class="section">
      <div class="h-title">AI 行動ダッシュボード（PRO）</div>
      <div class="h-sub">
        「結果」だけじゃなく、<b>入った理由（entry_reason）</b> を軸にクセを学習していく。
      </div>

      <div class="badges">
        <span class="badge"><span class="chip" style="background:var(--accent2)"></span>simulate files: {{ sim_files }}</span>
        <span class="badge"><span class="chip" style="background:var(--accent)"></span>qty_pro: {{ sim_total|intcomma }}</span>
        <span class="badge"><span class="chip" style="background:var(--accent3)"></span>win/lose: {{ wl_total|intcomma }}</span>
        <span class="badge"><span class="chip" style="background:#a78bfa"></span>理解度: {{ understanding_label }}</span>
      </div>

      <div class="grid2">
        <div class="kpi">
          <div class="lab">勝率（win/lose）</div>
          <div class="val">{% if win_rate is not None %}{{ win_rate|floatformat:1 }}%{% else %}-{% endif %}</div>
          <div class="sub">carry/skipは母数に含めない</div>
        </div>

        <div class="kpi">
          <div class="lab">平均R</div>
          <div class="val">{% if avg_r is not None %}{{ avg_r|floatformat:2 }}{% else %}-{% endif %}</div>
          <div class="sub">Rが無い日は学習に弱めに反映</div>
        </div>

        <div class="kpi">
          <div class="lab">平均PL</div>
          <div class="val">{% if avg_pl is not None %}{{ avg_pl|floatformat:0|intcomma }}円{% else %}-{% endif %}</div>
          <div class="sub">PLは評価済みのみ</div>
        </div>

        <div class="kpi">
          <div class="lab">学習対象トレード数（モデル）</div>
          <div class="val">{% if model.has_model %}{{ model.total_trades|intcomma }}{% else %}-{% endif %}</div>
          <div class="sub">latest_behavior_model_u*.json</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="k">直近ストリーク</div>
        <div class="v">{{ streak_label }}</div>
      </div>

      <div class="seq" aria-label="sequence">
        {% for s in sequence %}
          <div class="seq-dot {{ s.label }}">{{ s.text }}</div>
        {% endfor %}
        <div class="small">直近12個</div>
      </div>
    </div>

    <!-- AIの仮説（見やすい折りたたみ） -->
    <div class="section">
      <div class="h-title">AIの仮説</div>
      <div class="h-sub">
        いまの少量データから “それっぽいクセ” を仮置き。<b>必要なときだけ開いて読む</b>スタイル。
      </div>

      {% if hypotheses %}
        <div class="hypo-wrap">
          {% for h in hypotheses %}
            <details class="hypo">
              <summary>
                <div class="hypo-badge">{{ forloop.counter }}</div>
                <div class="hypo-title">{{ h }}</div>
                <div class="hypo-open">開く</div>
              </summary>
              <div class="hypo-body">
                {{ h }}
                <div class="mini">※データが増えるほど、仮説は「消える/強くなる/分岐する」を繰り返す。</div>
              </div>
            </details>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty" style="margin-top:12px;">
          まだ仮説を生成できるだけのデータがありません。<br>
          <span class="small">simulate（PRO）→ 評価 → 同期が揃うと出ます。</span>
        </div>
      {% endif %}

      <div class="pills">
        {% for n in notes %}
          <span class="pill">{{ n }}</span>
        {% endfor %}
      </div>
    </div>

    <!-- バイアスマップ -->
    <div class="section">
      <div class="h-title">バイアスマップ</div>
      <div class="h-sub">あなたの “癖の種類” を4軸で表示。</div>

      <div class="grid2">
        {% for b in bias_map %}
          <div class="card">
            <div class="row">
              <div class="k">{{ b.name }}</div>
              <div class="v">{{ b.value }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- entry_reason別 -->
    <div class="section">
      <div class="h-title">entry_reason 別 成績</div>
      <div class="h-sub">
        <b>「何で入ったか」</b>で勝率とRが変わるなら、あなたの型が見える。
      </div>

      {% if entry_reason_stats %}
        <div class="list">
          {% for r in entry_reason_stats %}
            <div class="card">
              <div class="row">
                <div class="k">{{ r.reason }}</div>
                <div class="v">{{ r.wins }}/{{ r.trials }}（{{ r.win_rate|floatformat:1 }}%）</div>
              </div>
              <div class="row" style="margin-top:6px;">
                <div class="k">avgR</div>
                <div class="v">{% if r.avg_r is not None %}{{ r.avg_r|floatformat:2 }}{% else %}-{% endif %}</div>
              </div>
              <div class="row" style="margin-top:6px;">
                <div class="k">avgPL</div>
                <div class="v">
                  {% if r.avg_pl is not None %}
                    {{ r.avg_pl|floatformat:0|intcomma }}円
                  {% else %}
                    -
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty" style="margin-top:12px;">
          entry_reason のデータがまだありません。<br>
          <span class="small">次に VirtualTrade に entry_reason を追加して、シミュレ登録時に保存します。</span>
        </div>
      {% endif %}
    </div>

    <!-- 欲しいデータ -->
    <div class="section">
      <div class="h-title">次に欲しいデータ</div>
      <div class="h-sub">これが揃うほど “言い当て精度” が上がる。</div>

      <div class="list">
        {% for w in wanted %}
          <div class="card">
            <div style="font-weight:950; font-size:13px; color:rgba(229,237,255,.92); line-height:1.55;">{{ w }}</div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- 最近のトレード -->
    <div class="section">
      <div class="h-title">最近の評価（抜粋）</div>
      <div class="h-sub">勝ち/負けだけじゃなく、理由とセットで見るための足場。</div>

      <div class="list">
        {% for t in recent_trades %}
          <div class="card">
            <div class="row">
              <div class="k">{{ t.code }}</div>
              <div class="v">
                {% if t.label == "win" %}
                  <span class="pl-pos">WIN</span>
                {% elif t.label == "lose" %}
                  <span class="pl-neg">LOSE</span>
                {% else %}
                  FLAT
                {% endif %}
              </div>
            </div>
            <div class="row" style="margin-top:6px;">
              <div class="k">PL</div>
              <div class="v {% if t.pl >= 0 %}pl-pos{% else %}pl-neg{% endif %}">
                {{ t.pl|floatformat:0|intcomma }}円
              </div>
            </div>
            <div class="row" style="margin-top:6px;">
              <div class="k">R</div>
              <div class="v">{% if t.r is not None %}{{ t.r|floatformat:2 }}{% else %}-{% endif %}</div>
            </div>
            <div class="row" style="margin-top:6px;">
              <div class="k">meta</div>
              <div class="v" style="font-weight:850;color:rgba(229,237,255,.60);">{{ t.meta }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% endif %}
</div>

<script>
(function(){
  // JS動作の印
  var root = document.getElementById("behaviorRoot");
  if (root) root.classList.remove("no-js");

  // iPhoneでCSS animationが効きづらい時があるので
  // requestAnimationFrame + translate3d で確実に動かす
  var track = document.getElementById("tickerTrack");
  if (!track) return;

  // ★ 体感速度：px/sec（ここだけ触れば速さが変わる）
  var pxPerSec = 120; // 速く=150/180, 遅く=90
  var x = 0;
  var last = performance.now();

  function getLoopWidth(){
    return Math.max(1, track.scrollWidth / 2); // 2回並べてる前提
  }
  var loopW = getLoopWidth();

  window.addEventListener("resize", function(){
    loopW = getLoopWidth();
  });

  function step(now){
    var dt = (now - last) / 1000;
    last = now;

    // iOS復帰でdtが跳ねる対策
    if (dt > 0.05) dt = 0.05;

    x -= pxPerSec * dt;
    if (-x >= loopW){
      x = 0;
    }
    track.style.transform = "translate3d(" + x.toFixed(2) + "px,0,0)";
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
})();
</script>
{% endblock %}