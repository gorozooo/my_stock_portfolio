{% extends "base.html" %}
{% load humanize %}

{% block title %}AIシミュレ一覧{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#020617;
    --card:rgba(15,23,42,0.95);
    --sub:#94a3b8;
    --fg:#e5e7eb;
    --accent:#38bdf8;
    --ok:#22c55e;
    --bad:#f97373;
    --muted:#64748b;
  }
  body{background:var(--bg);color:var(--fg);}
  .wrap{max-width:720px;margin:0 auto;padding:10px 12px 80px;}

  .head{
    padding:14px;
    border-radius:16px;
    border:1px solid rgba(148,163,184,0.3);
    background:linear-gradient(135deg,rgba(15,23,42,0.95),rgba(30,64,175,0.8));
    color:#e5e7eb;
    margin:6px 0 12px 0;
    backdrop-filter:blur(12px);
  }
  .head-title{
    font-size:16px;
    font-weight:700;
    margin-bottom:4px;
  }
  .head-sub{
    font-size:12px;
    color:#cbd5f5;
  }

  /* ===== フィルタエリア ===== */
  .filters{
    margin:0 0 12px 0;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.35);
    background:rgba(15,23,42,0.95);
    backdrop-filter:blur(10px);
    font-size:12px;
  }
  .filter-row{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:8px;
    margin-bottom:8px;
  }
  .filter-label{
    font-size:11px;
    color:var(--sub);
    min-width:52px;
  }
  .filter-search{
    flex:1;
    display:flex;
    gap:6px;
  }
  .filter-search input[type="text"]{
    flex:1;
    padding:6px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.7);
    background:rgba(15,23,42,0.95);
    color:var(--fg);
    font-size:12px;
  }
  .filter-search button{
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(56,189,248,0.8);
    background:rgba(56,189,248,0.15);
    color:#e0f2fe;
    font-size:12px;
  }

  .chips{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.6);
    font-size:11px;
    color:var(--sub);
    text-decoration:none;
    background:rgba(15,23,42,0.9);
  }
  .chip.active{
    border-color:rgba(56,189,248,0.9);
    color:#e0f2fe;
    background:radial-gradient(circle at top left,rgba(56,189,248,0.28),rgba(15,23,42,1));
  }

  .grid{display:grid;gap:10px;}

  .card{
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.35);
    background:radial-gradient(circle at top left,rgba(56,189,248,0.10),rgba(15,23,42,0.95));
    padding:10px 12px;
    backdrop-filter:blur(10px);
  }

  .row-top{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:8px;
    margin-bottom:4px;
  }
  .code-name{
    min-width:0;
  }
  .code{
    font-size:13px;
    color:var(--sub);
    margin-bottom:2px;
  }
  .name{
    font-size:15px;
    font-weight:600;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .ts-badge{
    font-size:11px;
    color:#e5e7eb;
    background:rgba(15,23,42,0.9);
    border-radius:999px;
    padding:4px 8px;
    border:1px solid rgba(148,163,184,0.6);
    white-space:nowrap;
  }

  .mode-badge{
    display:inline-block;
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.8);
    margin-top:4px;
  }
  .mode-demo{
    background:rgba(59,130,246,0.18);
    color:#bfdbfe;
  }
  .mode-live{
    background:rgba(22,163,74,0.18);
    color:#bbf7d0;
  }

  .kpi{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:6px;
    margin-top:6px;
  }
  .kpi-it{
    padding:6px 7px;
    border-radius:10px;
    background:rgba(15,23,42,0.9);
    border:1px solid rgba(30,64,175,0.5);
  }
  .kpi-label{
    font-size:11px;
    color:var(--sub);
    margin-bottom:2px;
  }
  .kpi-row{
    display:flex;
    justify-content:space-between;
    font-size:12px;
  }
  .kpi-name{
    color:var(--muted);
  }
  .kpi-val{
    font-variant-numeric:tabular-nums;
  }
  .kpi-val.pos{color:var(--ok);}
  .kpi-val.neg{color:var(--bad);}

  /* ===== 結果入力エリア ===== */
  .result-block{
    margin-top:8px;
    padding-top:6px;
    border-top:1px dashed rgba(148,163,184,0.5);
  }
  .result-row-top{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:4px;
  }
  .result-label{
    font-size:11px;
    color:var(--sub);
  }
  .result-status{
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.6);
    background:rgba(15,23,42,0.9);
  }
  .result-status.win{
    border-color:rgba(34,197,94,0.9);
    color:#bbf7d0;
    background:rgba(22,163,74,0.18);
  }
  .result-status.lose{
    border-color:rgba(248,113,113,0.9);
    color:#fecaca;
    background:rgba(248,113,113,0.14);
  }
  .result-status.skip{
    border-color:rgba(148,163,184,0.9);
    color:#e5e7eb;
    background:rgba(15,23,42,0.95);
  }

  .result-form-row{
    display:flex;
    gap:6px;
    margin-top:4px;
  }
  .result-form-row select,
  .result-form-row input[type="number"]{
    flex:1;
    padding:5px 7px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.7);
    background:rgba(15,23,42,0.95);
    color:var(--fg);
    font-size:11px;
  }
  .result-form-row button{
    padding:5px 9px;
    border-radius:999px;
    border:1px solid rgba(56,189,248,0.8);
    background:rgba(56,189,248,0.15);
    color:#e0f2fe;
    font-size:11px;
    white-space:nowrap;
  }

  .card-footer{
    margin-top:8px;
    display:flex;
    justify-content:flex-end;
  }
  .btn-delete{
    padding:4px 10px;
    border-radius:999px;
    border:1px solid rgba(248,113,113,0.8);
    background:rgba(248,113,113,0.1);
    color:#fecaca;
    font-size:11px;
  }

  .empty{
    margin-top:16px;
    padding:16px;
    border-radius:12px;
    border:1px dashed rgba(148,163,184,0.6);
    font-size:13px;
    color:#cbd5f5;
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="head">
    <div class="head-title">AIシミュレ一覧</div>
    <div class="head-sub">
      AI Picks の「シミュレ」で登録した紙トレのログです。<br>
      直近100件まで表示しています。
    </div>
  </div>

  {# ===== フィルタエリア ===== #}
  <div class="filters">
    {# 検索フォーム（銘柄コード / 名称） #}
    <form method="get" class="filter-row">
      <div class="filter-label">検索</div>
      <div class="filter-search">
        <input type="text"
               name="q"
               placeholder="銘柄コード・名称で絞り込み"
               value="{{ query }}">
        <input type="hidden" name="mode" value="{{ filter_mode }}">
        <input type="hidden" name="period" value="{{ filter_period }}">
        <button type="submit">検索</button>
      </div>
    </form>

    {# mode チップ（ALL / LIVE / DEMO） #}
    <div class="filter-row">
      <div class="filter-label">モード</div>
      <div class="chips">
        <a class="chip {% if filter_mode == 'all' %}active{% endif %}"
           href="?mode=all&period={{ filter_period }}&q={{ query|urlencode }}">
          ALL
        </a>
        <a class="chip {% if filter_mode == 'live' %}active{% endif %}"
           href="?mode=live&period={{ filter_period }}&q={{ query|urlencode }}">
          LIVE
        </a>
        <a class="chip {% if filter_mode == 'demo' %}active{% endif %}"
           href="?mode=demo&period={{ filter_period }}&q={{ query|urlencode }}">
          DEMO
        </a>
      </div>
    </div>

    {# 期間チップ（今日 / 今週 / 30日） #}
    <div class="filter-row">
      <div class="filter-label">期間</div>
      <div class="chips">
        <a class="chip {% if filter_period == 'today' %}active{% endif %}"
           href="?mode={{ filter_mode }}&period=today&q={{ query|urlencode }}">
          今日
        </a>
        <a class="chip {% if filter_period == 'week' %}active{% endif %}"
           href="?mode={{ filter_mode }}&period=week&q={{ query|urlencode }}">
          今週
        </a>
        <a class="chip {% if filter_period == '30d' %}active{% endif %}"
           href="?mode={{ filter_mode }}&period=30d&q={{ query|urlencode }}">
          過去30日
        </a>
      </div>
    </div>
  </div>

  {% if entries %}
    <div class="grid">
      {% for e in entries %}
        <div class="card">
          <div class="row-top">
            <div class="code-name">
              <div class="code">
                {{ e.code }}{% if e.price_date %}・{{ e.price_date }}{% endif %}
              </div>
              <div class="name">
                {{ e.name|default:"(名称不明)" }}
              </div>
              {% if e.mode %}
                {% if e.mode == "live" %}
                  <div class="mode-badge mode-live">LIVE シミュレ</div>
                {% else %}
                  <div class="mode-badge mode-demo">DEMO シミュレ</div>
                {% endif %}
              {% endif %}
            </div>
            <div class="ts-badge">
              {{ e.ts_label|default:e.ts }}
            </div>
          </div>

          <div class="kpi">
            <div class="kpi-it">
              <div class="kpi-label">エントリー</div>
              <div class="kpi-row">
                <div class="kpi-name">価格</div>
                <div class="kpi-val">
                  {% if e.entry %}
                    {{ e.entry|floatformat:0|intcomma }} 円
                  {% else %}
                    —
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="kpi-it">
              <div class="kpi-label">数量</div>
              <div class="kpi-row">
                <div class="kpi-name">楽天</div>
                <div class="kpi-val">
                  {% if e.qty_rakuten %}{{ e.qty_rakuten|floatformat:0|intcomma }} 株{% else %}0 株{% endif %}
                </div>
              </div>
              <div class="kpi-row">
                <div class="kpi-name">松井</div>
                <div class="kpi-val">
                  {% if e.qty_matsui %}{{ e.qty_matsui|floatformat:0|intcomma }} 株{% else %}0 株{% endif %}
                </div>
              </div>
            </div>

            <div class="kpi-it">
              <div class="kpi-label">想定利益</div>
              <div class="kpi-row">
                <div class="kpi-name">楽天</div>
                <div class="kpi-val pos">
                  {% if e.est_pl_rakuten %}
                    +{{ e.est_pl_rakuten|floatformat:0|intcomma }} 円
                  {% else %}
                    0 円
                  {% endif %}
                </div>
              </div>
              <div class="kpi-row">
                <div class="kpi-name">松井</div>
                <div class="kpi-val pos">
                  {% if e.est_pl_matsui %}
                    +{{ e.est_pl_matsui|floatformat:0|intcomma }} 円
                  {% else %}
                    0 円
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="kpi-it">
              <div class="kpi-label">想定損失</div>
              <div class="kpi-row">
                <div class="kpi-name">楽天</div>
                <div class="kpi-val neg">
                  {% if e.est_loss_rakuten %}
                    -{{ e.est_loss_rakuten|floatformat:0|intcomma }} 円
                  {% else %}
                    0 円
                  {% endif %}
                </div>
              </div>
              <div class="kpi-row">
                <div class="kpi-name">松井</div>
                <div class="kpi-val neg">
                  {% if e.est_loss_matsui %}
                    -{{ e.est_loss_matsui|floatformat:0|intcomma }} 円
                  {% else %}
                    0 円
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          {# ===== 結果入力エリア ===== #}
          <div class="result-block">
            <div class="result-row-top">
              <div class="result-label">結果</div>
              <div class="result-status
                          {% if e.result == 'win' %}win{% elif e.result == 'lose' %}lose{% elif e.result == 'skip' %}skip{% endif %}">
                {% if e.result == 'win' %}
                  勝ち
                {% elif e.result == 'lose' %}
                  負け
                {% elif e.result == 'skip' %}
                  見送り
                {% else %}
                  未入力
                {% endif %}
                {% if e.exit_price %}
                  （終値 {{ e.exit_price|floatformat:0|intcomma }} 円）
                {% endif %}
              </div>
            </div>

            <form method="post"
                  action="{% url 'aiapp:simulate_result' e.id %}">
              {% csrf_token %}
              <div class="result-form-row">
                <select name="result">
                  <option value="" {% if not e.result %}selected{% endif %}>未選択</option>
                  <option value="win" {% if e.result == 'win' %}selected{% endif %}>勝ち</option>
                  <option value="lose" {% if e.result == 'lose' %}selected{% endif %}>負け</option>
                  <option value="skip" {% if e.result == 'skip' %}selected{% endif %}>見送り</option>
                </select>
                <input type="number"
                       name="exit_price"
                       step="0.1"
                       placeholder="終値"
                       value="{% if e.exit_price %}{{ e.exit_price }}{% endif %}">
                <button type="submit">保存</button>
              </div>
            </form>
          </div>

          <div class="card-footer">
            <form method="post"
                  action="{% url 'aiapp:simulate_delete' e.id %}"
                  onsubmit="return confirm('このシミュレを削除しますか？');">
              {% csrf_token %}
              <button type="submit" class="btn-delete">削除</button>
            </form>
          </div>

        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">
      まだシミュレ登録がありません。<br>
      AI Picks 画面から「シミュレ」ボタンを押すと、ここに紙トレが溜まっていきます。
    </div>
  {% endif %}

</div>
{% endblock %}