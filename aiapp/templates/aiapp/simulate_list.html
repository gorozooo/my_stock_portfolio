{% extends "base.html" %}
{% load humanize %}

{% block title %}AIシミュレ一覧{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#020617;
    --card:rgba(15,23,42,0.95);
    --sub:#94a3b8;
    --fg:#e5e7eb;
    --accent:#38bdf8;
    --ok:#22c55e;
    --bad:#f97373;
    --muted:#64748b;
  }
  body{background:var(--bg);color:var(--fg);}
  body.no-scroll{
    position:fixed;
    inset:0;
    overflow:hidden;
  }
  .wrap{max-width:720px;margin:0 auto;padding:10px 12px 80px;}

  /* ===== 上部：PRO残高パネル（2x2圧縮） ===== */
  .pro-top{
    margin-bottom:10px;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.35);
    background:radial-gradient(circle at top left,rgba(56,189,248,0.16),rgba(15,23,42,0.94));
    backdrop-filter:blur(10px);
  }
  .pro-title{
    font-size:12px;
    font-weight:700;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    margin-bottom:6px;
  }
  .pro-sub{
    font-size:11px;
    color:var(--sub);
    font-variant-numeric:tabular-nums;
    white-space:nowrap;
  }

  /* ★ 2x2固定（縦を短くする） */
  .pro-grid{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:8px;
  }

  .pro-kv{
    border:1px solid rgba(148,163,184,0.25);
    border-radius:12px;
    padding:8px 10px;
    background:rgba(15,23,42,0.88);
  }
  .pro-kv .k{
    font-size:11px;
    color:var(--sub);
    margin-bottom:2px;
  }
  .pro-kv .v{
    font-size:14px;
    font-weight:800;
    font-variant-numeric:tabular-nums;
    letter-spacing:0.2px;
  }
  .pro-kv .v.pos{ color:var(--ok); }
  .pro-kv .v.neg{ color:var(--bad); }
  .pro-kv .mini{
    margin-top:3px;
    font-size:10px;
    color:var(--muted);
    font-variant-numeric:tabular-nums;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* 建玉カードだけ少し情報を詰める */
  .pro-kv.compact .v{
    font-size:13px;
    font-weight:800;
  }
  .pro-kv.compact .mini{
    margin-top:2px;
  }

  /* ===== KPIカード（選択日 / 通算） ===== */
  .kpi-top{
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:6px;
    margin-bottom:8px;
  }
  @media (max-width:480px){
    .kpi-top{ grid-template-columns:repeat(2,minmax(0,1fr)); }
  }
  .kpi-card{
    padding:7px 9px;
    border-radius:12px;
    border:1px solid rgba(148,163,184,0.35);
    background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(17,94,163,0.85));
    font-size:11px;
    line-height:1.25;
    backdrop-filter:blur(10px);
  }
  .kpi-title{
    font-size:11px;
    font-weight:700;
    margin-bottom:3px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .kpi-counts{
    display:flex;
    flex-wrap:wrap;
    gap:4px 6px;
    margin-bottom:3px;
  }
  .kpi-count{
    font-size:10px;
    font-variant-numeric:tabular-nums;
  }
  .kpi-count span.label{ color:var(--sub); margin-right:2px; }
  .kpi-pl{
    font-size:10px;
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:6px;
  }
  .kpi-pl-val{
    font-variant-numeric:tabular-nums;
    font-weight:800;
    margin-left:6px;
    white-space:nowrap;
  }
  .kpi-pl-val.pos{color:var(--ok);}
  .kpi-pl-val.neg{color:var(--bad);}

  /* ===== フィルタ部 ===== */
  .filters{
    margin:0 0 10px 0;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.35);
    background:rgba(15,23,42,0.9);
    backdrop-filter:blur(10px);
    font-size:12px;
  }
  .filter-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    margin-bottom:6px;
    flex-wrap:wrap;
  }
  .filter-label{
    font-size:11px;
    color:var(--sub);
    min-width:64px;
  }
  .chip-row{
    display:flex;
    gap:6px;
    flex-wrap:wrap;
  }
  .chip-form{margin:0;}
  .chip-btn{
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.6);
    padding:4px 10px;
    background:rgba(15,23,42,0.9);
    color:#e5e7eb;
    font-size:11px;
    line-height:1.2;
  }
  .chip-btn.active{
    background:rgba(56,189,248,0.18);
    border-color:rgba(56,189,248,0.9);
    color:#e0f2fe;
    font-weight:600;
  }

  .date-form{
    display:flex;
    align-items:center;
    gap:8px;
    flex:1;
  }
  .date-input{
    flex:1;
    min-width:0;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.6);
    background:rgba(15,23,42,0.9);
    color:#e5e7eb;
    font-size:12px;
    padding:6px 10px;
  }
  .date-input::-webkit-calendar-picker-indicator{ filter:invert(1); }

  .search-row{
    display:flex;
    gap:6px;
    margin-top:4px;
  }
  .search-input{
    flex:1;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.6);
    background:rgba(15,23,42,0.9);
    color:#e5e7eb;
    font-size:12px;
    padding:6px 10px;
  }
  .search-input::placeholder{ color:rgba(148,163,184,0.9); }
  .search-btn{
    border-radius:999px;
    border:1px solid rgba(56,189,248,0.8);
    background:rgba(56,189,248,0.18);
    color:#e0f2fe;
    font-size:12px;
    padding:6px 10px;
    white-space:nowrap;
  }

  .grid{display:grid;gap:10px;}

  .card{
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.35);
    background:radial-gradient(circle at top left,rgba(56,189,248,0.10),rgba(15,23,42,0.95));
    padding:10px 12px;
    backdrop-filter:blur(10px);
  }

  /* ===== 上部レイアウト ===== */
  .row-top{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:8px;
  }

  .code-name{ min-width:0; flex:1; }

  .ts-badge{
    flex-shrink:0;
    font-size:11px;
    color:var(--sub);
    text-align:right;
  }

  .code{
    font-size:13px;
    color:var(--sub);
    margin-bottom:2px;
  }

  .name{
    font-size:15px;
    font-weight:600;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:clip;
    max-width:22ch;
  }

  .mode-badge{
    display:inline-block;
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.8);
    margin-top:4px;
  }
  .mode-demo{
    background:rgba(59,130,246,0.18);
    color:#bfdbfe;
  }
  .mode-live{
    background:rgba(22,163,74,0.18);
    color:#bbf7d0;
  }

  .head-result-chip{ margin-top:4px; }

  .result-badge{
    font-size:10px;
    padding:2px 6px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.6);
  }
  .result-badge-win{
    background:rgba(34,197,94,0.2);
    border-color:rgba(34,197,94,0.8);
    color:#bbf7d0;
  }
  .result-badge-lose{
    background:rgba(248,113,113,0.18);
    border-color:rgba(248,113,113,0.9);
    color:#fecaca;
  }
  .result-badge-flat{
    background:rgba(148,163,184,0.2);
    border-color:rgba(148,163,184,0.9);
    color:#e5e7eb;
  }
  .result-badge-none{
    background:rgba(15,23,42,0.9);
    border-color:rgba(148,163,184,0.6);
    color:#9ca3af;
  }

  /* ===== メイン2カラム ===== */
  .body-cols{
    display:grid;
    grid-template-columns:minmax(0,1.05fr) minmax(0,1.1fr);
    gap:8px;
    margin-top:8px;
  }

  .ai-box,
  .real-box{
    padding:8px 8px 7px;
    border-radius:10px;
    background:rgba(15,23,42,0.96);
    border:1px solid rgba(30,64,175,0.6);
    font-size:11px;
  }

  .ai-title,
  .real-title{
    font-size:11px;
    font-weight:600;
    margin-bottom:4px;
    color:#e5e7eb;
  }
  .ai-row,
  .real-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:4px;
    margin-top:2px;
  }
  .ai-label,
  .real-label{
    color:var(--muted);
    font-size:11px;
  }
  .ai-val,
  .real-val{
    font-variant-numeric:tabular-nums;
    font-size:11px;
    text-align:right;
  }

  .ai-section{
    margin-top:4px;
    padding-top:4px;
    border-top:1px dashed rgba(148,163,184,0.4);
  }

  .ai-val.pos{color:var(--ok);}
  .ai-val.neg{color:var(--bad);}

  .real-section{
    margin-top:4px;
    padding-top:4px;
    border-top:1px dashed rgba(148,163,184,0.5);
  }

  .real-note{
    font-size:10px;
    color:var(--sub);
    margin-top:2px;
  }

  .real-pl-wrap{ margin-top:4px; }
  .real-pl-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:2px;
  }
  .result-pl{
    font-variant-numeric:tabular-nums;
    font-size:12px;
  }
  .result-pl.pos{color:var(--ok);}
  .result-pl.neg{color:var(--bad);}

  .empty{
    margin-top:16px;
    padding:16px;
    border-radius:12px;
    border:1px dashed rgba(148,163,184,0.6);
    font-size:13px;
    color:#cbd5f5;
  }

  .delete-row{
    margin-top:6px;
    text-align:right;
  }

  .delete-link{
    font-size:11px;
    color:#fca5a5;
    background:transparent;
    border:0;
    padding:0;
    cursor:pointer;
    text-decoration:none;
  }
</style>

<script>
  // iOS の date ピッカーを開いている間、背面のスクロールを止める
  document.addEventListener('focusin', function(e){
    if (e.target.matches('input[type="date"]')) {
      var body = document.body;
      body.dataset.scrollY = window.scrollY || 0;
      body.classList.add('no-scroll');
    }
  });
  document.addEventListener('focusout', function(e){
    if (e.target.matches('input[type="date"]')) {
      var body = document.body;
      var y = parseInt(body.dataset.scrollY || '0', 10);
      body.classList.remove('no-scroll');
      window.scrollTo(0, y);
    }
  });

  // 日付が変わったら即サブミット
  document.addEventListener('DOMContentLoaded', function(){
    var dateInput = document.querySelector('.date-input');
    if (dateInput && dateInput.form) {
      dateInput.addEventListener('change', function(){
        dateInput.form.submit();
      });
    }
  });
</script>
{% endblock %}

{% block content %}
<div class="wrap">

  <!-- ===== PRO残高パネル（2x2） ===== -->
  <div class="pro-top">
    <div class="pro-title">
      <div>仮想口座残高</div>
      <div class="pro-sub">建玉 {{ pro_account.open_count|default:0 }} / {{ pro_account.max_positions|default:5 }} ・上限 {{ pro_account.max_total_risk_r|default:3.0 }}R</div>
    </div>

    <div class="pro-grid">
      <div class="pro-kv">
        <div class="k">口座資金</div>
        <div class="v">
          {{ pro_account.equity_yen|default:0|floatformat:0|intcomma }} 円
        </div>
      </div>

      <div class="pro-kv">
        <div class="k">拘束中（OPEN合計）</div>
        <div class="v">
          {{ pro_account.reserved_yen|default:0|floatformat:0|intcomma }} 円
        </div>
      </div>

      <div class="pro-kv">
        <div class="k">余力</div>
        <div class="v {% if pro_account.free_yen|default:0 > 0 %}pos{% else %}neg{% endif %}">
          {{ pro_account.free_yen|default:0|floatformat:0|intcomma }} 円
        </div>
      </div>

      <div class="pro-kv compact">
        <div class="k">建玉 / 制限</div>
        <div class="v">
          {{ pro_account.open_count|default:0 }} / {{ pro_account.max_positions|default:5 }}
          ・{{ pro_account.max_total_risk_r|default:3.0 }}R
        </div>
      </div>
    </div>
  </div>

  <!-- ===== KPI（左右2カラム / 小型） ===== -->
  <div class="kpi-top">
    <div class="kpi-card">
      <div class="kpi-title">選択日の成績（PRO公式）{% if selected_date_str %}：{{ selected_date_str }}{% endif %}</div>
      {% if summary_selected.has_data %}
        <div class="kpi-counts">
          <div class="kpi-count"><span class="label">勝</span>{{ summary_selected.win }}</div>
          <div class="kpi-count"><span class="label">負</span>{{ summary_selected.lose }}</div>
          <div class="kpi-count"><span class="label">見/持</span>{{ summary_selected.skip }}</div>
          {% if summary_selected.flat %}
            <div class="kpi-count"><span class="label">分</span>{{ summary_selected.flat }}</div>
          {% endif %}
        </div>
        <div class="kpi-pl">
          <span style="color:var(--sub);">合計</span>
          <span class="kpi-pl-val {% if summary_selected.total_pl >= 0 %}pos{% else %}neg{% endif %}">
            {{ summary_selected.total_pl|floatformat:0|intcomma }} 円
          </span>
        </div>
      {% else %}
        <div class="kpi-pl"><span style="color:var(--sub);">この日のシミュレなし</span><span class="kpi-pl-val pos">0 円</span></div>
      {% endif %}
    </div>

    <div class="kpi-card">
      <div class="kpi-title">通算成績（全期間 / PRO公式）</div>
      {% if summary_total.has_data %}
        <div class="kpi-counts">
          <div class="kpi-count"><span class="label">勝</span>{{ summary_total.win }}</div>
          <div class="kpi-count"><span class="label">負</span>{{ summary_total.lose }}</div>
          <div class="kpi-count"><span class="label">見/持</span>{{ summary_total.skip }}</div>
          {% if summary_total.flat %}
            <div class="kpi-count"><span class="label">分</span>{{ summary_total.flat }}</div>
          {% endif %}
        </div>
        <div class="kpi-pl">
          <span style="color:var(--sub);">合計</span>
          <span class="kpi-pl-val {% if summary_total.total_pl >= 0 %}pos{% else %}neg{% endif %}">
            {{ summary_total.total_pl|floatformat:0|intcomma }} 円
          </span>
        </div>
      {% else %}
        <div class="kpi-pl"><span style="color:var(--sub);">履歴なし</span><span class="kpi-pl-val pos">0 円</span></div>
      {% endif %}
    </div>
  </div>

  <div class="filters">
    <!-- モードフィルタ -->
    <div class="filter-row">
      <div class="filter-label">モード</div>
      <div class="chip-row">
        <form method="get" class="chip-form">
          <input type="hidden" name="date" value="{{ selected_date_str }}">
          <input type="hidden" name="q" value="{{ q }}">
          <button type="submit" name="mode" value="all"
                  class="chip-btn {% if mode == 'all' %}active{% endif %}">ALL</button>
        </form>
        <form method="get" class="chip-form">
          <input type="hidden" name="date" value="{{ selected_date_str }}">
          <input type="hidden" name="q" value="{{ q }}">
          <button type="submit" name="mode" value="live"
                  class="chip-btn {% if mode == 'live' %}active{% endif %}">LIVE</button>
        </form>
        <form method="get" class="chip-form">
          <input type="hidden" name="date" value="{{ selected_date_str }}">
          <input type="hidden" name="q" value="{{ q }}">
          <button type="submit" name="mode" value="demo"
                  class="chip-btn {% if mode == 'demo' %}active{% endif %}">DEMO</button>
        </form>
      </div>
    </div>

    <!-- 日付フィルタ（iOS ホイール） -->
    <div class="filter-row">
      <div class="filter-label">日付</div>
      <form method="get" class="date-form">
        <input type="hidden" name="mode" value="{{ mode }}">
        <input type="hidden" name="q" value="{{ q }}">
        <input type="date"
               name="date"
               class="date-input"
               value="{{ selected_date_str }}">
      </form>
    </div>

    <!-- 銘柄検索 -->
    <form method="get" class="search-row">
      <input type="hidden" name="mode" value="{{ mode }}">
      <input type="hidden" name="date" value="{{ selected_date_str }}">
      <input type="text"
             name="q"
             value="{{ q }}"
             class="search-input"
             placeholder="銘柄コード or 名称で検索（PRO公式のみ）">
      <button type="submit" class="search-btn">検索</button>
    </form>
  </div>

  {% if entries %}
    <div class="grid">
      {% for e in entries %}
        <div class="card">
          <div class="row-top">
            <div class="code-name">
              <div class="code">
                {{ e.code }}{% if e.price_date %}・{{ e.price_date }}{% endif %}
              </div>
              <div class="name">
                {{ e.name|default:"(名称不明)" }}
              </div>

              {% if e.mode %}
                {% if e.mode == "live" %}
                  <div class="mode-badge mode-live">LIVE シミュレ</div>
                {% else %}
                  <div class="mode-badge mode-demo">DEMO シミュレ</div>
                {% endif %}
              {% endif %}

              {% if e.combined_label %}
                <div class="head-result-chip">
                  <span class="result-badge
                    {% if e.combined_label == 'win' %}
                      result-badge-win
                    {% elif e.combined_label == 'lose' %}
                      result-badge-lose
                    {% elif e.combined_label == 'flat' %}
                      result-badge-flat
                    {% else %}
                      result-badge-none
                    {% endif %}
                  ">
                    {% if e.combined_label == 'win' %}
                      勝ち
                    {% elif e.combined_label == 'lose' %}
                      負け
                    {% elif e.combined_label == 'flat' %}
                      引き分け
                    {% elif e.combined_label == 'carry' %}
                      持ち越し
                    {% elif e.combined_label == 'skip' %}
                      見送り
                    {% else %}
                      -
                    {% endif %}
                  </span>
                </div>
              {% endif %}
            </div>

            <div class="ts-badge">
              {{ e.ts_label|default:e.ts }}
            </div>
          </div>

          <div class="body-cols">
            <!-- ===== 左：AIスナップ（PRO指値） ===== -->
            <div class="ai-box">
              <div class="ai-title">AIスナップ（PRO指値）</div>
              <div class="ai-row">
                <div class="ai-label">エントリー</div>
                <div class="ai-val">
                  {% if e.entry %}
                    {{ e.entry|floatformat:0|intcomma }} 円
                  {% else %}—{% endif %}
                </div>
              </div>
              <div class="ai-row">
                <div class="ai-label">TP</div>
                <div class="ai-val">
                  {% if e.tp %}{{ e.tp|floatformat:0|intcomma }} 円{% else %}—{% endif %}
                </div>
              </div>
              <div class="ai-row">
                <div class="ai-label">SL</div>
                <div class="ai-val">
                  {% if e.sl %}{{ e.sl|floatformat:0|intcomma }} 円{% else %}—{% endif %}
                </div>
              </div>

              <div class="ai-section">
                <div>数量 / 必要資金</div>
                <div class="ai-row">
                  <div class="ai-label">PRO数量</div>
                  <div class="ai-val">
                    {{ e.qty_pro|floatformat:0|intcomma }} 株
                  </div>
                </div>
                <div class="ai-row">
                  <div class="ai-label">必要資金</div>
                  <div class="ai-val">
                    {% if e.required_cash_pro %}
                      {{ e.required_cash_pro|floatformat:0|intcomma }} 円
                    {% else %}0 円{% endif %}
                  </div>
                </div>
              </div>

              <div class="ai-section">
                <div>想定PL（PRO）</div>
                <div class="ai-row">
                  <div class="ai-label">想定利益</div>
                  <div class="ai-val pos">
                    {% if e.est_pl_pro %}
                      +{{ e.est_pl_pro|floatformat:0|intcomma }} 円
                    {% else %}0 円{% endif %}
                  </div>
                </div>
                <div class="ai-row">
                  <div class="ai-label">想定損失</div>
                  <div class="ai-val neg">
                    {% if e.est_loss_pro %}
                      -{{ e.est_loss_pro|floatformat:0|intcomma }} 円
                    {% else %}0 円{% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- ===== 右：シミュ結果（約定＆評価） ===== -->
            <div class="real-box">
              <div class="real-title">
                シミュ結果{% if e.eval_horizon_days %}（{{ e.eval_horizon_days }}営業日後）{% endif %}
              </div>

              <div class="real-section">
                <div>約定</div>
                {% if e.eval_entry_px %}
                  <div class="real-row">
                    <div class="real-label">価格</div>
                    <div class="real-val">
                      {{ e.eval_entry_px|floatformat:0|intcomma }} 円
                    </div>
                  </div>
                  {% if e.entry_label %}
                    <div class="real-row">
                      <div class="real-label">時刻</div>
                      <div class="real-val">
                        {{ e.entry_label }}
                      </div>
                    </div>
                  {% endif %}
                {% else %}
                  <div class="real-note">
                    約定できず
                  </div>
                {% endif %}
              </div>

              <div class="real-section">
                <div>決済</div>
                {% if e.exit_reason_label %}
                  <div class="real-row">
                    <div class="real-label">結果</div>
                    <div class="real-val">
                      {{ e.exit_reason_label }}
                    </div>
                  </div>
                  {% if e.exit_label %}
                    <div class="real-row">
                      <div class="real-label">時刻</div>
                      <div class="real-val">
                        {{ e.exit_label }}
                      </div>
                    </div>
                  {% endif %}
                {% elif e.eval_exit_reason %}
                  <div class="real-row">
                    <div class="real-label">結果</div>
                    <div class="real-val">
                      {{ e.eval_exit_reason }}
                    </div>
                  </div>
                {% else %}
                  <div class="real-note">
                    まだ評価が実行されていません（ai_sim_eval 未実行）
                  </div>
                {% endif %}
              </div>

              <div class="real-section">
                <div class="real-pl-wrap">
                  <div>損益（PRO）</div>
                  <div class="real-pl-row">
                    <div class="real-label">実績PL</div>
                    <div>
                      {% if e.eval_pl_pro is None %}
                        <span class="result-pl">—</span>
                      {% else %}
                        <span class="result-pl {% if e.eval_pl_pro >= 0 %}pos{% else %}neg{% endif %}">
                          {{ e.eval_pl_pro|floatformat:0|intcomma }} 円
                        </span>
                      {% endif %}
                    </div>
                  </div>
                  <div class="real-note">
                    ※carry（未確定）の間は “—” 表示。確定するとPLが出ます（replay.pro.last_eval.pl_pro）。
                  </div>
                </div>
              </div>
            </div>
          </div>

          <form method="post"
                action="{% url 'aiapp:simulate_delete' e.id %}"
                class="delete-row"
                onsubmit="return confirm('このシミュレ記録を削除しますか？');">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" class="delete-link">このシミュレを削除</button>
          </form>

        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">
      条件に一致するシミュレ登録がありません。<br>
      日付やモード・銘柄検索を少しゆるめてみてください。
    </div>
  {% endif %}

</div>
{% endblock %}