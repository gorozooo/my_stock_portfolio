{% extends "base.html" %}
{% load humanize %}

{% block title %}AIシミュレ一覧{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#020617;
    --card:rgba(15,23,42,0.95);
    --sub:#94a3b8;
    --fg:#e5e7eb;
    --accent:#38bdf8;
    --ok:#22c55e;
    --bad:#f97373;
    --muted:#64748b;
  }
  body{background:var(--bg);color:var(--fg);}
  .wrap{max-width:720px;margin:0 auto;padding:10px 12px 80px;}

  .head{
    padding:14px;
    border-radius:16px;
    border:1px solid rgba(148,163,184,0.3);
    background:linear-gradient(135deg,rgba(15,23,42,0.95),rgba(30,64,175,0.8));
    color:#e5e7eb;
    margin:6px 0 12px 0;
    backdrop-filter:blur(12px);
  }
  .head-title{
    font-size:16px;
    font-weight:700;
    margin-bottom:4px;
  }
  .head-sub{
    font-size:12px;
    color:#cbd5f5;
  }

  /* ===== サマリーバー ===== */
  .summary-bar{
    margin:0 0 10px 0;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.35);
    background:linear-gradient(135deg,rgba(15,23,42,0.96),rgba(17,94,163,0.85));
    backdrop-filter:blur(10px);
    font-size:12px;
  }
  .summary-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:8px;
    margin-bottom:4px;
  }
  .summary-title{
    font-size:12px;
    font-weight:600;
    color:#e5e7eb;
  }
  .summary-mode{
    font-size:11px;
    color:#cbd5f5;
  }
  .summary-counts{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-bottom:4px;
  }
  .summary-count{
    font-size:12px;
  }
  .summary-count span.label{
    color:var(--sub);
    margin-right:2px;
  }
  .summary-pl{
    font-size:12px;
    color:#cbd5f5;
  }
  .summary-pl-val{
    font-variant-numeric:tabular-nums;
    font-weight:600;
    margin-left:4px;
  }
  .summary-pl-val.pos{color:var(--ok);}
  .summary-pl-val.neg{color:var(--bad);}

  /* ===== フィルタ部 ===== */
  .filters{
    margin:0 0 10px 0;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.35);
    background:rgba(15,23,42,0.9);
    backdrop-filter:blur(10px);
    font-size:12px;
  }
  .filter-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    margin-bottom:6px;
    flex-wrap:wrap;
  }
  .filter-label{
    font-size:11px;
    color:var(--sub);
    min-width:64px;
  }
  .chip-row{
    display:flex;
    gap:6px;
    flex-wrap:wrap;
  }
  .chip-form{
    margin:0;
  }
  .chip-btn{
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.6);
    padding:4px 10px;
    background:rgba(15,23,42,0.9);
    color:#e5e7eb;
    font-size:11px;
    line-height:1.2;
  }
  .chip-btn.active{
    background:rgba(56,189,248,0.18);
    border-color:rgba(56,189,248,0.9);
    color:#e0f2fe;
    font-weight:600;
  }

  .search-row{
    display:flex;
    gap:6px;
    margin-top:4px;
  }
  .search-input{
    flex:1;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.6);
    background:rgba(15,23,42,0.9);
    color:#e5e7eb;
    font-size:12px;
    padding:6px 10px;
  }
  .search-input::placeholder{
    color:rgba(148,163,184,0.9);
  }
  .search-btn{
    border-radius:999px;
    border:1px solid rgba(56,189,248,0.8);
    background:rgba(56,189,248,0.18);
    color:#e0f2fe;
    font-size:12px;
    padding:6px 10px;
    white-space:nowrap;
  }

  .grid{display:grid;gap:10px;}

  .card{
    border-radius:14px;
    border:1px solid rgba(148,163,184,0.35);
    background:radial-gradient(circle at top left,rgba(56,189,248,0.10),rgba(15,23,42,0.95));
    padding:10px 12px;
    backdrop-filter:blur(10px);
  }

  /* ===== ヘッダー部分 ===== */
  .row-top{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:8px;
    margin-bottom:6px;
  }
  .code-name{
    min-width:0;
    flex:1;
  }
  .code{
    font-size:13px;
    color:var(--sub);
    margin-bottom:2px;
  }
  .name{
    font-size:15px;
    font-weight:600;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:22ch;
  }
  .ts-badge{
    flex-shrink:0;
    font-size:11px;
    color:var(--sub);
    text-align:right;
  }

  .mode-row{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:6px;
    margin-top:4px;
  }
  .mode-badge{
    display:inline-block;
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.8);
  }
  .mode-demo{
    background:rgba(59,130,246,0.18);
    color:#bfdbfe;
  }
  .mode-live{
    background:rgba(22,163,74,0.18);
    color:#bbf7d0;
  }
  .pill-status{
    font-size:11px;
    padding:2px 8px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.7);
  }
  .pill-win{background:rgba(34,197,94,0.18);border-color:rgba(34,197,94,0.8);color:#bbf7d0;}
  .pill-lose{background:rgba(248,113,113,0.18);border-color:rgba(248,113,113,0.9);color:#fecaca;}
  .pill-flat{background:rgba(148,163,184,0.18);border-color:rgba(148,163,184,0.9);color:#e5e7eb;}
  .pill-skip{background:rgba(15,23,42,0.9);border-color:rgba(148,163,184,0.7);color:#9ca3af;}

  /* ===== 本体 2カラム ===== */
  .panels{
    margin-top:8px;
    display:grid;
    grid-template-columns:repeat(2,minmax(0,1fr));
    gap:8px;
  }
  @media (max-width: 480px){
    .panels{grid-template-columns:1fr;}
  }
  .panel{
    border-radius:10px;
    background:rgba(15,23,42,0.95);
    border:1px solid rgba(30,64,175,0.6);
    padding:8px 9px;
    font-size:12px;
  }
  .panel-title{
    font-size:11px;
    font-weight:600;
    margin-bottom:2px;
  }
  .panel-sub{
    font-size:10px;
    color:var(--sub);
    margin-bottom:6px;
  }
  .row{
    display:flex;
    justify-content:space-between;
    margin-top:2px;
  }
  .row-label{
    font-size:11px;
    color:var(--muted);
  }
  .row-val{
    font-size:12px;
    font-variant-numeric:tabular-nums;
  }
  .row-val.pos{color:var(--ok);}
  .row-val.neg{color:var(--bad);}

  .panel-section{
    margin-top:6px;
    padding-top:4px;
    border-top:1px dashed rgba(148,163,184,0.4);
  }
  .panel-section-title{
    font-size:11px;
    color:var(--sub);
    margin-bottom:2px;
  }

  .result-summary{
    margin-top:8px;
    padding:6px 8px;
    border-radius:10px;
    background:rgba(15,23,42,0.9);
    border:1px dashed rgba(148,163,184,0.6);
    font-size:11px;
    color:var(--sub);
  }

  .delete-row{
    margin-top:6px;
    text-align:right;
  }
  .delete-link{
    font-size:11px;
    color:#fca5a5;
    text-decoration:none;
  }

  .empty{
    margin-top:16px;
    padding:16px;
    border-radius:12px;
    border:1px dashed rgba(148,163,184,0.6);
    font-size:13px;
    color:#cbd5f5;
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <div class="head">
    <div class="head-title">AIシミュレ一覧</div>
    <div class="head-sub">
      AI Picks の「シミュレ」で登録した紙トレのログです。<br>
      フィルタで絞り込みつつ、直近100件まで表示しています。
    </div>
  </div>

  {% if summary.has_data %}
    <div class="summary-bar">
      <div class="summary-header">
        <div class="summary-title">
          本日の{% if mode == "demo" %}DEMO{% elif mode == "live" %}LIVE{% else %}ALL{% endif %}成績
        </div>
        <div class="summary-mode">
          表示中のフィルタ: モード={{ mode|upper }} / 期間=
          {% if period == "today" %}今日{% elif period == "7d" %}7日{% else %}30日{% endif %}
        </div>
      </div>
      <div class="summary-counts">
        <div class="summary-count"><span class="label">勝ち</span>{{ summary.win }}件</div>
        <div class="summary-count"><span class="label">負け</span>{{ summary.lose }}件</div>
        <div class="summary-count"><span class="label">見送り</span>{{ summary.skip }}件</div>
        {% if summary.flat %}
          <div class="summary-count"><span class="label">引き分け</span>{{ summary.flat }}件</div>
        {% endif %}
      </div>
      <div class="summary-pl">
        合計
        <span class="summary-pl-val {% if summary.total_pl >= 0 %}pos{% else %}neg{% endif %}">
          {{ summary.total_pl|floatformat:0|intcomma }} 円
        </span>
      </div>
    </div>
  {% endif %}

  <div class="filters">
    <!-- モードフィルタ -->
    <div class="filter-row">
      <div class="filter-label">モード</div>
      <div class="chip-row">
        <form method="get" class="chip-form">
          <input type="hidden" name="period" value="{{ period }}">
          <input type="hidden" name="q" value="{{ q }}">
          <button type="submit" name="mode" value="all"
                  class="chip-btn {% if mode == 'all' %}active{% endif %}">ALL</button>
        </form>
        <form method="get" class="chip-form">
          <input type="hidden" name="period" value="{{ period }}">
          <input type="hidden" name="q" value="{{ q }}">
          <button type="submit" name="mode" value="live"
                  class="chip-btn {% if mode == 'live' %}active{% endif %}">LIVE</button>
        </form>
        <form method="get" class="chip-form">
          <input type="hidden" name="period" value="{{ period }}">
          <input type="hidden" name="q" value="{{ q }}">
          <button type="submit" name="mode" value="demo"
                  class="chip-btn {% if mode == 'demo' %}active{% endif %}">DEMO</button>
        </form>
      </div>
    </div>

    <!-- 期間フィルタ -->
    <div class="filter-row">
      <div class="filter-label">期間</div>
      <div class="chip-row">
        <form method="get" class="chip-form">
          <input type="hidden" name="mode" value="{{ mode }}">
          <input type="hidden" name="q" value="{{ q }}">
          <button type="submit" name="period" value="today"
                  class="chip-btn {% if period == 'today' %}active{% endif %}">今日</button>
        </form>
        <form method="get" class="chip-form">
          <input type="hidden" name="mode" value="{{ mode }}">
          <input type="hidden" name="q" value="{{ q }}">
          <button type="submit" name="period" value="7d"
                  class="chip-btn {% if period == '7d' %}active{% endif %}">7日</button>
        </form>
        <form method="get" class="chip-form">
          <input type="hidden" name="mode" value="{{ mode }}">
          <input type="hidden" name="q" value="{{ q }}">
          <button type="submit" name="period" value="30d"
                  class="chip-btn {% if period == '30d' %}active{% endif %}">30日</button>
        </form>
      </div>
    </div>

    <!-- 銘柄検索 -->
    <form method="get" class="search-row">
      <input type="hidden" name="mode" value="{{ mode }}">
      <input type="hidden" name="period" value="{{ period }}">
      <input type="text"
             name="q"
             value="{{ q }}"
             class="search-input"
             placeholder="銘柄コード or 名称で検索">
      <button type="submit" class="search-btn">検索</button>
    </form>
  </div>

  {% if entries %}
    <div class="grid">
      {% for e in entries %}
        <div class="card">
          <div class="row-top">
            <div class="code-name">
              <div class="code">
                {{ e.code }}{% if e.price_date %}・{{ e.price_date }}{% endif %}
              </div>
              <div class="name">
                {{ e.name|default:"(名称不明)" }}
              </div>
              <div class="mode-row">
                {% if e.mode %}
                  {% if e.mode == "live" %}
                    <span class="mode-badge mode-live">LIVE シミュレ</span>
                  {% else %}
                    <span class="mode-badge mode-demo">DEMO シミュレ</span>
                  {% endif %}
                {% endif %}

                {# ステータスピル（タイムアップは専用） #}
                {% if e.exit_reason == "horizon_close" %}
                  <span class="pill-status pill-flat">タイムアップ</span>
                {% else %}
                  {% if e.combined_label == "win" %}
                    <span class="pill-status pill-win">勝ち</span>
                  {% elif e.combined_label == "lose" %}
                    <span class="pill-status pill-lose">負け</span>
                  {% elif e.combined_label == "flat" %}
                    <span class="pill-status pill-flat">引き分け</span>
                  {% elif e.combined_label == "skip" %}
                    <span class="pill-status pill-skip">見送り</span>
                  {% endif %}
                {% endif %}
              </div>
            </div>
            <div class="ts-badge">
              {{ e.ts_label|default:e.ts }}
            </div>
          </div>

          <div class="panels">
            <!-- 左：AIスナップ -->
            <div class="panel">
              <div class="panel-title">AIスナップ（注文イメージ）</div>
              <div class="panel-sub">
                シミュレ登録時点の AI 提案値（固定スナップショット）
              </div>

              <div class="row">
                <div class="row-label">エントリー指値</div>
                <div class="row-val">
                  {% if e.entry %}
                    {{ e.entry|floatformat:0|intcomma }} 円
                  {% else %}—{% endif %}
                </div>
              </div>
              <div class="row">
                <div class="row-label">TP</div>
                <div class="row-val">
                  {% if e.tp %}
                    {{ e.tp|floatformat:0|intcomma }} 円
                  {% else %}—{% endif %}
                </div>
              </div>
              <div class="row">
                <div class="row-label">SL</div>
                <div class="row-val">
                  {% if e.sl %}
                    {{ e.sl|floatformat:0|intcomma }} 円
                  {% else %}—{% endif %}
                </div>
              </div>

              <div class="panel-section">
                <div class="panel-section-title">数量（AI 想定）</div>
                <div class="row">
                  <div class="row-label">楽天</div>
                  <div class="row-val">
                    {% if e.qty_rakuten %}
                      {{ e.qty_rakuten|floatformat:0|intcomma }} 株
                    {% else %}
                      0 株
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="row-label">松井</div>
                  <div class="row-val">
                    {% if e.qty_matsui %}
                      {{ e.qty_matsui|floatformat:0|intcomma }} 株
                    {% else %}
                      0 株
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="panel-section">
                <div class="panel-section-title">想定利益 / 損失</div>
                <div class="row">
                  <div class="row-label">想定利益（楽天）</div>
                  <div class="row-val pos">
                    {% if e.est_pl_rakuten %}
                      +{{ e.est_pl_rakuten|floatformat:0|intcomma }} 円
                    {% else %}
                      0 円
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="row-label">想定損失（楽天）</div>
                  <div class="row-val neg">
                    {% if e.est_loss_rakuten %}
                      -{{ e.est_loss_rakuten|floatformat:0|intcomma }} 円
                    {% else %}
                      0 円
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="row-label">想定利益（松井）</div>
                  <div class="row-val pos">
                    {% if e.est_pl_matsui %}
                      +{{ e.est_pl_matsui|floatformat:0|intcomma }} 円
                    {% else %}
                      0 円
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="row-label">想定損失（松井）</div>
                  <div class="row-val neg">
                    {% if e.est_loss_matsui %}
                      -{{ e.est_loss_matsui|floatformat:0|intcomma }} 円
                    {% else %}
                      0 円
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- 右：シミュ結果 -->
            <div class="panel">
              <div class="panel-title">
                シミュ結果（{{ e.eval_horizon_days|default:"?" }}営業日後）
              </div>
              <div class="panel-sub">
                {% if e.eval_close_date %}
                  {{ e.eval_close_date }}・決済価格
                  {% if e.eval_close_px %}
                    {{ e.eval_close_px|floatformat:0|intcomma }} 円
                  {% else %}—{% endif %}
                {% endif %}
              </div>

              <div class="panel-section">
                <div class="panel-section-title">エントリー（実際）</div>
                <div class="row">
                  <div class="row-label">約定価格</div>
                  <div class="row-val">
                    {% if e.eval_entry_px %}
                      {{ e.eval_entry_px|floatformat:0|intcomma }} 円
                    {% elif e.entry %}
                      {{ e.entry|floatformat:0|intcomma }} 円
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="row-label">楽天数量</div>
                  <div class="row-val">
                    {% if e.qty_rakuten %}
                      {{ e.qty_rakuten|floatformat:0|intcomma }} 株
                    {% else %}0 株{% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="row-label">松井数量</div>
                  <div class="row-val">
                    {% if e.qty_matsui %}
                      {{ e.qty_matsui|floatformat:0|intcomma }} 株
                    {% else %}0 株{% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="row-label">約定時刻</div>
                  <div class="row-val">
                    {% if e.entry_label %}
                      {{ e.entry_label }}
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="panel-section">
                <div class="panel-section-title">決済</div>
                <div class="row">
                  <div class="row-label">評価結果</div>
                  <div class="row-val">
                    {% if e.combined_label == "skip" %}
                      指値に一度も触れなかった
                    {% else %}
                      {% if e.exit_reason == "horizon_close" %}
                        タイムアップ
                      {% elif e.exit_reason == "hit_tp" %}
                        利確
                      {% elif e.exit_reason == "hit_sl" %}
                        損切
                      {% elif e.exit_reason_label %}
                        {{ e.exit_reason_label }}
                      {% else %}
                        -
                      {% endif %}
                      {% if e.exit_label %}（{{ e.exit_label }}）{% endif %}
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="row-label">決済時刻</div>
                  <div class="row-val">
                    {% if e.exit_label %}
                      {{ e.exit_label }}
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="panel-section">
                <div class="panel-section-title">損益（実際）</div>
                <div class="row">
                  <div class="row-label">楽天</div>
                  <div class="row-val
                    {% if e.eval_pl_rakuten > 0 %}pos{% elif e.eval_pl_rakuten < 0 %}neg{% endif %}">
                    {% if e.eval_pl_rakuten or e.eval_pl_rakuten == 0 %}
                      {{ e.eval_pl_rakuten|floatformat:0|intcomma }} 円
                    {% else %}
                      0 円
                    {% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="row-label">松井</div>
                  <div class="row-val
                    {% if e.eval_pl_matsui > 0 %}pos{% elif e.eval_pl_matsui < 0 %}neg{% endif %}">
                    {% if e.eval_pl_matsui or e.eval_pl_matsui == 0 %}
                      {{ e.eval_pl_matsui|floatformat:0|intcomma }} 円
                    {% else %}
                      0 円
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="result-summary">
            想定と実績のズレは、<br>
            ・想定 = 「指値 / TP / SL で理論どおり約定した場合」<br>
            ・実績 = 「5分足ベースで実際に約定した価格」<br>
            なので、ギャップアップ・ダウンなどで差が出ることがあります。
          </div>

          <div class="delete-row">
            <a class="delete-link"
               href="{% url 'aiapp:simulate_delete' e.id %}"
               onclick="return confirm('このシミュレ記録を削除しますか？');">
              このシミュレを削除
            </a>
          </div>

        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">
      条件に一致するシミュレ登録がありません。<br>
      フィルタ（モード・期間・銘柄）を少しゆるめてみてください。
    </div>
  {% endif %}

</div>
{% endblock %}