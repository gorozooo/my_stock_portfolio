{% extends "base.html" %}
{% load humanize %}
{% block title %}AI設定{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#0b0f1a;--card:rgba(255,255,255,0.06);--fg:#eaf0ff;--sub:#9fb1c7;
    --line:rgba(255,255,255,.10);--accent:#2563eb;
  }
  body{background:var(--bg);color:var(--fg)}
  .wrap{max-width:720px;margin:0 auto;padding:18px 14px 90px}
  h1{font-size:20px;margin:4px 0 14px 2px;font-weight:700}

  /* タブ */
  .tabs{display:flex;gap:6px;margin-bottom:12px}
  .tab{
    flex:1;text-align:center;padding:10px 8px;border-radius:12px;
    border:1px solid var(--line);background:rgba(255,255,255,.05);
    color:var(--fg);text-decoration:none;font-weight:600
  }
  .tab.active{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.18)}

  .sec{border:1px solid var(--line);background:var(--card);border-radius:16px;padding:14px 14px 8px;margin-bottom:12px;backdrop-filter:blur(10px)}
  .sec h2{font-size:14px;color:var(--sub);margin:0 0 10px 2px;font-weight:600}

  /* フォーム：基本設定 */
  .form-grid{display:grid;gap:10px}
  .form-row{display:grid;grid-template-columns:1fr 140px;gap:10px;align-items:center}
  .form-row input{
    width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);
    background:rgba(255,255,255,.08);color:var(--fg);font-size:16px;text-align:right;
  }
  .btn{display:inline-block;text-align:center;padding:12px;border-radius:10px;background:var(--accent);color:#fff;text-decoration:none;border:0;font-weight:700}

  /* サマリカード（楽天・松井） */
  .cards{display:grid;gap:10px}
  .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(255,255,255,.05)}
  .card .hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .badge{font-size:12px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.06)}
  .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kv .it{border:1px solid var(--line);border-radius:10px;padding:10px}
  .kv .lb{font-size:12px;color:var(--sub)}
  .kv .vl{font-size:18px;margin-top:2px}
  .msg{margin-top:10px;color:var(--sub);font-size:13px}

  /* トースト */
  .toast{margin:0 0 10px 0;padding:10px;border:1px solid rgba(255,255,255,.18);border-radius:10px;background:rgba(16,185,129,.18);color:#d1fae5;font-weight:600}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <h1>AI設定</h1>

  <div class="tabs">
    <a class="tab active" href="#basic" onclick="showTab(event,'basic')">基本設定</a>
    <a class="tab" href="#summary" onclick="showTab(event,'summary')">証券サマリ</a>
  </div>

  {% if saved %}
    <div class="toast">保存しました</div>
  {% endif %}

  <!-- 基本設定 -->
  <section id="tab-basic" class="sec">
    <h2>基本設定</h2>
    <form method="post">
      {% csrf_token %}
      <div class="form-grid">
        <div class="form-row">
          <label for="risk_pct">1トレードのリスク（％）</label>
          <input id="risk_pct" name="risk_pct" type="number" step="0.1" min="0" max="100" value="{{ risk_pct|floatformat:2 }}">
        </div>

        <div class="form-row">
          <label for="leverage_rakuten">楽天 倍率</label>
          <input id="leverage_rakuten" name="leverage_rakuten" type="number" step="0.01" min="1" max="4" value="{{ leverage_rakuten|floatformat:2 }}">
        </div>
        <div class="form-row">
          <label for="haircut_rakuten">楽天 ヘアカット率</label>
          <input id="haircut_rakuten" name="haircut_rakuten" type="number" step="0.01" min="0" max="0.8" value="{{ haircut_rakuten|floatformat:2 }}">
        </div>

        <div class="form-row">
          <label for="leverage_matsui">松井 倍率</label>
          <input id="leverage_matsui" name="leverage_matsui" type="number" step="0.01" min="1" max="4" value="{{ leverage_matsui|floatformat:2 }}">
        </div>
        <div class="form-row">
          <label for="haircut_matsui">松井 ヘアカット率</label>
          <input id="haircut_matsui" name="haircut_matsui" type="number" step="0.01" min="0" max="0.8" value="{{ haircut_matsui|floatformat:2 }}">
        </div>
      </div>

      <div style="margin-top:10px;text-align:right">
        <button class="btn" type="submit">保存</button>
      </div>
    </form>
  </section>

  <!-- 証券会社サマリ（自動計算） -->
  <section id="tab-summary" class="sec" style="display:none">
    <h2>証券会社サマリ（自動計算）</h2>
    <div class="cards">
      {% for b in brokers %}
        <div class="card">
          <div class="hd">
            <div class="badge">{{ b.label }}</div>
          </div>
          <div class="kv">
            <div class="it">
              <div class="lb">現金残高</div>
              <div class="vl">{{ b.cash_yen|intcomma }} 円</div>
            </div>
            <div class="it">
              <div class="lb">現物（特定）評価額</div>
              <div class="vl">{{ b.stock_acq_value|intcomma }} 円</div>
            </div>
            <div class="it">
              <div class="lb">信用枠（概算）</div>
              <div class="vl">{{ b.credit_limit|intcomma }} 円</div>
            </div>
            <div class="it">
              <div class="lb">信用余力（概算）</div>
              <div class="vl">{{ b.credit_available|intcomma }} 円</div>
            </div>
          </div>
          {% if b.note %}
            <div class="msg">{{ b.note }}</div>
          {% endif %}
        </div>
      {% empty %}
        <div class="msg">対象の証券口座が見つかりませんでした。</div>
      {% endfor %}
    </div>
    <div class="msg" style="margin-top:8px">
      ※ NISAは担保・余力計算に含めません。<br>
      ※ 数値は概算です（倍率は 楽天={{ leverage_rakuten|floatformat:2 }} / 松井={{ leverage_matsui|floatformat:2 }}、ヘアカット率は各設定値で計算）。
    </div>
  </section>
</div>

<script>
function showTab(ev, name){
  ev.preventDefault();
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.sec').forEach(s => s.style.display='none');

  ev.currentTarget.classList.add('active');
  document.getElementById('tab-'+name).style.display='block';
}
</script>
{% endblock %}