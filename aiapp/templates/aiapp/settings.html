{% extends "base.html" %}
{% load humanize %}
{% block title %}AI設定{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#0b0f1a;--card:rgba(255,255,255,.06);--fg:#eaf0ff;--sub:#9fb1c7;
    --line:rgba(255,255,255,.10);--accent:#2563eb;--muted:#334155;
  }
  body{background:var(--bg);color:var(--fg)}
  .wrap{max-width:720px;margin:0 auto;padding:18px 14px 90px}

  /* 丸タブ（承認済みデザイン） */
  .tabs{display:flex;gap:12px;margin:6px 0 14px}
  .tab{flex:1;text-align:center;padding:12px;border-radius:14px;
       border:1px solid var(--line);background:rgba(255,255,255,.05);color:#cfe0ff;
       text-decoration:none;font-weight:700;display:block}
  .tab.active{
       background:#1f3a8a;border-color:#2f49a6;color:#fff;
       box-shadow:0 4px 20px rgba(37,99,235,.25)
  }

  .sec{border:1px solid var(--line);background:var(--card);
       border-radius:16px;padding:14px 14px 10px;margin-bottom:12px;
       backdrop-filter:blur(10px)}
  .sec h2{font-size:14px;color:var(--sub);margin:0 0 10px 2px;font-weight:600}

  /* 入力行 */
  .row{display:grid;grid-template-columns:1fr 140px;gap:10px;align-items:center}
  .inp{
       width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);
       background:rgba(255,255,255,.08);color:var(--fg);
       font-size:16px;text-align:right;
  }
  .btn{
       display:inline-block;text-align:center;padding:12px;border-radius:10px;
       background:var(--accent);color:#fff;text-decoration:none;border:0;
       font-weight:700
  }
  .note{font-size:12px;color:#9fb1c7;margin-top:6px}

  /* ブローカーごとの倍率ブロック */
  .broker-block{margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,.08)}
  .broker-block:first-of-type{margin-top:4px;padding-top:4px;border-top:none}
  .broker-title{font-size:13px;color:var(--sub);margin:0 0 4px 2px;font-weight:600}

  /* サマリカード */
  .cards{display:grid;gap:10px}
  .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(255,255,255,.05)}
  .card .hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .badge{font-size:12px;padding:4px 8px;border:1px solid var(--line);
         border-radius:999px;background:rgba(255,255,255,.06)}
  .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kv .it{border:1px solid var(--line);border-radius:10px;padding:10px}
  .kv .lb{font-size:12px;color:var(--sub)}
  .kv .vl{font-size:18px;margin-top:2px}
  .msg{margin-top:10px;color:#9fb1c7;font-size:13px}
</style>
{% endblock %}

{% block content %}
<div class="wrap">
  <h1 style="font-size:20px;margin:4px 0 12px 2px;font-weight:700">AI設定</h1>

  <!-- 丸タブ -->
  <div class="tabs">
    <a class="tab {% if tab == 'basic' %}active{% endif %}" href="?tab=basic">基本設定</a>
    <a class="tab {% if tab == 'summary' %}active{% endif %}" href="?tab=summary">証券サマリ</a>
    <a class="tab {% if tab == 'advanced' %}active{% endif %}" href="?tab=advanced">拡張</a>
  </div>

  {% if tab == 'basic' %}
    <!-- 基本設定 -->
    <div class="sec">
      <h2>数量計算ルール</h2>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="tab" value="basic">

        <div class="row">
          <label style="font-size:14px;color:var(--sub)">
            1トレードあたりのリスク（％）
          </label>
          <input
            class="inp"
            name="risk_pct"
            type="number"
            inputmode="decimal"
            step="0.1"
            min="0"
            max="100"
            value="{{ risk_pct|floatformat:2 }}"
          >
        </div>

        <div class="row" style="margin-top:8px;">
          <label style="font-size:14px;color:var(--sub)">
            信用余力の使用上限（％）
          </label>
          <input
            class="inp"
            name="credit_usage_pct"
            type="number"
            inputmode="decimal"
            step="1"
            min="0"
            max="100"
            value="{{ credit_usage_pct|floatformat:0 }}"
          >
        </div>

        <h2 style="margin-top:14px">倍率 / ヘアカット（概算用）</h2>

        <!-- 楽天 -->
        <div class="broker-block">
          <div class="broker-title">楽天</div>
          <div class="row">
            <label style="font-size:14px;color:var(--sub)">倍率</label>
            <input
              class="inp"
              name="leverage_rakuten"
              type="number"
              inputmode="decimal"
              step="0.01"
              min="0"
              value="{{ leverage_rakuten|floatformat:2 }}"
            >
          </div>
          <div class="row" style="margin-top:6px;">
            <label style="font-size:14px;color:var(--sub)">ヘアカット</label>
            <input
              class="inp"
              name="haircut_rakuten"
              type="number"
              inputmode="decimal"
              step="0.01"
              min="0"
              max="1"
              value="{{ haircut_rakuten|floatformat:2 }}"
            >
          </div>
        </div>

        <!-- 松井 -->
        <div class="broker-block">
          <div class="broker-title">松井</div>
          <div class="row">
            <label style="font-size:14px;color:var(--sub)">倍率</label>
            <input
              class="inp"
              name="leverage_matsui"
              type="number"
              inputmode="decimal"
              step="0.01"
              min="0"
              value="{{ leverage_matsui|floatformat:2 }}"
            >
          </div>
          <div class="row" style="margin-top:6px;">
            <label style="font-size:14px;color:var(--sub)">ヘアカット</label>
            <input
              class="inp"
              name="haircut_matsui"
              type="number"
              inputmode="decimal"
              step="0.01"
              min="0"
              max="1"
              value="{{ haircut_matsui|floatformat:2 }}"
            >
          </div>
        </div>

        <div style="margin-top:12px;text-align:right">
          <button class="btn" type="submit">保存</button>
        </div>
        <div class="note">
          ※ ここで設定した倍率/ヘアカットは証券サマリの概算にも反映されます。<br>
          ※ 信用余力の使用上限（％）は AI Picks の数量計算で使われます。
        </div>
      </form>
    </div>

  {% elif tab == 'summary' %}
    <!-- 証券サマリ -->
    <div class="sec">
      <h2>証券会社サマリ（自動計算）</h2>
      <div class="cards">
        {% for b in brokers %}
          <div class="card">
            <div class="hd">
              <div class="badge">{{ b.label }}</div>
            </div>
            <div class="kv" style="margin-bottom:8px">
              <div class="it">
                <div class="lb">現金残高</div>
                <div class="vl">{{ b.cash_yen|intcomma }} 円</div>
              </div>
              <div class="it">
                <div class="lb">現物（特定）評価額</div>
                <div class="vl">{{ b.stock_acq_value|intcomma }} 円</div>
              </div>
              <div class="it">
                <div class="lb">信用枠（概算）</div>
                <div class="vl">{{ b.credit_limit|intcomma }} 円</div>
              </div>
              <div class="it">
                <div class="lb">信用余力（概算）</div>
                <div class="vl">{{ b.credit_yoryoku|intcomma }} 円</div>
              </div>
            </div>
            <div class="msg">{{ b.note }}</div>
          </div>
        {% empty %}
          <div class="msg">対象の証券口座が見つかりませんでした。</div>
        {% endfor %}
      </div>
      <div class="msg" style="margin-top:12px">
        ※ NISAは数量算出に含めません／SBIは今回UI表示を省略<br>
        ※ 数値は概算です（倍率は設定値、ヘアカットは現物に適用）
      </div>
    </div>

  {% else %}
    <!-- 拡張（今は空） -->
    <div class="sec">
      <h2>拡張</h2>
      <div class="note">将来のモード・しきい値などをここに追加します。</div>
    </div>
  {% endif %}
</div>
{% endblock %}