{% extends "base.html" %}
{% load humanize %}
{% block title %}AI設定{% endblock %}

{% block head %}
<style>
  :root{
    --bg:#0b0f1a;--card:rgba(255,255,255,.06);--fg:#eaf0ff;--sub:#9fb1c7;
    --line:rgba(255,255,255,.10);--accent:#2563eb;--muted:#334155;
  }
  body{background:var(--bg);color:var(--fg)}
  .wrap{max-width:720px;margin:0 auto;padding:18px 14px 90px}

  /* 丸タブ（承認済みデザイン） */
  .tabs{display:flex;gap:10px;margin:6px 0 14px}
  .tab{flex:1;text-align:center;padding:12px;border-radius:14px;
       border:1px solid var(--line);background:rgba(255,255,255,.05);color:#cfe0ff;
       text-decoration:none;font-weight:700;display:block}
  .tab.active{
       background:#1f3a8a;border-color:#2f49a6;color:#fff;
       box-shadow:0 4px 20px rgba(37,99,235,.25)
  }

  .sec{
    border:1px solid var(--line);
    background:var(--card);
    border-radius:16px;
    padding:14px 14px 10px;
    margin-bottom:12px;
    backdrop-filter:blur(10px);
    overflow:hidden; /* はみ出しを枠内に収める */
  }
  .sec h2{font-size:14px;color:var(--sub);margin:0 0 10px 2px;font-weight:600}

  /* 入力行：はみ出し防止 */
  .row{
    display:grid;
    grid-template-columns: 1fr minmax(0, 140px);
    gap:10px;
    align-items:center;
  }
  .row label{
    min-width:0;
    overflow-wrap:anywhere;
  }
  .inp{
       width:100%;
       max-width:100%;
       box-sizing:border-box;
       padding:12px;
       border-radius:10px;
       border:1px solid var(--line);
       background:rgba(255,255,255,.08);
       color:var(--fg);
       font-size:16px;
       text-align:right;
  }
  .btn{
       display:inline-block;text-align:center;padding:12px 18px;border-radius:10px;
       background:var(--accent);color:#fff;text-decoration:none;border:0;
       font-weight:800
  }
  .note{font-size:12px;color:#9fb1c7;margin-top:6px}
  .msg{margin-top:10px;color:#9fb1c7;font-size:13px}

  /* ブローカーごとの倍率ブロック */
  .broker-block{margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,.08)}
  .broker-block:first-of-type{margin-top:4px;padding-top:4px;border-top:none}
  .broker-title{font-size:13px;color:var(--sub);margin:0 0 4px 2px;font-weight:600}

  /* サマリカード */
  .cards{display:grid;gap:10px}
  .card{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(255,255,255,.05)}
  .card .hd{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .badge{font-size:12px;padding:4px 8px;border:1px solid var(--line);
         border-radius:999px;background:rgba(255,255,255,.06)}
  .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kv .it{border:1px solid var(--line);border-radius:10px;padding:10px}
  .kv .lb{font-size:12px;color:var(--sub)}
  .kv .vl{font-size:18px;margin-top:2px}

  /* PRO: 学習モード（pill） */
  .mode-pills{display:flex;gap:10px}
  .pill{
    flex:1;
    display:block;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--line);
    background:rgba(255,255,255,.05);
    color:#cfe0ff;
    text-align:center;
    font-weight:900;
    font-size:14px;
    cursor:pointer;
    user-select:none;
  }
  .pill input{display:none}
  .pill.active{
    background:#1f3a8a;border-color:#2f49a6;color:#fff;
    box-shadow:0 4px 20px rgba(37,99,235,.20)
  }
  .pill small{display:block;margin-top:4px;font-weight:700;color:#bcd2ff;font-size:11px;opacity:.9}

  /* PRO: 2カラム（スマホは1列、広い時だけ2列） */
  .split2{display:grid;grid-template-columns:1fr;gap:10px}
  @media (min-width: 680px){
    .split2{grid-template-columns:1fr 1fr}
  }

  .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0}

  /* PRO: 選択中だけ表示 */
  .pro-panel{display:none}
  .pro-panel.active{display:block}

  .pilltag{
    display:inline-block;
    margin-left:8px;
    padding:2px 10px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:#cfe0ff;
    font-size:12px;
    font-weight:900;
    vertical-align:middle;
  }
</style>
{% endblock %}

{% block content %}
<div class="wrap">

  <!-- 丸タブ -->
  <div class="tabs">
    <a class="tab {% if tab == 'basic' %}active{% endif %}" href="?tab=basic">基本設定</a>
    <a class="tab {% if tab == 'pro' %}active{% endif %}" href="?tab=pro">PRO</a>
    <a class="tab {% if tab == 'summary' %}active{% endif %}" href="?tab=summary">証券サマリ</a>
    <a class="tab {% if tab == 'advanced' %}active{% endif %}" href="?tab=advanced">ルール</a>
  </div>

  {% if tab == 'basic' %}
    <!-- 基本設定 -->
    <div class="sec">
      <h2>数量計算ルール</h2>
      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="tab" value="basic">

        <div class="row">
          <label style="font-size:14px;color:var(--sub)">
            1トレードあたりのリスク（％）
          </label>
          <input
            class="inp"
            name="risk_pct"
            type="number"
            inputmode="decimal"
            step="0.1"
            min="0"
            max="100"
            value="{{ risk_pct|floatformat:2 }}"
          >
        </div>

        <div class="row" style="margin-top:8px;">
          <label style="font-size:14px;color:var(--sub)">
            信用余力の使用上限（％）
          </label>
          <input
            class="inp"
            name="credit_usage_pct"
            type="number"
            inputmode="decimal"
            step="1"
            min="0"
            max="100"
            value="{{ credit_usage_pct|floatformat:1 }}"
          >
        </div>

        <h2 style="margin-top:14px">倍率 / ヘアカット（概算用）</h2>

        <!-- 楽天 -->
        <div class="broker-block">
          <div class="broker-title">楽天</div>
          <div class="row">
            <label style="font-size:14px;color:var(--sub)">倍率</label>
            <input class="inp" name="leverage_rakuten" type="number" inputmode="decimal" step="0.01" min="0"
                   value="{{ leverage_rakuten|floatformat:2 }}">
          </div>
          <div class="row" style="margin-top:6px;">
            <label style="font-size:14px;color:var(--sub)">ヘアカット</label>
            <input class="inp" name="haircut_rakuten" type="number" inputmode="decimal" step="0.01" min="0" max="1"
                   value="{{ haircut_rakuten|floatformat:2 }}">
          </div>
        </div>

        <!-- 松井 -->
        <div class="broker-block">
          <div class="broker-title">松井</div>
          <div class="row">
            <label style="font-size:14px;color:var(--sub)">倍率</label>
            <input class="inp" name="leverage_matsui" type="number" inputmode="decimal" step="0.01" min="0"
                   value="{{ leverage_matsui|floatformat:2 }}">
          </div>
          <div class="row" style="margin-top:6px;">
            <label style="font-size:14px;color:var(--sub)">ヘアカット</label>
            <input class="inp" name="haircut_matsui" type="number" inputmode="decimal" step="0.01" min="0" max="1"
                   value="{{ haircut_matsui|floatformat:2 }}">
          </div>
        </div>

        <!-- SBI -->
        <div class="broker-block">
          <div class="broker-title">SBI</div>
          <div class="row">
            <label style="font-size:14px;color:var(--sub)">倍率</label>
            <input class="inp" name="leverage_sbi" type="number" inputmode="decimal" step="0.01" min="0"
                   value="{{ leverage_sbi|floatformat:2 }}">
          </div>
          <div class="row" style="margin-top:6px;">
            <label style="font-size:14px;color:var(--sub)">ヘアカット</label>
            <input class="inp" name="haircut_sbi" type="number" inputmode="decimal" step="0.01" min="0" max="1"
                   value="{{ haircut_sbi|floatformat:2 }}">
          </div>
        </div>

        <div style="margin-top:12px;text-align:right">
          <button class="btn" type="submit">保存</button>
        </div>
        <div class="note">
          ※ ここで設定したリスク％・信用余力の使用上限はポリシーファイルにも反映されます。<br>
          ※ 倍率/ヘアカットは証券サマリの概算に使われます。
        </div>
      </form>
    </div>

  {% elif tab == 'pro' %}
    <!-- PROタブ -->
    <div class="sec">
      <h2>PRO学習モード（2択固定）</h2>

      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="tab" value="pro">

        <div class="mode-pills" style="margin-bottom:10px;">
          <label class="pill {% if pro_mode == 'collect' %}active{% endif %}">
            <input type="radio" name="pro_mode" value="collect" {% if pro_mode == 'collect' %}checked{% endif %}>
            Collect
            <small>母数を増やす（建玉を優先）</small>
          </label>
          <label class="pill {% if pro_mode == 'strict' %}active{% endif %}">
            <input type="radio" name="pro_mode" value="strict" {% if pro_mode == 'strict' %}checked{% endif %}>
            Strict
            <small>質を優先（見送りを強化）</small>
          </label>
        </div>

        <div class="note" style="margin-top:0;">
          ※ ここで選んだモードと数値は short_aggressive.yml（真実ソース）に保存されます。<br>
          ※ Collect/Strict は別の数値を保持します（同じに見える問題を潰す）。
        </div>

        <!-- Collect パネル（選択中だけ表示） -->
        <div class="pro-panel {% if pro_mode == 'collect' %}active{% endif %}" data-pro="collect">
          <div class="divider"></div>
          <h2>建玉・資金ルール<span class="pilltag">Collect</span></h2>

          <div class="split2">
            <div class="row">
              <label style="font-size:14px;color:var(--sub)">同時建玉数（max_positions）</label>
              <input class="inp" name="c_max_positions" type="number" inputmode="numeric" step="1" min="1"
                     value="{{ c_max_positions|floatformat:0 }}">
            </div>

            <!-- ★追加：最大リスク数（R） -->
            <div class="row">
              <label style="font-size:14px;color:var(--sub)">同時に許容する最大リスク数（R）</label>
              <input class="inp" name="c_max_total_risk_r" type="number" inputmode="decimal" step="1" min="1"
                     value="{{ c_max_total_risk_r|floatformat:0 }}">
            </div>

            <div class="row">
              <label style="font-size:14px;color:var(--sub)">1銘柄の上限資金（円）</label>
              <input class="inp" name="c_max_notional_per_trade_yen" type="number" inputmode="numeric" step="10000" min="0"
                     value="{{ c_max_notional_per_trade_yen|floatformat:0 }}">
            </div>

            <div class="row">
              <label style="font-size:14px;color:var(--sub)">1銘柄の下限資金（円）※0で無効</label>
              <input class="inp" name="c_min_notional_per_trade_yen" type="number" inputmode="numeric" step="10000" min="0"
                     value="{{ c_min_notional_per_trade_yen|floatformat:0 }}">
            </div>

            <div class="row">
              <label style="font-size:14px;color:var(--sub)">口座枠（概算）（円）</label>
              <input class="inp" name="c_max_total_notional_yen" type="number" inputmode="numeric" step="10000" min="0"
                     value="{{ c_max_total_notional_yen|floatformat:0 }}">
            </div>

            <div class="row">
              <label style="font-size:14px;color:var(--sub)">予備資金（常に残す）（円）</label>
              <input class="inp" name="c_reserve_cash_yen" type="number" inputmode="numeric" step="10000" min="0"
                     value="{{ c_reserve_cash_yen|floatformat:0 }}">
            </div>

            <div class="row">
              <label style="font-size:14px;color:var(--sub)">最大保有（営業日）horizon_bd</label>
              <input class="inp" name="c_horizon_bd" type="number" inputmode="numeric" step="1" min="1"
                     value="{{ c_horizon_bd|floatformat:0 }}">
            </div>
          </div>
        </div>

        <!-- Strict パネル（選択中だけ表示） -->
        <div class="pro-panel {% if pro_mode == 'strict' %}active{% endif %}" data-pro="strict">
          <div class="divider"></div>
          <h2>建玉・資金ルール<span class="pilltag">Strict</span></h2>

          <div class="split2">
            <div class="row">
              <label style="font-size:14px;color:var(--sub)">同時建玉数（max_positions）</label>
              <input class="inp" name="s_max_positions" type="number" inputmode="numeric" step="1" min="1"
                     value="{{ s_max_positions|floatformat:0 }}">
            </div>

            <!-- ★追加：最大リスク数（R） -->
            <div class="row">
              <label style="font-size:14px;color:var(--sub)">同時に許容する最大リスク数（R）</label>
              <input class="inp" name="s_max_total_risk_r" type="number" inputmode="decimal" step="1" min="1"
                     value="{{ s_max_total_risk_r|floatformat:0 }}">
            </div>

            <div class="row">
              <label style="font-size:14px;color:var(--sub)">1銘柄の上限資金（円）</label>
              <input class="inp" name="s_max_notional_per_trade_yen" type="number" inputmode="numeric" step="10000" min="0"
                     value="{{ s_max_notional_per_trade_yen|floatformat:0 }}">
            </div>

            <div class="row">
              <label style="font-size:14px;color:var(--sub)">1銘柄の下限資金（円）※0で無効</label>
              <input class="inp" name="s_min_notional_per_trade_yen" type="number" inputmode="numeric" step="10000" min="0"
                     value="{{ s_min_notional_per_trade_yen|floatformat:0 }}">
            </div>

            <div class="row">
              <label style="font-size:14px;color:var(--sub)">口座枠（概算）（円）</label>
              <input class="inp" name="s_max_total_notional_yen" type="number" inputmode="numeric" step="10000" min="0"
                     value="{{ s_max_total_notional_yen|floatformat:0 }}">
            </div>

            <div class="row">
              <label style="font-size:14px;color:var(--sub)">予備資金（常に残す）（円）</label>
              <input class="inp" name="s_reserve_cash_yen" type="number" inputmode="numeric" step="10000" min="0"
                     value="{{ s_reserve_cash_yen|floatformat:0 }}">
            </div>

            <div class="row">
              <label style="font-size:14px;color:var(--sub)">最大保有（営業日）horizon_bd</label>
              <input class="inp" name="s_horizon_bd" type="number" inputmode="numeric" step="1" min="1"
                     value="{{ s_horizon_bd|floatformat:0 }}">
            </div>
          </div>

          <div class="divider"></div>

          <h2>Strict時の締め付け（Strictにしたら必ず効く）</h2>

          <div class="row">
            <label style="font-size:14px;color:var(--sub)">Strict: 最低RR（R）</label>
            <input class="inp" name="strict_min_rr" type="number" inputmode="decimal" step="0.1" min="0"
                   value="{{ strict_min_rr|floatformat:1 }}">
          </div>

          <div class="row" style="margin-top:8px;">
            <label style="font-size:14px;color:var(--sub)">Strict: 最低純利益（円）</label>
            <input class="inp" name="strict_min_net_profit_yen" type="number" inputmode="numeric" step="100" min="0"
                   value="{{ strict_min_net_profit_yen|floatformat:0 }}">
          </div>
        </div>

        <div style="margin-top:12px;text-align:right">
          <button class="btn" type="submit">保存</button>
        </div>

        <div class="note">
          ※ 保存先は short_aggressive.yml（真実ソース）です。<br>
          ※ 選択中のモードの値が “実際に効く値” として limits / filters に同期されます。
        </div>
      </form>
    </div>

  {% elif tab == 'summary' %}
    <!-- 証券サマリ -->
    <div class="sec">
      <h2>証券会社サマリ（自動計算）</h2>
      <div class="cards">
        {% for b in brokers %}
          <div class="card">
            <div class="hd">
              <div class="badge">{{ b.label }}</div>
            </div>
            <div class="kv" style="margin-bottom:8px">
              <div class="it">
                <div class="lb">現金残高</div>
                <div class="vl">{{ b.cash_yen|intcomma }} 円</div>
              </div>
              <div class="it">
                <div class="lb">現物（特定）評価額</div>
                <div class="vl">{{ b.stock_acq_value|intcomma }} 円</div>
              </div>
              <div class="it">
                <div class="lb">信用枠（概算）</div>
                <div class="vl">{{ b.credit_limit|intcomma }} 円</div>
              </div>
              <div class="it">
                <div class="lb">信用余力（概算）</div>
                <div class="vl">{{ b.credit_yoryoku|intcomma }} 円</div>
              </div>
            </div>
            <div class="msg">{{ b.note }}</div>
          </div>
        {% empty %}
          <div class="msg">対象の証券口座が見つかりませんでした。</div>
        {% endfor %}
      </div>
      <div class="msg" style="margin-top:12px">
        ※ NISAは数量算出に含めません<br>
        ※ 数値は概算です（倍率は設定値、ヘアカットは現物に適用）
      </div>
    </div>

  {% else %}
    <!-- ルール -->
    <div class="sec">
      <h2>短期×攻め ポリシー（short_aggressive.yml）</h2>

      {% if policy %}
        <div class="msg">
          ポリシーファイルのしきい値をそのまま表示しています。<br>
          ※ 実際の数量計算では、ここに表示されている値をもとに AI Picks が計算されます。
        </div>

        <div class="cards" style="margin-top:10px">
          <!-- 基本 -->
          <div class="card">
            <div class="hd">
              <div class="badge">基本</div>
              <div style="font-size:12px;color:var(--sub)">
                mode: {{ policy.mode|default:"short_aggressive" }}
              </div>
            </div>
            <div class="kv">
              <div class="it">
                <div class="lb">1トレードのリスク</div>
                <div class="vl">
                  {% if policy.risk_pct is not None %}
                    {{ policy.risk_pct|floatformat:2 }} %
                  {% else %}
                    —
                  {% endif %}
                </div>
              </div>
              <div class="it">
                <div class="lb">信用余力の使用上限</div>
                <div class="vl">
                  {% if policy.credit_usage_pct is not None %}
                    {{ policy.credit_usage_pct|floatformat:1 }} %
                  {% else %}
                    —
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- フィルター -->
          <div class="card">
            <div class="hd">
              <div class="badge">フィルター</div>
            </div>
            <div class="kv">
              <div class="it">
                <div class="lb">最低純利益</div>
                <div class="vl">
                  {% if policy.min_net_profit_yen is not None %}
                    {{ policy.min_net_profit_yen|floatformat:0|intcomma }} 円
                  {% else %}
                    —
                  {% endif %}
                </div>
              </div>
              <div class="it">
                <div class="lb">最低 Reward / Risk</div>
                <div class="vl">
                  {% if policy.min_reward_risk is not None %}
                    R {{ policy.min_reward_risk|floatformat:2 }}
                  {% else %}
                    —
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="msg">
              純利益がこの金額未満、または R がこの値を下回るケースは「見送り」候補になります。<br>
              マイナス許容:
              {% if policy.allow_negative_pl %}
                許容する（allow_negative_pl = true）
              {% else %}
                許容しない（allow_negative_pl = false）
              {% endif %}
            </div>
          </div>

          <!-- コスト想定 -->
          <div class="card">
            <div class="hd">
              <div class="badge">コスト想定</div>
            </div>
            <div class="kv">
              <div class="it">
                <div class="lb">売買手数料レート</div>
                <div class="vl">
                  {% if policy.commission_rate is not None %}
                    {{ policy.commission_rate|floatformat:4 }} （約定代金に対する割合）
                  {% else %}
                    —
                  {% endif %}
                </div>
              </div>
              <div class="it">
                <div class="lb">最低手数料</div>
                <div class="vl">
                  {% if policy.min_commission is not None %}
                    {{ policy.min_commission|floatformat:0|intcomma }} 円
                  {% else %}
                    —
                  {% endif %}
                </div>
              </div>
              <div class="it">
                <div class="lb">スリッページレート</div>
                <div class="vl">
                  {% if policy.slippage_rate is not None %}
                    {{ policy.slippage_rate|floatformat:4 }}
                  {% else %}
                    —
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="msg">
              ここで設定したコスト想定を使って、<br>
              ・純利益がマイナスにならないか<br>
              ・利益がショボすぎないか<br>
              をチェックしています。
            </div>
          </div>
        </div>

        <form method="post" style="margin-top:18px;">
          {% csrf_token %}
          <input type="hidden" name="tab" value="advanced">

          <h2>ポリシーしきい値の編集</h2>

          <div class="row">
            <label style="font-size:14px;color:var(--sub)">最低純利益（円）</label>
            <input class="inp" name="min_net_profit_yen" type="number" inputmode="decimal" step="100" min="0"
                   value="{% if policy.min_net_profit_yen is not None %}{{ policy.min_net_profit_yen|floatformat:0 }}{% endif %}">
          </div>

          <div class="row" style="margin-top:8px;">
            <label style="font-size:14px;color:var(--sub)">最低 Reward / Risk（R）</label>
            <input class="inp" name="min_reward_risk" type="number" inputmode="decimal" step="0.1" min="0"
                   value="{% if policy.min_reward_risk is not None %}{{ policy.min_reward_risk|floatformat:2 }}{% endif %}">
          </div>

          <div class="row" style="margin-top:8px;">
            <label style="font-size:14px;color:var(--sub)">マイナス許容</label>
            <select name="allow_negative_pl" class="inp" style="text-align:left;">
              <option value="false" {% if not policy.allow_negative_pl %}selected{% endif %}>許容しない</option>
              <option value="true" {% if policy.allow_negative_pl %}selected{% endif %}>許容する</option>
            </select>
          </div>

          <h2 style="margin-top:14px;">コスト想定の編集</h2>

          <div class="row">
            <label style="font-size:14px;color:var(--sub)">売買手数料レート</label>
            <input class="inp" name="commission_rate" type="number" inputmode="decimal" step="0.0001" min="0"
                   value="{% if policy.commission_rate is not None %}{{ policy.commission_rate|floatformat:4 }}{% endif %}">
          </div>

          <div class="row" style="margin-top:8px;">
            <label style="font-size:14px;color:var(--sub)">最低手数料（円）</label>
            <input class="inp" name="min_commission" type="number" inputmode="decimal" step="10" min="0"
                   value="{% if policy.min_commission is not None %}{{ policy.min_commission|floatformat:0 }}{% endif %}">
          </div>

          <div class="row" style="margin-top:8px;">
            <label style="font-size:14px;color:var(--sub)">スリッページレート</label>
            <input class="inp" name="slippage_rate" type="number" inputmode="decimal" step="0.0001" min="0"
                   value="{% if policy.slippage_rate is not None %}{{ policy.slippage_rate|floatformat:4 }}{% endif %}">
          </div>

          <div style="margin-top:12px;text-align:right">
            <button class="btn" type="submit">保存</button>
          </div>
          <div class="note">
            ※ ここで編集した値は short_aggressive.yml に保存され、次回以降の AI Picks 計算に反映されます。
          </div>
        </form>

      {% else %}
        <div class="note">
          short_aggressive.yml を読み込めませんでした。<br>
          ファイルのパス: <code>aiapp/policies/short_aggressive.yml</code> を確認してください。
        </div>
      {% endif %}
    </div>
  {% endif %}
</div>

<script>
  function applyProPanel(mode){
    document.querySelectorAll(".pill").forEach(function(el){ el.classList.remove("active"); });
    var checked = document.querySelector('input[name="pro_mode"][value="'+mode+'"]');
    if (checked) {
      var wrap = checked.closest(".pill");
      if (wrap) wrap.classList.add("active");
    }

    document.querySelectorAll(".pro-panel").forEach(function(p){
      p.classList.remove("active");
      if (p.getAttribute("data-pro") === mode) p.classList.add("active");
    });
  }

  document.addEventListener("change", function(e){
    if (!e.target || e.target.name !== "pro_mode") return;
    applyProPanel(e.target.value);
  });

  document.addEventListener("DOMContentLoaded", function(){
    var current = document.querySelector('input[name="pro_mode"]:checked');
    applyProPanel(current ? current.value : "collect");
  });
</script>
{% endblock %}