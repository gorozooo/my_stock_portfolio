{% extends "base.html" %}
{% load static %}

{% block title %}AI{% endblock %}

{% block head %}
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="{% static 'ai/ai.css' %}?v=21">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="ai-wrap">
  <header class="ai-top">
    <div class="top-inner">
      <div class="ai-row top-meta">
        <span class="muted">â±ï¸ {{ updated_at }} æ›´æ–°</span>
        <span class="muted">ğŸ“ˆ ãƒ¬ã‚¸ãƒ¼ãƒ ï¼š{{ regime.label }}ï¼ˆ{{ regime.confidence }}%ï¼‰</span>
      </div>
      <div class="ai-row modes">
        <button class="pill on">{{ mode.period }}</button>
        <button class="pill on">{{ mode.stance }}</button>
        <button class="pill">ãŠã¾ã‹ã›</button>
      </div>
    </div>
  </header>

  <main class="ai-list">
    {% for it in items %}
    <article class="ai-card" data-index="{{ forloop.counter0 }}">
      <!-- é ­ã¯2ã‚«ãƒ©ãƒ ï¼šå·¦=ã‚¿ã‚¤ãƒˆãƒ«ã€å³=ç‚¹æ•°(1è¡Œç›®)+â­ï¸(2è¡Œç›®) -->
      <div class="card-head">
        <h3 class="title">
          <span class="name">{{ it.name }}</span>
          <span class="code">({{ it.code }})</span>
        </h3>

        <div class="meta-right">
          <span class="score"><b>{{ it.score }}</b> ç‚¹</span>
          <span class="stars" aria-label="AIä¿¡é ¼åº¦">
            {% for i in "12345"|make_list %}{% if forloop.counter <= it.stars %}â­ï¸{% else %}â˜†{% endif %}{% endfor %}
          </span>
        </div>
      </div>

      <!-- ã‚»ã‚¯ã‚¿ãƒ¼ï¼šã¾ãšã¯ãã®ã¾ã¾å‡ºã™ï¼ˆå¾Œæ®µJSã§JPXã‹ã‚‰å¼·åˆ¶è£œæ­£ï¼‰ -->
      <div class="row sub">
        <span class="sector"
              data-code="{{ it.code|default:'' }}"
              data-sector="{{ it.sector|default_if_none:'' }}"
              data-sector-jp="{{ it.sector_jp|default_if_none:'' }}">
          {{ it.sector_jp|default:it.sector|default:"-" }}
        </span>
      </div>

      <div class="row trends">
        <span>æ—¥è¶³ {% if it.trend.d == 'up' %}â¤´ï¸{% elif it.trend.d == 'down' %}â¤µï¸{% else %}â¡ï¸{% endif %}</span>
        <span>é€±è¶³ {% if it.trend.w == 'up' %}â¤´ï¸{% elif it.trend.w == 'down' %}â¤µï¸{% else %}â¡ï¸{% endif %}</span>
        <span>æœˆè¶³ {% if it.trend.m == 'up' %}â¤´ï¸{% elif it.trend.m == 'down' %}â¤µï¸{% else %}â¡ï¸{% endif %}</span>
      </div>

      <button class="more" data-open="{{ forloop.counter0 }}">â–¶ è©³ç´°ã‚’è¦‹ã‚‹</button>
    </article>
    {% endfor %}
  </main>

  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="aiModal" class="modal hidden" aria-hidden="true" role="dialog">
    <div class="modal-sheet" role="document" aria-modal="true">
      <button class="close" data-close>é–‰ã˜ã‚‹</button>

      <section class="modal-head">
        <h3 id="m_name"></h3>
        <div class="right">
          <span id="m_stars"></span>
          <span id="m_score" class="score"></span>
        </div>
        <div class="sub">
          <span id="m_sector">-</span>
        </div>
        <div class="trends">
          <span id="m_trend_d"></span>
          <span id="m_trend_w"></span>
          <span id="m_trend_m"></span>
        </div>
      </section>

      <section class="reasons">
        <h4>ç†ç”±ï¼ˆæ‡¸å¿µå«ã‚€ï¼‰</h4>
        <ul id="m_reasons"></ul>
      </section>

      <section class="prices">
        <h4>ä¾¡æ ¼ç›®å®‰</h4>
        <div id="m_prices"></div>
        <div id="m_qty"></div>
      </section>

      <section class="chart">
        <h4>ãƒãƒ£ãƒ¼ãƒˆï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ï¼åˆ©ç¢ºï¼æåˆ‡ï¼‰</h4>
        <canvas id="m_chart" height="260"></canvas>
      </section>

      <section class="actions">
        <button id="act_watch">ğŸ”– ã‚¦ã‚©ãƒƒãƒç™»éŒ²</button>
        <button id="act_paper" disabled>ğŸ“Š ç´™ãƒˆãƒ¬è¨˜éŒ²ä¸­</button>
      </section>
    </div>
    <div class="backdrop" data-close></div>
  </div>
</div>

<script>
  // ã‚µãƒ¼ãƒã‹ã‚‰æ¸¡ã•ã‚ŒãŸç”Ÿãƒ‡ãƒ¼ã‚¿
  window.__AI_ITEMS__ = {{ items|safe }};
</script>

<script>
/**
 * JPXãƒã‚¹ã‚¿ãƒ¼CSVï¼ˆ/media/jpx_master.csvï¼‰ã‹ã‚‰ code -> sector(æ—¥æœ¬èª) ã‚’å¼•ãå½“ã¦ã€
 * ã‚«ãƒ¼ãƒ‰ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºã‚’ã€Œå¿…ãšã€åŸ‹ã‚ã‚‹å‰æ®µè£œæ­£ã€‚
 * - itemså´ã® sector/sector_jp ãŒç©º or æ•°å€¤ã§ã‚‚æœ€çµ‚çš„ã«åŸ‹ã¾ã‚‹
 */
(function() {
  const SECT33 = {
    50:'æ°´ç”£ãƒ»è¾²æ—æ¥­',51:'é‰±æ¥­',52:'å»ºè¨­æ¥­',53:'é£Ÿæ–™å“',54:'ç¹Šç¶­è£½å“',55:'ãƒ‘ãƒ«ãƒ—ãƒ»ç´™',
    56:'åŒ–å­¦',57:'åŒ»è–¬å“',58:'çŸ³æ²¹ãƒ»çŸ³ç‚­è£½å“',59:'ã‚´ãƒ è£½å“',60:'ã‚¬ãƒ©ã‚¹ãƒ»åœŸçŸ³è£½å“',
    61:'é‰„é‹¼',62:'éé‰„é‡‘å±',63:'é‡‘å±è£½å“',64:'æ©Ÿæ¢°',65:'é›»æ°—æ©Ÿå™¨',66:'è¼¸é€ç”¨æ©Ÿå™¨',
    67:'ç²¾å¯†æ©Ÿå™¨',68:'ãã®ä»–è£½å“',69:'é›»æ°—ãƒ»ã‚¬ã‚¹æ¥­',70:'é™¸é‹æ¥­',71:'æµ·é‹æ¥­',72:'ç©ºé‹æ¥­',
    73:'å€‰åº«ãƒ»é‹è¼¸é–¢é€£æ¥­',74:'æƒ…å ±ãƒ»é€šä¿¡æ¥­',75:'å¸å£²æ¥­',76:'å°å£²æ¥­',77:'éŠ€è¡Œæ¥­',
    78:'è¨¼åˆ¸ã€å•†å“å…ˆç‰©å–å¼•æ¥­',79:'ä¿é™ºæ¥­',80:'ãã®ä»–é‡‘èæ¥­',81:'ä¸å‹•ç”£æ¥­',82:'ã‚µãƒ¼ãƒ“ã‚¹æ¥­',83:'ãã®ä»–'
  };

  const isNumLike = (s) => typeof s === 'string' && /^\s*\d+(?:\.\d+)?\s*$/.test(s);
  const code4 = (v) => {
    const m = String(v||'').match(/(\d{4})/);
    return m ? m[1] : '';
  };

  // 1) æ—¢å­˜ãƒ†ã‚­ã‚¹ãƒˆãŒç©º/æ•°å€¤ãªã‚‰ã€å¾Œã§ä¸Šæ›¸ãå¯¾è±¡ã¨ã—ã¦ãƒãƒ¼ã‚¯
  const cards = Array.from(document.querySelectorAll('.ai-card'));
  const needFix = [];
  cards.forEach(card => {
    const secEl = card.querySelector('.sector');
    if (!secEl) return;
    const raw = (secEl.textContent || '').trim();
    if (raw === '' || isNumLike(raw) || raw === '-') {
      needFix.push(secEl);
    }
  });

  // 2) CSVã‚’èª­ã¿ã€ãƒãƒƒãƒ—åŒ–
  function parseCSV(text){
    const lines = text.split(/\r?\n/).filter(Boolean);
    // æƒ³å®šãƒ˜ãƒƒãƒ€: code,name,sector
    const head = lines.shift().split(',');
    const idxCode = head.indexOf('code');
    const idxSector = head.indexOf('sector');
    const map = {};
    for (const ln of lines){
      const cols = ln.split(',');
      const c4 = code4(cols[idxCode]);
      if (!c4) continue;
      let s = (cols[idxSector] || '').trim();
      // æ•°å€¤ã‚³ãƒ¼ãƒ‰(50..83)ãªã‚‰æ—¥æœ¬èªã¸
      if (isNumLike(s)) {
        const n = parseInt(s, 10);
        s = SECT33[n] || s;
      }
      if (s) map[c4] = s;
    }
    return map;
  }

  function applyToCards(map){
    needFix.forEach(secEl => {
      const cEl = secEl.closest('.ai-card').querySelector('.code');
      const c4 = code4(cEl ? cEl.textContent : secEl.dataset.code);
      const fromMap = map[c4];
      if (fromMap) secEl.textContent = fromMap;
      else if (secEl.textContent.trim() === '' || isNumLike(secEl.textContent) || secEl.textContent.trim() === '-') {
        secEl.textContent = '-';
      }
    });
  }

  // 3) ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¨ãã‚‚åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§åŸ‹ã‚ã‚‹
  function sectorSafe(val, code, map){
    const s = (val ?? '').toString().trim();
    if (s && !isNumLike(s) && s !== '-') return s;
    const m = map[code4(code)];
    return m || '-';
  }

  function wireModal(map){
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.more');
      if (!btn) return;
      const idx = parseInt(btn.dataset.open, 10);
      const item = (window.__AI_ITEMS__ || [])[idx] || {};
      const sec = sectorSafe(item.sector_jp || item.sector, item.code, map);
      const el = document.getElementById('m_sector');
      if (el) el.textContent = sec;
    });
  }

  // å®Ÿè¡Œï¼šCSVå–å¾—ã—ã¦é©ç”¨
  fetch('/media/jpx_master.csv', {cache:'no-store'})
    .then(r => r.ok ? r.text() : Promise.reject(r.status))
    .then(txt => {
      const map = parseCSV(txt);
      applyToCards(map);
      wireModal(map);
      // äºˆå‚™ï¼šai.jsã‹ã‚‰ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«
      window.__aiSectorNameMap__ = map;
    })
    .catch(()=> {
      // å¤±æ•—æ™‚ã§ã‚‚è¡¨ç¤ºãŒç©ºã«ãªã‚‰ãªã„ã‚ˆã†ã«æœ€ä½é™ã®ä¿é™º
      wireModal({});
    });
})();
</script>

<script src="{% static 'ai/ai.js' %}?v=20"></script>
{% endblock %}