{% extends "base.html" %}
{% load static %}

{% block title %}AI{% endblock %}

{% block head %}
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="{% static 'ai/ai.css' %}?v=22">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="ai-wrap">
  <header class="ai-top">
    <div class="top-inner">
      <div class="ai-row top-meta">
        <span class="muted">â±ï¸ {{ updated_at }} æ›´æ–°</span>
        <span class="muted">ğŸ“ˆ ãƒ¬ã‚¸ãƒ¼ãƒ ï¼š{{ regime.label }}ï¼ˆ{{ regime.confidence }}%ï¼‰</span>
      </div>
      <div class="ai-row modes">
        <button class="pill on">{{ mode.period }}</button>
        <button class="pill on">{{ mode.stance }}</button>
        <button class="pill">ãŠã¾ã‹ã›</button>
      </div>
    </div>
  </header>

  <main class="ai-list">
    {% for it in items %}
    <article class="ai-card" data-index="{{ forloop.counter0 }}">
      <div class="card-head">
        <h3 class="title">
          <span class="name">{{ it.name }}</span>
          <span class="code">({{ it.code }})</span>
        </h3>

        <div class="meta-right">
          <span class="score"><b>{{ it.score }}</b> ç‚¹</span>
          <span class="stars" aria-label="AIä¿¡é ¼åº¦">
            {% for i in "12345"|make_list %}{% if forloop.counter <= it.stars %}â­ï¸{% else %}â˜†{% endif %}{% endfor %}
          </span>
        </div>
      </div>

      <div class="row sub">
        <span class="sector">{{ it.sector_jp|default:"-" }}</span>
      </div>

      <div class="row trends">
        <span>æ—¥è¶³ {% if it.trend.d == 'up' %}â¤´ï¸{% elif it.trend.d == 'down' %}â¤µï¸{% else %}â¡ï¸{% endif %}</span>
        <span>é€±è¶³ {% if it.trend.w == 'up' %}â¤´ï¸{% elif it.trend.w == 'down' %}â¤µï¸{% else %}â¡ï¸{% endif %}</span>
        <span>æœˆè¶³ {% if it.trend.m == 'up' %}â¤´ï¸{% elif it.trend.m == 'down' %}â¤µï¸{% else %}â¡ï¸{% endif %}</span>
      </div>

      <button class="more" data-open="{{ forloop.counter0 }}">â–¶ è©³ç´°ã‚’è¦‹ã‚‹</button>
    </article>
    {% endfor %}
  </main>

  <div id="aiModal" class="modal hidden" aria-hidden="true" role="dialog">
    <div class="modal-sheet" role="document" aria-modal="true">
      <button class="close" data-close>é–‰ã˜ã‚‹</button>

      <section class="modal-head">
        <h3 id="m_name"></h3>
        <div class="right">
          <span id="m_stars"></span>
          <span id="m_score" class="score"></span>
        </div>
        <div class="sub">
          <span id="m_sector">-</span>
        </div>
        <div class="trends">
          <span id="m_trend_d"></span>
          <span id="m_trend_w"></span>
          <span id="m_trend_m"></span>
        </div>
      </section>

      <section class="reasons">
        <h4>ç†ç”±ï¼ˆæ‡¸å¿µå«ã‚€ï¼‰</h4>
        <ul id="m_reasons"></ul>
      </section>

      <section class="prices">
        <h4>ä¾¡æ ¼ç›®å®‰</h4>
        <div id="m_prices"></div>
        <div id="m_qty"></div>
      </section>

      <section class="chart">
        <h4>ãƒãƒ£ãƒ¼ãƒˆï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ï¼åˆ©ç¢ºï¼æåˆ‡ï¼‰</h4>
        <canvas id="m_chart" height="260"></canvas>
      </section>

      <section class="actions">
        <button id="act_watch">ğŸ”– ã‚¦ã‚©ãƒƒãƒç™»éŒ²</button>
        <button id="act_paper" disabled>ğŸ“Š ç´™ãƒˆãƒ¬è¨˜éŒ²ä¸­</button>
      </section>
    </div>
    <div class="backdrop" data-close></div>
  </div>
</div>

<script>
  // ã‚µãƒ¼ãƒã‹ã‚‰æ¸¡ã•ã‚ŒãŸç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆJSONç›´æ¸¡ã—ï¼‰
  window.__AI_ITEMS__ = {{ items|safe }};

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ»ãƒã‚¤ãƒ³ãƒ‰ï¼šsector ã¯ã‚µãƒ¼ãƒã‹ã‚‰ã® sector_jp ã‚’ãã®ã¾ã¾ä½¿ã†
  (function(){
    const items = window.__AI_ITEMS__ || [];
    const modal = document.getElementById('aiModal');
    const elName = document.getElementById('m_name');
    const elStars = document.getElementById('m_stars');
    const elScore = document.getElementById('m_score');
    const elSector = document.getElementById('m_sector');
    const elD = document.getElementById('m_trend_d');
    const elW = document.getElementById('m_trend_w');
    const elM = document.getElementById('m_trend_m');
    const elPrices = document.getElementById('m_prices');
    const elQty = document.getElementById('m_qty');

    function open(i){
      const it = items[i] || {};
      elName.textContent = `${it.name || ''} (${it.code || ''})`;
      elScore.textContent = `${it.score || 0}ç‚¹`;
      elStars.textContent = 'â­ï¸'.repeat(it.stars || 0) + 'â˜†'.repeat(Math.max(0,5-(it.stars||0)));
      elSector.textContent = it.sector_jp || '-';
      elD.textContent = `æ—¥è¶³ ${it.trend?.d === 'up' ? 'â¤´ï¸' : (it.trend?.d === 'down' ? 'â¤µï¸' : 'â¡ï¸')}`;
      elW.textContent = `é€±è¶³ ${it.trend?.w === 'up' ? 'â¤´ï¸' : (it.trend?.w === 'down' ? 'â¤µï¸' : 'â¡ï¸')}`;
      elM.textContent = `æœˆè¶³ ${it.trend?.m === 'up' ? 'â¤´ï¸' : (it.trend?.m === 'down' ? 'â¤µï¸' : 'â¡ï¸')}`;
      if (it.prices){
        elPrices.textContent = `ã‚¨ãƒ³ãƒˆãƒªãƒ¼ç›®å®‰ï¼š${it.prices.entry} ï¼ åˆ©ç¢ºï¼š${it.prices.tp} ï¼ æåˆ‡ï¼š${it.prices.sl}`;
      } else {
        elPrices.textContent = '';
      }
      if (it.qty){
        elQty.textContent = `ææ¡ˆæ•°é‡ï¼š${it.qty.shares}æ ªï¼ˆå¿…è¦è³‡é‡‘ ${it.qty.capital}å††ã€æƒ³å®šåˆ©ç›Š ${it.qty.pl_plus}å††ã€æƒ³å®šæå¤± ${it.qty.pl_minus}å††ã€R=${it.qty.r})`;
      } else {
        elQty.textContent = '';
      }
      modal.classList.remove('hidden');
      modal.setAttribute('aria-hidden', 'false');
    }

    document.addEventListener('click', (e)=>{
      const more = e.target.closest('.more');
      if (more){
        const i = parseInt(more.dataset.open || '0', 10) || 0;
        open(i);
      }
      if (e.target.matches('[data-close]') || e.target.classList.contains('backdrop')){
        modal.classList.add('hidden');
        modal.setAttribute('aria-hidden', 'true');
      }
    });
  })();
</script>

<script src="{% static 'ai/ai.js' %}?v=21"></script>
{% endblock %}